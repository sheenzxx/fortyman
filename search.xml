<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>创建可插拔数据库语法</title>
    <url>/2022/11/18/CreatePdb/</url>
    <content><![CDATA[<h3 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h3><pre><code>1.必须连接CDB 实例,并且CDB 必须是打开并且处于读写模式
2.要创建PDB 或 应用容器，当前位置必须是处于根容器(CDB$ROOT)，并且具有 CREATE PLUGGABLE DATABASE 的系统权限
3.要创建应用种子或应用PDB ,当前位置必须是处于根容器(CDB$ROOT)，并且具有 CREATE PLUGGABLE DATABASE 的系统权限
对于通过克隆方式创建PDB 需要注意：
   - 如果源库 和要创建的PDB 位于同个CDB中，那么你必须在被克隆的PDB 以及要创建的PDB对应根容器中中具有CREATE PLUGGABLE DATABASE 的系统权限
   - 如果源库是远端的PDB 或非CDB ,则必须在目标PDB对应的根容器中，以及远端源库都同时具有CREATE PLUGGABLE DATABASE的系统权限。
</code></pre><h3 id="1-通过-pdbseed-库来创建"><a href="#1-通过-pdbseed-库来创建" class="headerlink" title="1. 通过 pdbseed 库来创建"></a>1. 通过 pdbseed 库来创建</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span>  <span class="keyword">AS</span> SEED &#125;</span><br><span class="line">ADMIN <span class="keyword">USER</span> 用户名 IDENTIFIED <span class="keyword">BY</span> 密码 [ROLES<span class="operator">=</span>(角色<span class="number">1</span>,角色<span class="number">2.</span>..)] </span><br><span class="line">[PARALLEL [并发数]]</span><br><span class="line">[<span class="keyword">DEFAULT</span> TABLESPACE 默认表空间名 [ DATAFILE 指定数据文件 ] [ 扩展管理声明 ] ]</span><br><span class="line">[STORAGE ([MAXSIZE 存储最大值 <span class="operator">|</span> UNLIMITED ] [MAX_AUDIT_SIZE 审核空间最大值 <span class="operator">|</span> UNLIMITED ] [ MAX_DIAG_SIZE DIAG最大值 <span class="operator">|</span> UNLIMITED] )<span class="operator">|</span>UNLIMITED] </span><br><span class="line">[FILE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库的路径&#x27;</span>,<span class="string">&#x27;替换的路径&#x27;</span>)<span class="operator">|</span> <span class="keyword">None</span>]</span><br><span class="line">[SERVICE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库服务名&#x27;</span>,<span class="string">&#x27;替换服务名&#x27;</span>)]</span><br><span class="line">[PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;绝对路径&#x27;</span><span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="keyword">NONE</span>]</span><br><span class="line">[TEMPFILE REUSE]</span><br><span class="line">[USER_TABLESPACE [(<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ] [SNAPSHOT <span class="keyword">COPY</span><span class="operator">|</span>NODATA] <span class="operator">|</span> [<span class="keyword">COPY</span><span class="operator">|</span>MOVE<span class="operator">|</span>NOCOPY]]</span><br><span class="line">[STANDBYS <span class="operator">=</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ]]</span><br><span class="line">[LOGGIN <span class="operator">|</span> NOLOGGIN <span class="operator">|</span> FILESYSTEM_LIKE_LOGGIN]</span><br><span class="line">[CREATE_FILE_DEST <span class="operator">=</span> <span class="keyword">NONE</span> <span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="string">&#x27;磁盘组名&#x27;</span>]</span><br><span class="line">[HOST<span class="operator">=</span><span class="string">&#x27;主机名&#x27;</span>]</span><br><span class="line">[PORT<span class="operator">=</span>端口号]</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> pluggable database sheen</span><br><span class="line">admin <span class="keyword">user</span> sheen_sys identified <span class="keyword">by</span> sheen123 roles<span class="operator">=</span>(dba)</span><br><span class="line">PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;/disk1/oracle/oradata/ORCL19/sheen/&#x27;</span></span><br><span class="line">FILE_NAME_CONVERT<span class="operator">=</span>(<span class="string">&#x27;/data/oracle/oradata/ORCL19/pdbseed&#x27;</span>,<span class="string">&#x27;/data/oracle/oradata/ORCL19/sheen&#x27;</span>); #根据种子创建pdb 要指定FILE_NAME_CONVERT 参数</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="2-通过-clone-的方式来创建"><a href="#2-通过-clone-的方式来创建" class="headerlink" title="2. 通过 clone 的方式来创建"></a>2. 通过 clone 的方式来创建</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span> <span class="keyword">AS</span> SEED &#125;</span><br><span class="line">&#123; &#123; <span class="keyword">FROM</span> &#123; 源pdb [ @ dblink ] &#125; <span class="operator">|</span> &#123; 非CDB库 @ dblink &#125; &#125; <span class="operator">|</span>  &#123; <span class="keyword">AS</span> PROXY <span class="keyword">FROM</span> src_pdb_name @ dblink &#125; &#125;</span><br><span class="line">[PARALLEL [并发数]]</span><br><span class="line">[<span class="keyword">DEFAULT</span> TABLESPACE 默认表空间名 [ DATAFILE 指定数据文件 ] [ 扩展管理声明 ] ]</span><br><span class="line">[FILE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库的路径&#x27;</span>,<span class="string">&#x27;替换的路径&#x27;</span>)<span class="operator">|</span> <span class="keyword">None</span>]</span><br><span class="line">[SERVICE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库服务名&#x27;</span>,<span class="string">&#x27;替换服务名&#x27;</span>)]</span><br><span class="line">[PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;绝对路径&#x27;</span><span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="keyword">NONE</span>]</span><br><span class="line">[TEMPFILE REUSE]</span><br><span class="line">[SNAPSHOT <span class="keyword">COPY</span>]</span><br><span class="line">[<span class="keyword">USING</span> SNAPSHOT &#123;快照名 <span class="operator">|</span> <span class="keyword">AT</span> SCN 快照SCN值 <span class="operator">|</span><span class="keyword">AT</span> 快照时间戳&#125;]</span><br><span class="line">[USER_TABLESPACE [(<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ] [SNAPSHOT <span class="keyword">COPY</span><span class="operator">|</span>NODATA] <span class="operator">|</span> [<span class="keyword">COPY</span><span class="operator">|</span>MOVE<span class="operator">|</span>NOCOPY]]</span><br><span class="line">[STANDBYS <span class="operator">=</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ]]</span><br><span class="line">[LOGGIN <span class="operator">|</span> NOLOGGIN <span class="operator">|</span> FILESYSTEM_LIKE_LOGGIN]</span><br><span class="line">[CREATE_FILE_DEST <span class="operator">=</span> <span class="keyword">NONE</span> <span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="string">&#x27;磁盘组名&#x27;</span>]</span><br><span class="line">[KEYSTORE IDENTIFIED <span class="keyword">BY</span> &#123;<span class="keyword">EXTERNAL</span> STORE <span class="operator">|</span> keystore 密码&#125;] [<span class="keyword">NO</span> REKEY]</span><br><span class="line">[REFRESH MODE MANUAL <span class="operator">|</span> <span class="keyword">EVERY</span> 刷新间隔 &#123;<span class="keyword">HOUR</span> <span class="operator">|</span> MINUTES&#125; <span class="operator">|</span> <span class="keyword">NONE</span>]</span><br><span class="line">[RELOCATE AVAILABLITY MAX <span class="operator">|</span>NORMAL]</span><br><span class="line">[<span class="keyword">NO</span> DATA]</span><br><span class="line">[HOST<span class="operator">=</span><span class="string">&#x27;主机名&#x27;</span>]</span><br><span class="line">[PORT<span class="operator">=</span>端口号]</span><br><span class="line"></span><br><span class="line">热克隆：</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB2_CLONE <span class="keyword">FROM</span> CDB1_PDB2</span><br><span class="line">KEYSTORE IDENTIFIED <span class="keyword">BY</span> keystore_password</span><br><span class="line"></span><br><span class="line">对于联合PDB</span><br><span class="line">密码库的密码就是ROOT 密码库的密码</span><br><span class="line">同时wallet 必须在ROOT 中打开</span><br><span class="line"></span><br><span class="line">对于独立的PDB</span><br><span class="line">密码库的密码是对应 CDB1_PDB2_CLONE 的一个新的密码</span><br><span class="line"></span><br><span class="line">克隆一个PDB:</span><br><span class="line">对于联合PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB1_C <span class="keyword">AS</span> CLONE <span class="keyword">USING</span> <span class="string">&#x27;/tmp/cdb1_pdb3.pdb&#x27;</span></span><br><span class="line">KEYSTORE IDENTIFED <span class="keyword">BY</span> keystore_password DECRYPT <span class="keyword">USING</span> transport_secret</span><br><span class="line">如果使用TDE,则wallet 必须在ROOT中打开</span><br><span class="line">如果.pdb 文件中存在 TDE keys，必须指定 KEYSTORE IDENTIFED <span class="keyword">BY</span> keystore_password DECRYPT <span class="keyword">USING</span> transport_secret 子句</span><br><span class="line">keystore_password 是ROOT的 keystore 密码</span><br><span class="line"></span><br><span class="line">对于独立PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB2_C <span class="keyword">AS</span> CLONE <span class="keyword">USING</span> <span class="string">&#x27;/tmp/cdb1_pdb2.pdb&#x27;</span></span><br><span class="line">不需要指定KEYSTORE IDENTIFED <span class="keyword">BY</span> 或者 DECRYPT <span class="keyword">USING</span> transport_secret 子句。如果指定也会被忽略</span><br><span class="line">wallet 不用在ROOT 中打开</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">通过pdbseed 创建新的PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE salespdb</span><br><span class="line">  ADMIN <span class="keyword">USER</span> salesadm IDENTIFIED <span class="keyword">BY</span> password</span><br><span class="line">  ROLES <span class="operator">=</span> (dba)</span><br><span class="line">  <span class="keyword">DEFAULT</span> TABLESPACE sales</span><br><span class="line">    DATAFILE <span class="string">&#x27;/disk1/oracle/dbs/salespdb/sales01.dbf&#x27;</span> SIZE <span class="number">250</span>M AUTOEXTEND <span class="keyword">ON</span></span><br><span class="line">  FILE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;/disk1/oracle/dbs/pdbseed/&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;/disk1/oracle/dbs/salespdb/&#x27;</span>)</span><br><span class="line">  STORAGE (MAXSIZE <span class="number">2</span>G)</span><br><span class="line">  PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;/disk1/oracle/dbs/salespdb/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">通过已经存在的PDB创建新的PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE newpdb <span class="keyword">FROM</span> salespdb</span><br><span class="line">  FILE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;/disk1/oracle/dbs/salespdb/&#x27;</span>, <span class="string">&#x27;/disk1/oracle/dbs/newpdb/&#x27;</span>)</span><br><span class="line">  PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;/disk1/oracle/dbs/newpdb&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-通过-XML-的方式来创建"><a href="#3-通过-XML-的方式来创建" class="headerlink" title="3. 通过 XML 的方式来创建"></a>3. 通过 XML 的方式来创建</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span>  <span class="keyword">AS</span> SEED &#125;</span><br><span class="line">[<span class="keyword">AS</span> CLONE]</span><br><span class="line"><span class="keyword">USING</span> xml文件名 </span><br><span class="line">[SOURCE_FILE_NAME_CONVERT<span class="operator">=</span>(<span class="string">&#x27;源文件名部分1&#x27;</span>,<span class="string">&#x27;替换成目标名的部分1&#x27;</span>,<span class="string">&#x27;源文件名部分2&#x27;</span>,<span class="string">&#x27;替换成目标名的部分2&#x27;</span>,...) <span class="operator">|</span> &#123;SOURCE_FILE_DIRECTORY <span class="operator">=</span> [<span class="string">&#x27;源文件路径名&#x27;</span> <span class="operator">|</span><span class="keyword">NONE</span>]&#125;]</span><br><span class="line">[ &#123; [ <span class="keyword">COPY</span> <span class="operator">|</span> MOVE ] FILE_NAME_CONVERT <span class="operator">=</span> &#123;(<span class="string">&#x27;源库的路径&#x27;</span>,<span class="string">&#x27;替换的路径&#x27;</span>)<span class="operator">|</span> <span class="keyword">None</span>&#125; &#125; <span class="operator">|</span> NOCOPY ]</span><br><span class="line">[SERVICE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库服务名&#x27;</span>,<span class="string">&#x27;替换服务名&#x27;</span>)]</span><br><span class="line">[<span class="keyword">DEFAULT</span> TABLESPACE 默认表空间名 [ DATAFILE 指定数据文件 ] [ 扩展管理声明 ] ]</span><br><span class="line">[STORAGE ([MAXSIZE 存储最大值 <span class="operator">|</span> UNLIMITED ] [MAX_AUDIT_SIZE 审核空间最大值 <span class="operator">|</span> UNLIMITED ] [ MAX_DIAG_SIZE DIAG最大值 <span class="operator">|</span> UNLIMITED] )<span class="operator">|</span>UNLIMITED] </span><br><span class="line">[PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;绝对路径&#x27;</span><span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="keyword">NONE</span>]</span><br><span class="line">[TEMPFILE REUSE]</span><br><span class="line">[USER_TABLESPACE [(<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ] [SNAPSHOT <span class="keyword">COPY</span><span class="operator">|</span>NODATA] <span class="operator">|</span> [<span class="keyword">COPY</span><span class="operator">|</span>MOVE<span class="operator">|</span>NOCOPY]]</span><br><span class="line">[STANDBYS <span class="operator">=</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ]]</span><br><span class="line">[LOGGIN <span class="operator">|</span> NOLOGGIN <span class="operator">|</span> FILESYSTEM_LIKE_LOGGIN]</span><br><span class="line">[CREATE_FILE_DEST <span class="operator">=</span> <span class="keyword">NONE</span> <span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="string">&#x27;磁盘组名&#x27;</span>]</span><br><span class="line">[HOST<span class="operator">=</span><span class="string">&#x27;主机名&#x27;</span>]</span><br><span class="line">[PORT<span class="operator">=</span>端口号]</span><br><span class="line">[DECRYPT <span class="keyword">USING</span> transport_secret]</span><br><span class="line"></span><br><span class="line">通过XML 的方式来加载PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE salespdb</span><br><span class="line">  <span class="keyword">USING</span> <span class="string">&#x27;/disk1/usr/salespdb.xml&#x27;</span></span><br><span class="line">  SOURCE_FILE_NAME_CONVERT <span class="operator">=</span></span><br><span class="line">    (<span class="string">&#x27;/disk1/oracle/dbs/salespdb/&#x27;</span>, <span class="string">&#x27;/disk2/oracle/dbs/salespdb/&#x27;</span>)</span><br><span class="line">  NOCOPY</span><br><span class="line">  STORAGE (MAXSIZE <span class="number">2</span>G)</span><br><span class="line">  TEMPFILE REUSE;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="4-通过-镜像拷贝-的方式来创建"><a href="#4-通过-镜像拷贝-的方式来创建" class="headerlink" title="4. 通过 镜像拷贝 的方式来创建"></a>4. 通过 镜像拷贝 的方式来创建</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span>  <span class="keyword">AS</span> SEED &#125;</span><br><span class="line"><span class="keyword">FROM</span> 源pdb名称 </span><br><span class="line"><span class="keyword">USING</span> MIRROR <span class="keyword">COPY</span> 镜像名</span><br></pre></td></tr></table></figure>
<h3 id="5-CONTAINER-MAP-子句"><a href="#5-CONTAINER-MAP-子句" class="headerlink" title="5. CONTAINER MAP 子句"></a>5. CONTAINER MAP 子句</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">CONTAINER_MAP <span class="keyword">UPDATE</span> &#123;添加表分区 <span class="operator">|</span> 将表分为分区表&#125; </span><br><span class="line"></span><br><span class="line">为区间分区容器添加新的PDB并划分区区间</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE cdb1_pdb3</span><br><span class="line">  ADMIN <span class="keyword">USER</span> IDENTIFIED <span class="keyword">BY</span> manager</span><br><span class="line">  FILE_NAME_CONVERT<span class="operator">=</span>(<span class="string">&#x27;cdb1_pdb0, cdb1_pdb3&#x27;</span>)</span><br><span class="line">  CONTAINER_MAP <span class="keyword">UPDATE</span> (<span class="keyword">ADD</span> <span class="keyword">PARTITION</span> cdb1_pdb3 <span class="keyword">VALUES</span> LESS THAN (<span class="number">100</span>));</span><br><span class="line"><span class="keyword">ALTER</span> PLUGGABLE DATABASE cdb1_pdb3 <span class="keyword">OPEN</span>;</span><br><span class="line"></span><br><span class="line">将存在的区间分区容器分裂部分创建一个新的PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE cdb1_pdb4</span><br><span class="line">  ADMIN <span class="keyword">USER</span> IDENTIFIED <span class="keyword">BY</span> manager</span><br><span class="line">  FILE_NAME_CONVERT<span class="operator">=</span>(<span class="string">&#x27;cdb1_pdb0, cdb1_pdb4&#x27;</span>)</span><br><span class="line">  CONTAINER_MAP <span class="keyword">UPDATE</span> (SPLIT <span class="keyword">PARTITION</span> cdb1_pdb3 </span><br><span class="line">                          <span class="keyword">AT</span> (<span class="number">50</span>) </span><br><span class="line">                          <span class="keyword">INTO</span></span><br><span class="line">                          (<span class="keyword">PARTITION</span> cdb1_pdb3, <span class="keyword">PARTITION</span> cdb1_pdb3);</span><br><span class="line"><span class="keyword">ALTER</span> PLUGGABLE DATABASE cdb1_pdb4 <span class="keyword">OPEN</span>;</span><br><span class="line"></span><br><span class="line">确认分区结果</span><br><span class="line"><span class="keyword">SELECT</span> partition_name, high_value</span><br><span class="line">  <span class="keyword">FROM</span> dba_tab_partitions</span><br><span class="line">  <span class="keyword">WHERE</span> table_name<span class="operator">=</span><span class="string">&#x27;MAP&#x27;</span> <span class="keyword">AND</span> table_owner<span class="operator">=</span><span class="string">&#x27;SYS&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="6-pdb-snapshot-clause-指定是否创建-PDB-SNAPSHOT"><a href="#6-pdb-snapshot-clause-指定是否创建-PDB-SNAPSHOT" class="headerlink" title="6. pdb_snapshot_clause 指定是否创建 PDB SNAPSHOT"></a>6. pdb_snapshot_clause 指定是否创建 PDB SNAPSHOT</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span>  <span class="keyword">AS</span> SEED &#125;</span><br><span class="line">SNAPSHOT MANUAL <span class="operator">|</span> <span class="keyword">EVERY</span> 刷新间隔 &#123;HOURS <span class="operator">|</span> MINUTES&#125; <span class="operator">|</span> <span class="keyword">NONE</span></span><br><span class="line">       <span class="keyword">NONE</span>：默认值，标识不创建快照</span><br><span class="line">       MANUAL：表明 PDB 的快照只能手工创建</span><br><span class="line">       <span class="keyword">EVERY</span> <span class="type">INTERVAL</span>：则PDB的快照会在每一个时间间隔后创建</span><br><span class="line">                       如果指定的单位是 MINUTES 则间隔时间必须小于<span class="number">3000</span></span><br><span class="line">                       如果指定的单位是 HOURS 则间隔时间必须小于<span class="number">2000</span></span><br></pre></td></tr></table></figure>
<h3 id="7-名词释义"><a href="#7-名词释义" class="headerlink" title="7. 名词释义"></a>7. 名词释义</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">pdbname:要创建的pdb名称</span><br><span class="line"><span class="keyword">AS</span> APPLICATION CONTAINER：指定创建一个应用容器</span><br><span class="line"><span class="keyword">AS</span> SEED：创建应用种子 。数据库会为其分配一个 application_container_name$SEED 的名字，一个容器最多只能有一个应用种子</span><br><span class="line">ADMIN <span class="keyword">USER</span>: 为pdb 创建一个管理员用户</span><br><span class="line">ROLES：为管理员账号赋权         </span><br><span class="line">PARALLEL：复制数据文件到新的PDB的并发数。如果指定PARLLEL 而不指定数字，数据库会自动选择并发数</span><br><span class="line"><span class="keyword">DEFAULT</span> TABLESPACE：为PDB 创建一个默认表空间，为所有非<span class="operator">-</span><span class="keyword">SYSTEM</span> 并且没有指定默认表空间的用户的默认表空间</span><br><span class="line">FILE_NAME_CONVERT：指定种子库的路径，以及目标pdb存放数据文件的路径。</span><br><span class="line">                   如果FILE_NAME_CONVERT<span class="operator">=</span><span class="keyword">NONE</span>,数据库将首先在OMF中创建数据文件，</span><br><span class="line">                   如果没有使用OMF,则数据库会使用 PDB_FILE_NAME_CONVERT 初始化参数来设定</span><br><span class="line">SERVICE_NAME_CONVERT：替换种子库中出现的service_name 为新的名字</span><br><span class="line">                     <span class="number">1</span>) 不能替换PDB的默认服务，默认服务的名字将于PDB 同名</span><br><span class="line">                     <span class="number">2</span>) 通过create_pdb_from_seed 的方式，使用CDB seed 创建PDB 时不能使用该参数。因为CDB seed 没有用户自定义的service_name。</span><br><span class="line">                     <span class="number">3</span>) 通过应用seed来创建应用PDB 则可以使用该参数。</span><br><span class="line">PATH_PREFIX：<span class="number">1</span>) 使用该参数可确保于PDB关联的目录对象的文件路径仅限于指定目录或者其子目录。同时也确保于PDB关联的的以下文件</span><br><span class="line">             <span class="number">2</span>) 限制在指定目录(PDB的ORACLE XML存储库，使用<span class="keyword">CREATE</span> PFILE语句创建的文件，以及ORACLE wallets的导出目录)</span><br><span class="line">             <span class="number">3</span>) 创建PDB后无法修改此路径，该路径限制不影响在OMF中创建的文件</span><br><span class="line">             <span class="number">4</span>) 在UNIX类系统中。注意必须确保以 <span class="operator">/</span> 结束路径</span><br><span class="line">                PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;/disk1/oracle/dba/salespdb/&#x27;</span> #路径后面的 <span class="operator">/</span> 千万不能丢</span><br><span class="line">             <span class="number">5</span>) 如果使用目录对象，则目录对象必须存在于CDB$ROOT 中，目录对象指向的绝对路径将用于PATH_PREFIX</span><br><span class="line">             <span class="number">6</span>) 如果PATH_PREFIX<span class="operator">=</span><span class="keyword">NONE</span>,则以PDB相关联的目录路径将被视为绝对路径，并且不限于特定目录。</span><br><span class="line">             <span class="number">7</span>) 为 PDB 指定 PATH_PREFIX 后，现有目录对象可能无法按预期工作，因为 PATH_PREFIX 字符串始终作为前缀添加到 PDB 中的所有本地目录对象， </span><br><span class="line">                PATH_PREFIX 仅适用于用户创建的目录对象。 它不适用于 Oracle 提供的目录对象。</span><br><span class="line">TEMPFILE REUSE：指定假如存在TEMPFILE 则格式化并重新使用该文件</span><br><span class="line">USER_TABLESPACE：指定PDB 可以使用的已存在的表空间。<span class="keyword">SYSTEM</span>, SYSAUX, TEMP 这<span class="number">3</span>个表空间对所有的PDB都适用并且不能在该子句中指定</span><br><span class="line">                 指定表空间名。则这些表空间在新PDB 可用</span><br><span class="line">                 指定<span class="keyword">ALL</span> 。则所有的表空间在新PDB 可用</span><br><span class="line">                 指定<span class="keyword">ALL</span> <span class="keyword">EXCEPT</span> 。则除了指定的表空间。其他在新PDB 可用</span><br><span class="line">                 指定<span class="keyword">NONE</span> 。 则只有<span class="keyword">SYSTEM</span>, SYSAUX, TEMP 在新的PDB 不可用</span><br><span class="line"></span><br><span class="line">SNAPSHOT <span class="keyword">COPY</span> <span class="operator">|</span> <span class="keyword">NO</span> DATA：仅用于 clone 方式，</span><br><span class="line">           SNAPSHOT <span class="keyword">COPY</span>：使用存储快照来克隆表空间</span><br><span class="line">           <span class="keyword">NO</span> DATA：只拷贝表空间的数据定义信息。而不拷贝表空间的内容</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span> <span class="operator">|</span> MOVE <span class="operator">|</span> NOCOPY：仅用于 XML 方式</span><br><span class="line">          默认情况下数据库通过配置文件为新的PDB 创建每个设定的表空间。而这三种方法允许你重写那些设定</span><br><span class="line">          <span class="keyword">COPY</span>：拷贝表空间到新的位置</span><br><span class="line">          MOVE：移动表空间到新的位置</span><br><span class="line">          NOCOPY：不拷贝或移动表空间到新的位置</span><br><span class="line">        </span><br><span class="line">STANDBYS：cdbname 指定哪个CDB 从库包含这个新的PDB.可以指定多个CDB 从库</span><br><span class="line">          <span class="keyword">ALL</span>：指定连接主CDB 的所有从CDB 都包含这个新的PDB。这个是默认值</span><br><span class="line">          <span class="keyword">ALL</span> <span class="keyword">EXCEPT</span>:除了指定的CDB从库。其他从库都包含这个新的PDB</span><br><span class="line">          <span class="keyword">NONE</span>: 所有连接这个主CDB 的从CDB 都不包含这个新的PDB</span><br><span class="line">LOGGIN <span class="operator">|</span> NOLOGGIN <span class="operator">|</span> FILESYSTEM_LIKE_LOGGIN: 设定PDB创建表空间的日志属性。</span><br><span class="line">         默认情况是LOGGIN</span><br><span class="line">         该属性可在创建表空间时指定覆盖默认设置</span><br><span class="line"></span><br><span class="line">CREATE_FILE_DEST：改写PDB存放数据文件路径的属性。默认情况下，PDB 会引用CDB 的OMF设置。</span><br><span class="line">        <span class="keyword">NONE</span>：禁止PDB 使用OMF </span><br><span class="line">        directory_path_name(<span class="string">&#x27;directory 对象名&#x27;</span>)<span class="operator">|</span>diskgroup_name(<span class="string">&#x27;磁盘组名&#x27;</span>)：允许PDB使用OMF</span><br><span class="line">            <span class="number">1</span>) directory_path_name：指定 directory_path_name 以指定 PDB 文件的基本文件系统目录。 </span><br><span class="line">               指定操作系统目录的完整路径名。 该目录必须存在并且 Oracle 进程必须对该目录具有适当的权限。 </span><br><span class="line">               单引号是必需的，因此路径名区分大小写。</span><br><span class="line">            <span class="number">2</span>) diskgroup_name：指定 diskgroup_name 以指定 PDB 文件的默认 Oracle ASM 磁盘组。</span><br><span class="line">        如果指定 <span class="keyword">NONE</span> 以外的值，则数据库在 PDB 中隐式设置 DB_CREATE_FILE_DEST 初始化参数为 <span class="keyword">SCOPE</span><span class="operator">=</span>SPFILE。</span><br><span class="line">HOST <span class="operator">&amp;</span> PORT：仅在引用代理PDB来创建新的PDB时有用。这种类型的PDB称为引用PDB。 </span><br><span class="line">           <span class="keyword">AS</span> PROXY PDB<span class="variable">@dblink</span></span><br><span class="line"></span><br><span class="line">create_pdb_clone：通过克隆方式创建PDB</span><br><span class="line">        克隆的源PDB 可以是在同一个CDB中。也可以在不同的CDB中。甚至是非CDB 实例。</span><br><span class="line">        如果源PDB在同一个CDB中，则源PDB可以是插入状态也可以是非插入状态。如果是不同CDB 则需要插入状态。</span><br><span class="line">        如果源PDB不在同一个CDB中。或者是非CDB，有以下要求：</span><br><span class="line">        <span class="number">1</span>）它们必须具有相同的字节序格式</span><br><span class="line">        <span class="number">2</span>）它们必须具有兼容的字符集和国家字符集，这意味着：</span><br><span class="line">           A.源字符集中的每个字符在本地 CDB 字符集中都有</span><br><span class="line">           B.源字符集中的每个字符在本地 CDB 字符集中具有相同的代码点值</span><br><span class="line">        <span class="number">3</span>）他们必须安装相同的数据库选项集</span><br><span class="line">        源库用户使用了默认临时表空间的，在新PDB中使用新PDB的默认临时表空间。</span><br><span class="line">        源库用户没有使用默认临时表空间的，将继续使用在新PDB中本地对应的临时表空间。  </span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span>：通过克隆方式创建PDB 指定源库</span><br><span class="line"></span><br><span class="line"><span class="keyword">AS</span> PROXY <span class="keyword">FROM</span>：通过代理方式克隆</span><br><span class="line"></span><br><span class="line">DECRYPT <span class="keyword">USING</span> transport_secret：指定这个子句必须具有 SYSKM的权限</span><br><span class="line">    在联合PDB中：</span><br><span class="line">    如果使用TDE保护数据库，则一定要指定这个子句，否则则是可选项</span><br><span class="line">    在独立PDB中则不需要指定这个子句</span><br><span class="line">    wallet 必须在ROOT 中打开</span><br><span class="line">    在所有的方式下(NOCOPY, <span class="keyword">COPY</span>, <span class="keyword">and</span> MOVE) 都会拷贝wallet 文件。</span><br><span class="line">    例子：</span><br><span class="line">    在XML medata 文件中加载PDB</span><br><span class="line">    <span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB2 <span class="keyword">USING</span> <span class="string">&#x27;/tmp/cdb1_pdb2.xml&#x27;</span> NOCOPY</span><br><span class="line">    KEYSTORE IDENTIFIED <span class="keyword">BY</span> keystore_password DECRYPT <span class="keyword">USING</span> transport_secret</span><br><span class="line">    </span><br><span class="line">    在归档文件中加载PDB</span><br><span class="line">    <span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB1_1_C <span class="keyword">USING</span> <span class="string">&#x27;/tmp/cdb1_pdb3.pdb&#x27;</span> DECRYPT <span class="keyword">USING</span> transport_secret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="一个完整的建库例子"><a href="#一个完整的建库例子" class="headerlink" title="一个完整的建库例子"></a>一个完整的建库例子</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">CREATE</span> PLUGGABLE DATABASE wsb </span><br><span class="line">  <span class="number">2</span>  ADMIN <span class="keyword">USER</span> wsb_sys IDENTIFIED <span class="keyword">BY</span> wsbadmin roles<span class="operator">=</span>(dba)</span><br><span class="line">  <span class="number">3</span>  <span class="keyword">DEFAULT</span> TABLESPACE wsb_sys_data </span><br><span class="line">  <span class="number">4</span>  DATAFILE <span class="string">&#x27;/data/oracle/oradata/ORCL19/wsb/wsb_sys_data.dbf&#x27;</span> SIZE <span class="number">1</span>G AUTOEXTEND <span class="keyword">ON</span></span><br><span class="line">  <span class="number">5</span>  FILE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;/data/oracle/oradata/ORCL19/pdbseed&#x27;</span>, <span class="string">&#x27;/data/oracle/oradata/ORCL19/wsb&#x27;</span>);</span><br><span class="line"></span><br><span class="line">插接式数据库已创建。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">show</span> pdbs;</span><br><span class="line"></span><br><span class="line">    CON_ID CON_NAME                       <span class="keyword">OPEN</span> MODE  RESTRICTED</span><br><span class="line"><span class="comment">---------- ------------------------------ ---------- ----------</span></span><br><span class="line">         <span class="number">2</span> PDB$SEED                       READ <span class="keyword">ONLY</span>  <span class="keyword">NO</span></span><br><span class="line">         <span class="number">3</span> WSB                            MOUNTED</span><br><span class="line">         <span class="number">4</span> SHEEN                          READ WRITE <span class="keyword">NO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> pluggable database wsb <span class="keyword">open</span>;</span><br><span class="line"></span><br><span class="line">插接式数据库已变更。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> session <span class="keyword">set</span> container<span class="operator">=</span>wsb;</span><br><span class="line"></span><br><span class="line">会话已更改。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span>space wsb_data datafile <span class="string">&#x27;/data/oracle/oradata/ORCL19/wsb/wsb_data01.dbf&#x27;</span> size <span class="number">5</span>G;</span><br><span class="line"></span><br><span class="line">表空间已创建。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">user</span> wsb identified <span class="keyword">by</span> wsbpasswd <span class="keyword">default</span> tablespace wsb_data;</span><br><span class="line"></span><br><span class="line">用户已创建。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">connect</span>,<span class="keyword">create</span> session,resource <span class="keyword">to</span> wsb;</span><br><span class="line"></span><br><span class="line">授权成功。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">user</span> wsb quota unlimited <span class="keyword">on</span> wsb_data;</span><br><span class="line"></span><br><span class="line">用户已更改。</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>oracle</category>
      </categories>
      <tags>
        <tag>pdb</tag>
        <tag>oracle 19c</tag>
      </tags>
  </entry>
  <entry>
    <title>datanode 无法启动报  RECEIVED SIGNAL 15  SIGTERM</title>
    <url>/2023/03/27/DatanodeErrSignal15/</url>
    <content><![CDATA[<p>今天发现有个节点dead node .于是重启了datanode<br>./hadoop-daemond.sh stop datanode<br>./hadoop-daemond.sh start datanode<br>监控页面 dead node 状态依然没有改变。</p>
<p>查看日志发现出现如下错误<br>23/03/27 09:45:04 ERROR org.apache.hadoop.hdfs.server.datanode.DataNode: RECEIVED SIGNAL 15: SIGTERM</p>
<p>在节点上运行<br>hdfs dfsadmin -refreshNodes</p>
<p>问题解决</p>
]]></content>
      <categories>
        <category>hadoop</category>
      </categories>
      <tags>
        <tag>datanode</tag>
      </tags>
  </entry>
  <entry>
    <title>clickhouse 的 MergeTree 引擎</title>
    <url>/2023/01/13/MergeTree/</url>
    <content><![CDATA[<p>MergeTree 的主要特性</p>
<ul>
<li>存储按主键排序的数据</li>
<li>支持分区表</li>
<li>支持数据复制</li>
<li>支持数据采样</li>
</ul>
<p><code>注意的是 Merge 引擎并不是 *MergeTree 引擎的家族成员</code></p>
<h4 id="建一个-MergeTree-表"><a href="#建一个-MergeTree-表" class="headerlink" title="建一个 MergeTree 表"></a>建一个 MergeTree 表</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">    name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1] [TTL expr1],</span><br><span class="line">    name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2] [TTL expr2],</span><br><span class="line">    ...</span><br><span class="line">    INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1,</span><br><span class="line">    INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2,</span><br><span class="line">    ...</span><br><span class="line">    PROJECTION projection_name_1 (<span class="keyword">SELECT</span> <span class="operator">&lt;</span><span class="keyword">COLUMN</span> LIST EXPR<span class="operator">&gt;</span> [<span class="keyword">GROUP</span> <span class="keyword">BY</span>] [<span class="keyword">ORDER</span> <span class="keyword">BY</span>]),</span><br><span class="line">    PROJECTION projection_name_2 (<span class="keyword">SELECT</span> <span class="operator">&lt;</span><span class="keyword">COLUMN</span> LIST EXPR<span class="operator">&gt;</span> [<span class="keyword">GROUP</span> <span class="keyword">BY</span>] [<span class="keyword">ORDER</span> <span class="keyword">BY</span>])</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> expr</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">PRIMARY</span> KEY expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[TTL expr</span><br><span class="line">    [<span class="keyword">DELETE</span><span class="operator">|</span><span class="keyword">TO</span> DISK <span class="string">&#x27;xxx&#x27;</span><span class="operator">|</span><span class="keyword">TO</span> VOLUME <span class="string">&#x27;xxx&#x27;</span> [, ...] ]</span><br><span class="line">    [<span class="keyword">WHERE</span> conditions]</span><br><span class="line">    [<span class="keyword">GROUP</span> <span class="keyword">BY</span> key_expr [<span class="keyword">SET</span> v1 <span class="operator">=</span> aggr_func(v1) [, v2 <span class="operator">=</span> aggr_func(v2) ...]] ] ]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br><span class="line"></span><br><span class="line">ENGINE： 指定 MergeTree() ,MergeTree 引擎没有参数</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>： 指定一组排序键, 例如 <span class="keyword">ORDER</span> <span class="keyword">BY</span> (event_date,counter_id)不需要排序时指定 tuple()如果没有指定 <span class="keyword">PRIMARY</span> KEY 则clickhouse 会按<span class="keyword">ORDER</span> <span class="keyword">BY</span> 的排序字段建一个主键</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span>：指定分区键，分区并不会加速查询，不要使用细粒度的键作为分区键。按月分区可使用 toYYYYMM(date_column) 表达式</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY：主键，当主键顺序与 <span class="keyword">ORDER</span> <span class="keyword">BY</span> 排序键不一致时指定</span><br><span class="line">SAMPLE <span class="keyword">BY</span>：采样表达式。采样列必须包含在主键里面。例如:SAMPLE <span class="keyword">BY</span> intHash32(UserID) <span class="keyword">ORDER</span> <span class="keyword">BY</span> (CounterID, EventDate, intHash32(UserID))</span><br><span class="line">TTL：指定一系列规则，规定行的持续存储时长，并定义数据在磁盘与卷之间自动转移的逻辑。比如定时将部分数据转化为冷数据,存储到普通磁盘中。表达式必须包含日期或者时间的字段。</span><br><span class="line">示例:</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table</span><br><span class="line">(</span><br><span class="line">    d DateTime,</span><br><span class="line">    a <span class="type">Int</span></span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(d)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> d</span><br><span class="line">TTL d <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">MONTH</span> <span class="keyword">DELETE</span>,   <span class="comment">-- 删除超过一个月的行</span></span><br><span class="line">    d <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">1</span> WEEK <span class="keyword">TO</span> VOLUME <span class="string">&#x27;aaa&#x27;</span>, <span class="comment">-- 超过1周的行转移到名为aaa 的卷</span></span><br><span class="line">    d <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">2</span> WEEK <span class="keyword">TO</span> DISK <span class="string">&#x27;bbb&#x27;</span>; <span class="comment">-- 超过2周的行转移到名为 bbb 的磁盘</span></span><br><span class="line"></span><br><span class="line">SETTINGS：设置控制MergeTree 行为的参数</span><br><span class="line">   index_granularity：索引粒度，定义一个索引标记存储的最大行数。默认值 <span class="number">8192</span>行</span><br><span class="line">   index_granularity_bytes：数据粒度的最大大小。默认值 <span class="number">10</span>Mb ,如果只按行数限制，则需要将其值设置为<span class="number">0</span> (不推荐)</span><br><span class="line">   min_index_granularity_bytes：数据粒度最小大小。默认<span class="number">1024</span>b,防止意外创建具有非常低粒度的表</span><br><span class="line">   enable_mixed_granularity_parts：是否启动 index_granularity_bytes 的开关。启动数据粒度大小限制有利于提高大行表的查询</span><br><span class="line">   use_minimalistic_part_header_in_zookeeper：设置在zookeeper中存储数据部分头部信息的方法。设置为<span class="number">1</span> 将存储更少的信息</span><br><span class="line">   min_merge_bytes_to_use_direct_io：设置在合并操作时直接使用DIRECT_IO 的最小数据量，默认<span class="number">10</span>MB，设置<span class="number">1</span> 开启， <span class="number">0</span> 关闭</span><br><span class="line">   merge_with_ttl_timeout：在重复合并数据执行 ttl <span class="keyword">delete</span> 操作时的最小间隔时间 。默认<span class="number">4</span>小时</span><br><span class="line">   merge_with_recompression_ttl_timeout：在重复合并数据执行 ttl 压缩 操作时的最小间隔时间。默认<span class="number">4</span>小时</span><br><span class="line">   try_fetch_recompressed_part_timeout：clickhouse 在启动合并压缩数据前，尝试从副本里获取此次标志合并压缩的已压缩数据的超时时间。 默认<span class="number">2</span>小时</span><br><span class="line">   write_final_mark：是否在数据部分末尾写上最终索引标记(在最后一个字节之后)。默认 <span class="number">1</span> 开启， 请不要关掉它</span><br><span class="line">   merge_max_block_size：合并时块的最大行数，默认 <span class="number">8192</span></span><br><span class="line">   storage_policy：存储策略</span><br><span class="line">   min_bytes_for_wide_part,min_rows_for_wide_part：设置可以存储为wide 格式的最小的数据大小<span class="operator">/</span>最小的行数</span><br><span class="line">   max_parts_in_total：最大的分区数</span><br><span class="line">   max_compress_block_size：数据压缩前数据块的最大尺寸。</span><br><span class="line">   min_compress_block_size：数据压缩前数据块的最小尺寸。</span><br><span class="line">   max_partitions_to_read：查询时可以查的最大分区数</span><br></pre></td></tr></table></figure>
<h4 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h4><p>一张表由按主键排序的数据部分组成<br>主键没有唯一性约束，允许插入多条相同主键的数据</p>
]]></content>
      <categories>
        <category>clickhouse</category>
      </categories>
      <tags>
        <tag>engine</tag>
        <tag>index</tag>
      </tags>
  </entry>
  <entry>
    <title>docker容器下创建mysql主从集群</title>
    <url>/2023/03/09/MysqlInDockerReplication/</url>
    <content><![CDATA[<h3 id="准备条件"><a href="#准备条件" class="headerlink" title="准备条件"></a>准备条件</h3><p>docker 已安装，mysql 镜像已拉取，这里以mysql/mysql-server:8.0 镜像为例</p>
<h3 id="创建mysql-主库"><a href="#创建mysql-主库" class="headerlink" title="创建mysql 主库"></a>创建mysql 主库</h3><p>配置文件中必须要有server-id，主从库必须不一样,在my.cnf 指定 </p>
<p>log-bin = mysql-bin<br>log-bin-index = mysql-bin.index<br>server-id=185<br>gtid-mode=on<br>enforce_gtid_consistency = 1<br>binlog-format=row<br>log_replica_updates = 1</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 创建指定目录。</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data/mysql_data/&#123;conf,data,<span class="built_in">log</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动主库容器</span></span><br><span class="line">docker run -p 3306:3306 --name mysql8-1 \ <span class="comment">##映射端口 跟给container 取个名字</span></span><br><span class="line">-v /data/mysql8_data/log:/var/log/mysql \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 日志</span></span><br><span class="line">-v /data/mysql8_data:/var/lib/mysql \  <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 数据目录</span></span><br><span class="line">-v /data/mysql8_data/conf/my.cnf:/etc/my.cnf \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 配置文件</span></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root123 \  <span class="comment">## -e 环境变量.初始化时设置数据库的root 密码</span></span><br><span class="line">-d mysql/mysql-server:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看数据库日志是否正常</span></span><br><span class="line">docker logs mysql8-1 2&gt;&amp;1 </span><br></pre></td></tr></table></figure>
<h3 id="创建mysql-从库"><a href="#创建mysql-从库" class="headerlink" title="创建mysql 从库"></a>创建mysql 从库</h3><p>配置文件中必须要有server-id，主从库必须不一样,在my.cnf 指定<br>port = 3307<br>log-bin = mysql-bin<br>log-bin-index = mysql-bin.index<br>server-id=186<br>gtid-mode=on<br>enforce_gtid_consistency = 1<br>binlog-format=row<br>log_replica_updates = 1<br>read_only<br>relay-log = relay-bin<br>relay_log_recovery = 1<br>replica_skip_errors = off</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 创建指定目录。</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data/mysql_slave_data/&#123;conf,data,<span class="built_in">log</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动主库容器</span></span><br><span class="line">docker run -p 3307:3307 --name mysql8-slave \ <span class="comment">##映射端口 跟给container 取个名字</span></span><br><span class="line">-v /data/mysql8_slave_data/log:/var/log/mysql \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 日志</span></span><br><span class="line">-v /data/mysql8_slave_data:/var/lib/mysql \  <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 数据目录</span></span><br><span class="line">-v /data/mysql8_slave_data/conf/my.cnf:/etc/my.cnf \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 配置文件</span></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root123 \  <span class="comment">## -e 环境变量.初始化时设置数据库的root 密码</span></span><br><span class="line">-d mysql/mysql-server:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看数据库日志是否正常</span></span><br><span class="line">docker logs mysql8-slave 2&gt;&amp;1 </span><br></pre></td></tr></table></figure>
<h3 id="创建复制用户"><a href="#创建复制用户" class="headerlink" title="创建复制用户"></a>创建复制用户</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql8-1 mysql -uroot -proot123 -e <span class="string">&quot;create user repl@&#x27;%&#x27; identified by &#x27;replpass&#x27;;grant select,replication slave on *.* to repl@&#x27;%&#x27;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="从库执行复制配置"><a href="#从库执行复制配置" class="headerlink" title="从库执行复制配置"></a>从库执行复制配置</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql8-slave mysql -uroot -proot123 -e <span class="string">&quot;CHANGE REPLICATION SOURCE TO \</span></span><br><span class="line"><span class="string">&gt; SOURCE_HOST=&#x27;192.168.56.15&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_PORT=3306,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_USER=&#x27;repl&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_PASSWORD=&#x27;replpass&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_AUTO_POSITION=1,\</span></span><br><span class="line"><span class="string">&gt; GET_MASTER_PUBLIC_KEY=1;&quot;</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql8-slave mysql -uroot -proot123 -e <span class="string">&quot;start replica;&quot;</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql8-slave mysql -uroot -proot123 -e <span class="string">&quot;show replicat status\G&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             Replica_IO_State: Waiting <span class="keyword">for</span> <span class="built_in">source</span> to send event</span><br><span class="line">                  Source_Host: 192.168.56.15</span><br><span class="line">                  Source_User: repl</span><br><span class="line">                  Source_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Source_Log_File: mysql-bin.000007</span><br><span class="line">          Read_Source_Log_Pos: 508</span><br><span class="line">               Relay_Log_File: relay-bin.000007</span><br><span class="line">                Relay_Log_Pos: 460</span><br><span class="line">        Relay_Source_Log_File: mysql-bin.000007</span><br><span class="line">           Replica_IO_Running: Yes</span><br><span class="line">          Replica_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Source_Log_Pos: 508</span><br><span class="line">              Relay_Log_Space: 1231</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Source_SSL_Allowed: No</span><br><span class="line">           Source_SSL_CA_File: </span><br><span class="line">           Source_SSL_CA_Path: </span><br><span class="line">              Source_SSL_Cert: </span><br><span class="line">            Source_SSL_Cipher: </span><br><span class="line">               Source_SSL_Key: </span><br><span class="line">        Seconds_Behind_Source: 0</span><br><span class="line">Source_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Source_Server_Id: 185</span><br><span class="line">                  Source_UUID: fca3aab0-bd94-11ed-9a7c-0242ac110002</span><br><span class="line">             Source_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">    Replica_SQL_Running_State: Replica has <span class="built_in">read</span> all relay <span class="built_in">log</span>; waiting <span class="keyword">for</span> more updates</span><br><span class="line">           Source_Retry_Count: 86400</span><br><span class="line">                  Source_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Source_SSL_Crl: </span><br><span class="line">           Source_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: fca3aab0-bd94-11ed-9a7c-0242ac110002:1-8</span><br><span class="line">            Executed_Gtid_Set: 8239dff7-bf0e-11ed-9ce5-0242ac110002:1-3,</span><br><span class="line">fca3aab0-bd94-11ed-9a7c-0242ac110002:1-8</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Source_TLS_Version: </span><br><span class="line">       Source_public_key_path: </span><br><span class="line">        Get_Source_public_key: 1</span><br><span class="line">            Network_Namespace: </span><br></pre></td></tr></table></figure>
<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><p>mysql8 默认是采用 caching_sha2_password 的密码加密方式，如果我们在 CHANGE REPLICATION SOURCE时<br>没有指定 GET_MASTER_PUBLIC_KEY=1。则在 start replica 的时候 会出现错误:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">error connecting to master <span class="string">&#x27;repl@192.168.56.15:3306&#x27;</span> - retry-time: 60 retries: 6 message:</span><br><span class="line">Authentication plugin <span class="string">&#x27;caching_sha2_password&#x27;</span> reported error: </span><br><span class="line">Authentication requires secure connection</span><br></pre></td></tr></table></figure><br>或者重置复制账号的密码为 mysql_native_password 的加密方式<br>alter user repl@’%’ identified with mysql_native_password by ‘replpass’;</p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>docker</tag>
        <tag>replication</tag>
      </tags>
  </entry>
  <entry>
    <title>将阿里云RDS备份拉回IDC做从库</title>
    <url>/2022/10/19/RecoveryDRSToIDc/</url>
    <content><![CDATA[<h3 id="1-登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定"><a href="#1-登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定" class="headerlink" title="1. 登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定"></a>1. 登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定</h3><p><img src="/images/20221019141152.png" alt="Lena"></p>
<h3 id="2-下载备份文件"><a href="#2-下载备份文件" class="headerlink" title="2. 下载备份文件"></a>2. 下载备份文件</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -c <span class="string">&quot;https://rdsbak-st-v2.oss-cn-shenzhen-internal.aliyuncs.com/custinxxxxxxx/hins21434496_data_20221019045743_qp.xb?xxxxxxxxxxxx.....&quot;</span> -O hins21434496_data_20221019045743_qp.xb </span><br></pre></td></tr></table></figure>
<h3 id="3-解压文件恢复xtrbackup-备份"><a href="#3-解压文件恢复xtrbackup-备份" class="headerlink" title="3.解压文件恢复xtrbackup 备份"></a>3.解压文件恢复xtrbackup 备份</h3><h5 id="A-如果环境中没有qpress-跟-xtrabackup-工具-则需要先下载安装"><a href="#A-如果环境中没有qpress-跟-xtrabackup-工具-则需要先下载安装" class="headerlink" title="A. 如果环境中没有qpress 跟 xtrabackup 工具 则需要先下载安装"></a>A. 如果环境中没有qpress 跟 xtrabackup 工具 则需要先下载安装</h5><p>对于MySQL 5.7、5.6或5.5实例：安装Percona XtraBackup 2.4。<br>对于MySQL 8.0实例，安装Percona XtraBackup 8.0。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget <span class="string">&quot;http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/183466/cn_zh/1608011575185/qpress-11-linux-x64.tar&quot;</span></span><br><span class="line">tar xvf qpress-11-linux-x64.tar</span><br><span class="line"><span class="built_in">chmod</span> 775 qpress</span><br><span class="line"><span class="built_in">cp</span> qpress /usr/bin</span><br></pre></td></tr></table></figure><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install libev</span><br><span class="line">wget <span class="string">&quot;https://downloads.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.26/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.26-1.el7.x86_64.rpm&quot;</span></span><br><span class="line">yum -y install percona-xtrabackup-24-2.4.26-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<h5 id="B-解压恢复"><a href="#B-解压恢复" class="headerlink" title="B. 解压恢复"></a>B. 解压恢复</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> data_common_xtrabackup</span><br><span class="line"><span class="built_in">cat</span> hins21434496_data_20221019045743_qp.xb | xbstream -x -v -C /usr/local/mysql/data_common_xtrabackup</span><br><span class="line">innobackupex --decompress --remove-original /usr/local/mysql/data_common_xtrabackup</span><br><span class="line">innobackupex --default-files=/usr/local/mysql/data_common_xtrabackup/backup-my.cnf --apply-log /usr/local/mysql/data_common_xtrabackup</span><br></pre></td></tr></table></figure>
<h3 id="4-搭建从库"><a href="#4-搭建从库" class="headerlink" title="4. 搭建从库"></a>4. 搭建从库</h3><h5 id="A-将backup-my-cnf-的innodb-部分参数添加到本地IDC-etc-my-cnf"><a href="#A-将backup-my-cnf-的innodb-部分参数添加到本地IDC-etc-my-cnf" class="headerlink" title="A. 将backup-my.cnf 的innodb 部分参数添加到本地IDC /etc/my.cnf"></a>A. 将backup-my.cnf 的innodb 部分参数添加到本地IDC /etc/my.cnf</h5><pre><code>innodb_log_files_in_group=2
innodb_log_file_size=1572864000
innodb_log_buffer_size=8388608
innodb_page_size=16384
innodb_undo_tablespaces=2
</code></pre><h5 id="B-完整的配置文件部分"><a href="#B-完整的配置文件部分" class="headerlink" title="B. 完整的配置文件部分"></a>B. 完整的配置文件部分</h5><pre><code>[mysqld4]
port    = 3309
socket  = /tmp/mysql.common_aliyun_slave.sock
datadir = /usr/local/mysql/data_common_aliyun_slave
innodb_data_home_dir = /usr/local/mysql/data_common_aliyun_slave
innodb_undo_directory = /usr/local/mysql/data_common_aliyun_slave
innodb_log_group_home_dir = /usr/local/mysql/data_common_aliyun_slave
innodb_buffer_pool_size = 10G
innodb_buffer_pool_instances = 10
innodb_fast_shutdown=0
innodb_log_files_in_group=2
innodb_log_file_size=1572864000
innodb_log_buffer_size=8388608
innodb_page_size=16384
innodb_undo_tablespaces=2
init_connect=&#39;set names utf8mb4&#39;
character-set-server=utf8mb4
server-id = 186
collation-server=utf8mb4_general_ci
log-slave-updates = true
skip-grant-tables #这个参数先添加以便去除权限登录数据库修改
</code></pre><h5 id="C-将恢复目录里面mysql-库的两个trigger-重命名-重置root-密码相关信息"><a href="#C-将恢复目录里面mysql-库的两个trigger-重命名-重置root-密码相关信息" class="headerlink" title="C. 将恢复目录里面mysql 库的两个trigger 重命名,重置root 密码相关信息"></a>C. 将恢复目录里面mysql 库的两个trigger 重命名,重置root 密码相关信息</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/mysql/data_common_aliyun_slave/mysql</span><br><span class="line"><span class="built_in">mv</span> user.TRG user.TRG.bak</span><br><span class="line"><span class="built_in">mv</span> proxies_priv.TRG proxies_priv.TRG.bak</span><br><span class="line">mysqld_multi start 4</span><br><span class="line">mysql -uroot -p -S /tmp/mysql.common_aliyun_slave.sock</span><br><span class="line">mysql&gt; use mysql</span><br><span class="line">mysql&gt; update user <span class="built_in">set</span> authentication_string=password(<span class="string">&#x27;xxx&#x27;</span>),host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span> <span class="built_in">where</span> user=<span class="string">&#x27;aliyun_root&#x27;</span>;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">mysql&gt; <span class="built_in">exit</span>;</span><br></pre></td></tr></table></figure>
<h5 id="D-查看恢复目录里面的-xtrabackup-info-文件-gtid-execute-信息"><a href="#D-查看恢复目录里面的-xtrabackup-info-文件-gtid-execute-信息" class="headerlink" title="D. 查看恢复目录里面的 xtrabackup_info 文件 gtid execute 信息"></a>D. 查看恢复目录里面的 xtrabackup_info 文件 gtid execute 信息</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> xtrabackup_info</span><br><span class="line">uuid = 99c6d1c2-4f2f-11ed-b7c8-0c42a1b70fa6</span><br><span class="line">name = </span><br><span class="line">.....</span><br><span class="line">lock_time = 1</span><br><span class="line">binlog_pos = filename <span class="string">&#x27;mysql-bin.000834&#x27;</span>, position 15350993, GTID of the last change <span class="string">&#x27;8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130585536&#x27;</span></span><br><span class="line">innodb_from_lsn = 0</span><br><span class="line">innodb_to_lsn = 437844748178</span><br><span class="line">partial = N</span><br><span class="line">incremental = N</span><br><span class="line">format = xbstream</span><br><span class="line">compact = N</span><br><span class="line">compressed = compressed</span><br><span class="line">encrypted = N</span><br></pre></td></tr></table></figure>
<h5 id="E-查看主库的gtid-purged-信息"><a href="#E-查看主库的gtid-purged-信息" class="headerlink" title="E. 查看主库的gtid purged 信息"></a>E. 查看主库的gtid purged 信息</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW GLOBAL VARIABLES LIKE <span class="string">&#x27;gtid_purged&#x27;</span>; </span><br><span class="line">8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130084627</span><br></pre></td></tr></table></figure>
<h5 id="F-将恢复的IDC实例作为云上的从库"><a href="#F-将恢复的IDC实例作为云上的从库" class="headerlink" title="F. 将恢复的IDC实例作为云上的从库"></a>F. 将恢复的IDC实例作为云上的从库</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; reset slave;</span><br><span class="line">mysql&gt; reset master;</span><br><span class="line">mysql&gt; <span class="built_in">set</span> @@global.gtid_purged=<span class="string">&#x27;8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130084627,8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130585536&#x27;</span></span><br><span class="line">mysql&gt; change master to</span><br><span class="line">mysql&gt; master_host=<span class="string">&#x27;xxxx.aliyun.xxxxx&#x27;</span>,</span><br><span class="line">mysql&gt; master_port=<span class="string">&#x27;xxxx&#x27;</span>,</span><br><span class="line">mysql&gt; master_user=<span class="string">&#x27;repuser&#x27;</span>,</span><br><span class="line">mysql&gt; master_password=<span class="string">&#x27;reppass&#x27;</span>,</span><br><span class="line">mysql&gt; master_auto_position=1;</span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure>
<p>可以看到数据库已经正确连接到阿里云上RDS</p>
<h3 id="5-注意"><a href="#5-注意" class="headerlink" title="5. 注意"></a>5. 注意</h3><p>set @@global.gtid_purged=’主库的gtid_purged,从库的gtid_excuted’<br>master_user ， master_password 为RDS 实例上已经建好具有 select, replication_slave 的权限账号以及密码</p>
<p>上面有将2个trigger 重命名的操作。是因为阿里的数据库对user 表做了限制。只有把2个trigger 拿掉,才能修改用户表<br>否则将报如下错误<br>    ERROR 1064 (42000): Unknown trigger has an error in its body: ‘Unknown system variable ‘maintain_user_list’’</p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>database</tag>
        <tag>aliyun RDS</tag>
      </tags>
  </entry>
  <entry>
    <title>MysqlPidSwapUse</title>
    <url>/2022/11/25/MysqlPidSwapUse/</url>
    <content><![CDATA[<p>有时候发现linux 操作系统的swap 发生了占用。但想知道究竟是被哪些进程占用。<br>这里的一个思路就是通过/proc/${pid}/smaps 文件统计出 对应的swap 占用</p>
<p>那么我们可以根据ps -ef |grep ${keyword} 过滤出想要查看的进程。然后将进程<br>id 循环查看/proc/${pid}/smaps 就可以得到每个进程的swap 占用</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> pid <span class="keyword">in</span> `ps -ef |grep <span class="variable">$&#123;filterKeyword&#125;</span> |awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   totSwap=$(<span class="built_in">cat</span> /proc/<span class="variable">$&#123;pid&#125;</span>/smaps |grep Swap |awk -v filter=<span class="variable">$&#123;filter&#125;</span> <span class="string">&#x27;BEGIN&#123;tot=0&#125;&#123;tot = tot + $2&#125;END&#123;if(tot &gt; filter)&#123;printf &quot;%sM\n&quot;,tot/1024&#125;&#125;&#x27;</span>)</span><br><span class="line">   [ -z <span class="variable">$&#123;totSwap&#125;</span> ] || <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;pid&#125;</span>: <span class="variable">$&#123;totSwap&#125;</span>&quot;</span> &gt;&gt; swap_in_use.log</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>工具URL:<br><a href="https://github.com/sheenzxx/mysqltool/blob/main/PidSwapUse.sh">https://github.com/sheenzxx/mysqltool/blob/main/PidSwapUse.sh</a></p>
]]></content>
      <categories>
        <category>shell</category>
      </categories>
      <tags>
        <tag>swap</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Shell的日期加减操作</title>
    <url>/2023/04/06/ShellDateAdd/</url>
    <content><![CDATA[<p>开发需要重跑一个任务。输入参数是一个时间字符串，<br>开发给的时间是202304050100 开始到202304061000点结束，按每个小时时间字符串来入传参数。<br>可以敲33个时间字符串，放在文件里面cat 循环输出。但能自动绝不对动手，敲33个时间字符串太无趣。<br>可以考虑写循环并且每个时间加一个小时来推进。关键是如何构造一个时间递加的方法。</p>
<p>日期的加减运算:<br>date -d “目标时间 +|-n year|month|week|day|hour|minute|second” +”时间格式”<br>目标时间需要注意的是 年月日(空格)时分秒<br>+n 表示往后加多少时间单位<br>-n 表示往前推多少时间单位<br>year|month|week|day|hour|minute|second 时间单位<br>+”时间格式” 加号与日期格式之间不能留空</p>
<p>有可能用到的是时间格式<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">%</span><span class="language-bash">H 小时，24小时制（00~23）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">I 小时，12小时制（01~12）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">k 小时，24小时制（0~23）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">l 小时，12小时制（1~12）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">M 分钟（00~59）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">p 显示出AM或PM</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">r 显示时间，12小时制（hh:mm:ss %p）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">s 从1970年1月1日00:00:00到目前经历的秒数</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">S 显示秒（00~59）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">T 显示时间，24小时制（hh:mm:ss）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">X 显示时间的格式（%H:%M:%S）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">Z 显示时区，日期域（CST）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">a 星期的简称（Sun~Sat）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">A 星期的全称（Sunday~Saturday）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">h,%b 月的简称（Jan~Dec）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">B 月的全称（January~December）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">c 日期和时间（Tue Nov 20 14:12:58 2012）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">d 一个月的第几天（01~31）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">x,%D 日期（mm/dd/yy）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">j 一年的第几天（001~366）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">m 月份（01~12）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">w 一个星期的第几天（0代表星期天）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">W 一年的第几个星期（00~53，星期一为第一天）</span> </span><br><span class="line"><span class="meta prompt_">%</span><span class="language-bash">y 年的最后两个数字（1999则是99）</span></span><br></pre></td></tr></table></figure></p>
<p>于是很快就能得到我们想要的代码<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">i=0</span><br><span class="line">while [ $i -le 33 ]</span><br><span class="line">do</span><br><span class="line">   let &#x27;i++&#x27;;</span><br><span class="line">   dstr=`date -d &quot;20230405 0000 +$i day&quot; +&quot;%Y%m%d%H%M&quot;</span><br><span class="line">   /data/PRG/tasks/rerun_task.sh $dstr</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>shell</category>
      </categories>
      <tags>
        <tag>date</tag>
      </tags>
  </entry>
  <entry>
    <title>虚拟机安装TiDB单机版</title>
    <url>/2022/12/07/TiDBSingle/</url>
    <content><![CDATA[<h3 id="TiDB-集群的基本架构"><a href="#TiDB-集群的基本架构" class="headerlink" title="TiDB 集群的基本架构"></a>TiDB 集群的基本架构</h3><p>TiDB 是众多国产数据库中，最具人气的一款。采用分布式架构。其中可分为如下3个部分：<br>TiDB server: SQL 层。此层无状态。主要工作就是对SQL进行解析，生成物理执行计划，<br>             将数据请求转发到底层的 TiKV</p>
<p>PD server: 复制整个TiDB集群的元信息管理。存储每个 TiKV 节点实时的数据分布情况<br>           和集群的整体拓扑结构。同时为分布式事务分配事务ID，同时还会根据 TiKV<br>           节点实时上报的数据分布状态，下发数据调度命令给具体的 TiKV 节点。可以<br>           说是整个集群的大脑</p>
<p>数据存储层：<br>      TiKV: 负责数据存储工作，通过RocksDB 数据库将数据持久化到磁盘中。TiKV 的<br>           基本存储单元为region .负责存储一个key range 的数据。每个TiKV 会负责多<br>           个region.集群里面TiKV 会为数据准备多个数据副本，并保存在多个TiKV 节点中<br>      TiFlash: TiFalsh 是为OLAP 运算加速而设计的。它设计以列式存储。</p>
<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><p>完整的配置官文很详细。<br><a href="https://docs.pingcap.com/zh/tidb/dev/check-before-deployment">https://docs.pingcap.com/zh/tidb/dev/check-before-deployment</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;fs.file-max = 1000000&quot;&gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo &quot;net.core.somaxconn = 32768&quot;&gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo &quot;net.ipv4.tcp_tw_recycle = 0&quot;&gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo &quot;net.ipv4.tcp_syncookies = 0&quot;&gt;&gt; /etc/sysctl.conf</span><br><span class="line">echo &quot;vm.overcommit_memory = 1&quot;&gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt;&gt;/etc/security/limits.conf</span><br><span class="line">tidb           soft    nofile          1000000</span><br><span class="line">tidb           hard    nofile          1000000</span><br><span class="line">tidb           soft    stack          32768</span><br><span class="line">tidb           hard    stack          32768</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="安装辅助工具TiUP"><a href="#安装辅助工具TiUP" class="headerlink" title="安装辅助工具TiUP"></a>安装辅助工具TiUP</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">有了TiUP 安装非常方便。特别是在线安装。</span><br><span class="line">下载并安装 tiup</span><br><span class="line">curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh</span><br><span class="line"></span><br><span class="line">安装完后执行命令,因为它往这个文件写入了tiup 的路径。需要<span class="built_in">source</span> 生效</span><br><span class="line"><span class="built_in">source</span> /root/.bash_profile </span><br></pre></td></tr></table></figure>
<h3 id="在线安装TiDB"><a href="#在线安装TiDB" class="headerlink" title="在线安装TiDB"></a>在线安装TiDB</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 安装 cluster 组件</span><br><span class="line">tiup cluster</span><br><span class="line"></span><br><span class="line">2.修改sshd 配置文件</span><br><span class="line">vi /etc/ssh/sshd_config</span><br><span class="line">MaxSessions = 20</span><br><span class="line">service sshd restart</span><br><span class="line"></span><br><span class="line">3.新建配置文件 topo.yaml 并按模板编辑。替换里面的host 为本机的IP</span><br><span class="line">user: <span class="string">&quot;tidb&quot;</span>：表示通过 tidb 系统用户（部署会自动创建）来做集群的内部管理，默认使用 22 端口通过 ssh 登录目标机器</span><br><span class="line">replication.enable-placement-rules：设置这个 PD 参数来确保 TiFlash 正常运行</span><br><span class="line">host：设置为本部署主机的 IP</span><br><span class="line"></span><br><span class="line">vi topo.yaml</span><br><span class="line"><span class="comment"># # Global variables are applied to all deployments and used as the default value of</span></span><br><span class="line"><span class="comment"># # the deployments if a specific deployment value is missing.</span></span><br><span class="line">global:</span><br><span class="line"> user: <span class="string">&quot;tidb&quot;</span></span><br><span class="line"> ssh_port: 22</span><br><span class="line"> deploy_dir: <span class="string">&quot;/tidb-deploy&quot;</span></span><br><span class="line"> data_dir: <span class="string">&quot;/tidb-data&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># # Monitored variables are applied to all the machines.</span></span><br><span class="line">monitored:</span><br><span class="line"> node_exporter_port: 9100</span><br><span class="line"> blackbox_exporter_port: 9115</span><br><span class="line"></span><br><span class="line">server_configs:</span><br><span class="line"> tidb:</span><br><span class="line">   log.slow-threshold: 300</span><br><span class="line"> tikv:</span><br><span class="line">   readpool.storage.use-unified-pool: <span class="literal">false</span></span><br><span class="line">   readpool.coprocessor.use-unified-pool: <span class="literal">true</span></span><br><span class="line"> pd:</span><br><span class="line">   replication.enable-placement-rules: <span class="literal">true</span></span><br><span class="line">   replication.location-labels: [<span class="string">&quot;host&quot;</span>]</span><br><span class="line"> tiflash:</span><br><span class="line">   logger.level: <span class="string">&quot;info&quot;</span></span><br><span class="line"></span><br><span class="line">pd_servers:</span><br><span class="line"> - host: 192.168.56.14</span><br><span class="line"></span><br><span class="line">tidb_servers:</span><br><span class="line"> - host: 192.168.56.14</span><br><span class="line"></span><br><span class="line">tikv_servers:</span><br><span class="line"> - host: 192.168.56.14</span><br><span class="line">   port: 20160</span><br><span class="line">   status_port: 20180</span><br><span class="line">   config:</span><br><span class="line">     server.labels: &#123; host: <span class="string">&quot;logic-host-1&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"> - host: 192.168.56.14</span><br><span class="line">   port: 20161</span><br><span class="line">   status_port: 20181</span><br><span class="line">   config:</span><br><span class="line">     server.labels: &#123; host: <span class="string">&quot;logic-host-2&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"> - host: 192.168.56.14</span><br><span class="line">   port: 20162</span><br><span class="line">   status_port: 20182</span><br><span class="line">   config:</span><br><span class="line">     server.labels: &#123; host: <span class="string">&quot;logic-host-3&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">tiflash_servers:</span><br><span class="line"> - host: 192.168.56.14</span><br><span class="line"></span><br><span class="line">monitoring_servers:</span><br><span class="line"> - host: 192.168.56.14</span><br><span class="line"></span><br><span class="line">grafana_servers:</span><br><span class="line"> - host: 192.168.56.14</span><br><span class="line"></span><br><span class="line">4. 执行集群部署命令</span><br><span class="line"></span><br><span class="line"><span class="comment">#tiup cluster deploy &lt;cluster-name&gt; &lt;tidb-version&gt; ./topo.yaml --user root -p</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># tiup cluster deploy TiDBCluster v6.1.3 ./topo.yaml --user root -p</span></span><br><span class="line">tiup is checking updates <span class="keyword">for</span> component cluster ...</span><br><span class="line">Starting component `cluster`: /root/.tiup/components/cluster/v1.11.1/tiup-cluster deploy TiDBCluster v6.1.3 ./topo.yaml --user root -p</span><br><span class="line">Input SSH password: </span><br><span class="line"></span><br><span class="line">+ Detect CPU Arch Name</span><br><span class="line">  - Detecting node 192.168.56.14 Arch info ... Done</span><br><span class="line"></span><br><span class="line">+ Detect CPU OS Name</span><br><span class="line">  - Detecting node 192.168.56.14 OS info ... Done</span><br><span class="line">Please confirm your topology:</span><br><span class="line">Cluster <span class="built_in">type</span>:    tidb</span><br><span class="line">Cluster name:    TiDBCluster</span><br><span class="line">Cluster version: v6.1.3</span><br><span class="line">Role        Host           Ports                            OS/Arch       Directories</span><br><span class="line">----        ----           -----                            -------       -----------</span><br><span class="line">pd          192.168.56.14  2379/2380                        linux/x86_64  /tidb-deploy/pd-2379,/tidb-data/pd-2379</span><br><span class="line">tikv        192.168.56.14  20160/20180                      linux/x86_64  /tidb-deploy/tikv-20160,/tidb-data/tikv-20160</span><br><span class="line">tikv        192.168.56.14  20161/20181                      linux/x86_64  /tidb-deploy/tikv-20161,/tidb-data/tikv-20161</span><br><span class="line">tikv        192.168.56.14  20162/20182                      linux/x86_64  /tidb-deploy/tikv-20162,/tidb-data/tikv-20162</span><br><span class="line">tidb        192.168.56.14  4000/10080                       linux/x86_64  /tidb-deploy/tidb-4000</span><br><span class="line">tiflash     192.168.56.14  9000/8123/3930/20170/20292/8234  linux/x86_64  /tidb-deploy/tiflash-9000,/tidb-data/tiflash-9000</span><br><span class="line">prometheus  192.168.56.14  9090/12020                       linux/x86_64  /tidb-deploy/prometheus-9090,/tidb-data/prometheus-9090</span><br><span class="line">grafana     192.168.56.14  3000                             linux/x86_64  /tidb-deploy/grafana-3000</span><br><span class="line">Attention:</span><br><span class="line">    1. If the topology is not what you expected, check your yaml file.</span><br><span class="line">    2. Please confirm there is no port/directory conflicts <span class="keyword">in</span> same host.</span><br><span class="line">Do you want to <span class="built_in">continue</span>? [y/N]: (default=N) y</span><br><span class="line">+ Generate SSH keys ... Done</span><br><span class="line">+ Download TiDB components</span><br><span class="line">  - Download pd:v6.1.3 (linux/amd64) ... Done</span><br><span class="line">  - Download tikv:v6.1.3 (linux/amd64) ... Error</span><br><span class="line">  - Download tidb:v6.1.3 (linux/amd64) ... Error</span><br><span class="line">  - Download tiflash:v6.1.3 (linux/amd64) ... Error</span><br><span class="line">  - Download prometheus:v6.1.3 (linux/amd64) ... Done</span><br><span class="line">  - Download grafana:v6.1.3 (linux/amd64) ... Done</span><br><span class="line">  - Download node_exporter: (linux/amd64) ... Done</span><br><span class="line">  - Download blackbox_exporter: (linux/amd64) ... Done</span><br><span class="line"></span><br><span class="line">Error: download from https://tiup-mirrors.pingcap.com/tiflash-v6.1.3-linux-amd64.tar.gz failed: <span class="built_in">read</span> tcp 10.0.2.13:50586-&gt;183.60.150.53:443: <span class="built_in">read</span>: connection reset by peer</span><br><span class="line"></span><br><span class="line">Verbose debug logs has been written to /root/.tiup/logs/tiup-cluster-debug-2022-12-13-10-37-25.<span class="built_in">log</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">#网络请求超时</span></span><br><span class="line">好吧。try it later... 1000 years later...</span><br><span class="line">try it again and again</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># tiup cluster deploy TiDBCluster v6.1.3 ./topo.yaml --user root -p</span></span><br><span class="line">tiup is checking updates <span class="keyword">for</span> component cluster ...</span><br><span class="line">Starting component `cluster`: /root/.tiup/components/cluster/v1.11.1/tiup-cluster deploy TiDBCluster v6.1.3 ./topo.yaml --user root -p</span><br><span class="line">Input SSH password: </span><br><span class="line"></span><br><span class="line">+ Detect CPU Arch Name</span><br><span class="line">  - Detecting node 192.168.56.14 Arch info ... Done</span><br><span class="line"></span><br><span class="line">+ Detect CPU OS Name</span><br><span class="line">  - Detecting node 192.168.56.14 OS info ... Done</span><br><span class="line">Please confirm your topology:</span><br><span class="line">Cluster <span class="built_in">type</span>:    tidb</span><br><span class="line">Cluster name:    TiDBCluster</span><br><span class="line">Cluster version: v6.1.3</span><br><span class="line">Role        Host           Ports                            OS/Arch       Directories</span><br><span class="line">----        ----           -----                            -------       -----------</span><br><span class="line">pd          192.168.56.14  2379/2380                        linux/x86_64  /tidb-deploy/pd-2379,/tidb-data/pd-2379</span><br><span class="line">tikv        192.168.56.14  20160/20180                      linux/x86_64  /tidb-deploy/tikv-20160,/tidb-data/tikv-20160</span><br><span class="line">tikv        192.168.56.14  20161/20181                      linux/x86_64  /tidb-deploy/tikv-20161,/tidb-data/tikv-20161</span><br><span class="line">tikv        192.168.56.14  20162/20182                      linux/x86_64  /tidb-deploy/tikv-20162,/tidb-data/tikv-20162</span><br><span class="line">tidb        192.168.56.14  4000/10080                       linux/x86_64  /tidb-deploy/tidb-4000</span><br><span class="line">tiflash     192.168.56.14  9000/8123/3930/20170/20292/8234  linux/x86_64  /tidb-deploy/tiflash-9000,/tidb-data/tiflash-9000</span><br><span class="line">prometheus  192.168.56.14  9090/12020                       linux/x86_64  /tidb-deploy/prometheus-9090,/tidb-data/prometheus-9090</span><br><span class="line">grafana     192.168.56.14  3000                             linux/x86_64  /tidb-deploy/grafana-3000</span><br><span class="line">Attention:</span><br><span class="line">    1. If the topology is not what you expected, check your yaml file.</span><br><span class="line">    2. Please confirm there is no port/directory conflicts <span class="keyword">in</span> same host.</span><br><span class="line">Do you want to <span class="built_in">continue</span>? [y/N]: (default=N) y</span><br><span class="line">+ Generate SSH keys ... Done</span><br><span class="line">+ Download TiDB components</span><br><span class="line">  - Download pd:v6.1.3 (linux/amd64) ... Done</span><br><span class="line">  - Download tikv:v6.1.3 (linux/amd64) ... Done</span><br><span class="line">  - Download tidb:v6.1.3 (linux/amd64) ... Done</span><br><span class="line">  - Download tiflash:v6.1.3 (linux/amd64) ... Done</span><br><span class="line">  - Download prometheus:v6.1.3 (linux/amd64) ... Done</span><br><span class="line">  - Download grafana:v6.1.3 (linux/amd64) ... Done</span><br><span class="line">  - Download node_exporter: (linux/amd64) ... Done</span><br><span class="line">  - Download blackbox_exporter: (linux/amd64) ... Done</span><br><span class="line">+ Initialize target host environments</span><br><span class="line">  - Prepare 192.168.56.14:22 ... Done</span><br><span class="line">+ Deploy TiDB instance</span><br><span class="line">  - Copy pd -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Copy tikv -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Copy tikv -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Copy tikv -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Copy tidb -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Copy tiflash -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Copy prometheus -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Copy grafana -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Deploy node_exporter -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Deploy blackbox_exporter -&gt; 192.168.56.14 ... Done</span><br><span class="line">+ Copy certificate to remote host</span><br><span class="line">+ Init instance configs</span><br><span class="line">  - Generate config pd -&gt; 192.168.56.14:2379 ... Done</span><br><span class="line">  - Generate config tikv -&gt; 192.168.56.14:20160 ... Done</span><br><span class="line">  - Generate config tikv -&gt; 192.168.56.14:20161 ... Done</span><br><span class="line">  - Generate config tikv -&gt; 192.168.56.14:20162 ... Done</span><br><span class="line">  - Generate config tidb -&gt; 192.168.56.14:4000 ... Done</span><br><span class="line">  - Generate config tiflash -&gt; 192.168.56.14:9000 ... Done</span><br><span class="line">  - Generate config prometheus -&gt; 192.168.56.14:9090 ... Done</span><br><span class="line">  - Generate config grafana -&gt; 192.168.56.14:3000 ... Done</span><br><span class="line">+ Init monitor configs</span><br><span class="line">  - Generate config node_exporter -&gt; 192.168.56.14 ... Done</span><br><span class="line">  - Generate config blackbox_exporter -&gt; 192.168.56.14 ... Done</span><br><span class="line">+ Check status</span><br><span class="line">Enabling component pd</span><br><span class="line">        Enabling instance 192.168.56.14:2379</span><br><span class="line">        Enable instance 192.168.56.14:2379 success</span><br><span class="line">Enabling component tikv</span><br><span class="line">        Enabling instance 192.168.56.14:20162</span><br><span class="line">        Enabling instance 192.168.56.14:20160</span><br><span class="line">        Enabling instance 192.168.56.14:20161</span><br><span class="line">        Enable instance 192.168.56.14:20161 success</span><br><span class="line">        Enable instance 192.168.56.14:20162 success</span><br><span class="line">        Enable instance 192.168.56.14:20160 success</span><br><span class="line">Enabling component tidb</span><br><span class="line">        Enabling instance 192.168.56.14:4000</span><br><span class="line">        Enable instance 192.168.56.14:4000 success</span><br><span class="line">Enabling component tiflash</span><br><span class="line">        Enabling instance 192.168.56.14:9000</span><br><span class="line">        Enable instance 192.168.56.14:9000 success</span><br><span class="line">Enabling component prometheus</span><br><span class="line">        Enabling instance 192.168.56.14:9090</span><br><span class="line">        Enable instance 192.168.56.14:9090 success</span><br><span class="line">Enabling component grafana</span><br><span class="line">        Enabling instance 192.168.56.14:3000</span><br><span class="line">        Enable instance 192.168.56.14:3000 success</span><br><span class="line">Enabling component node_exporter</span><br><span class="line">        Enabling instance 192.168.56.14</span><br><span class="line">        Enable 192.168.56.14 success</span><br><span class="line">Enabling component blackbox_exporter</span><br><span class="line">        Enabling instance 192.168.56.14</span><br><span class="line">        Enable 192.168.56.14 success</span><br><span class="line">Cluster `TiDBCluster` deployed successfully, you can start it with <span class="built_in">command</span>: `tiup cluster start TiDBCluster --init`</span><br><span class="line"></span><br><span class="line"><span class="comment">#终于下载安装成功。失败后执行相同的命令重试。之前下载成功的包只是验证不需要重新下载。直到全部done 之后就自动安装了</span></span><br><span class="line"><span class="comment">#迫不及待。来启动下看看</span></span><br><span class="line">tiup cluster start TiDBCluster --init</span><br><span class="line">[root@localhost ~]<span class="comment"># tiup cluster start TiDBCluster --init</span></span><br><span class="line">tiup is checking updates <span class="keyword">for</span> component cluster ...</span><br><span class="line">Starting component `cluster`: /root/.tiup/components/cluster/v1.11.1/tiup-cluster start TiDBCluster --init</span><br><span class="line">Starting cluster TiDBCluster...</span><br><span class="line">+ [ Serial ] - SSHKeySet: privateKey=/root/.tiup/storage/cluster/clusters/TiDBCluster/ssh/id_rsa, publicKey=/root/.tiup/storage/cluster/clusters/TiDBCluster/ssh/id_rsa.pub</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [ Serial ] - StartCluster</span><br><span class="line">Starting component pd</span><br><span class="line">        Starting instance 192.168.56.14:2379</span><br><span class="line">        Start instance 192.168.56.14:2379 success</span><br><span class="line">Starting component tikv</span><br><span class="line">        Starting instance 192.168.56.14:20162</span><br><span class="line">        Starting instance 192.168.56.14:20160</span><br><span class="line">        Starting instance 192.168.56.14:20161</span><br><span class="line">        Start instance 192.168.56.14:20161 success</span><br><span class="line">        Start instance 192.168.56.14:20162 success</span><br><span class="line">        Start instance 192.168.56.14:20160 success</span><br><span class="line">Starting component tidb</span><br><span class="line">        Starting instance 192.168.56.14:4000</span><br><span class="line"></span><br><span class="line">Error: failed to start tidb: failed to start: 192.168.56.14 tidb-4000.service, please check the instance<span class="string">&#x27;s log(/tidb-deploy/tidb-4000/log) for more detail.: timed out waiting for port 4000 to be started after 2m0s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">报错了</span></span><br><span class="line"><span class="string">查看日志：</span></span><br><span class="line"><span class="string">vi /tidb-deploy/tidb-4000/log/tidb.log</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">[2022/12/13 10:42:49.558 +08:00] [FATAL] [bootstrap.go:2088] [&quot;mustExecute error&quot;] [error=&quot;tikv disk full&quot;] [stack=&quot;github.com/pingcap/tidb/session.mustExecute\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/bootstrap.go:2088\ngithub.com/pingcap/tidb/session.insertBuiltinBindInfoRow\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/bootstrap.go:1461\ngithub.com/pingcap/tidb/session.initBindInfoTable\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/bootstrap.go:1457\ngithub.com/pingcap/tidb/session.doDDLWorks\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/bootstrap.go:1941\ngithub.com/pingcap/tidb/session.bootstrap\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/bootstrap.go:445\ngithub.com/pingcap/tidb/session.runInBootstrapSession\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2961\ngithub.com/pingcap/tidb/session.BootstrapSession\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/session/session.go:2849\nmain.createStoreAndDomain\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/tidb-server/main.go:296\nmain.main\n\t/home/jenkins/agent/workspace/build-common/go/src/github.com/pingcap/tidb/tidb-server/main.go:202\nruntime.main\n\t/usr/local/go/src/runtime/proc.go:250&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">error=&quot;tikv disk full&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">但是查看磁盘信息</span></span><br><span class="line"><span class="string">[root@localhost ~]# df -h</span></span><br><span class="line"><span class="string">Filesystem               Size  Used Avail Use% Mounted on</span></span><br><span class="line"><span class="string">devtmpfs                 8.6G     0  8.6G   0% /dev</span></span><br><span class="line"><span class="string">tmpfs                    8.6G     0  8.6G   0% /dev/shm</span></span><br><span class="line"><span class="string">tmpfs                    8.6G  8.6M  8.6G   1% /run</span></span><br><span class="line"><span class="string">tmpfs                    8.6G     0  8.6G   0% /sys/fs/cgroup</span></span><br><span class="line"><span class="string">/dev/mapper/centos-root  9.2G  6.3G  3.0G  68% /</span></span><br><span class="line"><span class="string">/dev/sda1               1014M  156M  859M  16% /boot</span></span><br><span class="line"><span class="string">tmpfs                    1.8G     0  1.8G   0% /run/user/0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">还有3G 空闲空间</span></span><br></pre></td></tr></table></figure>
<h3 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h3><p>最后在社区论坛翻到一篇提问<br><a href="https://asktug.com/t/topic/513370">https://asktug.com/t/topic/513370</a></p>
<p>里面有提到可能是磁盘预留空间过小<br><a href="https://docs.pingcap.com/zh/tidb/stable/tikv-configuration-file/#reserve-space">https://docs.pingcap.com/zh/tidb/stable/tikv-configuration-file/#reserve-space</a><br>reserve-space<br>TiKV 启动时会预留一块空间用于保护磁盘空间。当磁盘剩余空间小于该预留空间时，<br>TiKV 会限制部分写操作。预留空间形式上分为两个部分：预留空间的 80% 用作磁盘空间不足时的运维操作所<br>需要的额外磁盘空间，剩余的 20% 为磁盘临时文件。在回收空间的过程中，如果额外使用的磁盘空间过多，导致<br>存储耗尽时，该临时文件会成为恢复服务的最后一道防御。<br>临时文件名为 space_placeholder_file，位于 storage.data-dir 目录下。当 TiKV 因磁盘空间耗尽而下线时，<br>重启 TiKV 会自动删除该临时文件，并自动尝试回收空间。当剩余空间不足时，TiKV 不会创建该临时文件。防御的<br>有效性与预留空间的大小有关。预留空间大小的计算方式为磁盘容量的 5% 与该配置项之间的最大值。当该配置项的<br>值为 0MB 时，TiKV 会关闭磁盘防护功能。<br>默认值：5GB<br>单位：MB|GB</p>
<p>停服务，停机把空间调大<br>由于虚拟机使用vmdk 格式。在OVM 里面需先改成vdi 才能扩容<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:\Users\Administrator&gt;D:\VirtualBox\VboxManage clonehd --format VDI F:\VirtualBox_VMS\TiDB\TiDB-disk1.vmdk F:\VirtualBox_VMS\TiDB\TiDB-disk1.vdi</span><br><span class="line">0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%</span><br><span class="line">Clone medium created in format &#x27;VDI&#x27;. UUID: f3343571-9286-4de3-8d81-2db0e1014cdf</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator&gt;D:\VirtualBox\VboxManage modifymedium F:\VirtualBox_VMS\TiDB\TiDB-disk1.vdi --resize 40960</span><br><span class="line">0%...10%...20%...30%...40%...50%...60%...70%...80%...90%...100%</span><br><span class="line"></span><br><span class="line">在ovm 里面把存储修改为扩容的TiDB-disk1.vdi </span><br><span class="line">然后启动实例</span><br></pre></td></tr></table></figure></p>
<p>修改分区<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# fdisk /dev/sda</span><br><span class="line">Welcome to fdisk (util-linux 2.23.2).</span><br><span class="line"></span><br><span class="line">Changes will remain in memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write command.</span><br><span class="line"></span><br><span class="line">Command (m for help): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x000be816</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/sda2         2099200    16777215     7339008   8e  Linux LVM</span><br><span class="line">/dev/sda3        16777216    41943039    12582912    5  Extended</span><br><span class="line">/dev/sda5        16779264    41943039    12581888   8e  Linux LVM</span><br><span class="line"></span><br><span class="line">Command (m for help): n</span><br><span class="line">Partition type:</span><br><span class="line">   p   primary (2 primary, 1 extended, 1 free)</span><br><span class="line">   l   logical (numbered from 5)</span><br><span class="line">Select (default p): p</span><br><span class="line">Selected partition 4</span><br><span class="line">First sector (41943040-83886079, default 41943040): </span><br><span class="line">Using default value 41943040</span><br><span class="line">Last sector, +sectors or +size&#123;K,M,G&#125; (41943040-83886079, default 83886079): </span><br><span class="line">Using default value 83886079</span><br><span class="line">Partition 4 of type Linux and of size 20 GiB is set</span><br><span class="line"></span><br><span class="line">Command (m for help): p</span><br><span class="line"></span><br><span class="line">Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disk label type: dos</span><br><span class="line">Disk identifier: 0x000be816</span><br><span class="line"></span><br><span class="line">   Device Boot      Start         End      Blocks   Id  System</span><br><span class="line">/dev/sda1   *        2048     2099199     1048576   83  Linux</span><br><span class="line">/dev/sda2         2099200    16777215     7339008   8e  Linux LVM</span><br><span class="line">/dev/sda3        16777216    41943039    12582912    5  Extended</span><br><span class="line">/dev/sda4        41943040    83886079    20971520   83  Linux</span><br><span class="line">/dev/sda5        16779264    41943039    12581888   8e  Linux LVM</span><br><span class="line"></span><br><span class="line">Command (m for help): w</span><br><span class="line">The partition table has been altered!</span><br><span class="line"></span><br><span class="line">##格式化新分区</span><br><span class="line">[root@localhost ~]# mkfs -t xfs /dev/sda4</span><br><span class="line">meta-data=/dev/sda4              isize=512    agcount=4, agsize=1310720 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0, sparse=0</span><br><span class="line">data     =                       bsize=4096   blocks=5242880, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line">log      =internal log           bsize=4096   blocks=2560, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br><span class="line"></span><br><span class="line">##创建新的逻辑卷</span><br><span class="line">[root@localhost ~]# pvcreate /dev/sda4</span><br><span class="line">WARNING: xfs signature detected on /dev/sda4 at offset 0. Wipe it? [y/n]: y</span><br><span class="line">  Wiping xfs signature on /dev/sda4.</span><br><span class="line">  Physical volume &quot;/dev/sda4&quot; successfully created.</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# vgdisplay </span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               centos</span><br><span class="line">  System ID             </span><br><span class="line">  Format                lvm2</span><br><span class="line">  Metadata Areas        3</span><br><span class="line">  Metadata Sequence No  6</span><br><span class="line">  VG Access             read/write</span><br><span class="line">  VG Status             resizable</span><br><span class="line">  MAX LV                0</span><br><span class="line">  Cur LV                2</span><br><span class="line">  Open LV               2</span><br><span class="line">  Max PV                0</span><br><span class="line">  Cur PV                3</span><br><span class="line">  Act PV                3</span><br><span class="line">  VG Size               &lt;38.99 GiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              9981</span><br><span class="line">  Alloc PE / Size       2559 / &lt;10.00 GiB</span><br><span class="line">  Free  PE / Size       7422 / 28.99 GiB</span><br><span class="line">  VG UUID               3JfbC5-EXRn-70u3-rRza-aKuL-Z9bP-mS8aRQ</span><br><span class="line"></span><br><span class="line">##扩展跟目录分区</span><br><span class="line">[root@localhost ~]# lvextend -L +20G /dev/centos/root</span><br><span class="line">  Size of logical volume centos/root changed from &lt;9.20 GiB (2354 extents) to &lt;29.20 GiB (7474 extents).</span><br><span class="line">  Logical volume centos/root successfully resized.  </span><br><span class="line">##同步文件系统</span><br><span class="line">[root@localhost ~]# xfs_growfs /dev/mapper/centos-root </span><br><span class="line">meta-data=/dev/mapper/centos-root isize=512    agcount=6, agsize=406016 blks</span><br><span class="line">         =                       sectsz=512   attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=0 spinodes=0</span><br><span class="line">data     =                       bsize=4096   blocks=2410496, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=1</span><br><span class="line">log      =internal               bsize=4096   blocks=2560, version=2</span><br><span class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br><span class="line"></span><br><span class="line">[root@localhost ~]# df -h</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">devtmpfs                 8.6G     0  8.6G   0% /dev</span><br><span class="line">tmpfs                    8.6G     0  8.6G   0% /dev/shm</span><br><span class="line">tmpfs                    8.6G  8.6M  8.6G   1% /run</span><br><span class="line">tmpfs                    8.6G     0  8.6G   0% /sys/fs/cgroup</span><br><span class="line">/dev/mapper/centos-root   30G  6.3G   23G  22% /</span><br><span class="line">/dev/sda1               1014M  156M  859M  16% /boot</span><br><span class="line">tmpfs                    1.8G     0  1.8G   0% /run/user/0</span><br></pre></td></tr></table></figure></p>
<p>再次启动看看<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# tiup cluster start TiDBCluster --init</span><br><span class="line">tiup is checking updates for component cluster ...</span><br><span class="line">Starting component `cluster`: /root/.tiup/components/cluster/v1.11.1/tiup-cluster start TiDBCluster --init</span><br><span class="line">Starting cluster TiDBCluster...</span><br><span class="line">+ [ Serial ] - SSHKeySet: privateKey=/root/.tiup/storage/cluster/clusters/TiDBCluster/ssh/id_rsa, publicKey=/root/.tiup/storage/cluster/clusters/TiDBCluster/ssh/id_rsa.pub</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [Parallel] - UserSSH: user=tidb, host=192.168.56.14</span><br><span class="line">+ [ Serial ] - StartCluster</span><br><span class="line">Starting component pd</span><br><span class="line">        Starting instance 192.168.56.14:2379</span><br><span class="line">        Start instance 192.168.56.14:2379 success</span><br><span class="line">Starting component tikv</span><br><span class="line">        Starting instance 192.168.56.14:20162</span><br><span class="line">        Starting instance 192.168.56.14:20160</span><br><span class="line">        Starting instance 192.168.56.14:20161</span><br><span class="line">        Start instance 192.168.56.14:20161 success</span><br><span class="line">        Start instance 192.168.56.14:20162 success</span><br><span class="line">        Start instance 192.168.56.14:20160 success</span><br><span class="line">Starting component tidb</span><br><span class="line">        Starting instance 192.168.56.14:4000</span><br><span class="line">        Start instance 192.168.56.14:4000 success</span><br><span class="line">Starting component tiflash</span><br><span class="line">        Starting instance 192.168.56.14:9000</span><br><span class="line">        Start instance 192.168.56.14:9000 success</span><br><span class="line">Starting component prometheus</span><br><span class="line">        Starting instance 192.168.56.14:9090</span><br><span class="line">        Start instance 192.168.56.14:9090 success</span><br><span class="line">Starting component grafana</span><br><span class="line">        Starting instance 192.168.56.14:3000</span><br><span class="line">        Start instance 192.168.56.14:3000 success</span><br><span class="line">Starting component node_exporter</span><br><span class="line">        Starting instance 192.168.56.14</span><br><span class="line">        Start 192.168.56.14 success</span><br><span class="line">Starting component blackbox_exporter</span><br><span class="line">        Starting instance 192.168.56.14</span><br><span class="line">        Start 192.168.56.14 success</span><br><span class="line">+ [ Serial ] - UpdateTopology: cluster=TiDBCluster</span><br><span class="line">Started cluster `TiDBCluster` successfully</span><br><span class="line">The root password of TiDB database has been changed.</span><br><span class="line">The new password is: &#x27;9g_K-b=DTx42fS81@3&#x27;.</span><br><span class="line">Copy and record it to somewhere safe, it is only displayed once, and will not be stored.</span><br><span class="line">The generated password can NOT be get and shown again.</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>启动成功了</p>
<p>查看节点状态<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# tiup cluster display TiDBCluster</span><br><span class="line">tiup is checking updates for component cluster ...</span><br><span class="line">Starting component `cluster`: /root/.tiup/components/cluster/v1.11.1/tiup-cluster display TiDBCluster</span><br><span class="line">Cluster type:       tidb</span><br><span class="line">Cluster name:       TiDBCluster</span><br><span class="line">Cluster version:    v6.1.3</span><br><span class="line">Deploy user:        tidb</span><br><span class="line">SSH type:           builtin</span><br><span class="line">Dashboard URL:      http://192.168.56.14:2379/dashboard</span><br><span class="line">Grafana URL:        http://192.168.56.14:3000</span><br><span class="line">ID                   Role        Host           Ports                            OS/Arch       Status   Data Dir                    Deploy Dir</span><br><span class="line">--                   ----        ----           -----                            -------       ------   --------                    ----------</span><br><span class="line">192.168.56.14:3000   grafana     192.168.56.14  3000                             linux/x86_64  Up       -                           /tidb-deploy/grafana-3000</span><br><span class="line">192.168.56.14:2379   pd          192.168.56.14  2379/2380                        linux/x86_64  Up|L|UI  /tidb-data/pd-2379          /tidb-deploy/pd-2379</span><br><span class="line">192.168.56.14:9090   prometheus  192.168.56.14  9090/12020                       linux/x86_64  Up       /tidb-data/prometheus-9090  /tidb-deploy/prometheus-9090</span><br><span class="line">192.168.56.14:4000   tidb        192.168.56.14  4000/10080                       linux/x86_64  Up       -                           /tidb-deploy/tidb-4000</span><br><span class="line">192.168.56.14:9000   tiflash     192.168.56.14  9000/8123/3930/20170/20292/8234  linux/x86_64  Up       /tidb-data/tiflash-9000     /tidb-deploy/tiflash-9000</span><br><span class="line">192.168.56.14:20160  tikv        192.168.56.14  20160/20180                      linux/x86_64  Up       /tidb-data/tikv-20160       /tidb-deploy/tikv-20160</span><br><span class="line">192.168.56.14:20161  tikv        192.168.56.14  20161/20181                      linux/x86_64  Up       /tidb-data/tikv-20161       /tidb-deploy/tikv-20161</span><br><span class="line">192.168.56.14:20162  tikv        192.168.56.14  20162/20182                      linux/x86_64  Up       /tidb-data/tikv-20162       /tidb-deploy/tikv-20162</span><br><span class="line">Total nodes: 8</span><br><span class="line"></span><br><span class="line">查看当前部署的集群列表</span><br><span class="line">[root@localhost ~]# tiup cluster list</span><br><span class="line">tiup is checking updates for component cluster ...</span><br><span class="line">Starting component `cluster`: /root/.tiup/components/cluster/v1.11.1/tiup-cluster list</span><br><span class="line">Name         User  Version  Path                                              PrivateKey</span><br><span class="line">----         ----  -------  ----                                              ----------</span><br><span class="line">TiDBCluster  tidb  v6.1.3   /root/.tiup/storage/cluster/clusters/TiDBCluster  /root/.tiup/storage/cluster/clusters/TiDBCluster/ssh/id_rsa</span><br><span class="line"></span><br><span class="line">访问数据库</span><br><span class="line">[root@localhost ~]# mysql -h 192.168.56.14 -P 4000 -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 441</span><br><span class="line">Server version: 5.7.25-TiDB-v6.1.3 TiDB Server (Apache License 2.0) Community Edition, MySQL 5.7 compatible</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| INFORMATION_SCHEMA |</span><br><span class="line">| METRICS_SCHEMA     |</span><br><span class="line">| PERFORMANCE_SCHEMA |</span><br><span class="line">| mysql              |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>TiDB</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>tidb</tag>
        <tag>国产数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>ckOptimize</title>
    <url>/2023/01/11/ckOptimize/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>搭建clichouse 集群</title>
    <url>/2023/01/29/buildClickHouseCluster/</url>
    <content><![CDATA[<h4 id="一-规划："><a href="#一-规划：" class="headerlink" title="一 规划："></a>一 规划：</h4><p>本次搭建采用3个服务器搭建一个 3分片2副本的clickhouse 集群。命名规则中。以S 代表分片。R代表复制集。集群架构如下图<br><img src="images/clickhouse.png" alt="cka"></p>
<p>172.28.160.2 上面存放2个实例分别为 S1R1(分片1复制集1)实例， S2R2(分片2复制集2)实例<br>172.28.160.3 上面存放2个实例分别为 S2R1(分片2复制集1)实例， S3R2(分片3复制集2)实例<br>172.28.160.4 上面存放2个实例分别为 S3R1(分片3复制集1)实例， S3R2(分片1复制集2)实例</p>
<p>以确保在宕机任何一个节点。都不会影响集群的正常使用<br>同时在三个节点上启动clickhouse-keeper ，用于分布式集群通讯。（旧版本中用zookeeper）</p>
<p>主机实例分布<br><img src="images/c1t1.png" alt="c1t1"><br><img src="images/c2t2.png" alt="c2t2"><br><img src="images/c3t3.png" alt="c3t3"></p>
<h4 id="二-安装"><a href="#二-安装" class="headerlink" title="二 安装"></a>二 安装</h4><h5 id="1-下载-clickhouse-稳定版本地址-：https-packages-clickhouse-com-rpm-stable"><a href="#1-下载-clickhouse-稳定版本地址-：https-packages-clickhouse-com-rpm-stable" class="headerlink" title="1. 下载 clickhouse 稳定版本地址 ：https://packages.clickhouse.com/rpm/stable/"></a>1. 下载 clickhouse 稳定版本地址 ：<a href="https://packages.clickhouse.com/rpm/stable/">https://packages.clickhouse.com/rpm/stable/</a></h5><p>本次安装采用RPM 安装，使用版本 22.12.3.5<br>需下载的rpm 包有<br>clickhouse-common-static-22.12.3.5.x86_64.rpm<br>clickhouse-server-22.12.3.5.x86_64.rpm<br>clickhouse-client-22.12.3.5.x86_64.rpm</p>
<h5 id="2-安装前检测以及优化系统项配置"><a href="#2-安装前检测以及优化系统项配置" class="headerlink" title="2. 安装前检测以及优化系统项配置"></a>2. 安装前检测以及优化系统项配置</h5><p>检查当前CPU是否支持SSE 4.2的命令<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grep -q sse4_2 /proc/cpuinfo &amp;&amp; echo &quot;SSE 4.2 supported&quot; || echo &quot;SSE 4.2 not supported&quot;</span><br></pre></td></tr></table></figure><br>设置内存分配策略为：0<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo 0 |tee /proc/sys/vm/overcommit_memory</span><br></pre></td></tr></table></figure><br>禁用透明大页<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;never&quot; |tee /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"># 永久禁用</span><br><span class="line">echo &#x27;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#x27; &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure><br>/etc/hosts 添加集群主机名IP地址映射<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">172.28.160.2 ct-bigdata-clickhouse-160-2</span><br><span class="line">172.28.160.3 ct-bigdata-clickhouse-160-3</span><br><span class="line">172.28.160.4 ct-bigdata-clickhouse-160-4</span><br></pre></td></tr></table></figure></p>
<h5 id="3-按顺序安装RPM-包"><a href="#3-按顺序安装RPM-包" class="headerlink" title="3. 按顺序安装RPM 包"></a>3. 按顺序安装RPM 包</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ct-bigdata-clickhouse-160-2 clickhouseSoft]# rpm -ivh clickhouse-common-static-22.12.3.5.x86_64.rpm</span><br><span class="line">Preparing... ################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">      1:clickhouse-common-static-0:22.12.################################# [100%]</span><br><span class="line"></span><br><span class="line">安装clickhouse-server 中间提升需要设置default 密码。输入设置即可。会在 /etc/clickhouse-server/users.d/default-password.xml 保存这个密码     </span><br><span class="line"></span><br><span class="line">[root@ct-bigdata-clickhouse-160-2 clickhouseSoft]# rpm -ivh clickhouse-server-22.12.3.5.x86_64.rpm</span><br><span class="line">Preparing... ################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">1:clickhouse-server-0:22.12.3.5-1 ################################# [100%]</span><br><span class="line">ClickHouse binary is already located at /usr/bin/clickhouse</span><br><span class="line">Symlink /usr/bin/clickhouse-server already exists but it points to /clickhouse. Will replace the old symlink to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-server to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-client to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-local to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-benchmark to /usr/bin/clickhouse.</span><br><span class="line">Symlink /usr/bin/clickhouse-copier already exists but it points to /clickhouse. Will replace the old symlink to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-copier to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-obfuscator to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-git-import to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-compressor to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-format to /usr/bin/clickhouse.</span><br><span class="line">Symlink /usr/bin/clickhouse-extract-from-config already exists but it points to /clickhouse. Will replace the old symlink to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-extract-from-config to /usr/bin/clickhouse.</span><br><span class="line">Symlink /usr/bin/clickhouse-keeper already exists but it points to /clickhouse. Will replace the old symlink to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-keeper to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-keeper-converter to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-disks to /usr/bin/clickhouse.</span><br><span class="line">Creating clickhouse group if it does not exist.</span><br><span class="line">groupadd -r clickhouse</span><br><span class="line">Creating clickhouse user if it does not exist.</span><br><span class="line">useradd -r --shell /bin/false --home-dir /nonexistent -g clickhouse clickhouse</span><br><span class="line">Will set ulimits for clickhouse user in /etc/security/limits.d/clickhouse.conf.</span><br><span class="line">Creating config directory /etc/clickhouse-server/config.d that is used for tweaks of main server configuration.</span><br><span class="line">Creating config directory /etc/clickhouse-server/users.d that is used for tweaks of users configuration.</span><br><span class="line">Config file /etc/clickhouse-server/config.xml already exists, will keep it and extract path info from it.</span><br><span class="line">/etc/clickhouse-server/config.xml has /var/lib/clickhouse/ as data path.</span><br><span class="line">/etc/clickhouse-server/config.xml has /var/log/clickhouse-server/ as log path.</span><br><span class="line">Users config file /etc/clickhouse-server/users.xml already exists, will keep it and extract users info from it.</span><br><span class="line">Creating log directory /var/log/clickhouse-server/.</span><br><span class="line">Creating data directory /var/lib/clickhouse/.</span><br><span class="line">Creating pid directory /var/run/clickhouse-server.</span><br><span class="line">chown -R clickhouse:clickhouse &#x27;/var/log/clickhouse-server/&#x27;</span><br><span class="line">chown -R clickhouse:clickhouse &#x27;/var/run/clickhouse-server&#x27;</span><br><span class="line">chown clickhouse:clickhouse &#x27;/var/lib/clickhouse/&#x27;</span><br><span class="line">groupadd -r clickhouse-bridge</span><br><span class="line">useradd -r --shell /bin/false --home-dir /nonexistent -g clickhouse-bridge clickhouse-bridge</span><br><span class="line">chown -R clickhouse-bridge:clickhouse-bridge &#x27;/usr/bin/clickhouse-odbc-bridge&#x27;</span><br><span class="line">chown -R clickhouse-bridge:clickhouse-bridge &#x27;/usr/bin/clickhouse-library-bridge&#x27;</span><br><span class="line">Enter password for default user:</span><br><span class="line">Password for default user is saved in file /etc/clickhouse-server/users.d/default-password.xml.</span><br><span class="line">Setting capabilities for clickhouse binary. This is optional.</span><br><span class="line">Cannot set &#x27;net_admin&#x27; or &#x27;ipc_lock&#x27; or &#x27;sys_nice&#x27; or &#x27;net_bind_service&#x27; capability for clickhouse binary. This is optional. Taskstats accounting will be disabled. To enable taskstats accounting you may add the required capability later manually.</span><br><span class="line">chown -R clickhouse:clickhouse &#x27;/etc/clickhouse-server&#x27;</span><br><span class="line"></span><br><span class="line">ClickHouse has been successfully installed.</span><br><span class="line"></span><br><span class="line">Start clickhouse-server with:</span><br><span class="line">sudo clickhouse start</span><br><span class="line"></span><br><span class="line">Start clickhouse-client with:</span><br><span class="line">clickhouse-client --password</span><br><span class="line"></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/clickhouse-server.service to /usr/lib/systemd/system/clickhouse-server.service.</span><br><span class="line"></span><br><span class="line">[root@ct-bigdata-clickhouse-160-2 clickhouseSoft]# rpm -ivh clickhouse-client-22.12.3.5.x86_64.rpm</span><br><span class="line">Preparing... ################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">1:clickhouse-client-0:22.12.3.5-1 ################################# [100%]</span><br></pre></td></tr></table></figure>
<p>安装完这3个rpm 包同时也包含clickhouse-keeper 不需要额外安装,以上步骤均在各个节点上执行</p>
<h5 id="4-设置目录"><a href="#4-设置目录" class="headerlink" title="4. 设置目录"></a>4. 设置目录</h5><p>在 172.28.160.2 节点上<br>设置实例存储目录<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /data1/clickhouse/s1r1</span><br><span class="line">mkdir -p /data2/clickhouse/s2r2</span><br><span class="line">chown -R clickhouse:clickhouse /data1/clickhouse</span><br><span class="line">chown -R clickhouse:clickhouse /data2/clickhouse</span><br><span class="line">cd /var/lib/clickhouse/</span><br><span class="line">ln -s /data1/clickhouse/s1r1 s1r1</span><br><span class="line">ln -s /data2/clickhouse/s2r2 s2r2</span><br></pre></td></tr></table></figure><br>设置各个实例日志目录<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /var/log/clickhouse-server/&#123;s1r1,s2r2&#125;</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-server</span><br></pre></td></tr></table></figure><br>设置clickhouse-keeper 存储目录<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /var/lib/clickhouse/keeper/coordination</span><br><span class="line">mkdir -p /var/log/clickhouse-keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/lib/clickhouse/keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-keeper</span><br></pre></td></tr></table></figure><br>在172.28.160.3 节点上<br>设置实例存储目录<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /data1/clickhouse/s2r1</span><br><span class="line">mkdir -p /data2/clickhouse/s3r2</span><br><span class="line">chown -R clickhouse:clickhouse /data1/clickhouse</span><br><span class="line">chown -R clickhouse:clickhouse /data2/clickhouse</span><br><span class="line">ln -s /data1/clickhouse/s2r1 s2r1</span><br><span class="line">ln -s /data2/clickhouse/s3r2 s3r2</span><br></pre></td></tr></table></figure><br>设置各个实例日志目录<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /var/log/clickhouse-server/&#123;s2r1,s3r2&#125;</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-server</span><br></pre></td></tr></table></figure><br>设置clickhouse-keeper 存储目录<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /var/lib/clickhouse/keeper/coordination</span><br><span class="line">mkdir -p /var/log/clickhouse-keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/lib/clickhouse/keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-keeper</span><br></pre></td></tr></table></figure><br>在172.28.160.4 节点上<br>设置实例存储目录<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /data1/clickhouse/s3r1</span><br><span class="line">mkdir -p /data2/clickhouse/s1r2</span><br><span class="line">chown -R clickhouse:clickhouse /data1/clickhouse</span><br><span class="line">chown -R clickhouse:clickhouse /data2/clickhouse</span><br><span class="line">ln -s /data1/clickhouse/s3r1 s3r1</span><br><span class="line">ln -s /data2/clickhouse/s1r2 s1r2</span><br></pre></td></tr></table></figure><br>设置各个实例日志目录<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /var/log/clickhouse-server/&#123;s3r1,s1r2&#125;</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-server</span><br></pre></td></tr></table></figure><br>设置clickhouse-keeper 存储目录<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /var/lib/clickhouse/keeper/coordination</span><br><span class="line">mkdir -p /var/log/clickhouse-keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/lib/clickhouse/keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-keeper</span><br></pre></td></tr></table></figure></p>
<h5 id="5-设置配置文件"><a href="#5-设置配置文件" class="headerlink" title="5. 设置配置文件"></a>5. 设置配置文件</h5><p>在172.28.160.2 上<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /etc/clickhouse-server/</span><br><span class="line">cp config.xml config_s1r1.xml </span><br></pre></td></tr></table></figure><br>在config_s1r1.xml  中 将以下参数替换成如下参数,将路径指向我们定义好的路径</p>
<p>日志部分 设置waring 级别，并将错误日志，日志指向 s1r1<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">level</span>&gt;</span>warning<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">log</span>&gt;</span>/var/log/clickhouse-server/s1r1/clickhouse-server.log<span class="tag">&lt;/<span class="name">log</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">errorlog</span>&gt;</span>/var/log/clickhouse-server/s1r1/clickhouse-server.err.log<span class="tag">&lt;/<span class="name">errorlog</span>&gt;</span></span><br></pre></td></tr></table></figure><br>设置数据文件存放路径<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/s1r1<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tmp_path</span>&gt;</span>/var/lib/clickhouse/s1r1/tmp/<span class="tag">&lt;/<span class="name">tmp_path</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user_files_path</span>&gt;</span>/var/lib/clickhouse/s1r1/user_files/<span class="tag">&lt;/<span class="name">user_files_path</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user_directories</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">local_directory</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/s1r1/access/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">local_directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user_directories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 宏定义，表示分片1 副本 1 用于分布式表--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>01<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>01-1<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure><br>设置集群信息，在remote_servers 表签下，将原有的信息删除，仅保留 <remote_servers></remote_servers>,并添加信息如下</p>
<p>设置一个3分片2副本集群 <three_shards_tow_replicated> 表示集群名称  <shard> </shard> 表示分片，<shard> 中的 <replica> 表示 分片中的的副本信息<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">remote_servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">three_shards_tow_replicated</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                      <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                      <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                      <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                      <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                  <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                  <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                  <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                  <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                              <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                              <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                              <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                              <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">three_shards_tow_replicated</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">remote_servers</span>&gt;</span></span><br></pre></td></tr></table></figure><br>打开zookeeper 配置信息<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">zookeeper</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zookeeper</span>&gt;</span></span><br></pre></td></tr></table></figure><br>设置好config 配置文件后，将其拷贝一份</p>
<p>cp config_s1r1.xml config_s2r2.xml</p>
<p>修改config_s2r2.xml如下</p>
<p>将其中涉及路径 s1r1 全部替换为 s2r2</p>
<p>端口部分修改为如下对应<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">http_port</span>&gt;</span>8124<span class="tag">&lt;/<span class="name">http_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">tcp_port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">tcp_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mysql_port</span>&gt;</span>9014<span class="tag">&lt;/<span class="name">mysql_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">postgresql_port</span>&gt;</span>9015<span class="tag">&lt;/<span class="name">postgresql_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">interserver_http_port</span>&gt;</span>9019<span class="tag">&lt;/<span class="name">interserver_http_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 宏定义部分 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>02<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>02-2<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>为其他节点准备配置文件<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp config_s1r1.xml config_s2r1.xml</span><br><span class="line"></span><br><span class="line">cp config_s1r1.xml config_s3r1.xml</span><br><span class="line"></span><br><span class="line">cp config_s2r2.xml config_s3r2.xml</span><br><span class="line"></span><br><span class="line">cp config_s2r2.xml config_s1r2.xml</span><br></pre></td></tr></table></figure><br>修改 config_s2r1.xml</p>
<p>将路径中的s1r1 全部替换成 s2r1</p>
<p>宏定义部分<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>02<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>02-1<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure><br>修改 config_s3r1.xml</p>
<p>将路径中的s1r1 全部替换成 s3r1</p>
<p>宏定义部分<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>03<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>03-1<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure><br>修改 config_s3r2.xml</p>
<p>将路径中的s2r2 全部替换成 s3r2</p>
<p>宏定义部分<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>03<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>03-2<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>将路径中的s2r2 全部替换成 s1r2</p>
<p>宏定义部分<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>01<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>01-2<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>将文件分发到各个节点上</p>
<p>172.28.160.2 保留  config_s1r1.xml config_s2r2.xml 文件</p>
<p>172.28.160.3 保留  config_s2r1.xml config_s3r2.xml 文件</p>
<p>172.28.160.4 保留  config_s3r1.xml config_s1r2.xml 文件<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">scp  config_s2r1.xml config_s3r2.xml  172.28.160.3:/etc/clickhouse-server/</span><br><span class="line"></span><br><span class="line">scp  config_s3r1.xml config_s1r2.xml  172.28.160.4:/etc/clickhouse-server/</span><br></pre></td></tr></table></figure><br>在172.28.160.2 上删除多余的文件</p>
<p>rm -f  config_s2r1.xml config_s3r2.xml  config_s3r1.xml config_s1r2.xml</p>
<p>新增clickhouse-keeper 配置文件</p>
<p>vi keeper.xml<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">clickhouse</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">logger</span>&gt;</span></span><br><span class="line">                 <span class="comment">&lt;!-- Possible levels [1]:</span></span><br><span class="line"><span class="comment">                    - none (turns off logging)</span></span><br><span class="line"><span class="comment">                    - fatal</span></span><br><span class="line"><span class="comment">                    - critical</span></span><br><span class="line"><span class="comment">                    - error</span></span><br><span class="line"><span class="comment">                    - warning</span></span><br><span class="line"><span class="comment">                    - notice</span></span><br><span class="line"><span class="comment">                    - information</span></span><br><span class="line"><span class="comment">                    - debug</span></span><br><span class="line"><span class="comment">                    - trace</span></span><br><span class="line"><span class="comment">                       [1]: https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/Logger.h#L105-L114</span></span><br><span class="line"><span class="comment">                    --&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">level</span>&gt;</span>warning<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">log</span>&gt;</span>/var/log/clickhouse-keeper/clickhouse-keeper.log<span class="tag">&lt;/<span class="name">log</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">errorlog</span>&gt;</span>/var/log/clickhouse-keeper/clickhouse-keeper.err.log<span class="tag">&lt;/<span class="name">errorlog</span>&gt;</span></span><br><span class="line">                  <span class="comment">&lt;!-- Rotation policy</span></span><br><span class="line"><span class="comment">                         See https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/FileChannel.h#L54-L85</span></span><br><span class="line"><span class="comment">                   --&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">size</span>&gt;</span>1000M<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">count</span>&gt;</span>10<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">                  <span class="comment">&lt;!-- &lt;console&gt;1&lt;/console&gt; --&gt;</span> <span class="comment">&lt;!-- Default behavior is autodetection (log to console if not daemon mode and is tty) --&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">max_connections</span>&gt;</span>4096<span class="tag">&lt;/<span class="name">max_connections</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 监听IP ,不设置的话只挂本地127.0.0.1 ::1: 上--&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">listen_host</span>&gt;</span>0.0.0.0<span class="tag">&lt;/<span class="name">listen_host</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">keeper_server</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">tcp_port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">tcp_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="comment">&lt;!-- Must be unique among all keeper serves --&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">server_id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">server_id</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">log_storage_path</span>&gt;</span>/var/lib/clickhouse/keeper/coordination/logs<span class="tag">&lt;/<span class="name">log_storage_path</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">snapshot_storage_path</span>&gt;</span>/var/lib/clickhouse/keeper/coordination/snapshots<span class="tag">&lt;/<span class="name">snapshot_storage_path</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">coordination_settings</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">operation_timeout_ms</span>&gt;</span>10000<span class="tag">&lt;/<span class="name">operation_timeout_ms</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">min_session_timeout_ms</span>&gt;</span>30000<span class="tag">&lt;/<span class="name">min_session_timeout_ms</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">session_timeout_ms</span>&gt;</span>30000<span class="tag">&lt;/<span class="name">session_timeout_ms</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">raft_logs_level</span>&gt;</span>warning<span class="tag">&lt;/<span class="name">raft_logs_level</span>&gt;</span></span><br><span class="line">                             <span class="comment">&lt;!-- All settings listed in https://github.com/ClickHouse/ClickHouse/blob/master/src/Coordination/CoordinationSettings.h --&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">coordination_settings</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                  <span class="comment">&lt;!-- enable sanity hostname checks for cluster configuration (e.g. if localhost is used with remote endpoints) --&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">hostname_checks_enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">hostname_checks_enabled</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">raft_configuration</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">hostname</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">hostname</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>9444<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">hostname</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">hostname</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>9444<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">id</span>&gt;</span>3<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">hostname</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">hostname</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">port</span>&gt;</span>9444<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                         <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                         <span class="comment">&lt;!-- Add more servers here --&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">raft_configuration</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">keeper_server</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">clickhouse</span>&gt;</span></span><br></pre></td></tr></table></figure><br>将keeper.xml 拷贝到其他2个节点上<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">scp  keeper.xml  172.28.160.3:/etc/clickhouse-server/</span><br><span class="line">scp  keeper.xml  172.28.160.4:/etc/clickhouse-server/</span><br></pre></td></tr></table></figure><br>在172.28.160.3 修改 keeper.xml  替换server_id  为 <server_id>2</server_id></p>
<p>在172.28.160.4 修改 keeper.xml  替换server_id  为 <server_id>3</server_id></p>
<p>配置user.xml 文件,添加集群用户repl。3节点上都添加</p>
<p>vi user.xml<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- replicat user --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">repl</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">password_sha256_hex</span>&gt;</span>SHA256PASSWORD<span class="tag">&lt;/<span class="name">password_sha256_hex</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">networks</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;/<span class="name">networks</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">profile</span>&gt;</span>default<span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">quota</span>&gt;</span>default<span class="tag">&lt;/<span class="name">quota</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">repl</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></table></figure><br>重新全部授权 clickhouse </p>
<p>chown -R clickhouse:clickhouse /etc/clickhouse-server</p>
<h5 id="6-设置systemctl-启动脚本，并启动集群"><a href="#6-设置systemctl-启动脚本，并启动集群" class="headerlink" title="6. 设置systemctl 启动脚本，并启动集群"></a>6. 设置systemctl 启动脚本，并启动集群</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi  clickhouse-keeper.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=ClickHouse Keeper (analytic DBMS <span class="keyword">for</span> big data)</span><br><span class="line">Requires=network-online.target</span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> that After/Wants=time-sync.target is not enough, you need to ensure</span></span><br><span class="line"><span class="comment"># that the time was adjusted already, if you use systemd-timesyncd you are</span></span><br><span class="line"><span class="comment"># safe, but if you use ntp or some other daemon, you should configure it</span></span><br><span class="line"><span class="comment"># additionaly.</span></span><br><span class="line">After=time-sync.target network-online.target</span><br><span class="line">Wants=time-sync.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=clickhouse</span><br><span class="line">Group=clickhouse</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=30</span><br><span class="line">ExecStart=/usr/bin/clickhouse-keeper --config=/etc/clickhouse-server/keeper.xml --pid-file=/var/lib/clickhouse/keeper/clickhouse-keeper.pid</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">CapabilityBoundingSet=CAP_NET_ADMIN CAP_IPC_LOCK CAP_SYS_NICE CAP_NET_BIND_SERVICE</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="comment"># ClickHouse should not start from the rescue shell (rescue.target).</span></span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>将启动脚本拷贝到/lib/systemd/system/<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp clickhouse-keeper.service /lib/systemd/system/clickhouse-keeper.service</span><br></pre></td></tr></table></figure><br>重载并启动<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start clickhouse-keeper.service</span><br></pre></td></tr></table></figure><br>启动成功验证<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl status clickhouse-keeper.service</span><br></pre></td></tr></table></figure><br>将这个脚本拷贝到其他2个服务器上。执行同样的操作。</p>
<p>这样keeper 集群就启动了，可以通过跟zookeeper 一样的四字母命令来查看zookeeper 的状态<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ct-bigdata-clickhouse-160-2 clickhouse-server]# echo mntr | nc localhost 2181</span><br><span class="line">zk_version v22.12.3.5-stable-893de538f0298310edb9ea1d7c83968cbbc5310f</span><br><span class="line">zk_avg_latency 0</span><br><span class="line">zk_max_latency 0</span><br><span class="line">zk_min_latency 0</span><br><span class="line">zk_packets_received 0</span><br><span class="line">zk_packets_sent 0</span><br><span class="line">zk_num_alive_connections 0</span><br><span class="line">zk_outstanding_requests 0</span><br><span class="line">zk_server_state leader</span><br><span class="line">zk_znode_count 3</span><br><span class="line">zk_watch_count 0</span><br><span class="line">zk_ephemerals_count 0</span><br><span class="line">zk_approximate_data_size 644</span><br><span class="line">zk_key_arena_size 4096</span><br><span class="line">zk_latest_snapshot_size 0</span><br><span class="line">zk_open_file_descriptor_count 41</span><br><span class="line">zk_max_file_descriptor_count 12640848</span><br><span class="line">zk_followers 2</span><br><span class="line">zk_synced_followers 2</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>需要注意的是keeper 启动raft 协议需要用到ipv6<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">### 如遇到如下错误。检查是否禁用了ipv6 ,查看并修改 /etc/default/grub </span></span><br><span class="line">&lt;Error&gt; RaftInstance: got exception: open: Address family not supported by protocol [system:97] on port 9444</span><br><span class="line"></span><br><span class="line"><span class="comment"># vi /etc/default/grub</span></span><br><span class="line">删除  ipv6.disable=1 这个选项</span><br><span class="line">重新生成grub 配置文件</span><br><span class="line"><span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br><span class="line">重启操作系统</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure></p>
<p>接下来配置clickhouse-server 的启动脚本<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp /lib/systemd/system/clickhouse-server.service   /lib/systemd/system/clickhouse-server_s1r1.service</span><br></pre></td></tr></table></figure><br>修改启动配置文件的路径以及pid 文件的存放路径<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vi /lib/systemd/system/clickhouse-server_s1r1.service  </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=ClickHouse Server (analytic DBMS for big data)</span><br><span class="line">Requires=network-online.target</span><br><span class="line"># NOTE: that After/Wants=time-sync.target is not enough, you need to ensure</span><br><span class="line"># that the time was adjusted already, if you use systemd-timesyncd you are</span><br><span class="line"># safe, but if you use ntp or some other daemon, you should configure it</span><br><span class="line"># additionaly.</span><br><span class="line">After=time-sync.target network-online.target</span><br><span class="line">Wants=time-sync.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line"># Switching off watchdog is very important for sd_notify to work correctly.</span><br><span class="line">Environment=CLICKHOUSE_WATCHDOG_ENABLE=0</span><br><span class="line">User=clickhouse</span><br><span class="line">Group=clickhouse</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=30</span><br><span class="line">RuntimeDirectory=clickhouse-server</span><br><span class="line">ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s1r1.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s1r1.pid</span><br><span class="line"># Minus means that this file is optional.</span><br><span class="line">EnvironmentFile=-/etc/default/clickhouse</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">CapabilityBoundingSet=CAP_NET_ADMIN CAP_IPC_LOCK CAP_SYS_NICE CAP_NET_BIND_SERVICE</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"># ClickHouse should not start from the rescue shell (rescue.target).</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><br>对应的其他实例在ExecStart=的位置将配置文件指定到对应的配置文件以及路径上。</p>
<p>在172.28.160.2 上</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lickhouse-server_s1r1.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s1r1.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s1r1.pid</span><br><span class="line"></span><br><span class="line">clickhouse-server_s2r2.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s2r2.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s2r2.pid</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s1r1.service</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s2r2.service</span><br></pre></td></tr></table></figure>
<p>在172.28.160.3 上<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lickhouse-server_s2r1.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s2r1.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s2r1.pid</span><br><span class="line"></span><br><span class="line">clickhouse-server_s3r2.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s3r2.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s3r2.pid</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s2r1.service</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s3r2.service</span><br></pre></td></tr></table></figure><br>在172.28.160.4 上<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lickhouse-server_s3r1.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s3r1.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s3r1.pid</span><br><span class="line"></span><br><span class="line">clickhouse-server_s1r2.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s1r2.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s1r2.pid</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s3r1.service</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s1r2.service</span><br></pre></td></tr></table></figure></p>
<h5 id="7-集群验证"><a href="#7-集群验证" class="headerlink" title="7. 集群验证"></a>7. 集群验证</h5><p>节点启动成功后,可以登录本地节点查看<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@ct-bigdata-clickhouse-160-2 ~]# clickhouse-client --user=default --password=123456</span><br><span class="line">ClickHouse client version 22.12.3.5 (official build).</span><br><span class="line">Connecting to localhost:9000 as user default.</span><br><span class="line">Connected to ClickHouse server version 22.12.3 revision 54461.</span><br><span class="line"></span><br><span class="line">ct-bigdata-clickhouse-160-2 :) </span><br><span class="line"></span><br><span class="line">ct-bigdata-clickhouse-160-2 :) select * from system.clusters;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM system.clusters</span><br><span class="line"></span><br><span class="line">Query id: 85ad631d-dacf-49d0-a410-3b3420d2e619</span><br><span class="line"></span><br><span class="line">┌─cluster─────────────────────┬─shard_num─┬─shard_weight─┬─replica_num─┬─host_name────┬─host_address─┬─port─┬─is_local─┬─user─┬─default_database─┬─errors_count─┬─slowdowns_count─┬─estimated_recovery_time─┐</span><br><span class="line">│ three_shards_tow_replicated │ 1 │ 1 │ 1 │ 172.28.160.2 │ 172.28.160.2 │ 9000 │ 1 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 1 │ 1 │ 2 │ 172.28.160.4 │ 172.28.160.4 │ 9001 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 2 │ 1 │ 1 │ 172.28.160.3 │ 172.28.160.3 │ 9000 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 2 │ 1 │ 2 │ 172.28.160.2 │ 172.28.160.2 │ 9001 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 3 │ 1 │ 1 │ 172.28.160.4 │ 172.28.160.4 │ 9000 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 3 │ 1 │ 2 │ 172.28.160.3 │ 172.28.160.3 │ 9001 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">└─────────────────────────────┴───────────┴──────────────┴─────────────┴──────────────┴──────────────┴──────┴──────────┴──────┴──────────────────┴──────────────┴─────────────────┴─────────────────────────┘</span><br><span class="line"></span><br><span class="line">6 rows in set. Elapsed: 0.001 sec.</span><br></pre></td></tr></table></figure><br>通过查询clusters 系统表。可以看到集群信息</p>
<p>建一个集群表验证一下<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ct-bigdata-clickhouse-160-2 :) create table test_cluster_table on cluster three_shards_tow_replicated (id int,name String,price int ) ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/&#123;shard&#125;/default/test_cluster_table&#x27;,&#x27;&#123;replica&#125;&#x27;) ORDER BY id;</span><br><span class="line"></span><br><span class="line">CREATE TABLE test_cluster_table ON CLUSTER three_shards_tow_replicated</span><br><span class="line">(</span><br><span class="line">`id` int,</span><br><span class="line">`name` String,</span><br><span class="line">`price` int</span><br><span class="line">)</span><br><span class="line">ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/&#123;shard&#125;/default/test_cluster_table&#x27;, &#x27;&#123;replica&#125;&#x27;)</span><br><span class="line">ORDER BY id</span><br><span class="line"></span><br><span class="line">Query id: 0461fe5a-19f6-4017-9683-a596670b34e3</span><br><span class="line"></span><br><span class="line">┌─host─────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐</span><br><span class="line">│ 172.28.160.4 │ 9000 │ 0 │ │ 5 │ 0 │</span><br><span class="line">│ 172.28.160.4 │ 9001 │ 0 │ │ 4 │ 0 │</span><br><span class="line">│ 172.28.160.3 │ 9001 │ 0 │ │ 3 │ 0 │</span><br><span class="line">│ 172.28.160.2 │ 9000 │ 0 │ │ 2 │ 0 │</span><br><span class="line">│ 172.28.160.2 │ 9001 │ 0 │ │ 1 │ 0 │</span><br><span class="line">│ 172.28.160.3 │ 9000 │ 0 │ │ 0 │ 0 │</span><br><span class="line">└──────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘</span><br><span class="line"></span><br><span class="line">6 rows in set. Elapsed: 0.310 sec.</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>可以看到各个节点上均已创建了表，集群功能正常</p>
<p>验证插入数据<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ct-bigdata-clickhouse-160-2 :) insert into test_cluster_table values(1,&#x27;光猫200&#x27;,88)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ct-bigdata-clickhouse-160-2 :) select * from test_cluster_table;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM test_cluster_table</span><br><span class="line"></span><br><span class="line">Query id: c29c5e62-8843-4456-98b5-2cdda06068fb</span><br><span class="line"></span><br><span class="line">┌─id─┬─name────┬─price─┐</span><br><span class="line">│ 1 │ 光猫200 │ 88 │</span><br><span class="line">└────┴─────────┴───────┘</span><br><span class="line"></span><br><span class="line">1 row in set. Elapsed: 0.001 sec.</span><br><span class="line"></span><br><span class="line">[root@ct-bigdata-clickhouse-160-4 ~]# clickhouse-client --user=default --password=123456 --port=9001</span><br><span class="line">ClickHouse client version 22.12.3.5 (official build).</span><br><span class="line">Connecting to localhost:9001 as user default.</span><br><span class="line">Connected to ClickHouse server version 22.12.3 revision 54461.</span><br><span class="line"></span><br><span class="line">ct-bigdata-clickhouse-160-4 :) select * from test_cluster_table;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM test_cluster_table</span><br><span class="line"></span><br><span class="line">Query id: 97c833d2-cd9a-4994-95c6-7919555b5e55</span><br><span class="line"></span><br><span class="line">┌─id─┬─name────┬─price─┐</span><br><span class="line">│ 1 │ 光猫200 │ 88 │</span><br><span class="line">└────┴─────────┴───────┘</span><br><span class="line"></span><br><span class="line">1 row in set. Elapsed: 0.001 sec.</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><br>上面的结果可以看到 在s1r1 插入的数据。在 s1r2 实例上可以看到。replica 功能正常。</p>
<p>以上为clickhouse 集群安装完整步骤。</p>
<h5 id="8-将集群配置独立写到metrika-xml-的方法"><a href="#8-将集群配置独立写到metrika-xml-的方法" class="headerlink" title="8. 将集群配置独立写到metrika.xml 的方法"></a>8. 将集群配置独立写到metrika.xml 的方法</h5><p>上述安装过程是将集群配置 <remote_servers> 写在 config 配置文件中，这里提供另一种方案，将remote_servers 的配置写在额外的配置文件中。默认额外配置文件读取路径为 /etc/metrika.xml</p>
<p>1) 在 172.28.160.2 节点上 /etc/config.d/ 目录中创建文件 metrika.xml </p>
<p>vi metrika.xml<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">yandex</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">three_shards_tow_replicated</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">three_shards_tow_replicated</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">yandex</span>&gt;</span></span><br></pre></td></tr></table></figure><br>将该文件发送到其他节点上上<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">scp metrika.xml 172.28.160.3:/etc/clickhouse-server/config.d/</span><br><span class="line"></span><br><span class="line">scp metrika.xml 172.28.160.4:/etc/clickhouse-server/config.d/</span><br></pre></td></tr></table></figure><br>三个节点上对该文件修改所有者为 clickhouse</p>
<p>2) 修改config 文件，所有实例的config 文件都要修改</p>
<p>将原先<code>&lt;remote_servers&gt;。。。&lt;/remote_servers&gt;</code> 的配置屏蔽或者删除</p>
<p>添加<br>表示将引用子文件 clickhouse_remote_servers 属性下的配置,incl对应metrika 里面的标签名。<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">remote_servers</span> <span class="attr">incl</span>=<span class="string">&quot;clickhouse_remote_servers&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><br>修改读取 metrika.xml 的路径。<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">include_from</span>&gt;</span>/etc/clickhouse-server/config.d/metrika.xml<span class="tag">&lt;/<span class="name">include_from</span>&gt;</span></span><br></pre></td></tr></table></figure><br>3) 重启实例，并检查集群是否正常</p>
]]></content>
      <categories>
        <category>clickhouse</category>
      </categories>
      <tags>
        <tag>cluster</tag>
      </tags>
  </entry>
  <entry>
    <title>处理clickhouse MaterializeMySQL 数据库故障一则</title>
    <url>/2023/07/21/clickhouseMaterializeMySQL/</url>
    <content><![CDATA[<p>开发同事报clickhouse 的 MaterializeMySQL 数据库查询都报错<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">SQL 错误 [48] [07000]: Code: 48, e.displayText() = DB::Exception: Cannot rename and modify the same column `invitation_task_detail` <span class="keyword">in</span> a single ALTER query (version 20.12.4.5 (official build))</span><br><span class="line">, server ClickHouseNode [uri=http://10.82.xxx.xxx:8123/xxxx, options=&#123;use_server_time_zone=<span class="literal">false</span>,use_time_zone=Asia/Shanghai&#125;]@2105728836</span><br></pre></td></tr></table></figure></p>
<p>后查明原因竟是开发同事在对应的mysql 库修改了表结构。这个时候需要删除重建 MaterializeMySQL 数据库<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker <span class="built_in">exec</span> -it clickhouse bash</span><br><span class="line">root@WCN-GDUVA-SBKAP1:/<span class="comment"># clickhouse-client --user=default</span></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) drop database store_beauty;</span><br><span class="line"></span><br><span class="line">DROP DATABASE store_beauty</span><br><span class="line"></span><br><span class="line">Query <span class="built_in">id</span>: c4e3933d-8eb4-4ca0-a867-457d4d7e2007</span><br><span class="line"></span><br><span class="line">Ok.</span><br><span class="line"></span><br><span class="line"><span class="comment">## 这里需要开启 allow_experimental_database_materialize_mysql 参数。</span></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) SET allow_experimental_database_materialize_mysql = 1;</span><br><span class="line"></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) CREATE DATABASE store_beauty ENGINE = MaterializeMySQL(<span class="string">&#x27;10.82.xx.xxx:3306&#x27;</span>, <span class="string">&#x27;store_beauty&#x27;</span>, <span class="string">&#x27;repl&#x27;</span>, <span class="string">&#x27;xxxxxx&#x27;</span>);</span><br><span class="line"></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) use store_beauty</span><br><span class="line"></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) show tables;</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line"><span class="comment">## 发现 生产库正常同步，而uat 只同步了40个表就挂住了。翻看日志</span></span><br><span class="line"><span class="built_in">cd</span> /var/log/clickhouse-server</span><br><span class="line"><span class="built_in">tail</span> -100f clickhouse-server.err.log</span><br><span class="line">...</span><br><span class="line">2023.07.21 03:13:24.147160 [ 128 ] &#123;1ac67e78-ef20-4f55-a3a4-d9d0f96fce9a&#125; &lt;Error&gt; DynamicQueryHandler: Code: 50, e.displayText() = DB::Exception: Unknown data <span class="built_in">type</span> family: json, Stack trace (when copying this message, always include the lines below):</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">## 发现这里报了一个类型错误。相同的操作 在线上没问题。在uat 反而卡住了。开发说uat mysql 库也没动过。</span></span><br><span class="line"><span class="comment">## 一时间以为是uat percona 升级了数据库版本引发的。想尝试升级clickhouse 版本看看</span></span><br><span class="line"><span class="comment">## 拉取最新的 docker 镜像</span></span><br><span class="line">docker pull clickhouse/clickhouse-server:23.4</span><br><span class="line"><span class="comment">## 保存镜像并同步到uat 环境</span></span><br><span class="line">docker save -o clickhouse-server.tar clickhouse/clickhouse-server </span><br><span class="line"><span class="comment">## 在uat 环境中导入</span></span><br><span class="line">sudo docker load -i clickhouse-server.tar</span><br><span class="line"></span><br><span class="line"><span class="comment">## 拉起一个新版本镜像的container</span></span><br><span class="line">sudo docker run -d --name=clickhouse23.4 -p 18123:8123 -p19000:9000  -v /app/clickhouse/data234:/var/lib/clickhouse  --<span class="built_in">ulimit</span> nofile=262144:262144 clickhouse/clickhouse-server</span><br><span class="line"></span><br><span class="line"><span class="comment">## 登入镜像</span></span><br><span class="line">sudo docker <span class="built_in">exec</span> -it clickhouse23.4 bash</span><br><span class="line"><span class="comment">## 开启物化库参数。这里比20.12 的版本上 参数有区别 。materialize(d) 多了一个 字符</span></span><br><span class="line">SET allow_experimental_database_materialized_mysql = 1;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建库后。发现依然卡在 40个表</span></span><br><span class="line">CREATE DATABASE store_beauty ENGINE = MaterializeMySQL(<span class="string">&#x27;10.82.xx.xxx:3306&#x27;</span>, <span class="string">&#x27;store_beauty&#x27;</span>, <span class="string">&#x27;repl&#x27;</span>, <span class="string">&#x27;xxxxxx&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">## 这次翻看日志可以发现比较清晰。它指出了在dump wb_user_calendar 表的时候，列 spa_content 的 json 类型转换错误。该列在uat 上是json 类型。开发说有很多表都有json 类型</span></span><br><span class="line"><span class="comment">## 查看线上表数据。该列都有数据。而uat 该列没有数据，于是更新该列非null 后问题依旧。</span></span><br><span class="line"><span class="comment">## 于是查看线上mysql 同名表发现 该表实际上是text 类型。而不是json 类型。存储的是json 格式的字符串。</span></span><br><span class="line"><span class="comment">## 修改 uat 字段与线上一致 </span></span><br><span class="line">alter table wb_user_calendar change spa_content spa_content text default null comment <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除数据库重建</span></span><br><span class="line"><span class="comment">## 这次所有表都同步过来了。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h2 id="从这次故障可以看出-clickhouse-的-MaterializeMySQL-引擎并不支持-mysql-的json-格式。"><a href="#从这次故障可以看出-clickhouse-的-MaterializeMySQL-引擎并不支持-mysql-的json-格式。" class="headerlink" title="从这次故障可以看出 clickhouse 的 MaterializeMySQL 引擎并不支持 mysql 的json 格式。"></a>从这次故障可以看出 clickhouse 的 MaterializeMySQL 引擎并不支持 mysql 的json 格式。</h2><h2 id="升级clickhouse-到最新版本可解决-mysql-变更表结构不同步clickhouse-问题-并且需要注意MYSQL-修改表的语法"><a href="#升级clickhouse-到最新版本可解决-mysql-变更表结构不同步clickhouse-问题-并且需要注意MYSQL-修改表的语法" class="headerlink" title="升级clickhouse 到最新版本可解决 mysql 变更表结构不同步clickhouse 问题,并且需要注意MYSQL 修改表的语法"></a>升级clickhouse 到最新版本可解决 mysql 变更表结构不同步clickhouse 问题,并且需要注意MYSQL 修改表的语法</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. 改字段名不要用change的语法， 用rename的语法</span><br><span class="line"></span><br><span class="line">ALTER TABLE 表名 RENAME COLUMN 原字段名 TO 新字段名;</span><br><span class="line"></span><br><span class="line">2. 改字段属性用modify</span><br><span class="line"></span><br><span class="line">ALTER TABLE 表名 MODIFY 字段名 属性;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>clickhouse</category>
      </categories>
      <tags>
        <tag>MaterializeMySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>confluence 数据库配置要求</title>
    <url>/2023/03/22/confluenceDbConfig/</url>
    <content><![CDATA[<p>摘抄自官方文档<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">配置文件</span><br><span class="line"><span class="comment">## 字符集要求</span></span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line">collation-server=utf8mb4_bin</span><br><span class="line"><span class="comment">##存储引擎要求(现在mysql 默认都是这个引擎)</span></span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line"><span class="comment">## 要求允许通讯包体的大小</span></span><br><span class="line">max_allowed_packet=256M</span><br><span class="line"><span class="comment">## redolog 大小</span></span><br><span class="line">innodb_log_file_size=2GB</span><br><span class="line"><span class="comment">## sql_mode 需要去除这个选项。如果存在</span></span><br><span class="line">sql_mode = NO_AUTO_VALUE_ON_ZERO</span><br><span class="line"><span class="comment">## 事务隔离级别</span></span><br><span class="line">transaction-isolation=READ-COMMITTED</span><br><span class="line"><span class="comment">## binlog 格式设置 row</span></span><br><span class="line">binlog_format=row</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line"><span class="comment">## 5.7 版本optimizer_switch 里面 设置 derived_merge=off 默认on</span></span><br><span class="line">optimizer_switch = derived_merge=off</span><br><span class="line"></span><br><span class="line"><span class="comment">## SQL 命令</span></span><br><span class="line">CREATE DATABASE &lt;database-name&gt; CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;</span><br><span class="line">GRANT ALL PRIVILEGES ON &lt;database-name&gt;.* TO <span class="string">&#x27;&lt;confluenceuser&gt;&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">## mysql driver</span></span><br><span class="line"><span class="comment">## mysql 5.7 版本</span></span><br><span class="line"> mysql-connector-java-5.1.xx-bin.jar</span><br><span class="line"><span class="comment">## mysql 8.0 版本</span></span><br><span class="line"> mysql-connector-java-8.0.xx-bin.jar</span><br><span class="line"><span class="comment">## 放在下面的目录</span></span><br><span class="line">  &lt;installation-directory&gt;/confluence/WEB-INF/lib </span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>confluence</tag>
      </tags>
  </entry>
  <entry>
    <title>基于SQL user mode 的用户创建</title>
    <url>/2023/01/04/clickhouseUser/</url>
    <content><![CDATA[<p>clickhouse 在旧版本创建用户以及密码需要通过修改users.xml 配置文件，笔记麻烦。在20.5 开始支持SQL话的用户配置<br>首先修改配置 /etc/clickhouse-server/users.xml，打开 SQL USER mode<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">        ....</span><br><span class="line">        <span class="comment">&lt;!-- User can create other users and grant rights to them. --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">access_management</span>&gt;</span>1<span class="tag">&lt;/<span class="name">access_management</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 新版本中需要再添加如下参数,不然会报default 权限不足以grant --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">named_collection_control</span>&gt;</span>1<span class="tag">&lt;/<span class="name">named_collection_control</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">show_named_collections</span>&gt;</span>1<span class="tag">&lt;/<span class="name">show_named_collections</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">show_named_collections_secrets</span>&gt;</span>1<span class="tag">&lt;/<span class="name">show_named_collections_secrets</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><br>重启服务</p>
<p>定义一个用户<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">clickhouse<span class="operator">-</span>client <span class="comment">--user default --password &lt;password&gt;</span></span><br><span class="line"><span class="comment">-- 创建一个管理员用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> clickhouse_admin IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> clickhouse_admin <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 展示权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> clickhouse_admin;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建普通用户</span></span><br><span class="line"><span class="comment">-- 创建一个列读取用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> column_user IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"><span class="comment">-- 创建一个行读取用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> row_user IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建一个 列查询角色，并授权表上的列读取权限</span></span><br><span class="line"><span class="keyword">CREATE</span> ROLE column1_users;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>(id, column1) <span class="keyword">ON</span> db1.table1 <span class="keyword">TO</span> column1_users;</span><br><span class="line"><span class="comment">-- 将角色授权给列用户</span></span><br><span class="line"><span class="keyword">GRANT</span> column1_users <span class="keyword">TO</span> column_user;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建一个 行策略查询角色</span></span><br><span class="line"><span class="keyword">CREATE</span> ROLE A_rows_users;</span><br><span class="line"><span class="comment">-- 将行策略角色授权给行查询用户</span></span><br><span class="line"><span class="keyword">GRANT</span> A_rows_users <span class="keyword">TO</span> row_user;</span><br><span class="line"><span class="comment">-- 创建行查询策略给角色 A_rows_users</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="type">ROW</span> POLICY A_row_filter <span class="keyword">ON</span> db1.table1 <span class="keyword">FOR</span> <span class="keyword">SELECT</span> <span class="keyword">USING</span> column1 <span class="operator">=</span> <span class="string">&#x27;A&#x27;</span> <span class="keyword">TO</span> A_rows_users;</span><br><span class="line"><span class="comment">-- 授权查询db1.table1 上的列查询权限给角色 A_rows_users</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>(id, column1, column2) <span class="keyword">ON</span> db1.table1 <span class="keyword">TO</span> A_rows_users;</span><br><span class="line"><span class="comment">-- 创建一个其他可访问该表整表的角色给其他用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="type">ROW</span> POLICY allow_other_users_filter <span class="keyword">ON</span> db1.table1 <span class="keyword">FOR</span> <span class="keyword">SELECT</span> <span class="keyword">USING</span> <span class="number">1</span> <span class="keyword">TO</span> clickhouse_admin, column1_users;</span><br><span class="line">将策略附加到表时，系统将应用该策略，并且只有那些定义的用户和角色才能对表进行操作，其他所有用户和角色都将被拒绝任何操作。 为了不将限制性行策略应用于其他用户，必须定义另一个策略以允许其他用户和角色具有常规或其他类型的访问权限。</span><br></pre></td></tr></table></figure></p>
<p>修改用户和角色<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建一个具有默认角色的用户</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> row_and_column_user IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;password&#x27;</span> <span class="keyword">DEFAULT</span> ROLE A_rows_users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回收角色A_rows_users的部分权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span>(id, column1, column2) <span class="keyword">ON</span> db1.table1 <span class="keyword">FROM</span> A_rows_users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 允许角色A_rows_users 只能查询 column1 列</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>(id, column1) <span class="keyword">ON</span> db1.table1 <span class="keyword">TO</span> A_rows_users;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>查看权限<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查看角色 row_and_column_user 具有什么权限</span></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> row_and_column_user</span><br><span class="line"><span class="comment">-- 查看clickhouse 建有的角色</span></span><br><span class="line"><span class="keyword">SHOW</span> ROLES</span><br><span class="line"></span><br><span class="line"><span class="comment">--查看所有行策略</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="type">ROW</span> POLICIES</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看策略 A_row_filter 定义</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="type">ROW</span> POLICY A_row_filter <span class="keyword">ON</span> db1.table1</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>管理角色，策略，用户<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 回收角色A_rows_users 在table1 表上查询colunm1 的权限</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span>(column1, id) <span class="keyword">ON</span> db1.table1 <span class="keyword">FROM</span> A_rows_users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除策略A_row_filter</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="type">ROW</span> POLICY A_row_filter <span class="keyword">ON</span> db1.table1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回收row_user 的角色 A_rows_users</span></span><br><span class="line"><span class="keyword">REVOKE</span> A_rows_users <span class="keyword">FROM</span> row_user;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除角色</span></span><br><span class="line"><span class="keyword">DROP</span> ROLE A_rows_users;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除用户</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> row_user;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改用户密码</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> row_user@<span class="string">&#x27;192.168.%.%&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> sha256_password <span class="keyword">BY</span> <span class="string">&#x27;passwd2&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建profile</span></span><br><span class="line"><span class="keyword">CREATE</span> SETTINGS PROFILE low_mem_readonly SETTINGS max_threads <span class="operator">=</span> <span class="number">4</span>, max_memory_usage <span class="operator">=</span> <span class="number">4000000000</span> READONLY;</span><br><span class="line"><span class="keyword">CREATE</span> ROLE role_low_mem SETTINGS PROFILE <span class="string">&#x27;low_mem_readonly&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> db1.<span class="operator">*</span> <span class="keyword">TO</span> role_low_mem;</span><br></pre></td></tr></table></figure></p>
<p>通过命令创建的用户权限可以在access 目录里面查看到<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /data1/clickhouse/access</span><br><span class="line">[root@bigdata access]<span class="comment"># ll</span></span><br><span class="line">总用量 32</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse  263 Dec 28 10:52 344a88a5-c2bc-a961-252d.sql</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse 2365 Jan  4 10:53 b406882-c6bd-65dd-413e-721a4b75afaf.sql</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse    1 Dec 21 17:36 quotas.list</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse    1 Dec 21 17:36 roles.list</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse    1 Dec 21 17:36 row_policies.list</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse    1 Dec 21 17:36 settings_profiles.list</span><br><span class="line">-rw-r-----. 1 clickhouse clickhouse  143 Jan  4 10:51 users.list</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> users.list</span><br><span class="line">testeb406882-c6bd-65dd-413e-721a4b75afaf clickhouse_admin344a88a5-c2bc-a961-252d</span><br><span class="line"></span><br><span class="line">相关用户的权限语句可以在对应的 xxx.sql 查看</span><br><span class="line">比如 clickhouse_admin 对应上面的 344a88a5-c2bc-a961-252d.sql</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>以上操作都是在单点中执行。也仅在单点中生效<br><em>如果是部署的集群。需要在集群中生效。则需要加上 ON CLUSTER 子句</em><br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> all_hits <span class="keyword">ON</span> CLUSTER cluster (p <span class="type">Date</span>, i Int32) ENGINE <span class="operator">=</span> Distributed(cluster, <span class="keyword">default</span>, hits)</span><br></pre></td></tr></table></figure></p>
<p>看回完整的USER 语法<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="operator">|</span> <span class="keyword">OR</span> REPLACE] name1 [<span class="keyword">ON</span> CLUSTER cluster_name1]</span><br><span class="line">        [, name2 [<span class="keyword">ON</span> CLUSTER cluster_name2] ...]</span><br><span class="line">    [<span class="keyword">NOT</span> IDENTIFIED <span class="operator">|</span> IDENTIFIED &#123;[<span class="keyword">WITH</span> &#123;no_password <span class="operator">|</span> plaintext_password <span class="operator">|</span> sha256_password <span class="operator">|</span> sha256_hash <span class="operator">|</span> double_sha1_password <span class="operator">|</span> double_sha1_hash&#125;] <span class="keyword">BY</span> &#123;<span class="string">&#x27;password&#x27;</span> <span class="operator">|</span> <span class="string">&#x27;hash&#x27;</span>&#125;&#125; <span class="operator">|</span> &#123;<span class="keyword">WITH</span> ldap SERVER <span class="string">&#x27;server_name&#x27;</span>&#125; <span class="operator">|</span> &#123;<span class="keyword">WITH</span> kerberos [REALM <span class="string">&#x27;realm&#x27;</span>]&#125; <span class="operator">|</span> &#123;<span class="keyword">WITH</span> ssl_certificate CN <span class="string">&#x27;common_name&#x27;</span>&#125;]</span><br><span class="line">    [HOST &#123;<span class="keyword">LOCAL</span> <span class="operator">|</span> NAME <span class="string">&#x27;name&#x27;</span> <span class="operator">|</span> REGEXP <span class="string">&#x27;name_regexp&#x27;</span> <span class="operator">|</span> IP <span class="string">&#x27;address&#x27;</span> <span class="operator">|</span> <span class="keyword">LIKE</span> <span class="string">&#x27;pattern&#x27;</span>&#125; [,...] <span class="operator">|</span> <span class="keyword">ANY</span> <span class="operator">|</span> <span class="keyword">NONE</span>]</span><br><span class="line">    [<span class="keyword">DEFAULT</span> ROLE role [,...]]</span><br><span class="line">    [<span class="keyword">DEFAULT</span> DATABASE database <span class="operator">|</span> <span class="keyword">NONE</span>]</span><br><span class="line">    [GRANTEES &#123;<span class="keyword">user</span> <span class="operator">|</span> role <span class="operator">|</span> <span class="keyword">ANY</span> <span class="operator">|</span> <span class="keyword">NONE</span>&#125; [,...] [<span class="keyword">EXCEPT</span> &#123;<span class="keyword">user</span> <span class="operator">|</span> role&#125; [,...]]]</span><br><span class="line">    [SETTINGS variable [<span class="operator">=</span> <span class="keyword">value</span>] [MIN [<span class="operator">=</span>] min_value] [MAX [<span class="operator">=</span>] max_value] [READONLY <span class="operator">|</span> WRITABLE] <span class="operator">|</span> PROFILE <span class="string">&#x27;profile_name&#x27;</span>] [,...]</span><br></pre></td></tr></table></figure></p>
<p>ALTER 权限树<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── ALTER (only <span class="keyword">for</span> table and view)/</span><br><span class="line">│   ├── ALTER TABLE/</span><br><span class="line">│   │   ├── ALTER UPDATE</span><br><span class="line">│   │   ├── ALTER DELETE</span><br><span class="line">│   │   ├── ALTER COLUMN/</span><br><span class="line">│   │   │   ├── ALTER ADD COLUMN</span><br><span class="line">│   │   │   ├── ALTER DROP COLUMN</span><br><span class="line">│   │   │   ├── ALTER MODIFY COLUMN</span><br><span class="line">│   │   │   ├── ALTER COMMENT COLUMN</span><br><span class="line">│   │   │   ├── ALTER CLEAR COLUMN</span><br><span class="line">│   │   │   └── ALTER RENAME COLUMN</span><br><span class="line">│   │   ├── ALTER INDEX/</span><br><span class="line">│   │   │   ├── ALTER ORDER BY</span><br><span class="line">│   │   │   ├── ALTER SAMPLE BY</span><br><span class="line">│   │   │   ├── ALTER ADD INDEX</span><br><span class="line">│   │   │   ├── ALTER DROP INDEX</span><br><span class="line">│   │   │   ├── ALTER MATERIALIZE INDEX</span><br><span class="line">│   │   │   └── ALTER CLEAR INDEX</span><br><span class="line">│   │   ├── ALTER CONSTRAINT/</span><br><span class="line">│   │   │   ├── ALTER ADD CONSTRAINT</span><br><span class="line">│   │   │   └── ALTER DROP CONSTRAINT</span><br><span class="line">│   │   ├── ALTER TTL/</span><br><span class="line">│   │   │   └── ALTER MATERIALIZE TTL</span><br><span class="line">│   │   ├── ALTER SETTINGS</span><br><span class="line">│   │   ├── ALTER MOVE PARTITION</span><br><span class="line">│   │   ├── ALTER FETCH PARTITION</span><br><span class="line">│   │   └── ALTER FREEZE PARTITION</span><br><span class="line">│   └── ALTER LIVE VIEW/</span><br><span class="line">│       ├── ALTER LIVE VIEW REFRESH</span><br><span class="line">│       └── ALTER LIVE VIEW MODIFY QUERY</span><br><span class="line">├── ALTER DATABASE</span><br><span class="line">├── ALTER USER</span><br><span class="line">├── ALTER ROLE</span><br><span class="line">├── ALTER QUOTA</span><br><span class="line">├── ALTER [ROW] POLICY</span><br><span class="line">└── ALTER [SETTINGS] PROFILE</span><br></pre></td></tr></table></figure><br>示例<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">alter</span> <span class="keyword">on</span> my_db.my_table <span class="keyword">TO</span> my_user;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span>  my_user;</span><br><span class="line">┌─GRANTS <span class="keyword">FOR</span> my_user───────────────────────────────────────────┐</span><br><span class="line">│ <span class="keyword">GRANT</span> <span class="keyword">ALTER</span> <span class="keyword">TABLE</span>, <span class="keyword">ALTER</span> <span class="keyword">VIEW</span> <span class="keyword">ON</span> my_db.my_table <span class="keyword">TO</span> my_user   │</span><br><span class="line">└──────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 这里我们可以看到 alter 作用于 表上 包含了 alter table , alter view 2个主权限，其下还包含各种详细的权限。由上面的ALTER 权限树可以看出。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 单独授权添加列的权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALTER</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keyword">ON</span> my_db.my_table <span class="keyword">TO</span> my_user;</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> my_user;</span><br><span class="line">┌─GRANTS <span class="keyword">FOR</span> my_user──────────────────────────────────┐</span><br><span class="line">│ <span class="keyword">GRANT</span> <span class="keyword">ALTER</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keyword">ON</span> my_db.my_table <span class="keyword">TO</span> my_user │</span><br><span class="line">└─────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line"><span class="comment">--回收添加表列的权限，</span></span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">ALTER</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="keyword">ON</span> my_db.my_table <span class="keyword">FROM</span> my_user;</span><br><span class="line">(</span><br><span class="line">回收任何上级权限，都会回收当前子集权限，<span class="keyword">REVOKE</span> <span class="keyword">ALTER</span> CLOUMN 也将会回收 <span class="keyword">ALTER</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> 的权限，在上面只授权一个子权限的情况下，</span><br><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> <span class="keyword">ON</span> my_db.my_table <span class="keyword">FROM</span> my_user;</span><br><span class="line">与直接回收子权限的语句等同。</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> my_user;</span><br><span class="line">Ok.</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> <span class="keyword">rows</span> <span class="keyword">in</span> set. Elapsed: <span class="number">0.003</span> sec.</span><br></pre></td></tr></table></figure></p>
<p>修改用户设置的4种方式</p>
<ul>
<li>1 通过配置 users.xml 配置文件。在 <code>&lt;profiles&gt;</code> 标签下面设置</li>
<li>2 如果是会话级别参数 可以通过 <code>set setting=value</code> 的方式设置</li>
<li>3 在查询期间设置<ul>
<li>1) 在启动clickhouse-client 时加参数 <code>--setting=value</code></li>
<li>2) 使用http API ,通过CGI 参数（<code>URL?setting_1=value&amp;setting_2=value...</code>）</li>
<li>3) 在查询语句中指定settings ，<code>insert xxx values() settings setting1=value,setting2=value...</code></li>
</ul>
</li>
<li>4 通过ALTER USER username settings 的方式 <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> bireport settings async_insert<span class="operator">=</span><span class="number">1</span>,wait_for_async_insert<span class="operator">=</span><span class="number">0</span>,async_insert_max_data_size<span class="operator">=</span><span class="number">500000</span>,async_insert_busy_timeout_ms<span class="operator">=</span><span class="number">5000</span></span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>clickhouse</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>create user</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql replication 设置命令在8.0.23后的变化</title>
    <url>/2022/10/18/diffOfReplicationConfig/</url>
    <content><![CDATA[<p>设置同步配置(8.0.23及以后)<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CHANGE REPLICATION SOURCE TO</span><br><span class="line">    SOURCE_HOST=<span class="string">&#x27;source_host_name&#x27;</span>,</span><br><span class="line">    SOURCE_USER=<span class="string">&#x27;replication_user_name&#x27;</span>,</span><br><span class="line">    SOURCE_PASSWORD=<span class="string">&#x27;replication_password&#x27;</span>,</span><br><span class="line">    SOURCE_LOG_FILE=<span class="string">&#x27;recorded_log_file_name&#x27;</span>,</span><br><span class="line">    SOURCE_LOG_POS=recorded_log_position;</span><br></pre></td></tr></table></figure></p>
<p>设置同步配置(8.0.23以前)<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">CHANGE MASTER TO</span><br><span class="line">    MASTER_HOST=<span class="string">&#x27;source_host_name&#x27;</span>,</span><br><span class="line">    MASTER_USER=<span class="string">&#x27;replication_user_name&#x27;</span>,</span><br><span class="line">    MASTER_PASSWORD=<span class="string">&#x27;replication_password&#x27;</span>,</span><br><span class="line">    MASTER_LOG_FILE=<span class="string">&#x27;recorded_log_file_name&#x27;</span>,</span><br><span class="line">    MASTER_LOG_POS=recorded_log_position;</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>mysql 8</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 gin 优化一例</title>
    <url>/2023/09/25/gincase/</url>
    <content><![CDATA[<p>大数据组那边有个系统用了PG 。在慢语句告警中发现有个update 用了 78 秒<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> tag_users_mapping </span><br><span class="line">  <span class="keyword">set</span> user_ids<span class="operator">=</span>(<span class="keyword">select</span> <span class="built_in">coalesce</span>(rb_build_agg(user_id), rb_build(<span class="string">&#x27;&#123;&#125;&#x27;</span>))</span><br><span class="line"><span class="keyword">from</span>  user_tags_mapping </span><br><span class="line"><span class="keyword">where</span> leave <span class="operator">~</span> <span class="string">&#x27;(^20411947,)|(,20411947,)|(,20411947$)&#x27;</span> <span class="keyword">or</span> leave<span class="operator">=</span><span class="string">&#x27;20411947&#x27;</span>) <span class="keyword">where</span> id<span class="operator">=</span><span class="number">156518</span></span><br></pre></td></tr></table></figure><br>通过分析可以看到慢的是在update set 的子句里面。leave 用了正则表达式，user_tags_mapping 有2300W数据。走全表扫描。<br>查看表数据库可以看到leave 是使用text 类型存的数据为：<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;20121054,202365,20490503,500902&quot;</span><br><span class="line">&quot;2014550,204104135,20210,2013225,2022,20495281,500605,500902&quot;</span><br><span class="line">&quot;2011726,2023,20489521,50402,500902&quot;</span><br><span class="line">&quot;2013286,2022,204102891,50402,500902&quot;</span><br><span class="line">&quot;2013836,20210,204106485,50402,500902&quot;</span><br><span class="line">&quot;2019306,20217,204105486,500605,500902&quot;</span><br><span class="line">&quot;2013286,2022,204102891,50402,500902&quot;</span><br><span class="line">&quot;20124394,202107,20488918,500605,500902&quot;</span><br><span class="line">&quot;204108669,2013996,20215,204108668,500902&quot;</span><br><span class="line">&quot;2013286,2022,50402,500902&quot;</span><br></pre></td></tr></table></figure><br>开发用了正则匹配只是为了匹配 某个ID 存在于leave 中。<br>如何加速查询呢？唯有索引。看到这种按逗号分隔的组成，可以想到如果是array 数组，我们可以加上gin 索引来提高检索速度。<br>PG 有提供 string_to_array 将字符串分割成array 。也支持函数索引。于是建索引如下：<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_user_tags_mapping_leave <span class="keyword">on</span>  user_tags_mapping <span class="keyword">using</span> gin(string_to_array(leave,<span class="string">&#x27;,&#x27;</span>))</span><br></pre></td></tr></table></figure><br>将SQL改写,利用 &amp;&amp; 匹配 某个数组中的元素是否存在另一个数组<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> tag_users_mapping </span><br><span class="line">  <span class="keyword">set</span> user_ids<span class="operator">=</span>(<span class="keyword">select</span> <span class="built_in">coalesce</span>(rb_build_agg(user_id), rb_build(<span class="string">&#x27;&#123;&#125;&#x27;</span>)) <span class="keyword">from</span> tmp_user_tags_mapping <span class="keyword">where</span> <span class="keyword">array</span>[<span class="string">&#x27;20411947&#x27;</span>]<span class="operator">&amp;&amp;</span>string_to_array(leave,<span class="string">&#x27;,&#x27;</span>)) <span class="keyword">where</span> id<span class="operator">=</span><span class="number">156518</span></span><br></pre></td></tr></table></figure><br>这个查询需要花费 56ms 。性能提升 1300+ 倍。优化效果很明显。</p>
]]></content>
      <categories>
        <category>postgresql</category>
      </categories>
      <tags>
        <tag>gin index</tag>
      </tags>
  </entry>
  <entry>
    <title>对 docker Percona mysql 进行版本替换升级</title>
    <url>/2023/07/12/dokerPerconaUpgrade/</url>
    <content><![CDATA[<p>客户有一套 percona mysql 运行在Docker 中。版本为 8.0.25-15,经等保扫描有一些漏洞需要修复。需要对这套数据库进行版本升级。<br>版本替换需要停机处理。</p>
<ol>
<li><p>在能连外网的机器上下载最新的 Percona-server Docker 版本。<br>版本列表见：<a href="https://registry.hub.docker.com/r/percona/percona-server/tags?page=1&amp;name=8.0">https://registry.hub.docker.com/r/percona/percona-server/tags?page=1&amp;name=8.0</a><br>找到当前最新版本 8.0.33-25<br><code>docker pull percona/percona-server:8.0.33-25</code></p>
</li>
<li><p>将镜像导出。<br><code>docker save -o percona-server:8.0.33-25.tar percona/percona-server:8.0.33-25</code></p>
</li>
<li><p>将镜像同步到线上环境导入<br><code>docker load &lt; percona-server:8.0.33-25.tar</code><br>如果没有采用 [新镜像名称]:[新镜像标签] 的命名方式。导入后在 docker images 中只能看到 REPOSITORY  TAG 2 列都是 None<br>这时需要修改镜像名称<br><code>docker tag [镜像id] [新镜像名称]:[新镜像标签]</code></p>
</li>
<li><p>停止 当前运行的 percona-server 实例,并删除container</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@localhost percona_data]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID   IMAGE                              COMMAND                  CREATED         STATUS         PORTS                                                  NAMES</span><br><span class="line">ef10071274a8   percona/percona-server:8.0.25-15   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   3 seconds ago   Up 2 seconds   33060/tcp, 0.0.0.0:3308-&gt;3306/tcp, :::3308-&gt;3306/tcp   percona-server8025</span><br><span class="line"></span><br><span class="line">[root@localhost percona_data]<span class="comment"># docker stop percona-server8025</span></span><br><span class="line">percona-server8025</span><br><span class="line">[root@localhost percona_data]<span class="comment"># docker rm percona-server8025 </span></span><br><span class="line">percona-server8025</span><br></pre></td></tr></table></figure>
</li>
<li><p>用新的版本重新拉起container</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run  -d \</span><br><span class="line">&gt; --name=percona-server8025 \</span><br><span class="line">&gt; -v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">&gt; -v /etc/timezone:/etc/timezone  \</span><br><span class="line">&gt; -v /data/percona_data/data8025:/var/lib/mysql \</span><br><span class="line">&gt; -v /data/percona_data/conf:/etc/my.cnf.d \</span><br><span class="line">&gt; -p 3308:3306 \</span><br><span class="line">&gt; -e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">&gt; percona/percona-server:8.0.33-25  \  <span class="comment">## 此处替换新版本  </span></span><br><span class="line">&gt; --character-set-server=utf8mb4 \</span><br><span class="line">&gt; --collation-server=utf8mb4_unicode_ci</span><br><span class="line">ac487a648370b3fc92e9ac67d6b0addaa89082dc29f0f9148f9c12a9597d6c91</span><br><span class="line"></span><br><span class="line">[root@localhost percona_data]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                              COMMAND                  CREATED         STATUS         PORTS                                                  NAMES</span><br><span class="line">ac487a648370   percona/percona-server:8.0.33-25   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   4 seconds ago   Up 3 seconds   33060/tcp, 0.0.0.0:3308-&gt;3306/tcp, :::3308-&gt;3306/tcp   percona-server8025</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2023-07-19T02:19:21.459842Z 0 [Warning] [MY-011068] [Server] The syntax <span class="string">&#x27;log_slave_updates&#x27;</span> is deprecated and will be removed <span class="keyword">in</span> a future release. Please use log_replica_updates instead.</span><br><span class="line">2023-07-19T02:19:21.459865Z 0 [Warning] [MY-011068] [Server] The syntax <span class="string">&#x27;log_slave_updates&#x27;</span> is deprecated and will be removed <span class="keyword">in</span> a future release. Please use log_replica_updates instead.</span><br><span class="line">2023-07-19T02:19:21.459877Z 0 [Warning] [MY-011068] [Server] The syntax <span class="string">&#x27;skip_slave_start&#x27;</span> is deprecated and will be removed <span class="keyword">in</span> a future release. Please use skip_replica_start instead.</span><br><span class="line">2023-07-19T02:19:21.460998Z 0 [Warning] [MY-010097] [Server] Insecure configuration <span class="keyword">for</span> --secure-log-path: Current value does not restrict location of generated files. Consider setting it to a valid, non-empty path.</span><br><span class="line">2023-07-19T02:19:21.461043Z 0 [Warning] [MY-010918] [Server] <span class="string">&#x27;default_authentication_plugin&#x27;</span> is deprecated and will be removed <span class="keyword">in</span> a future release. Please use authentication_policy instead.</span><br><span class="line">2023-07-19T02:19:21.461062Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.33-25) starting as process 1</span><br><span class="line">2023-07-19T02:19:21.467176Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.</span><br><span class="line">2023-07-19T02:19:22.089039Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.</span><br><span class="line">2023-07-19T02:19:25.524903Z 4 [System] [MY-013381] [Server] Server upgrade from <span class="string">&#x27;80025&#x27;</span> to <span class="string">&#x27;80033&#x27;</span> started.  <span class="comment">## 8.0 的升级不需要执行mysql_upgrade mysqld 在启动后自动升级</span></span><br><span class="line">mbind: Operation not permitted</span><br><span class="line">2023-07-19T02:19:38.722702Z 4 [System] [MY-013381] [Server] Server upgrade from <span class="string">&#x27;80025&#x27;</span> to <span class="string">&#x27;80033&#x27;</span> completed.  <span class="comment">## 版本升级完成</span></span><br><span class="line">2023-07-19T02:19:38.970169Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.</span><br><span class="line">2023-07-19T02:19:38.970198Z 0 [System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported <span class="keyword">for</span> this channel.</span><br><span class="line">2023-07-19T02:19:39.014404Z 0 [System] [MY-010931] [Server] /usr/sbin/mysqld: ready <span class="keyword">for</span> connections. Version: <span class="string">&#x27;8.0.33-25&#x27;</span>  socket: <span class="string">&#x27;/var/lib/mysql/mysql.sock&#x27;</span>  port: 3306  Percona Server (GPL), Release 25, Revision 60c9e2c5.</span><br><span class="line">2023-07-19T02:19:39.014473Z 0 [System] [MY-011323] [Server] X Plugin ready <span class="keyword">for</span> connections. Bind-address: <span class="string">&#x27;::&#x27;</span> port: 33060, socket: /var/lib/mysql/mysqlx.sock</span><br></pre></td></tr></table></figure>
</li>
<li><p>数据检测</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[root@localhost data8025]# docker exec -it percona-server8025  mysql -uroot -p123456 -e &quot;select * from sheen.test1;&quot;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------+-------+</span><br><span class="line">| id   | title |</span><br><span class="line">+------+-------+</span><br><span class="line">|    1 | aa    |</span><br><span class="line">|    2 | bb    |</span><br><span class="line">+------+-------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>对于在没有root 权限 需要使用sudo 的情况下 需要加上 —privileged=true 这个参数。否则在初始化的时候会报路径权限不足</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker run  -d \    <span class="comment"># run create + start 一个container -d 后台运行</span></span><br><span class="line">--privileged=<span class="literal">true</span> \ <span class="comment"># 将扩展权限给这个container</span></span><br><span class="line">--name=percona-server8033 \  <span class="comment"># container 名称</span></span><br><span class="line">-v /etc/localtime:/etc/localtime:ro \ <span class="comment"># -v 将本地目录 映射到 容器中对应的目录</span></span><br><span class="line">-v /etc/timezone:/etc/timezone  \</span><br><span class="line">-v /data/percona_data/data8033:/var/lib/mysql \   <span class="comment"># 数据库的数据目录</span></span><br><span class="line">-v /data/percona_data/conf:/etc/my.cnf.d \        <span class="comment"># 数据库的配置文件目录</span></span><br><span class="line">-p 3306:3306 \                                    <span class="comment"># -p 端口映射。在宿主机上起一个端口映射容器里面服务的端口。</span></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=future123456 \             <span class="comment"># -e 容器环境变量，这里指定 mysql root 的密码</span></span><br><span class="line">percona/percona-server:8.0.33-25  \               <span class="comment"># 使用的镜像</span></span><br><span class="line">--character-set-server=utf8mb4 \                  <span class="comment"># 指定数据库的字符集</span></span><br><span class="line">--collation-server=utf8mb4_unicode_ci             <span class="comment"># 指定数据库的 colllaction</span></span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>percona</tag>
      </tags>
  </entry>
  <entry>
    <title>hadoop3.x 纠删码策略</title>
    <url>/2023/02/28/hadoop3EC/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>纠删码技术（Erasure coding）简称EC，是一种编码容错技术。最早用于通信行业，数据传输中的数据恢复。它通过对数据进行分块，然后计算出校验数据，使得各个部分的数据产生关联性。当一部分数据块丢失时，可以通过剩余的数据块和校验块计算出丢失的数据块。相比以前的冗余副本策略，它可以提高50%以上的存储利用率，并且保证数据的可靠性。</p>
<h3 id="纠删码内置策略"><a href="#纠删码内置策略" class="headerlink" title="纠删码内置策略"></a>纠删码内置策略</h3><p>1.RS-10-4-1024k：使用RS编码，每10个数据单元（cell），生成4个校验单元，共14个单元，也就是说：这14个单元中，只要有任意的10个单元存在（不管是数据单元还是校验单元，只要总数=10），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。</p>
<p>2.RS-3-2-1024k：使用RS编码，每3个数据单元，生成2个校验单元，共5个单元，也就是说：这5个单元中，只要有任意的3个单元存在（不管是数据单元还是校验单元，只要总数=3），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。</p>
<p>3.RS-6-3-1024k：使用RS编码，每6个数据单元，生成3个校验单元，共9个单元，也就是说：这9个单元中，只要有任意的6个单元存在（不管是数据单元还是校验单元，只要总数=6），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。</p>
<p>4.RS-LEGACY-6-3-1024k：策略和上面的RS-6-3-1024k一样，只是编码的算法用的是rs-legacy，应该是之前遗留的rs算法。</p>
<p>5.XOR-2-1-1024k：使用XOR编码（速度比RS编码快），每2个数据单元，生成1个校验单元，共3个单元，也就是说：这3个单元中，只要有任意的2个单元存在（不管是数据单元还是校验单元，只要总数=2），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。</p>
<p>以RS-6-3-1024k为例，6个数据单元+3个校验单元，可以容忍任意的3个单元丢失，冗余的数据是50%。而采用副本方式，3个副本，冗余200%，却还不能容忍任意的3个单元丢失。因此，RS编码在相同冗余度的情况下，会大大提升数据的可用性，而在相同可用性的情况下，会大大节省冗余空间。</p>
<h3 id="如何在hadoop-3-x-启动-EC-策略"><a href="#如何在hadoop-3-x-启动-EC-策略" class="headerlink" title="如何在hadoop 3.x 启动 EC 策略"></a>如何在hadoop 3.x 启动 EC 策略</h3><p>1.hadoop 3.x 默认 EC 策略为 RS-6-3-1024k，根据上面内置策略的描述，至少要满足相应的节点数才行<br>2.RS 策略 依赖于 Intel ISA-L 包。开启前需要安装Intel ISA-L 包<br>3.安装 Intel ISA-L 包，相关依赖 nasm 2.13<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nasm 下载地址：https://www.nasm.us/pub/nasm/releasebuilds/2.13/linux/</span><br><span class="line">rpm -ivh nasm-2.13-0.fc24.x86_64.rpm</span><br><span class="line"></span><br><span class="line">isa-l 下载地址：https://github.com/intel/isa-l</span><br><span class="line">编译安装</span><br><span class="line">tar -xzvf  isa-l-2.30.0.tar.gz</span><br><span class="line">cd  isa-l-2.30.0</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=/usr --libdir=/usr/lib64</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><br>4.设置EC策略<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hadoop fs -mkdir /ectest</span><br><span class="line">hdfs ec -setPolicy -path hdfs:///ectest (将设置默认策略)</span><br><span class="line">hdfs ec -setPolicy -policy RS-3-2-1024k -path hdfs:///ectest (指定策略)</span><br></pre></td></tr></table></figure></p>
<p>5.更改默认策略<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 纠删码策略 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.ec.system.default.policy<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>RS-3-2-1024k<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The default erasure coding policy name will be used</span><br><span class="line">    on the path if no policy name is passed.</span><br><span class="line">    5 register EC policy: RS-3-2-1024k、RS-6-3-1024k、RS-10-4-1024k、RS-LEGACY-6-3-1024k、XOR-2-1-1024k</span><br><span class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="不适用的场景"><a href="#不适用的场景" class="headerlink" title="不适用的场景"></a>不适用的场景</h3><p>1.在EC 策略上的磁盘 做 append() 和 truncate() 操作将抛 IOException<br>2.如果文件存储编码混合了多种EC策略 或者 使用了多副本.concat() 操作将抛 IOException<br>3.setReplication() 操作在EC 策略编码的文件上无效<br>4.hflush() 和 hsync() 在 DFSStripedOutputStream 上无效，所以不能在 EC编码的文件 通过调用hflush()，hsync() 使数据一致性。</p>
<p>适用于划分独立路径，存储不需要修改的数据或者冷备份数据</p>
<h3 id="设置EC-策略的相关命令"><a href="#设置EC-策略的相关命令" class="headerlink" title="设置EC 策略的相关命令"></a>设置EC 策略的相关命令</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hdfs ec [generic options]</span><br><span class="line">     [-setPolicy -path &lt;path&gt; [-policy &lt;policyName&gt;] [-replicate]]  #为指定的路径设置指定的ec 策略</span><br><span class="line">     [-getPolicy -path &lt;path&gt;]  #获取指定路径的ec 策略</span><br><span class="line">     [-unsetPolicy -path &lt;path&gt;] #取消指定路径的上一次 setPolicy ec 策略</span><br><span class="line">     [-listPolicies]   #获取hdfs 上登记的所有策略（包括 启用。禁用。删除的策略)</span><br><span class="line">     [-addPolicies -policyFile &lt;file&gt;] # 通过文件的方式，添加用户指定的EC策略集</span><br><span class="line">     [-listCodecs]   #列出系统支持的EC编码策略列表</span><br><span class="line">     [-enablePolicy -policy &lt;policyName&gt;]   #启用某个策略</span><br><span class="line">     [-disablePolicy -policy &lt;policyName&gt;]  #禁用某个策略</span><br><span class="line">     [-removePolicy -policy &lt;policyName&gt;]   #删除某个策略</span><br><span class="line">     [-verifyClusterSetup -policy &lt;policyName&gt;...&lt;policyName&gt;]  #校验集群设置是否满足所有已经启用的EC 策略</span><br><span class="line">     [-help [cmd ...]]</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>hadoop</category>
      </categories>
      <tags>
        <tag>ec</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2022/10/14/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>利用hive将habse数据导入clickhouse</title>
    <url>/2023/08/25/hvie2clickhouse/</url>
    <content><![CDATA[<p>如何将hbase 的数据导入clickhouse 呢。一种通过第三方工具,例如 datax 来传输，但是配置比较麻烦。<br>想到clickhouse 支持 hive 外部表查询。我们可以利用建立外部表的方式。将数据抽取到clickhouse 本地。</p>
<h3 id="clickhouse数据库的准备，起开远程本地缓存"><a href="#clickhouse数据库的准备，起开远程本地缓存" class="headerlink" title="clickhouse数据库的准备，起开远程本地缓存"></a>clickhouse数据库的准备，起开远程本地缓存</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开启本地cache 可以使 查询速度提高2x</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data1/clickhouse/local_cache</span><br><span class="line"><span class="built_in">chown</span> -R clickhouse:clickhouse /data1/clickhouse</span><br><span class="line">vi /etc/clickhouse-server/config.xml</span><br><span class="line"><span class="comment">##开启添加本地缓存</span></span><br><span class="line">    &lt;local_cache_for_remote_fs&gt;</span><br><span class="line">        &lt;<span class="built_in">enable</span>&gt;<span class="literal">true</span>&lt;/enable&gt;</span><br><span class="line">        &lt;root_dir&gt;/data1/clickhouse/local_cache&lt;/root_dir&gt;</span><br><span class="line">        &lt;limit_size&gt;559096952&lt;/limit_size&gt;</span><br><span class="line">        &lt;bytes_read_before_flush&gt;1048576&lt;/bytes_read_before_flush&gt;</span><br><span class="line">    &lt;/local_cache_for_remote_fs&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable: ClickHouse will maintain local cache for remote filesystem(HDFS) after startup if true.</span></span><br><span class="line"><span class="comment"># root_dir: Required. The root directory to store local cache files for remote filesystem.</span></span><br><span class="line"><span class="comment"># limit_size: Required. The maximum size(in bytes) of local cache files.</span></span><br><span class="line"><span class="comment"># bytes_read_before_flush: Control bytes before flush to local filesystem when downloading file from remote filesystem. The default value is 1MB.</span></span><br><span class="line"><span class="comment"># 重启数据库</span></span><br><span class="line"><span class="comment"># 用户可以通过设置 set use_local_cache_for_remote_fs = 0 关闭使用本地缓存</span></span><br></pre></td></tr></table></figure>
<h3 id="hbase-中的表"><a href="#hbase-中的表" class="headerlink" title="hbase 中的表"></a>hbase 中的表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="string">&#x27;hive_hbase_table&#x27;</span>,<span class="string">&#x27;cf1&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="在-hive-中建立访问-hbase-的表"><a href="#在-hive-中建立访问-hbase-的表" class="headerlink" title="在 hive 中建立访问 hbase 的表"></a>在 hive 中建立访问 hbase 的表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">use test;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> hive_hbase_table(key <span class="type">int</span>, <span class="keyword">value</span> string) <span class="operator">/</span><span class="operator">/</span> key 字段必须，对应 hbase 中的rowkey</span><br><span class="line">STORED <span class="keyword">BY</span> <span class="string">&#x27;org.apache.hadoop.hive.hbase.HBaseStorageHandler&#x27;</span> </span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (&quot;hbase.columns.mapping&quot; <span class="operator">=</span> &quot;:key,cf1:val&quot;) <span class="operator">/</span><span class="operator">/</span> hbase 字段映射</span><br><span class="line">TBLPROPERTIES (&quot;hbase.table.name&quot; <span class="operator">=</span> &quot;hive_hbase_table&quot;); <span class="operator">/</span><span class="operator">/</span> 映射hbase 中的表名</span><br></pre></td></tr></table></figure>
<h3 id="在-clickhouse-中间-hive-外部表"><a href="#在-clickhouse-中间-hive-外部表" class="headerlink" title="在 clickhouse 中间 hive 外部表"></a>在 clickhouse 中间 hive 外部表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test.test_orc</span><br><span class="line">(</span><br><span class="line">    `key` Int32,</span><br><span class="line">    `val` Int16</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> Hive(<span class="string">&#x27;thrift://xxx.xxx.xxx.xxx:9083&#x27;</span>, <span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;hive_hbase_table&#x27;</span>);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>clickhouse</category>
      </categories>
      <tags>
        <tag>hive</tag>
        <tag>clickhouse</tag>
        <tag>hbase</tag>
      </tags>
  </entry>
  <entry>
    <title>show engine innodb status 报表说明</title>
    <url>/2023/06/14/innodbStatus/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@localhost:(none)&gt;show engine innodb status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">  Type: InnoDB</span><br><span class="line">  Name: </span><br><span class="line">Status:  ##展示时间，监控名称  以及每秒均数是统计最近53秒内每秒的均数</span><br><span class="line">=====================================</span><br><span class="line">2023-06-14 12:25:18 0x7f5478e8f700 INNODB MONITOR OUTPUT</span><br><span class="line">=====================================</span><br><span class="line">Per second averages calculated from the last 53 seconds</span><br><span class="line">-----------------</span><br><span class="line">BACKGROUND THREAD   ##展示 master thread 的已完成的工作情况</span><br><span class="line">-----------------</span><br><span class="line">srv_master_thread loops: 668856 srv_active, 0 srv_shutdown, 3899 srv_idle ## 循环(以 active,shutdown,idle 状态)执行的次数的统计。active 值越高证明服务越繁忙</span><br><span class="line">srv_master_thread log flush and writes: 672755   ##对重做日志写磁盘的次数</span><br><span class="line">----------</span><br><span class="line">SEMAPHORES  ##信号量  </span><br><span class="line">----------</span><br><span class="line">OS WAIT ARRAY INFO: reservation count 14525329  ## OS的等待阵列信息：预计计数（InnoDB分配槽的额度）</span><br><span class="line">OS WAIT ARRAY INFO: signal count 91163064       ## OS的等待阵列信息：信号计数（线程通过阵列得到信号频率）</span><br><span class="line">RW-shared spins 0, rounds 177254322, OS waits 11626144 ## RW 共享锁 的自旋 , 循环 ,等待的的次数统计</span><br><span class="line">RW-excl spins 0, rounds 80192985, OS waits 693410</span><br><span class="line">RW-sx spins 19003619, rounds 44739191, OS waits 193972</span><br><span class="line">Spin rounds per wait: 177254322.00 RW-shared, 80192985.00 RW-excl, 2.35 RW-sx</span><br><span class="line">## InnoDB使用一个2步获取锁的策略。当试图获取一个锁，如果这个锁被占用，首先对锁进行自旋（spin）查询，如果经历了一个自旋周期后还不能获取锁，则进入到操作系统等待状态（os wait），等待被唤醒。</span><br><span class="line">## 如果在一秒中看到几十万个spin wait，则需要关注show engine innodb mutex</span><br><span class="line">## 大量线程等待信号量可能是磁盘I/O 或者是 Innodb 内部争用问题的结果</span><br><span class="line">------------</span><br><span class="line">TRANSACTIONS</span><br><span class="line">------------</span><br><span class="line">Trx id counter 7935198</span><br><span class="line">Purge done for trx&#x27;s n:o &lt; 7935196 undo n:o &lt; 0 state: running but idle</span><br><span class="line">History list length 118</span><br><span class="line">LIST OF TRANSACTIONS FOR EACH SESSION:</span><br><span class="line">---TRANSACTION 421583499832032, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499848448, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499847536, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499846624, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499845712, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499844800, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499843888, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499842976, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499842064, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499841152, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499840240, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499839328, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499838416, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499837504, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499836592, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499833856, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499832944, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 421583499831120, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 7935191, ACTIVE (PREPARED) 0 sec</span><br><span class="line">40 lock struct(s), heap size 3520, 16 row lock(s), undo log entries 84</span><br><span class="line">MySQL thread id 6404, OS thread handle 140000785757952, query id 20013857 Waiting for preceding transaction to commit</span><br><span class="line">---TRANSACTION 7935189, ACTIVE 0 sec starting index read</span><br><span class="line">mysql tables in use 1, locked 1</span><br><span class="line">33 lock struct(s), heap size 3520, 16 row lock(s), undo log entries 26</span><br><span class="line">MySQL thread id 6403, OS thread handle 140000785487616, query id 20013866 System lock</span><br><span class="line">/* DTS-writer-gf1t67yry6k46y1-MysqlEngine(11) */update `mmp_watsons_new`.`mmp_card_point_record_acrl_2023_70` set `order_no` = x&#x27;323330353330333738363136343039373936373137303035393338313530&#x27;,`point_order_id` = 1113713450420494725,`channel_app_id` = NULL,`operation_type` = x&#x27;706F696E74436865636B&#x27;,`point_order_create_at` = &#x27;2023-06-01 06:19:38.0&#x27;,`business_date` = &#x27;2023-05-30 22:03:40.0&#x27;,`expiration_date` = &#x27;2024-12-31 23:59:59.0&#x27;,`card_point_record_arcl_id` = 1113713450466631868,`prod_code` = x&#x27;313031323437333233&#x27;,`create_by` = NULL,`operation_type_name` = x&#x27;E5AFB9E8B4A6&#x27;,`operation_object_id` </span><br><span class="line">--------</span><br><span class="line">FILE I/O</span><br><span class="line">--------</span><br><span class="line">I/O thread 0 state: waiting for completed aio requests (insert buffer thread)</span><br><span class="line">I/O thread 1 state: waiting for completed aio requests (log thread)</span><br><span class="line">I/O thread 2 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 3 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 4 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 5 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 6 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 7 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 8 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 9 state: waiting for completed aio requests (read thread)</span><br><span class="line">I/O thread 10 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 11 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 12 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 13 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 14 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 15 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 16 state: waiting for completed aio requests (write thread)</span><br><span class="line">I/O thread 17 state: waiting for completed aio requests (write thread)</span><br><span class="line">Pending normal aio reads: [0, 0, 0, 0, 0, 0, 0, 0] , aio writes: [0, 0, 0, 0, 0, 0, 0, 0] ,</span><br><span class="line"> ibuf aio reads:, log i/o&#x27;s:, sync i/o&#x27;s:</span><br><span class="line">Pending flushes (fsync) log: 0; buffer pool: 0</span><br><span class="line">228169676 OS file reads, 941687878 OS file writes, 128745732 OS fsyncs</span><br><span class="line">1 pending preads, 0 pending pwrites</span><br><span class="line">144.37 reads/s, 16384 avg bytes/read, 355.69 writes/s, 293.47 fsyncs/s</span><br><span class="line">-------------------------------------</span><br><span class="line">INSERT BUFFER AND ADAPTIVE HASH INDEX</span><br><span class="line">-------------------------------------</span><br><span class="line">Ibuf: size 1, free list len 1156118, seg size 1156120, 175393237 merges</span><br><span class="line">merged operations:</span><br><span class="line"> insert 4721539653, delete mark 896413, delete 4068</span><br><span class="line">discarded operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">Hash table size 25496729, node heap has 3853 buffer(s)</span><br><span class="line">Hash table size 25496729, node heap has 4051 buffer(s)</span><br><span class="line">Hash table size 25496729, node heap has 2702 buffer(s)</span><br><span class="line">Hash table size 25496729, node heap has 7776 buffer(s)</span><br><span class="line">Hash table size 25496729, node heap has 3509 buffer(s)</span><br><span class="line">Hash table size 25496729, node heap has 3477 buffer(s)</span><br><span class="line">Hash table size 25496729, node heap has 2710 buffer(s)</span><br><span class="line">Hash table size 25496729, node heap has 7482 buffer(s)</span><br><span class="line">559.86 hash searches/s, 3029.92 non-hash searches/s</span><br><span class="line">---</span><br><span class="line">LOG</span><br><span class="line">---</span><br><span class="line">Log sequence number 5652529584000</span><br><span class="line">Log flushed up to   5652529557581</span><br><span class="line">Pages flushed up to 5652348066531</span><br><span class="line">Last checkpoint at  5652346103348</span><br><span class="line">0 pending log flushes, 0 pending chkp writes</span><br><span class="line">4602161 log i/o&#x27;s done, 11.27 log i/o&#x27;s/second</span><br><span class="line">----------------------</span><br><span class="line">BUFFER POOL AND MEMORY</span><br><span class="line">----------------------</span><br><span class="line">Total large memory allocated 105545465856</span><br><span class="line">Dictionary memory allocated 36707071</span><br><span class="line">Buffer pool size   6290688</span><br><span class="line">Free buffers       65486</span><br><span class="line">Database pages     6189642</span><br><span class="line">Old database pages 2284551</span><br><span class="line">Modified db pages  96151</span><br><span class="line">Pending reads      1</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 183584798, not young 6457983151</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 228170486, created 269537364, written 902704369</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 990 / 1000, young-making rate 3 / 1000 not 23 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 6189642, unzip_LRU len: 0</span><br><span class="line">I/O sum[314928]:cur[592], unzip sum[0]:cur[0]</span><br><span class="line">----------------------</span><br><span class="line">INDIVIDUAL BUFFER POOL INFO</span><br><span class="line">----------------------</span><br><span class="line">---BUFFER POOL 0</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4092</span><br><span class="line">Database pages     386900</span><br><span class="line">Old database pages 142803</span><br><span class="line">Modified db pages  6244</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11503401, not young 397501864</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14258537, created 16829301, written 56093213</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 995 / 1000, young-making rate 1 / 1000 not 12 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386900, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 1</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4093</span><br><span class="line">Database pages     386877</span><br><span class="line">Old database pages 142793</span><br><span class="line">Modified db pages  5844</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11473787, not young 406127774</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14288465, created 16841257, written 57041997</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 988 / 1000, young-making rate 4 / 1000 not 25 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386877, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 2</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4094</span><br><span class="line">Database pages     386867</span><br><span class="line">Old database pages 142788</span><br><span class="line">Modified db pages  6492</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11447911, not young 410094295</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14225042, created 16860342, written 57197067</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 989 / 1000, young-making rate 4 / 1000 not 22 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386867, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 3</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4092</span><br><span class="line">Database pages     386884</span><br><span class="line">Old database pages 142796</span><br><span class="line">Modified db pages  5519</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11457275, not young 411184738</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14242081, created 16816917, written 57374098</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 990 / 1000, young-making rate 3 / 1000 not 22 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386884, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 4</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4093</span><br><span class="line">Database pages     386826</span><br><span class="line">Old database pages 142775</span><br><span class="line">Modified db pages  5994</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11492781, not young 411168112</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14321944, created 16860054, written 56993785</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 991 / 1000, young-making rate 3 / 1000 not 19 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386826, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 5</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4094</span><br><span class="line">Database pages     386805</span><br><span class="line">Old database pages 142767</span><br><span class="line">Modified db pages  5741</span><br><span class="line">Pending reads      1</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11430273, not young 398449146</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14280953, created 16861870, written 56364946</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 990 / 1000, young-making rate 4 / 1000 not 21 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386805, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 6</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4089</span><br><span class="line">Database pages     386907</span><br><span class="line">Old database pages 142807</span><br><span class="line">Modified db pages  5692</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11488438, not young 394374410</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14232674, created 16831458, written 56226135</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 988 / 1000, young-making rate 3 / 1000 not 27 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386907, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 7</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4094</span><br><span class="line">Database pages     386875</span><br><span class="line">Old database pages 142792</span><br><span class="line">Modified db pages  6588</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11489391, not young 403775780</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14207108, created 16840975, written 56237140</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 988 / 1000, young-making rate 3 / 1000 not 21 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386875, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 8</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4095</span><br><span class="line">Database pages     386851</span><br><span class="line">Old database pages 142783</span><br><span class="line">Modified db pages  5964</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11475962, not young 407959835</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14269932, created 16856735, written 56115744</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 987 / 1000, young-making rate 4 / 1000 not 26 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386851, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 9</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4090</span><br><span class="line">Database pages     386854</span><br><span class="line">Old database pages 142787</span><br><span class="line">Modified db pages  5385</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11462980, not young 397150677</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14247247, created 16842565, written 56179486</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 988 / 1000, young-making rate 4 / 1000 not 29 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386854, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 10</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4093</span><br><span class="line">Database pages     386810</span><br><span class="line">Old database pages 142767</span><br><span class="line">Modified db pages  6165</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11432450, not young 408158098</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14193250, created 16840960, written 56071253</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 987 / 1000, young-making rate 4 / 1000 not 23 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386810, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 11</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4092</span><br><span class="line">Database pages     386854</span><br><span class="line">Old database pages 142786</span><br><span class="line">Modified db pages  6675</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11551863, not young 405446622</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14334456, created 16854097, written 56497730</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 989 / 1000, young-making rate 3 / 1000 not 20 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386854, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 12</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4092</span><br><span class="line">Database pages     386809</span><br><span class="line">Old database pages 142769</span><br><span class="line">Modified db pages  5973</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11493422, not young 403460514</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14341354, created 16855758, written 55907706</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 988 / 1000, young-making rate 4 / 1000 not 25 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386809, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 13</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4096</span><br><span class="line">Database pages     386851</span><br><span class="line">Old database pages 142782</span><br><span class="line">Modified db pages  5327</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11464112, not young 404000445</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14206053, created 16840627, written 56337964</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 988 / 1000, young-making rate 4 / 1000 not 28 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386851, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 14</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4094</span><br><span class="line">Database pages     386833</span><br><span class="line">Old database pages 142777</span><br><span class="line">Modified db pages  6855</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11441411, not young 400034543</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14221940, created 16854000, written 55781897</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 988 / 1000, young-making rate 4 / 1000 not 26 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386833, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">---BUFFER POOL 15</span><br><span class="line">Buffer pool size   393168</span><br><span class="line">Free buffers       4093</span><br><span class="line">Database pages     386839</span><br><span class="line">Old database pages 142779</span><br><span class="line">Modified db pages  5693</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 11479341, not young 399096298</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 14299450, created 16850448, written 56284208</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 989 / 1000, young-making rate 4 / 1000 not 33 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 386839, unzip_LRU len: 0</span><br><span class="line">I/O sum[19683]:cur[37], unzip sum[0]:cur[0]</span><br><span class="line">--------------</span><br><span class="line">ROW OPERATIONS</span><br><span class="line">--------------</span><br><span class="line">0 queries inside InnoDB, 0 queries in queue</span><br><span class="line">0 read views open inside InnoDB</span><br><span class="line">Process ID=111740, Main thread ID=140001081059072, state: sleeping</span><br><span class="line">Number of rows inserted 12562958356, updated 13763168, deleted 1043786, read 14823040</span><br><span class="line">503.08 inserts/s, 155.56 updates/s, 2.08 deletes/s, 157.64 reads/s</span><br><span class="line">----------------------------</span><br><span class="line">END OF INNODB MONITOR OUTPUT</span><br><span class="line">============================</span><br><span class="line"></span><br><span class="line">1 row in set (0.04 sec)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>innodb</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux 自带日志切换工具 logrotate</title>
    <url>/2022/12/14/logrotate/</url>
    <content><![CDATA[<p>很多时候某些工具并没有自带日志轮转功能。当产生日志过多，单个日志文件可能<br>大到几十G对于日志运维比较麻烦，比如nginx。最好的办法就是对文件进行切片。<br>按指定日期进行轮转，后期也有利于日志归档删除。很多人会自己写脚本，在crontab<br>中挂个定时任务，去切换文件。<br>其实在 Linux 中提供了一个logrotate 工具。可以满足这方面的需求，只要配置一下文件。<br>就可以轻松实现各种轮转</p>
<p>以nginx 为例<br>我们需要在 /etc/logrotate.d/ 下面创建一个配置文件<br>vi </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/logrotate.d/nginx</span><br><span class="line"></span><br><span class="line">/usr/local/nginx/logs/*.<span class="built_in">log</span> &#123;</span><br><span class="line">         monthly    <span class="comment">## 轮转周期 daily |weekly |monthly |yearly</span></span><br><span class="line">         missingok  <span class="comment">## 在日志轮循期间，任何错误将被忽略，例如“文件无法找到”之类的错误</span></span><br><span class="line">         rotate 7   <span class="comment">## 保留7个归档</span></span><br><span class="line">         minsize 5M <span class="comment">## 只有超过这个最小值才归档</span></span><br><span class="line">         dateext    <span class="comment">## 归档日志文件名 + 当前日期 重命名</span></span><br><span class="line">         compress   <span class="comment">##在轮循任务完成后，已轮循的归档将使用gzip进行压缩</span></span><br><span class="line">         delaycompress <span class="comment">##总是与compress选项一起用，delaycompress选项指示logrotate不要将最近的归档压缩，压缩将在下一次轮循周期进行。这在你或任何软件仍然需要读取最新归档时很有用。</span></span><br><span class="line">         notifempty  <span class="comment">## 如果日志文件为空，轮循不会进行。</span></span><br><span class="line">         create 640 django django <span class="comment">## 新建的日志文件指定权限</span></span><br><span class="line">         sharedscripts  <span class="comment">## 运行postrotate脚本，作用是在所有日志都轮转后统一执行一次脚本。如果没有配置这个，那么每个日志轮转后都会执行一次脚本</span></span><br><span class="line">         postrotate    <span class="comment">##  在所有其它指令完成后，postrotate和endscript里面指定的命令将被执行。在这种情况下，rsyslogd 进程将立即再次读取其配置并继续运行</span></span><br><span class="line">         <span class="keyword">if</span> [ -f /usr/local/nginx/nginx.pid ]; <span class="keyword">then</span></span><br><span class="line">              <span class="built_in">kill</span> -USR1 `<span class="built_in">cat</span> /usr/local/nginx/nginx.pid`  <span class="comment">## 触发nginx 重新加载配置。这样新的日志才会写入新建的文件</span></span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line">         endscript</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上配置了一个nginx 的日志轮转 按月归档。保留7个月</p>
<p>注意:<br>这些注释在使用时一定要删掉。否则会报错</p>
<p>可以对没有提供轮转功能的任何应用的日志进行轮转。如果没有提供reload 重载配置文件的<br>应用。则需要重启<br>以下是我对django uwsgi 的日志行进轮转配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /etc/logrotate.d/uwsgi</span><br><span class="line">/data/PRG/django/pc_dba_platform/uwsgi.log &#123;</span><br><span class="line">         daily</span><br><span class="line">         missingok</span><br><span class="line">         rotate 30</span><br><span class="line">         minsize 5M</span><br><span class="line">         dateext</span><br><span class="line">         compress</span><br><span class="line">         delaycompress</span><br><span class="line">         notifempty</span><br><span class="line">         create 640 django django</span><br><span class="line">         sharedscripts</span><br><span class="line">         postrotate</span><br><span class="line">         <span class="keyword">if</span> [ -f /data/PRG/django/pc_dba_platform/uwsgi.pid ]; <span class="keyword">then</span></span><br><span class="line">              <span class="comment">## uwsgi --reload 并不做重载配置操作。只是更新python 代码。所以这里用重启服务的方式</span></span><br><span class="line">              /data/PRG/django/pc_dba_platform/django_server.sh stop</span><br><span class="line">              /data/PRG/django/pc_dba_platform/django_server.sh start</span><br><span class="line">         <span class="keyword">fi</span></span><br><span class="line">         endscript</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>强制执行日志轮换<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/sbin/logrotate -f /etc/logrotate.d/uwsgi</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>logrotate</tag>
        <tag>nginx log rotate</tag>
      </tags>
  </entry>
  <entry>
    <title>kickstart配置项说明</title>
    <url>/2023/04/27/kickstart/</url>
    <content><![CDATA[<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">autopart(可选)</span><br><span class="line">            自动创建分区,大于1GB的根分区(/),交换分区和适合于不同体系结构的引导分区.一个或多个缺省分区的大小可以用part指令重新定义.</span><br><span class="line"></span><br><span class="line">ignoredisk(可选)</span><br><span class="line">            导致安装程序忽略指定的磁盘.如果使用自动分区并希望忽略某些磁盘的话,这就很有用.</span><br><span class="line">                    例如,没有ignoredisk,如要试图在SAN-cluster系统里部署,kickstart就会失败,因为安装程序检测到SAN不返回分区表的被动路径(passive path).</span><br><span class="line">            如果有磁盘的多个路径时,ignoredisk选项也有用处.</span><br><span class="line">            语法是:</span><br><span class="line">                    ignoredisk --drives=drive1,drive2,...</span><br><span class="line">                    这里driveN是sda,sdb... hda等等中的一个.</span><br><span class="line"></span><br><span class="line">autostep(可选)</span><br><span class="line">和interactive相似,除了它进入下一屏幕,它通常用于调试.</span><br><span class="line">            --autoscreenshot,安装过程中的每一步都截屏并在安装完成后把图片复制到/root/anaconda-screenshots.这对于制作文档很有用.</span><br><span class="line"></span><br><span class="line">auth或authconfig(必需)</span><br><span class="line">            为系统设置验证选项.这和在安装后运行的authconfig命令相似.在缺省情况下,密码通常被加密但不使用影子文件(shadowed).</span><br><span class="line">            --enablemd5,每个用户口令都使用md5加密.</span><br><span class="line">            --enablenis,启用NIS支持.在缺省情况下,--enablenis使用在网络上找到的域.域应该总是用--nisdomain=选项手工设置.</span><br><span class="line">            --nisdomain=,用在NIS服务的NIS域名.</span><br><span class="line">            --nisserver=,用来提供NIS服务的服务器(默认通过广播).</span><br><span class="line">            --useshadow或--enableshadow,使用屏蔽口令.</span><br><span class="line">            --enableldap,在/etc/nsswitch.conf启用LDAP支持,允许系统从LDAP目录获取用户的信息(UIDs,主目录,shell 等等).要使用这个选项,必须安装nss_ldap软件包.也必须用--ldapserver=和--ldapbasedn=指定服务器和base DN(distinguished name).</span><br><span class="line">            --enableldapauth,把LDAP作为一个验证方法使用.这启用了用于验证和更改密码的使用LDAP目录的pam_ldap模块.要使用这个选项,必须安装nss_ldap软件包.也必须用--ldapserver=和--ldapbasedn=指定服务器和base DN.</span><br><span class="line">            --ldapserver=,如果指定了--enableldap或--enableldapauth,使用这个选项来指定所使用的LDAP服务器的名字.这个选项在/etc/ldap.conf文件里设定.</span><br><span class="line">            --ldapbasedn=,如果指定了--enableldap或--enableldapauth,使用这个选项来指定用户信息存放的LDAP目录树里的DN.这个选项在/etc/ldap.conf文件里设置.</span><br><span class="line">            --enableldaptls,使用TLS(传输层安全)查寻.该选项允许LDAP在验证前向LDAP服务器发送加密的用户名和口令.</span><br><span class="line">            --enablekrb5,使用Kerberos 5验证用户.Kerberos自己不知道主目录,UID或shell.如果启用了Kerberos,必须启用LDAP,NIS,Hesiod或者使用/usr/sbin/useradd命令来使这个工作站获知用户的帐号.如果使用这个选项,必须安装pam_krb5软件包.</span><br><span class="line">            --krb5realm=,工作站所属的Kerberos 5领域.</span><br><span class="line">            --krb5kdc=,为领域请求提供服务的KDC.如果的领域内有多个KDC,使用逗号(,)来分隔它们.</span><br><span class="line">            --krb5adminserver=,领域内还运行kadmind的KDC.该服务器处理改变口令以及其它管理请求.如果有不止一个KDC,该服务器必须是主KDC.</span><br><span class="line">            --enablehesiod,启用Hesiod支持来查找用户主目录,UID 和 shell.在网络中设置和使用 Hesiod 的更多信息,可以在 glibc 软件包里包括的 /usr/share/doc/glibc-2.x.x/README.hesiod里找到.Hesiod是使用DNS记录来存储用户,组和其他信息的 DNS 的扩展.</span><br><span class="line">            --hesiodlhs,Hesiod LHS(&quot;left-hand side&quot;)选项在/etc/hesiod.conf里设置.Hesiod 库使用这个选项来决定查找信息时搜索DNS的名字,类似于LDAP对 base DN的使用.</span><br><span class="line">            --hesiodrhs,Hesiod RHS(&quot;right-hand side&quot;)选项在/etc/hesiod.conf里设置.Hesiod 库使用这个选项来决定查找信息时搜索DNS的名字,类似于LDAP对base DN的使用.</span><br><span class="line">            --enablesmbauth,启用对SMB服务器(典型的是Samba或Windows服务器)的用户验证.SMB验证支持不知道主目录,UID 或 shell.如果启用SMB,必须通过启用LDAP,NIS,Hesiod或者用/usr/sbin/useradd命令来使用户帐号为工作站所知.要使用这个选项,必须安装pam_smb软件包.</span><br><span class="line">            --smbservers=,用来做SMB验证的服务器名称.要指定不止一个服务器,用逗号(,)来分隔它们.</span><br><span class="line">            --smbworkgroup=,SMB服务器的工作组名称.</span><br><span class="line">            --enablecache,启用nscd服务.nscd服务缓存用户,组和其他类型的信息.如果选择在网络上用NIS,LDAP或hesiod分发用户和组的信息,缓存就尤其有用.</span><br><span class="line"></span><br><span class="line">bootloader(必需)</span><br><span class="line">            指定引导装载程序怎样被安装.对于安装和升级,这个选项都是必需的.</span><br><span class="line">            --append=,指定内核参数.要指定多个参数,使用空格分隔它们.</span><br><span class="line">                    例如:bootloader --location=mbr --append=&quot;hdd=ide-scsi ide=nodma&quot;</span><br><span class="line">            --driveorder,指定在BIOS引导顺序中居首的驱动器.</span><br><span class="line">                    例如:bootloader --driveorder=sda,hda</span><br><span class="line">            --location=,指定引导记录被写入的位置.有效的值如下:mbr(缺省),partition(在包含内核的分区的第一个扇区安装引导装载程序)或none(不安装引导装载程序).</span><br><span class="line">            --password=,如果使用GRUB,把GRUB引导装载程序的密码设置到这个选项指定的位置.这应该被用来限制对可以传入任意内核参数的GRUB shell的访问.</span><br><span class="line">            --md5pass=,如果使用GRUB,这和--password=类似,只是密码已经被加密.</span><br><span class="line">            --upgrade,升级现存的引导装载程序配置,保留其中原有的项目.该选项仅可用于升级.</span><br><span class="line">clearpart(可选)</span><br><span class="line">            在创建新分区之前,从系统上删除分区.默认不会删除任何分区.</span><br><span class="line">            注:如果使用了clearpart命令,--onpart命令就不能够用在逻辑分区上.</span><br><span class="line">            --all,删除系统上所有分区.</span><br><span class="line">            --drives=,指定从哪个驱动器上清除分区.</span><br><span class="line">                    例如,下面的命令清除了主IDE控制器上的前两个驱动器上所有分区</span><br><span class="line">                    clearpart --drives=hda,hdb --all</span><br><span class="line">            --initlabel,根据不同体系结构把磁盘标签初始化为缺省设置(例如,msdos用于x86而gpt用于Itanium).当安装到一个崭新的硬盘时,这很有用,安装程序不会询问是否应该初始化磁盘标签.</span><br><span class="line">            --linux,删除所有Linux分区.</span><br><span class="line">            --none(缺省),不要删除任何分区.</span><br><span class="line"></span><br><span class="line">cmdline(可选)</span><br><span class="line">            在完全的非交互式的命令行模式下进行安装.任何交互式的提示都会终止安装.这个模式对于有x3270控制台的IBM System z系统很有用.</span><br><span class="line"></span><br><span class="line">device(可选)</span><br><span class="line">            在多数的PCI系统里,安装程序会正确地自动探测以太网卡和SCSI卡.然而,在老的系统和某些PCI系统里,kickstart需要提示来找到正确的设备.device命令用来告诉安装程序安装额外的模块,它有着这样的格式:</span><br><span class="line">            device &lt;type&gt;&lt;moduleName&gt; --opts=&lt;options&gt;</span><br><span class="line">            &lt;type&gt;,用scsi或eth代替</span><br><span class="line">            &lt;moduleName&gt;,使用应该被安装的内核模块的名称来替换.</span><br><span class="line">            --opts=,传递给内核模块的选项.注意,如果把选项放在引号里,可以传递多个选项.</span><br><span class="line">                    例如:--opts=&quot;aic152x=0x340 io=11&quot;</span><br><span class="line"></span><br><span class="line">driverdisk(可选)</span><br><span class="line">            可以在kickstart安装过程中使用驱动软盘.必须把驱动软盘的内容复制到系统的硬盘分区的根目录下.然后必须使用driverdisk 命令来告诉安装程序到哪去寻找驱动磁盘.</span><br><span class="line">            driverdisk &lt;partition&gt; [--type=&lt;fstype&gt;]</span><br><span class="line">            另外,也可以为驱动程序盘指定一个网络位置:</span><br><span class="line">            driverdisk --source=ftp://path/to/dd.img</span><br><span class="line">            driverdisk --source=http://path/to/dd.img</span><br><span class="line">            driverdisk --source=nfs:host:/path/to/img</span><br><span class="line">                    &lt;partition&gt;,包含驱动程序盘的分区.</span><br><span class="line">                    --type=,文件系统类型(如:vfat,ext2,ext3).</span><br><span class="line"></span><br><span class="line">firewall(可选)</span><br><span class="line">            这个选项对应安装程序里的「防火墙配置」屏幕:</span><br><span class="line">            firewall --enabled|--disabled [--trust=] &lt;device&gt; [--port=]</span><br><span class="line">            --enabled或者--enable,拒绝不是答复输出请求如DNS答复或DHCP请求的进入连接.如果需要使用在这个机器上运行的服务,可以选择允许指定的服务穿过防火墙.</span><br><span class="line">            --disabled或--disable,不要配置任何iptables规则.</span><br><span class="line">            --trust=,在此列出设备,如eth0,这允许所有经由这个设备的数据包通过防火墙.如果需要列出多个设备,使用--trust eth0 --trust eth1.不要使用以逗号分隔的格式,如--trust eth0, eth1.</span><br><span class="line">            &lt;incoming&gt;,使用以下服务中的一个或多个来替换,从而允许指定的服务穿过防火墙.</span><br><span class="line">                    --ssh</span><br><span class="line">                    --telnet</span><br><span class="line">                    --smtp</span><br><span class="line">                    --http</span><br><span class="line">                    --ftp</span><br><span class="line">            --port=,可以用端口:协议(port:protocal)格式指定允许通过防火墙的端口.</span><br><span class="line">                    例如,如果想允许IMAP通过的防火墙,可以指定imap:tcp.还可以具体指定端口号码,要允许UDP分组在端口1234通过防火墙,输入1234:udp.要指定多个端口,用逗号将它们隔开.</span><br><span class="line"></span><br><span class="line">firstboot(可选)</span><br><span class="line">            决定是否在系统第一次引导时启动&quot;设置代理&quot;.如果启用,firstboot软件包必须被安装.如果不指定,这个选项是缺省为禁用的.</span><br><span class="line">            --enable或--enabled,系统第一次引导时,启动&quot;设置代理&quot;.</span><br><span class="line">            --disable或--disabled,系统第一次引导时,不启动&quot;设置代理&quot;.</span><br><span class="line">            --reconfig,在系统引导时在重配置(reconfiguration)模式下启用&quot;设置代理&quot;.这个模式启用了语言,鼠标,键盘,根密码,安全级别,时区和缺省网络配置之外的选项.</span><br><span class="line"></span><br><span class="line">halt(可选)</span><br><span class="line">            在成功地完成安装后关闭系统.这和手工安装相似,手工安装的anaconda会显示一条信息并等待用户按任意键来重启系统.在kickstart安装过程中,如果没有指定完成方法(completion method),将缺省使用reboot选项.</span><br><span class="line">            halt选项基本和shutdown -h命令相同.</span><br><span class="line">            关于其他的完成方法,请参考kickstart的poweroff,reboot和shutdown选项.</span><br><span class="line"></span><br><span class="line">graphical(可选)</span><br><span class="line">            在图形模式下执行kickstart安装.kickstart安装默认在图形模式下安装.</span><br><span class="line"></span><br><span class="line">install(可选)</span><br><span class="line">            告诉系统来安装全新的系统而不是在现有系统上升级.这是缺省的模式.必须指定安装的类型,如cdrom,harddrive,nfs或url(FTP 或HTTP安装).install命令和安装方法命令必须处于不同的行上.</span><br><span class="line"></span><br><span class="line">cdrom</span><br><span class="line">            从系统上的第一个光盘驱动器中安装.</span><br><span class="line"></span><br><span class="line">harddrive</span><br><span class="line">            从本地驱动器的vfat或ext2格式的红帽安装树来安装.</span><br><span class="line">            --biospart=,从BIOS分区来安装(如82).</span><br><span class="line">            --partition=,从分区安装(如sdb2).</span><br><span class="line">            --dir=,包含安装树的variant目录的目录.</span><br><span class="line">                    例如:harddrive --partition=hdb2 --dir=/tmp/install-tree</span><br><span class="line"></span><br><span class="line">nfs</span><br><span class="line">            从指定的NFS服务器安装.</span><br><span class="line">                    --server=,要从中安装的服务器(主机名或IP).</span><br><span class="line">                    --dir=,包含安装树的variant目录的目录.</span><br><span class="line">                    --opts=,用于挂载NFS输出的Mount选项(可选).</span><br><span class="line">                            例如:nfs --server=nfsserver.example.com --dir=/tmp/install-tree</span><br><span class="line"></span><br><span class="line">url</span><br><span class="line">            通过FTP或HTTP从远程服务器上的安装树中安装.</span><br><span class="line">                    例如:url --url http://&lt;server&gt;/&lt;dir&gt;</span><br><span class="line">                    或:url --url ftp://&lt;username&gt;:&lt;password&gt;@&lt;server&gt;/&lt;dir&gt;</span><br><span class="line"></span><br><span class="line">ignore disk(可选)</span><br><span class="line">            用来指定在分区,格式化和清除时anaconda不应该访问的磁盘.这个命令有一个必需的参数,就是用逗号隔开的需要忽略的驱动器列表.</span><br><span class="line">            例如:ignoredisk --drives=[disk1,disk2,...]</span><br><span class="line"></span><br><span class="line">interactive(可选)</span><br><span class="line">            在安装过程中使用kickstart文件里提供的信息,但允许检查和修改给定的值.将遇到安装程序的每个屏幕以及kickstart文件里给出的值.通过点击&quot;下一步&quot;接受给定的值或是改变值后点击&quot;下一步&quot;继续.请参考autostep命令.</span><br><span class="line"></span><br><span class="line">iscsi(可选)</span><br><span class="line">            issci --ipaddr= [options].</span><br><span class="line">            --target</span><br><span class="line">            --port=</span><br><span class="line">            --user=</span><br><span class="line">            --password=</span><br><span class="line"></span><br><span class="line">iscsiname(可选)</span><br><span class="line"></span><br><span class="line">key(可选)</span><br><span class="line">            指定安装密钥,它在软件包选择和获取支持时设别系统的时候是必需的.这个命令是红帽企业Linux-specific,它对Fedora来说没有意义并且会被忽略.</span><br><span class="line">            --skip,跳过输入密钥.通常,如果没有key命令,anaconda将暂停并提示输入密钥.如果没有密钥或不想提供它,这个选项允许继续自动化安装.</span><br><span class="line"></span><br><span class="line">keyboard(必需)</span><br><span class="line">            设置系统键盘类型.这里是 i386,Itanium,和 Alpha 机器上可用键盘的列表:</span><br><span class="line">            be-latin1, bg, br-abnt2, cf, cz-lat2, cz-us-qwertz, de, de-latin1,</span><br><span class="line">            de-latin1-nodeadkeys, dk, dk-latin1, dvorak, es, et, fi, fi-latin1,</span><br><span class="line">            fr, fr-latin0, fr-latin1, fr-pc, fr_CH, fr_CH-latin1, gr, hu, hu101,</span><br><span class="line">            is-latin1, it, it-ibm, it2, jp106, la-latin1, mk-utf, no, no-latin1,</span><br><span class="line">            pl, pt-latin1, ro_win, ru, ru-cp1251, ru-ms, ru1, ru2,  ru_win, </span><br><span class="line">            se-latin1, sg, sg-latin1, sk-qwerty, slovene, speakup,  speakup-lt,</span><br><span class="line">            sv-latin1, sg, sg-latin1, sk-querty, slovene, trq, ua,  uk, us, us-acentos</span><br><span class="line">            文件/usr/lib/python2.2/site-packages/rhpl/keyboard_models.py 也包含这个列表而且是 rhpl 软件包的一部分.</span><br><span class="line"></span><br><span class="line">lang(必需)</span><br><span class="line">            设置在安装过程中使用的语言以及系统的缺省语言.例如,要把语言设置为英语,kickstart文件应该包含下面的一行:</span><br><span class="line">            lang en_US</span><br><span class="line">            文件/usr/share/system-config-language/locale-list里每一行的第一个字段提供了一个有效语言代码的列表,它是system-config-language软件包的一部分.</span><br><span class="line">            文本模式的安装过程不支持某些语言(主要是中文,日语,韩文和印度的语言).如果用lang命令指定这些语言中的一种,安装过程仍然会使用英语,但是系统会缺省使用指定的语言.</span><br><span class="line"></span><br><span class="line">langsupport(不赞成)</span><br><span class="line">            langsupport关键字已经被取消而且使用它将导致屏幕出现错误信息及终止安装.作为代替,应该在kickstart文件里的%packages 部分列出所支持的语言的支持软件包组.例如,要支持法语,应该把下面的语句加入到</span><br><span class="line">            %packages:</span><br><span class="line">            @french-support</span><br><span class="line"></span><br><span class="line">logvol(可选)</span><br><span class="line">            使用以下语法来为逻辑卷管理(LVM)创建逻辑卷:</span><br><span class="line">            logvol &lt;mntpoint&gt; --vgname=&lt;name&gt; --size=&lt;size&gt; --name=&lt;name&gt;&lt;options&gt;</span><br><span class="line">            这些选项如下所示:</span><br><span class="line">            --noformat,使用一个现存的逻辑卷,不进行格式化.</span><br><span class="line">            --useexisting,使用一个现存的逻辑卷,重新格式化它.</span><br><span class="line">            --fstype=,为逻辑卷设置文件系统类型.合法值有:ext2,ext3,swap和vfat.</span><br><span class="line">            --fsoptions=,为逻辑卷设置文件系统类型.合法值有:ext2,ext3,swap和vfat.</span><br><span class="line">            --bytes-per-inode=,指定在逻辑卷上创建的文件系统的节点的大小.因为并不是所有的文件系统都支持这个选项,所以在其他情况下它都被忽略.</span><br><span class="line">            --grow=,告诉逻辑卷使用所有可用空间(若有),或使用设置的最大值.</span><br><span class="line">            --maxsize=,当逻辑卷被设置为可扩充时,以MB为单位的分区最大值.在这里指定一个整数值,不要在数字后加MB.</span><br><span class="line">            --recommended=,自动决定逻辑卷的大小.</span><br><span class="line">            --percent=,用卷组里可用空间的百分比来指定逻辑卷的大小.</span><br><span class="line">            首先创建分区,然后创建逻辑卷组,再创建逻辑卷.</span><br><span class="line">                    例如:</span><br><span class="line">                    part pv.01 --size 3000 </span><br><span class="line">                    volgroup myvg pv.01</span><br><span class="line">                    logvol / --vgname=myvg --size=2000 --name=rootvol</span><br><span class="line"></span><br><span class="line">logging(可选)</span><br><span class="line">            这个命令控制安装过程中anaconda的错误日志.它对安装好的系统没有影响.</span><br><span class="line">            --host=,发送日志信息到给定的远程主机,这个主机必须运行配置为可接受远程日志的syslogd进程.</span><br><span class="line">     --port=,如果远程的syslogd进程没有使用缺省端口,这个选项必须被指定.</span><br><span class="line">            --level=,debug,info,warning,error或critical中的一个.</span><br><span class="line">            指定tty3上显示的信息的最小级别.然而,无论这个级别怎么设置,所有的信息仍将发送到日志文件.</span><br><span class="line"></span><br><span class="line">mediacheck(可选)</span><br><span class="line">            如果指定的话,anaconda将在安装介质上运行mediacheck.这个命令只适用于交互式的安装,所以缺省是禁用的.</span><br><span class="line"></span><br><span class="line">monitor(可选)</span><br><span class="line">            如果monitor命令没有指定,anaconda将使用X来自动检测的显示器设置.请在手工配置显示器之前尝试这个命令.</span><br><span class="line">            --hsync=,指定显示器的水平频率.</span><br><span class="line">            --vsync=,指定显示器的垂直频率.</span><br><span class="line">            --monitor=,使用指定的显示器；显示器的名字应该在hwdata软件包里的/usr/share/hwdata/MonitorsDB列表上.这个显示器的列表也可以在Kickstart Configurator的X配置屏幕上找到.如果提供了--hsync或--vsync,它将被忽略.如果没有提供显示器信息,安装程序将自动探测显示器.</span><br><span class="line">            --noprobe=,不要试图探测显示器.</span><br><span class="line"></span><br><span class="line">mouse(已取消)</span><br><span class="line">            mouse 关键字已经被取消,使用它将导致屏幕出现错误信息并终止安装.</span><br><span class="line"></span><br><span class="line">network(可选)</span><br><span class="line">            为系统配置网络信息.如果 kickstart安装不要求联网(换句话说,不从NFS,HTTP或FTP安装),就不需要为系统配置网络.如果安装要求联网而kickstart文件里没有提供网络信息,安装程序会假定从eth0通过动态IP地址(BOOTP/DHCP)来安装,并配置安装完的系统动态决定IP地址.network选项为通过网络的kickstart安装以及所安装的系统配置联网信息.</span><br><span class="line">            --bootproto=,dhcp,bootp或static中的一种,缺省值是dhcp.bootp和dhcp被认为是相同的.</span><br><span class="line">                    static方法要求在kickstart文件里输入所有的网络信息.顾名思义,这些信息是静态的且在安装过程中和安装后所有.静态网络的设置行更为复杂,因为必须包括所有的网络配置信息.必须指定IP地址,网络,网关和命名服务器.</span><br><span class="line">                    例如(&quot;\&quot;表示连续的行):</span><br><span class="line">                    network --bootproto=static --ip=10.0.2.15 --netmask=255.255.255.0 \</span><br><span class="line">                    --gateway=10.0.2.254 --nameserver=10.0.2.1</span><br><span class="line">                    如果使用静态方法,请注意以下两个限制:</span><br><span class="line">                            所有静态联网配置信息都必须在一行上指定,不能使用反斜线来换行.</span><br><span class="line">                            在这里只能够指定一个命名服务器.然而,如果需要的话,可以使用kickstart文件的%post段落来添加更多的命名服务器.</span><br><span class="line">            --device=,用来选择用于安装的特定的以太设备.注意,除非kickstart文件是一个本地文件(如ks=floppy),否则--device=的使用是无效的.这是因为安装程序会配置网络来寻找kickstart文件.</span><br><span class="line">                    例如: network --bootproto=dhcp --device=eth0</span><br><span class="line">            --ip=,要安装的机器的IP地址.</span><br><span class="line">            --gateway=,IP地址格式的默认网关.</span><br><span class="line">            --nameserver=,主名称服务器,IP地址格式.</span><br><span class="line">            --nodns,不要配置任何 DNS 服务器.</span><br><span class="line">            --netmask=,安装的系统的子网掩码.</span><br><span class="line">            --hostname=,安装的系统的主机名.</span><br><span class="line">            --ethtool=,指定传给ethtool程序的网络设备的其他底层设置.</span><br><span class="line">            --essid=,无线网络的网络ID.</span><br><span class="line">            --wepkey=,无线网络的加密密钥.</span><br><span class="line">            --onboot=,是否在引导时启用该设备.</span><br><span class="line">            --class=,DHCP类型.</span><br><span class="line">            --mtu=,该设备的MTU.</span><br><span class="line">            --noipv4=,禁用此设备的IPv4.</span><br><span class="line">            --noipv6=,禁用此设备的IPv6.</span><br><span class="line"></span><br><span class="line">multipath(可选)</span><br><span class="line">            multipath --name= --device= --rule=</span><br><span class="line"></span><br><span class="line">part或partition(对于安装是必需的,升级可忽略).</span><br><span class="line">            在系统上创建分区.</span><br><span class="line">            如果不同分区里有多个红帽企业Linux系统,安装程序会提示用户升级哪个系统.</span><br><span class="line">            警告:作为安装过程的一部分,所有被创建的分区都会被格式化,除非使用了--noformat和--onpart.</span><br><span class="line">            &lt;mntpoint&gt;,&lt;mntpoint&gt;是分区的挂载点,它必须是下列形式中的一种:</span><br><span class="line">                    /&lt;path&gt;,例如,/,/usr,/home</span><br><span class="line">                    swap,该分区被用作交换空间,要自动决定交换分区的大小,使用--recommended选项.</span><br><span class="line">                            swap --recommended</span><br><span class="line">                            自动生成的交换分区的最小值大于系统内存的数量,但小于系统内存的两倍.</span><br><span class="line">                    raid.&lt;id&gt;,该分区用于 software RAID(参考 raid).</span><br><span class="line">                    pv.&lt;id&gt;,该分区用于 LVM(参考 logvol).</span><br><span class="line">            --size=,以MB为单位的分区最小值.在此处指定一个整数值,如500.不要在数字后面加MB.</span><br><span class="line">            --grow,告诉分区使用所有可用空间(若有),或使用设置的最大值.</span><br><span class="line">            --maxsize=,当分区被设置为可扩充时,以MB为单位的分区最大值.在这里指定一个整数值,不要在数字后加MB.</span><br><span class="line">            --noformat,用--onpart命令来告诉安装程序不要格式化分区.</span><br><span class="line">            --onpart=或--usepart=,把分区放在已存在的设备上.</span><br><span class="line">                    例如:partition /home --onpart=hda1,把/home置于必须已经存在的/dev/hda1上.</span><br><span class="line">            --ondisk=或--ondrive=,强迫分区在指定磁盘上创建.</span><br><span class="line">                    例如:--ondisk=sdb把分区置于系统的第二个SCSI磁盘上.</span><br><span class="line">            --asprimary,强迫把分区分配为主分区,否则提示分区失败.</span><br><span class="line">            --type=(用fstype代替),这个选项不再可用了.应该使用fstype.</span><br><span class="line">            --fstype=,为分区设置文件系统类型.有效的类型为ext2,ext3,swap和vfat.</span><br><span class="line">            --start=,指定分区的起始柱面,它要求用--ondisk=或ondrive=指定驱动器.它也要求用--end=指定结束柱面或用--size=指定分区大小.</span><br><span class="line">            --end=,指定分区的结束柱面.它要求用--start=指定起始柱面.</span><br><span class="line">            --bytes-per-inode=,指定此分区上创建的文件系统的节点大小.不是所有的文件系统都支持这个选项,所以在其他情况下它都被忽略.</span><br><span class="line">            --recommended,自动决定分区的大小.</span><br><span class="line">            --onbiosdisk,强迫在 BIOS 找到的特定磁盘上创建分区.</span><br><span class="line">            注:如果因为某种原因分区失败了,虚拟终端3上会显示诊断信息.</span><br><span class="line"></span><br><span class="line">poweroff(可选)</span><br><span class="line">            在安装成功后关闭系统并断电.通常,在手工安装过程中,anaconda会显示一条信息并等待用户按任意键来重新启动系统.在kickstart的安装过程中,如果没有指定完成方法,将使用缺省的reboot选项.</span><br><span class="line"></span><br><span class="line">raid(可选)</span><br><span class="line">            组成软件RAID设备.该命令的格式是:</span><br><span class="line">            raid &lt;mntpoint&gt; --level=&lt;level&gt; --device=&lt;mddevice&gt;&lt;partitions*&gt;</span><br><span class="line">            &lt;mntpoint&gt;,RAID文件系统被挂载的位置.如果是/,除非已经有引导分区存在(/boot),RAID级别必须是1.如果已经有引导分区,/boot分区必须是级别1且根分区(/)可以是任何可用的类型.&lt;partitions*&gt;(这表示可以有多个分区)列出了加入到RAID阵列的RAID标识符.</span><br><span class="line">            --level=,要使用的RAID级别(0,1,或5).</span><br><span class="line">            --device=,要使用的RAID设备的名称(如md0或md1).RAID设备的范围从md0直到md7,每个设备只能被使用一次.</span><br><span class="line">            --bytes-per-inode=,指定RAID设备上创建的文件系统的节点大小.不是所有的文件系统都支持这个选项,所以对于那些文件系统它都会被忽略.</span><br><span class="line">            --spares=,指定RAID阵列应该被指派N个备用驱动器.备用驱动器可以被用来在驱动器失败时重建阵列.</span><br><span class="line">            --fstype=,为RAID阵列设置文件系统类型.合法值有:ext2,ext3,swap和vfat.</span><br><span class="line">            --fsoptions=,指定当挂载文件系统时使用的free form字符串.这个字符串将被复制到系统的/etc/fstab文件里且应该用引号括起来.</span><br><span class="line">            --noformat,使用现存的RAID设备,不要格式化RAID阵列.</span><br><span class="line">            --useexisting,使用现存的RAID设备,重新格式化它.</span><br><span class="line"></span><br><span class="line">reboot(可选)</span><br><span class="line">            在成功完成安装(没有参数)后重新启动.通常,kickstart会显示信息并等待用户按任意键来重新启动系统.</span><br><span class="line"></span><br><span class="line">repo(可选)</span><br><span class="line">            配置用于软件包安装来源的额外的yum库.可以指定多个repo行.</span><br><span class="line">            repo --name=&lt;repoid&gt; [--baseline=&lt;url&gt;| --mirrorlist=&lt;url&gt;]</span><br><span class="line">            --name=,repo id.这个选项是必需的.</span><br><span class="line">            --baseurl=,库的URL.这里不支持yum repo配置文件里使用的变量.可以使用它或者--mirrorlist,亦或两者都不使用.</span><br><span class="line">            --mirrorlist=,指向库镜像的列表的URL.这里不支持yum repo配置文件里可能使用的变量.可以使用它或者--baseurl,亦或两者都不使用.</span><br><span class="line"></span><br><span class="line">rootpw(必需)</span><br><span class="line">            把系统的根口令设置为&lt;password&gt;参数.</span><br><span class="line">            rootpw [--iscrypted] &lt;password&gt;</span><br><span class="line">            --iscrypted,如果该选项存在,口令就会假定已被加密.</span><br><span class="line"></span><br><span class="line">selinux(可选)</span><br><span class="line">            在系统里设置SELinux状态.在anaconda里,SELinux缺省为enforcing.</span><br><span class="line">            selinux [--disabled|--enforcing|--permissive]</span><br><span class="line">            --enforcing,启用SELinux,实施缺省的targeted policy.</span><br><span class="line">                    注:如果kickstart文件里没有selinux选项,SELinux将被启用并缺省设置为--enforcing.</span><br><span class="line">            --permissive,输出基于SELinux策略的警告,但实际上不执行这个策略.</span><br><span class="line">            --disabled,在系统里完全地禁用 SELinux.</span><br><span class="line"></span><br><span class="line">services(可选)</span><br><span class="line">            修改运行在缺省运行级别下的缺省的服务集.在disabled列表里列出的服务将在enabled列表里的服务启用之前被禁用.</span><br><span class="line">            --disabled,禁用用逗号隔开的列表里的服务.</span><br><span class="line">            --enabled,启用用逗号隔开的列表里的服务.</span><br><span class="line"></span><br><span class="line">shutdown(可选)</span><br><span class="line">            在成功完成安装后关闭系统.在kickstart安装过程中,如果没有指定完成方法,将使用缺省的reboot选项.</span><br><span class="line"></span><br><span class="line">skipx(可选)</span><br><span class="line">            如果存在,安装的系统上就不会配置X.</span><br><span class="line"></span><br><span class="line">text(可选)</span><br><span class="line">            在文本模式下执行kickstart安装. kickstart安装默认在图形模式下安装.</span><br><span class="line"></span><br><span class="line">timezone(可选)</span><br><span class="line">            把系统时区设置为&lt;timezone&gt;,它可以是timeconfig列出的任何时区.</span><br><span class="line">            timezone [--utc] &lt;timezone&gt;</span><br><span class="line">            --utc,如果存在,系统就会假定硬件时钟被设置为UTC(格林威治标准)时间.</span><br><span class="line"></span><br><span class="line">upgrade(可选)</span><br><span class="line">            告诉系统升级现有的系统而不是安装一个全新的系统.必须指定 cdrom,harddrive,nfs或url(对于FTP和HTTP而言)中的一个作为安装树的位置.详情请参考 install.</span><br><span class="line"></span><br><span class="line">user(可选)</span><br><span class="line">            在系统上创建新用户.</span><br><span class="line">            user --name=&lt;username&gt; [--groups=&lt;list&gt;] [--homedir=&lt;homedir&gt;] [--password=&lt;password&gt;] [--iscrypted] [--shell=&lt;shell&gt;] [--uid=&lt;uid&gt;]</span><br><span class="line">            --name=,提供用户的名字.这个选项是必需的.</span><br><span class="line">            --groups=,除了缺省的组以外,用户应该属于的用逗号隔开的组的列表.</span><br><span class="line">            --homedir=,用户的主目录.如果没有指定,缺省为/home/&lt;username&gt;.</span><br><span class="line">            --password=,新用户的密码.如果没有指定,这个帐号将缺省被锁住.</span><br><span class="line">            --iscrypted=,所提供的密码是否已经加密？</span><br><span class="line">            --shell=,用户的登录shell.如果不提供,缺省为系统的缺省设置.</span><br><span class="line">            --uid=,用户的UID.如果未提供,缺省为下一个可用的非系统 UID.</span><br><span class="line"></span><br><span class="line">vnc(可选)</span><br><span class="line">            允许通过VNC远程地查看图形化的安装.文本模式的安装通常更喜欢使用这个方法,因为在文本模式下有某些大小和语言的限制.如果为no,这个命令将启动不需要密码的VNC服务器并打印出需要用来连接远程机器的命令.</span><br><span class="line">            vnc [--host=&lt;hostname&gt;] [--port=&lt;port&gt;] [--password=&lt;password&gt;]</span><br><span class="line">            --host=,不启动VNC服务器,而是连接至给定主机上的VNC viewer进程.</span><br><span class="line">            --port=,提供远程VNC viewer进程侦听的端口.如果不提供,anaconda将使用VNC的缺省端口.</span><br><span class="line">            --password=,设置连接VNC会话必需的密码.这是可选的,但却是我们所推荐的选项.</span><br><span class="line"></span><br><span class="line">volgroup(可选)</span><br><span class="line">            用来创建逻辑卷管理(LVM)组,其语法格式为:</span><br><span class="line">            volgroup &lt;name&gt;&lt;partition&gt;&lt;options&gt;</span><br><span class="line">            这些选项如下所示:</span><br><span class="line">            --noformat,使用一个现存的卷组,不要格式化它.</span><br><span class="line">            --useexisting,使用一个现存的卷组,重新格式化它.</span><br><span class="line">            --pesize=,设置物理分区(physical extent)的大小.</span><br><span class="line">            首先创建分区,然后创建逻辑卷组,再创建逻辑卷.例如:</span><br><span class="line"></span><br><span class="line">xconfig(可选)</span><br><span class="line">            配置X Window 系统.如果没有指定这个选项且安装了X,用户必须在安装过程中手工配置X；如果最终系统里没有安装X,这个选项不应该被使用.</span><br><span class="line">            --driver,指定用于视频硬件的 X 驱动.</span><br><span class="line">            --videoram=,指定显卡的显存数量.</span><br><span class="line">            --defaultdesktop=,指定GNOME或KDE作为缺省的桌面(假设已经通过%packages安装了GNOME或KDE桌面环境).</span><br><span class="line">            --startxonboot,在安装的系统上使用图形化登录.</span><br><span class="line">            --resolution=,指定安装的系统上X窗口系统的默认分辨率.有效值有:640x480,800x600,1024x768,1152x864, 1280x1024,1400x1050,1600x1200.请确定指定与视频卡和显示器兼容的分辨率.</span><br><span class="line">            --depth=,指定安装的系统上的 X 窗口系统的默认色彩深度.有效值有:8,16,24,和 32.请确定指定与视频卡和显示器兼容的色彩深度.</span><br><span class="line"></span><br><span class="line">zerombr(可选)</span><br><span class="line">            如果指定了zerombr且yes是它的唯一参数,任何磁盘上的无效分区表都将被初始化.这会毁坏有无效分区表的磁盘上的所有内容.这个命令的格式应该如下:</span><br><span class="line">            zerombr yes</span><br><span class="line">            其它格式均无效.</span><br><span class="line"></span><br><span class="line">zfcp(可选)</span><br><span class="line">            zfcp [--devnum=&lt;devnum&gt;] [--fcplun=&lt;fcplun&gt;] [--scsiid=&lt;scsiid&gt;] [--scsilun=&lt;scsilun&gt;] [--wwpn=&lt;wwpn&gt;]</span><br><span class="line"></span><br><span class="line">    %include</span><br><span class="line">            使用 %include/path/to/file命令可以把其他文件的内容包含在kickstart文件里,就好像这些内容出现在kickstart文件的%include命令后一样.</span><br></pre></td></tr></table></figure>
<p>LVM 分区配置<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># LVM partitioning infomation</span><br><span class="line">part /boot --fstype=&quot;ext4&quot; --size=200                          #这句很简单，创建一个ext4的分区，挂载到/boot，大小为200M，注意单位</span><br><span class="line">part pv.01 --size=10000                                        #创建第一个PV分区，所以是01，大小为10000M,第一个硬盘</span><br><span class="line">volgroup vg_root pv.01                                         #创建一个VG，名字为vg_root，包含第一个PV分区</span><br><span class="line">logvol  /  --vgname=vg_root  --size=2000  --name=lv_root       #创建一个LV，挂载到/  ，从vg_root中创建，大小为2000M，LV的名字是lv_root</span><br><span class="line">part pv.02 --size=2048                                         #创建第二个PV分区，大小为2048M，第二个硬盘</span><br><span class="line">volgroup vg_swap pv.02                                         #创建VG，名字vg_swap ，包含PV02</span><br><span class="line">logvol swap --vgname=vg_swap --size=1 --grow  --name=lv_swap   #  --size 后面跟的是大小， --grow 指的是使用所有可用空间，那么这句的意思就是使用VG所有可用空间来创建LV</span><br></pre></td></tr></table></figure><br>摘抄:<br><a href="https://www.zhihu.com/tardis/bd/art/374054171?source_id=1001">https://www.zhihu.com/tardis/bd/art/374054171?source_id=1001</a> PXE全自动批量安装linux系统【全程干货详解-保姆级教程】<br><a href="https://blog.csdn.net/supersyd/article/details/23704615">https://blog.csdn.net/supersyd/article/details/23704615</a>  kickstart 建 LVM的方法</p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>摘抄</tag>
      </tags>
  </entry>
  <entry>
    <title>maxscale 安装与配置</title>
    <url>/2023/08/17/maxscale/</url>
    <content><![CDATA[<p>maridb 的中间件 maxscale 一个C语言实现的智能代理(intelligent proxy), 提供读写分离,负载均衡和高可用性。它同时维护client端请求的连接以及到后端server的连接。</p>
<p>下载<br><a href="https://mariadb.com/downloads/community/maxscale/">https://mariadb.com/downloads/community/maxscale/</a></p>
<p>使用二进制压缩包安装的方式<br>下载: <a href="https://dlm.mariadb.com/3440302/MaxScale/23.08.1/centos/7/x86_64/maxscale-23.08.1.rhel.7.tar.gz">https://dlm.mariadb.com/3440302/MaxScale/23.08.1/centos/7/x86_64/maxscale-23.08.1.rhel.7.tar.gz</a></p>
<p>安装需要的库<br>libcurl<br>libaio<br>OpenSSL<br>gnutls<br>libatomic<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install libaio  libcurl OpenSSL gnutls libatomic</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /data</span><br><span class="line"></span><br><span class="line">tar -xzvf maxscale-23.08.1.rhel.7.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">ln</span> -s /data/maxscale-23.08.1.rhel.7 maxscale</span><br><span class="line"></span><br><span class="line">groupadd maxscale</span><br><span class="line">useradd -g maxscale maxscale</span><br><span class="line"></span><br><span class="line"><span class="built_in">chown</span> -R maxscale:maxscale /data/maxscale</span><br></pre></td></tr></table></figure><br>编辑配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/maxscale/etc</span><br><span class="line"><span class="built_in">cp</span> maxscale.cnf.template maxscale.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment">## 定义写实例</span></span><br><span class="line">[server1]</span><br><span class="line"><span class="built_in">type</span>=server</span><br><span class="line">address=192.168.12.5</span><br><span class="line">port=3306</span><br><span class="line">protocol=MySQLBackend</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line"><span class="built_in">type</span>=server</span><br><span class="line">address=192.168.12.6</span><br><span class="line">port=3306</span><br><span class="line">protocol=MySQLBackend</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义监控</span></span><br><span class="line">[MariaDB-Monitor]</span><br><span class="line"><span class="built_in">type</span>=monitor</span><br><span class="line">module=mariadbmon</span><br><span class="line">servers=server1,server2</span><br><span class="line">user=monitor_user</span><br><span class="line">password=monitor_pw</span><br><span class="line">monitor_interval=2s</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义只读服务</span></span><br><span class="line">[Read-Only-Service]</span><br><span class="line"><span class="built_in">type</span>=service</span><br><span class="line">router=readconnroute</span><br><span class="line">servers=server2</span><br><span class="line">user=service_user</span><br><span class="line">password=service_pw</span><br><span class="line">router_options=slave</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义读写分离服务</span></span><br><span class="line">[Read-Write-Service]</span><br><span class="line"><span class="built_in">type</span>=service</span><br><span class="line">router=readwritesplit</span><br><span class="line">servers=server1,server2</span><br><span class="line">max_slave_replication_lag=3  </span><br><span class="line">user=service_user</span><br><span class="line">password=service_pw</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义只读监听端口</span></span><br><span class="line">[Read-Only-Listener]</span><br><span class="line"><span class="built_in">type</span>=listener</span><br><span class="line">service=Read-Only-Service</span><br><span class="line">protocol=MariaDBClient</span><br><span class="line">port=4008</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义读写监听端口</span></span><br><span class="line">[Read-Write-Listener]</span><br><span class="line"><span class="built_in">type</span>=listener</span><br><span class="line">service=Read-Write-Service</span><br><span class="line">protocol=MariaDBClient</span><br><span class="line">port=4006</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在实例 server 1,sever 2 上</span></span><br><span class="line"><span class="comment">#创建监控用户</span></span><br><span class="line">CREATE USER <span class="string">&#x27;monitor_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;monitor_pw&#x27;</span>;</span><br><span class="line">GRANT REPLICATION CLIENT, FILE, SUPER, RELOAD, PROCESS, SHOW DATABASES, EVENT ON *.* TO <span class="string">&#x27;monitor_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建maxscale监视连接用户</span></span><br><span class="line">CREATE USER <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;service_pw&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.user TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.db TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.tables_priv TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.columns_priv TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.procs_priv TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.proxies_priv TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.roles_mapping TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SHOW DATABASES ON *.* TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建连接数据库的客户端用户</span></span><br><span class="line">grant all on db.* TO <span class="string">&#x27;app&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动maxscale</span></span><br><span class="line">bin/maxscale -d --basedir=.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#maxscale 部署最佳实践就跟应用部署在同一个服务器上，应用通过连localhost 或 127.0.0.1 来连接数据库</span></span><br><span class="line"><span class="comment">#也可以多台部署。前端通过nginx 等做负载均衡，统一入口</span></span><br></pre></td></tr></table></figure>
<p>maxctrl 的 相关用法<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Commands:</span><br><span class="line">  maxctrl list &lt;<span class="built_in">command</span>&gt;        List objects</span><br><span class="line">  maxctrl show &lt;<span class="built_in">command</span>&gt;        Show objects</span><br><span class="line">  maxctrl <span class="built_in">set</span> &lt;<span class="built_in">command</span>&gt;         Set object state</span><br><span class="line">  maxctrl clear &lt;<span class="built_in">command</span>&gt;       Clear object state</span><br><span class="line">  maxctrl <span class="built_in">enable</span> &lt;<span class="built_in">command</span>&gt;      Enable functionality</span><br><span class="line">  maxctrl <span class="built_in">disable</span> &lt;<span class="built_in">command</span>&gt;     Disable functionality</span><br><span class="line">  maxctrl create &lt;<span class="built_in">command</span>&gt;      Create objects</span><br><span class="line">  maxctrl destroy &lt;<span class="built_in">command</span>&gt;     Destroy objects</span><br><span class="line">  maxctrl <span class="built_in">link</span> &lt;<span class="built_in">command</span>&gt;        Link objects</span><br><span class="line">  maxctrl <span class="built_in">unlink</span> &lt;<span class="built_in">command</span>&gt;      Unlink objects</span><br><span class="line">  maxctrl start &lt;<span class="built_in">command</span>&gt;       Start objects</span><br><span class="line">  maxctrl stop &lt;<span class="built_in">command</span>&gt;        Stop objects</span><br><span class="line">  maxctrl alter &lt;<span class="built_in">command</span>&gt;       Alter objects</span><br><span class="line">  maxctrl rotate &lt;<span class="built_in">command</span>&gt;      Rotate <span class="built_in">log</span> files</span><br><span class="line">  maxctrl reload &lt;<span class="built_in">command</span>&gt;      Reload objects</span><br><span class="line">  maxctrl call &lt;<span class="built_in">command</span>&gt;        Call module commands</span><br><span class="line">  maxctrl api &lt;<span class="built_in">command</span>&gt;         Raw REST API access</span><br><span class="line">  maxctrl classify &lt;statement&gt;  Classify statement</span><br><span class="line"></span><br><span class="line">Global Options:</span><br><span class="line">  -c, --config     MaxCtrl configuration file</span><br><span class="line">                                            [string] [default: <span class="string">&quot;~/.maxctrl.cnf&quot;</span>]</span><br><span class="line">  -u, --user       Username to use                   [string] [default: <span class="string">&quot;admin&quot;</span>]</span><br><span class="line">  -p, --password   Password <span class="keyword">for</span> the user. To input the password manually, use -p</span><br><span class="line">                   <span class="string">&#x27;&#x27;</span> or --password=<span class="string">&#x27;&#x27;</span>             [string] [default: <span class="string">&quot;mariadb&quot;</span>]</span><br><span class="line">  -h, --hosts      List of MaxScale hosts. The hosts must be <span class="keyword">in</span> HOST:PORT format</span><br><span class="line">                   and each value must be separated by a comma.</span><br><span class="line">                                            [string] [default: <span class="string">&quot;127.0.0.1:8989&quot;</span>]</span><br><span class="line">  -t, --<span class="built_in">timeout</span>    Request <span class="built_in">timeout</span> <span class="keyword">in</span> plain milliseconds, e.g <span class="string">&#x27;-t 1000&#x27;</span>, or as</span><br><span class="line">                   duration with suffix [h|m|s|ms], e.g. <span class="string">&#x27;-t 10s&#x27;</span></span><br><span class="line">                                                     [string] [default: <span class="string">&quot;10000&quot;</span>]</span><br><span class="line">  -q, --quiet      Silence all output. Ignored <span class="keyword">while</span> <span class="keyword">in</span> interactive mode.</span><br><span class="line">                                                      [boolean] [default: <span class="literal">false</span>]</span><br><span class="line">      --tsv        Print tab separated output         [boolean] [default: <span class="literal">false</span>]</span><br><span class="line">      --skip-sync  Disable configuration synchronization <span class="keyword">for</span> this <span class="built_in">command</span></span><br><span class="line">                                                      [boolean] [default: <span class="literal">false</span>]</span><br><span class="line"></span><br><span class="line">HTTPS/TLS Options:</span><br><span class="line">  -s, --secure                  Enable HTTPS requests [boolean] [default: <span class="literal">false</span>]</span><br><span class="line">      --tls-key                 Path to TLS private key                 [string]</span><br><span class="line">      --tls-passphrase          Password <span class="keyword">for</span> the TLS private key        [string]</span><br><span class="line">      --tls-cert                Path to TLS public certificate          [string]</span><br><span class="line">      --tls-ca-cert             Path to TLS CA certificate              [string]</span><br><span class="line">  -n, --tls-verify-server-cert  Whether to verify server TLS certificates</span><br><span class="line">                                                       [boolean] [default: <span class="literal">true</span>]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --version  Show version number                                   [boolean]</span><br><span class="line">      --<span class="built_in">help</span>     Show <span class="built_in">help</span>                                             [boolean]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line">maxctrl list --<span class="built_in">help</span></span><br><span class="line">Commands:</span><br><span class="line">  maxctrl list servers              List servers</span><br><span class="line">  maxctrl list services             List services</span><br><span class="line">  maxctrl list listeners [service]  List listeners</span><br><span class="line">  maxctrl list monitors             List monitors</span><br><span class="line">  maxctrl list sessions             List sessions</span><br><span class="line">  maxctrl list filters              List filters</span><br><span class="line">  maxctrl list modules              List loaded modules</span><br><span class="line">  maxctrl list threads              List threads</span><br><span class="line">  maxctrl list <span class="built_in">users</span>                List created <span class="built_in">users</span></span><br><span class="line">  maxctrl list commands             List module commands</span><br><span class="line">  maxctrl list queries              List active queries from all sessions</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>中间件</tag>
        <tag>读写分离</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodb shard 集群开启分片</title>
    <url>/2023/07/19/mongoDBUseShared/</url>
    <content><![CDATA[<p>使用了mongodb 集群。如果没有对数据库。以及表开启分片。所有的库表默认只存在主节点上。分片集群也失去了意义。<br>这里介绍下如何开始数据库分片</p>
<p>1.安装mongosh<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">1. 下载mongoshell 1.0 版本</span><br><span class="line"></span><br><span class="line">2. tar -xzvf mongosh-1.10.0-linux-x64.tgz</span><br><span class="line"></span><br><span class="line">3. <span class="built_in">cd</span> mongosh-1.10.0-linux-x64/bin</span><br><span class="line"></span><br><span class="line">4. mongodb 管理控制台上添加白名单</span><br><span class="line"></span><br><span class="line">5. 登录mongoshard 集群</span><br><span class="line">./mongosh <span class="string">&quot;mongodb://s-xxxxxx.mongodb.rds.aliyuncs.com:3717,s-xxxxx.mongodb.rds.aliyuncs.com:3717/admin&quot;</span></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>2.登录集群后。先授权登录，然后切换到 config 库查看 当前shard集群的同步状态。以及查看分片集群的状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[mongos] admin&gt; db.auth(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"> &#123; ok: 1 &#125;</span><br><span class="line"> [mongos] admin&gt; use config</span><br><span class="line"> 查看当前Balancer的状态</span><br><span class="line"> sh.getBalancerState()</span><br><span class="line"> </span><br><span class="line"> 查看分片集群的状态</span><br><span class="line"> sh.status()</span><br></pre></td></tr></table></figure>
<p>3.设置同步平衡时间窗口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">设置 Balancer 窗口 窗口时间格式 时间格式为HH:MM  HH取值范围为00 - 23，MM取值范围为00 - 59</span><br><span class="line"> db.settings.updateOne(</span><br><span class="line">   &#123; _id: <span class="string">&quot;balancer&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="variable">$set</span>: &#123; activeWindow : &#123; start : <span class="string">&quot;00:00&quot;</span>, stop : <span class="string">&quot;09:00&quot;</span> &#125; &#125; &#125;,</span><br><span class="line">   &#123; upsert: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">如果需要balancer 始终运行，则设置如下</span><br><span class="line">db.settings.updateOne(&#123; _id : <span class="string">&quot;balancer&quot;</span> &#125;, &#123; <span class="variable">$unset</span> : &#123; activeWindow : <span class="literal">true</span> &#125; &#125;)  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>4.开启 Balancer 功能<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh.setBalancerState(<span class="literal">true</span>) </span><br></pre></td></tr></table></figure></p>
<p>5.如何关闭 Balancer 功能<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 执行如下脚本。确定 balaner 进程没在运行</span></span><br><span class="line"><span class="keyword">while</span>( sh.isBalancerRunning()[<span class="string">&quot;inBalancerRound&quot;</span>]) &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">          <span class="built_in">sleep</span>(1000);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## 返回值为空，表示Balancer没有处于执行任务的状态，此时可执行下一步的操作，关闭Balancer </span></span><br><span class="line"><span class="comment">## 返回值为waiting，表示Balancer正在执行块迁移，此时不能执行关闭Balancer的命令，否则可能引起数据不一致</span></span><br><span class="line"><span class="comment">## 需注意的是 在同步过程中sh.isBalancerRunning 也可能出现短暂的终止。 配合  sh.getBalancerState() 一起看比较稳妥</span></span><br><span class="line"><span class="comment">## 另一个可以观察 shard 分片上的 CPU 波动。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 确认没有同步任务时可以执行停止</span></span><br><span class="line">sh.stopBalancer()</span><br></pre></td></tr></table></figure></p>
<p>6.为数据库开启分片功能(config 库上执行)<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 数据库开启分片[config库上执行]</span></span><br><span class="line">sh.enableSharding(<span class="string">&quot;&lt;database&gt;&quot;</span>)</span><br><span class="line"><span class="comment">## 例如</span></span><br><span class="line">sh.enableSharding(<span class="string">&quot;mongodbtest&quot;</span>)</span><br></pre></td></tr></table></figure></p>
<p>7.为collection 建立分片索引(在目标库上执行)<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 命令</span></span><br><span class="line">db.&lt;collection&gt;.createIndex(&lt;keyPatterns&gt;,&lt;options&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 参数说明：</span></span><br><span class="line">    &lt;collection&gt;：集合名。</span><br><span class="line">    &lt;keyPatterns&gt;：包含用于建立索引的字段和索引类型。</span><br><span class="line">    常见的索引类型如下：</span><br><span class="line">       1：创建升序索引</span><br><span class="line">       -1：创建降序索引</span><br><span class="line">       <span class="string">&quot;hashed&quot;</span>：创建哈希索引</span><br><span class="line">    &lt;options&gt;：表示接收可选参数，详情请参见db.collection.createIndex()，本操作示例中暂未使用到该字段</span><br><span class="line"><span class="comment">## 例子</span></span><br><span class="line"><span class="comment">##创建升序索引示例，基于范围的分片</span></span><br><span class="line">db.customer.createIndex(&#123;name:1&#125;)</span><br><span class="line"><span class="comment">## 创建哈希索引示例，基于指定列的hash 分片</span></span><br><span class="line">db.customer.createIndex(&#123;name:<span class="string">&quot;hashed&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>8.开启 collection 的分片<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 命令</span></span><br><span class="line">sh.shardCollection(<span class="string">&quot;&lt;database&gt;.&lt;collection&gt;&quot;</span>,&#123; <span class="string">&quot;&lt;key&gt;&quot;</span>:&lt;value&gt; &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">##参数说明：</span></span><br><span class="line">    &lt;database&gt;：数据库名。</span><br><span class="line">    &lt;collection&gt;：集合名。</span><br><span class="line">    &lt;key&gt;：分片的键，MongoDB将根据片键的值进行数据分片。</span><br><span class="line">    &lt;value&gt;  1：表示基于范围分片，通常能很好地支持基于片键的范围查询。</span><br><span class="line">             “hashed”：表示基于哈希分片，通常能将写入均衡分布到各Shard节点中。</span><br><span class="line"></span><br><span class="line"><span class="comment">## 例子</span></span><br><span class="line"><span class="comment">## 基于范围分片的配置示例</span></span><br><span class="line">sh.shardCollection(<span class="string">&quot;mongodbtest.customer&quot;</span>,&#123;<span class="string">&quot;name&quot;</span>:1&#125;)</span><br><span class="line"><span class="comment">## 基于哈希分片的配置示例</span></span><br><span class="line">sh.shardCollection(<span class="string">&quot;mongodbtest.customer&quot;</span>,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;hashed&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>mongodb</category>
      </categories>
      <tags>
        <tag>sharding</tag>
        <tag>replica</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodb运维一些相关命令</title>
    <url>/2023/04/12/mongoMaintain/</url>
    <content><![CDATA[<p>登录数据库<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[wuiprd@WCN-GZP-WUIMDB1 ~]$ mongo</span><br><span class="line">MongoDB shell version v4.4.16</span><br><span class="line">connecting to: mongodb://127.0.0.1:3717/?compressors=disabled&amp;gssapiServiceName=mongodb</span><br><span class="line">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;df6155be-e08c-4c62-a9be-ad653471eb22&quot;) &#125;</span><br><span class="line">MongoDB server version: 4.4.16</span><br><span class="line">Mmp_wuid:PRIMARY&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line">Mmp_wuid:PRIMARY&gt; db.auth(&#x27;root&#x27;,&#x27;xxxxx&#x27;)</span><br><span class="line">1</span><br></pre></td></tr></table></figure><br>查看数据库<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; show dbs;</span><br></pre></td></tr></table></figure><br>查看从库信息<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; db.printSecondaryReplicationInfo()</span><br></pre></td></tr></table></figure><br>修改从库的权重<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; rs.conf()    #查看集群配置详情</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;_id&quot; : &quot;Mmp_wuid&quot;,</span><br><span class="line">&quot;version&quot; : 3,</span><br><span class="line">&quot;term&quot; : 16,</span><br><span class="line">&quot;protocolVersion&quot; : NumberLong(1),</span><br><span class="line">&quot;writeConcernMajorityJournalDefault&quot; : true,</span><br><span class="line">&quot;members&quot; : [</span><br><span class="line">&#123;</span><br><span class="line">&quot;_id&quot; : 0,</span><br><span class="line">&quot;host&quot; : &quot;10.82.49.101:3717&quot;,</span><br><span class="line">&quot;arbiterOnly&quot; : false,</span><br><span class="line">&quot;buildIndexes&quot; : true,</span><br><span class="line">&quot;hidden&quot; : false,</span><br><span class="line">&quot;priority&quot; : 2,</span><br><span class="line">&quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line">&quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">&quot;votes&quot; : 1</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">&quot;_id&quot; : 1,</span><br><span class="line">&quot;host&quot; : &quot;10.82.49.102:3717&quot;,</span><br><span class="line">&quot;arbiterOnly&quot; : false,</span><br><span class="line">&quot;buildIndexes&quot; : true,</span><br><span class="line">&quot;hidden&quot; : false,</span><br><span class="line">&quot;priority&quot; : 1,</span><br><span class="line">&quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line">&quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">&quot;votes&quot; : 1</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">&quot;_id&quot; : 2,</span><br><span class="line">&quot;host&quot; : &quot;10.82.49.103:3717&quot;,</span><br><span class="line">&quot;arbiterOnly&quot; : true,</span><br><span class="line">&quot;buildIndexes&quot; : true,</span><br><span class="line">&quot;hidden&quot; : false,</span><br><span class="line">&quot;priority&quot; : 0,</span><br><span class="line">&quot;tags&quot; : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line">&quot;slaveDelay&quot; : NumberLong(0),</span><br><span class="line">&quot;votes&quot; : 1</span><br><span class="line">&#125;</span><br><span class="line">],</span><br><span class="line">&quot;settings&quot; : &#123;</span><br><span class="line">&quot;chainingAllowed&quot; : true,</span><br><span class="line">&quot;heartbeatIntervalMillis&quot; : 2000,</span><br><span class="line">&quot;heartbeatTimeoutSecs&quot; : 10,</span><br><span class="line">&quot;electionTimeoutMillis&quot; : 10000,</span><br><span class="line">&quot;catchUpTimeoutMillis&quot; : -1,</span><br><span class="line">&quot;catchUpTakeoverDelayMillis&quot; : 30000,</span><br><span class="line">&quot;getLastErrorModes&quot; : &#123;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line">&quot;getLastErrorDefaults&quot; : &#123;</span><br><span class="line">&quot;w&quot; : 1,</span><br><span class="line">&quot;wtimeout&quot; : 0</span><br><span class="line">&#125;,</span><br><span class="line">&quot;replicaSetId&quot; : ObjectId(&quot;63082f54832262d25063ec05&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>在维护过程中，可能需要重启主库，但又不想让重启主库时发生切换。这个时候我们需要修改slave 的优先级。让它检测到主库重启也不切换。<br>在配置中可以看到从库 对应members列表中_id=1 的配置，其priority = 1，我们需要改为0，操作如下<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; cfg = rs.conf()     #导入配置</span><br><span class="line"></span><br><span class="line">Mmp_wuid:PRIMARY&gt; cfg.members[1].priority=0    #修改优先级</span><br><span class="line"></span><br><span class="line">Mmp_wuid:PRIMARY&gt; rs.reconfig(cfg)    #重新配置</span><br></pre></td></tr></table></figure><br>查看monogdb 缓存cache_size 大小<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; db.serverStatus().wiredTiger.cache[&#x27;maximum bytes configured&#x27;]/1024/1024/1024</span><br><span class="line">20</span><br></pre></td></tr></table></figure><br>修改cache_size 大小<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; db.adminCommand( &#123; &quot;setParameter&quot;: 1, &quot;wiredTigerEngineRuntimeConfig&quot;: &quot;cache_size=20G&quot;&#125;)</span><br></pre></td></tr></table></figure></p>
<p>查看当前连接数信息<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; db.serverStatus().connections;</span><br><span class="line">&#123;</span><br><span class="line">&quot;current&quot; : 19,</span><br><span class="line">&quot;available&quot; : 51181,</span><br><span class="line">&quot;totalCreated&quot; : 5787,</span><br><span class="line">&quot;active&quot; : 4,</span><br><span class="line">&quot;exhaustIsMaster&quot; : 1,</span><br><span class="line">&quot;exhaustHello&quot; : 1,</span><br><span class="line">&quot;awaitingTopologyChanges&quot; : 35</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看连接详情<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; db.currentOp(&#123;&quot;op&quot; : &quot;insert&quot;,&quot;active&quot; : true&#125;)  #查询op 操作是insert ，并且状态是活跃的连接详情</span><br><span class="line"></span><br><span class="line">Mmp_wuid:PRIMARY&gt; db.currentOp(&#123;&quot;secs_running&quot; : &#123;&quot;$gt&quot;:5&#125;&#125;)    #查询运行时间超过5秒的连接详情</span><br><span class="line"></span><br><span class="line">Mmp_wuid:PRIMARY&gt;  db.currentOp(&#123;&quot;secs_running&quot; : &#123;&quot;$gt&quot;:5&#125;&#125;).inprog.forEach(function(item)&#123;db.killOp(item.opid)&#125;) #查询超过5秒的连接并杀掉</span><br></pre></td></tr></table></figure></p>
<p>获取当前数据库操作统计<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mgset-54903079 [direct: primary] wuid&gt; db.serverStatus().opcounters</span><br><span class="line">&#123;</span><br><span class="line">  insert: Long(&quot;1638687567&quot;),</span><br><span class="line">  query: Long(&quot;2145547252&quot;),</span><br><span class="line">  update: Long(&quot;2074042631&quot;),</span><br><span class="line">  delete: Long(&quot;778119&quot;),</span><br><span class="line">  getmore: Long(&quot;3597908695&quot;),</span><br><span class="line">  command: Long(&quot;4173516698&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看是否具有全表扫描的操作<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[mongos] wuid&gt; db.currentOp(&#123;planSummary: &#x27;COLLSCAN&#x27;&#125;)</span><br><span class="line">&#123;</span><br><span class="line">  inprog: [</span><br><span class="line">    &#123;</span><br><span class="line">      ...</span><br><span class="line">      active: true,</span><br><span class="line">      currentOpTime: &#x27;2023-06-27T10:50:10.861+0800&#x27;,</span><br><span class="line">      effectiveUsers: [ &#123; user: &#x27;__system&#x27;, db: &#x27;local&#x27; &#125; ],</span><br><span class="line">      opid: &#x27;d-wz9efd20b71ae404:210659684&#x27;,</span><br><span class="line">      secs_running: Long(&quot;0&quot;),</span><br><span class="line">      microsecs_running: Long(&quot;64337&quot;),</span><br><span class="line">      op: &#x27;getmore&#x27;,</span><br><span class="line">      ns: &#x27;local.oplog.rs&#x27;,</span><br><span class="line">      command:&#123;...&#125;</span><br><span class="line">      planSummary: &#x27;COLLSCAN&#x27;,</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="启动mongodb"><a href="#启动mongodb" class="headerlink" title="启动mongodb"></a>启动mongodb</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo systemctl start mongod.service</span><br></pre></td></tr></table></figure>
<h1 id="停用mongodb"><a href="#停用mongodb" class="headerlink" title="停用mongodb"></a>停用mongodb</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo systemctl stop mongod.service</span><br></pre></td></tr></table></figure>
<h1 id="查看启动结果"><a href="#查看启动结果" class="headerlink" title="查看启动结果"></a>查看启动结果</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo systemctl status mongod.service</span><br></pre></td></tr></table></figure>
<p>启动过程中因为mongodb 处理回滚时间过长。导致启动到一半就被杀死终止<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:09:46.546+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;COMMAND&quot;, &quot;id&quot;:51803, &quot;ctx&quot;:&quot;conn4539024&quot;,&quot;msg&quot;:&quot;Slow query&quot;,&quot;attr&quot;:&#123;&quot;type&quot;:&quot;command&quot;,&quot;ns&quot;:&quot;wuid.tmp_repeat_unionId&quot;,&quot;command&quot;:&#123;&quot;insert&quot;:&quot;tmp_repeat_unionId&quot;,&quot;ordered&quot;:false,&quot;bypassDocumentValidation&quot;:true,&quot;$db&quot;:&quot;wuid&quot;&#125;,&quot;ninserted&quot;:128,&quot;keysInserted&quot;:128,&quot;numYields&quot;:0,&quot;reslen&quot;:245,&quot;locks&quot;:&#123;&quot;ParallelBatchWriterMode&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;r&quot;:1&#125;&#125;,&quot;FeatureCompatibilityVersion&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;ReplicationStateTransition&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Global&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Database&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Collection&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Mutex&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;r&quot;:1&#125;&#125;&#125;,&quot;flowControl&quot;:&#123;&quot;acquireCount&quot;:1,&quot;acquireWaitCount&quot;:1,&quot;timeAcquiringMicros&quot;:985762&#125;,&quot;storage&quot;:&#123;&#125;,&quot;protocol&quot;:&quot;op_query&quot;,&quot;durationMillis&quot;:988&#125;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:09:46.546+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;COMMAND&quot;, &quot;id&quot;:51803, &quot;ctx&quot;:&quot;conn4539022&quot;,&quot;msg&quot;:&quot;Slow query&quot;,&quot;attr&quot;:&#123;&quot;type&quot;:&quot;command&quot;,&quot;ns&quot;:&quot;wuid.tmp_to_id_unionId&quot;,&quot;command&quot;:&#123;&quot;insert&quot;:&quot;tmp_to_id_unionId&quot;,&quot;ordered&quot;:false,&quot;bypassDocumentValidation&quot;:true,&quot;$db&quot;:&quot;wuid&quot;&#125;,&quot;ninserted&quot;:128,&quot;keysInserted&quot;:128,&quot;numYields&quot;:0,&quot;reslen&quot;:245,&quot;locks&quot;:&#123;&quot;ParallelBatchWriterMode&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;r&quot;:1&#125;&#125;,&quot;FeatureCompatibilityVersion&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;ReplicationStateTransition&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Global&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Database&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Collection&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Mutex&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;r&quot;:1&#125;&#125;&#125;,&quot;flowControl&quot;:&#123;&quot;acquireCount&quot;:1,&quot;acquireWaitCount&quot;:1,&quot;timeAcquiringMicros&quot;:971338&#125;,&quot;storage&quot;:&#123;&#125;,&quot;protocol&quot;:&quot;op_query&quot;,&quot;durationMillis&quot;:974&#125;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:09:47.488+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;COMMAND&quot;, &quot;id&quot;:20482, &quot;ctx&quot;:&quot;conn4538701&quot;,&quot;msg&quot;:&quot;Going to kill op&quot;,&quot;attr&quot;:&#123;&quot;opId&quot;:1071745126&#125;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:09:47.488+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;COMMAND&quot;, &quot;id&quot;:20884, &quot;ctx&quot;:&quot;conn4538701&quot;,&quot;msg&quot;:&quot;Killed operation&quot;,&quot;attr&quot;:&#123;&quot;opId&quot;:1071745126&#125;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:09:47.558+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;COMMAND&quot;, &quot;id&quot;:51803, &quot;ctx&quot;:&quot;conn4539024&quot;,&quot;msg&quot;:&quot;Slow query&quot;,&quot;attr&quot;:&#123;&quot;type&quot;:&quot;command&quot;,&quot;ns&quot;:&quot;wuid.tmp_wuid_test&quot;,&quot;command&quot;:&#123;&quot;insert&quot;:&quot;tmp_wuid_test&quot;,&quot;ordered&quot;:false,&quot;bypassDocumentValidation&quot;:true,&quot;$db&quot;:&quot;wuid&quot;&#125;,&quot;ninserted&quot;:128,&quot;keysInserted&quot;:128,&quot;numYields&quot;:0,&quot;reslen&quot;:245,&quot;locks&quot;:&#123;&quot;ParallelBatchWriterMode&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;r&quot;:1&#125;&#125;,&quot;FeatureCompatibilityVersion&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;ReplicationStateTransition&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Global&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Database&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Collection&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Mutex&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;r&quot;:1&#125;&#125;&#125;,&quot;flowControl&quot;:&#123;&quot;acquireCount&quot;:1,&quot;acquireWaitCount&quot;:1,&quot;timeAcquiringMicros&quot;:986487&#125;,&quot;storage&quot;:&#123;&#125;,&quot;protocol&quot;:&quot;op_query&quot;,&quot;durationMillis&quot;:989&#125;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:09:47.568+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;COMMAND&quot;, &quot;id&quot;:51803, &quot;ctx&quot;:&quot;conn4539022&quot;,&quot;msg&quot;:&quot;Slow query&quot;,&quot;attr&quot;:&#123;&quot;type&quot;:&quot;command&quot;,&quot;ns&quot;:&quot;wuid.tmp_repeat_unionId&quot;,&quot;command&quot;:&#123;&quot;insert&quot;:&quot;tmp_repeat_unionId&quot;,&quot;ordered&quot;:false,&quot;bypassDocumentValidation&quot;:true,&quot;$db&quot;:&quot;wuid&quot;&#125;,&quot;ninserted&quot;:128,&quot;keysInserted&quot;:128,&quot;numYields&quot;:0,&quot;reslen&quot;:245,&quot;locks&quot;:&#123;&quot;ParallelBatchWriterMode&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;r&quot;:1&#125;&#125;,&quot;FeatureCompatibilityVersion&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;ReplicationStateTransition&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Global&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Database&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Collection&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;w&quot;:1&#125;&#125;,&quot;Mutex&quot;:&#123;&quot;acquireCount&quot;:&#123;&quot;r&quot;:1&#125;&#125;&#125;,&quot;flowControl&quot;:&#123;&quot;acquireCount&quot;:1,&quot;acquireWaitCount&quot;:1,&quot;timeAcquiringMicros&quot;:1008708&#125;,&quot;storage&quot;:&#123;&#125;,&quot;protocol&quot;:&quot;op_query&quot;,&quot;durationMillis&quot;:1011&#125;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:09:47.760+08:00&quot;&#125;,&quot;s&quot;:&quot;W&quot;, &quot;c&quot;:&quot;COMMAND&quot;, &quot;id&quot;:20525, &quot;ctx&quot;:&quot;conn4538447&quot;,&quot;msg&quot;:&quot;Failed to gather storage statistics for slow operation&quot;,&quot;attr&quot;:&#123;&quot;opId&quot;:1071745126,&quot;error&quot;:&quot;lock acquire timeout&quot;&#125;&#125;</span><br><span class="line">/Kill</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;SHARDING&quot;, &quot;id&quot;:4784902, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down the WaitForMajorityService&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;NETWORK&quot;, &quot;id&quot;:20562, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutdown: going to close listening sockets&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;NETWORK&quot;, &quot;id&quot;:4784905, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down the global connection pool&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;STORAGE&quot;, &quot;id&quot;:4784906, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down the FlowControlTicketholder&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;-&quot;, &quot;id&quot;:20520, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Stopping further Flow Control ticket acquisitions.&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;REPL&quot;, &quot;id&quot;:4784907, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down the replica set node executor&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;NETWORK&quot;, &quot;id&quot;:4784918, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down the ReplicaSetMonitor&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;SHARDING&quot;, &quot;id&quot;:4784921, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down the MigrationUtilExecutor&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;CONTROL&quot;, &quot;id&quot;:4784925, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down free monitoring&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;STORAGE&quot;, &quot;id&quot;:4784927, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down the HealthLog&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;STORAGE&quot;, &quot;id&quot;:4784929, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Acquiring the global lock for shutdown&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;-&quot;, &quot;id&quot;:4784931, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Dropping the scope cache for shutdown&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;FTDC&quot;, &quot;id&quot;:4784926, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down full-time data capture&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;CONTROL&quot;, &quot;id&quot;:20565, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Now exiting&quot;&#125;</span><br><span class="line">&#123;&quot;t&quot;:&#123;&quot;$date&quot;:&quot;2023-04-11T17:48:00.573+08:00&quot;&#125;,&quot;s&quot;:&quot;I&quot;, &quot;c&quot;:&quot;CONTROL&quot;, &quot;id&quot;:23138, &quot;ctx&quot;:&quot;SignalHandler&quot;,&quot;msg&quot;:&quot;Shutting down&quot;,&quot;attr&quot;:&#123;&quot;exitCode&quot;:0&#125;&#125;</span><br></pre></td></tr></table></figure><br>这是由于 /usr/lib/systemd/system/mongod.service 中采用了 Type=forking<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[Service]</span><br><span class="line">User=mongod</span><br><span class="line">Group=mongod</span><br><span class="line">Environment=&quot;OPTIONS=-f /etc/mongod.conf&quot;</span><br><span class="line">EnvironmentFile=-/etc/sysconfig/mongod</span><br><span class="line">ExecStart=/usr/bin/mongod $OPTIONS</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ExecStartPre=/usr/bin/mkdir -p /app/mongodb</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ExecStartPre=/usr/bin/chown -R mongod:mongod /app/mongodb</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ExecStartPre=/usr/bin/chmod -R 0755 /app/mongodb</span></span><br><span class="line">PermissionsStartOnly=true</span><br><span class="line">PIDFile=/app/mongodb/data/mongod.pid</span><br><span class="line">Type=forking</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">file size</span></span><br><span class="line">LimitFSIZE=infinity</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cpu time</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><br>在等待forking 子进程超时时杀掉了主进程。而因为实例启动时需要大量回滚恢复操作。这里将Type=forking 注释掉，然后重启。就正常了<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#Type=forking</span><br></pre></td></tr></table></figure></p>
<p>从库不能读，在主库中设置<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; db.getMongo().setSecondaryOk()</span><br></pre></td></tr></table></figure></p>
<p>查看集群状态<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Mmp_wuid:PRIMARY&gt; rs.status()</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>mongodb</category>
      </categories>
      <tags>
        <tag>replica set</tag>
      </tags>
  </entry>
  <entry>
    <title>mongodb 4.2 sharding 建删索引引发的一次故障</title>
    <url>/2023/07/03/mongoShardFault1/</url>
    <content><![CDATA[<p>由于以前开发在使用时并没有注意到sharding 分片的使用。导致表并未做分片。所有数据都压在主节点上。造成集群中一个分片<br>空间使用率接近90%,而另一个分片使用率0%。需要对整个库所有的表都开启分片处理。今天对其中一个表进行分片键索引的添加。<br>同时开发那边递交几个索引。说是应用上使用不到的，可以删掉，腾出些空间。于是开始操作，先建索引。然后再删掉无用索引。</p>
<p>建hash 索引(50分钟后。索引建立完成)<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.wuid_xxxx_record.createIndex(&#123;&quot;wuid&quot;:&quot;hashed&quot;&#125;)</span><br></pre></td></tr></table></figure></p>
<p>删除索引(索引建完后，开始执行清除无用索引)<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db.wuid.dropIndex(&quot;platform_type_1&quot;) </span><br><span class="line">db.wuid_xxxx_record.dropIndex(&quot;platform_type_1&quot;)</span><br><span class="line">db.wuid_xxxx_request.dropIndex(&quot;platform_type_1&quot;)</span><br><span class="line">db.wuid_xxx.dropIndex(&quot;platform_type_1&quot;)</span><br></pre></td></tr></table></figure><br>过了一分钟后。也就是在11:47分,突然应用接口开始报超时。数据监控的读写队列开始飙升。数据库响应非常慢。查看shard分片监控:</p>
<h4 id="主库cpu使用率"><a href="#主库cpu使用率" class="headerlink" title="主库cpu使用率"></a>主库cpu使用率</h4><p><img src="images/pcpu.png" alt="pcpu"></p>
<h4 id="主库OpCounter"><a href="#主库OpCounter" class="headerlink" title="主库OpCounter"></a>主库OpCounter</h4><p><img src="images/pOp.png" alt="pOp"></p>
<h4 id="主库读写队列"><a href="#主库读写队列" class="headerlink" title="主库读写队列"></a>主库读写队列</h4><p><img src="images/pwr.png" alt="pwr"><br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ob.currentOp()  ##查出来有2000个连接</span><br></pre></td></tr></table></figure><br>丈二和尚摸不着头脑 T.T。执行索引清除不会锁表。不应该会导致大量语句堵塞。于是赶紧开单问了阿里童靴。<br>经过阿里童靴一番查看之后。说是从库写多CPU打满,从库复制落后主库10秒后引发主库限流。</p>
<h4 id="从库影响主库？"><a href="#从库影响主库？" class="headerlink" title="从库影响主库？"></a>从库影响主库？</h4><p>查看分片从库节点监控</p>
<h4 id="从库cpu使用率以及Opcounter"><a href="#从库cpu使用率以及Opcounter" class="headerlink" title="从库cpu使用率以及Opcounter"></a>从库cpu使用率以及Opcounter</h4><p><img src="images/sOp.png" alt="sOp"></p>
<h4 id="从库读写队列"><a href="#从库读写队列" class="headerlink" title="从库读写队列"></a>从库读写队列</h4><p><img src="images/swr.png" alt="swr"></p>
<p>从库写多。但是当时主库的currentOp 并没有特别的增加。而且主库都没事。为啥从库会在那个点突然就飚到100%使用率？<br>请阿里的同学再细查下从库当时从库的操作。后面给出的结论是。主库上执行创建索引的操作在从库回放，开始build index,<br>执行一段时间之后。刚好又接收到主库发来的drop Index 。这时 wuid_xxxx_record 同时执行 create index 和 drop index<br>导致从库的CPU 飙高到100%。 从库响应慢了，导致触发架构中的分片主从节点数据同步保护机制(默认从库落后主库10s)。<br>引发了对主库操作的限流，从而导致到主库的请求全部被堵塞在队列中。导致应用的请求全部超时。</p>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>以后的操作要同时注意shard 分片的状态。同时有删索引建索引操作的。最好先执行删索引再执行建索引。这样避免有相同表出现<br>上述情况。</p>
]]></content>
      <categories>
        <category>mongodb</category>
      </categories>
      <tags>
        <tag>sharding</tag>
        <tag>replica</tag>
      </tags>
  </entry>
  <entry>
    <title>单机版将mongodb单节点升级为副本集群</title>
    <url>/2023/09/01/mongoSingle-Replicaset/</url>
    <content><![CDATA[<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>1.修改配置文件 /etc/mongod.conf,添加<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">replication:</span><br><span class="line">  oplogSizeMB: 2048</span><br><span class="line">  replSetName: mmp_wuid</span><br><span class="line">  </span><br><span class="line">security:</span><br><span class="line">  keyFile: /data/mongodb/etc/mongo.keyfile </span><br><span class="line">  authorization: &quot;enabled&quot;</span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">2.生成keyFile ,replica 开启security 需要设置keyFile</span><br><span class="line">```bash</span><br><span class="line">mkdir -p /data/mongodb/etc</span><br><span class="line">openssl rand -base64 753 &gt; /data/mongodb/etc/mongo.keyfile</span><br><span class="line">chmod 600 /app/mongodb/etc/mongo.keyfile</span><br></pre></td></tr></table></figure></p>
<h2 id="停止monogdb-服务"><a href="#停止monogdb-服务" class="headerlink" title="停止monogdb 服务"></a>停止monogdb 服务</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo   </span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.auth(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;xxxx&#x27;</span>) </span><br><span class="line">&gt;db.shutdownServer()</span><br><span class="line"><span class="comment">## 重启mongodb 服务</span></span><br><span class="line">systemctl start mongodb.service</span><br></pre></td></tr></table></figure>
<h2 id="配置复制集"><a href="#配置复制集" class="headerlink" title="配置复制集"></a>配置复制集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mongo</span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.auth(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">&gt;config = &#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;mmp_wuid&quot;</span>,members : [&#123;_id:0, host:<span class="string">&quot;192.168.30.207:27017&quot;</span>&#125;]&#125;</span><br><span class="line">&gt;rs.initiate(config)</span><br></pre></td></tr></table></figure>
<h2 id="搭建从节点"><a href="#搭建从节点" class="headerlink" title="搭建从节点"></a>搭建从节点</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkidr -p /app/mongodb_rep/&#123;<span class="built_in">log</span>,mongodb,etc&#125;</span><br><span class="line"><span class="built_in">cp</span> /etc/mongod.conf /etc/mongo_rep.conf</span><br><span class="line"><span class="comment">##修改 logfile 以及dbpath 指向从库实际路径,以及端口</span></span><br><span class="line"><span class="built_in">cp</span> /data/mongodb/etc/mongo.keyfile /app/mongodb_rep/etc/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> /lib/systemd/system/mongodb.service /lib/systemd/system/mongodb_rep.service</span><br><span class="line">vi mongodb_rep.service </span><br><span class="line"><span class="comment">##修改指向rep 配置文件的路径</span></span><br><span class="line"></span><br><span class="line">systemclt daemon-reaload</span><br><span class="line">systemctl start mongodb_rep.service</span><br></pre></td></tr></table></figure>
<h2 id="主节点上添加-replica-节点"><a href="#主节点上添加-replica-节点" class="headerlink" title="主节点上添加 replica 节点"></a>主节点上添加 replica 节点</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt; rs.add(&quot;192.168.30.207:27018&quot;)</span><br><span class="line">&gt; rs.status()</span><br></pre></td></tr></table></figure>
<p>可以看到节点2 处于 startup2 状态。为同步数据</p>
<h1 id="到此。单节点升级为replica-集群完成"><a href="#到此。单节点升级为replica-集群完成" class="headerlink" title="到此。单节点升级为replica 集群完成"></a>到此。单节点升级为replica 集群完成</h1><h2 id="错误与解决"><a href="#错误与解决" class="headerlink" title="错误与解决"></a>错误与解决</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">在副本集中启用认证后需要配置security.keyFile，否则会报如下错误</span><br><span class="line">1. BadValue: security.keyFile is required when authorization is enabled with replica sets</span><br><span class="line">try &#x27;/usr/local/mongodb/bin/mongod --help&#x27; for more information]</span><br><span class="line"></span><br><span class="line">在节点1上</span><br><span class="line">openssl rand -base64 753 &gt; /data/mongodb/etc/mongo.keyfile</span><br><span class="line">chmod 600 /app/mongodb/etc/mongo.keyfile</span><br><span class="line">拷贝到节点2</span><br><span class="line">scp mongo.keyfile mongodb2:`pwd`</span><br><span class="line"></span><br><span class="line">2. permissions on /app/mongodb_rep/etc/mongo.keyfile are too open</span><br><span class="line"></span><br><span class="line">mongo.keyfile 权限过大</span><br><span class="line">chmod 600 /app/mongodb_rep/etc/mongo.keyfile</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>mongodb</category>
      </categories>
      <tags>
        <tag>replica</tag>
      </tags>
  </entry>
  <entry>
    <title>为yapi搭建mongodb 存储单机版</title>
    <url>/2022/12/14/mongodbSingle/</url>
    <content><![CDATA[<h3 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h3><p>测试组有一套yapi 服务。希望迁到线上来。后端数据库用到mongodb,考虑到资源问题，<br>以及数据可丢失一天的容忍度。搭建一个mongodb 单机版</p>
<h3 id="2-下载安装包"><a href="#2-下载安装包" class="headerlink" title="2. 下载安装包"></a>2. 下载安装包</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 1. 下载mongodb 社区版安装包，采用 mongodb-5.0.14 版本， centos 7  tgz 文件包</span><br><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-5.0.14.tgz</span><br><span class="line"></span><br><span class="line"># 2. 下载工具包,在mongodb 4.4 开始，很多mongodb 数据库工具 独立成 mongotool，初始版本由 100.0.0 开始</span><br><span class="line"></span><br><span class="line">wget https://fastdl.mongodb.org/tools/db/mongodb-database-tools-rhel70-x86_64-100.6.1.tgz</span><br><span class="line"></span><br><span class="line"># 3. 下载mongo shell: mongosh 替代 mongo</span><br><span class="line"></span><br><span class="line">wget https://downloads.mongodb.com/compass/mongosh-1.6.1-linux-x64.tgz</span><br></pre></td></tr></table></figure>
<h3 id="3-安装相关依赖包"><a href="#3-安装相关依赖包" class="headerlink" title="3. 安装相关依赖包"></a>3. 安装相关依赖包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install libcurl openssl xz-libs</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="4-安装"><a href="#4-安装" class="headerlink" title="4. 安装"></a>4. 安装</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#解压安装软件</span></span><br><span class="line"><span class="built_in">cd</span> /data</span><br><span class="line">tar -xzvf mongodb-linux-x86_64-rhel70-5.0.14.tgz</span><br><span class="line">tar -xzvf mongodb-database-tools-rhel70-x86_64-100.6.1.tgz</span><br><span class="line">tar -xzvf mongosh-1.6.1-linux-x64.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment">#将工具包的bin包含文件以及 mongosh 的bin 包含文件移到mongodb server 的安装目录下</span></span><br><span class="line"><span class="built_in">mv</span> mongodb-database-tools-rhel70-x86_64-100.6.1/bin/* mongodb-linux-x86_64-rhel70-5.0.14/bin</span><br><span class="line"><span class="built_in">mv</span> mongosh-1.6.1-linux-x64/bin/mongosh mongodb-linux-x86_64-rhel70-5.0.14/bin</span><br><span class="line"><span class="built_in">mv</span> mongosh-1.6.1-linux-x64/bin/mongosh_crypt_v1.so /usr/local/lib</span><br><span class="line"></span><br><span class="line"><span class="comment">#建立软链以及相关目录和授权</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">ln</span> -s /data/mongodb-linux-x86_64-rhel70-5.0.14 mongodb</span><br><span class="line"><span class="built_in">mkdir</span> -p /usr/local/mongodb/&#123;logs,mongodata&#125;</span><br><span class="line"><span class="built_in">chown</span> -R mongod:mongod /data/mongodb-linux-x86_64-rhel70-5.0.14</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置环境变量</span></span><br><span class="line">vi /etc/profile</span><br><span class="line">...</span><br><span class="line">pathmunge /usr/local/mongodb/bin after</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加配置文件,指定日志。存储。以及网络，安全等信息</span></span><br><span class="line">vi /etc/mongod.conf</span><br><span class="line">systemLog:</span><br><span class="line">   destination: file</span><br><span class="line">   path: <span class="string">&quot;/usr/local/mongodb/logs/mongod.log&quot;</span></span><br><span class="line">   logAppend: <span class="literal">true</span></span><br><span class="line">   logRotate: reopen</span><br><span class="line">storage:</span><br><span class="line">   dbPath: <span class="string">&quot;/usr/local/mongodb/mongodata&quot;</span></span><br><span class="line">   journal:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">   directoryPerDB: <span class="literal">true</span></span><br><span class="line">   engine: wiredTiger</span><br><span class="line">   wiredTiger:</span><br><span class="line">      engineConfig:</span><br><span class="line">         cacheSizeGB: 5</span><br><span class="line">         journalCompressor: snappy</span><br><span class="line">         directoryForIndexes: <span class="literal">false</span></span><br><span class="line">      collectionConfig:</span><br><span class="line">         blockCompressor: snappy</span><br><span class="line">      indexConfig:</span><br><span class="line">         prefixCompression: <span class="literal">true</span></span><br><span class="line">net:</span><br><span class="line">   port: 27017</span><br><span class="line">   bindIpAll: <span class="literal">true</span></span><br><span class="line">   maxIncomingConnections: 65536</span><br><span class="line">security:</span><br><span class="line">   authorization: enabled</span><br><span class="line"></span><br><span class="line"><span class="built_in">chown</span> mongod:mongod /etc/mongod.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#切换到 mongod 用户</span></span><br><span class="line">su - mongod</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建启动脚本以及关闭脚本</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/mongodb/bin</span><br><span class="line">vi start_mongod.sh</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">/usr/local/mongodb/bin/mongod -f /etc/mongod.conf --fork</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x start_mongod.sh</span><br><span class="line"></span><br><span class="line">vi stop_mongod.sh</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">/usr/local/mongodb/bin/mongod --shutdown -f /etc/mongod.conf </span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> +x stop_mongod.sh</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="5-启动"><a href="#5-启动" class="headerlink" title="5. 启动"></a>5. 启动</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">start_mongod.sh</span><br><span class="line">ps -ef |grep mongod</span><br><span class="line">mongod    90789      1  0 12月08 ?       00:34:45 /usr/local/mongodb/bin/mongod -f /etc/mongod.conf --fork</span><br></pre></td></tr></table></figure>
<h3 id="6-创建账号初始化"><a href="#6-创建账号初始化" class="headerlink" title="6. 创建账号初始化"></a>6. 创建账号初始化</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mongosh</span><br><span class="line"><span class="comment">## 创建超级用户</span></span><br><span class="line"><span class="built_in">test</span> &gt; use admin</span><br><span class="line">admin &gt; db.createUser(&#123;</span><br><span class="line">...       user: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">...       <span class="built_in">pwd</span>: <span class="string">&#x27;xxxxxx&#x27;</span>,</span><br><span class="line">...       roles: [ &#123; role: <span class="string">&quot;root&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125; ]</span><br><span class="line">...       &#125;)</span><br><span class="line"><span class="comment">## 授权超级用户登录</span></span><br><span class="line">admin &gt; db.auth(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;xxxxxx&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#新建yapi 库并创建普通用户</span></span><br><span class="line">admin &gt; use yapi</span><br><span class="line">yapi &gt; db.createUser(&#123;</span><br><span class="line">...    user: <span class="string">&#x27;yapi&#x27;</span>,</span><br><span class="line">...    <span class="built_in">pwd</span>: <span class="string">&#x27;xxxxxxxx&#x27;</span>,</span><br><span class="line">...    roles: [ &#123; role: <span class="string">&quot;readWrite&quot;</span>, db: <span class="string">&quot;yapi&quot;</span> &#125; ]</span><br><span class="line">... &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="7-数据迁移"><a href="#7-数据迁移" class="headerlink" title="7. 数据迁移"></a>7. 数据迁移</h3><p>因为测试用的是4+ 版本，线上用的是5+ 版本，不能用monogdump,只能用 export import<br>的方式来迁移</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 测试环境导出</span></span><br><span class="line"><span class="built_in">cd</span> /data</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> yapiexport</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c adv_mock_case -o ./yapiexport/adv_mock_case.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c avatar -o ./yapiexport/avatar.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c follow -o ./yapiexport/follow.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c group -o ./yapiexport/group.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c identitycounters -o ./yapiexport/identitycounters.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c interface -o ./yapiexport/interface.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c interface_auto_sync -o ./yapiexport/interface_auto_sync.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c interface_case -o ./yapiexport/interface_case.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c interface_cat -o ./yapiexport/interface_cat.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c interface_col -o ./yapiexport/interface_col.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c <span class="built_in">log</span> -o ./yapiexport/log.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c project -o ./yapiexport/project.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c statis_mock -o ./yapiexport/statis_mock.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c storage -o ./yapiexport/storage.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c token -o ./yapiexport/token.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c user -o ./yapiexport/user.data</span><br><span class="line"></span><br><span class="line">PRG/mongodb/bin/mongoexport -d yapi -c wiki -o ./yapiexport/wiki.data</span><br><span class="line"></span><br><span class="line">tar -czvf yapiexport.tar.gz yapiexport</span><br><span class="line"></span><br><span class="line"><span class="comment">## 线上环境导入</span></span><br><span class="line">tar -xzvf yapiexport.tar.gz</span><br><span class="line"><span class="built_in">cd</span> yapiexport</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> `<span class="built_in">ls</span> *.data`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$f</span></span><br><span class="line">    mongoimport --authenticationDatabase=<span class="string">&quot;yapi&quot;</span> -u <span class="string">&quot;yapi&quot;</span> -p <span class="string">&quot;xxxxxx&quot;</span> -d <span class="string">&quot;yapi&quot;</span> -c <span class="variable">$&#123;f%%.data&#125;</span> <span class="variable">$f</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h3 id="8-创建备份脚本"><a href="#8-创建备份脚本" class="headerlink" title="8. 创建备份脚本"></a>8. 创建备份脚本</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建备份目录</span></span><br><span class="line"><span class="built_in">mkdir</span> /data/MONGODB_BACKUP</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建备份脚本</span></span><br><span class="line">vi /usr/local/mongodb/bin/mongobackup.sh</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">DT=`<span class="built_in">date</span> +<span class="string">&#x27;%Y%m%d&#x27;</span>`</span><br><span class="line"><span class="built_in">cd</span> /data/MONGODB_BACKUP</span><br><span class="line">backupset=<span class="string">&quot;yapi&quot;</span>_<span class="variable">$&#123;DT&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start backup: backupdate <span class="variable">$&#123;backupset&#125;</span>&quot;</span></span><br><span class="line"><span class="comment">## 使用mongodump 导出并压缩</span></span><br><span class="line">/usr/local/mongodb/bin/mongodump --db=<span class="string">&quot;yapi&quot;</span> -u <span class="string">&quot;yapi&quot;</span> -p <span class="string">&quot;xxxxxx&quot;</span>  --gzip --archive=<span class="variable">$backupset</span>.gz</span><br><span class="line"></span><br><span class="line"><span class="comment">## 备份完成后同步传到异地存储</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;mongodump sucessful ! now send to remote&quot;</span></span><br><span class="line">     rsync -av <span class="variable">$backupset</span>.gz mongod@192.168.11.244:/data/MONGODB_BACKUP</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;finsh backup&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;mongodump failed!!&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##clean backup，keep backup for 30 day</span></span><br><span class="line">find /data/MONGODB_BACKUP -name <span class="string">&quot;yapi_*.gz&quot;</span> -mtime +30 |xargs <span class="built_in">rm</span> -f</span><br><span class="line"></span><br><span class="line"><span class="comment">#end of script</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权可执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> +x mongobackup.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">## 挂crontab 每天执行</span></span><br><span class="line">crontab -e</span><br><span class="line"><span class="comment">##mongodb backup</span></span><br><span class="line">1 1 * * * /usr/local/mongodb/bin/mongobackup.sh &gt;&gt; /data/MONGODB_BACKUP/mongobackup.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>mongodb</category>
      </categories>
      <tags>
        <tag>install</tag>
        <tag>yapi</tag>
      </tags>
  </entry>
  <entry>
    <title>mangodb 集群复制</title>
    <url>/2022/12/16/mongoreplica/</url>
    <content><![CDATA[<h3 id="1-mongodb-复制集群成员"><a href="#1-mongodb-复制集群成员" class="headerlink" title="1. mongodb 复制集群成员"></a>1. mongodb 复制集群成员</h3><p>primary 主库，接收集群所有写操作。并将操作记录在oplog 中。辅助节点则通过oplog来回放主库的操作。</p>
<p>Secondaries 辅助节点，从主节点复制操作以维护相同的数据集。</p>
<p>一个集群最多只有一个主节点，副本集最多可以有 50 个成员，但只有 7 个有投票权的成员。</p>
<h5 id="辅助节点类型："><a href="#辅助节点类型：" class="headerlink" title="辅助节点类型："></a>辅助节点类型：</h5><p><em>Priority 0 辅助节点</em>：这种节点不能提升成为主节点，并且不能触发选举，但是可以参与投票。<br>                    可以正常的回放主库的oplog,可以提供只读，参与集群的负载均衡。</p>
<p><em>隐藏的辅助节点</em>：隐藏节点具有Priority 0 节点的大部分属性（除了提供只读服务)，对应用客户端不可见。<br>              此类节点因为不参与工作负载，所以几乎没有压力。可以用于做定时任务。报表。或者备份</p>
<p><em>延迟复制辅助节点</em>：延缓应用来自主库的oplog,可以看成是主库某一个过去时的快照。主要用于人为的数据误操作<br>                恢复。<br> &emsp; &emsp;由于是主库的历史版本，所以它在集群中必须满足下面三个要求<br> &emsp; &emsp;&emsp;Priority 0 最低权限<br> &emsp; &emsp;&emsp;hidden     隐藏的节点<br> &emsp; &emsp;&emsp;non-voting 不能参与投票</p>
<p><em>仲裁节点</em>： 仲裁节点适用于仅有一主一从的集群。仲裁节点参与投票，但不能成为主节点。因为它并没有数据</p>
<h3 id="2-Oplog"><a href="#2-Oplog" class="headerlink" title="2. Oplog"></a>2. Oplog</h3><p>oplog（操作日志）是一个特殊的上限集合，它保留所有修改存储在数据库中的数据的操作的滚动记录。</p>
<p>4.0 开始 oplog 能够增长超过它设置的上限。以避免删除 majority commit point.</p>
<p>4.4 开始支持设置 oplog 以小时为单位的最小保留周期，MongoDB 想要清除Oplog 必须满足2个条件<br>oplog 大小必须达到设置上限，并且超过了设置的最小保留周期数。</p>
<p>所有的辅助节点在 local.oplog.rs 集合中维护着一份oplog 备份。</p>
<h5 id="oplog-的大小"><a href="#oplog-的大小" class="headerlink" title="oplog 的大小"></a>oplog 的大小</h5><p>[UNIX &amp; WINDOWS]<br>In-Memory 存储引擎  | 默认占用物理内存5%       |最小 50M    | 最大 50G<br>WiredTiger 存储引擎 | 默认占用空闲磁盘空间5%    |最小 990M   | 最大 50G<br>[64bit macOS]<br>In-Memory 存储引擎 | 192M 物理内存<br>WiredTiger 存储引擎 | 192M 空闲磁盘空间</p>
<p>如果 oplog 占可用磁盘空间的 5% 并在 24 小时的操作中填满，则辅助节点可以停止从 oplog 复制条目<br>长达 24 小时，而不会变得太陈旧而无法继续复制。</p>
<p>在 mongod 创建oplog 之前，可以通过 oplogSizeMB 参数指定oplog 的大小。当复制集群启动后。还可以<br>通过管理命令  replSetResizeOplog 重置oplog 的大小，而无需重启服务</p>
<h5 id="设置-oplog-保留最小周期"><a href="#设置-oplog-保留最小周期" class="headerlink" title="设置 oplog 保留最小周期"></a>设置 oplog 保留最小周期</h5><p>mongod 配置文件参数：storage.oplogMinRetentionHours<br>命令行参数： —oplogMinRetentionHours<br>在运行期间变更使用 replSetResizeOplog 命令，请注意同时需要配置文件，以备下一次重启生效。</p>
<h5 id="oplog-窗口"><a href="#oplog-窗口" class="headerlink" title="oplog 窗口"></a>oplog 窗口</h5><p>oplog 条目带有时间戳。 oplog 窗口是 oplog 中最新时间戳和最旧时间戳之间的时间差。 如果辅助<br>节点失去与主节点的连接，如果连接在 oplog 窗口内恢复，它只能使用复制再次同步。</p>
<h5 id="那些可能需要更大的oplog-尺寸的-工作负载"><a href="#那些可能需要更大的oplog-尺寸的-工作负载" class="headerlink" title="那些可能需要更大的oplog 尺寸的 工作负载"></a>那些可能需要更大的oplog 尺寸的 工作负载</h5><p>1.同时更新多个文档<br>2.删除了于插入相当的数据，数据库空间没增加。不过oplog 就会显著增加。（删除跟写入都计入oplog）<br>3.大量的更新文档</p>
<h5 id="查看-Oplog-的状态"><a href="#查看-Oplog-的状态" class="headerlink" title="查看 Oplog 的状态"></a>查看 Oplog 的状态</h5><p>rs.printReplicationInfo() </p>
<h5 id="复制滞后以及流量控制"><a href="#复制滞后以及流量控制" class="headerlink" title="复制滞后以及流量控制"></a>复制滞后以及流量控制</h5><p>db.getReplicationInfo() 可在辅助节点上查看跟主库存在滞后性<br>flowControlTargetLagSeconds 参数控制应用的写入速率。以确保主节点与辅助节点的 majority committed<br>                            的滞后时间控制在 flowControlTargetLagSeconds 秒内</p>
<h5 id="Oplog-应用慢日志"><a href="#Oplog-应用慢日志" class="headerlink" title="Oplog 应用慢日志"></a>Oplog 应用慢日志</h5><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">applied op: &lt;oplog entry&gt; took &lt;num&gt;ms.</span><br></pre></td></tr></table></figure>
<p>相关参数：   命令行 mongod —slowms  配置参数 slowOpThresholdMs<br>以下情况不记录<br>logLevel/systemLog.verbosity 或 systemLog.component.replication.verbosity 日志级别<br>不被解析器捕获，并且在分析级别不被记录</p>
<p>使用 WiredTiger 引擎的复制集 local.oplog.rs 文档不能被删除，4.2 开始 单机版的 local.oplog.rs 文档<br>也不能被删除。也强烈不建议删除 local.oplog.rs 文档。5.0 开始 oplog 不能被手工操作。单机版对 oplog<br>的操作必须在Mongodb 的指导下进行</p>
<h3 id="3-复制集数据同步"><a href="#3-复制集数据同步" class="headerlink" title="3. 复制集数据同步"></a>3. 复制集数据同步</h3><h4 id="初始化同步"><a href="#初始化同步" class="headerlink" title="初始化同步"></a>初始化同步</h4><p><strong>逻辑初始化同步</strong><br>  1.克隆所有的数据库（local 库除外），mongod 扫描所有数据库中的每一个集合。并将这些数据写入自己备份集合中<br>  2.为集合里的每个文档创建索引<br>  3.推送拷贝文件期间产生的新oplog<br>  4.应用所有的变化到数据集中</p>
<p><strong>基于文件拷贝的初始化同步 （仅企业版支持）</strong><br>  1.设置 initialSyncMethod = fileCopyBased<br>  2.源库的local 库也会被复制<br>  3.限制：<br>  &emsp; &emsp;同步期间源库不能做备份，源库的local 库不能写入<br>  &emsp; &emsp;一次只能指定一个复制源节点<br>  &emsp; &emsp;使用加密存储引擎时，MongoDB 使用源密钥加密目标。</p>
<p><strong>容错机制</strong><br>  4.4 版本开始。如果遇到网络闪断，集合删除或者集合重命名导致的中断，则初始化进程将会尝试恢复同步，<br>  源库也必须是4.4版本以上。如果同步源是4.2 或更早的版本。辅助节点必须重启初始化同步进程。就像遇到<br>  非暂时性网络中断一样</p>
<p>  默认情况下辅助节点将尝试24小时恢复初始化同步，4.4 添加参数 initialSyncTransientErrorRetryPeriodSeconds<br>  如果超过这个参数设定的时间。它会从副本集中选择一个健康的节点并重头开始初始化。</p>
<p>  辅助节点在抛出同步错误之前，会进行10次尝试重启初始化进程</p>
<p><strong>初始化源选择</strong><br>  4.4 开始 ，初始化源将由参数 initialSyncSourceReadPreference 决定<br>  &emsp; &emsp; 1.设置为 primary (链式模式关闭将作为默认值) ，则选择主库为复制源。如果主库不可用或不可达。则抛错<br>  &emsp; &emsp; 2.设置为 primaryPreferred (选举复制集成员的默认值)。则优先选择主库复制，如果主库不可用或不可达，<br>  &emsp; &emsp; &emsp; 则选择集群中其他在线的节点作为复制源<br>  &emsp; &emsp; 3.对于所有其他支持的读取模式，从副本集成员执行同步源选择。</p>
<p>  选择源的第一遍，同步源必须满足下面要求：<br>  &emsp; &emsp; 1.同步源必须是primary 或者 secondary 状态<br>  &emsp; &emsp; 2.同步源必须在线并且可达<br>  &emsp; &emsp; 3.initialSyncSourceReadPreference 的值如果为secondary 或 secondaryPreferred,同步源必须是 secondary<br>  &emsp; &emsp; 4.同步源必须可用<br>  &emsp; &emsp; 5.同步源必须包含有来自主库30秒内新的oplog<br>  &emsp; &emsp; 6.如果成员建立索引。同步源必须建立索引<br>  &emsp; &emsp; 7.如果成员在副本集选举中投票，则同步源也必须投票<br>  &emsp; &emsp; 8.如果成员不是延迟成员，则同步源不得延迟。<br>  &emsp; &emsp; 9.如果成员是延迟成员，则同步源必须具有较短的配置延迟。<br>  &emsp; &emsp; 10.同步源必须比当前最佳同步源更快（即延迟更低）。<br>  如果第一遍过后没有同步源满足。则进行较为宽松的第二遍查找<br>  &emsp; &emsp; 1.同步源必须是primary 或者 secondary 状态<br>  &emsp; &emsp; 2.同步源必须在线并且可达<br>  &emsp; &emsp; 3.initialSyncSourceReadPreference 的值如果为secondary ,同步源必须是 secondary<br>  &emsp; &emsp; 4.如果成员建立索引。同步源必须建立索引<br>  &emsp; &emsp; 5.同步源必须比当前最佳同步源更快（即延迟更低）。</p>
<p>  如果2遍过后都没有可以选择的同步源。那么它将记录一个错误并且等待1秒钟后重新启动选择进程，在10次重启后都没有合适的。将报错退出</p>
<h4 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h4><p>  初始化同步完成之后，辅助节点就连续的进行数据复制。根据ping 值以及其他节点的状态变化。辅助节点可以根据自己的需要更改源的同步。</p>
<p>  <strong>流复制</strong>：源节点将连续的oplog 同步推送到同步它的辅助节点上。<br>  &emsp; &emsp; 流复制减轻了高负载和高延迟网络中的复制滞后<br>  &emsp; &emsp; 减少从辅助节点读取数据的陈旧性<br>  &emsp; &emsp; 降低了由于主库故障转移而丢失 w:1 的写操作的风险。<br>  &emsp; &emsp; 减少使用 w: “majority” 和 w: &gt;1 的写操作的延迟。<br>  4.4 版本添加了 oplogFetcherUsesExhaust 参数用来关闭流复制，当来自同步源的资源限制或者想要减少oplog 同步带来的网络带宽压力。可以将其制设置为false</p>
<p>  <strong>多线程复制</strong>: mongodb 在批量写操作时使用了多线程来改善并发。MongoDB 按文档 ID (WiredTiger) 对批次进行分组，并使用不同的线程同时应用每组操作。MongoDB 始终以原始写入顺序对给定文档应用写入操作。当读操作发生在正在应用批处理的辅助节点上并且设置阅读关注级别为 “local” 或者 “majority” 时将在  WiredTiger 快照上读取数据。从快照读取保证了数据的一致性视图，并且允许读取与复制的同时发生而不需要加锁</p>
<p>  <strong>流控制</strong>：前面说到过的，通过设置 flowControlTargetLagSeconds 实现</p>
<p><strong>复制同步源的选择</strong><br>与初始化源的选择遵循相同的准则</p>
<h3 id="4-复制集的部署架构"><a href="#4-复制集的部署架构" class="headerlink" title="4. 复制集的部署架构"></a>4. 复制集的部署架构</h3><h4 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h4><p><strong>决定复制集成员的数量</strong><br><em>选举成员的最大数量</em>：最多50个成员，以及最多7个投票成员,如果复制集中已经有7个投票成员，那么添加的成员就必须是非投票成员</p>
<p><em>部署奇数成员数量</em>：确保复制集中的投票成员数必须是奇数的。如果有偶数个投票成员，请部署另一个数据承载的投票成员。或者部署一个仲裁节点。</p>
<p><strong><em>避免在集群中部署多个仲裁节点</em></strong></p>
<p><strong>集群节点数与容错节点数</strong></p>
<table>
<tr><td>集群节点数</td><td>Majority 选举出新主节点需要的节点数</td><td>容错节点数</td></tr>
<tr><td>3</td><td>2</td><td>1</td></tr>
<tr><td>4</td><td>3</td><td>1</td></tr>
<tr><td>5</td><td>3</td><td>2</td></tr>
<tr><td>6</td><td>4</td><td>2</td></tr>
</table>

<p>从4.2开始，可以通过r.status() 查看集群的投票节点数 majorityVoteCount</p>
<p><strong>3节点复制集群（P-S-S)</strong><br><img src="images/replica-set-primary-with-two-secondaries.bakedsvg.svg" alt="pss"></p>
<p>集群中包含一个主节点和2个辅助节点，当主节点挂掉之后。将在2个辅助节点间选举，推出一个新的主节点</p>
<p><strong>3节点复制集群（P-S-A)</strong><br><img src="images/replica-set-primary-with-secondary-and-arbiter.bakedsvg.svg" alt="psa"></p>
<p>集群中包含一个主节点和1个辅助节点和一个仲裁节点，当主节点挂掉之后。另一个辅助节点提升为主节点</p>
<p><strong>多数据中心部署复制集群</strong><br><img src="images/replica-set-three-data-centers.bakedsvg.svg" alt="mutidata"></p>
<p>集群将辅助节点部署在3不同的数据中心。任何数据中心断线，都不影响集群的读写。剩下的节点依然可以选举</p>
<h3 id="5-复制集选举"><a href="#5-复制集选举" class="headerlink" title="5. 复制集选举"></a>5. 复制集选举</h3><p><strong>触发选举的情况</strong></p>
<ul>
<li>新增一个节点到集群</li>
<li>初始化复制集</li>
<li>复制集维护，例如rs.setDown() ,rs.reconfig() 等</li>
<li>辅助节点同主节点失去连接超过配置的超时时间（默认10s)</li>
</ul>
<p>在选举结束前，集群不可写，如果设置了运行在辅助节点上，则保持可读。集群在主节点失败到选举出新主所用的时间，一般不会超过12s,这包含了标志主库不可用和调用一个完整的选举过程。可以通过调整复制配置参数settings.electionTimeoutMillis 来改变这个时间。</p>
<p><strong>影响选举的因素和条件</strong></p>
<ul>
<li>复制协议。 protocolVersion: 1 减少了副本集的故障转移时间并加速了对多个同步主节点的检测。</li>
<li>心跳。集群成员每2秒钟向其他成员发送心跳包，如果心跳没有在10s 内返回，则违规成员将被标记不可访问</li>
<li>成员优先级。</li>
<li>镜像读取</li>
<li>数据中心丢失</li>
<li></li>
</ul>
]]></content>
      <categories>
        <category>mongodb</category>
      </categories>
      <tags>
        <tag>replica</tag>
        <tag>nosql</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql 8.0 用户权限部分</title>
    <url>/2022/10/17/mysql8User/</url>
    <content><![CDATA[<h3 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h3><h4 id="用户表mysql-user"><a href="#用户表mysql-user" class="headerlink" title="用户表mysql.user"></a>用户表mysql.user</h4><pre><code>user.host char(255)# 5版本为60,新版本为255,并且字符类型为ascii --&gt;  CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL DEFAULT &#39;&#39;
user.user char(32) # 5版本为16位 .8 版本增加至 32 位
</code></pre><p>mysql 8.0 新增了 role （角色），角色用于管理用户权限;</p>
<h4 id="创建新角色"><a href="#创建新角色" class="headerlink" title="创建新角色"></a>创建新角色</h4><pre><code>create role role_name;
create role &#39;app_read&#39;,&#39;app_write&#39;,&#39;dba&#39;;
</code></pre><h4 id="为角色授权："><a href="#为角色授权：" class="headerlink" title="为角色授权："></a>为角色授权：</h4><pre><code>grant select on db.* to &#39;app_read&#39;@&#39;%&#39;;
grant insert,delete,update on db.* to &#39;app_write&#39;@&#39;%&#39;
grant all on *.* to &#39;dba&#39;@&#39;%&#39;;
</code></pre><h4 id="为用户授权角色"><a href="#为用户授权角色" class="headerlink" title="为用户授权角色"></a>为用户授权角色</h4><pre><code>grant role,role1,role2 to &#39;user&#39;@&#39;%&#39;;
grant dba to &#39;sheen&#39;@&#39;%&#39;;
</code></pre><h4 id="为用户设置已授权的角色"><a href="#为用户设置已授权的角色" class="headerlink" title="为用户设置已授权的角色"></a>为用户设置已授权的角色</h4><pre><code>set default role dba to &#39;nagios&#39;@&#39;%&#39;;#为用户设置默认角色 （定义用户时没有使用default role 则可以通过下面命令修改）
SET DEFAULT ROLE ALL TO USERNAME[,USERNAME2,USERNAME3...]; #将所有权限都授权给用户当默认角色
SET ROLE NONE;#清除当前会话使用的角色
SET ROLE ALL EXCEPT &#39;app_write&#39; TO USERNAME;授权用户除了 &#39;app_write&#39; 角色外的所有角色
SET ROLE DEFAULT; #设置会话使用默认角色
</code></pre><h4 id="回收授权给用户的角色"><a href="#回收授权给用户的角色" class="headerlink" title="回收授权给用户的角色"></a>回收授权给用户的角色</h4><pre><code>REOVKE ROLE FROM USER;
eg:
  revoke &#39;app_read&#39; from sheen;
回收角色的授权
REVOKE INSERT, UPDATE, DELETE ON app_db.* FROM &#39;app_write&#39;;
删除角色
DROP ROLE &#39;app_read&#39;, &#39;app_write&#39;;
</code></pre><h3 id="grant-权限-on-db-to-role-name"><a href="#grant-权限-on-db-to-role-name" class="headerlink" title="grant 权限 on db.* to role_name;"></a>grant 权限 on db.* to role_name;</h3><p>eg: create role dba;<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; grant all on *.* to <span class="string">&#x27;dba&#x27;</span>;</span><br><span class="line"><span class="comment">#授权只读角色</span></span><br><span class="line">mysql&gt; create role select_role;</span><br><span class="line">mysql&gt; grant select on db.* to <span class="string">&#x27;select_role&#x27;</span>@<span class="string">&#x27;host_name&#x27;</span>; <span class="comment">#默认授权给&#x27;%&#x27; grant select on db.* to &#x27;select_role&#x27; == grant select on db.* to &#x27;select_role&#x27;@&#x27;%&#x27;;</span></span><br><span class="line"><span class="comment">#授权修改角色</span></span><br><span class="line">mysql&gt; create role update_role;</span><br><span class="line">mysql&gt; grant insert,update,delete to <span class="string">&#x27;update_role&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="新建用户跟-5-版本有区别"><a href="#新建用户跟-5-版本有区别" class="headerlink" title="新建用户跟 5 版本有区别:"></a>新建用户跟 5 版本有区别:</h3><pre><code>下面这种语法不再支持
grant 权限 on db.* to &#39;user&#39;@&#39;%&#39; identified by &#39;password&#39;; 
创建用户
create user username identified by &#39;password&#39; [default role &#39;xxx&#39;];
如果没有指定默认角色。当前用户默认角色为NONE,则不具有任何权限。即使你授权了某个role 。
</code></pre><p>使用角色的授权方法<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; create role dba;</span><br><span class="line">mysql&gt; grant all on *.* to <span class="string">&#x27;dba&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">mysql&gt; create user abc identified by <span class="string">&#x27;sdxdsq23L&#x27;</span> defualt role dba;</span><br><span class="line">mysql&gt; -- [ 以上语句等价 5 版本时 grant all on *.* to <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;sdxdsq23L&#x27;</span>;]</span><br><span class="line">mysql&gt; -- 使用用户授权的方法</span><br><span class="line">mysql&gt; create user abc identified by <span class="string">&#x27;sdxdsq23L&#x27;</span>;</span><br><span class="line">mysql&gt; grant all on *.* to to <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span> </span><br></pre></td></tr></table></figure></p>
<p> 假如我们没有设定defualt role 。将会发生什么情况<br> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> mysql&gt; create user <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;sdxdsq23L&#x27;</span>;</span><br><span class="line"> grant dba to <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"> mysql&gt; show grants <span class="keyword">for</span> abc;</span><br><span class="line">+------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> sheen@%                 |</span><br><span class="line">+------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO `abc`@`%` |</span><br><span class="line">| GRANT `dba`@`%` TO `abc`@`%`    |</span><br><span class="line">+------------------------------------+</span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> <span class="string">&#x27;dba&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> dba@%                                                                                                                                                                                                                                                                                                                                                                                                                                                    |</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `dba`@`%`                                                                                       |</span><br><span class="line">| GRANT APPLICATION_PASSWORD_ADMIN,AUDIT_ADMIN,BACKUP_ADMIN,BINLOG_ADMIN,BINLOG_ENCRYPTION_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,GROUP_REPLICATION_ADMIN,INNODB_REDO_LOG_ARCHIVE,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SERVICE_CONNECTION_ADMIN,SESSION_VARIABLES_ADMIN,SET_USER_ID,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN,TABLE_ENCRYPTION_ADMIN,XA_RECOVER_ADMIN ON *.* TO `dba`@`%` |</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; use sheen</span><br><span class="line">ERROR 1044 (42000): Access denied <span class="keyword">for</span> user <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span> to database <span class="string">&#x27;sheen&#x27;</span></span><br></pre></td></tr></table></figure><br>由上面可以看出我们已经授权dba 角色。dba 角色具有访问所有库的权限。但是还是连不了 sheen 这个库。<br>继续往下看<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; select current_role(); <span class="comment">#查看当前会话使用的角色</span></span><br><span class="line">+----------------+</span><br><span class="line">| current_role() |</span><br><span class="line">+----------------+</span><br><span class="line">| NONE           |</span><br><span class="line">+----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><br>是因为当前用户连接没有使用任何角色的原因</p>
<p>为当前会话设置使用角色（所设角色名必须是有授权给当前连接用户的角色）<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> role dba;</span><br><span class="line">mysql&gt; select current_role(); </span><br><span class="line">+----------------+</span><br><span class="line">| current_role() |</span><br><span class="line">+----------------+</span><br><span class="line">| `dba`@`%`      |</span><br><span class="line">+----------------+</span><br><span class="line">mysql&gt; use sheen;</span><br><span class="line">Database changed</span><br></pre></td></tr></table></figure></p>
<h4 id="新参数-mandatory-roles-强制定义角色参数。使用该参数，则实例下所有用户都会被授权-mandatory-roles-指定角色。而不需要再重新授权"><a href="#新参数-mandatory-roles-强制定义角色参数。使用该参数，则实例下所有用户都会被授权-mandatory-roles-指定角色。而不需要再重新授权" class="headerlink" title="新参数 mandatory_roles 强制定义角色参数。使用该参数，则实例下所有用户都会被授权 mandatory_roles 指定角色。而不需要再重新授权"></a>新参数 mandatory_roles 强制定义角色参数。使用该参数，则实例下所有用户都会被授权 mandatory_roles 指定角色。而不需要再重新授权</h4><pre><code>可用于my.cnf [mysqld] 下面。
[mysqld]
 mandatory_roles=&#39;role1,role2@localhost,r3@%.example.com&#39;
也可以在数据库启动后。动态持久化定义
SET PERSIST mandatory_roles = &#39;role1,role2@localhost,r3@%.example.com&#39;;
使用GLOBAL 时 该参数只适合当前实例。重启不保存设置结果
SET GLOBAL mandatory_roles = &#39;role1,role2@localhost,r3@%.example.com&#39;;

可以将某个授权用户转授权给新用户
grant select ,update ,delete ,insert on db.* to &#39;u1&#39;;
grant u1 to u2;
(这个操作适用于新老用户替换的情况。比如老的维护人员离开。新的维护人员到来。要让新用户人员具有老用户的权限时。可以有以下2种操作方式
  第一种.改老用户的密码。然后将老用户给新用户用  
      ALTER USER &#39;old_app_dev&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;new_password&#39;;
  第二种.将老账户视为角色，锁定老用户，将老用户作为一个角色授权给新的需要的新账户
      ALTER USER &#39;old_app_dev&#39;@&#39;localhost&#39; ACCOUNT LOCK;
      CREATE USER &#39;new_app_dev1&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;new_password&#39;;
      GRANT &#39;old_app_dev&#39;@&#39;localhost&#39; TO &#39;new_app_dev1&#39;@&#39;localhost&#39;;
 )     
角色的出现,使新版mysql 的权限控制更加灵活    

注意:
具有 SUPER 权限 的用户。可以修改数据 即便 数据库设置了read_only=on;可以在数据库连接达到max_connection后依然可以登录连接数据库。(5版本super 用户与普通用户共用max_connection数)

4个预留用户
&#39;root&#39;@&#39;localhost：用于管理目的。该帐户具有所有特权，是系统帐户，并且可以执行任何操作
&#39;mysql.sys&#39;@&#39;localhost&#39;：作为 DEFINER对 sys架构对象。使用该 mysql.sys帐户可以避免在DBA重命名或删除该root 帐户时发生的问题。此帐户已锁定，因此不能用于客户端连接
&#39;mysql.session&#39;@&#39;localhost&#39;：由插件内部使用以访问服务器。此帐户已锁定，因此不能用于客户端连接。该帐户是系统帐户
&#39;mysql.infoschema&#39;@&#39;localhost&#39;：作为information_schema 视图的definer。使用该mysql.infoschema帐户可以避免在DBA重命名或删除root帐户时发生的问题。此帐户已锁定，因此不能用于客户端连接
</code></pre>]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>mysql 8</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql json 类型</title>
    <url>/2023/04/04/mysqlJsonType/</url>
    <content><![CDATA[<p>JSON 类型的存储跟LONGBLOB, LONGTEXT 一样 存储长度:L + 4 bytes, where L &lt; 2 的32次方<br>JSON 的传输限制于 max_allowed_package 的大小，可以通过 JSON_STORAGE_SIZE()  函数来确定json 文档的大小<br>JSON 类型并不能直接创建索引，而是由计算列支持<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_json(</span><br><span class="line">     c json,</span><br><span class="line">     g <span class="type">int</span> generated always <span class="keyword">as</span> (c<span class="operator">-</span><span class="operator">&gt;</span>&quot;$.id&quot;),</span><br><span class="line">     key idx_g (g)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_json (c) <span class="keyword">VALUES</span></span><br><span class="line">      (<span class="string">&#x27;&#123;&quot;id&quot;: &quot;1&quot;, &quot;name&quot;: &quot;Fred&quot;&#125;&#x27;</span>), (<span class="string">&#x27;&#123;&quot;id&quot;: &quot;2&quot;, &quot;name&quot;: &quot;Wilma&quot;&#125;&#x27;</span>),</span><br><span class="line">   (<span class="string">&#x27;&#123;&quot;id&quot;: &quot;3&quot;, &quot;name&quot;: &quot;Barney&quot;&#125;&#x27;</span>), (<span class="string">&#x27;&#123;&quot;id&quot;: &quot;4&quot;, &quot;name&quot;: &quot;Betty&quot;&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test_json;</span><br><span class="line">c                            <span class="operator">|</span>g<span class="operator">|</span></span><br><span class="line"><span class="comment">-----------------------------+-+</span></span><br><span class="line">&#123;&quot;id&quot;: &quot;1&quot;, &quot;name&quot;: &quot;Fred&quot;&#125;  <span class="operator">|</span><span class="number">1</span><span class="operator">|</span></span><br><span class="line">&#123;&quot;id&quot;: &quot;2&quot;, &quot;name&quot;: &quot;Wilma&quot;&#125; <span class="operator">|</span><span class="number">2</span><span class="operator">|</span></span><br><span class="line">&#123;&quot;id&quot;: &quot;3&quot;, &quot;name&quot;: &quot;Barney&quot;&#125;<span class="operator">|</span><span class="number">3</span><span class="operator">|</span></span><br><span class="line">&#123;&quot;id&quot;: &quot;4&quot;, &quot;name&quot;: &quot;Betty&quot;&#125; <span class="operator">|</span><span class="number">4</span><span class="operator">|</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test_json <span class="keyword">where</span> c<span class="operator">-</span><span class="operator">&gt;</span>&quot;$.id&quot; <span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">id<span class="operator">|</span>select_type<span class="operator">|</span><span class="keyword">table</span>    <span class="operator">|</span>partitions<span class="operator">|</span>type<span class="operator">|</span>possible_keys<span class="operator">|</span>key  <span class="operator">|</span>key_len<span class="operator">|</span><span class="keyword">ref</span>  <span class="operator">|</span><span class="keyword">rows</span><span class="operator">|</span>filtered<span class="operator">|</span>Extra<span class="operator">|</span></span><br><span class="line"><span class="comment">--+-----------+---------+----------+----+-------------+-----+-------+-----+----+--------+-----+</span></span><br><span class="line"> <span class="number">1</span><span class="operator">|</span>SIMPLE     <span class="operator">|</span>test_json<span class="operator">|</span>          <span class="operator">|</span><span class="keyword">ref</span> <span class="operator">|</span>idx_g        <span class="operator">|</span>idx_g<span class="operator">|</span><span class="number">5</span>      <span class="operator">|</span>const<span class="operator">|</span>   <span class="number">1</span><span class="operator">|</span>   <span class="number">100.0</span><span class="operator">|</span>     <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"> <span class="operator">-</span><span class="operator">&gt;</span> 操作符相当于 json_extract() 函数</span><br><span class="line"> <span class="operator">-</span><span class="operator">&gt;&gt;</span> 操作符相当于 json_unquote() 函数 <span class="comment">--不带双引号</span></span><br><span class="line"> <span class="keyword">SELECT</span> c<span class="operator">-</span><span class="operator">&gt;</span>&quot;$.name&quot;,c<span class="operator">-</span><span class="operator">&gt;&gt;</span>&quot;$.name&quot; <span class="keyword">FROM</span> test_json</span><br><span class="line"> c<span class="operator">-</span><span class="operator">&gt;</span>&quot;$.name&quot;<span class="operator">|</span>c<span class="operator">-</span><span class="operator">&gt;&gt;</span>&quot;$.name&quot;<span class="operator">|</span></span><br><span class="line"><span class="comment">-----------+------------+</span></span><br><span class="line">&quot;Fred&quot;     <span class="operator">|</span>Fred        <span class="operator">|</span></span><br><span class="line">&quot;Wilma&quot;    <span class="operator">|</span>Wilma       <span class="operator">|</span></span><br><span class="line">&quot;Barney&quot;   <span class="operator">|</span>Barney      <span class="operator">|</span></span><br><span class="line">&quot;Betty&quot;    <span class="operator">|</span>Betty       <span class="operator">|</span></span><br><span class="line">&quot;Fred&quot;     <span class="operator">|</span>Fred        <span class="operator">|</span></span><br><span class="line">&quot;Wilma&quot;    <span class="operator">|</span>Wilma       <span class="operator">|</span></span><br></pre></td></tr></table></figure></p>
<p>更新JSON 列的值<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">全字段更新</span><br><span class="line"><span class="keyword">update</span> test_json <span class="keyword">set</span> c<span class="operator">=</span><span class="string">&#x27;&#123;&quot;id&quot;: &quot;5&quot;, &quot;name&quot;: &quot;Sheen&quot;&#125;&#x27;</span> <span class="keyword">where</span> c<span class="operator">-</span><span class="operator">&gt;</span><span class="string">&#x27;$.id&#x27;</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">部分更新(<span class="number">8.0</span><span class="operator">+</span>)</span><br><span class="line">在<span class="keyword">update</span> 语句中通过 json_set(),json_replace(),json_remove() 这三个函数，对json 列进行部分更新操作</span><br><span class="line"># 输入列与被更新列必须是同一列</span><br><span class="line"><span class="keyword">UPDATE</span> mytable <span class="keyword">SET</span> jcol1 <span class="operator">=</span> JSON_SET(jcol1, <span class="string">&#x27;$.a&#x27;</span>, <span class="number">100</span>); </span><br><span class="line"># 这个操作在部分更新操作是不允许的。输入列与被更新列不一致</span><br><span class="line"><span class="keyword">UPDATE</span> mytable <span class="keyword">SET</span> jcol1 <span class="operator">=</span> JSON_SET(jcol2, <span class="string">&#x27;$.a&#x27;</span>, <span class="number">100</span>); </span><br><span class="line"># 被替换的值的存储空间必须至少和新值一样大。换句话说，新值不能大于旧值</span><br><span class="line">可以通过 JSON_STORAGE_FREE() 函数查看部分更新json 列释放的空间大小。</span><br><span class="line">通过设置 binlog_row_value_options <span class="operator">=</span> PARTIAL_JSON.可以使部分更新操作写入binlog时采用压缩格式。节省空间</span><br></pre></td></tr></table></figure></p>
<p>创建 JSON 值<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">以中括号引起的json数组</span><br><span class="line">[&quot;abc&quot;, <span class="number">10</span>, <span class="keyword">null</span>, <span class="literal">true</span>, <span class="literal">false</span>]</span><br><span class="line"></span><br><span class="line">以花括号引起的key:<span class="keyword">value</span>的json对象</span><br><span class="line">&#123;&quot;k1&quot;: &quot;value&quot;, &quot;k2&quot;: <span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line">都可以成为JSON类型的值，JSON 标量值可以包含各种数据类型。但是 key<span class="operator">-</span><span class="keyword">value</span> 对象中 key 必须是字符串，JSON对象允许循环嵌套json数组或对象</span><br><span class="line">[<span class="number">99</span>, &#123;&quot;id&quot;: &quot;HK500&quot;, &quot;cost&quot;: <span class="number">75.99</span>&#125;, [&quot;hot&quot;, &quot;cold&quot;]]</span><br><span class="line">&#123;&quot;k1&quot;: &quot;value&quot;, &quot;k2&quot;: [<span class="number">10</span>, <span class="number">20</span>]&#125;</span><br><span class="line">可以通过 <span class="built_in">CAST</span>(<span class="keyword">value</span> <span class="keyword">as</span> JSON) 将其他类型转化为JSON 类型</span><br></pre></td></tr></table></figure></p>
<p>JSON_TYPE() 函数尝试解析一个JSON对象的类型。如果json对象有效则返回对应的类型。否则返回错误<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> json_type(<span class="string">&#x27;&#123;&quot;id&quot;: &quot;5&quot;, &quot;name&quot;: &quot;Fred&quot;&#125;&#x27;</span>)</span><br><span class="line">json_type(<span class="string">&#x27;&#123;&quot;id&quot;: &quot;5&quot;, &quot;name&quot;: &quot;Fred&quot;&#125;&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------+</span></span><br><span class="line">OBJECT                                  <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> json_type(<span class="string">&#x27;[1,2,3,4]&#x27;</span>) </span><br><span class="line">json_type(<span class="string">&#x27;[1,2,3,4]&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------+</span></span><br><span class="line"><span class="keyword">ARRAY</span>                 <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> json_type(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">json_type(<span class="string">&#x27;1&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">--------------+</span></span><br><span class="line"><span class="type">INTEGER</span>       <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> json_type(<span class="string">&#x27;&quot;var&quot;&#x27;</span>) </span><br><span class="line">json_type(<span class="string">&#x27;&quot;var&quot;&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">------------------+</span></span><br><span class="line">STRING            <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> json_type(<span class="string">&#x27;var&#x27;</span>) </span><br><span class="line"><span class="keyword">SQL</span> 错误 [<span class="number">3141</span>] [<span class="number">22001</span>]: Data truncation: Invalid JSON text <span class="keyword">in</span> argument <span class="number">1</span> <span class="keyword">to</span> <span class="keyword">function</span> json_type: &quot;Invalid value.&quot; <span class="keyword">at</span> position <span class="number">0.</span></span><br></pre></td></tr></table></figure></p>
<p>JSON_ARRAY() 将给定的值列表组成一个json数组<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">json_array</span>(<span class="string">&#x27;var&#x27;</span>,<span class="number">1</span>,now())</span><br><span class="line"><span class="built_in">json_array</span>(<span class="string">&#x27;var&#x27;</span>,<span class="number">1</span>,now())               <span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------+</span></span><br><span class="line">[&quot;var&quot;, <span class="number">1</span>, &quot;2023-04-04 15:23:00.000000&quot;]<span class="operator">|</span></span><br></pre></td></tr></table></figure></p>
<p>JSON_OBJECT() 将给定的key value 组成一个 json 对象<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">json_object</span>(<span class="string">&#x27;id&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;Sheen&#x27;</span>)</span><br><span class="line"><span class="built_in">json_object</span>(<span class="string">&#x27;id&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;Sheen&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------+</span></span><br><span class="line">&#123;&quot;id&quot;: <span class="number">1</span>, &quot;name&quot;: &quot;Sheen&quot;&#125;        <span class="operator">|</span></span><br></pre></td></tr></table></figure></p>
<p>JSON_MERGE_PRESERVE() 将多个json 文档合并成一个<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> JSON_MERGE_PRESERVE(<span class="string">&#x27;[&quot;a&quot;, 1]&#x27;</span>, <span class="string">&#x27;&#123;&quot;key&quot;: &quot;value&quot;&#125;&#x27;</span>);</span><br><span class="line">JSON_MERGE_PRESERVE(<span class="string">&#x27;[&quot;a&quot;, 1]&#x27;</span>, <span class="string">&#x27;&#123;&quot;key&quot;: &quot;value&quot;&#125;&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">---------------------------------------------------+</span></span><br><span class="line">[&quot;a&quot;, <span class="number">1</span>, &#123;&quot;key&quot;: &quot;value&quot;&#125;]                         <span class="operator">|</span></span><br></pre></td></tr></table></figure></p>
<p>JSON值的规范化<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">JSON_OBJECT</span>(<span class="string">&#x27;key1&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;key2&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;def&#x27;</span>);</span><br><span class="line">在<span class="number">8.0</span><span class="number">.3</span>以后的版本</span><br><span class="line">是以重复键最后出现胜利原则</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">JSON_OBJECT</span>(<span class="string">&#x27;key1&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;key2&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;def&#x27;</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> &#123;&quot;key1&quot;: &quot;def&quot;, &quot;key2&quot;: &quot;abc&quot;&#125;                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------+</span></span><br><span class="line">在<span class="number">8.0</span><span class="number">.3</span> 以前的版本</span><br><span class="line">是以重复建最早出现胜利原则</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">JSON_OBJECT</span>(<span class="string">&#x27;key1&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;key2&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;key1&#x27;</span>, <span class="string">&#x27;def&#x27;</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> &#123;&quot;key1&quot;: <span class="number">1</span>, &quot;key2&quot;: &quot;abc&quot;&#125;                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------------------------------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>JSON值合并 (8.0.3版本开始支持)<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">JSON_MERGE_PRESERVE() </span><br><span class="line">JSON_MERGE_PATCH()</span><br><span class="line">这<span class="number">2</span>个合并函数的不同在于对重复键的处理</span><br><span class="line">JSON_MERGE_PRESERVE() 是保留了重复键，并将值合并，JSON_MERGE_PATCH() 则保留重复键的最后一个。其他全部丢弃</span><br><span class="line">合并数组:</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   JSON_MERGE_PRESERVE(<span class="string">&#x27;[1, 2]&#x27;</span>, <span class="string">&#x27;[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&#x27;</span>, <span class="string">&#x27;[true, false]&#x27;</span>) <span class="keyword">AS</span> Preserve,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   JSON_MERGE_PATCH(<span class="string">&#x27;[1, 2]&#x27;</span>, <span class="string">&#x27;[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&#x27;</span>, <span class="string">&#x27;[true, false]&#x27;</span>) <span class="keyword">AS</span> Patch\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">Preserve: [<span class="number">1</span>, <span class="number">2</span>, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, <span class="literal">true</span>, <span class="literal">false</span>]</span><br><span class="line">   Patch: [<span class="literal">true</span>, <span class="literal">false</span>]</span><br><span class="line">在上面的例子中 JSON_MERGE_PATCH 将每个参数视为一个由单个元素组成的数组。因此其下标皆为<span class="number">0</span> 。根据最后优胜规则 ，结果就是[<span class="literal">true</span>,<span class="literal">false</span>]</span><br><span class="line"></span><br><span class="line">合并对象</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   JSON_MERGE_PRESERVE(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: 2&#125;&#x27;</span>, <span class="string">&#x27;&#123;&quot;c&quot;: 3, &quot;a&quot;: 4&#125;&#x27;</span>, <span class="string">&#x27;&#123;&quot;c&quot;: 5, &quot;d&quot;: 3&#125;&#x27;</span>) <span class="keyword">AS</span> Preserve,</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>   JSON_MERGE_PATCH(<span class="string">&#x27;&#123;&quot;a&quot;: 3, &quot;b&quot;: 2&#125;&#x27;</span>, <span class="string">&#x27;&#123;&quot;c&quot;: 3, &quot;a&quot;: 4&#125;&#x27;</span>, <span class="string">&#x27;&#123;&quot;c&quot;: 5, &quot;d&quot;: 3&#125;&#x27;</span>) <span class="keyword">AS</span> Patch\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">Preserve: &#123;&quot;a&quot;: [<span class="number">1</span>, <span class="number">4</span>], &quot;b&quot;: <span class="number">2</span>, &quot;c&quot;: [<span class="number">3</span>, <span class="number">5</span>], &quot;d&quot;: <span class="number">3</span>&#125;</span><br><span class="line">   Patch: &#123;&quot;a&quot;: <span class="number">4</span>, &quot;b&quot;: <span class="number">2</span>, &quot;c&quot;: <span class="number">5</span>, &quot;d&quot;: <span class="number">3</span>&#125;</span><br><span class="line">上面的例子中，我们可以看到对于重复键JSON_MERGE_PRESERVE保留key,并将其值合并成数组。而JSON_MERGE_PATCH遵循最后优胜规则，只保留重复key 的最后一个值</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span></span><br><span class="line">	  <span class="operator">-</span><span class="operator">&gt;</span>   JSON_MERGE_PRESERVE(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>) <span class="keyword">AS</span> Preserve,</span><br><span class="line">	  <span class="operator">-</span><span class="operator">&gt;</span>   JSON_MERGE_PATCH(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>) <span class="keyword">AS</span> Patch\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">Preserve: [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">   Patch: <span class="number">2</span></span><br><span class="line">非数组对象会被自动包装为数组对象。于是本例子中的JSON_MERGE_PATCH同样丢弃了第一个数组对象。仅保留<span class="number">2</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span></span><br><span class="line">	  <span class="operator">-</span><span class="operator">&gt;</span>   JSON_MERGE_PRESERVE(<span class="string">&#x27;[10, 20]&#x27;</span>, <span class="string">&#x27;&#123;&quot;a&quot;: &quot;x&quot;, &quot;b&quot;: &quot;y&quot;&#125;&#x27;</span>) <span class="keyword">AS</span> Preserve,</span><br><span class="line">	  <span class="operator">-</span><span class="operator">&gt;</span>   JSON_MERGE_PATCH(<span class="string">&#x27;[10, 20]&#x27;</span>, <span class="string">&#x27;&#123;&quot;a&quot;: &quot;x&quot;, &quot;b&quot;: &quot;y&quot;&#125;&#x27;</span>) <span class="keyword">AS</span> Patch\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">Preserve: [<span class="number">10</span>, <span class="number">20</span>, &#123;&quot;a&quot;: &quot;x&quot;, &quot;b&quot;: &quot;y&quot;&#125;]</span><br><span class="line">   Patch: &#123;&quot;a&quot;: &quot;x&quot;, &quot;b&quot;: &quot;y&quot;&#125;</span><br><span class="line">在混合数组和对象合并中。JSON_MERGE_PRESERVE将对象合并到数组中。而JSON_MERGE_PATCH则是将参数视为一个由单个元素组成的数组，这样就只保留最后一个参数</span><br><span class="line">可以说JSON_MERGE_PATCH 除了在多个json对象中合并对象里的每一个值。重复值就只保留最后一个。在其他情况下，只返回最后一个参数的值</span><br></pre></td></tr></table></figure></p>
<p>查找JSON值<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">json值的查找路径</span><br><span class="line">$为根 </span><br><span class="line">$[n],表示第n<span class="operator">+</span><span class="number">1</span>个对象，下标从<span class="number">0</span> 开始</span><br><span class="line">$[n].key 表示第n<span class="operator">+</span><span class="number">1</span>个对象中指定key的值,当json值只有一个json 对象 可以写成 $.key 。存在多个对象而写成$.key 将返回<span class="keyword">NULL</span></span><br><span class="line">$[n].key[n] 表示第n<span class="operator">+</span><span class="number">1</span>个对象中指定key的值,key[n] 中的n 表示key 值里面第n<span class="operator">+</span><span class="number">1</span>个元素</span><br><span class="line">$.<span class="operator">*</span> 表示将对象的所有值组成一个数组返回</span><br><span class="line">$<span class="operator">*</span><span class="operator">*</span>.key 表示将对象的所有值中的key对应的值组成一个数组返回</span><br><span class="line">$[m <span class="keyword">to</span> n] 表示在json数组中获取一段连续的元素</span><br><span class="line">$[<span class="keyword">last</span>] 表示json数组中最后一个元素</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> JSON_EXTRACT(<span class="string">&#x27;[3, &#123;&quot;a&quot;: [5, 6], &quot;b&quot;: 10&#125;, [99, 100]]&#x27;</span>,<span class="string">&#x27;$[0]&#x27;</span>)</span><br><span class="line">$[<span class="number">0</span>] 表示第一个json元素</span><br><span class="line">JSON_EXTRACT(<span class="string">&#x27;[3, &#123;&quot;a&quot;: [5, 6], &quot;b&quot;: 10&#125;, [99, 100]]&#x27;</span>,<span class="string">&#x27;$[0]&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">-------------------------------------------------------------+</span></span><br><span class="line"><span class="number">3</span>                                                            <span class="operator">|</span></span><br><span class="line"><span class="keyword">SELECT</span> JSON_EXTRACT(<span class="string">&#x27;[3, &#123;&quot;a&quot;: [5, 6], &quot;b&quot;: 10&#125;, [99, 100]]&#x27;</span>,<span class="string">&#x27;$[1].a&#x27;</span>)</span><br><span class="line">$[<span class="number">1</span>].a 表示第二个元素里面key为a的值</span><br><span class="line">JSON_EXTRACT(<span class="string">&#x27;[3, &#123;&quot;a&quot;: [5, 6], &quot;b&quot;: 10&#125;, [99, 100]]&#x27;</span>,<span class="string">&#x27;$[1].a&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">---------------------------------------------------------------+</span></span><br><span class="line">[<span class="number">5</span>, <span class="number">6</span>]                                                         <span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> JSON_EXTRACT(<span class="string">&#x27;[3, &#123;&quot;a&quot;: [5, 6], &quot;b&quot;: 10&#125;, [99, 100]]&#x27;</span>,<span class="string">&#x27;$[1].a[1]&#x27;</span>)</span><br><span class="line">$[<span class="number">1</span>].a[<span class="number">1</span>] 表示第二个元素里面key为a的值里面的第二个元素</span><br><span class="line">JSON_EXTRACT(<span class="string">&#x27;[3, &#123;&quot;a&quot;: [5, 6], &quot;b&quot;: 10&#125;, [99, 100]]&#x27;</span>,<span class="string">&#x27;$[1].a[1]&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">6</span>                                                                 <span class="operator">|</span></span><br><span class="line"><span class="keyword">SELECT</span> JSON_EXTRACT(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: 2, &quot;c&quot;: [3, 4, 5]&#125;&#x27;</span>, <span class="string">&#x27;$.*&#x27;</span>)</span><br><span class="line">$.<span class="operator">*</span> 仅用于只有一个json对象中，将对象中所有的值以数组返回</span><br><span class="line">Name                                                   <span class="operator">|</span><span class="keyword">Value</span>            <span class="operator">|</span></span><br><span class="line"><span class="comment">-------------------------------------------------------+-----------------+</span></span><br><span class="line">JSON_EXTRACT(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;b&quot;: 2, &quot;c&quot;: [3, 4, 5]&#125;&#x27;</span>, <span class="string">&#x27;$.*&#x27;</span>)<span class="operator">|</span>[<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]]<span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> JSON_EXTRACT(<span class="string">&#x27;&#123;&quot;a&quot;: &#123;&quot;b&quot;: 1&#125;, &quot;c&quot;: &#123;&quot;b&quot;: 2&#125;&#125;&#x27;</span>, <span class="string">&#x27;$**.b&#x27;</span>);</span><br><span class="line">$.<span class="operator">*</span><span class="operator">*</span>.b 表示第一层的<span class="keyword">value</span>中的key<span class="operator">=</span>b 的值以数组的形式返回 </span><br><span class="line">Name                                                   <span class="operator">|</span><span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="comment">-------------------------------------------------------+------+</span></span><br><span class="line">JSON_EXTRACT(<span class="string">&#x27;&#123;&quot;a&quot;: &#123;&quot;b&quot;: 1&#125;, &quot;c&quot;: &#123;&quot;b&quot;: 2&#125;&#125;&#x27;</span>, <span class="string">&#x27;$**.b&#x27;</span>)<span class="operator">|</span>[<span class="number">1</span>, <span class="number">2</span>]<span class="operator">|</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> JSON_EXTRACT(<span class="string">&#x27;[1, 2, 3, 4, 5]&#x27;</span>, <span class="string">&#x27;$[1 to 3]&#x27;</span>);</span><br><span class="line">$[<span class="number">1</span> <span class="keyword">to</span> <span class="number">3</span>] 对于json 数组可以通过 n <span class="keyword">to</span> m 的方式获数组中连续的一段值，表示获取从第<span class="number">2</span>到第<span class="number">4</span>个元素</span><br><span class="line">Name                                        <span class="operator">|</span><span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="comment">--------------------------------------------+---------+</span></span><br><span class="line">JSON_EXTRACT(<span class="string">&#x27;[1, 2, 3, 4, 5]&#x27;</span>, <span class="string">&#x27;$[1 to 3]&#x27;</span>)<span class="operator">|</span>[<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]<span class="operator">|</span></span><br><span class="line">$[<span class="keyword">last</span>] 则表示数组的最后一个元素。$[<span class="keyword">last</span> <span class="number">-3</span> <span class="keyword">to</span> <span class="keyword">last</span> <span class="number">-1</span>] 表示从倒数第<span class="number">4</span>个元素到倒数第<span class="number">2</span>个元素</span><br></pre></td></tr></table></figure></p>
<p>修改JSON的值<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">JSON_SET() 函数</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@j</span> <span class="operator">=</span> <span class="string">&#x27;[&quot;a&quot;, &#123;&quot;b&quot;: [true, false]&#125;, [10, 20]]&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> JSON_SET(<span class="variable">@j</span>, <span class="string">&#x27;$[1].b[0]&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;$[2][2]&#x27;</span>, <span class="number">2</span>);</span><br><span class="line">$[<span class="number">1</span>].b[<span class="number">0</span>] 将第<span class="number">2</span>个元素key<span class="operator">=</span>b 的第<span class="number">1</span>个元素修改为<span class="number">1</span>，将第<span class="number">3</span>个元素的值中第<span class="number">3</span>个值设置为<span class="number">2</span></span><br><span class="line">JSON_SET(<span class="variable">@j</span>, <span class="string">&#x27;$[1].b[0]&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;$[2][2]&#x27;</span>, <span class="number">2</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">------------------------------------------+</span></span><br><span class="line">[&quot;a&quot;, &#123;&quot;b&quot;: [<span class="number">1</span>, <span class="literal">false</span>]&#125;, [<span class="number">10</span>, <span class="number">20</span>, <span class="number">2</span>]]     <span class="operator">|</span></span><br><span class="line">从结果中我们可以看到 $[<span class="number">1</span>]  对应的是 &#123;&quot;b&quot;: [<span class="literal">true</span>, <span class="literal">false</span>]&#125;, $[<span class="number">1</span>].b[<span class="number">0</span>] 对应的是<span class="literal">true</span> 被修改成<span class="number">1</span>，而第<span class="number">3</span>个元素[<span class="number">10</span>, <span class="number">20</span>]没有下标为<span class="number">2</span>的数据。则新增了一个<span class="number">2</span></span><br><span class="line">JSON_SET() 既更新旧值也插入新值</span><br><span class="line"></span><br><span class="line">JSON_INSERT() 函数</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@j</span> <span class="operator">=</span> <span class="string">&#x27;[&quot;a&quot;, &#123;&quot;b&quot;: [true, false]&#125;, [10, 20]]&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> JSON_INSERT(<span class="variable">@j</span>, <span class="string">&#x27;$[1].b[0]&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;$[2][2]&#x27;</span>, <span class="number">2</span>);</span><br><span class="line">JSON_INSERT(<span class="variable">@j</span>, <span class="string">&#x27;$[1].b[0]&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;$[2][2]&#x27;</span>, <span class="number">2</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">---------------------------------------------+</span></span><br><span class="line">[&quot;a&quot;, &#123;&quot;b&quot;: [<span class="literal">true</span>, <span class="literal">false</span>]&#125;, [<span class="number">10</span>, <span class="number">20</span>, <span class="number">2</span>]]     <span class="operator">|</span></span><br><span class="line">从结果中可以看到JSON_INSERT()是插入新的值而不更新旧值</span><br><span class="line"></span><br><span class="line">JSON_PLACE() 函数</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@j</span> <span class="operator">=</span> <span class="string">&#x27;[&quot;a&quot;, &#123;&quot;b&quot;: [true, false]&#125;, [10, 20]]&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> JSON_REPLACE(<span class="variable">@j</span>, <span class="string">&#x27;$[1].b[0]&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;$[2][2]&#x27;</span>, <span class="number">2</span>);</span><br><span class="line">JSON_REPLACE(<span class="variable">@j</span>, <span class="string">&#x27;$[1].b[0]&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;$[2][2]&#x27;</span>, <span class="number">2</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">----------------------------------------------+</span></span><br><span class="line">[&quot;a&quot;, &#123;&quot;b&quot;: [<span class="number">1</span>, <span class="literal">false</span>]&#125;, [<span class="number">10</span>, <span class="number">20</span>]]            <span class="operator">|</span></span><br><span class="line">从结果中可以看到JSON_PLACE()只更新旧值，不插入新值</span><br><span class="line"></span><br><span class="line">JSON_REMOVE() 函数</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@j</span> <span class="operator">=</span> <span class="string">&#x27;[&quot;a&quot;, &#123;&quot;b&quot;: [true, false]&#125;, [10, 20]]&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> JSON_REMOVE(<span class="variable">@j</span>, <span class="string">&#x27;$[2]&#x27;</span>, <span class="string">&#x27;$[1].b[1]&#x27;</span>, <span class="string">&#x27;$[1].b[1]&#x27;</span>);</span><br><span class="line">JSON_REMOVE(<span class="variable">@j</span>, <span class="string">&#x27;$[2]&#x27;</span>, <span class="string">&#x27;$[1].b[1]&#x27;</span>, <span class="string">&#x27;$[1].b[1]&#x27;</span>)<span class="operator">|</span></span><br><span class="line"><span class="comment">-------------------------------------------------+</span></span><br><span class="line">[&quot;a&quot;, &#123;&quot;b&quot;: [<span class="literal">true</span>]&#125;]                             <span class="operator">|</span></span><br><span class="line">从结果集可以看到，根据参数指定的的多个path 进行元素移除</span><br><span class="line">第<span class="number">1</span>个参数，$[<span class="number">2</span>] 即 [<span class="number">10</span>, <span class="number">20</span>] 被移除</span><br><span class="line">第<span class="number">2</span>个参数，$[<span class="number">1</span>].b[<span class="number">1</span>] 即  &#123;&quot;b&quot;: [<span class="literal">true</span>, <span class="literal">false</span>]&#125; 中的<span class="literal">false</span> 也被移除</span><br><span class="line">第<span class="number">3</span>个参数，$[<span class="number">1</span>].b[<span class="number">1</span>] 即  &#123;&quot;b&quot;: [<span class="literal">true</span>, <span class="literal">false</span>]&#125; 中的<span class="literal">false</span> 因为在第<span class="number">2</span>步已经被移除。所以找不到。将不起任何作用</span><br></pre></td></tr></table></figure></p>
<p>JSON 类型值的比较<br>JSON 类型值可以通过 =, &lt;, &lt;=, &gt;, &gt;=, &lt;&gt;, !=, 和 &lt;=&gt; 这些操作符比较<br>BETWEEN IN() GREATEST() LEAST() 这些比较操作跟函数暂时不被支持</p>
<p>以下列表显示了JSON类型的优先级，从最高优先级到最低优先级。（类型名称是由JSON_type（）函数返回的名称。）一行中显示在一起的类型具有相同的优先级。列表中较早列出的JSON类型的任何值都比列表中较晚列出的任何JSON类型的值大。<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="type">BLOB</span></span><br><span class="line">  比较两个值的前N个字节，其中N是较短值中的字节数。如果两个值的前N个字节相同，则将较短的值排列在较长的值之前</span><br><span class="line">BIT</span><br><span class="line">  与<span class="type">BLOB</span>相同的规则</span><br><span class="line">OPAQUE</span><br><span class="line">  与<span class="type">BLOB</span>相同的规则。OPAQUE值是未分类为其他类型之一的值</span><br><span class="line">DATETIME</span><br><span class="line">  表示较早时间点的值在表示较晚时间点的数值之前排序。如果两个值最初分别来自MySQL DATETIME和<span class="type">TIMESTAMP</span>类型，那么如果它们表示相同的时间点，则它们是相等的。</span><br><span class="line"><span class="type">TIME</span></span><br><span class="line">  两个时间值中较小的一个按顺序排列在较大的一个之前。</span><br><span class="line"><span class="type">DATE</span></span><br><span class="line">  较早的日期在最近的日期之前排序。</span><br><span class="line"><span class="type">BOOLEAN</span></span><br><span class="line">  <span class="literal">false</span> 比 <span class="literal">true</span> 小</span><br><span class="line"><span class="keyword">ARRAY</span></span><br><span class="line">  <span class="number">2</span>个数组如果他们的长度和元素顺序都相同。则相等。否则则有存在差异的第一个元素的大小为准。首先以该位置较小的那个数组排在前面。如果一个较短的数组所有值与较长的数组的前N个相同。则较短的排在前面</span><br><span class="line">OBJECT</span><br><span class="line">  <span class="number">2</span>个对象具有相同的key 并且key 对应的值相同。则<span class="number">2</span>个对象相等。<span class="number">2</span>个不相等的对象其排序具有不确定性</span><br><span class="line">STRING</span><br><span class="line">  字符串在被比较的两个字符串的utf8mb4表示的前N个字节上按词法排序，其中N是较短字符串的长度。如果两个字符串的前N个字节相同，则认为较短的字符串小于较长的字符串。</span><br><span class="line"><span class="type">INTEGER</span>, <span class="keyword">DOUBLE</span></span><br><span class="line">  如果是mysql 内置的数值型类型则按数值型的排序方式。如果无法确定其类型。mysql将其转化为精准的数值型再进行比较</span><br><span class="line"><span class="keyword">NULL</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>json</tag>
      </tags>
  </entry>
  <entry>
    <title>MySql 插件安装</title>
    <url>/2022/11/08/mysqlPlugIn/</url>
    <content><![CDATA[<h3 id="首先来认识几个插件相关参数"><a href="#首先来认识几个插件相关参数" class="headerlink" title="首先来认识几个插件相关参数"></a>首先来认识几个插件相关参数</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">plugin_dir 指定插件so 文件存放的目录 mysql 5.7 自带的插件目录在 /usr/local/mysql/lib/plugin 里面</span><br><span class="line">           plugin_dir = /usr/local/mysql/lib/plugin</span><br><span class="line"></span><br><span class="line">plugin_name 要调用的插件的名称，默认情况下，服务器启动将会在mysql.plugin系统表中插件逐个加载，也可以通</span><br><span class="line">            过这个参数来改变这个行为</span><br><span class="line">            plugin_name = [OFF | ON | FORCE | FORCE_PLUS_PERMANENT]</span><br><span class="line">            OFF: 禁用插件 。可能某些内置插件不再此禁用之列，比如 mysql_native_password</span><br><span class="line">            ON ： 启用插件，如果启用失败。则禁用插件</span><br><span class="line">            FORCE：启用插件，如果启用失败，则数据库也停止启动。</span><br><span class="line">            FORCE_PLUS_PERMANENT：启用插件。比 FORCE 多了一个在运行过程中禁止卸载插件。如果用户执行卸载插件则报错</span><br><span class="line"></span><br><span class="line">plugin-load 告诉服务器在启动内置插件和存储引擎后启动指定的插件</span><br><span class="line">            plugin-load=<span class="string">&quot;connection_control.so&quot;</span></span><br><span class="line"></span><br><span class="line">plugin-load-add  告诉服务器在启动内置插件和存储引擎后启动指定的插件</span><br><span class="line">            plugin-load-add=<span class="string">&quot;connection_control.so&quot;</span></span><br><span class="line">early-plugin-load 告诉服务器在启动内置插件和存储引擎前启动指定插件</span><br><span class="line">            early-plugin-load=<span class="string">&quot;someplugin.so&quot;</span></span><br><span class="line"></span><br><span class="line">plugin-load 和 plugin-load-add 的区别是，plugin-load 在多实例环境下。配置多个plugin-load 最终取最后一个plugin-load的值,</span><br><span class="line">plugin-load-add 则是叠加作用。最终启动所有plugin-load-add 启动的多个插件</span><br><span class="line">--plugin-load=x --plugin-load-add=y</span><br><span class="line">等效于</span><br><span class="line">--plugin-load-add=x --plugin-load-add=y</span><br><span class="line">等效于</span><br><span class="line">--plugin-load=<span class="string">&quot;x;y&quot;</span></span><br><span class="line"></span><br><span class="line">当启用了skip-grant-tables ，则内置mysql.plugin 会被跳过，不启动内置插件。但是通过 plugin-load 、plugin-load-add 、early-plugin-load</span><br><span class="line">则会被加载。</span><br></pre></td></tr></table></figure>
<h3 id="通过命令来加载插件"><a href="#通过命令来加载插件" class="headerlink" title="通过命令来加载插件"></a>通过命令来加载插件</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 首要条件 plugin_dir 要指向存放插件so 文件的目录。</span><br><span class="line">[mysqld]</span><br><span class="line">plugin<span class="operator">-</span>load<span class="operator">-</span><span class="keyword">add</span><span class="operator">=</span>myplugin<span class="operator">=</span>somepluglib.so</span><br><span class="line"></span><br><span class="line">等价于</span><br><span class="line">INSTALL PLUGIN myplugin SONAME <span class="string">&#x27;somepluglib.so&#x27;</span>;</span><br><span class="line"></span><br><span class="line">通过INSTALL PLUGIN 命令可以在线加载已经存放在 plugin_dir 中的插件。</span><br><span class="line">通过INSTALL PLUGIN 命令会使加载的插件写入mysql.plugin.导致插件永久注册。因为它要确保在下一次重启时会加载到该插件</span><br><span class="line">对于那些必须在数据库启动初始化阶段必须加载的插件，则不能通过INSTALL PLUGUN 来注册，会报错</span><br><span class="line">ERROR <span class="number">1721</span> (HY000): Plugin <span class="string">&#x27;myplugin&#x27;</span> <span class="keyword">is</span> marked <span class="keyword">as</span> <span class="keyword">not</span> dynamically</span><br><span class="line">installable. You have <span class="keyword">to</span> stop the server <span class="keyword">to</span> install it.</span><br><span class="line">这种情况的插件则需要通过 plugin<span class="operator">-</span>load plugin<span class="operator">-</span>load<span class="operator">-</span><span class="keyword">add</span>  early<span class="operator">-</span>plugin<span class="operator">-</span>load 来加载</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="卸载插件"><a href="#卸载插件" class="headerlink" title="卸载插件"></a>卸载插件</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">UNINSTALL PLUGIN 命令可以在运行时卸载 INSTALL PLUGIN 加载的插件或者通过plugin<span class="operator">-</span>load 的插件，除以下两种情况</span><br><span class="line"><span class="number">1.</span> 不能卸载内置插件。那些在information_schema.plugin 或者 <span class="keyword">show</span> plugins 结果中 Library 列展示为<span class="keyword">NULL</span> 的插件</span><br><span class="line"><span class="number">2.</span> 当 plugin_name 设置了 FORCE_PLUS_PERMANENT 值，这是不允许删除插件的</span><br><span class="line"></span><br><span class="line">对应那些配置了plugin<span class="operator">-</span>load 的插件则最终移除需要在配置文件中去除指定的插件，然后重启服务器。</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>plugin</tag>
        <tag>security</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql数据库服务器调优</title>
    <url>/2023/03/30/mysqlServerTun/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>centos7</tag>
        <tag>server</tag>
      </tags>
  </entry>
  <entry>
    <title>docker 安装mysql</title>
    <url>/2023/03/08/mysqlindocker/</url>
    <content><![CDATA[<h3 id="下载安装docker"><a href="#下载安装docker" class="headerlink" title="下载安装docker"></a>下载安装docker</h3><p>执行如下命令。等待安装完成<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br></pre></td></tr></table></figure></p>
<h3 id="拉取mysql-镜像"><a href="#拉取mysql-镜像" class="headerlink" title="拉取mysql 镜像"></a>拉取mysql 镜像</h3><p>看mysql 官方文档使用的是 mysql/mysql-server:tag 的版本。那我们就下载这个版本<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull mysql/mysql-server:8.0</span><br><span class="line"></span><br><span class="line">docker images</span><br><span class="line">[root@localhost mysql8_data]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY           TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">mysql                latest    4f06b49211c0   12 days ago   530MB</span><br><span class="line">mysql/mysql-server   8.0       1d9c2219ff69   7 weeks ago   496MB</span><br></pre></td></tr></table></figure></p>
<h3 id="启动镜像并进行相关检查"><a href="#启动镜像并进行相关检查" class="headerlink" title="启动镜像并进行相关检查"></a>启动镜像并进行相关检查</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --name mysql8-1 --restart on-failure -d mysql/mysql-server:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看正在运行的container</span></span><br><span class="line">docker ps</span><br><span class="line">[root@localhost mysql8_data]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS                    PORTS                                                        NAMES</span><br><span class="line">ac42ef0a7b2c   mysql/mysql-server:8.0   <span class="string">&quot;/entrypoint.sh mysq…&quot;</span>   33 minutes ago   Up 16 minutes (healthy)   0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060-33061/tcp   mysql8-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据库的日志</span></span><br><span class="line">docker logs mysql8-1 2&gt;&amp;1 | grep GENERATED</span><br><span class="line">GENERATED ROOT PASSWORD: Axegh3kAJyDLaRuBemecis&amp;EShOs</span><br><span class="line"></span><br><span class="line"><span class="comment">#登录mysql</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql8-1 mysql -uroot -p </span><br><span class="line"><span class="comment">#修改密码</span></span><br><span class="line">mysql&gt; ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;password&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>到此。一个简单的mysql 实例就被挂起来了<br>将mysql 的配置文件复制出来看看<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> mysql8-1:/etc/my.cnf ./</span><br><span class="line">里面只有几个很简单的参数 </span><br><span class="line"></span><br><span class="line"><span class="comment">#登录docker container 查看mysql 的文件</span></span><br><span class="line">docker <span class="built_in">exec</span> it mysql8-1 bash</span><br><span class="line">bash-4.4<span class="comment"># cd /var/lib/mysql </span></span><br><span class="line">bash-4.4<span class="comment"># ls</span></span><br><span class="line"><span class="string">&#x27;#ib_16384_0.dblwr&#x27;</span>   auto.cnf          dbindocker       mysql-bin.000001   mysql.ibd            public_key.pem    undo_002</span><br><span class="line"><span class="string">&#x27;#ib_16384_1.dblwr&#x27;</span>   ca-key.pem        ib_buffer_pool   mysql-bin.000002   mysql.sock           server-cert.pem</span><br><span class="line"><span class="string">&#x27;#innodb_redo&#x27;</span>        ca.pem            ibdata1          mysql-bin.000003   mysql.sock.lock      server-key.pem</span><br><span class="line"><span class="string">&#x27;#innodb_temp&#x27;</span>        client-cert.pem   ibtmp1           mysql-bin.000004   performance_schema   sys</span><br><span class="line"> ac42ef0a7b2c.pid     client-key.pem    mysql            mysql-bin.index    private_key.pem      undo_001</span><br></pre></td></tr></table></figure><br>到目前为止。一个mysql实例就成功跑起来了。不过，数据什么的都在container 里面。这在生产上绝对是不符合的</p>
<h3 id="将数据文件映射到宿主机上"><a href="#将数据文件映射到宿主机上" class="headerlink" title="将数据文件映射到宿主机上"></a>将数据文件映射到宿主机上</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#停掉并删除刚才启动的container</span></span><br><span class="line">docker stop mysql8-1</span><br><span class="line">docker <span class="built_in">rm</span> mysql8-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#在本地建好路径</span></span><br><span class="line"><span class="built_in">mkdir</span> /data/mysql8_data</span><br><span class="line"><span class="built_in">mkdir</span> /data/mysql8_data/&#123;<span class="built_in">log</span>,conf,data&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑一个my.cnf 放 /data/mysql8_data/conf/my.cnf</span></span><br><span class="line"><span class="comment"># 不能让mysql8_data 成为数据库目录。初始化时会检查到存在文件。会初始化失败</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新拉起一个container</span></span><br><span class="line">docker run -p 3306:3306 --name mysql8-1 \ <span class="comment">##映射端口 跟给container 取个名字</span></span><br><span class="line">-v /data/mysql8_data/log:/var/log/mysql \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 日志</span></span><br><span class="line">-v /data/mysql8_data:/var/lib/mysql \  <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 数据目录</span></span><br><span class="line">-v /data/mysql8_data/conf/my.cnf:/etc/my.cnf \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 配置文件</span></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root123 \  <span class="comment">## -e 环境变量.初始化时设置数据库的root 密码</span></span><br><span class="line">-d mysql/mysql-server:8.0   <span class="comment">## 指定镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志。可以看到初始化的日志</span></span><br><span class="line">docker logs mysql8-1 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器进程</span></span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS                    PORTS                                                        NAMES</span><br><span class="line">ac42ef0a7b2c   mysql/mysql-server:8.0   <span class="string">&quot;/entrypoint.sh mysq…&quot;</span>   33 minutes ago   Up 16 minutes (healthy)   0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060-33061/tcp   mysql8-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#登录mysql</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql8-1 mysql -uroot -proot123</span><br><span class="line"></span><br><span class="line">root 用户只适用于本地登录</span><br><span class="line"></span><br><span class="line">可以进入数据库建立一个远程登录用户</span><br><span class="line"></span><br><span class="line"><span class="comment">#看回刚才挂载的目录，里面已经产生各种数据文件</span></span><br><span class="line"><span class="built_in">cd</span> /data/mysql8_data/data </span><br><span class="line"></span><br><span class="line"><span class="comment">#使用dbeaver 远程登录</span></span><br><span class="line">报错:Public Key Retrieval is not allowed</span><br><span class="line">需修改连接配置 --》 驱动属性 --》 allowPublicKeyRetrieval 更改为<span class="literal">true</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次登录成功</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle 12c 设置开机启动</title>
    <url>/2023/03/09/o12cstartup/</url>
    <content><![CDATA[<p>1.编辑 /etc/oratab  默认值是N 修改为Y<br>orcl:/data/oracle/product/12.2.0/db_1:Y</p>
<p>2.编辑 vi $ORACLE_HOME/bin/dbstart<br>将ORACLE_HOME_LISTNER=$1修改成 ORACLE_HOME_LISTNER=$ORACLE_HOME</p>
<p>3.在 /etc/rc.d/rc.local 添加 。这个启动包含 listener 启动<br>su - oracle -lc /data/oracle/product/12.2.0/db_1/bin/dbstart</p>
<p>4.启动时 只是启动实例。需要再将PDB 打开，可以通过trigger 设置自动打开所有pdb</p>
<p>在sqlplus / as sysdba</p>
<p>create trigger open_all_pdbs<br>AFTER STARTUP<br>ON DATABASE<br>BEGIN<br>  EXECUTE IMMEDIATE ‘alter pluggable database all open’;<br>end open_all_pdbs;<br>/<br>执行</p>
]]></content>
      <categories>
        <category>oracle</category>
      </categories>
      <tags>
        <tag>startup</tag>
      </tags>
  </entry>
  <entry>
    <title>日志报错:oldest xmin is far in the past</title>
    <url>/2022/11/01/oldestxmin/</url>
    <content><![CDATA[<p>今天巡检RDS postgresql 上的日志，发现错误日志里面一直报错<br><img src="/images/16672725934495.png" alt="errorlog">   </p>
<p>oldest xmin is far in the past<br>首先考虑到的是有长事务没有关闭导致autovacuum不能推进oldest xmin。<br>于是先查下有没idle in transaction 事务<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_stat_activity <span class="keyword">where</span> state<span class="operator">=</span><span class="string">&#x27;idle in transaction&#x27;</span></span><br></pre></td></tr></table></figure><br>发现并没有这样的transaction</p>
<p>那么是有事务在准备阶段没有关闭吗<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_prepared_xacts;</span><br></pre></td></tr></table></figure><br>发现也没有结果</p>
<p>出现这种情况的还有另一种可能。就是存在已经没有使用的复制槽</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_replication_slots;</span><br></pre></td></tr></table></figure>
<p>一看，果然有2条记录<br>经过一番询问，原来是好几个月前开发需要开DTS同步数据做数据集聚，但是项目已经停了好久。这边也没收到<br>通知。就这样落下了2个复制槽一直没有释放。由于长时间没用应用导致出现auto vacuum 的时候出错了</p>
<p>既然已经找到问题。那就把这2个没用的复制槽删掉吧<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_drop_replication_slot(<span class="string">&#x27;di_slot_2783&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> pg_drop_replication_slot(<span class="string">&#x27;di_slot_2785&#x27;</span>);</span><br></pre></td></tr></table></figure><br>过1分分钟重新查看日志。可以看到已经没报错vacumm 也执行过去了。oldest xmin: 662582680 达到6亿多<br><img src="/images/16672751408080.png" alt="resultpic"></p>
]]></content>
      <categories>
        <category>postgresql</category>
      </categories>
      <tags>
        <tag>error log</tag>
        <tag>vacuum</tag>
      </tags>
  </entry>
  <entry>
    <title>PG系统表之 pg_class</title>
    <url>/2023/03/28/pgclass/</url>
    <content><![CDATA[<p>pg_class 表记录了数据库中几乎所有的关系(relations)：包括表、索引、视图、物化视图、组合类型和TOAST表</p>
<h5 id="pg-class"><a href="#pg-class" class="headerlink" title="pg_class"></a>pg_class</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">oid oid </span><br><span class="line">   行标识</span><br><span class="line">relname name</span><br><span class="line">    关系名称,例如表名，索引名。视图名等</span><br><span class="line">relnamespace oid  (<span class="keyword">references</span> pg_namespace.oid)</span><br><span class="line">    包含这个关系的命名空间的 oid</span><br><span class="line">reltype oid (<span class="keyword">references</span> pg_type.oid)</span><br><span class="line">    表的类型。其他关系都用 <span class="number">0</span> 标识</span><br><span class="line">relowner oid (<span class="keyword">references</span> pg_authid.oid)</span><br><span class="line">    关系所有者</span><br><span class="line">relam oid (<span class="keyword">references</span> pg_am.oid)</span><br><span class="line">    如果是表或索引，表示使用的访问方法(堆、B树、哈希等),否则为<span class="number">0</span>(序列和视图等不需要存储的关系)，</span><br><span class="line">relfilenode oid</span><br><span class="line">    这个关系在磁盘上文件的名称;<span class="number">0</span>表示这是一个“映射”关系，其磁盘文件名取决于低层状态</span><br><span class="line">reltablespace oid (<span class="keyword">references</span> pg_tablespace.oid)</span><br><span class="line">    该关系所存储的表空间。如果为<span class="number">0</span>，使用数据库的默认表空间。(如果关系无磁盘文件时无意义)</span><br><span class="line">relpages int4</span><br><span class="line">    表示这个表以页为统计的大小。这个只是执行计划使用的预估值，由 VACUUM, ANALYZE 还有少量由DDL 操作(例如 <span class="keyword">create</span> index) 更新</span><br><span class="line">reltuples float4</span><br><span class="line">    表示表中活动的行数。这个只是执行计划使用的预估值，由 VACUUM, ANALYZE 还有少量由DDL 操作(例如 <span class="keyword">create</span> index) 更新，如果表没发生过vacuumed 或 analyzed 则标记为<span class="number">-1</span> 表示未知行数</span><br><span class="line">relallvisible int4</span><br><span class="line">    在表的可见性映射表中被标记为全可见的页数。这个只是执行计划使用的预估值。由 VACUUM, ANALYZE 还有少量由DDL 操作(例如 <span class="keyword">create</span> index) 更新。</span><br><span class="line">reltoastrelid oid (<span class="keyword">references</span> pg_class.oid)</span><br><span class="line">    与该表关联的TOAST表的 oid ,如果没有用<span class="number">0</span>表示，对于超长的行数据（默认<span class="number">8</span>kb一页，页是PG中最基本的存储单位），PG 将数据存储在另一张二级表的多行中。这张表就叫TOAST表，这张存储方式叫行外存储方式</span><br><span class="line">relhasindex bool</span><br><span class="line">    如果这是一个表并且其上建有（或最近建有）索引则为真</span><br><span class="line">relisshared bool</span><br><span class="line">    如果该表在集簇中的所有数据库间共享则为真。只有某些系统目录（如pg_database）是共享的</span><br><span class="line">relpersistence <span class="type">char</span></span><br><span class="line">    P <span class="operator">=</span> 永久表<span class="operator">/</span>序列 u <span class="operator">=</span> 无日志表<span class="operator">/</span>序列 t <span class="operator">=</span> 临时表<span class="operator">/</span>序列</span><br><span class="line">relkind <span class="type">char</span></span><br><span class="line">    r <span class="operator">=</span> 普通表, i <span class="operator">=</span> 索引, S <span class="operator">=</span> 序列, t <span class="operator">=</span> TOAST 表, v <span class="operator">=</span> 视图, m <span class="operator">=</span> 物化视图, c <span class="operator">=</span> 组合类型, f <span class="operator">=</span> 外部表, p <span class="operator">=</span> 分区表, I <span class="operator">=</span> 分区索引</span><br><span class="line">relnatts int2</span><br><span class="line">    关系中用户列的数目（系统列不计算在内）。在pg_attribute中必须有这么多对应的项。另请参阅pg_attribute.attnum。</span><br><span class="line">relchecks int2</span><br><span class="line">    表上的约束数，参见 pg_constraint</span><br><span class="line">relhasrules bool</span><br><span class="line">    如果表有（或曾有）规则则为真，参见 pg_rewrite</span><br><span class="line">relhastriggers bool</span><br><span class="line">    如果表有（或曾有）触发器则为真，参见 pg_trigger</span><br><span class="line">relhassubclass bool</span><br><span class="line">    如果表或索引有（或曾有）任何继承的子女或分区则为真</span><br><span class="line">relrowsecurity bool</span><br><span class="line">    如果表有启用行级别的安全策略则为真，参见 pg_policy </span><br><span class="line">relforcerowsecurity bool</span><br><span class="line">    如果行级安全策略（启用时）也适用于表拥有者则为真，参见 pg_policy</span><br><span class="line">relispopulated bool</span><br><span class="line">    如果表已被填充则为真（对于所有关系该列都为真，但对于某些物化视图却不是）</span><br><span class="line">relreplident <span class="type">char</span></span><br><span class="line">    用来形成复制标志的列， 对于行，d <span class="operator">=</span> 默认值(主键，如果有) , n <span class="operator">=</span> 无， f <span class="operator">=</span> 所有列 ，i <span class="operator">=</span> 索引</span><br><span class="line">relispartition bool</span><br><span class="line">    如果表或索引为分区表<span class="operator">/</span>索引,则为真</span><br><span class="line">relrewrite oid (<span class="keyword">references</span> pg_class.oid)</span><br><span class="line">    对于在要求表重写的DDL操作期间被写入的新关系，这个域包含原始关系的OID，否则为<span class="number">0</span>。那种状态仅在内部可见，对于一个用户可见的关系这个域应该从不包含不是<span class="number">0</span>的值。</span><br><span class="line">relfrozenxid xid</span><br><span class="line">    在此之前的所有事务ID在表中已经被替换为一个永久的(“冻结的”) 事务ID。这用于跟踪表是否需要被清理，以便阻止事务ID回卷或者允许pg_xact被收缩。如果该关系不是一个表则为<span class="number">0</span>（InvalidTransactionId）。</span><br><span class="line">relminmxid xid</span><br><span class="line">    在此之前的多事务ID在表中已经被替换为一个事务ID。这被用于跟踪表是否需要被清理，以阻止 多事务ID回卷或者允许pg_multixact被收缩。如果关系不是一个表则 为<span class="number">0</span>（InvalidMultiXactId）。</span><br><span class="line">relacl aclitem[]</span><br><span class="line">    访问权限</span><br><span class="line">reloptions text[]</span><br><span class="line">    访问方法相关的选项，以“keyword<span class="operator">=</span><span class="keyword">value</span>”字符串形式</span><br><span class="line">relpartbound pg_node_tree</span><br><span class="line">    如果表示一个分区（见relispartition），分区边界的内部表达</span><br></pre></td></tr></table></figure>
<h5 id="pg-depend"><a href="#pg-depend" class="headerlink" title="pg_depend"></a>pg_depend</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">classid oid (<span class="keyword">references</span> pg_class.oid)</span><br><span class="line">    依赖对象所在的系统目录OID</span><br><span class="line">objid oid (<span class="keyword">references</span> <span class="keyword">any</span> OID <span class="keyword">column</span>) 任意列的OID</span><br><span class="line">    指定依赖对象的OID</span><br><span class="line">objsubid int4</span><br><span class="line">    对于一个表列，这里是列号（objid和classid指表本身）。对于所有其他对象类型，此列为<span class="number">0</span>。</span><br><span class="line">refclassid oid (<span class="keyword">references</span> pg_class.oid)</span><br><span class="line">    被引用对象所在的系统目录的OID</span><br><span class="line">refobjid oid (<span class="keyword">references</span> <span class="keyword">any</span> OID <span class="keyword">column</span>) 任意列的OID</span><br><span class="line">    指定被引用对象的OID</span><br><span class="line">refobjsubid int4</span><br><span class="line">    对于一个被引用的表列，这里是列号（objid和classid指表本身）。对于所有其他对象类型，此列为<span class="number">0</span>。</span><br><span class="line">deptype <span class="type">char</span></span><br><span class="line">    n : DEPENDENCY_NORMAL </span><br><span class="line">        在独立创建的对象之间的一个普通关系。依赖对象可以在不影响被依赖对象的情况下被删除。被引用对象只能通过指定CASCADE被删除，在这种情况下依赖对象也会被删除. 例如一个表引用了一个序列做自增。删除表不影响序列。删除序列则需要指定 cascade 连表一起删除</span><br><span class="line">    a : DEPENDENCY_AUTO </span><br><span class="line">        依赖对象可以被独立于被依赖对象删除，且应该在被引用对象被删除时自动被删除（不管在RESTRICT或CASCADE模式）。例如表上的约束。表删了。约束也跟着消失</span><br><span class="line">    i ：DEPENDENCY_INTERNAL </span><br><span class="line">        依赖对象作为被引用对象创建过程的一部分被创建，并且只是其内部实现的一部分。不允许直接<span class="keyword">DROP</span>所依赖的对象（而是告诉用户对引用对象发出<span class="keyword">DROP</span>操作）。无论是否指定了CASCADE，<span class="keyword">DROP</span>被引用的对象都将导致自动删除从属对象。如果由于删除了对某些其他对象的依赖关系而不得不删除依赖对象，则其删除将转换为对所引用对象的删除，因此依赖对象的NORMAL和AUTO依赖关系的行为就像它们是所引用对象的依赖关系。示例：视图的<span class="keyword">ON</span> <span class="keyword">SELECT</span>规则使其在内部依赖于视图，以防止在视图保留时将其删除。规则的依赖关系（例如它引用的表）就好像他们是视图的依赖关系</span><br><span class="line">    P ：DEPENDENCY_PARTITION_PRI</span><br><span class="line">    S : DEPENDENCY_PARTITION_SEC</span><br><span class="line">        依赖对象被作为被引用对象创建过程的一部分创建，并且确实是其内部实现的一部分。但是，不像INTERNAL，有多个这样的引用对象。除非删除了这些引用对象中的至少一个对象，否则不得删除依赖对象；如果其中任何一个被删除，则不管是否指定了CASCADE，都应删除依赖对象。也不像INTERNAL，依赖对象所依赖的某些其他对象的删除不会导致任何分区引用的对象的自动删除。因此，如果删除没有通过其他路径级联到这些对象中的至少一个，它会被拒绝。（大多数情况下，依赖对象与至少一个分区引用对象共享所有非分区的依赖关系，因此此限制不会导致阻止任何级联的删除。）主分区和辅助分区的依赖关系表现相同，除了主分区依赖关系倾向用于错误消息；因此，分区相关的对象应该有一个主分区依赖关系和一个或多个辅助分区依赖关系。注意到分区依赖关系是任何对象所正常拥有的依赖关系的补充，而不是替代。这简化了ATTACH<span class="operator">/</span>DETACH <span class="keyword">PARTITION</span>操作：只要添加或删除分区的依赖关系。例如：子分区索引与其所基于的分区表和父分区索引是分区相关的，因此只要其中一个删除，则子分区索引就消失，否则，就不消失。父索引上的依赖关系是主要的，故如果用户试图删除子分区索引，错误消息反而会建议删除父索引（不是表）</span><br><span class="line">    e : DEPENDENCY_EXTENSION </span><br><span class="line">        依赖对象是作为扩展的被引用对象的一个成员（参见pg_extension）。依赖对象可以通过被引用对象上的<span class="keyword">DROP</span> EXTENSION来删除。在功能上，这种依赖类型和一个INTERNAL依赖的作用相同，其存在只是为了清晰和简化pg_dump</span><br><span class="line">    x : DEPENDENCY_AUTO_EXTENSION</span><br><span class="line">        依赖对象不是作为被引用对象的扩展的成员（因此不应该被pg_dump忽略），但是没有该扩展它又无法工作，因此如果删除了扩展，则该依赖对象应自动删除。该依赖对象也可以独立删除。功能上，该依赖关系类型与AUTO依赖相同，但是为了清晰起见和简化pg_dump，将其分开</span><br><span class="line">    p : DEPENDENCY_PIN</span><br><span class="line">        没有依赖对象，这种类型的项是一个信号，用于说明系统本身依赖于被引用对象，并且该对象永远不能被删除。这种类型的项只能被initdb创建。而此种项的依赖对象的列都为<span class="number">0</span></span><br></pre></td></tr></table></figure>
<h4 id="查询序列与表的依赖关系"><a href="#查询序列与表的依赖关系" class="headerlink" title="查询序列与表的依赖关系"></a>查询序列与表的依赖关系</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ts.nspname <span class="keyword">as</span> object_schema,</span><br><span class="line">        tbl.relname <span class="keyword">as</span> table_name, </span><br><span class="line">       col.attname <span class="keyword">as</span> column_name,</span><br><span class="line">       s.relname   <span class="keyword">as</span> sequence_name,</span><br><span class="line">	   d.refobjid,d.objid</span><br><span class="line"><span class="keyword">from</span> pg_class s</span><br><span class="line">  <span class="keyword">join</span> pg_namespace sn <span class="keyword">on</span> sn.oid <span class="operator">=</span> s.relnamespace </span><br><span class="line">  <span class="keyword">join</span> pg_depend d <span class="keyword">on</span> d.refobjid <span class="operator">=</span> s.oid  <span class="keyword">and</span> d.refclassid<span class="operator">=</span><span class="string">&#x27;pg_class&#x27;</span>::regclass </span><br><span class="line">  <span class="keyword">join</span> pg_attrdef ad <span class="keyword">on</span> ad.oid <span class="operator">=</span> d.objid  <span class="keyword">and</span> d.classid <span class="operator">=</span> <span class="string">&#x27;pg_attrdef&#x27;</span>::regclass</span><br><span class="line">  <span class="keyword">join</span> pg_attribute col <span class="keyword">on</span> col.attrelid <span class="operator">=</span> ad.adrelid <span class="keyword">and</span> col.attnum <span class="operator">=</span> ad.adnum</span><br><span class="line">  <span class="keyword">join</span> pg_class tbl <span class="keyword">on</span> tbl.oid <span class="operator">=</span> ad.adrelid </span><br><span class="line">  <span class="keyword">join</span> pg_namespace ts <span class="keyword">on</span> ts.oid <span class="operator">=</span> tbl.relnamespace </span><br><span class="line"><span class="keyword">where</span> s.relkind <span class="operator">=</span> <span class="string">&#x27;S&#x27;</span></span><br><span class="line"><span class="comment">--  and s.relname = &#x27;sequence_name&#x27;</span></span><br><span class="line">  <span class="keyword">and</span> d.deptype <span class="keyword">in</span> (<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;n&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="查询表的schema-owner"><a href="#查询表的schema-owner" class="headerlink" title="查询表的schema,owner"></a>查询表的schema,owner</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> pc.relname <span class="keyword">as</span> table_name,pn.nspname <span class="keyword">as</span> schema_name,pa.rolname <span class="keyword">as</span> owner,pc.relhasindex,pc.relhastriggers</span><br><span class="line">  <span class="keyword">from</span> pg_class pc,</span><br><span class="line">       pg_namespace pn,</span><br><span class="line">	   pg_authid pa</span><br><span class="line">  <span class="keyword">where</span> pc.relkind <span class="operator">=</span><span class="string">&#x27;r&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> pc.relnamespace <span class="operator">=</span> pn.oid</span><br><span class="line">	<span class="keyword">and</span> pc.relowner <span class="operator">=</span> pa.oid</span><br><span class="line">    <span class="keyword">and</span> pc.relname <span class="operator">=</span> <span class="string">&#x27;table_name&#x27;</span></span><br><span class="line"></span><br><span class="line">可以查到与 pg_tables 类似的结果</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>postgresql</category>
      </categories>
      <tags>
        <tag>pg_class</tag>
      </tags>
  </entry>
  <entry>
    <title>PG逻辑复制</title>
    <url>/2022/10/21/pgLogicalReplication/</url>
    <content><![CDATA[<h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h3><p>PG 逻辑复制在9.4 版本开始支持。只是那时使用逻辑复制是以扩展的方式使用，需要额外编译插件，从pg 10开始，<br>我们可以很简单的在数据库中直接创建publication 以及 subcription 的方式来使用逻辑复制。</p>
<h4 id="1-1-逻辑复制与物理复制的区别："><a href="#1-1-逻辑复制与物理复制的区别：" class="headerlink" title="1.1. 逻辑复制与物理复制的区别："></a>1.1. 逻辑复制与物理复制的区别：</h4><pre><code>逻辑复制是基于复制标识（通常是主键）复制数据以及变更的方法
物理复制是基于精确的数据块地址喝逐字节复制的方法
</code></pre><h4 id="1-2-逻辑复制的使用场景"><a href="#1-2-逻辑复制的使用场景" class="headerlink" title="1.2. 逻辑复制的使用场景"></a>1.2. 逻辑复制的使用场景</h4><pre><code>1.可以发送一个库或者一个子集的增量变更数据给订阅者
2.当个别变更到达订阅端时引动触发器
3.基于分析目的的将多个数据库的数据汇总到一个数据库
4.在不同数据库版本之间做复制(一般可用作数据库版本升级)
5.在不同平台的数据中做复制(例如linux 与 windows 之间的PG 的复制)
6.发送不同的数据给不同分组的人员
7.在不同数据库中共享一个子集
</code></pre><p>订阅数据库可以作为发布者创建发布给其他数据库做订阅。订阅数据一般只作为只读。如果对订阅对象写入，有可能会<br>引发冲突。</p>
<h3 id="2-发布"><a href="#2-发布" class="headerlink" title="2. 发布"></a>2. 发布</h3><p>发布可以在任何物理复制主机上创建,有定义发布的节点我们称为发布者。发布是记录一个表或者一组表变更的集合<br>（也称为复制集或者改变集），每一个发布只能存在一个数据库。</p>
<p>发布不同于模式(schema)，不影响表的访问形势。如果需要每个表可以存在于多个发布中，发布目前只能包含表或者模式<br>中的所有表，必须显式添加到发布中。除非在创建发布时使用ALL tables 选项</p>
<p>Publication可以选择把它们产生的更改限制为INSERT、UPDATE、DELETE以及TRUNCATE的任意组合，类似于触发器如何<br>被特定事件类型触发的方式。默认情况下，所有操作类型都会被复制</p>
<p>每一个发布表都有一个复制标识，一般是主键，或者是唯一键，如果都没有那么将标识为full ，即整行作为复制标识</p>
<h4 id="2-1-创建发布"><a href="#2-1-创建发布" class="headerlink" title="2.1. 创建发布"></a>2.1. 创建发布</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span><span class="operator">+</span> 版本</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION name</span><br><span class="line">    [ <span class="keyword">FOR</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">      <span class="operator">|</span> <span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES ]</span><br><span class="line">    [ <span class="keyword">WITH</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"></span><br><span class="line"><span class="number">15</span><span class="operator">+</span> 版本   </span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION name</span><br><span class="line">    [ <span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES</span><br><span class="line">      <span class="operator">|</span> <span class="keyword">FOR</span> publication_object [, ... ] ]</span><br><span class="line">    [ <span class="keyword">WITH</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">where</span> publication_object <span class="keyword">is</span> <span class="keyword">one</span> <span class="keyword">of</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [ ( column_name [, ... ] ) ] [ <span class="keyword">WHERE</span> ( expression ) ] [, ... ]</span><br><span class="line">    TABLES <span class="keyword">IN</span> SCHEMA &#123; schema_name <span class="operator">|</span> <span class="built_in">CURRENT_SCHEMA</span> &#125; [, ... ]</span><br><span class="line"></span><br><span class="line">释义</span><br><span class="line">name </span><br><span class="line">    发布名</span><br><span class="line"></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">TABLE</span> </span><br><span class="line">    指定要被添加到发布的表列表，如果指定<span class="keyword">ONLY</span> 则只有<span class="keyword">ONLY</span> 后面那个表添加进去,没有指定则列表全部添加。</span><br><span class="line">    如果表名后加 <span class="operator">*</span> ，则这个表的所有派生表都将被添加（PG 存在表继承）,但分区表不适用，分区表的分区都会作为发布的一部分，不用在创建发布时指定。 </span><br><span class="line">    表名后面加 (列名,...) 只有指定的列会被发布，没有指定则发布表的所有字段，包含以后新建的所有字段。</span><br><span class="line">    <span class="keyword">where</span> 表达式则是过滤满足条件的数据才会被发布</span><br><span class="line">    <span class="keyword">TABLE</span> <span class="keyword">IN</span> SCHEMA(<span class="number">15</span><span class="operator">+</span> 版本)，可以直接指定摸个模式下所有表添加，包含以后建的新表。相比<span class="keyword">ALL</span> TABLES ，复制粒度更小。更灵活</span><br><span class="line">    只有普通表，分区表(<span class="number">13</span><span class="operator">+</span> 版本)才能放在发布中,临时表，非日志记录表，外部表，物化视图，以及普通视图都不能放在发布中</span><br><span class="line"></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES </span><br><span class="line">    指定将数据库里是所有表都添加到发布中去。包含以后建的新表</span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">    publish (string) </span><br><span class="line">        指定限制发布DML，可以是  <span class="string">&#x27;insert, update, delete, truncate&#x27;</span> 的任意组合(<span class="keyword">truncate</span> <span class="number">11</span><span class="operator">+</span> 版本支持)，默认<span class="number">4</span>种全部发布</span><br><span class="line">    publish_via_partition_root (<span class="type">boolean</span>) (<span class="number">13</span><span class="operator">+</span> 版本) </span><br><span class="line">        这个参数决定当分区表或者在其分区上的变更是在模式中是使用一个标识还是那个变更的分区表做标识，默认是变更的分区表做标志,启用这个选项，将允许</span><br><span class="line">        分区表变更能被复制到同名的非分区表或分区表中。</span><br><span class="line">        当它被启用。作用于分区上的<span class="keyword">truncate</span> 操作将不会被复制</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">注意</span><br><span class="line">    如果 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> 或者 <span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES 没有设置，发布启动时带一个空表集，以后添加表时会添加到这个表集中</span><br><span class="line">    创建发布并没有马上启动复制。它只是为以后的订阅者定义了一个组和一些过滤逻辑</span><br><span class="line">    创建发布的用户必须在当前数据库中具备<span class="keyword">create</span> 权限 （super 用户会忽略这个检查）</span><br><span class="line">    将表添加到发布中，用户必须具备该表的所有权。<span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES 则要求用户具有SUPER权限</span><br><span class="line">    添加到发布<span class="keyword">UPDATE</span><span class="operator">/</span><span class="keyword">DELETE</span>操作的表必须已经定义了复制标识,否则将在这些标识禁用这些操作</span><br><span class="line">    对于<span class="keyword">insert</span> ... <span class="keyword">on</span> conflict命令，发布是以实际发生的数据变更发布的，因此根据结果。可能是<span class="keyword">insert</span> 也可能是<span class="keyword">update</span> 。也可能不发布</span><br><span class="line">    对于 <span class="keyword">copy</span> ... <span class="keyword">from</span> 命令是作为<span class="keyword">insert</span> 发布的</span><br><span class="line">    DDL 操作不发布</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">示例</span><br><span class="line">#创建一个发布,包含<span class="number">2</span>个表的变更</span><br><span class="line"><span class="keyword">create</span> publication my_pub <span class="keyword">for</span> <span class="keyword">table</span> table1,table2;</span><br><span class="line"></span><br><span class="line">#创建一个发布，包含所有报的变更</span><br><span class="line"><span class="keyword">create</span> publication my_pub <span class="keyword">for</span> <span class="keyword">all</span> tables;</span><br><span class="line"></span><br><span class="line">#创建一个发布，包含指定DML</span><br><span class="line"><span class="keyword">create</span> publication my_pub <span class="keyword">for</span> <span class="keyword">table</span> <span class="keyword">with</span> publish(<span class="string">&#x27;delete,update&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="2-2-修改发布"><a href="#2-2-修改发布" class="headerlink" title="2.2. 修改发布"></a>2.2. 修改发布</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">#为发布添加表</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">ADD</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">#替换发布中的表的列表</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">SET</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">#删除发布中的表</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">DROP</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">#修改发布中的发布属性</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">SET</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">#修改发布的所有者</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name OWNER <span class="keyword">TO</span> &#123; new_owner <span class="operator">|</span> <span class="built_in">CURRENT_USER</span> <span class="operator">|</span> <span class="built_in">SESSION_USER</span> &#125;</span><br><span class="line">#为发布重命名</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name RENAME <span class="keyword">TO</span> new_name</span><br><span class="line"></span><br><span class="line">## 示例</span><br><span class="line"><span class="keyword">alter</span> publicaiton my_pub <span class="keyword">set</span> (publish <span class="operator">=</span> <span class="string">&#x27;insert,update&#x27;</span>)</span><br><span class="line"><span class="keyword">alter</span> publication my_pub <span class="keyword">add</span> tab2,tab3;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-删除发布"><a href="#2-3-删除发布" class="headerlink" title="2.3. 删除发布"></a>2.3. 删除发布</h4><p>发布只能被发布的所有者及超级用户删除<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> PUBLICATION [ IF <span class="keyword">EXISTS</span> ] name [, ...] [ CASCADE <span class="operator">|</span> RESTRICT ]</span><br><span class="line"></span><br><span class="line">## 示例</span><br><span class="line"><span class="keyword">drop</span> publication my_pub;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-订阅"><a href="#3-订阅" class="headerlink" title="3. 订阅"></a>3. 订阅</h3><p>订阅位于逻辑复制的下游，创建有订阅的节点称为订阅者。订阅定义了与另一个数据库的连接以及需要订阅的的发布集（一个或多个发布）<br>订阅节点上可以有多个订阅，每一个订阅接收一个复制槽（replication slot）的数据变更。当初始化好同步表以前存在的数据时，可能额外需要多的复制槽。并且在同步结束后删除。<br>逻辑复制的订阅可作为同步复制的备用服务器，备用名默认为订阅名，可以在订阅的连接信息中用application_name指定一个可供选择的名称<br>创建订阅的用户需要super 权限，因为non-superusers不能读取pg_subscription的信息<br>create subscription 用于创建订阅 alter subscription 用于停止和复用订阅，drop subscription 则用于删除订阅。<br>当订阅被删除并重新创建时，同步信息将丢失，这意味着数据必须重新同步<br>模式定义不会被复制,发布的表必须在订阅端存在。<br>发布与订阅端的表必须同名。不支持不同名表订阅<br>发布与订阅端的表的字段名必须相同，订阅端表列的顺序不要求与发布端相同，列的数据类型也不需要一样，只要可以将数据的文本表示形式转换为目标类型即可。订阅端表列可以比发布端<br>多，多出的列将以订阅端表的定义默认值填充</p>
<h4 id="3-1-复制槽管理"><a href="#3-1-复制槽管理" class="headerlink" title="3.1 复制槽管理"></a>3.1 复制槽管理</h4><p>如上面说的。在表初始化开始同步数据时，会要求额外的复制槽—数据同步槽，数据同步槽又系统内部自动创建，并在不需要时自动<br>删除。数据同步槽名称为“pg<em>%u_sync</em>%u_%llu”，参数为：订阅oid, 表的relid,系统标识sysid<br>一般情况下。远端的复制槽的创建在订阅创建（create subscription）的时候创建，并且在删除订阅(drop subscription)的时候删除,在某些情况下有必要单独操纵订阅以及其底层的复制槽。</p>
<h5 id="下面是一些场景："><a href="#下面是一些场景：" class="headerlink" title="下面是一些场景："></a>下面是一些场景：</h5><pre><code>1.在创建一个订阅时，复制槽已经存在。在这种情况下，可以使用create_slot = false选项创建订阅并关联到现有的槽
2.在创建一个订阅时，远程主机不可达或者处于一种不明状态。在这种情况下，可以使用connect = false选项创建订阅。那么远程主机将根本不会被联系。
  这是pg_dump所使用的方式。这样，在订阅可以被激活之前，必须手工创建远程复制槽
3.在删除一个订阅时，复制槽应该被保留。当订阅者数据库正在被移动到一台不同的主机并且将从那里再被激活时，这种行为很有用。在这种情况下，可以在尝试删除该订阅之前，
  使用ALTER SUBSCRIPTION将复制槽解除关联
4.在删除一个订阅是，远程主机不可达。在这种情况下，可以在尝试删除该订阅之前，使用ALTER SUBSCRIPTION将复制槽解除关联。如果远程数据库实例不再存在，那么不需要进一步的行动。
  不过，如果远程数据库实例只是不可达，那么复制槽应该被手动删除。否则它将会继续保留WAL并且最终可能会导致磁盘被填满。这种情况应该要仔细地研究
</code></pre><h4 id="3-2-创建订阅"><a href="#3-2-创建订阅" class="headerlink" title="3.2 创建订阅"></a>3.2 创建订阅</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION subscription_name</span><br><span class="line">    CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line">    PUBLICATION publication_name [, ...]</span><br><span class="line">    [ <span class="keyword">WITH</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"></span><br><span class="line">subscription_name</span><br><span class="line">    订阅名</span><br><span class="line">CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line">    连接远端发布节点的连接串</span><br><span class="line">PUBLICATION publication_name</span><br><span class="line">    发布名称,可以指定多个发布名称。也即是一个订阅可以订阅多个发布</span><br><span class="line"><span class="keyword">WITH</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">    指定订阅相关参数</span><br><span class="line">    <span class="keyword">connect</span> (<span class="type">boolean</span>)</span><br><span class="line">        指定创建订阅时是否连接远程发布节点，默认<span class="literal">true</span>,设置为<span class="literal">false</span> ,会强制设置 create_slot , enabled , copy_data 这<span class="number">3</span>个参数值为 <span class="literal">false</span></span><br><span class="line">        当该参数设置为<span class="literal">false</span> ，没有表会被订阅，当enable 订阅时，不会发生任何复制，必须执行<span class="keyword">ALTER</span> SUBSCRIPTION ... REFRESH PUBLICATION 才能使表订阅生效</span><br><span class="line">    create_slot (<span class="type">boolean</span>) </span><br><span class="line">        指定是否在发布节点上创建复制槽，默认值<span class="literal">true</span>, 如果设置为<span class="literal">false</span> ,你将需要通过别的方法在发布节点上创建复制槽</span><br><span class="line">    enabled (<span class="type">boolean</span>) </span><br><span class="line">        指定订阅是否马上生效，默认 <span class="literal">true</span> ,设置<span class="literal">false</span> 则只是创建并没有让复制生效</span><br><span class="line">    slot_name (string)</span><br><span class="line">        指定发布节点上复制槽的名称，默认值是将订阅的名称当做复制槽的名称</span><br><span class="line">        设置为<span class="keyword">NONE</span> 将表示订阅不创建复制槽，当你想稍后手工创建复制槽可使用该选项。同时必须设置create_slot，slot_name 的值为<span class="literal">false</span></span><br><span class="line">    #下面的参数则是控制订阅创建后的行为：</span><br><span class="line">    <span class="type">binary</span> (<span class="type">boolean</span>) (<span class="number">14</span><span class="operator">+</span> 版本)</span><br><span class="line">        指定订阅是否要求发布者发送数据采用<span class="type">binary</span> 格式（相对应的是text），默认值为<span class="literal">false</span>,如果设置为<span class="literal">true</span>,也只有具有二进制发送和接收功能的数据类型才会以二进制形式传输。</span><br><span class="line">        在进行跨版本复制时，可能会因为发布者具有某种数据类型的二进制发送功能，而订阅者缺少该类型的二进制接收功能导致数据传输将失败，并且无法使用二进制选项。</span><br><span class="line">    copy_data (<span class="type">boolean</span>)</span><br><span class="line">        指定是否在订阅开始时同步发布表中已存在的数据，默认值为<span class="literal">true</span></span><br><span class="line">        如果创建发布时有指定<span class="keyword">where</span> 条件，则满足条件的数据才会被发布过来</span><br><span class="line">    streaming (<span class="type">boolean</span>) （<span class="number">14</span><span class="operator">+</span> 版本)</span><br><span class="line">        指定是否为订阅开启正在进行中的事务中进行流传输。默认情况下所有事务都在发布端解码。然后才整个完整的发布给订阅</span><br><span class="line">    synchronous_commit (enum)</span><br><span class="line">        该参数会覆盖系统参数 synchronous_commit</span><br><span class="line">        设置为off 对 逻辑复制是安全的：如果订阅因为缺少同步而丢失的事务。发布者将会从新发布</span><br><span class="line">        在进行同步逻辑复制时，逻辑复制worker 将持续向发布者报告写入和刷新的位置，发布者则等待实际的刷新，这意味着订阅端设置synchronous_commit<span class="operator">=</span>off 将会增加发布端<span class="keyword">commit</span> 的延迟，</span><br><span class="line">        这种情况下设置为<span class="keyword">local</span> 或更高级别将会更合适</span><br><span class="line">    two_phase (<span class="type">boolean</span>) (<span class="number">15</span><span class="operator">+</span> 版本)</span><br><span class="line">        指定订阅是否启用两阶段提交，默认值<span class="literal">false</span></span><br><span class="line">        当启用两阶段提交，准备好的事务将会在 <span class="keyword">prepare</span> tansaction 阶段时就传给订阅者，在订阅者上也当做<span class="number">2</span>阶段处理。否则准备好的事务只有在提交时才会发送给订阅者。然后由订阅者立即处理</span><br><span class="line">        两阶段提交的实现要求复制已成功完成初始表同步阶段。 因此，即使为订阅启用了 two_phase，内部的两阶段状态也会暂时保持“待定”，直到初始化阶段完成。 查看 pg_subscription 的 subtwophasestate 列，了解实际的两阶段状态</span><br><span class="line">    disable_on_error (<span class="type">boolean</span>)</span><br><span class="line">        指定如果订阅工作者在从发布者复制数据期间检测到任何错误，是否应自动禁用订阅。 默认为<span class="literal">false</span>      </span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">    #创建一个订阅，并且不马上激活</span><br><span class="line">    <span class="keyword">CREATE</span> SUBSCRIPTION mysub</span><br><span class="line">         CONNECTION <span class="string">&#x27;host=192.168.1.50 port=5432 user=foo dbname=foodb&#x27;</span></span><br><span class="line">        PUBLICATION insert_only</span><br><span class="line">               <span class="keyword">WITH</span> (enabled <span class="operator">=</span> <span class="literal">false</span>);</span><br><span class="line">    #创建一个有<span class="number">2</span>个发布的订阅</span><br><span class="line">    <span class="keyword">CREATE</span> SUBSCRIPTION mysub</span><br><span class="line">         CONNECTION <span class="string">&#x27;host=192.168.1.50 port=5432 user=foo dbname=foodb&#x27;</span></span><br><span class="line">        PUBLICATION mypublication, insert_only;    </span><br></pre></td></tr></table></figure>
<h4 id="3-3-注意："><a href="#3-3-注意：" class="headerlink" title="3.3 注意："></a>3.3 注意：</h4><pre><code>不能在事务块中执行带创建复制槽行为的CREATE SUBSCRIPTION.
创建订阅时带创建复制槽的行为在相同的数据库集群（集群内不同的数据库之间，或者同个数据库之间）都会导致创建行为挂起.除非是创建时指定不创建复制槽，如果想实现集群中不同库复制行为， 首先应该通过插件pgoutput，使用其函数pg_create_logical_replication_slot先创建复制槽。然后再创建复制时指定 create_slot=false。这种限制性定义，可能会在未来的版本中取消
任何在发布中带where限制的表。其中不匹配的行或者空数据都会被发布,如果一个订阅有多个发布者，并且其中一个表有多个带where的发布，只要所有发布where条件任何一个成立，那一行会被发布。如果其中一个发布者没有带where条件或者采用了 ALL TABLE 或者 ALL TABLE IN SCHEMA,则表的每一行都始终发布，不管其他定义如何。而在15 版本以前，where定义在初始化同步表数据阶段将被忽略,这种情况下，用户需在初始化同步后自行删除不匹配的行。
订阅者有关联多个发布的，每个发布者同一个表的列必须相同。不支持不相同列的集合
允许使用不存在的发布，
</code></pre><h4 id="3-4-修改订阅"><a href="#3-4-修改订阅" class="headerlink" title="3.4 修改订阅"></a>3.4 修改订阅</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SET</span> PUBLICATION publication_name [, ...] [ <span class="keyword">WITH</span> ( publication_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">ADD</span> PUBLICATION publication_name [, ...] [ <span class="keyword">WITH</span> ( publication_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">DROP</span> PUBLICATION publication_name [, ...] [ <span class="keyword">WITH</span> ( publication_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name REFRESH PUBLICATION [ <span class="keyword">WITH</span> ( refresh_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name ENABLE</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name DISABLE</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SET</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SKIP</span> ( skip_option <span class="operator">=</span> <span class="keyword">value</span> )</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name OWNER <span class="keyword">TO</span> &#123; new_owner <span class="operator">|</span> <span class="built_in">CURRENT_ROLE</span> <span class="operator">|</span> <span class="built_in">CURRENT_USER</span> <span class="operator">|</span> <span class="built_in">SESSION_USER</span> &#125;</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name RENAME <span class="keyword">TO</span> new_name</span><br><span class="line">注意：</span><br><span class="line">修改订阅能修改创建订阅时设置的大部分属性</span><br><span class="line">关于权限问题。目前的订阅都是superuser 所以所有者检查将会被忽略。未来的版本可能改变这个问题</span><br><span class="line">当刷新发布的时候，将会移除那些不属于发布者的关系，如果有同步复制槽，同时删除同步复制槽，以便释放订阅在远端服务器分配的资源</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION ... REFRESH PUBLICATION 和  <span class="keyword">ALTER</span> SUBSCRIPTION ... &#123;<span class="keyword">SET</span><span class="operator">|</span><span class="keyword">ADD</span><span class="operator">|</span><span class="keyword">DROP</span>&#125; PUBLICATION ... <span class="keyword">with</span> refresh option <span class="keyword">as</span> <span class="literal">true</span> 句式不能在事务块中执行</span><br><span class="line">也不能用于设置了两阶段提交的订阅(two_phase <span class="operator">=</span><span class="literal">true</span>),除了copy_data<span class="operator">=</span><span class="literal">false</span>,可以了在视图pg_subscription的subtwophasestate字段查看两阶段提交实际状态</span><br><span class="line">参数说明：</span><br><span class="line">name</span><br><span class="line">    订阅的名称</span><br><span class="line">CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line">    连接发布节点的数据库连接串</span><br><span class="line"><span class="keyword">SET</span> PUBLICATION publication_name</span><br><span class="line"><span class="keyword">ADD</span> PUBLICATION publication_name</span><br><span class="line"><span class="keyword">DROP</span> PUBLICATION publication_name</span><br><span class="line">    这<span class="number">3</span>个句式是改变订阅的发布列表。<span class="keyword">SET</span> 是替换 ，<span class="keyword">ADD</span> 是添加 ，<span class="keyword">DROP</span> 则是删除，默认情况下这些操作也像 REFRESH PUBLICATION</span><br><span class="line">    publication_option 选项是 refresh ,默认值是<span class="literal">true</span> ,修改为<span class="literal">false</span> 则不刷新发布表信息，REFRESH PUBLICATION 需另外执行</span><br><span class="line">REFRESH PUBLICATION</span><br><span class="line">    在发布者获取缺失的表信息，这将添加从创建复制开始或从上一次REFRESH PUBLICATION之后的所有新增的表的复制</span><br><span class="line">    refresh_option： copy_data (<span class="type">boolean</span>) 是否将同步已存在的的表数据</span><br><span class="line">ENABLE</span><br><span class="line">    激活被禁用的订阅</span><br><span class="line">DISABLE</span><br><span class="line">    禁用活动的订阅</span><br><span class="line"><span class="keyword">SET</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">    修改在创建订阅时指定的参数值(slot_name, synchronous_commit, <span class="type">binary</span>, streaming, <span class="keyword">and</span> disable_on_error)</span><br><span class="line"><span class="keyword">SKIP</span> ( skip_option <span class="operator">=</span> <span class="keyword">value</span> )</span><br><span class="line">    跳过远程事务的修改，当传入的数据违反了任何约束。逻辑复制将停止，直到解决。通过<span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SKIP</span> 命令可以时复制worker跳过事务中所有数据的修改，</span><br><span class="line">    此选项对启动两阶段提交的订阅者上已经准备好的事务没有影响。逻辑复制worker成功跳过事务或完成事务后，LSN(存储在pg_subscription.subskiplsn)将被清除</span><br><span class="line">    skip_option： LSN, 指定逻辑复制worker将跳过其更改的远程事务的完成 LSN。 完成 LSN 是提交或准备事务的 LSN。 不支持跳过单个子事务。 设置 <span class="keyword">NONE</span> 会重置 LSN。</span><br><span class="line">new_owner</span><br><span class="line">    为订阅指定新的所有者</span><br><span class="line">new_name</span><br><span class="line">    修改订阅的名字</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">    #重新设置订阅的发布列表</span><br><span class="line">    <span class="keyword">ALTER</span> SUBSCRIPTION mysub <span class="keyword">SET</span> PUBLICATION insert_only;</span><br><span class="line">    #禁用订阅</span><br><span class="line">    <span class="keyword">ALTER</span> SUBSCRIPTION mysub DISABLE;</span><br></pre></td></tr></table></figure>
<h4 id="3-5-删除订阅"><a href="#3-5-删除订阅" class="headerlink" title="3.5 删除订阅"></a>3.5 删除订阅</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> SUBSCRIPTION [ IF <span class="keyword">EXISTS</span> ] name [ CASCADE <span class="operator">|</span> RESTRICT </span><br><span class="line">删除订阅，订阅只能被superuser 删除，不能在事务块中执行删除带有复制槽的订阅</span><br><span class="line">参数说明：</span><br><span class="line">name</span><br><span class="line">    订阅名称</span><br><span class="line">CASCADE</span><br><span class="line">RESTRICT</span><br><span class="line">    这些关键词没有任何作用，因为订阅没有依赖关系。</span><br><span class="line"></span><br><span class="line">注意:</span><br><span class="line">     当删除带复制槽的订阅时，删除命令会连接远端发布节点去删除复制槽。这是很有必要的，远端为订阅分配的资源将能得到释放.如果远端节点不可达或者远端节点上的复制槽没法被删除，</span><br><span class="line">     或者复制槽在远端不存在，或者未曾存在过，都将导致删除命令失败退出。这种情况下。可以通过 <span class="keyword">ALTER</span> SUBSCRIPTION ... <span class="keyword">SET</span> (slot_name <span class="operator">=</span> <span class="keyword">NONE</span>)，然后再删除订阅，这种操作</span><br><span class="line">     将不会去远端执行删除复制槽。但请注意远端的复制槽并没有被删除，需要手工去删除复制槽。如果不删除。会导致远端节点一直保留等待被复制的WAL ，存在磁盘空间被耗尽的风险。</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">    <span class="keyword">DROP</span> SUBSCRIPTION mysub;</span><br></pre></td></tr></table></figure>
<h3 id="4-行过滤（15-版本"><a href="#4-行过滤（15-版本" class="headerlink" title="4. 行过滤（15+ 版本)"></a>4. 行过滤（15+ 版本)</h3><h4 id="4-1-行过滤规则"><a href="#4-1-行过滤规则" class="headerlink" title="4.1 行过滤规则"></a>4.1 行过滤规则</h4><pre><code>行过滤发送在发布者发布数据之前，不符合条件或者对应列为空的数据将不会被复制，行过滤器对truncate 无效
</code></pre><h4 id="4-2-表达式限制"><a href="#4-2-表达式限制" class="headerlink" title="4.2 表达式限制"></a>4.2 表达式限制</h4><pre><code>WHERE 子句只允许简单的表达式。 它不能包含用户定义的函数、运算符、类型和排序规则、系统列引用或非不可变的内置函数，如果是发布UPDATE/DELETE 操作，则条件中必须
包含复制标识列(主键,唯一键)，如果是INSERT 则where 条件可以是任何列
</code></pre><h4 id="4-3-UPDATE操作在行过滤中的转换"><a href="#4-3-UPDATE操作在行过滤中的转换" class="headerlink" title="4.3 UPDATE操作在行过滤中的转换"></a>4.3 UPDATE操作在行过滤中的转换</h4><pre><code>每一个UPDATE 操作,都会对旧行以及新行进行where条件匹配。如果新旧行都不匹配则不复制。如果旧行匹配，新行匹配则INSERT,如果旧行匹配，新行不匹配
则DELETE,如果新旧行都匹配则UPDATE.如下图1示
</code></pre><p>图1<br><img src="/images/UpdateTransformation.png" alt="UpdateTrans">   </p>
<h4 id="4-4-行过滤在分区表的行为"><a href="#4-4-行过滤在分区表的行为" class="headerlink" title="4.4 行过滤在分区表的行为"></a>4.4 行过滤在分区表的行为</h4><pre><code>publish_via_partition_root 参数将决定行过滤的行为，如果设置为true 则使用根分区表的行过滤器。如果设置为false ，则使用每个分区的行过滤器 
</code></pre><h4 id="4-5-初始化数据同步行为"><a href="#4-5-初始化数据同步行为" class="headerlink" title="4.5 初始化数据同步行为"></a>4.5 初始化数据同步行为</h4><pre><code>如果订阅要求同步已存在的数据，并且发布包含where 过滤，只有匹配的行才会发送给订阅
如果订阅者同时订阅有多个发布，只要满足任何一个where 过滤的行都会被发送给订阅
(上面提到过如果订阅者是15版本以前的版本，在初始化数据时不会对已存在数据做行过滤)
</code></pre><h4 id="4-6-绑定多行过滤"><a href="#4-6-绑定多行过滤" class="headerlink" title="4.6 绑定多行过滤"></a>4.6 绑定多行过滤</h4><pre><code>订阅者同时订阅多个发布，并且这些发布在同一个表上都包含where 过滤器，对于每一行数据,通过OR运算对每个过滤器进行匹配。只要满足其中一个则成立，
那么遇到以下情况，则过滤器将变得多余
1.其中一个发布者没有包含过滤器
2.其中一个发布者在创建时使用了FOR ALL TABLE 子句。这种不允许包含过滤行为
3.其中一个发布者在创建时使用了FOR ALL TABLES IN SCHEMA,并且这个表在定义的schema 里面，这种也不允许包含过滤行为
</code></pre><h4 id="4-7-示例"><a href="#4-7-示例" class="headerlink" title="4.7 示例"></a>4.7 示例</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 在发布节点上创建测试表</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(a <span class="type">int</span>, b <span class="type">int</span>, c text, <span class="keyword">PRIMARY</span> KEY(a,c));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t2(d <span class="type">int</span>, e <span class="type">int</span>, f <span class="type">int</span>, <span class="keyword">PRIMARY</span> KEY(d));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t3(g <span class="type">int</span>, h <span class="type">int</span>, i <span class="type">int</span>, <span class="keyword">PRIMARY</span> KEY(g));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 在发布节点上创建带行过滤的发布</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p1 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t1 <span class="keyword">WHERE</span> (a <span class="operator">&gt;</span> <span class="number">5</span> <span class="keyword">AND</span> c <span class="operator">=</span> <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p2 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t1, t2 <span class="keyword">WHERE</span> (e <span class="operator">=</span> <span class="number">99</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p3 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t2 <span class="keyword">WHERE</span> (d <span class="operator">=</span> <span class="number">10</span>), t3 <span class="keyword">WHERE</span> (g <span class="operator">=</span> <span class="number">10</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line"># 在psql 中 通过 \dRp<span class="operator">+</span> 展示所有的行过滤器</span><br><span class="line">test_pub<span class="operator">=</span># \dRp<span class="operator">+</span></span><br><span class="line">                               Publication p1</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t1&quot; <span class="keyword">WHERE</span> ((a <span class="operator">&gt;</span> <span class="number">5</span>) <span class="keyword">AND</span> (c <span class="operator">=</span> <span class="string">&#x27;NSW&#x27;</span>::text))</span><br><span class="line"></span><br><span class="line">                               Publication p2</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t1&quot;</span><br><span class="line">    &quot;public.t2&quot; <span class="keyword">WHERE</span> (e <span class="operator">=</span> <span class="number">99</span>)</span><br><span class="line"></span><br><span class="line">                               Publication p3</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t2&quot; <span class="keyword">WHERE</span> (d <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line">    &quot;public.t3&quot; <span class="keyword">WHERE</span> (g <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"># 也可以通过\d 表名的方式查看某个表上的行过滤器</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># \d t1</span><br><span class="line">                 <span class="keyword">Table</span> &quot;public.t1&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> a      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"> b      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"> c      <span class="operator">|</span> text    <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line">Indexes:</span><br><span class="line">    &quot;t1_pkey&quot; <span class="keyword">PRIMARY</span> KEY, btree (a, c)</span><br><span class="line">Publications:</span><br><span class="line">    &quot;p1&quot; <span class="keyword">WHERE</span> ((a <span class="operator">&gt;</span> <span class="number">5</span>) <span class="keyword">AND</span> (c <span class="operator">=</span> <span class="string">&#x27;NSW&#x27;</span>::text))</span><br><span class="line">    &quot;p2&quot;</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># \d t2</span><br><span class="line">                 <span class="keyword">Table</span> &quot;public.t2&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> d      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"> e      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"> f      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line">Indexes:</span><br><span class="line">    &quot;t2_pkey&quot; <span class="keyword">PRIMARY</span> KEY, btree (d)</span><br><span class="line">Publications:</span><br><span class="line">    &quot;p2&quot; <span class="keyword">WHERE</span> (e <span class="operator">=</span> <span class="number">99</span>)</span><br><span class="line">    &quot;p3&quot; <span class="keyword">WHERE</span> (d <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># \d t3</span><br><span class="line">                 <span class="keyword">Table</span> &quot;public.t3&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> g      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"> h      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"> i      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line">Indexes:</span><br><span class="line">    &quot;t3_pkey&quot; <span class="keyword">PRIMARY</span> KEY, btree (g)</span><br><span class="line">Publications:</span><br><span class="line">    &quot;p3&quot; <span class="keyword">WHERE</span> (g <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在订阅节点上 创建一个与发布节点上相同结构的表 t1，并且创建订阅 s1 ，订阅发布p1</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(a <span class="type">int</span>, b <span class="type">int</span>, c text, <span class="keyword">PRIMARY</span> KEY(a,c));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> SUBSCRIPTION s1</span><br><span class="line">test_sub<span class="operator">-</span># CONNECTION <span class="string">&#x27;host=localhost dbname=test_pub application_name=s1&#x27;</span></span><br><span class="line">test_sub<span class="operator">-</span># PUBLICATION p1;</span><br><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line"># 在发布节点上为表t1 插入一些数据，这时我们能看到满足p1 过滤条件的数据复制到订阅节点上了</span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">102</span>, <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">103</span>, <span class="string">&#x27;QLD&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">104</span>, <span class="string">&#x27;VIC&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">105</span>, <span class="string">&#x27;ACT&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="number">106</span>, <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="number">107</span>, <span class="string">&#x27;NT&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="number">108</span>, <span class="string">&#x27;QLD&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="number">109</span>, <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">2</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line"> <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">106</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line"> <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">106</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#更新一些数据，更新的旧行与新行都满足p1的过滤条件，这个时候<span class="keyword">UPDATE</span> 操作 正常的复制到订阅节点上</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> b <span class="operator">=</span> <span class="number">999</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">1</span></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">2</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line"> <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line"> <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line"> <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">#再更新一些数据，使旧行不满足p1过滤条件，而新行满足过滤条件，这个时候<span class="keyword">UPDATE</span> 操作变为<span class="keyword">INSERT</span> 操作复制到订阅节点上</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> a <span class="operator">=</span> <span class="number">555</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line">   <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line">   <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line">   <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 再更新一些数据使旧行满足p1过滤条件，而新行不满足，这个时候<span class="keyword">UPDATE</span> 操作变为<span class="keyword">DELETE</span> 操作复制到订阅节点上</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> c <span class="operator">=</span> <span class="string">&#x27;VIC&#x27;</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">9</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line">   <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line">   <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line">   <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">   <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> VIC</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#####下面是分区表行过滤的示例</span><br><span class="line"></span><br><span class="line"># 发布节点上创建分区表主parent,以及分区表子表child</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> parent(a <span class="type">int</span> <span class="keyword">PRIMARY</span> KEY) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(a);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child <span class="keyword">PARTITION</span> <span class="keyword">OF</span> parent <span class="keyword">DEFAULT</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 相同的表结构在订阅节点上也创建</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> parent(a <span class="type">int</span> <span class="keyword">PRIMARY</span> KEY) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(a);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child <span class="keyword">PARTITION</span> <span class="keyword">OF</span> parent <span class="keyword">DEFAULT</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 发布节点上创建条件发布p4,订阅节点创建订阅s4，订阅p4的发布，并且设置 publish_via_partition_root <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p4 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> parent <span class="keyword">WHERE</span> (a <span class="operator">&lt;</span> <span class="number">5</span>), child <span class="keyword">WHERE</span> (a <span class="operator">&gt;=</span> <span class="number">5</span>)</span><br><span class="line">test_pub<span class="operator">-</span># <span class="keyword">WITH</span> (publish_via_partition_root<span class="operator">=</span><span class="literal">true</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> SUBSCRIPTION s4</span><br><span class="line">test_sub<span class="operator">-</span># CONNECTION <span class="string">&#x27;host=localhost dbname=test_pub application_name=s4&#x27;</span></span><br><span class="line">test_sub<span class="operator">-</span># PUBLICATION p4;</span><br><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line"># 发布节点上写入些数据</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> parent <span class="keyword">VALUES</span> (<span class="number">2</span>), (<span class="number">4</span>), (<span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child <span class="keyword">VALUES</span> (<span class="number">3</span>), (<span class="number">5</span>), (<span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> parent <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> <span class="number">4</span></span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br><span class="line"># 订阅节点上可以看到</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> parent <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> <span class="number">4</span></span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 再来检验 publish_via_partition_root <span class="operator">=</span> <span class="literal">false</span> 的情况</span><br><span class="line"># 发布节点删除发布p4 并重建创建发布设置  publish_via_partition_root <span class="operator">=</span> <span class="literal">false</span> </span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">DROP</span> PUBLICATION p4;</span><br><span class="line"><span class="keyword">DROP</span> PUBLICATION</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p4 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> parent, child <span class="keyword">WHERE</span> (a <span class="operator">&gt;=</span> <span class="number">5</span>)</span><br><span class="line">test_pub<span class="operator">-</span># <span class="keyword">WITH</span> (publish_via_partition_root<span class="operator">=</span><span class="literal">false</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line"># 订阅节点刷新</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">ALTER</span> SUBSCRIPTION s4 REFRESH PUBLICATION;</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">TRUNCATE</span> parent;</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> parent <span class="keyword">VALUES</span> (<span class="number">2</span>), (<span class="number">4</span>), (<span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child <span class="keyword">VALUES</span> (<span class="number">3</span>), (<span class="number">5</span>), (<span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> parent <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> <span class="number">4</span></span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>
<h3 id="5-指定表字段集-15-版本"><a href="#5-指定表字段集-15-版本" class="headerlink" title="5 指定表字段集(15+ 版本)"></a>5 指定表字段集(15+ 版本)</h3><pre><code>可基于行行为或性能原因选择指定表字段，但不可作为安全限制，恶意的订阅能够读取发布未指定的列数据
如果没有指定表字段，则新增的字段数据同样会自动被复制，如果指定了表字段，那只有指定的字段数据会被复制
表字段列表只能包含简单的字段引用。 不保留表中字段的顺序
创建发布指定 FOR TABLE IN SCHEMA 时不支持指定表字段列表
对于分区表，由发布参数 publish_via_partition_root 决定用父表的字段列，还是子表的字段列表。设置true 使用父表的字段列，设置false（默认值）使用子表的字段列表
如果发布者会发布UPDATE/DELETE 操作，则字段列表必须包含表标识列（主键，唯一键），如果只是发布INSERT ,则可以省略包含表标识，字段列表对于TRUNCATE无任何影响 
在数据初始化期间只有发布指定的表字段列表会被拷贝，然而当订阅者的版本是15以前的版本时，所有的列都会同步过去。
订阅者订阅多个发布时，不支持每个发布者使用不同的表字段列表。当出现由于某个发布调整字段，这个时候就可能导致不同发布间字段不一致，这种情况alter publication 会成功
但稍后可能在发布者的walsender 报错，或者订阅者可能也抛错。这个时候需要通过alter subscription ... drop publicaiton ...删除有问题的发布，然后调整其列表再加回来。
</code></pre><h4 id="5-1-示例"><a href="#5-1-示例" class="headerlink" title="5.1 示例"></a>5.1 示例</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 发布节点上创建表 t1</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(id <span class="type">int</span>, a text, b text, c text, d text, e text, <span class="keyword">PRIMARY</span> KEY(id));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 创建发布p1 带表字段列表</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p1 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t1 (id, b, a, d);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line"># 在psql 中使用 \dRp<span class="operator">+</span> 查看发布定义</span><br><span class="line">test_pub<span class="operator">=</span># \dRp<span class="operator">+</span></span><br><span class="line">                               Publication p1</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t1&quot; (id, a, b, d)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在订阅节点上创建相同表结构的表并创建一个订阅者订阅p1</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(id <span class="type">int</span>, b text, a text, d text, <span class="keyword">PRIMARY</span> KEY(id));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> SUBSCRIPTION s1</span><br><span class="line">test_sub<span class="operator">-</span># CONNECTION <span class="string">&#x27;host=localhost dbname=test_pub application_name=s1&#x27;</span></span><br><span class="line">test_sub<span class="operator">-</span># PUBLICATION p1;</span><br><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line"># 在发布节点上初始化数据</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">&#x27;a-1&#x27;</span>, <span class="string">&#x27;b-1&#x27;</span>, <span class="string">&#x27;c-1&#x27;</span>, <span class="string">&#x27;d-1&#x27;</span>, <span class="string">&#x27;e-1&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">&#x27;a-2&#x27;</span>, <span class="string">&#x27;b-2&#x27;</span>, <span class="string">&#x27;c-2&#x27;</span>, <span class="string">&#x27;d-2&#x27;</span>, <span class="string">&#x27;e-2&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">3</span>, <span class="string">&#x27;a-3&#x27;</span>, <span class="string">&#x27;b-3&#x27;</span>, <span class="string">&#x27;c-3&#x27;</span>, <span class="string">&#x27;d-3&#x27;</span>, <span class="string">&#x27;e-3&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"> id <span class="operator">|</span>  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c  <span class="operator">|</span>  d  <span class="operator">|</span>  e</span><br><span class="line"><span class="comment">----+-----+-----+-----+-----+-----</span></span><br><span class="line">  <span class="number">1</span> <span class="operator">|</span> a<span class="number">-1</span> <span class="operator">|</span> b<span class="number">-1</span> <span class="operator">|</span> c<span class="number">-1</span> <span class="operator">|</span> d<span class="number">-1</span> <span class="operator">|</span> e<span class="number">-1</span></span><br><span class="line">  <span class="number">2</span> <span class="operator">|</span> a<span class="number">-2</span> <span class="operator">|</span> b<span class="number">-2</span> <span class="operator">|</span> c<span class="number">-2</span> <span class="operator">|</span> d<span class="number">-2</span> <span class="operator">|</span> e<span class="number">-2</span></span><br><span class="line">  <span class="number">3</span> <span class="operator">|</span> a<span class="number">-3</span> <span class="operator">|</span> b<span class="number">-3</span> <span class="operator">|</span> c<span class="number">-3</span> <span class="operator">|</span> d<span class="number">-3</span> <span class="operator">|</span> e<span class="number">-3</span></span><br><span class="line"></span><br><span class="line"># 在订阅节点上我们看到只有指定的字段复制过来了</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"> id <span class="operator">|</span>  b  <span class="operator">|</span>  a  <span class="operator">|</span>  d</span><br><span class="line"><span class="comment">----+-----+-----+-----</span></span><br><span class="line">  <span class="number">1</span> <span class="operator">|</span> b<span class="number">-1</span> <span class="operator">|</span> a<span class="number">-1</span> <span class="operator">|</span> d<span class="number">-1</span></span><br><span class="line">  <span class="number">2</span> <span class="operator">|</span> b<span class="number">-2</span> <span class="operator">|</span> a<span class="number">-2</span> <span class="operator">|</span> d<span class="number">-2</span></span><br><span class="line">  <span class="number">3</span> <span class="operator">|</span> b<span class="number">-3</span> <span class="operator">|</span> a<span class="number">-3</span> <span class="operator">|</span> d<span class="number">-3</span></span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>
<h3 id="6-冲突"><a href="#6-冲突" class="headerlink" title="6 冲突"></a>6 冲突</h3><p>当订阅节点订阅表在本地被更改过时，或者由于表的权限问题，或者由于订阅端表开启了行级别的安全策略，都有可能引发冲突冲突一旦发生，复制将会终止。<br>可以通过查看日志了解冲突详情，并根据实际情况处理数据问题，或者解决权限问题。冲突必须经过人为解决后，复制才能够继续。<br>例如下面的错误信息<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">ERROR:  duplicate key <span class="keyword">value</span> violates <span class="keyword">unique</span> <span class="keyword">constraint</span> &quot;test_pkey&quot;</span><br><span class="line">DETAIL:  Key (c)<span class="operator">=</span>(<span class="number">1</span>) already exists.</span><br><span class="line">CONTEXT:  processing remote data <span class="keyword">for</span> replication origin &quot;pg_16395&quot; during &quot;INSERT&quot; <span class="keyword">for</span> replication target relation &quot;public.test&quot; <span class="keyword">in</span> transaction <span class="number">725</span> finished <span class="keyword">at</span> <span class="number">0</span><span class="operator">/</span><span class="number">14</span>C0378</span><br></pre></td></tr></table></figure><br>在错误信息中我们可以看到事务的LSN 0/14C0378 还有复制源 pg_16395。我们可以通过  ALTER SUBSCRIPTION … SKIP 的命令来跳过完成的冲突事务，<br>也可以通过函数pg_replication_origin_advance(node_name text, lsn pg_lsn) 来跳过完成的冲突事务。<br>在使用pg_replication_origin_advance() 函数前必须先禁用订阅，或者创建订阅时指定了参数disable_on_error=true.<br>接着指定node_name “pg_16395” 以及完成的冲突事务 0/14C0378 的下一个位置 0/14C0379。当前复制源的位置可通过pg_replication_origin_status 系统视图来查看。</p>
<p>需要注意的是跳过整个事务。可能会将事务中本不冲突的数据也一并跳过。很容易引起订阅节点与发布节点上数据的不一致</p>
<h3 id="7-限制"><a href="#7-限制" class="headerlink" title="7 限制"></a>7 限制</h3><p>逻辑复制有以下的限制</p>
<pre><code>1. DDL 并不会被复制。初始化订阅节点时可以采用pg_dump -n -s 的方法导出指定schema下所有表结构。当发布节点上的表结构做变更时，需先在订阅节点上做变更。然后再在发布节点上做变更
2. 序列数据不会被复制。当要启用订阅节点作为业务节点时，一定要先重置序列的起始值，或重建序列，已满足当前序列值与表的最大值相匹配
3. 支持truncate 复制。在发布执行truncate需要注意的是，在truncate 关联外键的某些表。会同时清空关联的一组表。如果订阅节点也是相同的一组表关联，则复制正常运行。但如果订阅节点
   上还关联了某些不属于发布上关联的表。则复制会失败
4. 大对象不会被复制。 除了将数据存储在普通表中之外，没有解决方法
5. 复制只支持普通表，包括分区表。 尝试复制其他类型，例如视图、物化视图或外部表，将导致错误
6. 当复制分区表时，发布节点上有的分区子表，在订阅节点上都必须存在。
</code></pre><h3 id="8-复制架构"><a href="#8-复制架构" class="headerlink" title="8 复制架构"></a>8 复制架构</h3><p>逻辑复制从发布节点拷贝数据快照开始，当数据快照拷贝完成之后，发布节点上的变更将实时发送到订阅节点上。订阅者按照在发布<br>者上提交的顺序应用数据，以便保证任何单个订阅中的发布的事务一致性。</p>
<p>逻辑复制是用类似于物理流复制的架构构建的。 它由“walsender”和“apply”进程实现。walsender 进程启动 WAL 的逻辑解码<br>并加载标准逻辑解码插件（pgoutput）。 该插件将从 WAL 读取的更改转换为逻辑复制协议并根据发布规范过滤数据。 然后使用<br>流复制协议将数据连续传输到应用工作程序，应用工作程序将数据映射到本地表并在收到更改时以正确的事务顺序应用各个更改</p>
<p>订阅节点上的应用进程在运行时总是设置 session_replication_role= replica,这通常对触发器跟约束有影响。<br>    session_replication_role [origin|replica|local]:在会话中控制触发跟复制相关的触发器以及规则 .此设置的预期用途是逻辑复制系统在应用复制更改时将其值设置为replica</p>
<p>逻辑复制应用进程当前只触发行触发器，而不是语句触发器。 然而，初始表同步的实现类似于 COPY 命令，因此会触发 INSERT<br>的行触发器和语句触发器。</p>
<h3 id="9-监控"><a href="#9-监控" class="headerlink" title="9 监控"></a>9 监控</h3><p>逻辑复制采用类似于物理流复制的框架。监控发布者的健康状态可以通过 pg_stat_replication 视图查看<br>而对于订阅节点，则可以通过 pg_stat_subscription 查看</p>
<h3 id="10-配置参数设置"><a href="#10-配置参数设置" class="headerlink" title="10 配置参数设置"></a>10 配置参数设置</h3><p>在发布节点上<br>    wal_level = logical<br>    max_replication_slots &gt;= 订阅数量 + 初始化时同步表的连接数<br>    max_wal_senders &gt;= max_replication_slots + 物理复制从库的连接数<br>订阅节点上<br>    max_replication_slots &gt;= 订阅数量 + 初始化时同步表的连接数<br>    max_logical_replication_workers &gt;= 订阅数量 + 初始化时同步表的连接数<br>    max_worker_processes &gt;= max_logical_replication_workers + 1</p>
]]></content>
      <categories>
        <category>postgresql</category>
      </categories>
      <tags>
        <tag>replication</tag>
        <tag>logical</tag>
      </tags>
  </entry>
  <entry>
    <title>利用PG 的逻辑复制给阿里云数据搭建IDC 逻辑复制库</title>
    <url>/2022/10/20/pglogical/</url>
    <content><![CDATA[<p>将阿里云RDS 数据同步回IDC 做备库，最佳选择是DTS，当然想省钱的话，我们不妨来做个逻辑复制</p>
<h4 id="pg-逻辑复制的要求"><a href="#pg-逻辑复制的要求" class="headerlink" title="pg 逻辑复制的要求:"></a>pg 逻辑复制的要求:</h4><pre><code>1.postgresql 10+ 版本
2.wal_level 设置为 pglogical
3.max_replication_slots 至少设置为1 
4.逻辑复制采用发布,订阅模式。即在主库创建发布。在备库创建订阅
5.目前仅支持 INSERT ,UPDATE , DELETE 操作，11+ 支持 TRUNCATE ,不支持DDL。
6.被发布表（published table ）。必须都有一个复制标识。默认是表的主键，或者有唯一键 都可以被设置为复制标志。如果没有任何唯一标识可用。则会设置为full,已整列数据作为标志
7.订阅者连接发布的用户必须具有super 权限，如果具有super 权限。订阅将由pg_dump 转储，如果不具备super 权限则无法在 pg_subscription 中读取订阅信息，订阅将会被跳过。
8.发布数据库源表必须在订阅库中目标表以同名存在，订阅库目标表可以比发布库源表多字段,但源表字段必须在目标库都存在,对应的字段名也应该相同，不要求顺序相同，字段类型也只需要能够自动转换即可。
</code></pre><p>下面开始演示<br>由于云库RDS 我们一般都不具有super 权限。我们在创建发布者时，就没办法 create publication xxx for all tables; 只能按表来添加</p>
<h4 id="1-导出发布端数据表结构（注意这里只复制指定的schema-表）"><a href="#1-导出发布端数据表结构（注意这里只复制指定的schema-表）" class="headerlink" title="1. 导出发布端数据表结构（注意这里只复制指定的schema 表）"></a>1. 导出发布端数据表结构（注意这里只复制指定的schema 表）</h4><pre><code>pg_dump -f publication_db.meta.sql -U publication_db -s publication_db -h xxxx.aliyun.com -p port
</code></pre><h4 id="2-订阅端导入表"><a href="#2-订阅端导入表" class="headerlink" title="2. 订阅端导入表"></a>2. 订阅端导入表</h4><pre><code>create database publication_db owner xxxx  tablespace xxxx;
psql -U publication_db -d publication_db &lt; publication_db.meta.sql
</code></pre><h4 id="3-查看发布端是否具备逻辑复制条件"><a href="#3-查看发布端是否具备逻辑复制条件" class="headerlink" title="3. 查看发布端是否具备逻辑复制条件"></a>3. 查看发布端是否具备逻辑复制条件</h4><pre><code>show wal_level;
wal_level =logical 
show max_replication_slots;
max_replication_slots = 10
show max_wal_senders;
max_wal_senders = 10
</code></pre><p>   按照上述要求，如果不是则进行调整。然后重启数据库（生产环境重启数据库必须与业务协商）</p>
<h4 id="4-发布端创建发布"><a href="#4-发布端创建发布" class="headerlink" title="4. 发布端创建发布"></a>4. 发布端创建发布</h4><pre><code> create publication publication_db_logical for table xxxx;
 Select * from pg_publication; #查看发布者信息
</code></pre><h4 id="5-订阅端创建订阅"><a href="#5-订阅端创建订阅" class="headerlink" title="5. 订阅端创建订阅"></a>5. 订阅端创建订阅</h4><pre><code>\c publication_db superUser
create subscription publication_db_sub connction &#39;host=aliyun.db.domain port=xxx dbname=publication_db user=superUser password=xxxx&#39; publication publication_db_logical;
##对于pg中无法解析域名，我们可以先ping 下 RDS的域名。以得到真实IP，然后在/etc/hosts 中对应添加 ip  域名
select * from pg_subscription; #查看订阅信息
</code></pre><h4 id="6-在发布端查看是否已经启动复制进程"><a href="#6-在发布端查看是否已经启动复制进程" class="headerlink" title="6. 在发布端查看是否已经启动复制进程"></a>6. 在发布端查看是否已经启动复制进程</h4><pre><code>select * from pg_stat_replication;
</code></pre><h4 id="7-订阅创建成功后"><a href="#7-订阅创建成功后" class="headerlink" title="7. 订阅创建成功后"></a>7. 订阅创建成功后</h4><pre><code>订阅端首先进行的是表数据初始化。即在发布端全量拉取数据过来，完成后再进行增量同步
</code></pre><h4 id="8-添加余下的表到发布中"><a href="#8-添加余下的表到发布中" class="headerlink" title="8. 添加余下的表到发布中"></a>8. 添加余下的表到发布中</h4><pre><code>alter publication publication_db_logical add table tab1,tab2,tab3....
</code></pre><h4 id="9-在订阅端刷新订阅"><a href="#9-在订阅端刷新订阅" class="headerlink" title="9. 在订阅端刷新订阅"></a>9. 在订阅端刷新订阅</h4><pre><code>alter subscription mysub refresh publication;  #只有发动刷新。发布端的变动才会同步过来
</code></pre><h3 id="如果发布表需要增加字段。逻辑复制还能继续吗？"><a href="#如果发布表需要增加字段。逻辑复制还能继续吗？" class="headerlink" title="如果发布表需要增加字段。逻辑复制还能继续吗？"></a>如果发布表需要增加字段。逻辑复制还能继续吗？</h3><p>如果发布表增加了字段。而订阅表没有添加字段，逻辑复制就会中断。这个时候，只要在订阅节点库中对应表添加相应字段，再把订阅启动起来，就可以了。<br>正确的添加顺序。应该在订阅节点库先添加字段。然后再在发布节点库添加字段。然后看看是否复制正常。复制不正常就先停下复制。再启动复制即可</p>
]]></content>
      <categories>
        <category>postgresql</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>pglogical</tag>
      </tags>
  </entry>
  <entry>
    <title>postgis 插件安装</title>
    <url>/2022/10/14/postgisInstall/</url>
    <content><![CDATA[<h3 id="安装简介"><a href="#安装简介" class="headerlink" title="安装简介"></a>安装简介</h3><p>安装postgresql(已有跳过)—-&gt;安装postgis所需要的依赖—-&gt;安装postgis—-&gt;进入postgresql数据库—-&gt;指定数据库添加扩展<br>postgresql是基础软件，因此是必须第一个安装的，而postgis的依赖可分为两个部分，一部分是必须的库，包含 geos库，gdal库，<br>proj库，json-c库，libXML2库，这五个库如果正确安装了，那么就已经可以编译安装postgis并在pg数据中创建扩展了，但是需要<br>说明的是，此时的postgis并不支持3d数据的分析，存储，计算等工作，仅仅支持2d的地理信息。如果需要支持3d 则需要再安装四个<br>库，这四个库分别是protobuf，protobuf-c，cgal，sfcgal，这四个库均依赖于boost 库,在选择版本上要以boost 库版本为基准。<br>下面来开始安装，以全新的环境未安装postgresql 数据库做示例,所有软件包均放在 /data 目录下</p>
<h3 id="本文安装环境"><a href="#本文安装环境" class="headerlink" title="本文安装环境"></a>本文安装环境</h3><p>centos 7 3.10.0-1160.71.1.el7.x86_64</p>
<h3 id="postgis-安装的前置要求"><a href="#postgis-安装的前置要求" class="headerlink" title="postgis 安装的前置要求:"></a>postgis 安装的前置要求:</h3><ol>
<li>PostgreSQL 9.6 - 15</li>
<li>GNU C compiler (gcc)  gcc gcc-c++ 编译器</li>
<li>make 工具</li>
<li>proj  版本要求 &gt;= 4.9  找相应版本（本文用的是 proj.7.1.0） used to provide coordinate reprojection support within PostGIS     <a href="https://proj.org/">https://proj.org/</a> </li>
<li>GEOS  版本要求 &gt;= 3.6 geos 3.9 支持所有特性 （本文用的是 geos-3.8.3)  <a href="http://trac.osgeo.org/geos/">http://trac.osgeo.org/geos/</a> </li>
<li>libXML2 版本要求 &gt;= 2.5 (本文用的是libxml2-2.9.1) 当前用于一些 imports 函数 (ST_GeomFromGML and ST_GeomFromKML)</li>
<li>json-c  版本要求 &gt;=0.9 (本文用的是json-c-json-c-0.13.1-20180305) 用于 ST_GeomFromGeoJson 函数  <a href="https://github.com/json-c/json-c/releases/">https://github.com/json-c/json-c/releases/</a></li>
<li>gdal 版本要求 2+ ，3+ 更好 (本文用的是 gdal-3.5.2) raster支持  <a href="http://trac.osgeo.org/gdal/wiki/DownloadSource">http://trac.osgeo.org/gdal/wiki/DownloadSource</a></li>
</ol>
<h3 id="可选项"><a href="#可选项" class="headerlink" title="可选项"></a>可选项</h3><ol>
<li>dgal</li>
<li>gtk</li>
<li>sfcgal （支持3D坐标必备）</li>
<li>protobuf-c  ST_AsMVT可用</li>
<li>CUnit</li>
<li>DBLatex</li>
<li>ImageMagick </li>
</ol>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>boost , libxml2 都通过yum 安装 降低难度，gcc gcc-c++ 也通过yum 安装。自己安装更高的版本后续编译也会带来很多问题。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y lrzsz wget perl-ExtUtils-Embed \</span></span><br><span class="line">    readline-devel zlib-devel pam-devel \</span><br><span class="line">    libxml2-devel libxslt-devel openldap-devel \</span><br><span class="line">    python-devel gcc-c++ openssl-devel cmake libtool \</span><br><span class="line">    gcc libffi-devel mpfr-devel gmp-devel boost-devel</span><br></pre></td></tr></table></figure>
<p>安装完通过rpm -qa |grep xxx 可以看到<br>libxml2-2.9.1-6.el7_9.6.x86_64<br>gcc-c++-4.8.5-44.el7.x86_64<br>gcc-4.8.5-44.el7.x86_64<br>boost-1.53.0-28.el7.x86_64 （ pg_routing 版本3+ 要求 boost-1.56+ 我们选择 pgrouting-2.6.3.tar.gz ）</p>
<h3 id="编译安装-postgresql"><a href="#编译安装-postgresql" class="headerlink" title="编译安装 postgresql"></a>编译安装 postgresql</h3><p>数据库使用postgresql-14.5 编译安装完成后到/usr/local 目录下创建软链 并将目录授权postgres 用户<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /data</span></span><br><span class="line"><span class="comment"># tar -xzvf postgresql-14.5.tar.gz</span></span><br><span class="line"><span class="comment"># mv postgresql-14.5 postgresql-14.5_pkg</span></span><br><span class="line"><span class="comment"># cd postgresql-14.5_pkg</span></span><br><span class="line"><span class="comment"># CFLAGS=&quot;-O2 -march=native -mtune=native -pipe -fomit-frame-pointer&quot; \</span></span><br><span class="line">        CXXFLAGS=<span class="string">&quot;-O2 -march=native -mtune=native -pipe -fomit-frame-pointer&quot;</span> \</span><br><span class="line">        ./configure \</span><br><span class="line">        --prefix=/data/postgresql-14.5  \</span><br><span class="line">        --enable-nls \</span><br><span class="line">        --enable-thread-safety \</span><br><span class="line">        --with-libxml \</span><br><span class="line">        --with-libxslt \</span><br><span class="line">        --with-ldap=no \</span><br><span class="line">        --with-perl  \</span><br><span class="line">        --with-python \</span><br><span class="line">        --with-pam</span><br><span class="line"><span class="comment"># make &amp;&amp; make install-world</span></span><br><span class="line"><span class="comment"># cd /usr/local</span></span><br><span class="line"><span class="comment"># ln -s /data/postgresql-14.5 psql</span></span><br><span class="line"><span class="comment"># chown -R postgres.postgres  /data/postgresql-14.5</span></span><br></pre></td></tr></table></figure></p>
<h3 id="安装proj"><a href="#安装proj" class="headerlink" title="安装proj"></a>安装proj</h3><p>安装proj 之前我们先要安装2个依赖 sqlite3 以及 libtiff</p>
<p>安装sqlite3<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf sqlite-autoconf-3390400.tar.gz</span></span><br><span class="line"><span class="comment"># cd sqlite-autoconf-3390400</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/sqlite3</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<p>安装libtiff<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xvf tiff-4.4.0.tar</span></span><br><span class="line"><span class="comment"># cd tiff-4.4.0</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/libtiff</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<p>安装完依赖开始安装proj<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf proj-7.1.0.tar.gz</span></span><br><span class="line"><span class="comment"># cd proj-7.1.0</span></span><br><span class="line"><span class="comment"># SQLITE3_CFLAGS=&quot;-I/usr/local/sqlite3/include&quot; SQLITE3_LIBS=&quot;-L/usr/local/sqlite3/lib -lsqlite3&quot; TIFF_CFLAGS=&quot;-I/usr/local/libtiff/include&quot; TIFF_LIBS=&quot;-L/usr/local/libtiff/lib -ltiff&quot; ./configure --prefix=/usr/local/proj --without-curl</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<h3 id="安装geos"><a href="#安装geos" class="headerlink" title="安装geos"></a>安装geos</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xvf geos-3.8.3.tar</span></span><br><span class="line"><span class="comment"># cd geos-3.8.3</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/geos</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-gdal-依赖-sqlite3-跟-proj"><a href="#安装-gdal-依赖-sqlite3-跟-proj" class="headerlink" title="安装 gdal (依赖 sqlite3 跟 proj )"></a>安装 gdal (依赖 sqlite3 跟 proj )</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf gdal-3.5.2.tar.gz</span></span><br><span class="line"><span class="comment"># gdal-3.5.2</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/gdal --with-sqlite3=/usr/local/sqlite3 --with-proj=/usr/local/proj </span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-json-c"><a href="#安装-json-c" class="headerlink" title="安装 json-c"></a>安装 json-c</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf json-c-json-c-0.13.1-20180305.tar.gz</span></span><br><span class="line"><span class="comment"># cd json-c-json-c-0.13.1-20180305</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/jsonc</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<p>如果不需要支持3D 。以上库安装完后即可进行postgis 编译了</p>
<h3 id="安装-protobuf"><a href="#安装-protobuf" class="headerlink" title="安装 protobuf"></a>安装 protobuf</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf protobuf-all-3.15.0.tar.gz</span></span><br><span class="line"><span class="comment"># cd protobuf-3.15.0</span></span><br><span class="line"><span class="comment"># ./configure  --prefix=/usr/local/protobuf</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-protobuf-c"><a href="#安装-protobuf-c" class="headerlink" title="安装 protobuf-c"></a>安装 protobuf-c</h3><p>设置环境变量，安装protobuf-c 需要识别 protobuf<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export PROTOBUF_HOME=/usr/local/protobuf</span></span><br><span class="line"><span class="comment"># export PKG_CONFIG_PATH=/usr/local/protobuf/lib/pkgconfig</span></span><br><span class="line"><span class="comment"># tar -zxvf protobuf-c-1.3.3.tar.gz</span></span><br><span class="line"><span class="comment"># cd protobuf-c-1.3.3</span></span><br><span class="line"><span class="comment"># ./configure  --prefix=/usr/local/protobuf-c</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<p>CGAL 以及SFCGAL 安装需要cmake 3+的版本</p>
<h3 id="安装cmake"><a href="#安装cmake" class="headerlink" title="安装cmake"></a>安装cmake</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf cmake-3.23.4-linux-x86_64.tar.gz</span></span><br><span class="line"><span class="comment"># ln -s /data/cmake-3.23.4-linux-x86_64 /usr/local/cmake</span></span><br></pre></td></tr></table></figure>
<h3 id="将安装的相关环境变量写入-etc-profile"><a href="#将安装的相关环境变量写入-etc-profile" class="headerlink" title="将安装的相关环境变量写入/etc/profile"></a>将安装的相关环境变量写入/etc/profile</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vi /etc/profile</span></span><br><span class="line"><span class="comment"># pathmunge /usr/local/protobuf/bin after</span></span><br><span class="line"><span class="comment"># pathmunge /usr/local/protobuf-c/bin after</span></span><br><span class="line"><span class="comment"># pathmunge /usr/local/pgsql/bin after</span></span><br><span class="line"><span class="comment"># PATH=/usr/local/cmake/bin:$PATH</span></span><br><span class="line"><span class="comment"># source /etc/profile</span></span><br></pre></td></tr></table></figure>
<h3 id="编译CGAL"><a href="#编译CGAL" class="headerlink" title="编译CGAL"></a>编译CGAL</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># unzip CGAL-4.14.3.zip </span></span><br><span class="line"><span class="comment"># cd CGAL-4.14.3</span></span><br><span class="line"><span class="comment"># mkdir build</span></span><br><span class="line"><span class="comment"># cd build</span></span><br><span class="line"><span class="comment"># /usr/local/cmake/bin/cmake ../   ###(注意这里不要指定路径。以免安装编译SFCGAL时发生意外)</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<h3 id="编译安装-SFCGAL"><a href="#编译安装-SFCGAL" class="headerlink" title="编译安装 SFCGAL"></a>编译安装 SFCGAL</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf SFCGAL-v1.3.10.tar.gz</span></span><br><span class="line"><span class="comment"># cd /data/SFCGAL-v1.3.10/</span></span><br><span class="line"><span class="comment"># mkdir build</span></span><br><span class="line"><span class="comment"># cmake -D CMAKE_INSTALL_PREFIX=/usr/local/sfcgal  ../</span></span><br></pre></td></tr></table></figure>
<h3 id="将以上安装的所有lib-列入LD-LIBARY-PATH-直接写到-etc-ld-so-conf-也可以"><a href="#将以上安装的所有lib-列入LD-LIBARY-PATH-直接写到-etc-ld-so-conf-也可以" class="headerlink" title="将以上安装的所有lib 列入LD_LIBARY_PATH (直接写到 /etc/ld.so.conf 也可以)"></a>将以上安装的所有lib 列入LD_LIBARY_PATH (直接写到 /etc/ld.so.conf 也可以)</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># export LD_LIBRARY_PATH=/usr/local/pgsql/lib:/usr/local/gdal/lib:/usr/local/geos/lib:/usr/local/jsonc/lib:/usr/local/proj/lib:/usr/local/protobuf/lib:/usr/local/protobuf-c/lib:/usr/local/sfcgal/lib64:/usr/local/sqlite3/lib:/usr/local/tiff/lib:/usr/lib:/usr/lib64</span></span><br><span class="line"><span class="comment"># source /etc/profile</span></span><br></pre></td></tr></table></figure>
<h3 id="编译安装-pg-routing"><a href="#编译安装-pg-routing" class="headerlink" title="编译安装 pg_routing"></a>编译安装 pg_routing</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf pgrouting-2.6.3.tar.gz </span></span><br><span class="line"><span class="comment"># cd pgrouting-2.6.3</span></span><br><span class="line"><span class="comment"># mkdir build</span></span><br><span class="line"><span class="comment"># cmake ../</span></span><br><span class="line"><span class="comment"># make</span></span><br><span class="line"><span class="comment"># make install</span></span><br></pre></td></tr></table></figure>
<h3 id="编译安装-postgis"><a href="#编译安装-postgis" class="headerlink" title="编译安装 postgis"></a>编译安装 postgis</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf postgis-3.2.4dev.tar.gz </span></span><br><span class="line"><span class="comment"># cd postgis-3.2.4dev/</span></span><br><span class="line"><span class="comment"># ./configure --with-pgconfig=/usr/local/pgsql/bin/pg_config \</span></span><br><span class="line">  --with-gdalconfig=/usr/local/gdal/bin/gdal-config \</span><br><span class="line">  --with-geosconfig=/usr/local/geos/bin/geos-config  \</span><br><span class="line">  --with-protobufdir=/usr/local/protobuf-c \</span><br><span class="line">  --with-jsondir=/usr/local/jsonc \</span><br><span class="line">  --with-sfcgal=/usr/local/sfcgal/bin/sfcgal-config \</span><br><span class="line">  --with-projdir=/usr/local/proj \</span><br><span class="line">  --with-xml2config=/usr/bin/xml2-config</span><br><span class="line"></span><br><span class="line"><span class="comment"># make</span></span><br><span class="line"><span class="comment"># make install</span></span><br></pre></td></tr></table></figure>
<h3 id="初始化pg数据库。我们来看看create-extension-是否成功"><a href="#初始化pg数据库。我们来看看create-extension-是否成功" class="headerlink" title="初始化pg数据库。我们来看看create extension 是否成功"></a>初始化pg数据库。我们来看看create extension 是否成功</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># su - postgres</span></span><br><span class="line">$ initdb -A md5 -E utf8 --locale=C -D /usr/local/pgsql/data_sheen -W</span><br><span class="line">$ pg_ctl -D /usr/local/pgsql/data_sheen start</span><br><span class="line">$ <span class="built_in">mkdir</span> -p /data/PG_TABLESPACE/sheen_data  <span class="comment">###(创建自定义表空间目录)</span></span><br><span class="line">$ psql</span><br><span class="line">postgres=<span class="comment"># create user sheen loginin password &#x27;xxx&#x27;;</span></span><br><span class="line">postgres=<span class="comment"># create tablespace sheen_data owner sheen location &#x27;/data/PG_TABLESPACE/sheen_data&#x27;;</span></span><br><span class="line">postgres=<span class="comment"># create database sheen with owner=sheen tablespace=sheen_data;</span></span><br><span class="line">postgres=<span class="comment"># \c sheen postgres</span></span><br><span class="line">sheen=<span class="comment"># create extension postgis;</span></span><br><span class="line">sheen=<span class="comment"># create extension postgis_raster;</span></span><br><span class="line">sheen=<span class="comment"># create extension postgis_sfcgal;</span></span><br><span class="line">sheen=<span class="comment"># CREATE EXTENSION pgrouting;</span></span><br><span class="line">sheen=<span class="comment"># \dx</span></span><br><span class="line">                                   List of installed extensions</span><br><span class="line">      Name      | Version  |   Schema   |                        Description                         </span><br><span class="line">----------------+----------+------------+------------------------------------------------------------</span><br><span class="line"> pgrouting      | 2.6.3    | public     | pgRouting Extension</span><br><span class="line"> plpgsql        | 1.0      | pg_catalog | PL/pgSQL procedural language</span><br><span class="line"> postgis        | 3.2.4dev | public     | PostGIS geometry and geography spatial types and <span class="built_in">functions</span></span><br><span class="line"> postgis_raster | 3.2.4dev | public     | PostGIS raster types and <span class="built_in">functions</span></span><br><span class="line"> postgis_sfcgal | 3.2.4dev | public     | PostGIS SFCGAL <span class="built_in">functions</span></span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure>
<h3 id="扩展安装-fuzzystrmatch-和-postgis-tiger-geocoder"><a href="#扩展安装-fuzzystrmatch-和-postgis-tiger-geocoder" class="headerlink" title="扩展安装 fuzzystrmatch 和 postgis_tiger_geocoder"></a>扩展安装 fuzzystrmatch 和 postgis_tiger_geocoder</h3><p>postgis_tiger_geocoder 依赖于 fuzzystrmatch，要启用 postgis_tiger_geocoder需先编译启用fuzzystrmatch<br>fuzzystrmatch 存放在 postgresql 安装包的contrib 里面<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[postgres@localhost ~]$ <span class="built_in">cd</span> /data/postgresql-14.5_pkg/contrib/fuzzystrmatch</span><br><span class="line">[postgres@localhost fuzzystrmatch]$ make</span><br><span class="line">make -C ../../src/backend generated-headers</span><br><span class="line">make[1]: Entering directory `/data/postgresql-14.5_pkg/src/backend<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make -C catalog distprep generated-header-symlinks</span></span><br><span class="line"><span class="string">make[2]: Entering directory `/data/postgresql-14.5_pkg/src/backend/catalog&#x27;</span></span><br><span class="line">make[2]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `distprep<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">make[2]: Nothing to be done for `generated-header-symlinks&#x27;</span>.</span><br><span class="line">make[2]: Leaving directory `/data/postgresql-14.5_pkg/src/backend/catalog<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make -C utils distprep generated-header-symlinks</span></span><br><span class="line"><span class="string">make[2]: Entering directory `/data/postgresql-14.5_pkg/src/backend/utils&#x27;</span></span><br><span class="line">make[2]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `distprep<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">make[2]: Nothing to be done for `generated-header-symlinks&#x27;</span>.</span><br><span class="line">make[2]: Leaving directory `/data/postgresql-14.5_pkg/src/backend/utils<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make[1]: Leaving directory `/data/postgresql-14.5_pkg/src/backend&#x27;</span></span><br><span class="line">gcc -std=gnu99 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -march=native -mtune=native -pipe -fomit-frame-pointer -fPIC -I. -I. -I../../src/include  -D_GNU_SOURCE -I/usr/include/libxml2   -c -o dmetaphone.o dmetaphone.c</span><br><span class="line">gcc -std=gnu99 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -march=native -mtune=native -pipe -fomit-frame-pointer -fPIC -I. -I. -I../../src/include  -D_GNU_SOURCE -I/usr/include/libxml2   -c -o fuzzystrmatch.o fuzzystrmatch.c</span><br><span class="line">gcc -std=gnu99 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -march=native -mtune=native -pipe -fomit-frame-pointer -fPIC -shared -o fuzzystrmatch.so  dmetaphone.o fuzzystrmatch.o -L../../src/port -L../../src/common    -Wl,--as-needed -Wl,-rpath,<span class="string">&#x27;/data/postgresql-14.5/lib&#x27;</span>,--enable-new-dtags  </span><br><span class="line">[postgres@localhost fuzzystrmatch]$ make install</span><br><span class="line">make -C ../../src/backend generated-headers</span><br><span class="line">make[1]: Entering directory `/data/postgresql-14.5_pkg/src/backend<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make -C catalog distprep generated-header-symlinks</span></span><br><span class="line"><span class="string">make[2]: Entering directory `/data/postgresql-14.5_pkg/src/backend/catalog&#x27;</span></span><br><span class="line">make[2]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `distprep<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">make[2]: Nothing to be done for `generated-header-symlinks&#x27;</span>.</span><br><span class="line">make[2]: Leaving directory `/data/postgresql-14.5_pkg/src/backend/catalog<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make -C utils distprep generated-header-symlinks</span></span><br><span class="line"><span class="string">make[2]: Entering directory `/data/postgresql-14.5_pkg/src/backend/utils&#x27;</span></span><br><span class="line">make[2]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `distprep<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">make[2]: Nothing to be done for `generated-header-symlinks&#x27;</span>.</span><br><span class="line">make[2]: Leaving directory `/data/postgresql-14.5_pkg/src/backend/utils<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make[1]: Leaving directory `/data/postgresql-14.5_pkg/src/backend&#x27;</span></span><br><span class="line">/usr/bin/mkdir -p <span class="string">&#x27;/data/postgresql-14.5/lib&#x27;</span></span><br><span class="line">/usr/bin/mkdir -p <span class="string">&#x27;/data/postgresql-14.5/share/extension&#x27;</span></span><br><span class="line">/usr/bin/mkdir -p <span class="string">&#x27;/data/postgresql-14.5/share/extension&#x27;</span></span><br><span class="line">/usr/bin/install -c -m 755  fuzzystrmatch.so <span class="string">&#x27;/data/postgresql-14.5/lib/fuzzystrmatch.so&#x27;</span></span><br><span class="line">/usr/bin/install -c -m 644 ./fuzzystrmatch.control <span class="string">&#x27;/data/postgresql-14.5/share/extension/&#x27;</span></span><br><span class="line">/usr/bin/install -c -m 644 ./fuzzystrmatch--1.1.sql ./fuzzystrmatch--1.0--1.1.sql  <span class="string">&#x27;/data/postgresql-14.5/share/extension/&#x27;</span></span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># \c sheen postgres</span></span><br><span class="line">You are now connected to database <span class="string">&quot;sheen&quot;</span> as user <span class="string">&quot;postgres&quot;</span>.</span><br><span class="line">sheen=<span class="comment"># CREATE EXTENSION fuzzystrmatch;</span></span><br><span class="line">CREATE EXTENSION</span><br><span class="line">sheen=<span class="comment"># CREATE EXTENSION postgis_tiger_geocoder;</span></span><br><span class="line">CREATE EXTENSION</span><br><span class="line">sheen=<span class="comment"># SELECT na.address, na.streetname,na.streettypeabbrev, na.zip</span></span><br><span class="line">sheen-<span class="comment"># FROM normalize_address(&#x27;1 Devonshire Place, Boston, MA 02109&#x27;) AS na;</span></span><br><span class="line"> address | streetname | streettypeabbrev |  zip  </span><br><span class="line">---------+------------+------------------+-------</span><br><span class="line">       1 | Devonshire | Pl               | 02109</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure></p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>安装postgis 是比较麻烦的过程。安装期间曾试过想要安装某些高版本的包而升级了gcc ,后面各种编译错误。调换各种安装包后。<br>到最后postgis 执行configure 通过，结果在make 就出现错误 原因还是boost 的版本问题。</p>
]]></content>
      <categories>
        <category>postgresql</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>postgis</tag>
        <tag>postgresql</tag>
      </tags>
  </entry>
  <entry>
    <title>python 连接 Oceanbase 数据库</title>
    <url>/2023/09/25/python2oceanbase/</url>
    <content><![CDATA[<p>通过python 连接 Oceanbase 数据库。我们通过jdbc 的方式来实现</p>
<ol>
<li>java jdk8 or jdk 11<br>oracle 官网下载 jdk8 或者 open jdk 11 设置JAVA_HOME</li>
<li>jaydebeapi 包<br>pip install jaydebeapi</li>
<li>ob-client jar包: oceanbase-client-2.x.x.jar<br>下载 oceanbase-client-2.4.1.jar 放在指定目录 在jarFile 中需要用到</li>
</ol>
<p>准备好以上的东西后，定义数据库连接类,使用 com.alipay.oceanbase.jdbc.Driver 驱动类<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Obconnect</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,ip,port,dbname,user,password</span>):</span><br><span class="line">        self.ip = ip</span><br><span class="line">        self.port = port</span><br><span class="line">        self.dbname = dbname</span><br><span class="line">        self.user = user</span><br><span class="line">        self.password = password</span><br><span class="line">        self.driver = <span class="string">&#x27;com.alipay.oceanbase.jdbc.Driver&#x27;</span></span><br><span class="line">        self.jarFile = <span class="string">&#x27;./oceanbase-client-2.4.1.jar&#x27;</span> </span><br><span class="line">        self.url = <span class="string">&#x27;jdbc:oceanbase://&#123;&#125;:&#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.ip,self.port,self.dbname)</span><br><span class="line">        self.conn = jaydebeapi.connect(self.driver, self.url, [user, password], self.jarFile)</span><br><span class="line">        self.cursor = self.conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self,sql</span>):</span><br><span class="line">        self.cursor.execute(sql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">executemany</span>(<span class="params">self,sql,data</span>):</span><br><span class="line">        self.cursor.executemany(sql,data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self,sql</span>):</span><br><span class="line">        self.cursor.execute(sql)</span><br><span class="line">        res = self.cursor.fetchall()</span><br><span class="line">        <span class="keyword">return</span> res  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">       self.cursor.close()</span><br><span class="line">       self.conn.close() </span><br></pre></td></tr></table></figure></p>
<p>实现一个在oracle 读取数据批量写入 oceanbase 的例子<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jaydebeapi</span><br><span class="line"><span class="keyword">from</span> baseTools <span class="keyword">import</span> DbConn <span class="comment">#连接oracle 的定义，大家自行实现用cx_Oracle</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">encoding = <span class="string">&quot;gbk&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obconnect</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,ip,port,dbname,user,password</span>):</span><br><span class="line">        self.ip = ip</span><br><span class="line">        self.port = port</span><br><span class="line">        self.dbname = dbname</span><br><span class="line">        self.user = user</span><br><span class="line">        self.password = password</span><br><span class="line">        self.driver = <span class="string">&#x27;com.alipay.oceanbase.jdbc.Driver&#x27;</span></span><br><span class="line">        self.jarFile = <span class="string">&#x27;./oceanbase-client-2.4.1.jar&#x27;</span> </span><br><span class="line">        self.url = <span class="string">&#x27;jdbc:oceanbase://&#123;&#125;:&#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.ip,self.port,self.dbname)</span><br><span class="line">        self.conn = jaydebeapi.connect(self.driver, self.url, [user, password], self.jarFile)</span><br><span class="line">        self.cursor = self.conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self,sql</span>):</span><br><span class="line">        self.cursor.execute(sql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">executemany</span>(<span class="params">self,sql,data</span>):</span><br><span class="line">        self.cursor.executemany(sql,data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self,sql</span>):</span><br><span class="line">        self.cursor.execute(sql)</span><br><span class="line">        res = self.cursor.fetchall()</span><br><span class="line">        <span class="keyword">return</span> res  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">       self.cursor.close()</span><br><span class="line">       self.conn.close() </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##结果集类型转换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">result_change</span>(<span class="params">data</span>):</span><br><span class="line">    result =[]</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> data:</span><br><span class="line">        tmp_list=<span class="built_in">list</span>(row)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tmp_list)):</span><br><span class="line">            <span class="comment">## 日期型转化。ob 不认datetime 。转成 timestamp</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(tmp_list[idx],datetime.datetime):</span><br><span class="line">                tmp_list[idx] = tmp_list[idx].timestamp()</span><br><span class="line">        result.append(tmp_list)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment">## 构造 insert sql 模板</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">insert_string_creater</span>(<span class="params">title,table_name,dbtype</span>):</span><br><span class="line">    <span class="keyword">if</span> dbtype == <span class="string">&quot;oracle&quot;</span>:</span><br><span class="line">        parstr = <span class="string">&quot;,&quot;</span>.join([<span class="string">&quot;:%s&quot;</span>%col <span class="keyword">for</span> col <span class="keyword">in</span> title])</span><br><span class="line">        instr = <span class="string">&quot;insert into %s values (%s)&quot;</span>%(table_name,parstr)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> dbtype == <span class="string">&quot;mysql&quot;</span>:</span><br><span class="line">            tp = [<span class="string">&#x27;`%s`&#x27;</span>%t <span class="keyword">for</span> t <span class="keyword">in</span> title ]</span><br><span class="line">            title_str = <span class="string">&quot;,&quot;</span>.join(tp)</span><br><span class="line">        <span class="keyword">else</span>:   </span><br><span class="line">            title_str = <span class="string">&quot;,&quot;</span>.join(title)</span><br><span class="line">        val_str = <span class="string">&quot;,&quot;</span>.join([<span class="string">&#x27;%s&#x27;</span>]*<span class="built_in">len</span>(title))</span><br><span class="line">        instr = <span class="string">&quot;insert into %s (%s) values (%s)&quot;</span>%(table_name,title_str,val_str) </span><br><span class="line">    <span class="keyword">return</span> instr</span><br><span class="line"></span><br><span class="line"><span class="comment">## 连接实例</span></span><br><span class="line">obconn = Obconnect(<span class="string">&#x27;xxxx&#x27;</span>,<span class="number">1521</span>,<span class="string">&#x27;xxxx&#x27;</span>,<span class="string">&#x27;xxxx&#x27;</span>,<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">oraconn = DbConn(&#123;<span class="string">&quot;ip&quot;</span>:<span class="string">&#x27;192.168.xxx.xxx&#x27;</span>,<span class="string">&quot;port&quot;</span>:<span class="number">1521</span>,<span class="string">&quot;db&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;user&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;dbtype&quot;</span>:<span class="string">&quot;oracle&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">## </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bulk_insert</span>(<span class="params">table_name</span>):</span><br><span class="line">    res,title = oraconn.query_title(<span class="string">&quot;select * from product_app.%s where rownum &lt;10000 &quot;</span>%table_name)</span><br><span class="line">    instr = insert_string_creater(title,table_name,<span class="string">&#x27;oracle&#x27;</span>)</span><br><span class="line">    data = result_change(res)</span><br><span class="line">    obconn.executemany(instr,data)</span><br><span class="line">    obconn.execute(<span class="string">&quot;commit&quot;</span>)</span><br><span class="line"></span><br><span class="line">bulk_insert(<span class="string">&#x27;cc_acl&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>oceanbase</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>driver</tag>
      </tags>
  </entry>
  <entry>
    <title>sed 使用</title>
    <url>/2023/03/30/sed/</url>
    <content><![CDATA[<p>如何将 /usr/local/mysql/bin 注册到 /etc/profile 指定位置?<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">LINE=`grep -n <span class="string">&quot;pathmunge /usr/sbin after&quot;</span> /etc/profile |awk -F<span class="string">&quot;:&quot;</span> <span class="string">&#x27;&#123;print $1 +2&#125;&#x27;</span>`</span><br><span class="line">sed -i <span class="string">&quot;<span class="variable">$&#123;LINE&#125;</span>&quot;</span>i<span class="string">&quot;pathmunge /usr/local/mysql/bin&quot;</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment">###效果</span></span><br><span class="line"><span class="comment"># Path manipulation</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$EUID</span>&quot;</span> = <span class="string">&quot;0&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    pathmunge /usr/sbin</span><br><span class="line">    pathmunge /usr/local/sbin</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    pathmunge /usr/local/sbin after</span><br><span class="line">    pathmunge /usr/sbin after</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">pathmunge /usr/local/mysql/bin</span><br></pre></td></tr></table></figure></p>
<p>比如，要将目录/modules下面所有文件中的zhangsan都修改成lisi，这样做：<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sed -i &quot;s/zhangsan/lisi/g&quot; `grep zhangsan -rl /modules`</span><br><span class="line"></span><br><span class="line">-i 表示inplace edit，就地修改文件</span><br><span class="line">-r 表示搜索子目录</span><br><span class="line">-l 表示输出匹配的文件名</span><br><span class="line">这个命令组合很强大，要注意备份文件</span><br><span class="line"> </span><br><span class="line">sed -i &#x27;s/old_string/new_string/g&#x27;`grep &quot;old_string&quot; -l *sh`  批量替换 sh 文件中包含指定字符串的为目标字符串</span><br></pre></td></tr></table></figure></p>
<p>当用sed  批量处理 sh 文件时，出现了下面的错误，<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[oracle@intra_db-10-121 bin]$ sed -i &quot;s#dba@3conline\.com\.cn#dba@3conline\.com#g&quot;`grep &quot;dba@3conline.com.cn&quot; -l *`   </span><br><span class="line">sed：-e 表达式 #1，字符 44：unknown option to `s&#x27;</span><br><span class="line">[oracle@intra_db-10-121 bin]$ sed -i &quot;s#dba@3conline\.com\.cn#dba@3conline\.com#g&quot;`grep &quot;dba@3conline.com.cn&quot; -l \*\.sh`</span><br><span class="line">grep: *.sh: 没有那个文件或目录</span><br><span class="line">sed: no input files</span><br></pre></td></tr></table></figure><br>可以更改为如下写法<br><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grep &quot;dba@3conline.com.cn&quot; -l *.sh |xargs sed -i &quot;s#dba@3conline\.com\.cn#dba@3conline\.com#g&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>shell</category>
      </categories>
      <tags>
        <tag>sed</tag>
      </tags>
  </entry>
  <entry>
    <title>搭建 shardingsphere-proxy-4.1.1</title>
    <url>/2023/07/27/sharding-proxy/</url>
    <content><![CDATA[<p>shardingsphere-proxy 4.x 跟 5.x 差别比较大。这里介绍4.x proxy 的搭建<br>在 <a href="https://archive.apache.org/dist/shardingsphere/">https://archive.apache.org/dist/shardingsphere/</a> 下载所需版本<br>本文选择的是 apache-shardingsphere-4.1.1-sharding-proxy-bin.tar.gz </p>
<p>1.安装jdk<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /app</span><br><span class="line">tar -xzvf jdk-8u341-linux-x64.tar.gz </span><br><span class="line">vi ~/.bash_profile</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/app/jdk1.8.0_341</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/.local/bin:<span class="variable">$HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> PATH</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></p>
<p>2.解压配置proxy<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 解压bin 包</span></span><br><span class="line"><span class="built_in">cd</span> /app</span><br><span class="line">tar -xzvf apache-shardingsphere-4.1.1-sharding-proxy-bin.tar.gz </span><br><span class="line"><span class="built_in">mv</span> apache-shardingsphere-4.1.1-sharding-proxy-bin shardingsphere-proxy-4.11</span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置授权文件，定义了shardingsphere-proxy 登录的用户以及密码。</span></span><br><span class="line"><span class="built_in">cd</span> shardingsphere-proxy-4.11</span><br><span class="line">vi conf/server.yaml</span><br><span class="line"></span><br><span class="line">authentication:</span><br><span class="line">  <span class="built_in">users</span>:</span><br><span class="line">    root:         <span class="comment"># 用户</span></span><br><span class="line">      password: root  <span class="comment"># 密码</span></span><br><span class="line">    sharding:     <span class="comment"># 用户</span></span><br><span class="line">      password: sharding  <span class="comment"># 密码</span></span><br><span class="line">      authorizedSchemas: beauty_db <span class="comment"># 授权数据库,要设置 在config-x 里面定义的 schemaName</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置分片文件</span></span><br><span class="line">vi conf/config-sharding.yaml</span><br><span class="line">schemaName: beauty_db  <span class="comment">## proxy 库名定义</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">dataSources: <span class="comment">## 设置数据源</span></span><br><span class="line">  o2o:  <span class="comment">##数据源名称</span></span><br><span class="line">    url: jdbc:mysql://10.xx.xx.xx:3306/beautydb?serverTimezone=UTC&amp;useSSL=<span class="literal">false</span></span><br><span class="line">    username: beauty</span><br><span class="line">    password: beauty123</span><br><span class="line">    connectionTimeoutMilliseconds: 30000</span><br><span class="line">    idleTimeoutMilliseconds: 60000</span><br><span class="line">    maxLifetimeMilliseconds: 1800000</span><br><span class="line"><span class="comment">## 分片规则定义</span></span><br><span class="line">shardingRule:</span><br><span class="line">  tables:</span><br><span class="line">    wb_service_order:  <span class="comment">## 逻辑表名</span></span><br><span class="line">      actualDataNodes: o2o.wb_service_order_$-&gt;&#123;2022..2023&#125;_$-&gt;&#123;0..9&#125; <span class="comment">## 实际映射的分表&#123;wb_server_order_2022_0 --&gt; wb_server_order_2023_9 &#125;</span></span><br><span class="line">      tableStrategy:</span><br><span class="line">        complex:  <span class="comment">## 分片策略 &#123;standard:标准型 complex: 复合型 inline: 行表达式  hint: 基于hint 的分片策略&#125;</span></span><br><span class="line">          shardingColumns: union_id,create_time  <span class="comment">## 分片字段 ，单字段用shardingColumn 多字段用 shardingColumns</span></span><br><span class="line">          algorithmClassName: cn.smartbreeze.biz.beauty.sharding.algorithm.UnionIdHash10AndTimeYearShardingAlgorithm <span class="comment">##自定义逻辑分片类名</span></span><br><span class="line">    wb_service_order_ext:</span><br><span class="line">      actualDataNodes: o2o.wb_service_order_ext_$-&gt;&#123;2022..2023&#125;_$-&gt;&#123;0..9&#125;</span><br><span class="line">      tableStrategy:</span><br><span class="line">        complex:</span><br><span class="line">          shardingColumns: order_id,create_time</span><br><span class="line">          algorithmClassName: cn.smartbreeze.biz.beauty.sharding.algorithm.OrderId10AndTimeYearShardingAlgorithm</span><br><span class="line">    wb_service_order_log:</span><br><span class="line">      actualDataNodes: o2o.wb_service_order_log_$-&gt;&#123;2023..2023&#125;_$-&gt;&#123;0..9&#125;</span><br><span class="line">      tableStrategy:</span><br><span class="line">        complex:</span><br><span class="line">          shardingColumns: order_id,create_time</span><br><span class="line">          algorithmClassName: cn.smartbreeze.biz.beauty.sharding.algorithm.OrderId10AndTimeYearShardingAlgorithm</span><br><span class="line">    wb_store_schedule:</span><br><span class="line">      actualDataNodes: o2o.wb_store_schedule_$-&gt;&#123;2023..2023&#125;_$-&gt;&#123;0..9&#125;</span><br><span class="line">      tableStrategy:</span><br><span class="line">        complex:</span><br><span class="line">          shardingColumns: store_id,start_time</span><br><span class="line">          algorithmClassName: cn.smartbreeze.biz.beauty.sharding.algorithm.StoreId10AndTimeYearShardingAlgorithm</span><br><span class="line">  bindingTables: <span class="comment">## 需要绑定的表。只展示逻辑名。不展示详细分片表</span></span><br><span class="line">    - wb_service_order ,wb_service_order_ext ,wb_service_order_log ,wb_store_schedule</span><br></pre></td></tr></table></figure><br>3.追加相应jar包<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># postgresql 类型的数据库不需要加载驱动包</span></span><br><span class="line"><span class="comment"># mysql 类型数据库需要加载驱动包</span></span><br><span class="line">tar -xzvf mysql-connector-java-5.1.49.tar.gz</span><br><span class="line"><span class="built_in">cp</span> mysql-connector-java-5.1.49/mysql-connector-java-5.1.49.jar  /app/shardingsphere-proxy-4.11/lib <span class="comment"># 驱动包放这个目录底下。</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /app/shardingsphere-proxy-4.11</span><br><span class="line"><span class="built_in">mkdir</span> ext-lib</span><br><span class="line"><span class="built_in">cp</span> store-beauty-biz-0.0.1-SNAPSHOT.jar  store-beauty-core-0.0.1-SNAPSHOT.jar ext-lib <span class="comment">## 这2个为开发写的自定义规则jar 包</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>4.启动验证<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /app/shardingsphere-proxy-4.11</span><br><span class="line">sh bin/start.sh  <span class="comment"># 启动 默认3307 端口。可以通过 sh bin/start.sh $&#123;proxy-port&#125; 的方式自定义端口号</span></span><br><span class="line">sh bin/stop.sh   <span class="comment"># 停止</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#登录验证</span></span><br><span class="line">mysql -usharding -psharding beauty_db --host=x.x.x.x --port=3307 </span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>中间件</tag>
        <tag>分库分表</tag>
      </tags>
  </entry>
  <entry>
    <title>oracle 19c 安装 sqlt</title>
    <url>/2023/06/16/sqlt/</url>
    <content><![CDATA[<p>sqlt 是oracle 提供的一款强大的SQL性能诊断工具.SQLT主要方法是通过输入的一个SQL语句，从而生成一组诊断文件，<br>这些文件用于诊断性能较差的或产生错误结果(WRONG RESULTS)的SQL。</p>
<p>安装包 sqlt_10g_11g_12c_18c_19c_5th_June_2020.zip<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># unzip sqlt_10g_11g_12c_18c_19c_5th_June_2020.zip</span></span><br><span class="line"><span class="comment"># cd sqlt/install</span></span><br><span class="line"><span class="comment"># sqlplus /  as sysdba</span></span><br><span class="line">SQL &gt; START sqdrop.sql     <span class="comment">## 卸载sqlt命令</span></span><br></pre></td></tr></table></figure></p>
<h3 id="安装sqlt"><a href="#安装sqlt" class="headerlink" title="安装sqlt"></a>安装sqlt</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd sqlt/install</span></span><br><span class="line"><span class="comment"># sqlplus / as sysdba</span></span><br><span class="line">SQL&gt; show pdbs;</span><br><span class="line"></span><br><span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span><br><span class="line">---------- ------------------------------ ---------- ----------</span><br><span class="line">         2 PDB<span class="variable">$SEED</span>                       READ ONLY  NO</span><br><span class="line">         6 SHEEN                          READ WRITE NO</span><br><span class="line"><span class="comment">## 切换到容器 sheen</span></span><br><span class="line">SQL&gt; alter session <span class="built_in">set</span> container = sheen;</span><br><span class="line"><span class="comment">## 为sqlt 专有用户设定临时表空间与数据表空间,并创建用于sqlt 分析的用户 sqlter (名字自己随便取)</span></span><br><span class="line">SQL&gt; create temporary tablespace sqlter_temp tempfile <span class="string">&#x27;/data/oracle/oradata/ORCL19/sqlter_temp.dbf&#x27;</span> size 2G;</span><br><span class="line">SQL&gt; create tablespace sqlter_data datafile <span class="string">&#x27;/data/oracle/oradata/ORCL19/sqlter_data.dbf&#x27;</span> size 2G;</span><br><span class="line">SQL&gt; create user sqlter identified by sqlter123 default tablespace sqlter_data temporary tablespace sqlter_temp;</span><br><span class="line">SQL&gt; grant connect,create session ,resource to sqlter;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 开始执行安装脚本</span></span><br><span class="line">SQL&gt; START sqcreate.sql</span><br><span class="line">....</span><br><span class="line">Optional Connect Identifier (ie: @PROD): @SHEEN    <span class="comment">## 这里填连接标识符，在tnsnames.ora 配置</span></span><br><span class="line">Password <span class="keyword">for</span> user SQLTXPLAIN: sqlter123  <span class="comment">## 写入用于SQLTXPLAIN 的密码 （我们前面定义的sqlter 的密码）</span></span><br><span class="line">Re-enter password: sqlter123 <span class="comment">## 重新输入一遍密码</span></span><br><span class="line">...</span><br><span class="line">Do you want to see the free space of each tablespace [YES]</span><br><span class="line">or is it ok just to show the list of tablespace [NO]?</span><br><span class="line"></span><br><span class="line">Type YES or NO [Default NO]: no     <span class="comment">##展示可用表空间</span></span><br><span class="line">... please <span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">TABLESPACE                     FREE_SPACE_MB</span><br><span class="line">------------------------------ -------------</span><br><span class="line">SHEEN_DATA</span><br><span class="line">SQLTER_DATA</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Specify PERMANENT tablespace to be used by SQLTXPLAIN.</span><br><span class="line"></span><br><span class="line">Tablespace name is <span class="keyword">case</span> sensitive.</span><br><span class="line"></span><br><span class="line">Default tablespace [SQLTER_DATA]:  SQLTER_DATA <span class="comment">## 这里填写专用表空间。也就是上面我们创建的表空间</span></span><br><span class="line"></span><br><span class="line">PL/SQL 过程已成功完成。</span><br><span class="line"></span><br><span class="line">... please <span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">TABLESPACE</span><br><span class="line">------------------------------</span><br><span class="line">SQLTER_TEMP</span><br><span class="line">TEMP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Specify TEMPORARY tablespace to be used by SQLTXPLAIN.</span><br><span class="line"></span><br><span class="line">Tablespace name is <span class="keyword">case</span> sensitive.</span><br><span class="line"></span><br><span class="line">Temporary tablespace [SQLTER_TEMP]: SQLTER_TEMP <span class="comment">## 这里填写专用临时表空间。</span></span><br><span class="line"></span><br><span class="line">The main application user of SQLT is the schema</span><br><span class="line">owner that issued the SQL to be analyzed.</span><br><span class="line">For example, on an EBS application you would</span><br><span class="line">enter APPS.</span><br><span class="line">You will not be asked to enter its password.</span><br><span class="line">To add more SQLT <span class="built_in">users</span> after this installation</span><br><span class="line">is completed simply grant them the SQLT_USER_ROLE</span><br><span class="line">role.</span><br><span class="line"></span><br><span class="line">Main application user of SQLT: sqlter   <span class="comment">##这里填写刚才创建的专用用户</span></span><br><span class="line">QLT can make extensive use of licensed features</span><br><span class="line">provided by the Oracle Diagnostic and the Oracle</span><br><span class="line">Tuning Packs, including SQL Tuning Advisor (STA),</span><br><span class="line">SQL Monitoring and Automatic Workload Repository</span><br><span class="line">(AWR).</span><br><span class="line">To <span class="built_in">enable</span> or <span class="built_in">disable</span> access to these features</span><br><span class="line">from the SQLT tool enter one of the following</span><br><span class="line">values when asked:</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;T&quot;</span> <span class="keyword">if</span> you have license <span class="keyword">for</span> Diagnostic and Tuning</span><br><span class="line"><span class="string">&quot;D&quot;</span> <span class="keyword">if</span> you have license only <span class="keyword">for</span> Oracle Diagnostic</span><br><span class="line"><span class="string">&quot;N&quot;</span> <span class="keyword">if</span> you <span class="keyword">do</span> not have these two licenses</span><br><span class="line"></span><br><span class="line">Oracle Pack license [T]:N <span class="comment">## 根据实际情况选择 是否有对应的许可证。没有选N,然后开始进入安装进程</span></span><br><span class="line">SQCUSR completed. Some errors are expected.</span><br><span class="line"></span><br><span class="line">过程已创建。</span><br><span class="line"></span><br><span class="line">没有错误。</span><br><span class="line">  adding: 230616112347_02_sqcusr.<span class="built_in">log</span> (deflated 84%)</span><br><span class="line"></span><br><span class="line">TAUTLTEST completed.</span><br><span class="line">  adding: 230616112348_09_tautltest.<span class="built_in">log</span> (deflated 57%)</span><br><span class="line"></span><br><span class="line">SQUTLTEST completed.</span><br><span class="line">  adding: 230616112348_10_squtltest.<span class="built_in">log</span> (deflated 59%)</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line">SQUTLTEST completed.</span><br><span class="line">  adding: 230616112511_10_squtltest.<span class="built_in">log</span> (deflated 57%)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SQLT <span class="built_in">users</span> must be granted SQLT_USER_ROLE before using this tool.</span><br><span class="line"></span><br><span class="line">SQCREATE completed. Installation completed successfully.</span><br><span class="line"></span><br><span class="line"><span class="comment">## 到这里安装完成</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 给用户授权 SQLT_USER_ROLE 角色</span></span><br><span class="line">SQL&gt; grant SQLT_USER_ROLE to sqlter;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">XTRACT：通过V<span class="variable">$SQL</span>、AWR的过去执行过的SQL内容，收集相关信息。</span><br><span class="line"></span><br><span class="line">XECUTE：通过执行SQL，收集相关信息。</span><br><span class="line"></span><br><span class="line">XPLAIN：不执行SQL，基于EXPLAIN PLAN FOR命令收集相关信息。（不推荐）</span><br><span class="line"></span><br><span class="line">XTRXEC：该方法合并了XTRACT和XECUTE 的功能。实际上，XTRXEC连续执行了这两种方法。</span><br><span class="line"></span><br><span class="line">XTRSBY：分析在 Data Guard 或备用只读数据库上执行的 SQL。</span><br><span class="line"></span><br><span class="line">XPREXT：使用XTRACT同时禁用一些SQLT的特性，使之执行更快。</span><br><span class="line"></span><br><span class="line">XPREXC：使用XECUTE同时禁用一些SQLT的特性，使之执行更快</span><br></pre></td></tr></table></figure>
<h3 id="XTRACT-的使用方法"><a href="#XTRACT-的使用方法" class="headerlink" title="XTRACT 的使用方法"></a>XTRACT 的使用方法</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">通过V<span class="variable">$SQL</span>或AWR找到要收集数据的SQL的SQL_ID 或者HASH_VALUE</span><br><span class="line"><span class="built_in">cd</span> sqlt/run</span><br><span class="line">sqlplus sqlter/sqlter123@sheen</span><br><span class="line">SQL&gt; select * from (select sql_id,hash_value,substr(sql_text,1,40) text from v<span class="variable">$sql</span> <span class="built_in">where</span> rownum &lt;5);</span><br><span class="line"></span><br><span class="line">SQL_ID                          HASH_VALUE TEXT</span><br><span class="line">------------------------------ ----------- ----------------------------------------</span><br><span class="line">c81x87vcts000                   3650879488 SELECT /* OPT_DYN_SAMP */ /*+ ALL_ROWS I</span><br><span class="line">1bpnwdxzv4002                   2142371842 select count(FA<span class="comment">#) from SYS_FBA_TRACKEDTA</span></span><br><span class="line">6c8jkzw0d000j                     13631505 SELECT /* OPT_DYN_SAMP */ /*+ ALL_ROWS I</span><br><span class="line">fwyky62r40013                   2923429923 SELECT /* OPT_DYN_SAMP */ /*+ ALL_ROWS</span><br><span class="line"></span><br><span class="line">SQL &gt; @sqltxtract fwyky62r40013 <span class="comment">## @sqltxtract [sql_id|hash_value] [SQLTXPLAIN PASSWORD]</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Parameter 1:</span><br><span class="line">SQL_ID or HASH_VALUE of the SQL to be extracted (required)</span><br><span class="line">Describe the characteristic of this run</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;F[AST]&quot;</span>             <span class="keyword">if</span> you have a FAST run</span><br><span class="line"><span class="string">&quot;S[LOW]&quot;</span>             <span class="keyword">if</span> you have a SLOW run (default)</span><br><span class="line"><span class="string">&quot;H[ASH]&quot;</span>             <span class="keyword">if</span> this is a run with a HASH JOIN</span><br><span class="line"><span class="string">&quot;N[L]&quot;</span>               <span class="keyword">if</span> this is a run with a NESTED LOOP</span><br><span class="line"><span class="string">&quot;C[OLUMN HISTOGRAM]&quot;</span> <span class="keyword">if</span> this is a run with a Column Historgram <span class="keyword">in</span> place</span><br><span class="line">SQL Description [S]:  <span class="comment">#默认直接敲回车</span></span><br><span class="line"></span><br><span class="line">Paremeter 2:</span><br><span class="line">SQLTXPLAIN password (required)</span><br><span class="line"></span><br><span class="line">输入 2 的值:  sqlter123  <span class="comment">## 输入SQLTXPLAIN 的密码</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Value passed:</span><br><span class="line">SQL_ID_OR_HASH_VALUE: <span class="string">&quot;fwyky62r40013&quot;</span></span><br><span class="line">.....</span><br><span class="line">. . 正在导出表                   SQLT<span class="variable">$_STATTAB</span>导出了           0 行</span><br><span class="line">成功终止导出, 没有出现警告。</span><br><span class="line">...</span><br><span class="line">即将导出指定的表通过常规路径...</span><br><span class="line">. . 正在导出表             SQLT<span class="variable">$_SQL_STATEMENT</span>导出了           1 行</span><br><span class="line">. . 正在导出表                SQLT$_AUX_STATS$导出了          13 行</span><br><span class="line">. . 正在导出表       SQLT<span class="variable">$_DBA_AUTOTASK_CLIENT</span>导出了           1 行</span><br><span class="line">. . 正在导出表            SQLT$_DBA_COL_USAGE$导出了           1 行</span><br><span class="line">. . 正在导出表           SQLT<span class="variable">$_DBA_CONSTRAINTS</span>导出了           2 行</span><br><span class="line">.....</span><br><span class="line">adding: sqlt_s10993_restore.sql (deflated 43%)</span><br><span class="line">  adding: sqlt_s10993_del_hgrm.sql (deflated 26%)</span><br><span class="line">        zip warning: name not matched: sqlt_s10993_opatch.zip</span><br><span class="line">.....</span><br><span class="line"><span class="comment">#####</span></span><br><span class="line">The SQLT has collected information and place it <span class="keyword">in</span> a repository <span class="keyword">in</span> the database, exported it and zip it.</span><br><span class="line">The collected info can be purged from the database using the following file :</span><br><span class="line">... getting sqlt_s10993_purge.sql out of sqlt repository ...</span><br><span class="line"></span><br><span class="line">SQLTXTRACT completed.</span><br><span class="line"></span><br><span class="line"><span class="comment">## 至此分析完成</span></span><br><span class="line">在run 目录中可以找到分析结果 sqlt_20230616_1655_fwyky62r40013_S.zip</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>oracle</category>
      </categories>
      <tags>
        <tag>sql tuning</tag>
        <tag>sql tool</tag>
      </tags>
  </entry>
  <entry>
    <title>not in 和 not exists</title>
    <url>/2022/10/27/sqltuning1/</url>
    <content><![CDATA[<p>今天发现了一条跑了10分钟都没出结果的语句。好家伙。<br>先做一个执行计划分析<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain</span><br><span class="line"><span class="keyword">select</span> a.id, a.title, a.pub_url <span class="keyword">from</span> tbl1 a <span class="keyword">where</span> </span><br><span class="line">a.garbage_sign<span class="operator">=</span><span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.isold_article<span class="operator">=</span><span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.channel_id<span class="operator">=</span><span class="string">&#x27;000116582&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.id <span class="keyword">not</span> <span class="keyword">in</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> article_id <span class="keyword">from</span> tbl2 <span class="keyword">where</span> create_date<span class="operator">&gt;</span><span class="string">&#x27;2022-09-01 00:00:00&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">                                                                QUERY PLAN                                                          </span><br><span class="line">       </span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-------</span></span><br><span class="line"> Bitmap Heap Scan <span class="keyword">on</span> tbl1 a  (cost<span class="operator">=</span><span class="number">685997.69</span>.<span class="number">.44605189219</span><span class="number">.14</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">121818</span> width<span class="operator">=</span><span class="number">108</span>)</span><br><span class="line">   Recheck Cond: (((channel_id)::text <span class="operator">=</span> <span class="string">&#x27;000116582&#x27;</span>::text) <span class="keyword">AND</span> ((garbage_sign)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::text) <span class="keyword">AND</span> ((isold_article)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::</span><br><span class="line">text))</span><br><span class="line">   <span class="keyword">Filter</span>: (<span class="keyword">NOT</span> (SubPlan <span class="number">1</span>))</span><br><span class="line">   <span class="operator">-</span><span class="operator">&gt;</span>  BitmapAnd  (cost<span class="operator">=</span><span class="number">685997.69</span>.<span class="number">.685997</span><span class="number">.69</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">243636</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> idx_tbl1_chennelid_pubdat  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.10402</span><span class="number">.42</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">262115</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">               Index Cond: ((channel_id)::text <span class="operator">=</span> <span class="string">&#x27;000116582&#x27;</span>::text)</span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> idx_tbl1_link  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.675534</span><span class="number">.11</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">8450463</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">               Index Cond: ((isold_article)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::text)</span><br><span class="line">   SubPlan <span class="number">1</span></span><br><span class="line">     <span class="operator">-</span><span class="operator">&gt;</span>  Materialize  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.363384</span><span class="number">.29</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1106828</span> width<span class="operator">=</span><span class="number">8</span>)</span><br><span class="line">           <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> tbl2  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.353526</span><span class="number">.15</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1106828</span> width<span class="operator">=</span><span class="number">8</span>)</span><br><span class="line">                 <span class="keyword">Filter</span>: (create_date <span class="operator">&gt;</span> <span class="string">&#x27;2022-09-01 00:00:00&#x27;</span>::<span class="type">timestamp</span> <span class="keyword">without</span> <span class="type">time</span> zone)</span><br><span class="line">(<span class="number">12</span> 行记录)</span><br></pre></td></tr></table></figure><br>从上面的执行计划可以看到子查询结果转化成一个100多W 的物化视图再跟tbl1做了一次bitmap。一般这么大的结果集并不是合适用 not in,not in 适合小结果集。<br>而大结果集则可以采用not exists, 改成not exists 来看看执行计划如何<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">explain</span><br><span class="line"><span class="keyword">select</span> a.id, a.title, a.pub_url <span class="keyword">from</span> tbl1 a <span class="keyword">where</span> </span><br><span class="line">a.garbage_sign<span class="operator">=</span><span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.isold_article<span class="operator">=</span><span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.channel_id<span class="operator">=</span><span class="string">&#x27;000116582&#x27;</span></span><br><span class="line"><span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> tbl2 b <span class="keyword">where</span> a.id <span class="operator">=</span> b.article_id <span class="keyword">and</span> b.create_date<span class="operator">&gt;</span><span class="string">&#x27;2022-09-01 00:00:00&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">                                                QUERY PLAN                                                </span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> Hash Anti <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">382148.83</span>.<span class="number">.1149719</span><span class="number">.26</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">213975</span> width<span class="operator">=</span><span class="number">108</span>)</span><br><span class="line">   Hash Cond: ((a.id)::text <span class="operator">=</span> (b.article_id)::text)</span><br><span class="line">   <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Heap Scan <span class="keyword">on</span> tbl1 a  (cost<span class="operator">=</span><span class="number">10463.33</span>.<span class="number">.725582</span><span class="number">.54</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">243636</span> width<span class="operator">=</span><span class="number">108</span>)</span><br><span class="line">         Recheck Cond: (((channel_id)::text <span class="operator">=</span> <span class="string">&#x27;000116582&#x27;</span>::text) <span class="keyword">AND</span> ((garbage_sign)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::text))</span><br><span class="line">         <span class="keyword">Filter</span>: ((isold_article)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::text)</span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> idx_tbl1_chennelid_pubdat  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.10402</span><span class="number">.42</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">262115</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">               Index Cond: ((channel_id)::text <span class="operator">=</span> <span class="string">&#x27;000116582&#x27;</span>::text)</span><br><span class="line">   <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">353526.15</span>.<span class="number">.353526</span><span class="number">.15</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1106828</span> width<span class="operator">=</span><span class="number">8</span>)</span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> tbl2 b  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.353526</span><span class="number">.15</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1106828</span> width<span class="operator">=</span><span class="number">8</span>)</span><br><span class="line">               <span class="keyword">Filter</span>: (create_date <span class="operator">&gt;</span> <span class="string">&#x27;2022-09-01 00:00:00&#x27;</span>::<span class="type">timestamp</span> <span class="keyword">without</span> <span class="type">time</span> zone)</span><br><span class="line">(<span class="number">10</span> 行记录)</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>从上面的执行计划上看已经用的是 Hash Anti Join 而不是 Bitmap Heap Scan。<br>只要4秒多就出结果</p>
<p>在写SQL 时大家要遵循这样一个原则。in ，not in 都适用于子查询是小结果集的。 exists , not exists 则用于子查询是大结果集的<br>关联条件必须具有索引，否则也会慢到你怀疑人生。</p>
]]></content>
      <categories>
        <category>postgresql</category>
      </categories>
      <tags>
        <tag>sql tuing</tag>
      </tags>
  </entry>
  <entry>
    <title>索引须知:最左原则</title>
    <url>/2022/11/02/sqltuning2/</url>
    <content><![CDATA[<p>有如下表结构<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_mapping_v1` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `site` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;平台&#x27;</span>,</span><br><span class="line">  `project` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;项目&#x27;</span>,</span><br><span class="line">  `distinct_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;设备号&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_user_mapping` (`site`,`project`,`distinct_id`) <span class="keyword">USING</span> BTREE COMMENT <span class="string">&#x27;用户映射表唯一组合索引&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>使用如下的语句进行检索。可能很多人都会认为会命中unique key.<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  id,site,project,distinct_id,user_id,create_time,update_time  <span class="keyword">FROM</span> user_mapping_v1 </span><br><span class="line"><span class="keyword">WHERE</span> distinct_id <span class="operator">=</span> <span class="string">&#x27;B4C2AA7B-95A0-44DF-BFC5-xxxx&#x27;</span> <span class="keyword">AND</span> project <span class="operator">=</span> <span class="string">&#x27;proj&#x27;</span></span><br></pre></td></tr></table></figure><br> 而实际执行时，你会收到意外的执行计划，那就是全表扫描。为什么呢？条件字段有包含在索引字段里面啊。这里就涉及到索引使用<br> 的一个原则问题：最左匹配原则。<br> 数据库通过条件匹配索引是从索引列最左列开始匹配的。那么上面的条件虽然有distinct_id，project 但是并没有site ，所以匹配<br> 不到索引。走了全表扫描。<br> 给它建一个索引<br> <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_distinct_project <span class="keyword">ON</span> user_mapping_v1(distinct_id,project)</span><br></pre></td></tr></table></figure><br>这下我们可以看到走的就是新建的这个索引了<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">id	select_type	  <span class="keyword">table</span>	        partitions	type	possible_keys	       key	             key_len	<span class="keyword">ref</span>	      <span class="keyword">rows</span>	filtered	Extra</span><br><span class="line"><span class="number">1</span>	SIMPLE	    user_mapping_v1	  \N	    <span class="keyword">ref</span>	 idx_distinct_project	idx_distinct_project	<span class="number">962</span>	   const,const	<span class="number">1</span>	 <span class="number">100.00</span>	     \N</span><br></pre></td></tr></table></figure><br>在创建索引时,通常要考虑把系统中对该表查下时最常使用的那个字段放在索引的最左边，建组合索引。以达到一个索引能在更多的情况下被使用</p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>sqltuning</tag>
      </tags>
  </entry>
  <entry>
    <title>升级hivemeta库</title>
    <url>/2023/03/14/upgradeHiveMeta/</url>
    <content><![CDATA[<h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>公司升级了hive 由 1.2 升级到 3.1,这里涉及到元数据的搬迁过程。元数据信息存储在mysql中</p>
<h4 id="升级过程"><a href="#升级过程" class="headerlink" title="升级过程"></a>升级过程</h4><ol>
<li><p>将旧库导出</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysqldump -uxxxx -pxxxx-S /tmp/mysql.sock --routines  --triggers --set-gtid-purged=off --default-character-set=latin1 hadoop &gt;hadoop_hive.1.2.sql</span><br></pre></td></tr></table></figure>
</li>
<li><p>将数据导入新的mysql实例中，如果已经是有搭建了3.x 版本的Hive 并联数据库产生了元数据的表，则先删除库。然后导入数据，不然升级脚本会报很多冲突</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql -uxxx -pxxx hadoop /tmp/mysql.sock &lt; hadoop_hive.1.2.sql</span><br></pre></td></tr></table></figure></li>
<li>在新库中执行 1.2.0 的表创建脚本(可能该版本是由以前的版本升上来的。部分表缺失，重新建表，对于存在的表则不会再建)<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/PRG/hive/scripts/metastore/upgrade/mysql  <span class="comment"># hive 版本升级脚本存放目录</span></span><br><span class="line">mysql -uxxx -pxxx hadoop /tmp/mysql.sock &lt; hive-schema-1.2.0.mysql.sql</span><br></pre></td></tr></table></figure></li>
<li><p>安装版本脚本进行一个个执行升级</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据升级脚本，一个个版本叠加上来，就不会报错</span></span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-1.2.0-to-2.0.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-2.0.0-to-2.1.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-2.1.0-to-2.2.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-2.2.0-to-2.3.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-2.3.0-to-3.0.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-3.0.0-to-3.1.0.mysql.sql</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端报错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">javax.jdo.JDOException: Exception thrown when executing query : SELECT <span class="string">&#x27;org.apache.hadoop.hive.metastore.model.MDatabase&#x27;</span> AS `NUCLEUS_TYPE`,`A0`.`DESC`,`A0`.`DB_LOCATION_URI`,`A0`.`NAME`,`A0`.`OWNER_NAME`,`A0`.`OWNER_TYPE`,`A0`.`D</span><br><span class="line">B_ID` FROM `DBS` `A0` WHERE `A0`.`NAME` = ?</span><br><span class="line"></span><br><span class="line">检查数据库发现DBS 有2个字段没有。在 hive-schema-3.1.0.mysql.sql 找到对应的 建表语句。将缺失字段添加回去</span><br><span class="line">ALTER TABLE `DBS` ADD `OWNER_NAME` varchar(128);</span><br><span class="line">ALTER TABLE `DBS` ADD `OWNER_TYPE` varchar(10);</span><br><span class="line">alter table DBS change `CTLG_NAME` `CTLG_NAME` varchar(256) NOT NULL DEFAULT <span class="string">&#x27;hive&#x27;</span> after OWNER_TYPE;</span><br><span class="line">问题解决</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>6.当新旧集群nameserver 不一样<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> dbs <span class="keyword">SET</span> DB_LOCATION_URI <span class="operator">=</span> REPLACE(db_location_uri,<span class="string">&#x27;$oldClustername&#x27;</span>,<span class="string">&#x27;$newClustername&#x27;</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> sds <span class="keyword">SET</span> location <span class="operator">=</span> REPLACE(location,<span class="string">&#x27;$oldClustername&#x27;</span>,<span class="string">&#x27;$newClustername&#x27;</span>);</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>hadoop</category>
      </categories>
      <tags>
        <tag>hive</tag>
      </tags>
  </entry>
  <entry>
    <title>gtid purged 的巧用</title>
    <url>/2022/10/18/useGtidPurged/</url>
    <content><![CDATA[<h3 id="今天根据冷备搭建主从-出现问题总结"><a href="#今天根据冷备搭建主从-出现问题总结" class="headerlink" title="今天根据冷备搭建主从,出现问题总结"></a>今天根据冷备搭建主从,出现问题总结</h3><h4 id="1-UUID-相同"><a href="#1-UUID-相同" class="headerlink" title="1 UUID 相同   ."></a>1 UUID 相同   .</h4><p>   清除 auto.cnf 文件。重启 重新生成UUID</p>
<h4 id="2-change-master-后-报-从库需要的binglog-已经被主库purged"><a href="#2-change-master-后-报-从库需要的binglog-已经被主库purged" class="headerlink" title="2.change master 后  报 从库需要的binglog 已经被主库purged"></a>2.change master 后  报 从库需要的binglog 已经被主库purged</h4><p>   查询主库的 gtid_purged<br>   设置从库的gtid purged<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">master:</span><br><span class="line">show global variables like <span class="string">&#x27;%gtid%&#x27;</span> </span><br><span class="line">gtid_purged=<span class="string">&#x27;32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-181880&#x27;</span></span><br><span class="line"></span><br><span class="line">slave: </span><br><span class="line">reset master;</span><br><span class="line">reset slave all;</span><br><span class="line"><span class="built_in">set</span> global gtid_purged=<span class="string">&#x27;32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-181880&#x27;</span></span><br><span class="line">change master to ........ master_auto_position=1;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-发现从库是从已存的主库binlog-开始读取。这使从库落后5万多秒。"><a href="#3-发现从库是从已存的主库binlog-开始读取。这使从库落后5万多秒。" class="headerlink" title="3 发现从库是从已存的主库binlog 开始读取。这使从库落后5万多秒。"></a>3 发现从库是从已存的主库binlog 开始读取。这使从库落后5万多秒。</h4><p>分析从库正在执行的binlog 这些binglog 正是在写一个大表。而这个大表刚好是要清除掉的。<br>怎样修改 主库的gtid_purged<br>主库gtid purged 记录的是被清除binlog 的最后一个 gtid 。要跳过这些已经执行过的binlog .那么就需要再重置一次binlog purged<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> purge master logs to <span class="string">&#x27;mysql-bin.000112&#x27;</span>;</span><br><span class="line">mysql.sock@(none)&gt; show global variables like <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br><span class="line">| Variable_name                   | Value                                         |</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery     | OFF                                           |</span><br><span class="line">| enforce_gtid_consistency        | ON                                            |</span><br><span class="line">| gtid_executed                   | 32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-187811 |</span><br><span class="line">| gtid_mode                       | ON                                            |</span><br><span class="line">| gtid_owned                      |                                               |</span><br><span class="line">| gtid_purged                     | 32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-187809 |</span><br><span class="line">| simplified_binlog_gtid_recovery | OFF                                           |</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br></pre></td></tr></table></figure><br>主库的gtid_purged 已经跳到已知最后一个binlog </p>
<p>重置从库。重新设置主从关系。将gtid_purged 设置到 32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-187809</p>
<p>从库成功跳过不需要执行的binlog .正常运行</p>
<h4 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h4><p>这些操作基于冷备。主从库的数据是一致的。而且中间没有任何其他操作在主库产生。如有,则要知道那些必须执行过的操作落在哪。<br>取主库重启后第一个产生的Binlog 为界限。</p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>mysql 5.6</tag>
        <tag>gtid</tag>
      </tags>
  </entry>
  <entry>
    <title>记一次 waiting for table flush 故障</title>
    <url>/2023/09/06/waitTableFlush/</url>
    <content><![CDATA[<p>早上运维同事说某一个应用的数据库突然报 too many session<br>于是登上数据库查看。发现数据库里堆积了有1000个会话。并且全部处于state: waiting for table flush<br>优先处理故障，将所有阻塞语句全部杀掉</p>
<p>通过监控，agent 日志等发现有一个慢语句在昨天下午两点多一直运行到早上5点。在慢语句系统中找出来发现<br>这个语句2表关联查询。并没有关联条件。导致SQL 出现笛卡尔积。因为表比较大。导致SQL 一直运行。可这个<br>语句为啥会导致 在5点钟左右开始所有的会话都陷入等待呢。</p>
<p>最终排查到我们的定时任务刚好在4点57 分开始。<br>xtrabackup 备份 会在备份非innodb 文件之前执行 flush tables with read lock. 以确保备份一致性。<br>这个时候一个长查询一直没有结束。导致 xtrabckup 进入等待，又因为是获取全局读锁。导致其他会话进来<br>后也一起陷入 waiting for table flush 。最终连接被耗尽，故障发生。</p>
<p>对于xtrabackup 官网针对这个问题提供了一些解决方案<br><a href="https://docs.percona.com/percona-xtrabackup/2.4/innobackupex/improved_ftwrl.html">https://docs.percona.com/percona-xtrabackup/2.4/innobackupex/improved_ftwrl.html</a></p>
<p>通过对下列参数的设置。可以避免trabackup 长时间等待，从而引发系统故障。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ftwrl-wait-query-type             ALL  <span class="comment"># which long queries should be finished before ftwrl</span></span><br><span class="line">ftwrl-wait-threshold              60   <span class="comment"># how long query should be running before we consider it long running and potential blocker of global lock</span></span><br><span class="line">kill-long-query-type              SELECT <span class="comment"># which queries should be killed once kill-long-queries-timeout has expired.</span></span><br><span class="line">kill-long-queries-timeout         0    <span class="comment"># how many time we give for queries to complete after FLUSH TABLES WITH READ LOCK is issued before start to kill. Default if 0, not to kill</span></span><br><span class="line">ftwrl-wait-timeout                0    <span class="comment"># how long to wait for a good moment. Default is 0, not to wait.</span></span><br><span class="line"></span><br><span class="line">example:</span><br><span class="line">$ innobackupex --ftwrl-wait-threshold=40 --ftwrl-wait-query-type=all --ftwrl-wait-timeout=180 --kill-long-queries-timeout=20 --kill-long-query-type=all /data/backups/</span><br></pre></td></tr></table></figure><br>当然对数据库长查询的监控也很有必要。之前是通过邮件告警。告警太多。被淹没了。这次也将告警接入企微。更加重视它。</p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>long query</tag>
        <tag>xtrabackup</tag>
      </tags>
  </entry>
  <entry>
    <title>PG的预写日志WAL(Write-Ahead Logging)</title>
    <url>/2022/10/31/wal/</url>
    <content><![CDATA[<p>WAL(Write-Ahead Logging)是保证数据完整性的一种标准方法,WAL的中心概念是数据文件（存储着表和索引）的修改必须在这些动作被日志记录之后才被写入，即在描述这些改变的日志记录被刷到持久存储以后。<br>WAL日志存放在pg_wal目录中。wal 的大小默认16M，可以在初始化数据库(initdb)的时候通过—wal-segsize 来修改其大小。<br>WAL文件中的每一个记录都被一个CRC-32（32位）校验码所保护，这让我们可以判断记录内容是否正确。CRC值在我们写入每一个WAL记录时设置，并且在崩溃恢复、归档恢复和复制时检查<br>使用 WAL 会显着减少磁盘写入次数，因为只需要将日志文件刷新到磁盘以保证事务被提交，而不是事务更改的每个数据文件。 日志文件是按顺序写入的，因此同步日志的成本远低于刷新数据页的成本。 对于处理涉及数据存储不同部分的许多小事务的服务器来说尤其如此。 此外，当服务器正在处理许多小的并发事务时，日志文件的一个 fsync 可能足以提交许多事务。<br>WAL 也使在线备份数据库以及基于时间点的恢复得以实现。</p>
<p>配置WAL的相关参数<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">checkpoint_timeout  </span><br><span class="line">    <span class="number">1.</span> 每次发动一次checkpoint的间隔时间。检查点在每 checkpoint_timeout 秒开始 或者在wal 存储量快要超过 max_wal_size</span><br><span class="line">       时开始。(默认值分表为 <span class="number">5</span>min,<span class="number">1</span>G)</span><br><span class="line">    <span class="number">2.</span> 在每一个checkpoint 时刻，所有的脏数据页都将被刷到磁盘，并且一个特殊的检查点记录将被写入日志文件</span><br><span class="line">      （修改记录之前已经被刷写到wal日志里面）</span><br><span class="line">    <span class="number">3.</span> 在崩溃时，崩溃恢复过程检查最新的检查点记录用来决定从日志中的哪一点（称为重做记录）开始REDO操作，因为在这个检查点</span><br><span class="line">       之前的数据都已经刷盘。</span><br><span class="line">    <span class="number">4.</span> 如果在前一个检查点以来都没有WAL被写入。即使过了checkpoint_timeout，新的检查点也会被跳过</span><br><span class="line">    <span class="number">5.</span> 如果在进行WAL归档，并想通过更高的频率来归档WAL日志段来防止数据的丢失。则需要调整的是 archive_timeout 参数，而</span><br><span class="line">       不是checkpoint_timeout 参数</span><br><span class="line">    <span class="number">6.</span> 可以通过<span class="keyword">SQL</span> 命令 CHECKPOINT 强制设置检查点</span><br><span class="line">    <span class="number">7.</span> 减少 checkpoint_timeout 的时间间隔或降低 max_wal_size 的容量限制将会使检查点发出得更为频繁，这虽然能在崩溃后</span><br><span class="line">       更快的恢复，但会因为更多的刷新脏页数据带来更多的IO开销。如果还设置了full_page_writes，为了保证页面的一致性，在</span><br><span class="line">       每个检查点之后对一个数据页的第一次修改，将会对这个页整页的数据写入日志，因此会导致更多的WAL日志量的产生。无论如</span><br><span class="line">       何都会导致更多的磁盘IO产生。</span><br><span class="line">    <span class="number">8.</span> 将checkpoint_timeout 设置足够长的时间是比较合理的做法，可以设置 checkpoint_warning 作为检查点的简单性检查，如</span><br><span class="line">       果由于填充wal文件引起的检查点发生的时间比这个时间更近，则向服务器日志写入一条消息，这表明应该增加 max_wal_size 。 </span><br><span class="line">       checkpoint_warning 默认<span class="number">30</span>s ，没有写明单位时以秒为单位。</span><br><span class="line"></span><br><span class="line">checkpoint_completion_target</span><br><span class="line">    <span class="number">1.</span> 设置检查点将IO操作平均在 checkpoint_timeout <span class="operator">*</span> checkpoint_completion_target 时间内。避免大批页面写入对I<span class="operator">/</span>O系统</span><br><span class="line">       产生的冲击</span><br><span class="line">    <span class="number">2.</span> 在<span class="number">14</span>版开始该参数默认值为<span class="number">0.9</span>，以前版本为<span class="number">0.5</span></span><br><span class="line">    <span class="number">3.</span> 假设有<span class="number">100</span>G 的数据要刷出，checkpoint_timeout 为<span class="number">5</span>min </span><br><span class="line">       当 checkpoint_completion_target 设置为<span class="number">0.5</span>时</span><br><span class="line">       IO 需要承当 <span class="number">100</span> <span class="operator">/</span> (<span class="number">0.5</span> <span class="operator">*</span> <span class="number">60</span> <span class="operator">*</span> <span class="number">5</span>) <span class="operator">*</span> <span class="number">1024</span> <span class="operator">~</span> <span class="number">682</span> M<span class="operator">/</span>s 的写速率</span><br><span class="line">       当 checkpoint_completion_target 设置为<span class="number">0.9</span>时</span><br><span class="line">       IO 需要承当 <span class="number">100</span> <span class="operator">/</span> (<span class="number">0.9</span> <span class="operator">*</span> <span class="number">60</span> <span class="operator">*</span> <span class="number">5</span>) <span class="operator">*</span> <span class="number">1024</span> <span class="operator">~</span> <span class="number">379</span> M<span class="operator">/</span>s 的写速率</span><br><span class="line">    <span class="number">4.</span> checkpoint_completion_target 的值越高则IO 承担的压力相对较小。对系统更友好。不会因为IO繁忙导致系统顿卡</span><br><span class="line">    <span class="number">5.</span> 虽然该值能设置大于<span class="number">1.0</span> ，但也不要设置 <span class="operator">&gt;=</span> <span class="number">1.0</span> ,因为checkpoint 除了刷数据，还需要做一些别的动作。<span class="number">1.0</span>的设置极有可能</span><br><span class="line">       导致检查点不能按时被完成，这可能由于所需的WAL段数量意外变化导致性能损失</span><br><span class="line">    </span><br><span class="line">checkpoint_flush_after</span><br><span class="line">    <span class="number">1.</span> 当发生检查点时，写入超过 checkpoint_flush_after 数量的数据，将尝试强制操作系统将这些写入发出到底层存储。这样做将</span><br><span class="line">       限制内核页面缓存中的脏数据量，从而减少在检查点结束时发出 fsync 或操作系统在后台以较大批量写回数据时发生停顿的可能</span><br><span class="line">       性。</span><br><span class="line">    <span class="number">2.</span> 通常这会减少失误的延迟。但对于工作负载大于 shared_buffers 但又小余系统缓存页的情况有不利影响。</span><br><span class="line">    <span class="number">3.</span> 该参数在Linux 和 POSIX 系统有效，在linux 上默认值为<span class="number">256</span>kB,其他平台则设置为<span class="number">0</span> 禁用。最大值<span class="number">2</span>MB</span><br><span class="line"></span><br><span class="line">max_wal_size min_wal_size </span><br><span class="line">    <span class="number">1.</span> 这<span class="number">2</span>个参数决定存放在 pg_wal 里面WAL 的数量。</span><br><span class="line">    <span class="number">2.</span> 如果短期内WAL产生数的峰值超过 max_wal_size ，则移除不需要的 wal 文件，直到系统回到 max_wal_size 的限制之下</span><br><span class="line">    <span class="number">3.</span> 当低于 max_wal_size 的限制时，系统就会循环使用足够的 wal 文件直到下一个检查点所需要的量。这种需要是基于之前的检查点</span><br><span class="line">       周期中使用的WAL 文件数量的移动平均数估算出来的。如果实际用量超过估计值，移动平均数会立即增加，因此它能在一定程度上适</span><br><span class="line">       应峰值用量而不是平均用量</span><br><span class="line">    <span class="number">4.</span> min_wal_size 对回收给未来使用的 WAL 文件的量设置了一个最小值。这个参数指定数量的 WAL 将总是被回收给未来使用，即便系</span><br><span class="line">       统很闲并且 WAL用量估计建议只需要一点点 WAL 时也是如此</span><br><span class="line"></span><br><span class="line">wal_keep_size (<span class="number">12</span>及以前版本 wal_keep_segments )</span><br><span class="line">    <span class="number">1.</span> 控制在pg_wal 中保留 wal 日志的最小数量：wal_keep_size <span class="operator">+</span> <span class="number">1</span> wal 文件大小的总和。另外开启了归档，在未归档之前，wal的日</span><br><span class="line">       志不能被移除也不能被覆盖。 </span><br><span class="line">    <span class="number">2.</span> 这个参数设置是为了保证流复制期间。从库能够从主库获取足够所需的wal，保证复制的正常。如果有开启归档，从库没能在pg_wal中</span><br><span class="line">       获取足够的wal日志恢复，则可以通过在归档中获取对应的日志来恢复。直到追上主库。</span><br><span class="line">    <span class="number">3.</span> 如果归档跟不上 WAL 生成的速度，或者如果 archive_command 反复失败，旧的 WAL 文件将堆积在 pg_wal 中，直到情况得到解决。 </span><br><span class="line">       使用复制槽的慢速或故障备用服务器将产生相同的效果。</span><br><span class="line">    </span><br><span class="line">在恢复和归档模式下，服务器还会定期执行重启点。服务器将其所有状态强制刷盘，更新 pg_control 文件，以指示无需再扫描已处理的wal</span><br><span class="line">数据，然后回收 pg_wal中所有的旧 wal 文件。重启点在主库上只能在检查点记录处执行，即在至少经过 checkpoint_timeout 时间之后或</span><br><span class="line">者在wal总量即将到达 max_wal_size 之时到达检查点从而触发重启点。但是由于何时可以执行重启点的限制。在恢复期间通常会超过 max_wal_size,</span><br><span class="line">最多超过一个检查点周期的wal,wal_max_size 并不是一个硬限制，无论何时。服务器上都应该保留有足够的空间。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>个常用的 wal 内部函数：XLogInsertRecord 和 XLogFlush 。XLogInsertRecord 用于将一条新记录放置在共享内存中的WAL buffer中。</span><br><span class="line">如果没有足够的空间放置新纪录，XLogInsertRecord 不得不向内核缓存写出一些已经填满的 WAL 缓存，这是不可取的。</span><br><span class="line">因为 XLogInsertRecord用于每个数据库低级别的修改(比如 <span class="keyword">insert</span>),同时需要在受影响的数据页上持有排他锁，这就要求它尽可能快。但写</span><br><span class="line">入 WAL 缓冲区还可能带来更糟糕的后果就是强制开新的日志段，这要求更多的时间。通常 WAL 缓存应该由 XLogFlush 请求和写入刷新，</span><br><span class="line">该请求在大多数情况下在事务提交时进行，以确保事务记录被刷新到永久存储。 在具有高日志输出的系统上， XLogFlush 请求出现的频率可能</span><br><span class="line">不足以阻止 XLogInsertRecord 进行写入。在这样的系统上，应该通过修改 wal_buffers 参数来增加 WAL 缓冲区的数量。当设置了 </span><br><span class="line">full_page_writes 并且系统非常繁忙时，将 wal_buffers 设置得更高将有助于在每个检查点之后的时间段内平滑响应时间。</span><br><span class="line"></span><br><span class="line">commit_delay </span><br><span class="line">    <span class="number">1.</span> 该参数定义了组提交领导进程在 XLogFlush 里面获得锁后将休眠多少微秒,而组提交的跟随者跟在领导者后面排队。</span><br><span class="line">    <span class="number">2.</span> 这个休眠时间允许其他服务将其提交记录追加到 WAL 缓存区，以便它们跟随领导进程的最终同步操作一起刷出到存储。</span><br><span class="line">    <span class="number">3.</span> 如果fsync 没启动或者当前处于活动的事务少于 commit_siblings 则不发生休眠</span><br><span class="line">    <span class="number">4.</span> 有些平台要求休眠时间是<span class="number">10</span>毫秒，所以只要是非<span class="number">0</span>值，<span class="number">1</span><span class="number">-10000</span>微秒之间的取值都是相同的效果</span><br><span class="line">    <span class="number">5.</span> 同样有些平台实际上的休眠时间会比 commit_delay 设置的时间长一些</span><br><span class="line"></span><br><span class="line">    设置commit_delay 只在两种情况下有帮助</span><br><span class="line">    <span class="number">1</span>) 有一些并发提交的事务</span><br><span class="line">    <span class="number">2</span>) 吞吐量在某种程度上被提交率限制</span><br><span class="line">    但是在高旋转延迟的设备上，即使少到只有两个客户端，该设置也能有效提高事务吞吐量。</span><br><span class="line"></span><br><span class="line">wal_sync_method：设置 wal 刷盘的方式</span><br><span class="line">    <span class="number">1.</span> open_datasync (通过<span class="keyword">open</span>() 函数的 O_DSYNC 选项写WAL 文件)</span><br><span class="line">    <span class="number">2.</span> fdatasync (在每次<span class="keyword">commit</span> 的时候调用 fdatasync() 函数)</span><br><span class="line">    <span class="number">3.</span> fsync (在每次<span class="keyword">commit</span> 的时候调用 fsync() 函数)</span><br><span class="line">    <span class="number">4.</span> fsync_writethrough (在每一次<span class="keyword">commit</span> 的时候调用 fsync() 函数, 强制直通写入任何磁盘缓存)</span><br><span class="line">    <span class="number">5.</span> open_sync (通过<span class="keyword">open</span>() 函数的 O_SYNC 选项 写 WAL 文件)</span><br><span class="line">    如果sync 关闭了，则此设置无关重要</span><br><span class="line"></span><br><span class="line">将wal 数据写入磁盘有<span class="number">2</span>个内置函数 XLogWrite 和 issue_xlog_fsync。当启用 track_wal_io_timing 参数</span><br><span class="line">时，XLogWrite 的写入时间 与 issue_xlog_fsync 的同步时间分别记录在 pg_wal_stat 的wal_write_time</span><br><span class="line">和 wal_sync_time 。通常 XLogInsertRecord 、XLogFlush 和 WAL writer 都会调用到 XLogWrite 函数</span><br><span class="line">将WAL 缓存写入磁盘，XLogWrite 则调用 issue_xlog_fsync 将WAL 文件同步到磁盘。如果 wal_sync_method </span><br><span class="line">是 open_datasync 或 open_sync，XLogWrite 中的写操作保证将写入的 WAL 数据同步到磁盘，而 issue_xlog_fsync </span><br><span class="line">则什么都不做。如果 wal_sync_method 是 fdatasync , fsync 和 fsync_writethrough ，写操作将WAL 缓存</span><br><span class="line">写入内核缓存，然后 issue_xlog_fsync 函数将它们同步到磁盘。如果设置了 track_wal_io_timing 参数，则</span><br><span class="line">XLogWrite 以及 issue_xlog_fsync 耗用的时间都会记录在 pg_stat_wal 的 wal_write 和 wal_sync 字段里。</span><br></pre></td></tr></table></figure></p>
<p>WAL 内部<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">wal 记录每次写入wal 日志的位置 用LSN（<span class="built_in">log</span> sequence number）来描述，它是日志中的字节偏移量</span><br><span class="line">wal 日志存放在 pg_wal 目录中，以每个默认<span class="number">16</span>M的段文件存放。（可以在initdb 的时候通过--wal-segsize 参数修改大小）</span><br><span class="line">每一个段文件都是由 <span class="number">8</span>kB 大小的页面组成 （可以通过配置--with-wal-blocksize 修改页面大小）</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogRecord</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        uint32          xl_tot_len;             <span class="comment">/* total len of entire record */</span></span><br><span class="line">        TransactionId xl_xid;           <span class="comment">/* xact id */</span></span><br><span class="line">        XLogRecPtr      xl_prev;                <span class="comment">/* ptr to previous record in log */</span></span><br><span class="line">        uint8           xl_info;                <span class="comment">/* flag bits, see below */</span></span><br><span class="line">        RmgrId          xl_rmid;                <span class="comment">/* resource manager for this record */</span></span><br><span class="line">        <span class="comment">/* 2 bytes of padding here, initialize to zero */</span></span><br><span class="line">        pg_crc32c       xl_crc;                 <span class="comment">/* CRC for this record */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* XLogRecordBlockHeaders and XLogRecordDataHeader follow, no padding */</span></span><br><span class="line"></span><br><span class="line">&#125; XLogRecord;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogRecordBlockHeader</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        uint8           id;                             <span class="comment">/* block reference ID */</span></span><br><span class="line">        uint8           fork_flags;             <span class="comment">/* fork within the relation, and flags */</span></span><br><span class="line">        uint16          data_length;    <span class="comment">/* number of payload bytes (not including page</span></span><br><span class="line"><span class="comment">                                                                 * image) */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* If BKPBLOCK_HAS_IMAGE, an XLogRecordBlockImageHeader struct follows */</span></span><br><span class="line">        <span class="comment">/* If BKPBLOCK_SAME_REL is not set, a RelFileNode follows */</span></span><br><span class="line">        <span class="comment">/* BlockNumber follows */</span></span><br><span class="line">&#125; XLogRecordBlockHeader;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>postgresql</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>wal</tag>
      </tags>
  </entry>
  <entry>
    <title>用xtrabackup 备份恢复Docker 的实例</title>
    <url>/2023/07/17/xtrabackupwithDocker/</url>
    <content><![CDATA[<p>1.拉取 xtrbackup Docker 镜像<br>镜像版本可以在 <a href="https://hub.docker.com/r/percona/percona-xtrabackup/tags">https://hub.docker.com/r/percona/percona-xtrabackup/tags</a> 查找<br><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pull percona/percona-xtrabackup:8.0.33-27 </span><br></pre></td></tr></table></figure></p>
<p>2.写一个可以支持全备和增量备份的脚本。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> xtrabackupDocker.sh </span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="comment"># 注意所有要docker挂载的路径都要有777 权限。否则都会报权限错误</span></span><br><span class="line"><span class="comment"># 全备和增备都以日期目录存储</span></span><br><span class="line"><span class="comment"># 增量备份 为取全备目录里面最新的一个全备为基础备份。没有基础备份退出增量备份</span></span><br><span class="line"></span><br><span class="line">fullTag=<span class="variable">$1</span></span><br><span class="line">BACKUP_PATH=/data/percona_data/backup</span><br><span class="line"></span><br><span class="line">today=`<span class="built_in">date</span> +<span class="string">&#x27;%Y%m%d_%H%M&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment">##创建备份路径</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">build_path</span></span>()&#123;</span><br><span class="line">   <span class="keyword">if</span> [ ! -d <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">mkdir</span> -p <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full</span><br><span class="line">      <span class="built_in">chmod</span> 777 <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">if</span> [ ! -d <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">mkdir</span> -p <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc</span><br><span class="line">      <span class="built_in">chmod</span> 777 <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 全备函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">full_backup</span></span>()&#123;</span><br><span class="line">   <span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full</span><br><span class="line">   <span class="keyword">if</span> [ -d <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full/<span class="variable">$today</span> ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">rm</span> -rf <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full/<span class="variable">$today</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   <span class="built_in">mkdir</span> <span class="variable">$today</span></span><br><span class="line">   <span class="built_in">chmod</span> 777 <span class="variable">$today</span></span><br><span class="line">   </span><br><span class="line">   docker run --name percona-xtrabackup \</span><br><span class="line">     --volumes-from percona-server8033 \    </span><br><span class="line">     -v <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full/<span class="variable">$today</span>:/backup \</span><br><span class="line">     percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">     xtrabackup --backup --datadir=/var/lib/mysql/ --target-dir=/backup \</span><br><span class="line">     --user=root --password=123456</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 增量备份</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">inc_backup</span></span>()&#123;</span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc</span><br><span class="line">  <span class="keyword">if</span> [ -d <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc/<span class="variable">$today</span> ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">rm</span> -rf <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc/<span class="variable">$today</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">mkdir</span> <span class="variable">$today</span></span><br><span class="line">  <span class="built_in">chmod</span> 777 <span class="variable">$today</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full</span><br><span class="line">  last_full=<span class="variable">$BACKUP_PATH</span>/full/$(<span class="built_in">ls</span> -t | <span class="built_in">head</span> -1)</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$last_full</span>&quot;</span> = <span class="string">&quot;<span class="variable">$BACKUP_PATH</span>/full/&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">     <span class="built_in">exit</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc</span><br><span class="line">  docker run --name percona-xtrabackup \</span><br><span class="line">     --volumes-from percona-server8033 \</span><br><span class="line">     -v <span class="variable">$last_full</span>:/backup \</span><br><span class="line">     -v <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc/<span class="variable">$today</span>:/inc \</span><br><span class="line">     percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">     xtrabackup --backup --datadir=/var/lib/mysql/ --target-dir=/inc \</span><br><span class="line">     --incremental-basedir=/backup \</span><br><span class="line">     --user=root --password=123456</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">##创建路径</span></span><br><span class="line">build_path || <span class="built_in">return</span> 1</span><br><span class="line"></span><br><span class="line"><span class="comment">##清除docker 容器</span></span><br><span class="line">containerId=`docker ps -a |grep percona-xtrabackup|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">docker <span class="built_in">rm</span> <span class="variable">$containerId</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$fullTag</span>&quot;</span> = <span class="string">&quot;full&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">   full_backup</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   inc_backup</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p>
<p>3.发起备份<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x xtrabackupDocker.sh</span><br><span class="line">./xtrabackupDocker.sh full <span class="comment">## 为发起全备</span></span><br><span class="line">./xtrabackupDocker.sh <span class="comment">## 不加参数为增备</span></span><br></pre></td></tr></table></figure></p>
<p>4.恢复备份<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span>  /data/percona_data/backup/full</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">20230714_1528</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建恢复容器</span></span><br><span class="line">docker create --name percona-xtrabackup_recovery --volumes-from percona-server8033 \</span><br><span class="line">-v /data/percona_data/backup/full/20230714_1528:/backup \</span><br><span class="line">-v /data/percona_data/conf/my.cnf:/etc/mysql/conf.d/my.cnf \</span><br><span class="line">percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">xtrabackup --defaults-file=/etc/mysql/conf.d/my.cnf  --prepare --target-dir=/backup \</span><br><span class="line">--user=root --password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment">## 执行恢复命令</span></span><br><span class="line">docker start -ai percona-xtrabackup  <span class="comment"># 第一遍执行</span></span><br><span class="line">docker start -ai percona-xtrabackup  <span class="comment"># 第二遍执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将目录拷回原来的数据目录</span></span><br><span class="line">docker stop percona-server8033</span><br><span class="line"><span class="built_in">cd</span> /data/percona_data/</span><br><span class="line"><span class="built_in">mv</span> data8033 data8033_bak</span><br><span class="line"><span class="built_in">mv</span> /data/percona_data/backup/full/20230714_1528 data8033</span><br><span class="line">docker start percona-server8033</span><br></pre></td></tr></table></figure></p>
<p>5.增量备份的恢复<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 先全量恢复。需要带  --apply-log-only 只应用日志</span></span><br><span class="line">docker run --name percona-xtrabackup_recovery --volumes-from percona-server8033 \</span><br><span class="line">-v /data/percona_data/backup/full/20230714_1528:/backup \</span><br><span class="line">-v /data/percona_data/conf/my.cnf:/etc/mysql/conf.d/my.cnf \</span><br><span class="line">percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">xtrabackup --defaults-file=/etc/mysql/conf.d/my.cnf  --prepare --apply-log-only --target-dir=/backup \</span><br><span class="line">--user=root --password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment">## 跑完就删 container .或者指定不同名字的container </span></span><br><span class="line"></span><br><span class="line">docker ps -a |grep percona-xtrabackup_recovery </span><br><span class="line">docker <span class="built_in">rm</span> <span class="variable">$container_id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 恢复增量 本文实例为基于全量的增量。所以恢复时只需要指定最后一个增量 </span></span><br><span class="line"><span class="comment">## 如果是多级增量备份 只要不是最后一个增量，就需要加上 --apply-log-only 选项。最后一个增量恢复去除该选项即可</span></span><br><span class="line">docker run --name percona-xtrabackup_recovery --volumes-from percona-server8033 \</span><br><span class="line">-v /data/percona_data/backup/inc/20230715_1528:/inc \</span><br><span class="line">-v /data/percona_data/conf/my.cnf:/etc/mysql/conf.d/my.cnf \</span><br><span class="line">percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">xtrabackup --defaults-file=/etc/mysql/conf.d/my.cnf  --prepare --target-dir=/backup \</span><br><span class="line">--user=root --password=123456</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>6.利用备份恢复为从库<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 先建一个从库的container </span></span><br><span class="line"><span class="comment">## 从库配置文件myslave.cnf 配置好从库相关选项。server-id 不能跟主库一样</span></span><br><span class="line">docker run -d \</span><br><span class="line">--name=percona-server8033_slave \</span><br><span class="line">-v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">-v /etc/timezone:/etc/timezone  \</span><br><span class="line">-v /data/percona_data/data8033_slave:/var/lib/mysql \</span><br><span class="line">-v /data/percona_data/conf/myslave.cnf:/etc/my.cnf \</span><br><span class="line">-p 3307:3306 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">percona/percona-server:8.0.33-25  \</span><br><span class="line">--character-set-server=utf8mb4 \</span><br><span class="line">--collation-server=utf8mb4_unicode_ci</span><br><span class="line"></span><br><span class="line">[root@localhost backup]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE                                  COMMAND                  CREATED      STATUS                  PORTS                                                  NAMES</span><br><span class="line">9a2016f84858   percona/percona-server:8.0.33-25       <span class="string">&quot;/docker-entrypoint.…&quot;</span>   2 days ago   Up 2 days               33060/tcp, 0.0.0.0:3307-&gt;3306/tcp, :::3307-&gt;3306/tcp   percona-server8033_slave</span><br><span class="line">docker logs 9a2016f84858 --follow</span><br><span class="line"></span><br><span class="line"><span class="comment">## 等初始化完成之后，停掉container</span></span><br><span class="line">docker stop percona-server8033_slave</span><br><span class="line"><span class="comment">## 恢复备份</span></span><br><span class="line">docker create --name percona-xtrabackup_recovery --volumes-from percona-server8033 \</span><br><span class="line">-v /data/percona_data/backup/full/20230714_1528:/backup \</span><br><span class="line">-v /data/percona_data/conf/my.cnf:/etc/mysql/conf.d/my.cnf \</span><br><span class="line">percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">xtrabackup --defaults-file=/etc/mysql/conf.d/my.cnf  --prepare --target-dir=/backup \</span><br><span class="line">--user=root --password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment">## 执行恢复命令</span></span><br><span class="line">docker start -ai percona-xtrabackup  <span class="comment"># 第一遍执行</span></span><br><span class="line">docker start -ai percona-xtrabackup  <span class="comment"># 第二遍执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 替换目录，将恢复的目录替为 /data/percona_data/data8033_slave 的目录</span></span><br><span class="line"><span class="built_in">mv</span> /data/percona_data/data8033_slave /data/percona_data/data8033_slave_bak</span><br><span class="line"><span class="built_in">mv</span> /data/percona_data/backup/full/20230714_1528 /data/percona_data/data8033_slave</span><br><span class="line"><span class="built_in">chmod</span> 777 /data/percona_data/data8033_slave</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动 从库容器</span></span><br><span class="line">docker start percona-server8033_slave</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在主库创建复制账号</span></span><br><span class="line">docker <span class="built_in">exec</span> -it percona-server8033 mysql -uroot -p123456 -e <span class="string">&quot;create user repl@&#x27;%&#x27; identified by &#x27;repl&#x27;;grant select,replication slave on *.* to repl@&#x27;%&#x27;;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 获取备份时的gtid 信息</span></span><br><span class="line"><span class="built_in">cd</span>  data8033_slave</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> xtrabackup_info</span><br><span class="line">...</span><br><span class="line">binlog_pos = filename <span class="string">&#x27;binlog.000007&#x27;</span>, position <span class="string">&#x27;197&#x27;</span>, GTID of the last change <span class="string">&#x27;c1ef4787-206b-11ee-8d03-0242ac110002:1-77&#x27;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置从库gtid 信息</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it percona-server8033_slave mysql -uroot -p123456 -e <span class="string">&quot;reset slave;reset master; set gtid_purged=&#x27;c1ef4787-206b-11ee-8d03-0242ac110002:1-77&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置从库连接主库信息</span></span><br><span class="line">docker <span class="built_in">exec</span> -it percona-server8033_slave mysql -uroot -p123456 -e <span class="string">&quot;CHANGE REPLICATION SOURCE TO \</span></span><br><span class="line"><span class="string">&gt; SOURCE_HOST=&#x27;192.168.56.15&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_PORT=3306,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_USER=&#x27;repl&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_PASSWORD=&#x27;repl&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_AUTO_POSITION=1;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it percona-server8033_slave mysql -uroot -p123456 -e <span class="string">&quot;start slave;show slave status\G&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>percona</tag>
        <tag>xtrabackup</tag>
      </tags>
  </entry>
  <entry>
    <title>Percona xtradb Cluster 5.7 安装</title>
    <url>/2022/10/17/xtradbClusterInstall/</url>
    <content><![CDATA[<h3 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h3><p>oracle vbox : centos 7  xtradb cluster 5.7 </p>
<h3 id="1-修改主机节点名称"><a href="#1-修改主机节点名称" class="headerlink" title="1.修改主机节点名称"></a>1.修改主机节点名称</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">192.168.56.6</span><br><span class="line"><span class="comment"># hostnamectl --static set-hostname pxcnode1</span></span><br><span class="line">192.168.56.7</span><br><span class="line"><span class="comment"># hostnamectl --static set-hostname pxcnode2</span></span><br><span class="line">192.168.56.8</span><br><span class="line"><span class="comment"># hostnamectl --static set-hostname pxcnode3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span></span><br><span class="line">&gt; 192.168.56.6  pxcnode1</span><br><span class="line">&gt; 192.168.56.7  pxcnode2</span><br><span class="line">&gt; 192.168.56.8  pxcnode3</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h3 id="2-关闭防火墙"><a href="#2-关闭防火墙" class="headerlink" title="2.关闭防火墙"></a>2.关闭防火墙</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl stop firewalld</span></span><br><span class="line"><span class="comment"># systemctl disable firewalld</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables -F</span></span><br></pre></td></tr></table></figure>
<h3 id="3-关闭selinux"><a href="#3-关闭selinux" class="headerlink" title="3.关闭selinux"></a>3.关闭selinux</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span></span><br><span class="line"><span class="comment"># setenforce 0</span></span><br><span class="line"><span class="comment"># getenforce</span></span><br></pre></td></tr></table></figure>
<h3 id="4-修改内核参数"><a href="#4-修改内核参数" class="headerlink" title="4.修改内核参数"></a>4.修改内核参数</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; /etc/security/limits.conf &lt;&lt;EOF</span></span><br><span class="line">&gt; mysql  soft   <span class="built_in">nproc</span>     2047 </span><br><span class="line">&gt; mysql  hard   <span class="built_in">nproc</span>     16384</span><br><span class="line">&gt; mysql  soft   nofile    1024</span><br><span class="line">&gt; mysql  hard   nofile    65536</span><br><span class="line">&gt; mysql  soft   stack     10240</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h3 id="5-修改登陆用户"><a href="#5-修改登陆用户" class="headerlink" title="5.修改登陆用户"></a>5.修改登陆用户</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; /etc/profile &lt;&lt;EOF</span></span><br><span class="line">&gt; <span class="keyword">if</span> [ <span class="variable">$USER</span> = <span class="string">&quot;mysql&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">&gt;     <span class="keyword">if</span> [ <span class="variable">$SHELL</span> = <span class="string">&quot;/bin/ksh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">&gt;         <span class="built_in">ulimit</span> -p 16384</span><br><span class="line">&gt;         <span class="built_in">ulimit</span> -n 65536</span><br><span class="line">&gt;     <span class="keyword">else</span></span><br><span class="line">&gt;         <span class="built_in">ulimit</span> -u 16384 -n 65536</span><br><span class="line">&gt;     <span class="keyword">fi</span></span><br><span class="line">&gt;     <span class="built_in">umask</span> 022</span><br><span class="line">&gt; <span class="keyword">fi</span></span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h3 id="6-安装相关依赖包"><a href="#6-安装相关依赖包" class="headerlink" title="6.安装相关依赖包"></a>6.安装相关依赖包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y perl-DBD-MySQL perl-Digest-MD5 perl-Env perl-Test* openssl openssl-devel</span></span><br></pre></td></tr></table></figure>
<h3 id="7-查看并卸载-mariadb"><a href="#7-查看并卸载-mariadb" class="headerlink" title="7.查看并卸载 mariadb"></a>7.查看并卸载 mariadb</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpm -qa |grep mariadb</span></span><br><span class="line"><span class="comment"># mariadb-libs-5.5.68-1.el7.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -e mariadb-libs-5.5.68-1.el7.x86_64 --nodeps</span></span><br></pre></td></tr></table></figure>
<h3 id="8-安装percona-repo-源-相关版本包"><a href="#8-安装percona-repo-源-相关版本包" class="headerlink" title="8.安装percona repo 源 相关版本包"></a>8.安装percona repo 源 相关版本包</h3><p>在网站上下载安装包安装的话，依赖太多。直接下载repo 源安装<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yum install -y Percona-XtraDB-Cluster-57</span></span><br></pre></td></tr></table></figure></p>
<h3 id="9-安装完后会发现每个节点都已经启动了一个实例，将实例停止"><a href="#9-安装完后会发现每个节点都已经启动了一个实例，将实例停止" class="headerlink" title="9.安装完后会发现每个节点都已经启动了一个实例，将实例停止"></a>9.安装完后会发现每个节点都已经启动了一个实例，将实例停止</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ps -ef |grep mysql</span></span><br><span class="line"><span class="comment"># systemctl stop mysql</span></span><br><span class="line"></span><br><span class="line">删除实例产生的文件 </span><br><span class="line"><span class="comment"># rm -rf /var/lib/mysql</span></span><br></pre></td></tr></table></figure>
<h3 id="10-创建目录"><a href="#10-创建目录" class="headerlink" title="10. 创建目录"></a>10. 创建目录</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /data/mysql/&#123;data,redo,undo,log,run&#125;</span></span><br><span class="line"><span class="comment"># cd /data</span></span><br><span class="line"><span class="comment"># chown -R mysql.mysql /data/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cd /data/mysql/</span></span><br><span class="line"><span class="comment"># chmod 700 </span></span><br></pre></td></tr></table></figure>
<h3 id="11-修改-etc-my-cnf"><a href="#11-修改-etc-my-cnf" class="headerlink" title="11.修改 /etc/my.cnf"></a>11.修改 /etc/my.cnf</h3><h4 id="1-可以在这2个目录中分别配置mysql-参数以及-xtradb-cluster-参数"><a href="#1-可以在这2个目录中分别配置mysql-参数以及-xtradb-cluster-参数" class="headerlink" title="1) 可以在这2个目录中分别配置mysql 参数以及 xtradb-cluster 参数"></a>1) 可以在这2个目录中分别配置mysql 参数以及 xtradb-cluster 参数</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!includedir /etc/my.cnf.d/</span></span><br><span class="line"><span class="comment">#!includedir /etc/percona-xtradb-cluster.conf.d/</span></span><br></pre></td></tr></table></figure>
<h4 id="2）为测试方便。这里注释掉这2个。直接把所有参数写到一个文件里"><a href="#2）为测试方便。这里注释掉这2个。直接把所有参数写到一个文件里" class="headerlink" title="2）为测试方便。这里注释掉这2个。直接把所有参数写到一个文件里"></a>2）为测试方便。这里注释掉这2个。直接把所有参数写到一个文件里</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The Percona XtraDB Cluster 5.7 configuration file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># * IMPORTANT: Additional settings that can override those from this file!</span></span><br><span class="line"><span class="comment">#   The files must end with &#x27;.cnf&#x27;, otherwise they&#x27;ll be ignored.</span></span><br><span class="line"><span class="comment">#   Please make any edits and changes to the appropriate sectional files</span></span><br><span class="line"><span class="comment">#   included below.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#!includedir /etc/my.cnf.d/</span></span><br><span class="line"><span class="comment">#!includedir /etc/percona-xtradb-cluster.conf.d/</span></span><br><span class="line">[client]</span><br><span class="line">socket=/data/mysql/run/mysql.sock</span><br><span class="line">[mysqld_safe]</span><br><span class="line">pid-file = /data/mysql/run/mysql.pid</span><br><span class="line">socket   = /data/mysql/run/mysql.sock</span><br><span class="line"><span class="built_in">nice</span>     = 0</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#skip-grant-tables</span></span><br><span class="line"><span class="comment">#skip-name-resolve = 1</span></span><br><span class="line">user = mysql</span><br><span class="line">port = 3306</span><br><span class="line">server-id = 6</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line">basedir = /usr</span><br><span class="line">datadir = /data/mysql/data</span><br><span class="line">socket = /data/mysql/run/mysql.sock</span><br><span class="line">pid-file = /data/mysql/run/mysql.pid</span><br><span class="line">max_connections = 300</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">wait_timeout = 10800</span><br><span class="line">interactive_timeout = 10800</span><br><span class="line">log_timestamps = SYSTEM</span><br><span class="line">log-error = /data/mysql/log/error.log</span><br><span class="line"><span class="comment">#log_warnings = 2</span></span><br><span class="line">log_error_verbosity = 2</span><br><span class="line"><span class="comment">#slow_query_log = on</span></span><br><span class="line">slow_query_log_file = /data/mysql/log/mysql-slow.log</span><br><span class="line"><span class="comment">#long_query_time = 3</span></span><br><span class="line"><span class="comment">#log_queries_not_using_indexes = on</span></span><br><span class="line"><span class="comment">#general_log = on</span></span><br><span class="line">general_log_file = /data/mysql/log/mysql-general.log</span><br><span class="line">innodb_flush_log_at_trx_commit = 2</span><br><span class="line">innodb_log_buffer_size = 16777216</span><br><span class="line">innodb_log_file_size = 256M</span><br><span class="line">innodb_log_files_in_group = 3</span><br><span class="line">innodb_buffer_pool_size = 512M</span><br><span class="line">innodb_log_group_home_dir = /data/mysql/redo</span><br><span class="line">innodb_undo_directory = /data/mysql/undo</span><br><span class="line">innodb_undo_tablespaces = 2</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_write_io_threads = 8</span><br><span class="line">innodb_read_io_threads = 8</span><br><span class="line">innodb_page_cleaners = 16</span><br><span class="line">innodb_io_capacity = 300</span><br><span class="line">query_cache_type = off</span><br><span class="line">query_cache_size = 0</span><br><span class="line">max_heap_table_size = 64M</span><br><span class="line">tmp_table_size = 64M</span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line">thread_cache_size = 50</span><br><span class="line">open_files_limit = 65535</span><br><span class="line">table_definition_cache = 4096</span><br><span class="line">table_open_cache = 5000</span><br><span class="line">secure_file_priv = /data/mysql/data/</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line"><span class="comment">###Percona Xtradb Cluster Wsrep Configure</span></span><br><span class="line">binlog_format = ROW</span><br><span class="line">default_storage_engine = INNODB</span><br><span class="line">innodb_autoinc_lock_mode = 2</span><br><span class="line"><span class="comment">#innodb_locks_unsafe_for_binlog = 1</span></span><br><span class="line">wsrep_retry_autocommit = 1</span><br><span class="line">wsrep_auto_increment_control = 1</span><br><span class="line">wsrep_provider = /usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_provider_options = <span class="string">&quot;gcache.page_size=64M;gcache.size=1G;gcs.fc_limit=512;gcs.fc_factor=0.9;evs.send_window=256;evs.user_send_window=128&quot;</span></span><br><span class="line">wsrep_cluster_name = <span class="string">&quot;mysql_galera_cluster&quot;</span></span><br><span class="line"><span class="comment">#wsrep_cluster_address = gcomm://</span></span><br><span class="line">wsrep_cluster_address = <span class="string">&quot;gcomm://192.168.56.6,192.168.56.7,192.168.56.8&quot;</span></span><br><span class="line">wsrep_node_name = pxc-cluster1</span><br><span class="line">wsrep_node_address = 192.168.56.6</span><br><span class="line">pxc_strict_mode = PERMISSIVE</span><br><span class="line"><span class="comment">#wsrep_sst_method = rsync</span></span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line">wsrep_slave_threads=8</span><br><span class="line">wsrep_sst_auth=<span class="string">&quot;sstuser:passw0rd&quot;</span></span><br></pre></td></tr></table></figure>
<p>  注意wsrep_sst_auth 为 配置sst 的用户名以及密码</p>
<h3 id="12-启动第一个节点"><a href="#12-启动第一个节点" class="headerlink" title="12.启动第一个节点"></a>12.启动第一个节点</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysql@bootstrap</span></span><br><span class="line"></span><br><span class="line">启动成功后登陆数据库重新设置root 密码（初始化密码在err 文件里面）以及 sst 用户账号密码</span><br><span class="line"><span class="comment"># mysql -uroot -p -S /data/mysql/run/mysql.sock</span></span><br><span class="line"></span><br><span class="line">mysql &gt; alter user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;sheen$123&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">mysql &gt; GRANT PROCESS,RELOAD,LOCK TABLES,REPLICATION CLIENT ON *.* TO <span class="string">&#x27;sstuser&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;passw0rd&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql &gt; flush privileges;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="13-将配置文件发送到其他2个节点。并修改相关设置"><a href="#13-将配置文件发送到其他2个节点。并修改相关设置" class="headerlink" title="13.将配置文件发送到其他2个节点。并修改相关设置"></a>13.将配置文件发送到其他2个节点。并修改相关设置</h3><p>  server-id = {7,8}<br>  wsrep_node_name = {pxc-cluster2,pxc-cluster3}<br>  wsrep_node_address = {192.168.56.7,192.168.56.8}</p>
<h3 id="14-在192-168-56-7-启动第二个节点"><a href="#14-在192-168-56-7-启动第二个节点" class="headerlink" title="14.在192.168.56.7 启动第二个节点"></a>14.在192.168.56.7 启动第二个节点</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysql   (注意集群只有第一个节点启动需要  @bootstrap)</span></span><br></pre></td></tr></table></figure>
<p>观察err.log 看是否正常启动</p>
<h3 id="15-在192-168-56-8-启动第三个节点"><a href="#15-在192-168-56-8-启动第三个节点" class="headerlink" title="15.在192.168.56.8 启动第三个节点"></a>15.在192.168.56.8 启动第三个节点</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysql   (注意集群只有第一个节点启动需要  @bootstrap)</span></span><br></pre></td></tr></table></figure>
<h3 id="16-集群验证"><a href="#16-集群验证" class="headerlink" title="16.集群验证"></a>16.集群验证</h3><h4 id="1）-完整性验证"><a href="#1）-完整性验证" class="headerlink" title="1） 完整性验证"></a>1） 完整性验证</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; show global status <span class="built_in">where</span> variable_name <span class="keyword">in</span></span><br><span class="line">(<span class="string">&#x27;wsrep_cluster_state_uuid&#x27;</span>,<span class="string">&#x27;wsrep_cluster_conf_id&#x27;</span>,<span class="string">&#x27;wsrep_cluster_size&#x27;</span>,<span class="string">&#x27;wsrep_cluster_status&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>注意：正常情况下以下指标值，在所有节点应该都是一致的</p>
<p>wsrep_cluster_state_uuid：在集群所有节点中该值应该是相同的，若有不同值，说明该节点没有连入集群</p>
<p>wsrep_cluster_conf_id：在集群所有节点中该值应该是相同的，若有不同值，说明该节点被临时”分区”了，当节点之间网络连接恢复后，该值应该恢复成一致</p>
<p>wsrep_cluster_size：如果与集群中的节点数一致，说明所有节点已经连接</p>
<p>wsrep_cluster_status：集群状态，若不为”Primary”，说明出现”分区”或是”split-brain”状况</p>
<h4 id="2）-节点状态检查"><a href="#2）-节点状态检查" class="headerlink" title="2） 节点状态检查"></a>2） 节点状态检查</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; show global status <span class="built_in">where</span> variable_name <span class="keyword">in</span></span><br><span class="line">(<span class="string">&#x27;wsrep_ready&#x27;</span>,<span class="string">&#x27;wsrep_connected&#x27;</span>,<span class="string">&#x27;wsrep_local_state_comment&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>wsrep_ready：该值为ON，则说明可以接受SQL负载；如果为OFF，则需要检查wsrep_connected</p>
<p>wsrep_connected：如果该值为OFF，且wsrep_ready的值也为OFF，则说明该节点没有连入集群</p>
<p>(可能是wsrep_cluster_address或wsrep_cluster_name等配置错误造成的，具体需要排查错误日志)</p>
<p>wsrep_local_state_comment：若wsrep_connected为ON，但wsrep_ready为OFF，则可以从该项查看原因</p>
<h4 id="3）-集群健康度检查"><a href="#3）-集群健康度检查" class="headerlink" title="3） 集群健康度检查"></a>3） 集群健康度检查</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql &gt; show global status <span class="built_in">where</span> variable_name <span class="keyword">in</span></span><br><span class="line">(<span class="string">&#x27;wsrep_flow_control_paused&#x27;</span>,<span class="string">&#x27;wsrep_cert_deps_distance&#x27;</span>,<span class="string">&#x27;wsrep_flow_control_sent&#x27;</span>,<span class="string">&#x27;wsrep_local_recv_queue_avg&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>wsrep_flow_control_paused：表示复制停止了多长时间</p>
<p>（即因Slave延迟而慢的程度，取值范围为0~1，越靠近0越好，值为1表示复制完全停止（停止广播），可优化wsrep_slave_threads的值来改善）</p>
<p>wsrep_cert_deps_distance：表示有多少事务可以并行应用处理，wsrep_slave_threads设置的值不应该高出该值太多</p>
<p>wsrep_flow_control_sent：表示该节点已经停止复制了多少次</p>
<p>wsrep_local_recv_queue_avg：表示slave事务队列的平均长度，slave瓶颈的预兆</p>
<h3 id="16-错误排查"><a href="#16-错误排查" class="headerlink" title="16.错误排查"></a>16.错误排查</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">在启动第二节点时，报错无法启动。看第一个节点日志报如下错误</span><br><span class="line">2022/08/29 09:37:21 socat[25648] E write(6, 0x564dea85bda0, 161): No route to host</span><br><span class="line">2022/08/29 09:37:22 socat[25652] E write(6, 0x56309d047da0, 161): No route to host</span><br><span class="line">2022/08/29 09:37:23 socat[25656] E write(6, 0x55d9b229fda0, 161): No route to host</span><br><span class="line">2022/08/29 09:37:24 socat[25660] E write(6, 0x55a3732bfda0, 161): No route to host</span><br><span class="line">2022/08/29 09:37:25 socat[25663] E write(6, 0x5598aa784da0, 161): No route to host</span><br><span class="line">        2022-08-29T09:37:26.737381+08:00 WSREP_SST: [ERROR] ******************* FATAL ERROR **********************</span><br><span class="line">        2022-08-29T09:37:26.738401+08:00 WSREP_SST: [ERROR] Error <span class="keyword">while</span> sending data to joiner node:  <span class="built_in">exit</span> codes: 0 1</span><br><span class="line">        2022-08-29T09:37:26.740138+08:00 WSREP_SST: [ERROR] ******************************************************</span><br><span class="line">        2022-08-29T09:37:26.741128+08:00 WSREP_SST: [ERROR] Cleanup after <span class="built_in">exit</span> with status:32</span><br><span class="line">2022-08-29T09:37:26.749151+08:00 0 [ERROR] WSREP: Process completed with error: wsrep_sst_xtrabackup-v2 --role <span class="string">&#x27;donor&#x27;</span> --address <span class="string">&#x27;192.168.56.7:4444/xtrabackup_sst//1&#x27;</span> --socket <span class="string">&#x27;/data/  mysql/run/mysql.sock&#x27;</span> --datadir <span class="string">&#x27;/data/mysql/data/&#x27;</span> --defaults-file <span class="string">&#x27;/etc/my.cnf&#x27;</span> --defaults-group-suffix <span class="string">&#x27;&#x27;</span> --mysqld-version <span class="string">&#x27;5.7.38-41-57&#x27;</span>   <span class="string">&#x27;&#x27;</span> --gtid   <span class="string">&#x27;fd5bdb71-2513-11ed-8942-0f1687c72112:4&#x27;</span> : 32 (Broken pipe)</span><br><span class="line">2022-08-29T09:37:26.749194+08:00 0 [ERROR] WSREP: Command did not run: wsrep_sst_xtrabackup-v2 --role <span class="string">&#x27;donor&#x27;</span> --address <span class="string">&#x27;192.168.56.7:4444/xtrabackup_sst//1&#x27;</span> --socket <span class="string">&#x27;/data/mysql/  run/mysql.sock&#x27;</span> --datadir <span class="string">&#x27;/data/mysql/data/&#x27;</span> --defaults-file <span class="string">&#x27;/etc/my.cnf&#x27;</span> --defaults-group-suffix <span class="string">&#x27;&#x27;</span> --mysqld-version <span class="string">&#x27;5.7.38-41-57&#x27;</span>   <span class="string">&#x27;&#x27;</span> --gtid   <span class="string">&#x27;fd5bdb71-2513-11ed-8942-0f1687c72112:4&#x27;</span></span><br><span class="line">2022-08-29T09:37:26.750072+08:00 0 [Warning] WSREP: 1.0 (pxc-cluster1): State transfer to 0.0 (pxc-cluster2) failed: -32 (Broken pipe)</span><br></pre></td></tr></table></figure>
<p>出现这个错误是防火墙的问题。 执行 iptables -F 清除防火墙规则</p>
]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>database</tag>
        <tag>cluster</tag>
        <tag>percona</tag>
      </tags>
  </entry>
</search>
