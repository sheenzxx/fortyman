<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sheenzxx.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="数据库相关技术研究,自动化运维">
<meta property="og:type" content="website">
<meta property="og:title" content="sheen&#39;s Blog">
<meta property="og:url" content="https://sheenzxx.github.io/page/4/index.html">
<meta property="og:site_name" content="sheen&#39;s Blog">
<meta property="og:description" content="数据库相关技术研究,自动化运维">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sheen">
<meta property="article:tag" content="Python,shell,SQL,oracle,mysql,postgresql">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://sheenzxx.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>sheen's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="sheen's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">sheen's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">随笔，技术笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/home/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/03/27/DatanodeErrSignal15/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/27/DatanodeErrSignal15/" class="post-title-link" itemprop="url">datanode 无法启动报  RECEIVED SIGNAL 15  SIGTERM</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-27 10:19:04" itemprop="dateCreated datePublished" datetime="2023-03-27T10:19:04+08:00">2023-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-04-07 14:22:43" itemprop="dateModified" datetime="2023-04-07T14:22:43+08:00">2023-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index"><span itemprop="name">hadoop</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天发现有个节点dead node .于是重启了datanode<br>./hadoop-daemond.sh stop datanode<br>./hadoop-daemond.sh start datanode<br>监控页面 dead node 状态依然没有改变。</p>
<p>查看日志发现出现如下错误<br>23/03/27 09:45:04 ERROR org.apache.hadoop.hdfs.server.datanode.DataNode: RECEIVED SIGNAL 15: SIGTERM</p>
<p>在节点上运行<br>hdfs dfsadmin -refreshNodes</p>
<p>问题解决</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/03/22/confluenceDbConfig/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/22/confluenceDbConfig/" class="post-title-link" itemprop="url">confluence 数据库配置要求</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-03-22 10:36:01 / 修改时间：13:22:07" itemprop="dateCreated datePublished" datetime="2023-03-22T10:36:01+08:00">2023-03-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>摘抄自官方文档<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">配置文件</span><br><span class="line"><span class="comment">## 字符集要求</span></span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line">collation-server=utf8mb4_bin</span><br><span class="line"><span class="comment">##存储引擎要求(现在mysql 默认都是这个引擎)</span></span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line"><span class="comment">## 要求允许通讯包体的大小</span></span><br><span class="line">max_allowed_packet=256M</span><br><span class="line"><span class="comment">## redolog 大小</span></span><br><span class="line">innodb_log_file_size=2GB</span><br><span class="line"><span class="comment">## sql_mode 需要去除这个选项。如果存在</span></span><br><span class="line">sql_mode = NO_AUTO_VALUE_ON_ZERO</span><br><span class="line"><span class="comment">## 事务隔离级别</span></span><br><span class="line">transaction-isolation=READ-COMMITTED</span><br><span class="line"><span class="comment">## binlog 格式设置 row</span></span><br><span class="line">binlog_format=row</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line"><span class="comment">## 5.7 版本optimizer_switch 里面 设置 derived_merge=off 默认on</span></span><br><span class="line">optimizer_switch = derived_merge=off</span><br><span class="line"></span><br><span class="line"><span class="comment">## SQL 命令</span></span><br><span class="line">CREATE DATABASE &lt;database-name&gt; CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;</span><br><span class="line">GRANT ALL PRIVILEGES ON &lt;database-name&gt;.* TO <span class="string">&#x27;&lt;confluenceuser&gt;&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">## mysql driver</span></span><br><span class="line"><span class="comment">## mysql 5.7 版本</span></span><br><span class="line"> mysql-connector-java-5.1.xx-bin.jar</span><br><span class="line"><span class="comment">## mysql 8.0 版本</span></span><br><span class="line"> mysql-connector-java-8.0.xx-bin.jar</span><br><span class="line"><span class="comment">## 放在下面的目录</span></span><br><span class="line">  &lt;installation-directory&gt;/confluence/WEB-INF/lib </span><br><span class="line"></span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/03/14/upgradeHiveMeta/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/14/upgradeHiveMeta/" class="post-title-link" itemprop="url">升级hivemeta库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-14 12:28:38" itemprop="dateCreated datePublished" datetime="2023-03-14T12:28:38+08:00">2023-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-28 15:35:42" itemprop="dateModified" datetime="2023-08-28T15:35:42+08:00">2023-08-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index"><span itemprop="name">hadoop</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>公司升级了hive 由 1.2 升级到 3.1,这里涉及到元数据的搬迁过程。元数据信息存储在mysql中</p>
<h4 id="升级过程"><a href="#升级过程" class="headerlink" title="升级过程"></a>升级过程</h4><ol>
<li><p>将旧库导出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uxxxx -pxxxx-S /tmp/mysql.sock --routines  --triggers --set-gtid-purged=off --default-character-set=latin1 hadoop &gt;hadoop_hive.1.2.sql</span><br></pre></td></tr></table></figure>
</li>
<li><p>将数据导入新的mysql实例中，如果已经是有搭建了3.x 版本的Hive 并联数据库产生了元数据的表，则先删除库。然后导入数据，不然升级脚本会报很多冲突</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uxxx -pxxx hadoop /tmp/mysql.sock &lt; hadoop_hive.1.2.sql</span><br></pre></td></tr></table></figure></li>
<li>在新库中执行 1.2.0 的表创建脚本(可能该版本是由以前的版本升上来的。部分表缺失，重新建表，对于存在的表则不会再建)<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/PRG/hive/scripts/metastore/upgrade/mysql  <span class="comment"># hive 版本升级脚本存放目录</span></span><br><span class="line">mysql -uxxx -pxxx hadoop /tmp/mysql.sock &lt; hive-schema-1.2.0.mysql.sql</span><br></pre></td></tr></table></figure></li>
<li><p>安装版本脚本进行一个个执行升级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#根据升级脚本，一个个版本叠加上来，就不会报错</span></span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-1.2.0-to-2.0.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-2.0.0-to-2.1.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-2.1.0-to-2.2.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-2.2.0-to-2.3.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-2.3.0-to-3.0.0.mysql.sql</span><br><span class="line">mysql -uxxx -pxxxx hadoop -S /tmp/mysql.hadoop.sock &lt; upgrade-3.0.0-to-3.1.0.mysql.sql</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">javax.jdo.JDOException: Exception thrown when executing query : SELECT <span class="string">&#x27;org.apache.hadoop.hive.metastore.model.MDatabase&#x27;</span> AS `NUCLEUS_TYPE`,`A0`.`DESC`,`A0`.`DB_LOCATION_URI`,`A0`.`NAME`,`A0`.`OWNER_NAME`,`A0`.`OWNER_TYPE`,`A0`.`D</span><br><span class="line">B_ID` FROM `DBS` `A0` WHERE `A0`.`NAME` = ?</span><br><span class="line"></span><br><span class="line">检查数据库发现DBS 有2个字段没有。在 hive-schema-3.1.0.mysql.sql 找到对应的 建表语句。将缺失字段添加回去</span><br><span class="line">ALTER TABLE `DBS` ADD `OWNER_NAME` varchar(128);</span><br><span class="line">ALTER TABLE `DBS` ADD `OWNER_TYPE` varchar(10);</span><br><span class="line">alter table DBS change `CTLG_NAME` `CTLG_NAME` varchar(256) NOT NULL DEFAULT <span class="string">&#x27;hive&#x27;</span> after OWNER_TYPE;</span><br><span class="line">问题解决</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>6.当新旧集群nameserver 不一样<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> dbs <span class="keyword">SET</span> DB_LOCATION_URI <span class="operator">=</span> REPLACE(db_location_uri,<span class="string">&#x27;$oldClustername&#x27;</span>,<span class="string">&#x27;$newClustername&#x27;</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> sds <span class="keyword">SET</span> location <span class="operator">=</span> REPLACE(location,<span class="string">&#x27;$oldClustername&#x27;</span>,<span class="string">&#x27;$newClustername&#x27;</span>);</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/03/09/MysqlInDockerReplication/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/09/MysqlInDockerReplication/" class="post-title-link" itemprop="url">docker容器下创建mysql主从集群</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-09 15:28:41" itemprop="dateCreated datePublished" datetime="2023-03-09T15:28:41+08:00">2023-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-17 15:16:23" itemprop="dateModified" datetime="2023-07-17T15:16:23+08:00">2023-07-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="准备条件"><a href="#准备条件" class="headerlink" title="准备条件"></a>准备条件</h3><p>docker 已安装，mysql 镜像已拉取，这里以mysql/mysql-server:8.0 镜像为例</p>
<h3 id="创建mysql-主库"><a href="#创建mysql-主库" class="headerlink" title="创建mysql 主库"></a>创建mysql 主库</h3><p>配置文件中必须要有server-id，主从库必须不一样,在my.cnf 指定 </p>
<p>log-bin = mysql-bin<br>log-bin-index = mysql-bin.index<br>server-id=185<br>gtid-mode=on<br>enforce_gtid_consistency = 1<br>binlog-format=row<br>log_replica_updates = 1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建指定目录。</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data/mysql_data/&#123;conf,data,<span class="built_in">log</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动主库容器</span></span><br><span class="line">docker run -p 3306:3306 --name mysql8-1 \ <span class="comment">##映射端口 跟给container 取个名字</span></span><br><span class="line">-v /data/mysql8_data/log:/var/log/mysql \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 日志</span></span><br><span class="line">-v /data/mysql8_data:/var/lib/mysql \  <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 数据目录</span></span><br><span class="line">-v /data/mysql8_data/conf/my.cnf:/etc/my.cnf \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 配置文件</span></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root123 \  <span class="comment">## -e 环境变量.初始化时设置数据库的root 密码</span></span><br><span class="line">-d mysql/mysql-server:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看数据库日志是否正常</span></span><br><span class="line">docker logs mysql8-1 2&gt;&amp;1 </span><br></pre></td></tr></table></figure>
<h3 id="创建mysql-从库"><a href="#创建mysql-从库" class="headerlink" title="创建mysql 从库"></a>创建mysql 从库</h3><p>配置文件中必须要有server-id，主从库必须不一样,在my.cnf 指定<br>port = 3307<br>log-bin = mysql-bin<br>log-bin-index = mysql-bin.index<br>server-id=186<br>gtid-mode=on<br>enforce_gtid_consistency = 1<br>binlog-format=row<br>log_replica_updates = 1<br>read_only<br>relay-log = relay-bin<br>relay_log_recovery = 1<br>replica_skip_errors = off</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建指定目录。</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data/mysql_slave_data/&#123;conf,data,<span class="built_in">log</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动主库容器</span></span><br><span class="line">docker run -p 3307:3307 --name mysql8-slave \ <span class="comment">##映射端口 跟给container 取个名字</span></span><br><span class="line">-v /data/mysql8_slave_data/log:/var/log/mysql \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 日志</span></span><br><span class="line">-v /data/mysql8_slave_data:/var/lib/mysql \  <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 数据目录</span></span><br><span class="line">-v /data/mysql8_slave_data/conf/my.cnf:/etc/my.cnf \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 配置文件</span></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root123 \  <span class="comment">## -e 环境变量.初始化时设置数据库的root 密码</span></span><br><span class="line">-d mysql/mysql-server:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看数据库日志是否正常</span></span><br><span class="line">docker logs mysql8-slave 2&gt;&amp;1 </span><br></pre></td></tr></table></figure>
<h3 id="创建复制用户"><a href="#创建复制用户" class="headerlink" title="创建复制用户"></a>创建复制用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql8-1 mysql -uroot -proot123 -e <span class="string">&quot;create user repl@&#x27;%&#x27; identified by &#x27;replpass&#x27;;grant select,replication slave on *.* to repl@&#x27;%&#x27;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="从库执行复制配置"><a href="#从库执行复制配置" class="headerlink" title="从库执行复制配置"></a>从库执行复制配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql8-slave mysql -uroot -proot123 -e <span class="string">&quot;CHANGE REPLICATION SOURCE TO \</span></span><br><span class="line"><span class="string">&gt; SOURCE_HOST=&#x27;192.168.56.15&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_PORT=3306,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_USER=&#x27;repl&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_PASSWORD=&#x27;replpass&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_AUTO_POSITION=1,\</span></span><br><span class="line"><span class="string">&gt; GET_MASTER_PUBLIC_KEY=1;&quot;</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql8-slave mysql -uroot -proot123 -e <span class="string">&quot;start replica;&quot;</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql8-slave mysql -uroot -proot123 -e <span class="string">&quot;show replicat status\G&quot;</span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             Replica_IO_State: Waiting <span class="keyword">for</span> <span class="built_in">source</span> to send event</span><br><span class="line">                  Source_Host: 192.168.56.15</span><br><span class="line">                  Source_User: repl</span><br><span class="line">                  Source_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Source_Log_File: mysql-bin.000007</span><br><span class="line">          Read_Source_Log_Pos: 508</span><br><span class="line">               Relay_Log_File: relay-bin.000007</span><br><span class="line">                Relay_Log_Pos: 460</span><br><span class="line">        Relay_Source_Log_File: mysql-bin.000007</span><br><span class="line">           Replica_IO_Running: Yes</span><br><span class="line">          Replica_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Source_Log_Pos: 508</span><br><span class="line">              Relay_Log_Space: 1231</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Source_SSL_Allowed: No</span><br><span class="line">           Source_SSL_CA_File: </span><br><span class="line">           Source_SSL_CA_Path: </span><br><span class="line">              Source_SSL_Cert: </span><br><span class="line">            Source_SSL_Cipher: </span><br><span class="line">               Source_SSL_Key: </span><br><span class="line">        Seconds_Behind_Source: 0</span><br><span class="line">Source_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Source_Server_Id: 185</span><br><span class="line">                  Source_UUID: fca3aab0-bd94-11ed-9a7c-0242ac110002</span><br><span class="line">             Source_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">    Replica_SQL_Running_State: Replica has <span class="built_in">read</span> all relay <span class="built_in">log</span>; waiting <span class="keyword">for</span> more updates</span><br><span class="line">           Source_Retry_Count: 86400</span><br><span class="line">                  Source_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Source_SSL_Crl: </span><br><span class="line">           Source_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: fca3aab0-bd94-11ed-9a7c-0242ac110002:1-8</span><br><span class="line">            Executed_Gtid_Set: 8239dff7-bf0e-11ed-9ce5-0242ac110002:1-3,</span><br><span class="line">fca3aab0-bd94-11ed-9a7c-0242ac110002:1-8</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Source_TLS_Version: </span><br><span class="line">       Source_public_key_path: </span><br><span class="line">        Get_Source_public_key: 1</span><br><span class="line">            Network_Namespace: </span><br></pre></td></tr></table></figure>
<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><p>mysql8 默认是采用 caching_sha2_password 的密码加密方式，如果我们在 CHANGE REPLICATION SOURCE时<br>没有指定 GET_MASTER_PUBLIC_KEY=1。则在 start replica 的时候 会出现错误:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">error connecting to master <span class="string">&#x27;repl@192.168.56.15:3306&#x27;</span> - retry-time: 60 retries: 6 message:</span><br><span class="line">Authentication plugin <span class="string">&#x27;caching_sha2_password&#x27;</span> reported error: </span><br><span class="line">Authentication requires secure connection</span><br></pre></td></tr></table></figure><br>或者重置复制账号的密码为 mysql_native_password 的加密方式<br>alter user repl@’%’ identified with mysql_native_password by ‘replpass’;</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/03/09/o12cstartup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/09/o12cstartup/" class="post-title-link" itemprop="url">oracle 12c 设置开机启动</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2023-03-09 15:25:51 / 修改时间：15:27:18" itemprop="dateCreated datePublished" datetime="2023-03-09T15:25:51+08:00">2023-03-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>1.编辑 /etc/oratab  默认值是N 修改为Y<br>orcl:/data/oracle/product/12.2.0/db_1:Y</p>
<p>2.编辑 vi $ORACLE_HOME/bin/dbstart<br>将ORACLE_HOME_LISTNER=$1修改成 ORACLE_HOME_LISTNER=$ORACLE_HOME</p>
<p>3.在 /etc/rc.d/rc.local 添加 。这个启动包含 listener 启动<br>su - oracle -lc /data/oracle/product/12.2.0/db_1/bin/dbstart</p>
<p>4.启动时 只是启动实例。需要再将PDB 打开，可以通过trigger 设置自动打开所有pdb</p>
<p>在sqlplus / as sysdba</p>
<p>create trigger open_all_pdbs<br>AFTER STARTUP<br>ON DATABASE<br>BEGIN<br>  EXECUTE IMMEDIATE ‘alter pluggable database all open’;<br>end open_all_pdbs;<br>/<br>执行</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/03/08/mysqlindocker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/08/mysqlindocker/" class="post-title-link" itemprop="url">docker 安装mysql</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-08 18:04:29" itemprop="dateCreated datePublished" datetime="2023-03-08T18:04:29+08:00">2023-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-10 16:50:37" itemprop="dateModified" datetime="2023-03-10T16:50:37+08:00">2023-03-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="下载安装docker"><a href="#下载安装docker" class="headerlink" title="下载安装docker"></a>下载安装docker</h3><p>执行如下命令。等待安装完成<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br></pre></td></tr></table></figure></p>
<h3 id="拉取mysql-镜像"><a href="#拉取mysql-镜像" class="headerlink" title="拉取mysql 镜像"></a>拉取mysql 镜像</h3><p>看mysql 官方文档使用的是 mysql/mysql-server:tag 的版本。那我们就下载这个版本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql/mysql-server:8.0</span><br><span class="line"></span><br><span class="line">docker images</span><br><span class="line">[root@localhost mysql8_data]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY           TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">mysql                latest    4f06b49211c0   12 days ago   530MB</span><br><span class="line">mysql/mysql-server   8.0       1d9c2219ff69   7 weeks ago   496MB</span><br></pre></td></tr></table></figure></p>
<h3 id="启动镜像并进行相关检查"><a href="#启动镜像并进行相关检查" class="headerlink" title="启动镜像并进行相关检查"></a>启动镜像并进行相关检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql8-1 --restart on-failure -d mysql/mysql-server:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看正在运行的container</span></span><br><span class="line">docker ps</span><br><span class="line">[root@localhost mysql8_data]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS                    PORTS                                                        NAMES</span><br><span class="line">ac42ef0a7b2c   mysql/mysql-server:8.0   <span class="string">&quot;/entrypoint.sh mysq…&quot;</span>   33 minutes ago   Up 16 minutes (healthy)   0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060-33061/tcp   mysql8-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看数据库的日志</span></span><br><span class="line">docker logs mysql8-1 2&gt;&amp;1 | grep GENERATED</span><br><span class="line">GENERATED ROOT PASSWORD: Axegh3kAJyDLaRuBemecis&amp;EShOs</span><br><span class="line"></span><br><span class="line"><span class="comment">#登录mysql</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql8-1 mysql -uroot -p </span><br><span class="line"><span class="comment">#修改密码</span></span><br><span class="line">mysql&gt; ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;password&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>到此。一个简单的mysql 实例就被挂起来了<br>将mysql 的配置文件复制出来看看<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> mysql8-1:/etc/my.cnf ./</span><br><span class="line">里面只有几个很简单的参数 </span><br><span class="line"></span><br><span class="line"><span class="comment">#登录docker container 查看mysql 的文件</span></span><br><span class="line">docker <span class="built_in">exec</span> it mysql8-1 bash</span><br><span class="line">bash-4.4<span class="comment"># cd /var/lib/mysql </span></span><br><span class="line">bash-4.4<span class="comment"># ls</span></span><br><span class="line"><span class="string">&#x27;#ib_16384_0.dblwr&#x27;</span>   auto.cnf          dbindocker       mysql-bin.000001   mysql.ibd            public_key.pem    undo_002</span><br><span class="line"><span class="string">&#x27;#ib_16384_1.dblwr&#x27;</span>   ca-key.pem        ib_buffer_pool   mysql-bin.000002   mysql.sock           server-cert.pem</span><br><span class="line"><span class="string">&#x27;#innodb_redo&#x27;</span>        ca.pem            ibdata1          mysql-bin.000003   mysql.sock.lock      server-key.pem</span><br><span class="line"><span class="string">&#x27;#innodb_temp&#x27;</span>        client-cert.pem   ibtmp1           mysql-bin.000004   performance_schema   sys</span><br><span class="line"> ac42ef0a7b2c.pid     client-key.pem    mysql            mysql-bin.index    private_key.pem      undo_001</span><br></pre></td></tr></table></figure><br>到目前为止。一个mysql实例就成功跑起来了。不过，数据什么的都在container 里面。这在生产上绝对是不符合的</p>
<h3 id="将数据文件映射到宿主机上"><a href="#将数据文件映射到宿主机上" class="headerlink" title="将数据文件映射到宿主机上"></a>将数据文件映射到宿主机上</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#停掉并删除刚才启动的container</span></span><br><span class="line">docker stop mysql8-1</span><br><span class="line">docker <span class="built_in">rm</span> mysql8-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#在本地建好路径</span></span><br><span class="line"><span class="built_in">mkdir</span> /data/mysql8_data</span><br><span class="line"><span class="built_in">mkdir</span> /data/mysql8_data/&#123;<span class="built_in">log</span>,conf,data&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑一个my.cnf 放 /data/mysql8_data/conf/my.cnf</span></span><br><span class="line"><span class="comment"># 不能让mysql8_data 成为数据库目录。初始化时会检查到存在文件。会初始化失败</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重新拉起一个container</span></span><br><span class="line">docker run -p 3306:3306 --name mysql8-1 \ <span class="comment">##映射端口 跟给container 取个名字</span></span><br><span class="line">-v /data/mysql8_data/log:/var/log/mysql \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 日志</span></span><br><span class="line">-v /data/mysql8_data:/var/lib/mysql \  <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 数据目录</span></span><br><span class="line">-v /data/mysql8_data/conf/my.cnf:/etc/my.cnf \ <span class="comment">## -v 使用volumn 的方式挂载相关数据库目录 配置文件</span></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root123 \  <span class="comment">## -e 环境变量.初始化时设置数据库的root 密码</span></span><br><span class="line">-d mysql/mysql-server:8.0   <span class="comment">## 指定镜像</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看日志。可以看到初始化的日志</span></span><br><span class="line">docker logs mysql8-1 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器进程</span></span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS                    PORTS                                                        NAMES</span><br><span class="line">ac42ef0a7b2c   mysql/mysql-server:8.0   <span class="string">&quot;/entrypoint.sh mysq…&quot;</span>   33 minutes ago   Up 16 minutes (healthy)   0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060-33061/tcp   mysql8-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#登录mysql</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql8-1 mysql -uroot -proot123</span><br><span class="line"></span><br><span class="line">root 用户只适用于本地登录</span><br><span class="line"></span><br><span class="line">可以进入数据库建立一个远程登录用户</span><br><span class="line"></span><br><span class="line"><span class="comment">#看回刚才挂载的目录，里面已经产生各种数据文件</span></span><br><span class="line"><span class="built_in">cd</span> /data/mysql8_data/data </span><br><span class="line"></span><br><span class="line"><span class="comment">#使用dbeaver 远程登录</span></span><br><span class="line">报错:Public Key Retrieval is not allowed</span><br><span class="line">需修改连接配置 --》 驱动属性 --》 allowPublicKeyRetrieval 更改为<span class="literal">true</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次登录成功</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/02/28/hadoop3EC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/hadoop3EC/" class="post-title-link" itemprop="url">hadoop3.x 纠删码策略</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-28 18:26:32" itemprop="dateCreated datePublished" datetime="2023-02-28T18:26:32+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-01 10:12:33" itemprop="dateModified" datetime="2023-03-01T10:12:33+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index"><span itemprop="name">hadoop</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>纠删码技术（Erasure coding）简称EC，是一种编码容错技术。最早用于通信行业，数据传输中的数据恢复。它通过对数据进行分块，然后计算出校验数据，使得各个部分的数据产生关联性。当一部分数据块丢失时，可以通过剩余的数据块和校验块计算出丢失的数据块。相比以前的冗余副本策略，它可以提高50%以上的存储利用率，并且保证数据的可靠性。</p>
<h3 id="纠删码内置策略"><a href="#纠删码内置策略" class="headerlink" title="纠删码内置策略"></a>纠删码内置策略</h3><p>1.RS-10-4-1024k：使用RS编码，每10个数据单元（cell），生成4个校验单元，共14个单元，也就是说：这14个单元中，只要有任意的10个单元存在（不管是数据单元还是校验单元，只要总数=10），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。</p>
<p>2.RS-3-2-1024k：使用RS编码，每3个数据单元，生成2个校验单元，共5个单元，也就是说：这5个单元中，只要有任意的3个单元存在（不管是数据单元还是校验单元，只要总数=3），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。</p>
<p>3.RS-6-3-1024k：使用RS编码，每6个数据单元，生成3个校验单元，共9个单元，也就是说：这9个单元中，只要有任意的6个单元存在（不管是数据单元还是校验单元，只要总数=6），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。</p>
<p>4.RS-LEGACY-6-3-1024k：策略和上面的RS-6-3-1024k一样，只是编码的算法用的是rs-legacy，应该是之前遗留的rs算法。</p>
<p>5.XOR-2-1-1024k：使用XOR编码（速度比RS编码快），每2个数据单元，生成1个校验单元，共3个单元，也就是说：这3个单元中，只要有任意的2个单元存在（不管是数据单元还是校验单元，只要总数=2），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。</p>
<p>以RS-6-3-1024k为例，6个数据单元+3个校验单元，可以容忍任意的3个单元丢失，冗余的数据是50%。而采用副本方式，3个副本，冗余200%，却还不能容忍任意的3个单元丢失。因此，RS编码在相同冗余度的情况下，会大大提升数据的可用性，而在相同可用性的情况下，会大大节省冗余空间。</p>
<h3 id="如何在hadoop-3-x-启动-EC-策略"><a href="#如何在hadoop-3-x-启动-EC-策略" class="headerlink" title="如何在hadoop 3.x 启动 EC 策略"></a>如何在hadoop 3.x 启动 EC 策略</h3><p>1.hadoop 3.x 默认 EC 策略为 RS-6-3-1024k，根据上面内置策略的描述，至少要满足相应的节点数才行<br>2.RS 策略 依赖于 Intel ISA-L 包。开启前需要安装Intel ISA-L 包<br>3.安装 Intel ISA-L 包，相关依赖 nasm 2.13<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nasm 下载地址：https://www.nasm.us/pub/nasm/releasebuilds/2.13/linux/</span><br><span class="line">rpm -ivh nasm-2.13-0.fc24.x86_64.rpm</span><br><span class="line"></span><br><span class="line">isa-l 下载地址：https://github.com/intel/isa-l</span><br><span class="line">编译安装</span><br><span class="line">tar -xzvf  isa-l-2.30.0.tar.gz</span><br><span class="line">cd  isa-l-2.30.0</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --prefix=/usr --libdir=/usr/lib64</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><br>4.设置EC策略<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -mkdir /ectest</span><br><span class="line">hdfs ec -setPolicy -path hdfs:///ectest (将设置默认策略)</span><br><span class="line">hdfs ec -setPolicy -policy RS-3-2-1024k -path hdfs:///ectest (指定策略)</span><br></pre></td></tr></table></figure></p>
<p>5.更改默认策略<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 纠删码策略 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.ec.system.default.policy<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>RS-3-2-1024k<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The default erasure coding policy name will be used</span><br><span class="line">    on the path if no policy name is passed.</span><br><span class="line">    5 register EC policy: RS-3-2-1024k、RS-6-3-1024k、RS-10-4-1024k、RS-LEGACY-6-3-1024k、XOR-2-1-1024k</span><br><span class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="不适用的场景"><a href="#不适用的场景" class="headerlink" title="不适用的场景"></a>不适用的场景</h3><p>1.在EC 策略上的磁盘 做 append() 和 truncate() 操作将抛 IOException<br>2.如果文件存储编码混合了多种EC策略 或者 使用了多副本.concat() 操作将抛 IOException<br>3.setReplication() 操作在EC 策略编码的文件上无效<br>4.hflush() 和 hsync() 在 DFSStripedOutputStream 上无效，所以不能在 EC编码的文件 通过调用hflush()，hsync() 使数据一致性。</p>
<p>适用于划分独立路径，存储不需要修改的数据或者冷备份数据</p>
<h3 id="设置EC-策略的相关命令"><a href="#设置EC-策略的相关命令" class="headerlink" title="设置EC 策略的相关命令"></a>设置EC 策略的相关命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hdfs ec [generic options]</span><br><span class="line">     [-setPolicy -path &lt;path&gt; [-policy &lt;policyName&gt;] [-replicate]]  #为指定的路径设置指定的ec 策略</span><br><span class="line">     [-getPolicy -path &lt;path&gt;]  #获取指定路径的ec 策略</span><br><span class="line">     [-unsetPolicy -path &lt;path&gt;] #取消指定路径的上一次 setPolicy ec 策略</span><br><span class="line">     [-listPolicies]   #获取hdfs 上登记的所有策略（包括 启用。禁用。删除的策略)</span><br><span class="line">     [-addPolicies -policyFile &lt;file&gt;] # 通过文件的方式，添加用户指定的EC策略集</span><br><span class="line">     [-listCodecs]   #列出系统支持的EC编码策略列表</span><br><span class="line">     [-enablePolicy -policy &lt;policyName&gt;]   #启用某个策略</span><br><span class="line">     [-disablePolicy -policy &lt;policyName&gt;]  #禁用某个策略</span><br><span class="line">     [-removePolicy -policy &lt;policyName&gt;]   #删除某个策略</span><br><span class="line">     [-verifyClusterSetup -policy &lt;policyName&gt;...&lt;policyName&gt;]  #校验集群设置是否满足所有已经启用的EC 策略</span><br><span class="line">     [-help [cmd ...]]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/01/29/buildClickHouseCluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/29/buildClickHouseCluster/" class="post-title-link" itemprop="url">搭建clichouse 集群</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-29 14:46:22" itemprop="dateCreated datePublished" datetime="2023-01-29T14:46:22+08:00">2023-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-15 12:33:42" itemprop="dateModified" datetime="2023-08-15T12:33:42+08:00">2023-08-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/clickhouse/" itemprop="url" rel="index"><span itemprop="name">clickhouse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="一-规划："><a href="#一-规划：" class="headerlink" title="一 规划："></a>一 规划：</h4><p>本次搭建采用3个服务器搭建一个 3分片2副本的clickhouse 集群。命名规则中。以S 代表分片。R代表复制集。集群架构如下图<br><img src="images/clickhouse.png" alt="cka"></p>
<p>172.28.160.2 上面存放2个实例分别为 S1R1(分片1复制集1)实例， S2R2(分片2复制集2)实例<br>172.28.160.3 上面存放2个实例分别为 S2R1(分片2复制集1)实例， S3R2(分片3复制集2)实例<br>172.28.160.4 上面存放2个实例分别为 S3R1(分片3复制集1)实例， S3R2(分片1复制集2)实例</p>
<p>以确保在宕机任何一个节点。都不会影响集群的正常使用<br>同时在三个节点上启动clickhouse-keeper ，用于分布式集群通讯。（旧版本中用zookeeper）</p>
<p>主机实例分布<br><img src="images/c1t1.png" alt="c1t1"><br><img src="images/c2t2.png" alt="c2t2"><br><img src="images/c3t3.png" alt="c3t3"></p>
<h4 id="二-安装"><a href="#二-安装" class="headerlink" title="二 安装"></a>二 安装</h4><h5 id="1-下载-clickhouse-稳定版本地址-：https-packages-clickhouse-com-rpm-stable"><a href="#1-下载-clickhouse-稳定版本地址-：https-packages-clickhouse-com-rpm-stable" class="headerlink" title="1. 下载 clickhouse 稳定版本地址 ：https://packages.clickhouse.com/rpm/stable/"></a>1. 下载 clickhouse 稳定版本地址 ：<a target="_blank" rel="noopener" href="https://packages.clickhouse.com/rpm/stable/">https://packages.clickhouse.com/rpm/stable/</a></h5><p>本次安装采用RPM 安装，使用版本 22.12.3.5<br>需下载的rpm 包有<br>clickhouse-common-static-22.12.3.5.x86_64.rpm<br>clickhouse-server-22.12.3.5.x86_64.rpm<br>clickhouse-client-22.12.3.5.x86_64.rpm</p>
<h5 id="2-安装前检测以及优化系统项配置"><a href="#2-安装前检测以及优化系统项配置" class="headerlink" title="2. 安装前检测以及优化系统项配置"></a>2. 安装前检测以及优化系统项配置</h5><p>检查当前CPU是否支持SSE 4.2的命令<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -q sse4_2 /proc/cpuinfo &amp;&amp; echo &quot;SSE 4.2 supported&quot; || echo &quot;SSE 4.2 not supported&quot;</span><br></pre></td></tr></table></figure><br>设置内存分配策略为：0<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 |tee /proc/sys/vm/overcommit_memory</span><br></pre></td></tr></table></figure><br>禁用透明大页<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;never&quot; |tee /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"># 永久禁用</span><br><span class="line">echo &#x27;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#x27; &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure><br>/etc/hosts 添加集群主机名IP地址映射<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.28.160.2 ct-bigdata-clickhouse-160-2</span><br><span class="line">172.28.160.3 ct-bigdata-clickhouse-160-3</span><br><span class="line">172.28.160.4 ct-bigdata-clickhouse-160-4</span><br></pre></td></tr></table></figure></p>
<h5 id="3-按顺序安装RPM-包"><a href="#3-按顺序安装RPM-包" class="headerlink" title="3. 按顺序安装RPM 包"></a>3. 按顺序安装RPM 包</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@ct-bigdata-clickhouse-160-2 clickhouseSoft]# rpm -ivh clickhouse-common-static-22.12.3.5.x86_64.rpm</span><br><span class="line">Preparing... ################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">      1:clickhouse-common-static-0:22.12.################################# [100%]</span><br><span class="line"></span><br><span class="line">安装clickhouse-server 中间提升需要设置default 密码。输入设置即可。会在 /etc/clickhouse-server/users.d/default-password.xml 保存这个密码     </span><br><span class="line"></span><br><span class="line">[root@ct-bigdata-clickhouse-160-2 clickhouseSoft]# rpm -ivh clickhouse-server-22.12.3.5.x86_64.rpm</span><br><span class="line">Preparing... ################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">1:clickhouse-server-0:22.12.3.5-1 ################################# [100%]</span><br><span class="line">ClickHouse binary is already located at /usr/bin/clickhouse</span><br><span class="line">Symlink /usr/bin/clickhouse-server already exists but it points to /clickhouse. Will replace the old symlink to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-server to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-client to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-local to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-benchmark to /usr/bin/clickhouse.</span><br><span class="line">Symlink /usr/bin/clickhouse-copier already exists but it points to /clickhouse. Will replace the old symlink to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-copier to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-obfuscator to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-git-import to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-compressor to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-format to /usr/bin/clickhouse.</span><br><span class="line">Symlink /usr/bin/clickhouse-extract-from-config already exists but it points to /clickhouse. Will replace the old symlink to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-extract-from-config to /usr/bin/clickhouse.</span><br><span class="line">Symlink /usr/bin/clickhouse-keeper already exists but it points to /clickhouse. Will replace the old symlink to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-keeper to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-keeper-converter to /usr/bin/clickhouse.</span><br><span class="line">Creating symlink /usr/bin/clickhouse-disks to /usr/bin/clickhouse.</span><br><span class="line">Creating clickhouse group if it does not exist.</span><br><span class="line">groupadd -r clickhouse</span><br><span class="line">Creating clickhouse user if it does not exist.</span><br><span class="line">useradd -r --shell /bin/false --home-dir /nonexistent -g clickhouse clickhouse</span><br><span class="line">Will set ulimits for clickhouse user in /etc/security/limits.d/clickhouse.conf.</span><br><span class="line">Creating config directory /etc/clickhouse-server/config.d that is used for tweaks of main server configuration.</span><br><span class="line">Creating config directory /etc/clickhouse-server/users.d that is used for tweaks of users configuration.</span><br><span class="line">Config file /etc/clickhouse-server/config.xml already exists, will keep it and extract path info from it.</span><br><span class="line">/etc/clickhouse-server/config.xml has /var/lib/clickhouse/ as data path.</span><br><span class="line">/etc/clickhouse-server/config.xml has /var/log/clickhouse-server/ as log path.</span><br><span class="line">Users config file /etc/clickhouse-server/users.xml already exists, will keep it and extract users info from it.</span><br><span class="line">Creating log directory /var/log/clickhouse-server/.</span><br><span class="line">Creating data directory /var/lib/clickhouse/.</span><br><span class="line">Creating pid directory /var/run/clickhouse-server.</span><br><span class="line">chown -R clickhouse:clickhouse &#x27;/var/log/clickhouse-server/&#x27;</span><br><span class="line">chown -R clickhouse:clickhouse &#x27;/var/run/clickhouse-server&#x27;</span><br><span class="line">chown clickhouse:clickhouse &#x27;/var/lib/clickhouse/&#x27;</span><br><span class="line">groupadd -r clickhouse-bridge</span><br><span class="line">useradd -r --shell /bin/false --home-dir /nonexistent -g clickhouse-bridge clickhouse-bridge</span><br><span class="line">chown -R clickhouse-bridge:clickhouse-bridge &#x27;/usr/bin/clickhouse-odbc-bridge&#x27;</span><br><span class="line">chown -R clickhouse-bridge:clickhouse-bridge &#x27;/usr/bin/clickhouse-library-bridge&#x27;</span><br><span class="line">Enter password for default user:</span><br><span class="line">Password for default user is saved in file /etc/clickhouse-server/users.d/default-password.xml.</span><br><span class="line">Setting capabilities for clickhouse binary. This is optional.</span><br><span class="line">Cannot set &#x27;net_admin&#x27; or &#x27;ipc_lock&#x27; or &#x27;sys_nice&#x27; or &#x27;net_bind_service&#x27; capability for clickhouse binary. This is optional. Taskstats accounting will be disabled. To enable taskstats accounting you may add the required capability later manually.</span><br><span class="line">chown -R clickhouse:clickhouse &#x27;/etc/clickhouse-server&#x27;</span><br><span class="line"></span><br><span class="line">ClickHouse has been successfully installed.</span><br><span class="line"></span><br><span class="line">Start clickhouse-server with:</span><br><span class="line">sudo clickhouse start</span><br><span class="line"></span><br><span class="line">Start clickhouse-client with:</span><br><span class="line">clickhouse-client --password</span><br><span class="line"></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/clickhouse-server.service to /usr/lib/systemd/system/clickhouse-server.service.</span><br><span class="line"></span><br><span class="line">[root@ct-bigdata-clickhouse-160-2 clickhouseSoft]# rpm -ivh clickhouse-client-22.12.3.5.x86_64.rpm</span><br><span class="line">Preparing... ################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">1:clickhouse-client-0:22.12.3.5-1 ################################# [100%]</span><br></pre></td></tr></table></figure>
<p>安装完这3个rpm 包同时也包含clickhouse-keeper 不需要额外安装,以上步骤均在各个节点上执行</p>
<h5 id="4-设置目录"><a href="#4-设置目录" class="headerlink" title="4. 设置目录"></a>4. 设置目录</h5><p>在 172.28.160.2 节点上<br>设置实例存储目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data1/clickhouse/s1r1</span><br><span class="line">mkdir -p /data2/clickhouse/s2r2</span><br><span class="line">chown -R clickhouse:clickhouse /data1/clickhouse</span><br><span class="line">chown -R clickhouse:clickhouse /data2/clickhouse</span><br><span class="line">cd /var/lib/clickhouse/</span><br><span class="line">ln -s /data1/clickhouse/s1r1 s1r1</span><br><span class="line">ln -s /data2/clickhouse/s2r2 s2r2</span><br></pre></td></tr></table></figure><br>设置各个实例日志目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/log/clickhouse-server/&#123;s1r1,s2r2&#125;</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-server</span><br></pre></td></tr></table></figure><br>设置clickhouse-keeper 存储目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/clickhouse/keeper/coordination</span><br><span class="line">mkdir -p /var/log/clickhouse-keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/lib/clickhouse/keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-keeper</span><br></pre></td></tr></table></figure><br>在172.28.160.3 节点上<br>设置实例存储目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data1/clickhouse/s2r1</span><br><span class="line">mkdir -p /data2/clickhouse/s3r2</span><br><span class="line">chown -R clickhouse:clickhouse /data1/clickhouse</span><br><span class="line">chown -R clickhouse:clickhouse /data2/clickhouse</span><br><span class="line">ln -s /data1/clickhouse/s2r1 s2r1</span><br><span class="line">ln -s /data2/clickhouse/s3r2 s3r2</span><br></pre></td></tr></table></figure><br>设置各个实例日志目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/log/clickhouse-server/&#123;s2r1,s3r2&#125;</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-server</span><br></pre></td></tr></table></figure><br>设置clickhouse-keeper 存储目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/clickhouse/keeper/coordination</span><br><span class="line">mkdir -p /var/log/clickhouse-keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/lib/clickhouse/keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-keeper</span><br></pre></td></tr></table></figure><br>在172.28.160.4 节点上<br>设置实例存储目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data1/clickhouse/s3r1</span><br><span class="line">mkdir -p /data2/clickhouse/s1r2</span><br><span class="line">chown -R clickhouse:clickhouse /data1/clickhouse</span><br><span class="line">chown -R clickhouse:clickhouse /data2/clickhouse</span><br><span class="line">ln -s /data1/clickhouse/s3r1 s3r1</span><br><span class="line">ln -s /data2/clickhouse/s1r2 s1r2</span><br></pre></td></tr></table></figure><br>设置各个实例日志目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/log/clickhouse-server/&#123;s3r1,s1r2&#125;</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-server</span><br></pre></td></tr></table></figure><br>设置clickhouse-keeper 存储目录<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/clickhouse/keeper/coordination</span><br><span class="line">mkdir -p /var/log/clickhouse-keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/lib/clickhouse/keeper</span><br><span class="line">chown -R clickhouse:clickhouse /var/log/clickhouse-keeper</span><br></pre></td></tr></table></figure></p>
<h5 id="5-设置配置文件"><a href="#5-设置配置文件" class="headerlink" title="5. 设置配置文件"></a>5. 设置配置文件</h5><p>在172.28.160.2 上<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/clickhouse-server/</span><br><span class="line">cp config.xml config_s1r1.xml </span><br></pre></td></tr></table></figure><br>在config_s1r1.xml  中 将以下参数替换成如下参数,将路径指向我们定义好的路径</p>
<p>日志部分 设置waring 级别，并将错误日志，日志指向 s1r1<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">level</span>&gt;</span>warning<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">log</span>&gt;</span>/var/log/clickhouse-server/s1r1/clickhouse-server.log<span class="tag">&lt;/<span class="name">log</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">errorlog</span>&gt;</span>/var/log/clickhouse-server/s1r1/clickhouse-server.err.log<span class="tag">&lt;/<span class="name">errorlog</span>&gt;</span></span><br></pre></td></tr></table></figure><br>设置数据文件存放路径<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/s1r1<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tmp_path</span>&gt;</span>/var/lib/clickhouse/s1r1/tmp/<span class="tag">&lt;/<span class="name">tmp_path</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user_files_path</span>&gt;</span>/var/lib/clickhouse/s1r1/user_files/<span class="tag">&lt;/<span class="name">user_files_path</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user_directories</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">local_directory</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">path</span>&gt;</span>/var/lib/clickhouse/s1r1/access/<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">local_directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user_directories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 宏定义，表示分片1 副本 1 用于分布式表--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>01<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>01-1<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure><br>设置集群信息，在remote_servers 表签下，将原有的信息删除，仅保留 <remote_servers></remote_servers>,并添加信息如下</p>
<p>设置一个3分片2副本集群 <three_shards_tow_replicated> 表示集群名称  <shard> </shard> 表示分片，<shard> 中的 <replica> 表示 分片中的的副本信息<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">remote_servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">three_shards_tow_replicated</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                      <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                      <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                      <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                      <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                  <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                  <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                  <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                  <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                 <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                              <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                              <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                              <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                              <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">three_shards_tow_replicated</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">remote_servers</span>&gt;</span></span><br></pre></td></tr></table></figure><br>打开zookeeper 配置信息<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">zookeeper</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zookeeper</span>&gt;</span></span><br></pre></td></tr></table></figure><br>设置好config 配置文件后，将其拷贝一份</p>
<p>cp config_s1r1.xml config_s2r2.xml</p>
<p>修改config_s2r2.xml如下</p>
<p>将其中涉及路径 s1r1 全部替换为 s2r2</p>
<p>端口部分修改为如下对应<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">http_port</span>&gt;</span>8124<span class="tag">&lt;/<span class="name">http_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">tcp_port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">tcp_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">mysql_port</span>&gt;</span>9014<span class="tag">&lt;/<span class="name">mysql_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">postgresql_port</span>&gt;</span>9015<span class="tag">&lt;/<span class="name">postgresql_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">interserver_http_port</span>&gt;</span>9019<span class="tag">&lt;/<span class="name">interserver_http_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 宏定义部分 --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>02<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>02-2<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>为其他节点准备配置文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cp config_s1r1.xml config_s2r1.xml</span><br><span class="line"></span><br><span class="line">cp config_s1r1.xml config_s3r1.xml</span><br><span class="line"></span><br><span class="line">cp config_s2r2.xml config_s3r2.xml</span><br><span class="line"></span><br><span class="line">cp config_s2r2.xml config_s1r2.xml</span><br></pre></td></tr></table></figure><br>修改 config_s2r1.xml</p>
<p>将路径中的s1r1 全部替换成 s2r1</p>
<p>宏定义部分<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>02<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>02-1<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure><br>修改 config_s3r1.xml</p>
<p>将路径中的s1r1 全部替换成 s3r1</p>
<p>宏定义部分<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>03<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>03-1<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure><br>修改 config_s3r2.xml</p>
<p>将路径中的s2r2 全部替换成 s3r2</p>
<p>宏定义部分<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>03<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>03-2<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>将路径中的s2r2 全部替换成 s1r2</p>
<p>宏定义部分<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">shard</span>&gt;</span>01<span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">replica</span>&gt;</span>01-2<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>将文件分发到各个节点上</p>
<p>172.28.160.2 保留  config_s1r1.xml config_s2r2.xml 文件</p>
<p>172.28.160.3 保留  config_s2r1.xml config_s3r2.xml 文件</p>
<p>172.28.160.4 保留  config_s3r1.xml config_s1r2.xml 文件<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp  config_s2r1.xml config_s3r2.xml  172.28.160.3:/etc/clickhouse-server/</span><br><span class="line"></span><br><span class="line">scp  config_s3r1.xml config_s1r2.xml  172.28.160.4:/etc/clickhouse-server/</span><br></pre></td></tr></table></figure><br>在172.28.160.2 上删除多余的文件</p>
<p>rm -f  config_s2r1.xml config_s3r2.xml  config_s3r1.xml config_s1r2.xml</p>
<p>新增clickhouse-keeper 配置文件</p>
<p>vi keeper.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">clickhouse</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">logger</span>&gt;</span></span><br><span class="line">                 <span class="comment">&lt;!-- Possible levels [1]:</span></span><br><span class="line"><span class="comment">                    - none (turns off logging)</span></span><br><span class="line"><span class="comment">                    - fatal</span></span><br><span class="line"><span class="comment">                    - critical</span></span><br><span class="line"><span class="comment">                    - error</span></span><br><span class="line"><span class="comment">                    - warning</span></span><br><span class="line"><span class="comment">                    - notice</span></span><br><span class="line"><span class="comment">                    - information</span></span><br><span class="line"><span class="comment">                    - debug</span></span><br><span class="line"><span class="comment">                    - trace</span></span><br><span class="line"><span class="comment">                       [1]: https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/Logger.h#L105-L114</span></span><br><span class="line"><span class="comment">                    --&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">level</span>&gt;</span>warning<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">log</span>&gt;</span>/var/log/clickhouse-keeper/clickhouse-keeper.log<span class="tag">&lt;/<span class="name">log</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">errorlog</span>&gt;</span>/var/log/clickhouse-keeper/clickhouse-keeper.err.log<span class="tag">&lt;/<span class="name">errorlog</span>&gt;</span></span><br><span class="line">                  <span class="comment">&lt;!-- Rotation policy</span></span><br><span class="line"><span class="comment">                         See https://github.com/pocoproject/poco/blob/poco-1.9.4-release/Foundation/include/Poco/FileChannel.h#L54-L85</span></span><br><span class="line"><span class="comment">                   --&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">size</span>&gt;</span>1000M<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">count</span>&gt;</span>10<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">                  <span class="comment">&lt;!-- &lt;console&gt;1&lt;/console&gt; --&gt;</span> <span class="comment">&lt;!-- Default behavior is autodetection (log to console if not daemon mode and is tty) --&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="tag">&lt;<span class="name">max_connections</span>&gt;</span>4096<span class="tag">&lt;/<span class="name">max_connections</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 监听IP ,不设置的话只挂本地127.0.0.1 ::1: 上--&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">listen_host</span>&gt;</span>0.0.0.0<span class="tag">&lt;/<span class="name">listen_host</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">keeper_server</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">tcp_port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">tcp_port</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="comment">&lt;!-- Must be unique among all keeper serves --&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">server_id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">server_id</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">log_storage_path</span>&gt;</span>/var/lib/clickhouse/keeper/coordination/logs<span class="tag">&lt;/<span class="name">log_storage_path</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">snapshot_storage_path</span>&gt;</span>/var/lib/clickhouse/keeper/coordination/snapshots<span class="tag">&lt;/<span class="name">snapshot_storage_path</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                   <span class="tag">&lt;<span class="name">coordination_settings</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">operation_timeout_ms</span>&gt;</span>10000<span class="tag">&lt;/<span class="name">operation_timeout_ms</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">min_session_timeout_ms</span>&gt;</span>30000<span class="tag">&lt;/<span class="name">min_session_timeout_ms</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">session_timeout_ms</span>&gt;</span>30000<span class="tag">&lt;/<span class="name">session_timeout_ms</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">raft_logs_level</span>&gt;</span>warning<span class="tag">&lt;/<span class="name">raft_logs_level</span>&gt;</span></span><br><span class="line">                             <span class="comment">&lt;!-- All settings listed in https://github.com/ClickHouse/ClickHouse/blob/master/src/Coordination/CoordinationSettings.h --&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">coordination_settings</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                  <span class="comment">&lt;!-- enable sanity hostname checks for cluster configuration (e.g. if localhost is used with remote endpoints) --&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">hostname_checks_enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">hostname_checks_enabled</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">raft_configuration</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">hostname</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">hostname</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>9444<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">id</span>&gt;</span>2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">hostname</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">hostname</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>9444<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">id</span>&gt;</span>3<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">hostname</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">hostname</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">port</span>&gt;</span>9444<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                         <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                         <span class="comment">&lt;!-- Add more servers here --&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">raft_configuration</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">keeper_server</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">clickhouse</span>&gt;</span></span><br></pre></td></tr></table></figure><br>将keeper.xml 拷贝到其他2个节点上<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp  keeper.xml  172.28.160.3:/etc/clickhouse-server/</span><br><span class="line">scp  keeper.xml  172.28.160.4:/etc/clickhouse-server/</span><br></pre></td></tr></table></figure><br>在172.28.160.3 修改 keeper.xml  替换server_id  为 <server_id>2</server_id></p>
<p>在172.28.160.4 修改 keeper.xml  替换server_id  为 <server_id>3</server_id></p>
<p>配置user.xml 文件,添加集群用户repl。3节点上都添加</p>
<p>vi user.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- replicat user --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">repl</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">password_sha256_hex</span>&gt;</span>SHA256PASSWORD<span class="tag">&lt;/<span class="name">password_sha256_hex</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">networks</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;/<span class="name">networks</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">profile</span>&gt;</span>default<span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">                 <span class="tag">&lt;<span class="name">quota</span>&gt;</span>default<span class="tag">&lt;/<span class="name">quota</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">repl</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></table></figure><br>重新全部授权 clickhouse </p>
<p>chown -R clickhouse:clickhouse /etc/clickhouse-server</p>
<h5 id="6-设置systemctl-启动脚本，并启动集群"><a href="#6-设置systemctl-启动脚本，并启动集群" class="headerlink" title="6. 设置systemctl 启动脚本，并启动集群"></a>6. 设置systemctl 启动脚本，并启动集群</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vi  clickhouse-keeper.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=ClickHouse Keeper (analytic DBMS <span class="keyword">for</span> big data)</span><br><span class="line">Requires=network-online.target</span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> that After/Wants=time-sync.target is not enough, you need to ensure</span></span><br><span class="line"><span class="comment"># that the time was adjusted already, if you use systemd-timesyncd you are</span></span><br><span class="line"><span class="comment"># safe, but if you use ntp or some other daemon, you should configure it</span></span><br><span class="line"><span class="comment"># additionaly.</span></span><br><span class="line">After=time-sync.target network-online.target</span><br><span class="line">Wants=time-sync.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=clickhouse</span><br><span class="line">Group=clickhouse</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=30</span><br><span class="line">ExecStart=/usr/bin/clickhouse-keeper --config=/etc/clickhouse-server/keeper.xml --pid-file=/var/lib/clickhouse/keeper/clickhouse-keeper.pid</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">CapabilityBoundingSet=CAP_NET_ADMIN CAP_IPC_LOCK CAP_SYS_NICE CAP_NET_BIND_SERVICE</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="comment"># ClickHouse should not start from the rescue shell (rescue.target).</span></span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>将启动脚本拷贝到/lib/systemd/system/<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp clickhouse-keeper.service /lib/systemd/system/clickhouse-keeper.service</span><br></pre></td></tr></table></figure><br>重载并启动<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start clickhouse-keeper.service</span><br></pre></td></tr></table></figure><br>启动成功验证<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status clickhouse-keeper.service</span><br></pre></td></tr></table></figure><br>将这个脚本拷贝到其他2个服务器上。执行同样的操作。</p>
<p>这样keeper 集群就启动了，可以通过跟zookeeper 一样的四字母命令来查看zookeeper 的状态<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@ct-bigdata-clickhouse-160-2 clickhouse-server]# echo mntr | nc localhost 2181</span><br><span class="line">zk_version v22.12.3.5-stable-893de538f0298310edb9ea1d7c83968cbbc5310f</span><br><span class="line">zk_avg_latency 0</span><br><span class="line">zk_max_latency 0</span><br><span class="line">zk_min_latency 0</span><br><span class="line">zk_packets_received 0</span><br><span class="line">zk_packets_sent 0</span><br><span class="line">zk_num_alive_connections 0</span><br><span class="line">zk_outstanding_requests 0</span><br><span class="line">zk_server_state leader</span><br><span class="line">zk_znode_count 3</span><br><span class="line">zk_watch_count 0</span><br><span class="line">zk_ephemerals_count 0</span><br><span class="line">zk_approximate_data_size 644</span><br><span class="line">zk_key_arena_size 4096</span><br><span class="line">zk_latest_snapshot_size 0</span><br><span class="line">zk_open_file_descriptor_count 41</span><br><span class="line">zk_max_file_descriptor_count 12640848</span><br><span class="line">zk_followers 2</span><br><span class="line">zk_synced_followers 2</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>需要注意的是keeper 启动raft 协议需要用到ipv6<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 如遇到如下错误。检查是否禁用了ipv6 ,查看并修改 /etc/default/grub </span></span><br><span class="line">&lt;Error&gt; RaftInstance: got exception: open: Address family not supported by protocol [system:97] on port 9444</span><br><span class="line"></span><br><span class="line"><span class="comment"># vi /etc/default/grub</span></span><br><span class="line">删除  ipv6.disable=1 这个选项</span><br><span class="line">重新生成grub 配置文件</span><br><span class="line"><span class="comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></span><br><span class="line">重启操作系统</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure></p>
<p>接下来配置clickhouse-server 的启动脚本<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /lib/systemd/system/clickhouse-server.service   /lib/systemd/system/clickhouse-server_s1r1.service</span><br></pre></td></tr></table></figure><br>修改启动配置文件的路径以及pid 文件的存放路径<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vi /lib/systemd/system/clickhouse-server_s1r1.service  </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=ClickHouse Server (analytic DBMS for big data)</span><br><span class="line">Requires=network-online.target</span><br><span class="line"># NOTE: that After/Wants=time-sync.target is not enough, you need to ensure</span><br><span class="line"># that the time was adjusted already, if you use systemd-timesyncd you are</span><br><span class="line"># safe, but if you use ntp or some other daemon, you should configure it</span><br><span class="line"># additionaly.</span><br><span class="line">After=time-sync.target network-online.target</span><br><span class="line">Wants=time-sync.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line"># Switching off watchdog is very important for sd_notify to work correctly.</span><br><span class="line">Environment=CLICKHOUSE_WATCHDOG_ENABLE=0</span><br><span class="line">User=clickhouse</span><br><span class="line">Group=clickhouse</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=30</span><br><span class="line">RuntimeDirectory=clickhouse-server</span><br><span class="line">ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s1r1.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s1r1.pid</span><br><span class="line"># Minus means that this file is optional.</span><br><span class="line">EnvironmentFile=-/etc/default/clickhouse</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">CapabilityBoundingSet=CAP_NET_ADMIN CAP_IPC_LOCK CAP_SYS_NICE CAP_NET_BIND_SERVICE</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"># ClickHouse should not start from the rescue shell (rescue.target).</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><br>对应的其他实例在ExecStart=的位置将配置文件指定到对应的配置文件以及路径上。</p>
<p>在172.28.160.2 上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lickhouse-server_s1r1.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s1r1.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s1r1.pid</span><br><span class="line"></span><br><span class="line">clickhouse-server_s2r2.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s2r2.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s2r2.pid</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s1r1.service</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s2r2.service</span><br></pre></td></tr></table></figure>
<p>在172.28.160.3 上<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lickhouse-server_s2r1.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s2r1.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s2r1.pid</span><br><span class="line"></span><br><span class="line">clickhouse-server_s3r2.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s3r2.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s3r2.pid</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s2r1.service</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s3r2.service</span><br></pre></td></tr></table></figure><br>在172.28.160.4 上<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lickhouse-server_s3r1.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s3r1.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s3r1.pid</span><br><span class="line"></span><br><span class="line">clickhouse-server_s1r2.service  ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config_s1r2.xml --pid-file=/var/lib/clickhouse/s1r1/clickhouse-server_s1r2.pid</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s3r1.service</span><br><span class="line"></span><br><span class="line">systemctl start clickhouse-server_s1r2.service</span><br></pre></td></tr></table></figure></p>
<h5 id="7-集群验证"><a href="#7-集群验证" class="headerlink" title="7. 集群验证"></a>7. 集群验证</h5><p>节点启动成功后,可以登录本地节点查看<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@ct-bigdata-clickhouse-160-2 ~]# clickhouse-client --user=default --password=123456</span><br><span class="line">ClickHouse client version 22.12.3.5 (official build).</span><br><span class="line">Connecting to localhost:9000 as user default.</span><br><span class="line">Connected to ClickHouse server version 22.12.3 revision 54461.</span><br><span class="line"></span><br><span class="line">ct-bigdata-clickhouse-160-2 :) </span><br><span class="line"></span><br><span class="line">ct-bigdata-clickhouse-160-2 :) select * from system.clusters;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM system.clusters</span><br><span class="line"></span><br><span class="line">Query id: 85ad631d-dacf-49d0-a410-3b3420d2e619</span><br><span class="line"></span><br><span class="line">┌─cluster─────────────────────┬─shard_num─┬─shard_weight─┬─replica_num─┬─host_name────┬─host_address─┬─port─┬─is_local─┬─user─┬─default_database─┬─errors_count─┬─slowdowns_count─┬─estimated_recovery_time─┐</span><br><span class="line">│ three_shards_tow_replicated │ 1 │ 1 │ 1 │ 172.28.160.2 │ 172.28.160.2 │ 9000 │ 1 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 1 │ 1 │ 2 │ 172.28.160.4 │ 172.28.160.4 │ 9001 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 2 │ 1 │ 1 │ 172.28.160.3 │ 172.28.160.3 │ 9000 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 2 │ 1 │ 2 │ 172.28.160.2 │ 172.28.160.2 │ 9001 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 3 │ 1 │ 1 │ 172.28.160.4 │ 172.28.160.4 │ 9000 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">│ three_shards_tow_replicated │ 3 │ 1 │ 2 │ 172.28.160.3 │ 172.28.160.3 │ 9001 │ 0 │ repl │ │ 0 │ 0 │ 0 │</span><br><span class="line">└─────────────────────────────┴───────────┴──────────────┴─────────────┴──────────────┴──────────────┴──────┴──────────┴──────┴──────────────────┴──────────────┴─────────────────┴─────────────────────────┘</span><br><span class="line"></span><br><span class="line">6 rows in set. Elapsed: 0.001 sec.</span><br></pre></td></tr></table></figure><br>通过查询clusters 系统表。可以看到集群信息</p>
<p>建一个集群表验证一下<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ct-bigdata-clickhouse-160-2 :) create table test_cluster_table on cluster three_shards_tow_replicated (id int,name String,price int ) ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/&#123;shard&#125;/default/test_cluster_table&#x27;,&#x27;&#123;replica&#125;&#x27;) ORDER BY id;</span><br><span class="line"></span><br><span class="line">CREATE TABLE test_cluster_table ON CLUSTER three_shards_tow_replicated</span><br><span class="line">(</span><br><span class="line">`id` int,</span><br><span class="line">`name` String,</span><br><span class="line">`price` int</span><br><span class="line">)</span><br><span class="line">ENGINE = ReplicatedMergeTree(&#x27;/clickhouse/tables/&#123;shard&#125;/default/test_cluster_table&#x27;, &#x27;&#123;replica&#125;&#x27;)</span><br><span class="line">ORDER BY id</span><br><span class="line"></span><br><span class="line">Query id: 0461fe5a-19f6-4017-9683-a596670b34e3</span><br><span class="line"></span><br><span class="line">┌─host─────────┬─port─┬─status─┬─error─┬─num_hosts_remaining─┬─num_hosts_active─┐</span><br><span class="line">│ 172.28.160.4 │ 9000 │ 0 │ │ 5 │ 0 │</span><br><span class="line">│ 172.28.160.4 │ 9001 │ 0 │ │ 4 │ 0 │</span><br><span class="line">│ 172.28.160.3 │ 9001 │ 0 │ │ 3 │ 0 │</span><br><span class="line">│ 172.28.160.2 │ 9000 │ 0 │ │ 2 │ 0 │</span><br><span class="line">│ 172.28.160.2 │ 9001 │ 0 │ │ 1 │ 0 │</span><br><span class="line">│ 172.28.160.3 │ 9000 │ 0 │ │ 0 │ 0 │</span><br><span class="line">└──────────────┴──────┴────────┴───────┴─────────────────────┴──────────────────┘</span><br><span class="line"></span><br><span class="line">6 rows in set. Elapsed: 0.310 sec.</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>可以看到各个节点上均已创建了表，集群功能正常</p>
<p>验证插入数据<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">ct-bigdata-clickhouse-160-2 :) insert into test_cluster_table values(1,&#x27;光猫200&#x27;,88)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ct-bigdata-clickhouse-160-2 :) select * from test_cluster_table;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM test_cluster_table</span><br><span class="line"></span><br><span class="line">Query id: c29c5e62-8843-4456-98b5-2cdda06068fb</span><br><span class="line"></span><br><span class="line">┌─id─┬─name────┬─price─┐</span><br><span class="line">│ 1 │ 光猫200 │ 88 │</span><br><span class="line">└────┴─────────┴───────┘</span><br><span class="line"></span><br><span class="line">1 row in set. Elapsed: 0.001 sec.</span><br><span class="line"></span><br><span class="line">[root@ct-bigdata-clickhouse-160-4 ~]# clickhouse-client --user=default --password=123456 --port=9001</span><br><span class="line">ClickHouse client version 22.12.3.5 (official build).</span><br><span class="line">Connecting to localhost:9001 as user default.</span><br><span class="line">Connected to ClickHouse server version 22.12.3 revision 54461.</span><br><span class="line"></span><br><span class="line">ct-bigdata-clickhouse-160-4 :) select * from test_cluster_table;</span><br><span class="line"></span><br><span class="line">SELECT *</span><br><span class="line">FROM test_cluster_table</span><br><span class="line"></span><br><span class="line">Query id: 97c833d2-cd9a-4994-95c6-7919555b5e55</span><br><span class="line"></span><br><span class="line">┌─id─┬─name────┬─price─┐</span><br><span class="line">│ 1 │ 光猫200 │ 88 │</span><br><span class="line">└────┴─────────┴───────┘</span><br><span class="line"></span><br><span class="line">1 row in set. Elapsed: 0.001 sec.</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><br>上面的结果可以看到 在s1r1 插入的数据。在 s1r2 实例上可以看到。replica 功能正常。</p>
<p>以上为clickhouse 集群安装完整步骤。</p>
<h5 id="8-将集群配置独立写到metrika-xml-的方法"><a href="#8-将集群配置独立写到metrika-xml-的方法" class="headerlink" title="8. 将集群配置独立写到metrika.xml 的方法"></a>8. 将集群配置独立写到metrika.xml 的方法</h5><p>上述安装过程是将集群配置 <remote_servers> 写在 config 配置文件中，这里提供另一种方案，将remote_servers 的配置写在额外的配置文件中。默认额外配置文件读取路径为 /etc/metrika.xml</p>
<p>1) 在 172.28.160.2 节点上 /etc/config.d/ 目录中创建文件 metrika.xml </p>
<p>vi metrika.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">yandex</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">three_shards_tow_replicated</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                             <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                     <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.4<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">host</span>&gt;</span>172.28.160.3<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">port</span>&gt;</span>9001<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">user</span>&gt;</span>repl<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">                                   <span class="tag">&lt;<span class="name">password</span>&gt;</span>PLAINPASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;/<span class="name">three_shards_tow_replicated</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">yandex</span>&gt;</span></span><br></pre></td></tr></table></figure><br>将该文件发送到其他节点上上<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp metrika.xml 172.28.160.3:/etc/clickhouse-server/config.d/</span><br><span class="line"></span><br><span class="line">scp metrika.xml 172.28.160.4:/etc/clickhouse-server/config.d/</span><br></pre></td></tr></table></figure><br>三个节点上对该文件修改所有者为 clickhouse</p>
<p>2) 修改config 文件，所有实例的config 文件都要修改</p>
<p>将原先<code>&lt;remote_servers&gt;。。。&lt;/remote_servers&gt;</code> 的配置屏蔽或者删除</p>
<p>添加<br>表示将引用子文件 clickhouse_remote_servers 属性下的配置,incl对应metrika 里面的标签名。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">remote_servers</span> <span class="attr">incl</span>=<span class="string">&quot;clickhouse_remote_servers&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><br>修改读取 metrika.xml 的路径。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">include_from</span>&gt;</span>/etc/clickhouse-server/config.d/metrika.xml<span class="tag">&lt;/<span class="name">include_from</span>&gt;</span></span><br></pre></td></tr></table></figure><br>3) 重启实例，并检查集群是否正常</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/01/13/MergeTree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/13/MergeTree/" class="post-title-link" itemprop="url">clickhouse 的 MergeTree 引擎</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-13 09:49:07" itemprop="dateCreated datePublished" datetime="2023-01-13T09:49:07+08:00">2023-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-16 16:30:20" itemprop="dateModified" datetime="2023-03-16T16:30:20+08:00">2023-03-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/clickhouse/" itemprop="url" rel="index"><span itemprop="name">clickhouse</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>MergeTree 的主要特性</p>
<ul>
<li>存储按主键排序的数据</li>
<li>支持分区表</li>
<li>支持数据复制</li>
<li>支持数据采样</li>
</ul>
<p><code>注意的是 Merge 引擎并不是 *MergeTree 引擎的家族成员</code></p>
<h4 id="建一个-MergeTree-表"><a href="#建一个-MergeTree-表" class="headerlink" title="建一个 MergeTree 表"></a>建一个 MergeTree 表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">    name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1] [TTL expr1],</span><br><span class="line">    name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2] [TTL expr2],</span><br><span class="line">    ...</span><br><span class="line">    INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1,</span><br><span class="line">    INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2,</span><br><span class="line">    ...</span><br><span class="line">    PROJECTION projection_name_1 (<span class="keyword">SELECT</span> <span class="operator">&lt;</span><span class="keyword">COLUMN</span> LIST EXPR<span class="operator">&gt;</span> [<span class="keyword">GROUP</span> <span class="keyword">BY</span>] [<span class="keyword">ORDER</span> <span class="keyword">BY</span>]),</span><br><span class="line">    PROJECTION projection_name_2 (<span class="keyword">SELECT</span> <span class="operator">&lt;</span><span class="keyword">COLUMN</span> LIST EXPR<span class="operator">&gt;</span> [<span class="keyword">GROUP</span> <span class="keyword">BY</span>] [<span class="keyword">ORDER</span> <span class="keyword">BY</span>])</span><br><span class="line">) ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> expr</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">PRIMARY</span> KEY expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[TTL expr</span><br><span class="line">    [<span class="keyword">DELETE</span><span class="operator">|</span><span class="keyword">TO</span> DISK <span class="string">&#x27;xxx&#x27;</span><span class="operator">|</span><span class="keyword">TO</span> VOLUME <span class="string">&#x27;xxx&#x27;</span> [, ...] ]</span><br><span class="line">    [<span class="keyword">WHERE</span> conditions]</span><br><span class="line">    [<span class="keyword">GROUP</span> <span class="keyword">BY</span> key_expr [<span class="keyword">SET</span> v1 <span class="operator">=</span> aggr_func(v1) [, v2 <span class="operator">=</span> aggr_func(v2) ...]] ] ]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br><span class="line"></span><br><span class="line">ENGINE： 指定 MergeTree() ,MergeTree 引擎没有参数</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>： 指定一组排序键, 例如 <span class="keyword">ORDER</span> <span class="keyword">BY</span> (event_date,counter_id)不需要排序时指定 tuple()如果没有指定 <span class="keyword">PRIMARY</span> KEY 则clickhouse 会按<span class="keyword">ORDER</span> <span class="keyword">BY</span> 的排序字段建一个主键</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span>：指定分区键，分区并不会加速查询，不要使用细粒度的键作为分区键。按月分区可使用 toYYYYMM(date_column) 表达式</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY：主键，当主键顺序与 <span class="keyword">ORDER</span> <span class="keyword">BY</span> 排序键不一致时指定</span><br><span class="line">SAMPLE <span class="keyword">BY</span>：采样表达式。采样列必须包含在主键里面。例如:SAMPLE <span class="keyword">BY</span> intHash32(UserID) <span class="keyword">ORDER</span> <span class="keyword">BY</span> (CounterID, EventDate, intHash32(UserID))</span><br><span class="line">TTL：指定一系列规则，规定行的持续存储时长，并定义数据在磁盘与卷之间自动转移的逻辑。比如定时将部分数据转化为冷数据,存储到普通磁盘中。表达式必须包含日期或者时间的字段。</span><br><span class="line">示例:</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> example_table</span><br><span class="line">(</span><br><span class="line">    d DateTime,</span><br><span class="line">    a <span class="type">Int</span></span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(d)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> d</span><br><span class="line">TTL d <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">MONTH</span> <span class="keyword">DELETE</span>,   <span class="comment">-- 删除超过一个月的行</span></span><br><span class="line">    d <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">1</span> WEEK <span class="keyword">TO</span> VOLUME <span class="string">&#x27;aaa&#x27;</span>, <span class="comment">-- 超过1周的行转移到名为aaa 的卷</span></span><br><span class="line">    d <span class="operator">+</span> <span class="type">INTERVAL</span> <span class="number">2</span> WEEK <span class="keyword">TO</span> DISK <span class="string">&#x27;bbb&#x27;</span>; <span class="comment">-- 超过2周的行转移到名为 bbb 的磁盘</span></span><br><span class="line"></span><br><span class="line">SETTINGS：设置控制MergeTree 行为的参数</span><br><span class="line">   index_granularity：索引粒度，定义一个索引标记存储的最大行数。默认值 <span class="number">8192</span>行</span><br><span class="line">   index_granularity_bytes：数据粒度的最大大小。默认值 <span class="number">10</span>Mb ,如果只按行数限制，则需要将其值设置为<span class="number">0</span> (不推荐)</span><br><span class="line">   min_index_granularity_bytes：数据粒度最小大小。默认<span class="number">1024</span>b,防止意外创建具有非常低粒度的表</span><br><span class="line">   enable_mixed_granularity_parts：是否启动 index_granularity_bytes 的开关。启动数据粒度大小限制有利于提高大行表的查询</span><br><span class="line">   use_minimalistic_part_header_in_zookeeper：设置在zookeeper中存储数据部分头部信息的方法。设置为<span class="number">1</span> 将存储更少的信息</span><br><span class="line">   min_merge_bytes_to_use_direct_io：设置在合并操作时直接使用DIRECT_IO 的最小数据量，默认<span class="number">10</span>MB，设置<span class="number">1</span> 开启， <span class="number">0</span> 关闭</span><br><span class="line">   merge_with_ttl_timeout：在重复合并数据执行 ttl <span class="keyword">delete</span> 操作时的最小间隔时间 。默认<span class="number">4</span>小时</span><br><span class="line">   merge_with_recompression_ttl_timeout：在重复合并数据执行 ttl 压缩 操作时的最小间隔时间。默认<span class="number">4</span>小时</span><br><span class="line">   try_fetch_recompressed_part_timeout：clickhouse 在启动合并压缩数据前，尝试从副本里获取此次标志合并压缩的已压缩数据的超时时间。 默认<span class="number">2</span>小时</span><br><span class="line">   write_final_mark：是否在数据部分末尾写上最终索引标记(在最后一个字节之后)。默认 <span class="number">1</span> 开启， 请不要关掉它</span><br><span class="line">   merge_max_block_size：合并时块的最大行数，默认 <span class="number">8192</span></span><br><span class="line">   storage_policy：存储策略</span><br><span class="line">   min_bytes_for_wide_part,min_rows_for_wide_part：设置可以存储为wide 格式的最小的数据大小<span class="operator">/</span>最小的行数</span><br><span class="line">   max_parts_in_total：最大的分区数</span><br><span class="line">   max_compress_block_size：数据压缩前数据块的最大尺寸。</span><br><span class="line">   min_compress_block_size：数据压缩前数据块的最小尺寸。</span><br><span class="line">   max_partitions_to_read：查询时可以查的最大分区数</span><br></pre></td></tr></table></figure>
<h4 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h4><p>一张表由按主键排序的数据部分组成<br>主键没有唯一性约束，允许插入多条相同主键的数据</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2023/01/11/ckOptimize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/11/ckOptimize/" class="post-title-link" itemprop="url">ckOptimize</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-11 10:53:49" itemprop="dateCreated datePublished" datetime="2023-01-11T10:53:49+08:00">2023-01-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sheen</p>
  <div class="site-description" itemprop="description">数据库相关技术研究,自动化运维</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">76</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sheen</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  


    </div>
</body>
</html>
