<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sheenzxx.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="数据库相关技术研究,自动化运维">
<meta property="og:type" content="website">
<meta property="og:title" content="sheen&#39;s Blog">
<meta property="og:url" content="https://sheenzxx.github.io/page/3/index.html">
<meta property="og:site_name" content="sheen&#39;s Blog">
<meta property="og:description" content="数据库相关技术研究,自动化运维">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sheen">
<meta property="article:tag" content="Python,shell,SQL,oracle,mysql,postgresql">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://sheenzxx.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>sheen's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="sheen's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">sheen's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">随笔，技术笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/home/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/21/pgLogicalReplication/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/21/pgLogicalReplication/" class="post-title-link" itemprop="url">PG逻辑复制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-21 09:57:54" itemprop="dateCreated datePublished" datetime="2022-10-21T09:57:54+08:00">2022-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-27 17:29:09" itemprop="dateModified" datetime="2022-10-27T17:29:09+08:00">2022-10-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h3><p>PG 逻辑复制在9.4 版本开始支持。只是那时使用逻辑复制是以扩展的方式使用，需要额外编译插件，从pg 10开始，<br>我们可以很简单的在数据库中直接创建publication 以及 subcription 的方式来使用逻辑复制。</p>
<h4 id="1-1-逻辑复制与物理复制的区别："><a href="#1-1-逻辑复制与物理复制的区别：" class="headerlink" title="1.1. 逻辑复制与物理复制的区别："></a>1.1. 逻辑复制与物理复制的区别：</h4><pre><code>逻辑复制是基于复制标识（通常是主键）复制数据以及变更的方法
物理复制是基于精确的数据块地址喝逐字节复制的方法
</code></pre><h4 id="1-2-逻辑复制的使用场景"><a href="#1-2-逻辑复制的使用场景" class="headerlink" title="1.2. 逻辑复制的使用场景"></a>1.2. 逻辑复制的使用场景</h4><pre><code>1.可以发送一个库或者一个子集的增量变更数据给订阅者
2.当个别变更到达订阅端时引动触发器
3.基于分析目的的将多个数据库的数据汇总到一个数据库
4.在不同数据库版本之间做复制(一般可用作数据库版本升级)
5.在不同平台的数据中做复制(例如linux 与 windows 之间的PG 的复制)
6.发送不同的数据给不同分组的人员
7.在不同数据库中共享一个子集
</code></pre><p>订阅数据库可以作为发布者创建发布给其他数据库做订阅。订阅数据一般只作为只读。如果对订阅对象写入，有可能会<br>引发冲突。</p>
<h3 id="2-发布"><a href="#2-发布" class="headerlink" title="2. 发布"></a>2. 发布</h3><p>发布可以在任何物理复制主机上创建,有定义发布的节点我们称为发布者。发布是记录一个表或者一组表变更的集合<br>（也称为复制集或者改变集），每一个发布只能存在一个数据库。</p>
<p>发布不同于模式(schema)，不影响表的访问形势。如果需要每个表可以存在于多个发布中，发布目前只能包含表或者模式<br>中的所有表，必须显式添加到发布中。除非在创建发布时使用ALL tables 选项</p>
<p>Publication可以选择把它们产生的更改限制为INSERT、UPDATE、DELETE以及TRUNCATE的任意组合，类似于触发器如何<br>被特定事件类型触发的方式。默认情况下，所有操作类型都会被复制</p>
<p>每一个发布表都有一个复制标识，一般是主键，或者是唯一键，如果都没有那么将标识为full ，即整行作为复制标识</p>
<h4 id="2-1-创建发布"><a href="#2-1-创建发布" class="headerlink" title="2.1. 创建发布"></a>2.1. 创建发布</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span><span class="operator">+</span> 版本</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION name</span><br><span class="line">    [ <span class="keyword">FOR</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">      <span class="operator">|</span> <span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES ]</span><br><span class="line">    [ <span class="keyword">WITH</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"></span><br><span class="line"><span class="number">15</span><span class="operator">+</span> 版本   </span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION name</span><br><span class="line">    [ <span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES</span><br><span class="line">      <span class="operator">|</span> <span class="keyword">FOR</span> publication_object [, ... ] ]</span><br><span class="line">    [ <span class="keyword">WITH</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">where</span> publication_object <span class="keyword">is</span> <span class="keyword">one</span> <span class="keyword">of</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [ ( column_name [, ... ] ) ] [ <span class="keyword">WHERE</span> ( expression ) ] [, ... ]</span><br><span class="line">    TABLES <span class="keyword">IN</span> SCHEMA &#123; schema_name <span class="operator">|</span> <span class="built_in">CURRENT_SCHEMA</span> &#125; [, ... ]</span><br><span class="line"></span><br><span class="line">释义</span><br><span class="line">name </span><br><span class="line">    发布名</span><br><span class="line"></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">TABLE</span> </span><br><span class="line">    指定要被添加到发布的表列表，如果指定<span class="keyword">ONLY</span> 则只有<span class="keyword">ONLY</span> 后面那个表添加进去,没有指定则列表全部添加。</span><br><span class="line">    如果表名后加 <span class="operator">*</span> ，则这个表的所有派生表都将被添加（PG 存在表继承）,但分区表不适用，分区表的分区都会作为发布的一部分，不用在创建发布时指定。 </span><br><span class="line">    表名后面加 (列名,...) 只有指定的列会被发布，没有指定则发布表的所有字段，包含以后新建的所有字段。</span><br><span class="line">    <span class="keyword">where</span> 表达式则是过滤满足条件的数据才会被发布</span><br><span class="line">    <span class="keyword">TABLE</span> <span class="keyword">IN</span> SCHEMA(<span class="number">15</span><span class="operator">+</span> 版本)，可以直接指定摸个模式下所有表添加，包含以后建的新表。相比<span class="keyword">ALL</span> TABLES ，复制粒度更小。更灵活</span><br><span class="line">    只有普通表，分区表(<span class="number">13</span><span class="operator">+</span> 版本)才能放在发布中,临时表，非日志记录表，外部表，物化视图，以及普通视图都不能放在发布中</span><br><span class="line"></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES </span><br><span class="line">    指定将数据库里是所有表都添加到发布中去。包含以后建的新表</span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">    publish (string) </span><br><span class="line">        指定限制发布DML，可以是  <span class="string">&#x27;insert, update, delete, truncate&#x27;</span> 的任意组合(<span class="keyword">truncate</span> <span class="number">11</span><span class="operator">+</span> 版本支持)，默认<span class="number">4</span>种全部发布</span><br><span class="line">    publish_via_partition_root (<span class="type">boolean</span>) (<span class="number">13</span><span class="operator">+</span> 版本) </span><br><span class="line">        这个参数决定当分区表或者在其分区上的变更是在模式中是使用一个标识还是那个变更的分区表做标识，默认是变更的分区表做标志,启用这个选项，将允许</span><br><span class="line">        分区表变更能被复制到同名的非分区表或分区表中。</span><br><span class="line">        当它被启用。作用于分区上的<span class="keyword">truncate</span> 操作将不会被复制</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">注意</span><br><span class="line">    如果 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> 或者 <span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES 没有设置，发布启动时带一个空表集，以后添加表时会添加到这个表集中</span><br><span class="line">    创建发布并没有马上启动复制。它只是为以后的订阅者定义了一个组和一些过滤逻辑</span><br><span class="line">    创建发布的用户必须在当前数据库中具备<span class="keyword">create</span> 权限 （super 用户会忽略这个检查）</span><br><span class="line">    将表添加到发布中，用户必须具备该表的所有权。<span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES 则要求用户具有SUPER权限</span><br><span class="line">    添加到发布<span class="keyword">UPDATE</span><span class="operator">/</span><span class="keyword">DELETE</span>操作的表必须已经定义了复制标识,否则将在这些标识禁用这些操作</span><br><span class="line">    对于<span class="keyword">insert</span> ... <span class="keyword">on</span> conflict命令，发布是以实际发生的数据变更发布的，因此根据结果。可能是<span class="keyword">insert</span> 也可能是<span class="keyword">update</span> 。也可能不发布</span><br><span class="line">    对于 <span class="keyword">copy</span> ... <span class="keyword">from</span> 命令是作为<span class="keyword">insert</span> 发布的</span><br><span class="line">    DDL 操作不发布</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">示例</span><br><span class="line">#创建一个发布,包含<span class="number">2</span>个表的变更</span><br><span class="line"><span class="keyword">create</span> publication my_pub <span class="keyword">for</span> <span class="keyword">table</span> table1,table2;</span><br><span class="line"></span><br><span class="line">#创建一个发布，包含所有报的变更</span><br><span class="line"><span class="keyword">create</span> publication my_pub <span class="keyword">for</span> <span class="keyword">all</span> tables;</span><br><span class="line"></span><br><span class="line">#创建一个发布，包含指定DML</span><br><span class="line"><span class="keyword">create</span> publication my_pub <span class="keyword">for</span> <span class="keyword">table</span> <span class="keyword">with</span> publish(<span class="string">&#x27;delete,update&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="2-2-修改发布"><a href="#2-2-修改发布" class="headerlink" title="2.2. 修改发布"></a>2.2. 修改发布</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#为发布添加表</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">ADD</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">#替换发布中的表的列表</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">SET</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">#删除发布中的表</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">DROP</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">#修改发布中的发布属性</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">SET</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">#修改发布的所有者</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name OWNER <span class="keyword">TO</span> &#123; new_owner <span class="operator">|</span> <span class="built_in">CURRENT_USER</span> <span class="operator">|</span> <span class="built_in">SESSION_USER</span> &#125;</span><br><span class="line">#为发布重命名</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name RENAME <span class="keyword">TO</span> new_name</span><br><span class="line"></span><br><span class="line">## 示例</span><br><span class="line"><span class="keyword">alter</span> publicaiton my_pub <span class="keyword">set</span> (publish <span class="operator">=</span> <span class="string">&#x27;insert,update&#x27;</span>)</span><br><span class="line"><span class="keyword">alter</span> publication my_pub <span class="keyword">add</span> tab2,tab3;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-删除发布"><a href="#2-3-删除发布" class="headerlink" title="2.3. 删除发布"></a>2.3. 删除发布</h4><p>发布只能被发布的所有者及超级用户删除<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> PUBLICATION [ IF <span class="keyword">EXISTS</span> ] name [, ...] [ CASCADE <span class="operator">|</span> RESTRICT ]</span><br><span class="line"></span><br><span class="line">## 示例</span><br><span class="line"><span class="keyword">drop</span> publication my_pub;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-订阅"><a href="#3-订阅" class="headerlink" title="3. 订阅"></a>3. 订阅</h3><p>订阅位于逻辑复制的下游，创建有订阅的节点称为订阅者。订阅定义了与另一个数据库的连接以及需要订阅的的发布集（一个或多个发布）<br>订阅节点上可以有多个订阅，每一个订阅接收一个复制槽（replication slot）的数据变更。当初始化好同步表以前存在的数据时，可能额外需要多的复制槽。并且在同步结束后删除。<br>逻辑复制的订阅可作为同步复制的备用服务器，备用名默认为订阅名，可以在订阅的连接信息中用application_name指定一个可供选择的名称<br>创建订阅的用户需要super 权限，因为non-superusers不能读取pg_subscription的信息<br>create subscription 用于创建订阅 alter subscription 用于停止和复用订阅，drop subscription 则用于删除订阅。<br>当订阅被删除并重新创建时，同步信息将丢失，这意味着数据必须重新同步<br>模式定义不会被复制,发布的表必须在订阅端存在。<br>发布与订阅端的表必须同名。不支持不同名表订阅<br>发布与订阅端的表的字段名必须相同，订阅端表列的顺序不要求与发布端相同，列的数据类型也不需要一样，只要可以将数据的文本表示形式转换为目标类型即可。订阅端表列可以比发布端<br>多，多出的列将以订阅端表的定义默认值填充</p>
<h4 id="3-1-复制槽管理"><a href="#3-1-复制槽管理" class="headerlink" title="3.1 复制槽管理"></a>3.1 复制槽管理</h4><p>如上面说的。在表初始化开始同步数据时，会要求额外的复制槽—数据同步槽，数据同步槽又系统内部自动创建，并在不需要时自动<br>删除。数据同步槽名称为“pg<em>%u_sync</em>%u_%llu”，参数为：订阅oid, 表的relid,系统标识sysid<br>一般情况下。远端的复制槽的创建在订阅创建（create subscription）的时候创建，并且在删除订阅(drop subscription)的时候删除,在某些情况下有必要单独操纵订阅以及其底层的复制槽。</p>
<h5 id="下面是一些场景："><a href="#下面是一些场景：" class="headerlink" title="下面是一些场景："></a>下面是一些场景：</h5><pre><code>1.在创建一个订阅时，复制槽已经存在。在这种情况下，可以使用create_slot = false选项创建订阅并关联到现有的槽
2.在创建一个订阅时，远程主机不可达或者处于一种不明状态。在这种情况下，可以使用connect = false选项创建订阅。那么远程主机将根本不会被联系。
  这是pg_dump所使用的方式。这样，在订阅可以被激活之前，必须手工创建远程复制槽
3.在删除一个订阅时，复制槽应该被保留。当订阅者数据库正在被移动到一台不同的主机并且将从那里再被激活时，这种行为很有用。在这种情况下，可以在尝试删除该订阅之前，
  使用ALTER SUBSCRIPTION将复制槽解除关联
4.在删除一个订阅是，远程主机不可达。在这种情况下，可以在尝试删除该订阅之前，使用ALTER SUBSCRIPTION将复制槽解除关联。如果远程数据库实例不再存在，那么不需要进一步的行动。
  不过，如果远程数据库实例只是不可达，那么复制槽应该被手动删除。否则它将会继续保留WAL并且最终可能会导致磁盘被填满。这种情况应该要仔细地研究
</code></pre><h4 id="3-2-创建订阅"><a href="#3-2-创建订阅" class="headerlink" title="3.2 创建订阅"></a>3.2 创建订阅</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION subscription_name</span><br><span class="line">    CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line">    PUBLICATION publication_name [, ...]</span><br><span class="line">    [ <span class="keyword">WITH</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"></span><br><span class="line">subscription_name</span><br><span class="line">    订阅名</span><br><span class="line">CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line">    连接远端发布节点的连接串</span><br><span class="line">PUBLICATION publication_name</span><br><span class="line">    发布名称,可以指定多个发布名称。也即是一个订阅可以订阅多个发布</span><br><span class="line"><span class="keyword">WITH</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">    指定订阅相关参数</span><br><span class="line">    <span class="keyword">connect</span> (<span class="type">boolean</span>)</span><br><span class="line">        指定创建订阅时是否连接远程发布节点，默认<span class="literal">true</span>,设置为<span class="literal">false</span> ,会强制设置 create_slot , enabled , copy_data 这<span class="number">3</span>个参数值为 <span class="literal">false</span></span><br><span class="line">        当该参数设置为<span class="literal">false</span> ，没有表会被订阅，当enable 订阅时，不会发生任何复制，必须执行<span class="keyword">ALTER</span> SUBSCRIPTION ... REFRESH PUBLICATION 才能使表订阅生效</span><br><span class="line">    create_slot (<span class="type">boolean</span>) </span><br><span class="line">        指定是否在发布节点上创建复制槽，默认值<span class="literal">true</span>, 如果设置为<span class="literal">false</span> ,你将需要通过别的方法在发布节点上创建复制槽</span><br><span class="line">    enabled (<span class="type">boolean</span>) </span><br><span class="line">        指定订阅是否马上生效，默认 <span class="literal">true</span> ,设置<span class="literal">false</span> 则只是创建并没有让复制生效</span><br><span class="line">    slot_name (string)</span><br><span class="line">        指定发布节点上复制槽的名称，默认值是将订阅的名称当做复制槽的名称</span><br><span class="line">        设置为<span class="keyword">NONE</span> 将表示订阅不创建复制槽，当你想稍后手工创建复制槽可使用该选项。同时必须设置create_slot，slot_name 的值为<span class="literal">false</span></span><br><span class="line">    #下面的参数则是控制订阅创建后的行为：</span><br><span class="line">    <span class="type">binary</span> (<span class="type">boolean</span>) (<span class="number">14</span><span class="operator">+</span> 版本)</span><br><span class="line">        指定订阅是否要求发布者发送数据采用<span class="type">binary</span> 格式（相对应的是text），默认值为<span class="literal">false</span>,如果设置为<span class="literal">true</span>,也只有具有二进制发送和接收功能的数据类型才会以二进制形式传输。</span><br><span class="line">        在进行跨版本复制时，可能会因为发布者具有某种数据类型的二进制发送功能，而订阅者缺少该类型的二进制接收功能导致数据传输将失败，并且无法使用二进制选项。</span><br><span class="line">    copy_data (<span class="type">boolean</span>)</span><br><span class="line">        指定是否在订阅开始时同步发布表中已存在的数据，默认值为<span class="literal">true</span></span><br><span class="line">        如果创建发布时有指定<span class="keyword">where</span> 条件，则满足条件的数据才会被发布过来</span><br><span class="line">    streaming (<span class="type">boolean</span>) （<span class="number">14</span><span class="operator">+</span> 版本)</span><br><span class="line">        指定是否为订阅开启正在进行中的事务中进行流传输。默认情况下所有事务都在发布端解码。然后才整个完整的发布给订阅</span><br><span class="line">    synchronous_commit (enum)</span><br><span class="line">        该参数会覆盖系统参数 synchronous_commit</span><br><span class="line">        设置为off 对 逻辑复制是安全的：如果订阅因为缺少同步而丢失的事务。发布者将会从新发布</span><br><span class="line">        在进行同步逻辑复制时，逻辑复制worker 将持续向发布者报告写入和刷新的位置，发布者则等待实际的刷新，这意味着订阅端设置synchronous_commit<span class="operator">=</span>off 将会增加发布端<span class="keyword">commit</span> 的延迟，</span><br><span class="line">        这种情况下设置为<span class="keyword">local</span> 或更高级别将会更合适</span><br><span class="line">    two_phase (<span class="type">boolean</span>) (<span class="number">15</span><span class="operator">+</span> 版本)</span><br><span class="line">        指定订阅是否启用两阶段提交，默认值<span class="literal">false</span></span><br><span class="line">        当启用两阶段提交，准备好的事务将会在 <span class="keyword">prepare</span> tansaction 阶段时就传给订阅者，在订阅者上也当做<span class="number">2</span>阶段处理。否则准备好的事务只有在提交时才会发送给订阅者。然后由订阅者立即处理</span><br><span class="line">        两阶段提交的实现要求复制已成功完成初始表同步阶段。 因此，即使为订阅启用了 two_phase，内部的两阶段状态也会暂时保持“待定”，直到初始化阶段完成。 查看 pg_subscription 的 subtwophasestate 列，了解实际的两阶段状态</span><br><span class="line">    disable_on_error (<span class="type">boolean</span>)</span><br><span class="line">        指定如果订阅工作者在从发布者复制数据期间检测到任何错误，是否应自动禁用订阅。 默认为<span class="literal">false</span>      </span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">    #创建一个订阅，并且不马上激活</span><br><span class="line">    <span class="keyword">CREATE</span> SUBSCRIPTION mysub</span><br><span class="line">         CONNECTION <span class="string">&#x27;host=192.168.1.50 port=5432 user=foo dbname=foodb&#x27;</span></span><br><span class="line">        PUBLICATION insert_only</span><br><span class="line">               <span class="keyword">WITH</span> (enabled <span class="operator">=</span> <span class="literal">false</span>);</span><br><span class="line">    #创建一个有<span class="number">2</span>个发布的订阅</span><br><span class="line">    <span class="keyword">CREATE</span> SUBSCRIPTION mysub</span><br><span class="line">         CONNECTION <span class="string">&#x27;host=192.168.1.50 port=5432 user=foo dbname=foodb&#x27;</span></span><br><span class="line">        PUBLICATION mypublication, insert_only;    </span><br></pre></td></tr></table></figure>
<h4 id="3-3-注意："><a href="#3-3-注意：" class="headerlink" title="3.3 注意："></a>3.3 注意：</h4><pre><code>不能在事务块中执行带创建复制槽行为的CREATE SUBSCRIPTION.
创建订阅时带创建复制槽的行为在相同的数据库集群（集群内不同的数据库之间，或者同个数据库之间）都会导致创建行为挂起.除非是创建时指定不创建复制槽，如果想实现集群中不同库复制行为， 首先应该通过插件pgoutput，使用其函数pg_create_logical_replication_slot先创建复制槽。然后再创建复制时指定 create_slot=false。这种限制性定义，可能会在未来的版本中取消
任何在发布中带where限制的表。其中不匹配的行或者空数据都会被发布,如果一个订阅有多个发布者，并且其中一个表有多个带where的发布，只要所有发布where条件任何一个成立，那一行会被发布。如果其中一个发布者没有带where条件或者采用了 ALL TABLE 或者 ALL TABLE IN SCHEMA,则表的每一行都始终发布，不管其他定义如何。而在15 版本以前，where定义在初始化同步表数据阶段将被忽略,这种情况下，用户需在初始化同步后自行删除不匹配的行。
订阅者有关联多个发布的，每个发布者同一个表的列必须相同。不支持不相同列的集合
允许使用不存在的发布，
</code></pre><h4 id="3-4-修改订阅"><a href="#3-4-修改订阅" class="headerlink" title="3.4 修改订阅"></a>3.4 修改订阅</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SET</span> PUBLICATION publication_name [, ...] [ <span class="keyword">WITH</span> ( publication_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">ADD</span> PUBLICATION publication_name [, ...] [ <span class="keyword">WITH</span> ( publication_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">DROP</span> PUBLICATION publication_name [, ...] [ <span class="keyword">WITH</span> ( publication_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name REFRESH PUBLICATION [ <span class="keyword">WITH</span> ( refresh_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name ENABLE</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name DISABLE</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SET</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SKIP</span> ( skip_option <span class="operator">=</span> <span class="keyword">value</span> )</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name OWNER <span class="keyword">TO</span> &#123; new_owner <span class="operator">|</span> <span class="built_in">CURRENT_ROLE</span> <span class="operator">|</span> <span class="built_in">CURRENT_USER</span> <span class="operator">|</span> <span class="built_in">SESSION_USER</span> &#125;</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name RENAME <span class="keyword">TO</span> new_name</span><br><span class="line">注意：</span><br><span class="line">修改订阅能修改创建订阅时设置的大部分属性</span><br><span class="line">关于权限问题。目前的订阅都是superuser 所以所有者检查将会被忽略。未来的版本可能改变这个问题</span><br><span class="line">当刷新发布的时候，将会移除那些不属于发布者的关系，如果有同步复制槽，同时删除同步复制槽，以便释放订阅在远端服务器分配的资源</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION ... REFRESH PUBLICATION 和  <span class="keyword">ALTER</span> SUBSCRIPTION ... &#123;<span class="keyword">SET</span><span class="operator">|</span><span class="keyword">ADD</span><span class="operator">|</span><span class="keyword">DROP</span>&#125; PUBLICATION ... <span class="keyword">with</span> refresh option <span class="keyword">as</span> <span class="literal">true</span> 句式不能在事务块中执行</span><br><span class="line">也不能用于设置了两阶段提交的订阅(two_phase <span class="operator">=</span><span class="literal">true</span>),除了copy_data<span class="operator">=</span><span class="literal">false</span>,可以了在视图pg_subscription的subtwophasestate字段查看两阶段提交实际状态</span><br><span class="line">参数说明：</span><br><span class="line">name</span><br><span class="line">    订阅的名称</span><br><span class="line">CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line">    连接发布节点的数据库连接串</span><br><span class="line"><span class="keyword">SET</span> PUBLICATION publication_name</span><br><span class="line"><span class="keyword">ADD</span> PUBLICATION publication_name</span><br><span class="line"><span class="keyword">DROP</span> PUBLICATION publication_name</span><br><span class="line">    这<span class="number">3</span>个句式是改变订阅的发布列表。<span class="keyword">SET</span> 是替换 ，<span class="keyword">ADD</span> 是添加 ，<span class="keyword">DROP</span> 则是删除，默认情况下这些操作也像 REFRESH PUBLICATION</span><br><span class="line">    publication_option 选项是 refresh ,默认值是<span class="literal">true</span> ,修改为<span class="literal">false</span> 则不刷新发布表信息，REFRESH PUBLICATION 需另外执行</span><br><span class="line">REFRESH PUBLICATION</span><br><span class="line">    在发布者获取缺失的表信息，这将添加从创建复制开始或从上一次REFRESH PUBLICATION之后的所有新增的表的复制</span><br><span class="line">    refresh_option： copy_data (<span class="type">boolean</span>) 是否将同步已存在的的表数据</span><br><span class="line">ENABLE</span><br><span class="line">    激活被禁用的订阅</span><br><span class="line">DISABLE</span><br><span class="line">    禁用活动的订阅</span><br><span class="line"><span class="keyword">SET</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">    修改在创建订阅时指定的参数值(slot_name, synchronous_commit, <span class="type">binary</span>, streaming, <span class="keyword">and</span> disable_on_error)</span><br><span class="line"><span class="keyword">SKIP</span> ( skip_option <span class="operator">=</span> <span class="keyword">value</span> )</span><br><span class="line">    跳过远程事务的修改，当传入的数据违反了任何约束。逻辑复制将停止，直到解决。通过<span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SKIP</span> 命令可以时复制worker跳过事务中所有数据的修改，</span><br><span class="line">    此选项对启动两阶段提交的订阅者上已经准备好的事务没有影响。逻辑复制worker成功跳过事务或完成事务后，LSN(存储在pg_subscription.subskiplsn)将被清除</span><br><span class="line">    skip_option： LSN, 指定逻辑复制worker将跳过其更改的远程事务的完成 LSN。 完成 LSN 是提交或准备事务的 LSN。 不支持跳过单个子事务。 设置 <span class="keyword">NONE</span> 会重置 LSN。</span><br><span class="line">new_owner</span><br><span class="line">    为订阅指定新的所有者</span><br><span class="line">new_name</span><br><span class="line">    修改订阅的名字</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">    #重新设置订阅的发布列表</span><br><span class="line">    <span class="keyword">ALTER</span> SUBSCRIPTION mysub <span class="keyword">SET</span> PUBLICATION insert_only;</span><br><span class="line">    #禁用订阅</span><br><span class="line">    <span class="keyword">ALTER</span> SUBSCRIPTION mysub DISABLE;</span><br></pre></td></tr></table></figure>
<h4 id="3-5-删除订阅"><a href="#3-5-删除订阅" class="headerlink" title="3.5 删除订阅"></a>3.5 删除订阅</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> SUBSCRIPTION [ IF <span class="keyword">EXISTS</span> ] name [ CASCADE <span class="operator">|</span> RESTRICT </span><br><span class="line">删除订阅，订阅只能被superuser 删除，不能在事务块中执行删除带有复制槽的订阅</span><br><span class="line">参数说明：</span><br><span class="line">name</span><br><span class="line">    订阅名称</span><br><span class="line">CASCADE</span><br><span class="line">RESTRICT</span><br><span class="line">    这些关键词没有任何作用，因为订阅没有依赖关系。</span><br><span class="line"></span><br><span class="line">注意:</span><br><span class="line">     当删除带复制槽的订阅时，删除命令会连接远端发布节点去删除复制槽。这是很有必要的，远端为订阅分配的资源将能得到释放.如果远端节点不可达或者远端节点上的复制槽没法被删除，</span><br><span class="line">     或者复制槽在远端不存在，或者未曾存在过，都将导致删除命令失败退出。这种情况下。可以通过 <span class="keyword">ALTER</span> SUBSCRIPTION ... <span class="keyword">SET</span> (slot_name <span class="operator">=</span> <span class="keyword">NONE</span>)，然后再删除订阅，这种操作</span><br><span class="line">     将不会去远端执行删除复制槽。但请注意远端的复制槽并没有被删除，需要手工去删除复制槽。如果不删除。会导致远端节点一直保留等待被复制的WAL ，存在磁盘空间被耗尽的风险。</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">    <span class="keyword">DROP</span> SUBSCRIPTION mysub;</span><br></pre></td></tr></table></figure>
<h3 id="4-行过滤（15-版本"><a href="#4-行过滤（15-版本" class="headerlink" title="4. 行过滤（15+ 版本)"></a>4. 行过滤（15+ 版本)</h3><h4 id="4-1-行过滤规则"><a href="#4-1-行过滤规则" class="headerlink" title="4.1 行过滤规则"></a>4.1 行过滤规则</h4><pre><code>行过滤发送在发布者发布数据之前，不符合条件或者对应列为空的数据将不会被复制，行过滤器对truncate 无效
</code></pre><h4 id="4-2-表达式限制"><a href="#4-2-表达式限制" class="headerlink" title="4.2 表达式限制"></a>4.2 表达式限制</h4><pre><code>WHERE 子句只允许简单的表达式。 它不能包含用户定义的函数、运算符、类型和排序规则、系统列引用或非不可变的内置函数，如果是发布UPDATE/DELETE 操作，则条件中必须
包含复制标识列(主键,唯一键)，如果是INSERT 则where 条件可以是任何列
</code></pre><h4 id="4-3-UPDATE操作在行过滤中的转换"><a href="#4-3-UPDATE操作在行过滤中的转换" class="headerlink" title="4.3 UPDATE操作在行过滤中的转换"></a>4.3 UPDATE操作在行过滤中的转换</h4><pre><code>每一个UPDATE 操作,都会对旧行以及新行进行where条件匹配。如果新旧行都不匹配则不复制。如果旧行匹配，新行匹配则INSERT,如果旧行匹配，新行不匹配
则DELETE,如果新旧行都匹配则UPDATE.如下图1示
</code></pre><p>图1<br><img src="/images/UpdateTransformation.png" alt="UpdateTrans">   </p>
<h4 id="4-4-行过滤在分区表的行为"><a href="#4-4-行过滤在分区表的行为" class="headerlink" title="4.4 行过滤在分区表的行为"></a>4.4 行过滤在分区表的行为</h4><pre><code>publish_via_partition_root 参数将决定行过滤的行为，如果设置为true 则使用根分区表的行过滤器。如果设置为false ，则使用每个分区的行过滤器 
</code></pre><h4 id="4-5-初始化数据同步行为"><a href="#4-5-初始化数据同步行为" class="headerlink" title="4.5 初始化数据同步行为"></a>4.5 初始化数据同步行为</h4><pre><code>如果订阅要求同步已存在的数据，并且发布包含where 过滤，只有匹配的行才会发送给订阅
如果订阅者同时订阅有多个发布，只要满足任何一个where 过滤的行都会被发送给订阅
(上面提到过如果订阅者是15版本以前的版本，在初始化数据时不会对已存在数据做行过滤)
</code></pre><h4 id="4-6-绑定多行过滤"><a href="#4-6-绑定多行过滤" class="headerlink" title="4.6 绑定多行过滤"></a>4.6 绑定多行过滤</h4><pre><code>订阅者同时订阅多个发布，并且这些发布在同一个表上都包含where 过滤器，对于每一行数据,通过OR运算对每个过滤器进行匹配。只要满足其中一个则成立，
那么遇到以下情况，则过滤器将变得多余
1.其中一个发布者没有包含过滤器
2.其中一个发布者在创建时使用了FOR ALL TABLE 子句。这种不允许包含过滤行为
3.其中一个发布者在创建时使用了FOR ALL TABLES IN SCHEMA,并且这个表在定义的schema 里面，这种也不允许包含过滤行为
</code></pre><h4 id="4-7-示例"><a href="#4-7-示例" class="headerlink" title="4.7 示例"></a>4.7 示例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"># 在发布节点上创建测试表</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(a <span class="type">int</span>, b <span class="type">int</span>, c text, <span class="keyword">PRIMARY</span> KEY(a,c));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t2(d <span class="type">int</span>, e <span class="type">int</span>, f <span class="type">int</span>, <span class="keyword">PRIMARY</span> KEY(d));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t3(g <span class="type">int</span>, h <span class="type">int</span>, i <span class="type">int</span>, <span class="keyword">PRIMARY</span> KEY(g));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 在发布节点上创建带行过滤的发布</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p1 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t1 <span class="keyword">WHERE</span> (a <span class="operator">&gt;</span> <span class="number">5</span> <span class="keyword">AND</span> c <span class="operator">=</span> <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p2 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t1, t2 <span class="keyword">WHERE</span> (e <span class="operator">=</span> <span class="number">99</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p3 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t2 <span class="keyword">WHERE</span> (d <span class="operator">=</span> <span class="number">10</span>), t3 <span class="keyword">WHERE</span> (g <span class="operator">=</span> <span class="number">10</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line"># 在psql 中 通过 \dRp<span class="operator">+</span> 展示所有的行过滤器</span><br><span class="line">test_pub<span class="operator">=</span># \dRp<span class="operator">+</span></span><br><span class="line">                               Publication p1</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t1&quot; <span class="keyword">WHERE</span> ((a <span class="operator">&gt;</span> <span class="number">5</span>) <span class="keyword">AND</span> (c <span class="operator">=</span> <span class="string">&#x27;NSW&#x27;</span>::text))</span><br><span class="line"></span><br><span class="line">                               Publication p2</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t1&quot;</span><br><span class="line">    &quot;public.t2&quot; <span class="keyword">WHERE</span> (e <span class="operator">=</span> <span class="number">99</span>)</span><br><span class="line"></span><br><span class="line">                               Publication p3</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t2&quot; <span class="keyword">WHERE</span> (d <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line">    &quot;public.t3&quot; <span class="keyword">WHERE</span> (g <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"># 也可以通过\d 表名的方式查看某个表上的行过滤器</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># \d t1</span><br><span class="line">                 <span class="keyword">Table</span> &quot;public.t1&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> a      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"> b      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"> c      <span class="operator">|</span> text    <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line">Indexes:</span><br><span class="line">    &quot;t1_pkey&quot; <span class="keyword">PRIMARY</span> KEY, btree (a, c)</span><br><span class="line">Publications:</span><br><span class="line">    &quot;p1&quot; <span class="keyword">WHERE</span> ((a <span class="operator">&gt;</span> <span class="number">5</span>) <span class="keyword">AND</span> (c <span class="operator">=</span> <span class="string">&#x27;NSW&#x27;</span>::text))</span><br><span class="line">    &quot;p2&quot;</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># \d t2</span><br><span class="line">                 <span class="keyword">Table</span> &quot;public.t2&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> d      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"> e      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"> f      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line">Indexes:</span><br><span class="line">    &quot;t2_pkey&quot; <span class="keyword">PRIMARY</span> KEY, btree (d)</span><br><span class="line">Publications:</span><br><span class="line">    &quot;p2&quot; <span class="keyword">WHERE</span> (e <span class="operator">=</span> <span class="number">99</span>)</span><br><span class="line">    &quot;p3&quot; <span class="keyword">WHERE</span> (d <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># \d t3</span><br><span class="line">                 <span class="keyword">Table</span> &quot;public.t3&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> g      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"> h      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"> i      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line">Indexes:</span><br><span class="line">    &quot;t3_pkey&quot; <span class="keyword">PRIMARY</span> KEY, btree (g)</span><br><span class="line">Publications:</span><br><span class="line">    &quot;p3&quot; <span class="keyword">WHERE</span> (g <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在订阅节点上 创建一个与发布节点上相同结构的表 t1，并且创建订阅 s1 ，订阅发布p1</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(a <span class="type">int</span>, b <span class="type">int</span>, c text, <span class="keyword">PRIMARY</span> KEY(a,c));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> SUBSCRIPTION s1</span><br><span class="line">test_sub<span class="operator">-</span># CONNECTION <span class="string">&#x27;host=localhost dbname=test_pub application_name=s1&#x27;</span></span><br><span class="line">test_sub<span class="operator">-</span># PUBLICATION p1;</span><br><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line"># 在发布节点上为表t1 插入一些数据，这时我们能看到满足p1 过滤条件的数据复制到订阅节点上了</span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">102</span>, <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">103</span>, <span class="string">&#x27;QLD&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">104</span>, <span class="string">&#x27;VIC&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">105</span>, <span class="string">&#x27;ACT&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="number">106</span>, <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="number">107</span>, <span class="string">&#x27;NT&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="number">108</span>, <span class="string">&#x27;QLD&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="number">109</span>, <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">2</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line"> <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">106</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line"> <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">106</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#更新一些数据，更新的旧行与新行都满足p1的过滤条件，这个时候<span class="keyword">UPDATE</span> 操作 正常的复制到订阅节点上</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> b <span class="operator">=</span> <span class="number">999</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">1</span></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">2</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line"> <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line"> <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line"> <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">#再更新一些数据，使旧行不满足p1过滤条件，而新行满足过滤条件，这个时候<span class="keyword">UPDATE</span> 操作变为<span class="keyword">INSERT</span> 操作复制到订阅节点上</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> a <span class="operator">=</span> <span class="number">555</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line">   <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line">   <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line">   <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 再更新一些数据使旧行满足p1过滤条件，而新行不满足，这个时候<span class="keyword">UPDATE</span> 操作变为<span class="keyword">DELETE</span> 操作复制到订阅节点上</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> c <span class="operator">=</span> <span class="string">&#x27;VIC&#x27;</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">9</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line">   <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line">   <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line">   <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">   <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> VIC</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#####下面是分区表行过滤的示例</span><br><span class="line"></span><br><span class="line"># 发布节点上创建分区表主parent,以及分区表子表child</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> parent(a <span class="type">int</span> <span class="keyword">PRIMARY</span> KEY) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(a);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child <span class="keyword">PARTITION</span> <span class="keyword">OF</span> parent <span class="keyword">DEFAULT</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 相同的表结构在订阅节点上也创建</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> parent(a <span class="type">int</span> <span class="keyword">PRIMARY</span> KEY) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(a);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child <span class="keyword">PARTITION</span> <span class="keyword">OF</span> parent <span class="keyword">DEFAULT</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 发布节点上创建条件发布p4,订阅节点创建订阅s4，订阅p4的发布，并且设置 publish_via_partition_root <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p4 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> parent <span class="keyword">WHERE</span> (a <span class="operator">&lt;</span> <span class="number">5</span>), child <span class="keyword">WHERE</span> (a <span class="operator">&gt;=</span> <span class="number">5</span>)</span><br><span class="line">test_pub<span class="operator">-</span># <span class="keyword">WITH</span> (publish_via_partition_root<span class="operator">=</span><span class="literal">true</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> SUBSCRIPTION s4</span><br><span class="line">test_sub<span class="operator">-</span># CONNECTION <span class="string">&#x27;host=localhost dbname=test_pub application_name=s4&#x27;</span></span><br><span class="line">test_sub<span class="operator">-</span># PUBLICATION p4;</span><br><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line"># 发布节点上写入些数据</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> parent <span class="keyword">VALUES</span> (<span class="number">2</span>), (<span class="number">4</span>), (<span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child <span class="keyword">VALUES</span> (<span class="number">3</span>), (<span class="number">5</span>), (<span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> parent <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> <span class="number">4</span></span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br><span class="line"># 订阅节点上可以看到</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> parent <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> <span class="number">4</span></span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 再来检验 publish_via_partition_root <span class="operator">=</span> <span class="literal">false</span> 的情况</span><br><span class="line"># 发布节点删除发布p4 并重建创建发布设置  publish_via_partition_root <span class="operator">=</span> <span class="literal">false</span> </span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">DROP</span> PUBLICATION p4;</span><br><span class="line"><span class="keyword">DROP</span> PUBLICATION</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p4 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> parent, child <span class="keyword">WHERE</span> (a <span class="operator">&gt;=</span> <span class="number">5</span>)</span><br><span class="line">test_pub<span class="operator">-</span># <span class="keyword">WITH</span> (publish_via_partition_root<span class="operator">=</span><span class="literal">false</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line"># 订阅节点刷新</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">ALTER</span> SUBSCRIPTION s4 REFRESH PUBLICATION;</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">TRUNCATE</span> parent;</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> parent <span class="keyword">VALUES</span> (<span class="number">2</span>), (<span class="number">4</span>), (<span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child <span class="keyword">VALUES</span> (<span class="number">3</span>), (<span class="number">5</span>), (<span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> parent <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> <span class="number">4</span></span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>
<h3 id="5-指定表字段集-15-版本"><a href="#5-指定表字段集-15-版本" class="headerlink" title="5 指定表字段集(15+ 版本)"></a>5 指定表字段集(15+ 版本)</h3><pre><code>可基于行行为或性能原因选择指定表字段，但不可作为安全限制，恶意的订阅能够读取发布未指定的列数据
如果没有指定表字段，则新增的字段数据同样会自动被复制，如果指定了表字段，那只有指定的字段数据会被复制
表字段列表只能包含简单的字段引用。 不保留表中字段的顺序
创建发布指定 FOR TABLE IN SCHEMA 时不支持指定表字段列表
对于分区表，由发布参数 publish_via_partition_root 决定用父表的字段列，还是子表的字段列表。设置true 使用父表的字段列，设置false（默认值）使用子表的字段列表
如果发布者会发布UPDATE/DELETE 操作，则字段列表必须包含表标识列（主键，唯一键），如果只是发布INSERT ,则可以省略包含表标识，字段列表对于TRUNCATE无任何影响 
在数据初始化期间只有发布指定的表字段列表会被拷贝，然而当订阅者的版本是15以前的版本时，所有的列都会同步过去。
订阅者订阅多个发布时，不支持每个发布者使用不同的表字段列表。当出现由于某个发布调整字段，这个时候就可能导致不同发布间字段不一致，这种情况alter publication 会成功
但稍后可能在发布者的walsender 报错，或者订阅者可能也抛错。这个时候需要通过alter subscription ... drop publicaiton ...删除有问题的发布，然后调整其列表再加回来。
</code></pre><h4 id="5-1-示例"><a href="#5-1-示例" class="headerlink" title="5.1 示例"></a>5.1 示例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 发布节点上创建表 t1</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(id <span class="type">int</span>, a text, b text, c text, d text, e text, <span class="keyword">PRIMARY</span> KEY(id));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 创建发布p1 带表字段列表</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p1 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t1 (id, b, a, d);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line"># 在psql 中使用 \dRp<span class="operator">+</span> 查看发布定义</span><br><span class="line">test_pub<span class="operator">=</span># \dRp<span class="operator">+</span></span><br><span class="line">                               Publication p1</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t1&quot; (id, a, b, d)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在订阅节点上创建相同表结构的表并创建一个订阅者订阅p1</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(id <span class="type">int</span>, b text, a text, d text, <span class="keyword">PRIMARY</span> KEY(id));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> SUBSCRIPTION s1</span><br><span class="line">test_sub<span class="operator">-</span># CONNECTION <span class="string">&#x27;host=localhost dbname=test_pub application_name=s1&#x27;</span></span><br><span class="line">test_sub<span class="operator">-</span># PUBLICATION p1;</span><br><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line"># 在发布节点上初始化数据</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">&#x27;a-1&#x27;</span>, <span class="string">&#x27;b-1&#x27;</span>, <span class="string">&#x27;c-1&#x27;</span>, <span class="string">&#x27;d-1&#x27;</span>, <span class="string">&#x27;e-1&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">&#x27;a-2&#x27;</span>, <span class="string">&#x27;b-2&#x27;</span>, <span class="string">&#x27;c-2&#x27;</span>, <span class="string">&#x27;d-2&#x27;</span>, <span class="string">&#x27;e-2&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">3</span>, <span class="string">&#x27;a-3&#x27;</span>, <span class="string">&#x27;b-3&#x27;</span>, <span class="string">&#x27;c-3&#x27;</span>, <span class="string">&#x27;d-3&#x27;</span>, <span class="string">&#x27;e-3&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"> id <span class="operator">|</span>  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c  <span class="operator">|</span>  d  <span class="operator">|</span>  e</span><br><span class="line"><span class="comment">----+-----+-----+-----+-----+-----</span></span><br><span class="line">  <span class="number">1</span> <span class="operator">|</span> a<span class="number">-1</span> <span class="operator">|</span> b<span class="number">-1</span> <span class="operator">|</span> c<span class="number">-1</span> <span class="operator">|</span> d<span class="number">-1</span> <span class="operator">|</span> e<span class="number">-1</span></span><br><span class="line">  <span class="number">2</span> <span class="operator">|</span> a<span class="number">-2</span> <span class="operator">|</span> b<span class="number">-2</span> <span class="operator">|</span> c<span class="number">-2</span> <span class="operator">|</span> d<span class="number">-2</span> <span class="operator">|</span> e<span class="number">-2</span></span><br><span class="line">  <span class="number">3</span> <span class="operator">|</span> a<span class="number">-3</span> <span class="operator">|</span> b<span class="number">-3</span> <span class="operator">|</span> c<span class="number">-3</span> <span class="operator">|</span> d<span class="number">-3</span> <span class="operator">|</span> e<span class="number">-3</span></span><br><span class="line"></span><br><span class="line"># 在订阅节点上我们看到只有指定的字段复制过来了</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"> id <span class="operator">|</span>  b  <span class="operator">|</span>  a  <span class="operator">|</span>  d</span><br><span class="line"><span class="comment">----+-----+-----+-----</span></span><br><span class="line">  <span class="number">1</span> <span class="operator">|</span> b<span class="number">-1</span> <span class="operator">|</span> a<span class="number">-1</span> <span class="operator">|</span> d<span class="number">-1</span></span><br><span class="line">  <span class="number">2</span> <span class="operator">|</span> b<span class="number">-2</span> <span class="operator">|</span> a<span class="number">-2</span> <span class="operator">|</span> d<span class="number">-2</span></span><br><span class="line">  <span class="number">3</span> <span class="operator">|</span> b<span class="number">-3</span> <span class="operator">|</span> a<span class="number">-3</span> <span class="operator">|</span> d<span class="number">-3</span></span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>
<h3 id="6-冲突"><a href="#6-冲突" class="headerlink" title="6 冲突"></a>6 冲突</h3><p>当订阅节点订阅表在本地被更改过时，或者由于表的权限问题，或者由于订阅端表开启了行级别的安全策略，都有可能引发冲突冲突一旦发生，复制将会终止。<br>可以通过查看日志了解冲突详情，并根据实际情况处理数据问题，或者解决权限问题。冲突必须经过人为解决后，复制才能够继续。<br>例如下面的错误信息<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ERROR:  duplicate key <span class="keyword">value</span> violates <span class="keyword">unique</span> <span class="keyword">constraint</span> &quot;test_pkey&quot;</span><br><span class="line">DETAIL:  Key (c)<span class="operator">=</span>(<span class="number">1</span>) already exists.</span><br><span class="line">CONTEXT:  processing remote data <span class="keyword">for</span> replication origin &quot;pg_16395&quot; during &quot;INSERT&quot; <span class="keyword">for</span> replication target relation &quot;public.test&quot; <span class="keyword">in</span> transaction <span class="number">725</span> finished <span class="keyword">at</span> <span class="number">0</span><span class="operator">/</span><span class="number">14</span>C0378</span><br></pre></td></tr></table></figure><br>在错误信息中我们可以看到事务的LSN 0/14C0378 还有复制源 pg_16395。我们可以通过  ALTER SUBSCRIPTION … SKIP 的命令来跳过完成的冲突事务，<br>也可以通过函数pg_replication_origin_advance(node_name text, lsn pg_lsn) 来跳过完成的冲突事务。<br>在使用pg_replication_origin_advance() 函数前必须先禁用订阅，或者创建订阅时指定了参数disable_on_error=true.<br>接着指定node_name “pg_16395” 以及完成的冲突事务 0/14C0378 的下一个位置 0/14C0379。当前复制源的位置可通过pg_replication_origin_status 系统视图来查看。</p>
<p>需要注意的是跳过整个事务。可能会将事务中本不冲突的数据也一并跳过。很容易引起订阅节点与发布节点上数据的不一致</p>
<h3 id="7-限制"><a href="#7-限制" class="headerlink" title="7 限制"></a>7 限制</h3><p>逻辑复制有以下的限制</p>
<pre><code>1. DDL 并不会被复制。初始化订阅节点时可以采用pg_dump -n -s 的方法导出指定schema下所有表结构。当发布节点上的表结构做变更时，需先在订阅节点上做变更。然后再在发布节点上做变更
2. 序列数据不会被复制。当要启用订阅节点作为业务节点时，一定要先重置序列的起始值，或重建序列，已满足当前序列值与表的最大值相匹配
3. 支持truncate 复制。在发布执行truncate需要注意的是，在truncate 关联外键的某些表。会同时清空关联的一组表。如果订阅节点也是相同的一组表关联，则复制正常运行。但如果订阅节点
   上还关联了某些不属于发布上关联的表。则复制会失败
4. 大对象不会被复制。 除了将数据存储在普通表中之外，没有解决方法
5. 复制只支持普通表，包括分区表。 尝试复制其他类型，例如视图、物化视图或外部表，将导致错误
6. 当复制分区表时，发布节点上有的分区子表，在订阅节点上都必须存在。
</code></pre><h3 id="8-复制架构"><a href="#8-复制架构" class="headerlink" title="8 复制架构"></a>8 复制架构</h3><p>逻辑复制从发布节点拷贝数据快照开始，当数据快照拷贝完成之后，发布节点上的变更将实时发送到订阅节点上。订阅者按照在发布<br>者上提交的顺序应用数据，以便保证任何单个订阅中的发布的事务一致性。</p>
<p>逻辑复制是用类似于物理流复制的架构构建的。 它由“walsender”和“apply”进程实现。walsender 进程启动 WAL 的逻辑解码<br>并加载标准逻辑解码插件（pgoutput）。 该插件将从 WAL 读取的更改转换为逻辑复制协议并根据发布规范过滤数据。 然后使用<br>流复制协议将数据连续传输到应用工作程序，应用工作程序将数据映射到本地表并在收到更改时以正确的事务顺序应用各个更改</p>
<p>订阅节点上的应用进程在运行时总是设置 session_replication_role= replica,这通常对触发器跟约束有影响。<br>    session_replication_role [origin|replica|local]:在会话中控制触发跟复制相关的触发器以及规则 .此设置的预期用途是逻辑复制系统在应用复制更改时将其值设置为replica</p>
<p>逻辑复制应用进程当前只触发行触发器，而不是语句触发器。 然而，初始表同步的实现类似于 COPY 命令，因此会触发 INSERT<br>的行触发器和语句触发器。</p>
<h3 id="9-监控"><a href="#9-监控" class="headerlink" title="9 监控"></a>9 监控</h3><p>逻辑复制采用类似于物理流复制的框架。监控发布者的健康状态可以通过 pg_stat_replication 视图查看<br>而对于订阅节点，则可以通过 pg_stat_subscription 查看</p>
<h3 id="10-配置参数设置"><a href="#10-配置参数设置" class="headerlink" title="10 配置参数设置"></a>10 配置参数设置</h3><p>在发布节点上<br>    wal_level = logical<br>    max_replication_slots &gt;= 订阅数量 + 初始化时同步表的连接数<br>    max_wal_senders &gt;= max_replication_slots + 物理复制从库的连接数<br>订阅节点上<br>    max_replication_slots &gt;= 订阅数量 + 初始化时同步表的连接数<br>    max_logical_replication_workers &gt;= 订阅数量 + 初始化时同步表的连接数<br>    max_worker_processes &gt;= max_logical_replication_workers + 1</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/20/pglogical/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/20/pglogical/" class="post-title-link" itemprop="url">利用PG 的逻辑复制给阿里云数据搭建IDC 逻辑复制库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-20 10:50:37" itemprop="dateCreated datePublished" datetime="2022-10-20T10:50:37+08:00">2022-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-28 15:21:15" itemprop="dateModified" datetime="2022-10-28T15:21:15+08:00">2022-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/postgres/" itemprop="url" rel="index"><span itemprop="name">postgres</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>将阿里云RDS 数据同步回IDC 做备库，最佳选择是DTS，当然想省钱的话，我们不妨来做个逻辑复制</p>
<h4 id="pg-逻辑复制的要求"><a href="#pg-逻辑复制的要求" class="headerlink" title="pg 逻辑复制的要求:"></a>pg 逻辑复制的要求:</h4><pre><code>1.postgresql 10+ 版本
2.wal_level 设置为 pglogical
3.max_replication_slots 至少设置为1 
4.逻辑复制采用发布,订阅模式。即在主库创建发布。在备库创建订阅
5.目前仅支持 INSERT ,UPDATE , DELETE 操作，11+ 支持 TRUNCATE ,不支持DDL。
6.被发布表（published table ）。必须都有一个复制标识。默认是表的主键，或者有唯一键 都可以被设置为复制标志。如果没有任何唯一标识可用。则会设置为full,已整列数据作为标志
7.订阅者连接发布的用户必须具有super 权限，如果具有super 权限。订阅将由pg_dump 转储，如果不具备super 权限则无法在 pg_subscription 中读取订阅信息，订阅将会被跳过。
8.发布数据库源表必须在订阅库中目标表以同名存在，订阅库目标表可以比发布库源表多字段,但源表字段必须在目标库都存在,对应的字段名也应该相同，不要求顺序相同，字段类型也只需要能够自动转换即可。
</code></pre><p>下面开始演示<br>由于云库RDS 我们一般都不具有super 权限。我们在创建发布者时，就没办法 create publication xxx for all tables; 只能按表来添加</p>
<h4 id="1-导出发布端数据表结构（注意这里只复制指定的schema-表）"><a href="#1-导出发布端数据表结构（注意这里只复制指定的schema-表）" class="headerlink" title="1. 导出发布端数据表结构（注意这里只复制指定的schema 表）"></a>1. 导出发布端数据表结构（注意这里只复制指定的schema 表）</h4><pre><code>pg_dump -f publication_db.meta.sql -U publication_db -s publication_db -h xxxx.aliyun.com -p port
</code></pre><h4 id="2-订阅端导入表"><a href="#2-订阅端导入表" class="headerlink" title="2. 订阅端导入表"></a>2. 订阅端导入表</h4><pre><code>create database publication_db owner xxxx  tablespace xxxx;
psql -U publication_db -d publication_db &lt; publication_db.meta.sql
</code></pre><h4 id="3-查看发布端是否具备逻辑复制条件"><a href="#3-查看发布端是否具备逻辑复制条件" class="headerlink" title="3. 查看发布端是否具备逻辑复制条件"></a>3. 查看发布端是否具备逻辑复制条件</h4><pre><code>show wal_level;
wal_level =logical 
show max_replication_slots;
max_replication_slots = 10
show max_wal_senders;
max_wal_senders = 10
</code></pre><p>   按照上述要求，如果不是则进行调整。然后重启数据库（生产环境重启数据库必须与业务协商）</p>
<h4 id="4-发布端创建发布"><a href="#4-发布端创建发布" class="headerlink" title="4. 发布端创建发布"></a>4. 发布端创建发布</h4><pre><code> create publication publication_db_logical for table xxxx;
 Select * from pg_publication; #查看发布者信息
</code></pre><h4 id="5-订阅端创建订阅"><a href="#5-订阅端创建订阅" class="headerlink" title="5. 订阅端创建订阅"></a>5. 订阅端创建订阅</h4><pre><code>\c publication_db superUser
create subscription publication_db_sub connction &#39;host=aliyun.db.domain port=xxx dbname=publication_db user=superUser password=xxxx&#39; publication publication_db_logical;
##对于pg中无法解析域名，我们可以先ping 下 RDS的域名。以得到真实IP，然后在/etc/hosts 中对应添加 ip  域名
select * from pg_subscription; #查看订阅信息
</code></pre><h4 id="6-在发布端查看是否已经启动复制进程"><a href="#6-在发布端查看是否已经启动复制进程" class="headerlink" title="6. 在发布端查看是否已经启动复制进程"></a>6. 在发布端查看是否已经启动复制进程</h4><pre><code>select * from pg_stat_replication;
</code></pre><h4 id="7-订阅创建成功后"><a href="#7-订阅创建成功后" class="headerlink" title="7. 订阅创建成功后"></a>7. 订阅创建成功后</h4><pre><code>订阅端首先进行的是表数据初始化。即在发布端全量拉取数据过来，完成后再进行增量同步
</code></pre><h4 id="8-添加余下的表到发布中"><a href="#8-添加余下的表到发布中" class="headerlink" title="8. 添加余下的表到发布中"></a>8. 添加余下的表到发布中</h4><pre><code>alter publication publication_db_logical add table tab1,tab2,tab3....
</code></pre><h4 id="9-在订阅端刷新订阅"><a href="#9-在订阅端刷新订阅" class="headerlink" title="9. 在订阅端刷新订阅"></a>9. 在订阅端刷新订阅</h4><pre><code>alter subscription mysub refresh publication;  #只有发动刷新。发布端的变动才会同步过来
</code></pre><h3 id="如果发布表需要增加字段。逻辑复制还能继续吗？"><a href="#如果发布表需要增加字段。逻辑复制还能继续吗？" class="headerlink" title="如果发布表需要增加字段。逻辑复制还能继续吗？"></a>如果发布表需要增加字段。逻辑复制还能继续吗？</h3><p>如果发布表增加了字段。而订阅表没有添加字段，逻辑复制就会中断。这个时候，只要在订阅节点库中对应表添加相应字段，再把订阅启动起来，就可以了。<br>正确的添加顺序。应该在订阅节点库先添加字段。然后再在发布节点库添加字段。然后看看是否复制正常。复制不正常就先停下复制。再启动复制即可</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/19/RecoveryDRSToIDc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/19/RecoveryDRSToIDc/" class="post-title-link" itemprop="url">将阿里云RDS备份拉回IDC做从库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-19 14:05:57 / 修改时间：16:03:28" itemprop="dateCreated datePublished" datetime="2022-10-19T14:05:57+08:00">2022-10-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定"><a href="#1-登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定" class="headerlink" title="1. 登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定"></a>1. 登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定</h3><p><img src="/images/20221019141152.png" alt="Lena"></p>
<h3 id="2-下载备份文件"><a href="#2-下载备份文件" class="headerlink" title="2. 下载备份文件"></a>2. 下载备份文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -c <span class="string">&quot;https://rdsbak-st-v2.oss-cn-shenzhen-internal.aliyuncs.com/custinxxxxxxx/hins21434496_data_20221019045743_qp.xb?xxxxxxxxxxxx.....&quot;</span> -O hins21434496_data_20221019045743_qp.xb </span><br></pre></td></tr></table></figure>
<h3 id="3-解压文件恢复xtrbackup-备份"><a href="#3-解压文件恢复xtrbackup-备份" class="headerlink" title="3.解压文件恢复xtrbackup 备份"></a>3.解压文件恢复xtrbackup 备份</h3><h5 id="A-如果环境中没有qpress-跟-xtrabackup-工具-则需要先下载安装"><a href="#A-如果环境中没有qpress-跟-xtrabackup-工具-则需要先下载安装" class="headerlink" title="A. 如果环境中没有qpress 跟 xtrabackup 工具 则需要先下载安装"></a>A. 如果环境中没有qpress 跟 xtrabackup 工具 则需要先下载安装</h5><p>对于MySQL 5.7、5.6或5.5实例：安装Percona XtraBackup 2.4。<br>对于MySQL 8.0实例，安装Percona XtraBackup 8.0。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">&quot;http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/183466/cn_zh/1608011575185/qpress-11-linux-x64.tar&quot;</span></span><br><span class="line">tar xvf qpress-11-linux-x64.tar</span><br><span class="line"><span class="built_in">chmod</span> 775 qpress</span><br><span class="line"><span class="built_in">cp</span> qpress /usr/bin</span><br></pre></td></tr></table></figure><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libev</span><br><span class="line">wget <span class="string">&quot;https://downloads.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.26/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.26-1.el7.x86_64.rpm&quot;</span></span><br><span class="line">yum -y install percona-xtrabackup-24-2.4.26-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<h5 id="B-解压恢复"><a href="#B-解压恢复" class="headerlink" title="B. 解压恢复"></a>B. 解压恢复</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> data_common_xtrabackup</span><br><span class="line"><span class="built_in">cat</span> hins21434496_data_20221019045743_qp.xb | xbstream -x -v -C /usr/local/mysql/data_common_xtrabackup</span><br><span class="line">innobackupex --decompress --remove-original /usr/local/mysql/data_common_xtrabackup</span><br><span class="line">innobackupex --default-files=/usr/local/mysql/data_common_xtrabackup/backup-my.cnf --apply-log /usr/local/mysql/data_common_xtrabackup</span><br></pre></td></tr></table></figure>
<h3 id="4-搭建从库"><a href="#4-搭建从库" class="headerlink" title="4. 搭建从库"></a>4. 搭建从库</h3><h5 id="A-将backup-my-cnf-的innodb-部分参数添加到本地IDC-etc-my-cnf"><a href="#A-将backup-my-cnf-的innodb-部分参数添加到本地IDC-etc-my-cnf" class="headerlink" title="A. 将backup-my.cnf 的innodb 部分参数添加到本地IDC /etc/my.cnf"></a>A. 将backup-my.cnf 的innodb 部分参数添加到本地IDC /etc/my.cnf</h5><pre><code>innodb_log_files_in_group=2
innodb_log_file_size=1572864000
innodb_log_buffer_size=8388608
innodb_page_size=16384
innodb_undo_tablespaces=2
</code></pre><h5 id="B-完整的配置文件部分"><a href="#B-完整的配置文件部分" class="headerlink" title="B. 完整的配置文件部分"></a>B. 完整的配置文件部分</h5><pre><code>[mysqld4]
port    = 3309
socket  = /tmp/mysql.common_aliyun_slave.sock
datadir = /usr/local/mysql/data_common_aliyun_slave
innodb_data_home_dir = /usr/local/mysql/data_common_aliyun_slave
innodb_undo_directory = /usr/local/mysql/data_common_aliyun_slave
innodb_log_group_home_dir = /usr/local/mysql/data_common_aliyun_slave
innodb_buffer_pool_size = 10G
innodb_buffer_pool_instances = 10
innodb_fast_shutdown=0
innodb_log_files_in_group=2
innodb_log_file_size=1572864000
innodb_log_buffer_size=8388608
innodb_page_size=16384
innodb_undo_tablespaces=2
init_connect=&#39;set names utf8mb4&#39;
character-set-server=utf8mb4
server-id = 186
collation-server=utf8mb4_general_ci
log-slave-updates = true
skip-grant-tables #这个参数先添加以便去除权限登录数据库修改
</code></pre><h5 id="C-将恢复目录里面mysql-库的两个trigger-重命名-重置root-密码相关信息"><a href="#C-将恢复目录里面mysql-库的两个trigger-重命名-重置root-密码相关信息" class="headerlink" title="C. 将恢复目录里面mysql 库的两个trigger 重命名,重置root 密码相关信息"></a>C. 将恢复目录里面mysql 库的两个trigger 重命名,重置root 密码相关信息</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/mysql/data_common_aliyun_slave/mysql</span><br><span class="line"><span class="built_in">mv</span> user.TRG user.TRG.bak</span><br><span class="line"><span class="built_in">mv</span> proxies_priv.TRG proxies_priv.TRG.bak</span><br><span class="line">mysqld_multi start 4</span><br><span class="line">mysql -uroot -p -S /tmp/mysql.common_aliyun_slave.sock</span><br><span class="line">mysql&gt; use mysql</span><br><span class="line">mysql&gt; update user <span class="built_in">set</span> authentication_string=password(<span class="string">&#x27;xxx&#x27;</span>),host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span> <span class="built_in">where</span> user=<span class="string">&#x27;aliyun_root&#x27;</span>;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">mysql&gt; <span class="built_in">exit</span>;</span><br></pre></td></tr></table></figure>
<h5 id="D-查看恢复目录里面的-xtrabackup-info-文件-gtid-execute-信息"><a href="#D-查看恢复目录里面的-xtrabackup-info-文件-gtid-execute-信息" class="headerlink" title="D. 查看恢复目录里面的 xtrabackup_info 文件 gtid execute 信息"></a>D. 查看恢复目录里面的 xtrabackup_info 文件 gtid execute 信息</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> xtrabackup_info</span><br><span class="line">uuid = 99c6d1c2-4f2f-11ed-b7c8-0c42a1b70fa6</span><br><span class="line">name = </span><br><span class="line">.....</span><br><span class="line">lock_time = 1</span><br><span class="line">binlog_pos = filename <span class="string">&#x27;mysql-bin.000834&#x27;</span>, position 15350993, GTID of the last change <span class="string">&#x27;8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130585536&#x27;</span></span><br><span class="line">innodb_from_lsn = 0</span><br><span class="line">innodb_to_lsn = 437844748178</span><br><span class="line">partial = N</span><br><span class="line">incremental = N</span><br><span class="line">format = xbstream</span><br><span class="line">compact = N</span><br><span class="line">compressed = compressed</span><br><span class="line">encrypted = N</span><br></pre></td></tr></table></figure>
<h5 id="E-查看主库的gtid-purged-信息"><a href="#E-查看主库的gtid-purged-信息" class="headerlink" title="E. 查看主库的gtid purged 信息"></a>E. 查看主库的gtid purged 信息</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW GLOBAL VARIABLES LIKE <span class="string">&#x27;gtid_purged&#x27;</span>; </span><br><span class="line">8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130084627</span><br></pre></td></tr></table></figure>
<h5 id="F-将恢复的IDC实例作为云上的从库"><a href="#F-将恢复的IDC实例作为云上的从库" class="headerlink" title="F. 将恢复的IDC实例作为云上的从库"></a>F. 将恢复的IDC实例作为云上的从库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; reset slave;</span><br><span class="line">mysql&gt; reset master;</span><br><span class="line">mysql&gt; <span class="built_in">set</span> @@global.gtid_purged=<span class="string">&#x27;8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130084627,8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130585536&#x27;</span></span><br><span class="line">mysql&gt; change master to</span><br><span class="line">mysql&gt; master_host=<span class="string">&#x27;xxxx.aliyun.xxxxx&#x27;</span>,</span><br><span class="line">mysql&gt; master_port=<span class="string">&#x27;xxxx&#x27;</span>,</span><br><span class="line">mysql&gt; master_user=<span class="string">&#x27;repuser&#x27;</span>,</span><br><span class="line">mysql&gt; master_password=<span class="string">&#x27;reppass&#x27;</span>,</span><br><span class="line">mysql&gt; master_auto_position=1;</span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure>
<p>可以看到数据库已经正确连接到阿里云上RDS</p>
<h3 id="5-注意"><a href="#5-注意" class="headerlink" title="5. 注意"></a>5. 注意</h3><p>set @@global.gtid_purged=’主库的gtid_purged,从库的gtid_excuted’<br>master_user ， master_password 为RDS 实例上已经建好具有 select, replication_slave 的权限账号以及密码</p>
<p>上面有将2个trigger 重命名的操作。是因为阿里的数据库对user 表做了限制。只有把2个trigger 拿掉,才能修改用户表<br>否则将报如下错误<br>    ERROR 1064 (42000): Unknown trigger has an error in its body: ‘Unknown system variable ‘maintain_user_list’’</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/18/useGtidPurged/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/18/useGtidPurged/" class="post-title-link" itemprop="url">gtid purged 的巧用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-18 15:00:58 / 修改时间：15:08:47" itemprop="dateCreated datePublished" datetime="2022-10-18T15:00:58+08:00">2022-10-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="今天根据冷备搭建主从-出现问题总结"><a href="#今天根据冷备搭建主从-出现问题总结" class="headerlink" title="今天根据冷备搭建主从,出现问题总结"></a>今天根据冷备搭建主从,出现问题总结</h3><h4 id="1-UUID-相同"><a href="#1-UUID-相同" class="headerlink" title="1 UUID 相同   ."></a>1 UUID 相同   .</h4><p>   清除 auto.cnf 文件。重启 重新生成UUID</p>
<h4 id="2-change-master-后-报-从库需要的binglog-已经被主库purged"><a href="#2-change-master-后-报-从库需要的binglog-已经被主库purged" class="headerlink" title="2.change master 后  报 从库需要的binglog 已经被主库purged"></a>2.change master 后  报 从库需要的binglog 已经被主库purged</h4><p>   查询主库的 gtid_purged<br>   设置从库的gtid purged<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">master:</span><br><span class="line">show global variables like <span class="string">&#x27;%gtid%&#x27;</span> </span><br><span class="line">gtid_purged=<span class="string">&#x27;32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-181880&#x27;</span></span><br><span class="line"></span><br><span class="line">slave: </span><br><span class="line">reset master;</span><br><span class="line">reset slave all;</span><br><span class="line"><span class="built_in">set</span> global gtid_purged=<span class="string">&#x27;32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-181880&#x27;</span></span><br><span class="line">change master to ........ master_auto_position=1;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-发现从库是从已存的主库binlog-开始读取。这使从库落后5万多秒。"><a href="#3-发现从库是从已存的主库binlog-开始读取。这使从库落后5万多秒。" class="headerlink" title="3 发现从库是从已存的主库binlog 开始读取。这使从库落后5万多秒。"></a>3 发现从库是从已存的主库binlog 开始读取。这使从库落后5万多秒。</h4><p>分析从库正在执行的binlog 这些binglog 正是在写一个大表。而这个大表刚好是要清除掉的。<br>怎样修改 主库的gtid_purged<br>主库gtid purged 记录的是被清除binlog 的最后一个 gtid 。要跳过这些已经执行过的binlog .那么就需要再重置一次binlog purged<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> purge master logs to <span class="string">&#x27;mysql-bin.000112&#x27;</span>;</span><br><span class="line">mysql.sock@(none)&gt; show global variables like <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br><span class="line">| Variable_name                   | Value                                         |</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery     | OFF                                           |</span><br><span class="line">| enforce_gtid_consistency        | ON                                            |</span><br><span class="line">| gtid_executed                   | 32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-187811 |</span><br><span class="line">| gtid_mode                       | ON                                            |</span><br><span class="line">| gtid_owned                      |                                               |</span><br><span class="line">| gtid_purged                     | 32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-187809 |</span><br><span class="line">| simplified_binlog_gtid_recovery | OFF                                           |</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br></pre></td></tr></table></figure><br>主库的gtid_purged 已经跳到已知最后一个binlog </p>
<p>重置从库。重新设置主从关系。将gtid_purged 设置到 32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-187809</p>
<p>从库成功跳过不需要执行的binlog .正常运行</p>
<h4 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h4><p>这些操作基于冷备。主从库的数据是一致的。而且中间没有任何其他操作在主库产生。如有,则要知道那些必须执行过的操作落在哪。<br>取主库重启后第一个产生的Binlog 为界限。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/18/diffOfReplicationConfig/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/18/diffOfReplicationConfig/" class="post-title-link" itemprop="url">mysql replication 设置命令在8.0.23后的变化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-18 14:52:44 / 修改时间：14:55:11" itemprop="dateCreated datePublished" datetime="2022-10-18T14:52:44+08:00">2022-10-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>设置同步配置(8.0.23及以后)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CHANGE REPLICATION SOURCE TO</span><br><span class="line">    SOURCE_HOST=<span class="string">&#x27;source_host_name&#x27;</span>,</span><br><span class="line">    SOURCE_USER=<span class="string">&#x27;replication_user_name&#x27;</span>,</span><br><span class="line">    SOURCE_PASSWORD=<span class="string">&#x27;replication_password&#x27;</span>,</span><br><span class="line">    SOURCE_LOG_FILE=<span class="string">&#x27;recorded_log_file_name&#x27;</span>,</span><br><span class="line">    SOURCE_LOG_POS=recorded_log_position;</span><br></pre></td></tr></table></figure></p>
<p>设置同步配置(8.0.23以前)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO</span><br><span class="line">    MASTER_HOST=<span class="string">&#x27;source_host_name&#x27;</span>,</span><br><span class="line">    MASTER_USER=<span class="string">&#x27;replication_user_name&#x27;</span>,</span><br><span class="line">    MASTER_PASSWORD=<span class="string">&#x27;replication_password&#x27;</span>,</span><br><span class="line">    MASTER_LOG_FILE=<span class="string">&#x27;recorded_log_file_name&#x27;</span>,</span><br><span class="line">    MASTER_LOG_POS=recorded_log_position;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/17/mysql8User/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/17/mysql8User/" class="post-title-link" itemprop="url">mysql 8.0 用户权限部分</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-17 11:15:43 / 修改时间：11:35:25" itemprop="dateCreated datePublished" datetime="2022-10-17T11:15:43+08:00">2022-10-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h3><h4 id="用户表mysql-user"><a href="#用户表mysql-user" class="headerlink" title="用户表mysql.user"></a>用户表mysql.user</h4><pre><code>user.host char(255)# 5版本为60,新版本为255,并且字符类型为ascii --&gt;  CHARACTER SET ascii COLLATE ascii_general_ci NOT NULL DEFAULT &#39;&#39;
user.user char(32) # 5版本为16位 .8 版本增加至 32 位
</code></pre><p>mysql 8.0 新增了 role （角色），角色用于管理用户权限;</p>
<h4 id="创建新角色"><a href="#创建新角色" class="headerlink" title="创建新角色"></a>创建新角色</h4><pre><code>create role role_name;
create role &#39;app_read&#39;,&#39;app_write&#39;,&#39;dba&#39;;
</code></pre><h4 id="为角色授权："><a href="#为角色授权：" class="headerlink" title="为角色授权："></a>为角色授权：</h4><pre><code>grant select on db.* to &#39;app_read&#39;@&#39;%&#39;;
grant insert,delete,update on db.* to &#39;app_write&#39;@&#39;%&#39;
grant all on *.* to &#39;dba&#39;@&#39;%&#39;;
</code></pre><h4 id="为用户授权角色"><a href="#为用户授权角色" class="headerlink" title="为用户授权角色"></a>为用户授权角色</h4><pre><code>grant role,role1,role2 to &#39;user&#39;@&#39;%&#39;;
grant dba to &#39;sheen&#39;@&#39;%&#39;;
</code></pre><h4 id="为用户设置已授权的角色"><a href="#为用户设置已授权的角色" class="headerlink" title="为用户设置已授权的角色"></a>为用户设置已授权的角色</h4><pre><code>set default role dba to &#39;nagios&#39;@&#39;%&#39;;#为用户设置默认角色 （定义用户时没有使用default role 则可以通过下面命令修改）
SET DEFAULT ROLE ALL TO USERNAME[,USERNAME2,USERNAME3...]; #将所有权限都授权给用户当默认角色
SET ROLE NONE;#清除当前会话使用的角色
SET ROLE ALL EXCEPT &#39;app_write&#39; TO USERNAME;授权用户除了 &#39;app_write&#39; 角色外的所有角色
SET ROLE DEFAULT; #设置会话使用默认角色
</code></pre><h4 id="回收授权给用户的角色"><a href="#回收授权给用户的角色" class="headerlink" title="回收授权给用户的角色"></a>回收授权给用户的角色</h4><pre><code>REOVKE ROLE FROM USER;
eg:
  revoke &#39;app_read&#39; from sheen;
回收角色的授权
REVOKE INSERT, UPDATE, DELETE ON app_db.* FROM &#39;app_write&#39;;
删除角色
DROP ROLE &#39;app_read&#39;, &#39;app_write&#39;;
</code></pre><h3 id="grant-权限-on-db-to-role-name"><a href="#grant-权限-on-db-to-role-name" class="headerlink" title="grant 权限 on db.* to role_name;"></a>grant 权限 on db.* to role_name;</h3><p>eg: create role dba;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant all on *.* to <span class="string">&#x27;dba&#x27;</span>;</span><br><span class="line"><span class="comment">#授权只读角色</span></span><br><span class="line">mysql&gt; create role select_role;</span><br><span class="line">mysql&gt; grant select on db.* to <span class="string">&#x27;select_role&#x27;</span>@<span class="string">&#x27;host_name&#x27;</span>; <span class="comment">#默认授权给&#x27;%&#x27; grant select on db.* to &#x27;select_role&#x27; == grant select on db.* to &#x27;select_role&#x27;@&#x27;%&#x27;;</span></span><br><span class="line"><span class="comment">#授权修改角色</span></span><br><span class="line">mysql&gt; create role update_role;</span><br><span class="line">mysql&gt; grant insert,update,delete to <span class="string">&#x27;update_role&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="新建用户跟-5-版本有区别"><a href="#新建用户跟-5-版本有区别" class="headerlink" title="新建用户跟 5 版本有区别:"></a>新建用户跟 5 版本有区别:</h3><pre><code>下面这种语法不再支持
grant 权限 on db.* to &#39;user&#39;@&#39;%&#39; identified by &#39;password&#39;; 
创建用户
create user username identified by &#39;password&#39; [default role &#39;xxx&#39;];
如果没有指定默认角色。当前用户默认角色为NONE,则不具有任何权限。即使你授权了某个role 。
</code></pre><p>使用角色的授权方法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create role dba;</span><br><span class="line">mysql&gt; grant all on *.* to <span class="string">&#x27;dba&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">mysql&gt; create user abc identified by <span class="string">&#x27;sdxdsq23L&#x27;</span> defualt role dba;</span><br><span class="line">mysql&gt; -- [ 以上语句等价 5 版本时 grant all on *.* to <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;sdxdsq23L&#x27;</span>;]</span><br><span class="line">mysql&gt; -- 使用用户授权的方法</span><br><span class="line">mysql&gt; create user abc identified by <span class="string">&#x27;sdxdsq23L&#x27;</span>;</span><br><span class="line">mysql&gt; grant all on *.* to to <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span> </span><br></pre></td></tr></table></figure></p>
<p> 假如我们没有设定defualt role 。将会发生什么情况<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> mysql&gt; create user <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified by <span class="string">&#x27;sdxdsq23L&#x27;</span>;</span><br><span class="line"> grant dba to <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"> mysql&gt; show grants <span class="keyword">for</span> abc;</span><br><span class="line">+------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> sheen@%                 |</span><br><span class="line">+------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO `abc`@`%` |</span><br><span class="line">| GRANT `dba`@`%` TO `abc`@`%`    |</span><br><span class="line">+------------------------------------+</span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> <span class="string">&#x27;dba&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> dba@%                                                                                                                                                                                                                                                                                                                                                                                                                                                    |</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `dba`@`%`                                                                                       |</span><br><span class="line">| GRANT APPLICATION_PASSWORD_ADMIN,AUDIT_ADMIN,BACKUP_ADMIN,BINLOG_ADMIN,BINLOG_ENCRYPTION_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,GROUP_REPLICATION_ADMIN,INNODB_REDO_LOG_ARCHIVE,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SERVICE_CONNECTION_ADMIN,SESSION_VARIABLES_ADMIN,SET_USER_ID,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN,TABLE_ENCRYPTION_ADMIN,XA_RECOVER_ADMIN ON *.* TO `dba`@`%` |</span><br><span class="line">+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; use sheen</span><br><span class="line">ERROR 1044 (42000): Access denied <span class="keyword">for</span> user <span class="string">&#x27;abc&#x27;</span>@<span class="string">&#x27;%&#x27;</span> to database <span class="string">&#x27;sheen&#x27;</span></span><br></pre></td></tr></table></figure><br>由上面可以看出我们已经授权dba 角色。dba 角色具有访问所有库的权限。但是还是连不了 sheen 这个库。<br>继续往下看<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select current_role(); <span class="comment">#查看当前会话使用的角色</span></span><br><span class="line">+----------------+</span><br><span class="line">| current_role() |</span><br><span class="line">+----------------+</span><br><span class="line">| NONE           |</span><br><span class="line">+----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><br>是因为当前用户连接没有使用任何角色的原因</p>
<p>为当前会话设置使用角色（所设角色名必须是有授权给当前连接用户的角色）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> role dba;</span><br><span class="line">mysql&gt; select current_role(); </span><br><span class="line">+----------------+</span><br><span class="line">| current_role() |</span><br><span class="line">+----------------+</span><br><span class="line">| `dba`@`%`      |</span><br><span class="line">+----------------+</span><br><span class="line">mysql&gt; use sheen;</span><br><span class="line">Database changed</span><br></pre></td></tr></table></figure></p>
<h4 id="新参数-mandatory-roles-强制定义角色参数。使用该参数，则实例下所有用户都会被授权-mandatory-roles-指定角色。而不需要再重新授权"><a href="#新参数-mandatory-roles-强制定义角色参数。使用该参数，则实例下所有用户都会被授权-mandatory-roles-指定角色。而不需要再重新授权" class="headerlink" title="新参数 mandatory_roles 强制定义角色参数。使用该参数，则实例下所有用户都会被授权 mandatory_roles 指定角色。而不需要再重新授权"></a>新参数 mandatory_roles 强制定义角色参数。使用该参数，则实例下所有用户都会被授权 mandatory_roles 指定角色。而不需要再重新授权</h4><pre><code>可用于my.cnf [mysqld] 下面。
[mysqld]
 mandatory_roles=&#39;role1,role2@localhost,r3@%.example.com&#39;
也可以在数据库启动后。动态持久化定义
SET PERSIST mandatory_roles = &#39;role1,role2@localhost,r3@%.example.com&#39;;
使用GLOBAL 时 该参数只适合当前实例。重启不保存设置结果
SET GLOBAL mandatory_roles = &#39;role1,role2@localhost,r3@%.example.com&#39;;

可以将某个授权用户转授权给新用户
grant select ,update ,delete ,insert on db.* to &#39;u1&#39;;
grant u1 to u2;
(这个操作适用于新老用户替换的情况。比如老的维护人员离开。新的维护人员到来。要让新用户人员具有老用户的权限时。可以有以下2种操作方式
  第一种.改老用户的密码。然后将老用户给新用户用  
      ALTER USER &#39;old_app_dev&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;new_password&#39;;
  第二种.将老账户视为角色，锁定老用户，将老用户作为一个角色授权给新的需要的新账户
      ALTER USER &#39;old_app_dev&#39;@&#39;localhost&#39; ACCOUNT LOCK;
      CREATE USER &#39;new_app_dev1&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;new_password&#39;;
      GRANT &#39;old_app_dev&#39;@&#39;localhost&#39; TO &#39;new_app_dev1&#39;@&#39;localhost&#39;;
 )     
角色的出现,使新版mysql 的权限控制更加灵活    

注意:
具有 SUPER 权限 的用户。可以修改数据 即便 数据库设置了read_only=on;可以在数据库连接达到max_connection后依然可以登录连接数据库。(5版本super 用户与普通用户共用max_connection数)

4个预留用户
&#39;root&#39;@&#39;localhost：用于管理目的。该帐户具有所有特权，是系统帐户，并且可以执行任何操作
&#39;mysql.sys&#39;@&#39;localhost&#39;：作为 DEFINER对 sys架构对象。使用该 mysql.sys帐户可以避免在DBA重命名或删除该root 帐户时发生的问题。此帐户已锁定，因此不能用于客户端连接
&#39;mysql.session&#39;@&#39;localhost&#39;：由插件内部使用以访问服务器。此帐户已锁定，因此不能用于客户端连接。该帐户是系统帐户
&#39;mysql.infoschema&#39;@&#39;localhost&#39;：作为information_schema 视图的definer。使用该mysql.infoschema帐户可以避免在DBA重命名或删除root帐户时发生的问题。此帐户已锁定，因此不能用于客户端连接
</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/17/xtradbClusterInstall/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/17/xtradbClusterInstall/" class="post-title-link" itemprop="url">Percona xtradb Cluster 5.7 安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-17 09:37:06 / 修改时间：10:01:37" itemprop="dateCreated datePublished" datetime="2022-10-17T09:37:06+08:00">2022-10-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h3><p>oracle vbox : centos 7  xtradb cluster 5.7 </p>
<h3 id="1-修改主机节点名称"><a href="#1-修改主机节点名称" class="headerlink" title="1.修改主机节点名称"></a>1.修改主机节点名称</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">192.168.56.6</span><br><span class="line"><span class="comment"># hostnamectl --static set-hostname pxcnode1</span></span><br><span class="line">192.168.56.7</span><br><span class="line"><span class="comment"># hostnamectl --static set-hostname pxcnode2</span></span><br><span class="line">192.168.56.8</span><br><span class="line"><span class="comment"># hostnamectl --static set-hostname pxcnode3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span></span><br><span class="line">&gt; 192.168.56.6  pxcnode1</span><br><span class="line">&gt; 192.168.56.7  pxcnode2</span><br><span class="line">&gt; 192.168.56.8  pxcnode3</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h3 id="2-关闭防火墙"><a href="#2-关闭防火墙" class="headerlink" title="2.关闭防火墙"></a>2.关闭防火墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl stop firewalld</span></span><br><span class="line"><span class="comment"># systemctl disable firewalld</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># iptables -F</span></span><br></pre></td></tr></table></figure>
<h3 id="3-关闭selinux"><a href="#3-关闭selinux" class="headerlink" title="3.关闭selinux"></a>3.关闭selinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span></span><br><span class="line"><span class="comment"># setenforce 0</span></span><br><span class="line"><span class="comment"># getenforce</span></span><br></pre></td></tr></table></figure>
<h3 id="4-修改内核参数"><a href="#4-修改内核参数" class="headerlink" title="4.修改内核参数"></a>4.修改内核参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; /etc/security/limits.conf &lt;&lt;EOF</span></span><br><span class="line">&gt; mysql  soft   <span class="built_in">nproc</span>     2047 </span><br><span class="line">&gt; mysql  hard   <span class="built_in">nproc</span>     16384</span><br><span class="line">&gt; mysql  soft   nofile    1024</span><br><span class="line">&gt; mysql  hard   nofile    65536</span><br><span class="line">&gt; mysql  soft   stack     10240</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h3 id="5-修改登陆用户"><a href="#5-修改登陆用户" class="headerlink" title="5.修改登陆用户"></a>5.修改登陆用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat &gt;&gt; /etc/profile &lt;&lt;EOF</span></span><br><span class="line">&gt; <span class="keyword">if</span> [ <span class="variable">$USER</span> = <span class="string">&quot;mysql&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">&gt;     <span class="keyword">if</span> [ <span class="variable">$SHELL</span> = <span class="string">&quot;/bin/ksh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">&gt;         <span class="built_in">ulimit</span> -p 16384</span><br><span class="line">&gt;         <span class="built_in">ulimit</span> -n 65536</span><br><span class="line">&gt;     <span class="keyword">else</span></span><br><span class="line">&gt;         <span class="built_in">ulimit</span> -u 16384 -n 65536</span><br><span class="line">&gt;     <span class="keyword">fi</span></span><br><span class="line">&gt;     <span class="built_in">umask</span> 022</span><br><span class="line">&gt; <span class="keyword">fi</span></span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<h3 id="6-安装相关依赖包"><a href="#6-安装相关依赖包" class="headerlink" title="6.安装相关依赖包"></a>6.安装相关依赖包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y perl-DBD-MySQL perl-Digest-MD5 perl-Env perl-Test* openssl openssl-devel</span></span><br></pre></td></tr></table></figure>
<h3 id="7-查看并卸载-mariadb"><a href="#7-查看并卸载-mariadb" class="headerlink" title="7.查看并卸载 mariadb"></a>7.查看并卸载 mariadb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -qa |grep mariadb</span></span><br><span class="line"><span class="comment"># mariadb-libs-5.5.68-1.el7.x86_64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rpm -e mariadb-libs-5.5.68-1.el7.x86_64 --nodeps</span></span><br></pre></td></tr></table></figure>
<h3 id="8-安装percona-repo-源-相关版本包"><a href="#8-安装percona-repo-源-相关版本包" class="headerlink" title="8.安装percona repo 源 相关版本包"></a>8.安装percona repo 源 相关版本包</h3><p>在网站上下载安装包安装的话，依赖太多。直接下载repo 源安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yum install -y Percona-XtraDB-Cluster-57</span></span><br></pre></td></tr></table></figure></p>
<h3 id="9-安装完后会发现每个节点都已经启动了一个实例，将实例停止"><a href="#9-安装完后会发现每个节点都已经启动了一个实例，将实例停止" class="headerlink" title="9.安装完后会发现每个节点都已经启动了一个实例，将实例停止"></a>9.安装完后会发现每个节点都已经启动了一个实例，将实例停止</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps -ef |grep mysql</span></span><br><span class="line"><span class="comment"># systemctl stop mysql</span></span><br><span class="line"></span><br><span class="line">删除实例产生的文件 </span><br><span class="line"><span class="comment"># rm -rf /var/lib/mysql</span></span><br></pre></td></tr></table></figure>
<h3 id="10-创建目录"><a href="#10-创建目录" class="headerlink" title="10. 创建目录"></a>10. 创建目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir -p /data/mysql/&#123;data,redo,undo,log,run&#125;</span></span><br><span class="line"><span class="comment"># cd /data</span></span><br><span class="line"><span class="comment"># chown -R mysql.mysql /data/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cd /data/mysql/</span></span><br><span class="line"><span class="comment"># chmod 700 </span></span><br></pre></td></tr></table></figure>
<h3 id="11-修改-etc-my-cnf"><a href="#11-修改-etc-my-cnf" class="headerlink" title="11.修改 /etc/my.cnf"></a>11.修改 /etc/my.cnf</h3><h4 id="1-可以在这2个目录中分别配置mysql-参数以及-xtradb-cluster-参数"><a href="#1-可以在这2个目录中分别配置mysql-参数以及-xtradb-cluster-参数" class="headerlink" title="1) 可以在这2个目录中分别配置mysql 参数以及 xtradb-cluster 参数"></a>1) 可以在这2个目录中分别配置mysql 参数以及 xtradb-cluster 参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!includedir /etc/my.cnf.d/</span></span><br><span class="line"><span class="comment">#!includedir /etc/percona-xtradb-cluster.conf.d/</span></span><br></pre></td></tr></table></figure>
<h4 id="2）为测试方便。这里注释掉这2个。直接把所有参数写到一个文件里"><a href="#2）为测试方便。这里注释掉这2个。直接把所有参数写到一个文件里" class="headerlink" title="2）为测试方便。这里注释掉这2个。直接把所有参数写到一个文件里"></a>2）为测试方便。这里注释掉这2个。直接把所有参数写到一个文件里</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The Percona XtraDB Cluster 5.7 configuration file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># * IMPORTANT: Additional settings that can override those from this file!</span></span><br><span class="line"><span class="comment">#   The files must end with &#x27;.cnf&#x27;, otherwise they&#x27;ll be ignored.</span></span><br><span class="line"><span class="comment">#   Please make any edits and changes to the appropriate sectional files</span></span><br><span class="line"><span class="comment">#   included below.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#!includedir /etc/my.cnf.d/</span></span><br><span class="line"><span class="comment">#!includedir /etc/percona-xtradb-cluster.conf.d/</span></span><br><span class="line">[client]</span><br><span class="line">socket=/data/mysql/run/mysql.sock</span><br><span class="line">[mysqld_safe]</span><br><span class="line">pid-file = /data/mysql/run/mysql.pid</span><br><span class="line">socket   = /data/mysql/run/mysql.sock</span><br><span class="line"><span class="built_in">nice</span>     = 0</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#skip-grant-tables</span></span><br><span class="line"><span class="comment">#skip-name-resolve = 1</span></span><br><span class="line">user = mysql</span><br><span class="line">port = 3306</span><br><span class="line">server-id = 6</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line">basedir = /usr</span><br><span class="line">datadir = /data/mysql/data</span><br><span class="line">socket = /data/mysql/run/mysql.sock</span><br><span class="line">pid-file = /data/mysql/run/mysql.pid</span><br><span class="line">max_connections = 300</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">wait_timeout = 10800</span><br><span class="line">interactive_timeout = 10800</span><br><span class="line">log_timestamps = SYSTEM</span><br><span class="line">log-error = /data/mysql/log/error.log</span><br><span class="line"><span class="comment">#log_warnings = 2</span></span><br><span class="line">log_error_verbosity = 2</span><br><span class="line"><span class="comment">#slow_query_log = on</span></span><br><span class="line">slow_query_log_file = /data/mysql/log/mysql-slow.log</span><br><span class="line"><span class="comment">#long_query_time = 3</span></span><br><span class="line"><span class="comment">#log_queries_not_using_indexes = on</span></span><br><span class="line"><span class="comment">#general_log = on</span></span><br><span class="line">general_log_file = /data/mysql/log/mysql-general.log</span><br><span class="line">innodb_flush_log_at_trx_commit = 2</span><br><span class="line">innodb_log_buffer_size = 16777216</span><br><span class="line">innodb_log_file_size = 256M</span><br><span class="line">innodb_log_files_in_group = 3</span><br><span class="line">innodb_buffer_pool_size = 512M</span><br><span class="line">innodb_log_group_home_dir = /data/mysql/redo</span><br><span class="line">innodb_undo_directory = /data/mysql/undo</span><br><span class="line">innodb_undo_tablespaces = 2</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_write_io_threads = 8</span><br><span class="line">innodb_read_io_threads = 8</span><br><span class="line">innodb_page_cleaners = 16</span><br><span class="line">innodb_io_capacity = 300</span><br><span class="line">query_cache_type = off</span><br><span class="line">query_cache_size = 0</span><br><span class="line">max_heap_table_size = 64M</span><br><span class="line">tmp_table_size = 64M</span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line">thread_cache_size = 50</span><br><span class="line">open_files_limit = 65535</span><br><span class="line">table_definition_cache = 4096</span><br><span class="line">table_open_cache = 5000</span><br><span class="line">secure_file_priv = /data/mysql/data/</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line"><span class="comment">###Percona Xtradb Cluster Wsrep Configure</span></span><br><span class="line">binlog_format = ROW</span><br><span class="line">default_storage_engine = INNODB</span><br><span class="line">innodb_autoinc_lock_mode = 2</span><br><span class="line"><span class="comment">#innodb_locks_unsafe_for_binlog = 1</span></span><br><span class="line">wsrep_retry_autocommit = 1</span><br><span class="line">wsrep_auto_increment_control = 1</span><br><span class="line">wsrep_provider = /usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_provider_options = <span class="string">&quot;gcache.page_size=64M;gcache.size=1G;gcs.fc_limit=512;gcs.fc_factor=0.9;evs.send_window=256;evs.user_send_window=128&quot;</span></span><br><span class="line">wsrep_cluster_name = <span class="string">&quot;mysql_galera_cluster&quot;</span></span><br><span class="line"><span class="comment">#wsrep_cluster_address = gcomm://</span></span><br><span class="line">wsrep_cluster_address = <span class="string">&quot;gcomm://192.168.56.6,192.168.56.7,192.168.56.8&quot;</span></span><br><span class="line">wsrep_node_name = pxc-cluster1</span><br><span class="line">wsrep_node_address = 192.168.56.6</span><br><span class="line">pxc_strict_mode = PERMISSIVE</span><br><span class="line"><span class="comment">#wsrep_sst_method = rsync</span></span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line">wsrep_slave_threads=8</span><br><span class="line">wsrep_sst_auth=<span class="string">&quot;sstuser:passw0rd&quot;</span></span><br></pre></td></tr></table></figure>
<p>  注意wsrep_sst_auth 为 配置sst 的用户名以及密码</p>
<h3 id="12-启动第一个节点"><a href="#12-启动第一个节点" class="headerlink" title="12.启动第一个节点"></a>12.启动第一个节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysql@bootstrap</span></span><br><span class="line"></span><br><span class="line">启动成功后登陆数据库重新设置root 密码（初始化密码在err 文件里面）以及 sst 用户账号密码</span><br><span class="line"><span class="comment"># mysql -uroot -p -S /data/mysql/run/mysql.sock</span></span><br><span class="line"></span><br><span class="line">mysql &gt; alter user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;sheen$123&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">mysql &gt; GRANT PROCESS,RELOAD,LOCK TABLES,REPLICATION CLIENT ON *.* TO <span class="string">&#x27;sstuser&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;passw0rd&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql &gt; flush privileges;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="13-将配置文件发送到其他2个节点。并修改相关设置"><a href="#13-将配置文件发送到其他2个节点。并修改相关设置" class="headerlink" title="13.将配置文件发送到其他2个节点。并修改相关设置"></a>13.将配置文件发送到其他2个节点。并修改相关设置</h3><p>  server-id = {7,8}<br>  wsrep_node_name = {pxc-cluster2,pxc-cluster3}<br>  wsrep_node_address = {192.168.56.7,192.168.56.8}</p>
<h3 id="14-在192-168-56-7-启动第二个节点"><a href="#14-在192-168-56-7-启动第二个节点" class="headerlink" title="14.在192.168.56.7 启动第二个节点"></a>14.在192.168.56.7 启动第二个节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysql   (注意集群只有第一个节点启动需要  @bootstrap)</span></span><br></pre></td></tr></table></figure>
<p>观察err.log 看是否正常启动</p>
<h3 id="15-在192-168-56-8-启动第三个节点"><a href="#15-在192-168-56-8-启动第三个节点" class="headerlink" title="15.在192.168.56.8 启动第三个节点"></a>15.在192.168.56.8 启动第三个节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl start mysql   (注意集群只有第一个节点启动需要  @bootstrap)</span></span><br></pre></td></tr></table></figure>
<h3 id="16-集群验证"><a href="#16-集群验证" class="headerlink" title="16.集群验证"></a>16.集群验证</h3><h4 id="1）-完整性验证"><a href="#1）-完整性验证" class="headerlink" title="1） 完整性验证"></a>1） 完整性验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show global status <span class="built_in">where</span> variable_name <span class="keyword">in</span></span><br><span class="line">(<span class="string">&#x27;wsrep_cluster_state_uuid&#x27;</span>,<span class="string">&#x27;wsrep_cluster_conf_id&#x27;</span>,<span class="string">&#x27;wsrep_cluster_size&#x27;</span>,<span class="string">&#x27;wsrep_cluster_status&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>注意：正常情况下以下指标值，在所有节点应该都是一致的</p>
<p>wsrep_cluster_state_uuid：在集群所有节点中该值应该是相同的，若有不同值，说明该节点没有连入集群</p>
<p>wsrep_cluster_conf_id：在集群所有节点中该值应该是相同的，若有不同值，说明该节点被临时”分区”了，当节点之间网络连接恢复后，该值应该恢复成一致</p>
<p>wsrep_cluster_size：如果与集群中的节点数一致，说明所有节点已经连接</p>
<p>wsrep_cluster_status：集群状态，若不为”Primary”，说明出现”分区”或是”split-brain”状况</p>
<h4 id="2）-节点状态检查"><a href="#2）-节点状态检查" class="headerlink" title="2） 节点状态检查"></a>2） 节点状态检查</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show global status <span class="built_in">where</span> variable_name <span class="keyword">in</span></span><br><span class="line">(<span class="string">&#x27;wsrep_ready&#x27;</span>,<span class="string">&#x27;wsrep_connected&#x27;</span>,<span class="string">&#x27;wsrep_local_state_comment&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>wsrep_ready：该值为ON，则说明可以接受SQL负载；如果为OFF，则需要检查wsrep_connected</p>
<p>wsrep_connected：如果该值为OFF，且wsrep_ready的值也为OFF，则说明该节点没有连入集群</p>
<p>(可能是wsrep_cluster_address或wsrep_cluster_name等配置错误造成的，具体需要排查错误日志)</p>
<p>wsrep_local_state_comment：若wsrep_connected为ON，但wsrep_ready为OFF，则可以从该项查看原因</p>
<h4 id="3）-集群健康度检查"><a href="#3）-集群健康度检查" class="headerlink" title="3） 集群健康度检查"></a>3） 集群健康度检查</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show global status <span class="built_in">where</span> variable_name <span class="keyword">in</span></span><br><span class="line">(<span class="string">&#x27;wsrep_flow_control_paused&#x27;</span>,<span class="string">&#x27;wsrep_cert_deps_distance&#x27;</span>,<span class="string">&#x27;wsrep_flow_control_sent&#x27;</span>,<span class="string">&#x27;wsrep_local_recv_queue_avg&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>wsrep_flow_control_paused：表示复制停止了多长时间</p>
<p>（即因Slave延迟而慢的程度，取值范围为0~1，越靠近0越好，值为1表示复制完全停止（停止广播），可优化wsrep_slave_threads的值来改善）</p>
<p>wsrep_cert_deps_distance：表示有多少事务可以并行应用处理，wsrep_slave_threads设置的值不应该高出该值太多</p>
<p>wsrep_flow_control_sent：表示该节点已经停止复制了多少次</p>
<p>wsrep_local_recv_queue_avg：表示slave事务队列的平均长度，slave瓶颈的预兆</p>
<h3 id="16-错误排查"><a href="#16-错误排查" class="headerlink" title="16.错误排查"></a>16.错误排查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">在启动第二节点时，报错无法启动。看第一个节点日志报如下错误</span><br><span class="line">2022/08/29 09:37:21 socat[25648] E write(6, 0x564dea85bda0, 161): No route to host</span><br><span class="line">2022/08/29 09:37:22 socat[25652] E write(6, 0x56309d047da0, 161): No route to host</span><br><span class="line">2022/08/29 09:37:23 socat[25656] E write(6, 0x55d9b229fda0, 161): No route to host</span><br><span class="line">2022/08/29 09:37:24 socat[25660] E write(6, 0x55a3732bfda0, 161): No route to host</span><br><span class="line">2022/08/29 09:37:25 socat[25663] E write(6, 0x5598aa784da0, 161): No route to host</span><br><span class="line">        2022-08-29T09:37:26.737381+08:00 WSREP_SST: [ERROR] ******************* FATAL ERROR **********************</span><br><span class="line">        2022-08-29T09:37:26.738401+08:00 WSREP_SST: [ERROR] Error <span class="keyword">while</span> sending data to joiner node:  <span class="built_in">exit</span> codes: 0 1</span><br><span class="line">        2022-08-29T09:37:26.740138+08:00 WSREP_SST: [ERROR] ******************************************************</span><br><span class="line">        2022-08-29T09:37:26.741128+08:00 WSREP_SST: [ERROR] Cleanup after <span class="built_in">exit</span> with status:32</span><br><span class="line">2022-08-29T09:37:26.749151+08:00 0 [ERROR] WSREP: Process completed with error: wsrep_sst_xtrabackup-v2 --role <span class="string">&#x27;donor&#x27;</span> --address <span class="string">&#x27;192.168.56.7:4444/xtrabackup_sst//1&#x27;</span> --socket <span class="string">&#x27;/data/  mysql/run/mysql.sock&#x27;</span> --datadir <span class="string">&#x27;/data/mysql/data/&#x27;</span> --defaults-file <span class="string">&#x27;/etc/my.cnf&#x27;</span> --defaults-group-suffix <span class="string">&#x27;&#x27;</span> --mysqld-version <span class="string">&#x27;5.7.38-41-57&#x27;</span>   <span class="string">&#x27;&#x27;</span> --gtid   <span class="string">&#x27;fd5bdb71-2513-11ed-8942-0f1687c72112:4&#x27;</span> : 32 (Broken pipe)</span><br><span class="line">2022-08-29T09:37:26.749194+08:00 0 [ERROR] WSREP: Command did not run: wsrep_sst_xtrabackup-v2 --role <span class="string">&#x27;donor&#x27;</span> --address <span class="string">&#x27;192.168.56.7:4444/xtrabackup_sst//1&#x27;</span> --socket <span class="string">&#x27;/data/mysql/  run/mysql.sock&#x27;</span> --datadir <span class="string">&#x27;/data/mysql/data/&#x27;</span> --defaults-file <span class="string">&#x27;/etc/my.cnf&#x27;</span> --defaults-group-suffix <span class="string">&#x27;&#x27;</span> --mysqld-version <span class="string">&#x27;5.7.38-41-57&#x27;</span>   <span class="string">&#x27;&#x27;</span> --gtid   <span class="string">&#x27;fd5bdb71-2513-11ed-8942-0f1687c72112:4&#x27;</span></span><br><span class="line">2022-08-29T09:37:26.750072+08:00 0 [Warning] WSREP: 1.0 (pxc-cluster1): State transfer to 0.0 (pxc-cluster2) failed: -32 (Broken pipe)</span><br></pre></td></tr></table></figure>
<p>出现这个错误是防火墙的问题。 执行 iptables -F 清除防火墙规则</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/14/postgisInstall/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/14/postgisInstall/" class="post-title-link" itemprop="url">postgis 插件安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-14 15:37:14" itemprop="dateCreated datePublished" datetime="2022-10-14T15:37:14+08:00">2022-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-17 15:19:11" itemprop="dateModified" datetime="2022-10-17T15:19:11+08:00">2022-10-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="安装简介"><a href="#安装简介" class="headerlink" title="安装简介"></a>安装简介</h3><p>安装postgresql(已有跳过)—-&gt;安装postgis所需要的依赖—-&gt;安装postgis—-&gt;进入postgresql数据库—-&gt;指定数据库添加扩展<br>postgresql是基础软件，因此是必须第一个安装的，而postgis的依赖可分为两个部分，一部分是必须的库，包含 geos库，gdal库，<br>proj库，json-c库，libXML2库，这五个库如果正确安装了，那么就已经可以编译安装postgis并在pg数据中创建扩展了，但是需要<br>说明的是，此时的postgis并不支持3d数据的分析，存储，计算等工作，仅仅支持2d的地理信息。如果需要支持3d 则需要再安装四个<br>库，这四个库分别是protobuf，protobuf-c，cgal，sfcgal，这四个库均依赖于boost 库,在选择版本上要以boost 库版本为基准。<br>下面来开始安装，以全新的环境未安装postgresql 数据库做示例,所有软件包均放在 /data 目录下</p>
<h3 id="本文安装环境"><a href="#本文安装环境" class="headerlink" title="本文安装环境"></a>本文安装环境</h3><p>centos 7 3.10.0-1160.71.1.el7.x86_64</p>
<h3 id="postgis-安装的前置要求"><a href="#postgis-安装的前置要求" class="headerlink" title="postgis 安装的前置要求:"></a>postgis 安装的前置要求:</h3><ol>
<li>PostgreSQL 9.6 - 15</li>
<li>GNU C compiler (gcc)  gcc gcc-c++ 编译器</li>
<li>make 工具</li>
<li>proj  版本要求 &gt;= 4.9  找相应版本（本文用的是 proj.7.1.0） used to provide coordinate reprojection support within PostGIS     <a target="_blank" rel="noopener" href="https://proj.org/">https://proj.org/</a> </li>
<li>GEOS  版本要求 &gt;= 3.6 geos 3.9 支持所有特性 （本文用的是 geos-3.8.3)  <a target="_blank" rel="noopener" href="http://trac.osgeo.org/geos/">http://trac.osgeo.org/geos/</a> </li>
<li>libXML2 版本要求 &gt;= 2.5 (本文用的是libxml2-2.9.1) 当前用于一些 imports 函数 (ST_GeomFromGML and ST_GeomFromKML)</li>
<li>json-c  版本要求 &gt;=0.9 (本文用的是json-c-json-c-0.13.1-20180305) 用于 ST_GeomFromGeoJson 函数  <a target="_blank" rel="noopener" href="https://github.com/json-c/json-c/releases/">https://github.com/json-c/json-c/releases/</a></li>
<li>gdal 版本要求 2+ ，3+ 更好 (本文用的是 gdal-3.5.2) raster支持  <a target="_blank" rel="noopener" href="http://trac.osgeo.org/gdal/wiki/DownloadSource">http://trac.osgeo.org/gdal/wiki/DownloadSource</a></li>
</ol>
<h3 id="可选项"><a href="#可选项" class="headerlink" title="可选项"></a>可选项</h3><ol>
<li>dgal</li>
<li>gtk</li>
<li>sfcgal （支持3D坐标必备）</li>
<li>protobuf-c  ST_AsMVT可用</li>
<li>CUnit</li>
<li>DBLatex</li>
<li>ImageMagick </li>
</ol>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>boost , libxml2 都通过yum 安装 降低难度，gcc gcc-c++ 也通过yum 安装。自己安装更高的版本后续编译也会带来很多问题。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install -y lrzsz wget perl-ExtUtils-Embed \</span></span><br><span class="line">    readline-devel zlib-devel pam-devel \</span><br><span class="line">    libxml2-devel libxslt-devel openldap-devel \</span><br><span class="line">    python-devel gcc-c++ openssl-devel cmake libtool \</span><br><span class="line">    gcc libffi-devel mpfr-devel gmp-devel boost-devel</span><br></pre></td></tr></table></figure>
<p>安装完通过rpm -qa |grep xxx 可以看到<br>libxml2-2.9.1-6.el7_9.6.x86_64<br>gcc-c++-4.8.5-44.el7.x86_64<br>gcc-4.8.5-44.el7.x86_64<br>boost-1.53.0-28.el7.x86_64 （ pg_routing 版本3+ 要求 boost-1.56+ 我们选择 pgrouting-2.6.3.tar.gz ）</p>
<h3 id="编译安装-postgresql"><a href="#编译安装-postgresql" class="headerlink" title="编译安装 postgresql"></a>编译安装 postgresql</h3><p>数据库使用postgresql-14.5 编译安装完成后到/usr/local 目录下创建软链 并将目录授权postgres 用户<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /data</span></span><br><span class="line"><span class="comment"># tar -xzvf postgresql-14.5.tar.gz</span></span><br><span class="line"><span class="comment"># mv postgresql-14.5 postgresql-14.5_pkg</span></span><br><span class="line"><span class="comment"># cd postgresql-14.5_pkg</span></span><br><span class="line"><span class="comment"># CFLAGS=&quot;-O2 -march=native -mtune=native -pipe -fomit-frame-pointer&quot; \</span></span><br><span class="line">        CXXFLAGS=<span class="string">&quot;-O2 -march=native -mtune=native -pipe -fomit-frame-pointer&quot;</span> \</span><br><span class="line">        ./configure \</span><br><span class="line">        --prefix=/data/postgresql-14.5  \</span><br><span class="line">        --enable-nls \</span><br><span class="line">        --enable-thread-safety \</span><br><span class="line">        --with-libxml \</span><br><span class="line">        --with-libxslt \</span><br><span class="line">        --with-ldap=no \</span><br><span class="line">        --with-perl  \</span><br><span class="line">        --with-python \</span><br><span class="line">        --with-pam</span><br><span class="line"><span class="comment"># make &amp;&amp; make install-world</span></span><br><span class="line"><span class="comment"># cd /usr/local</span></span><br><span class="line"><span class="comment"># ln -s /data/postgresql-14.5 psql</span></span><br><span class="line"><span class="comment"># chown -R postgres.postgres  /data/postgresql-14.5</span></span><br></pre></td></tr></table></figure></p>
<h3 id="安装proj"><a href="#安装proj" class="headerlink" title="安装proj"></a>安装proj</h3><p>安装proj 之前我们先要安装2个依赖 sqlite3 以及 libtiff</p>
<p>安装sqlite3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf sqlite-autoconf-3390400.tar.gz</span></span><br><span class="line"><span class="comment"># cd sqlite-autoconf-3390400</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/sqlite3</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<p>安装libtiff<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xvf tiff-4.4.0.tar</span></span><br><span class="line"><span class="comment"># cd tiff-4.4.0</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/libtiff</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<p>安装完依赖开始安装proj<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf proj-7.1.0.tar.gz</span></span><br><span class="line"><span class="comment"># cd proj-7.1.0</span></span><br><span class="line"><span class="comment"># SQLITE3_CFLAGS=&quot;-I/usr/local/sqlite3/include&quot; SQLITE3_LIBS=&quot;-L/usr/local/sqlite3/lib -lsqlite3&quot; TIFF_CFLAGS=&quot;-I/usr/local/libtiff/include&quot; TIFF_LIBS=&quot;-L/usr/local/libtiff/lib -ltiff&quot; ./configure --prefix=/usr/local/proj --without-curl</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<h3 id="安装geos"><a href="#安装geos" class="headerlink" title="安装geos"></a>安装geos</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xvf geos-3.8.3.tar</span></span><br><span class="line"><span class="comment"># cd geos-3.8.3</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/geos</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-gdal-依赖-sqlite3-跟-proj"><a href="#安装-gdal-依赖-sqlite3-跟-proj" class="headerlink" title="安装 gdal (依赖 sqlite3 跟 proj )"></a>安装 gdal (依赖 sqlite3 跟 proj )</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf gdal-3.5.2.tar.gz</span></span><br><span class="line"><span class="comment"># gdal-3.5.2</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/gdal --with-sqlite3=/usr/local/sqlite3 --with-proj=/usr/local/proj </span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-json-c"><a href="#安装-json-c" class="headerlink" title="安装 json-c"></a>安装 json-c</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf json-c-json-c-0.13.1-20180305.tar.gz</span></span><br><span class="line"><span class="comment"># cd json-c-json-c-0.13.1-20180305</span></span><br><span class="line"><span class="comment"># ./configure --prefix=/usr/local/jsonc</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<p>如果不需要支持3D 。以上库安装完后即可进行postgis 编译了</p>
<h3 id="安装-protobuf"><a href="#安装-protobuf" class="headerlink" title="安装 protobuf"></a>安装 protobuf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf protobuf-all-3.15.0.tar.gz</span></span><br><span class="line"><span class="comment"># cd protobuf-3.15.0</span></span><br><span class="line"><span class="comment"># ./configure  --prefix=/usr/local/protobuf</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<h3 id="安装-protobuf-c"><a href="#安装-protobuf-c" class="headerlink" title="安装 protobuf-c"></a>安装 protobuf-c</h3><p>设置环境变量，安装protobuf-c 需要识别 protobuf<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># export PROTOBUF_HOME=/usr/local/protobuf</span></span><br><span class="line"><span class="comment"># export PKG_CONFIG_PATH=/usr/local/protobuf/lib/pkgconfig</span></span><br><span class="line"><span class="comment"># tar -zxvf protobuf-c-1.3.3.tar.gz</span></span><br><span class="line"><span class="comment"># cd protobuf-c-1.3.3</span></span><br><span class="line"><span class="comment"># ./configure  --prefix=/usr/local/protobuf-c</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p>
<p>CGAL 以及SFCGAL 安装需要cmake 3+的版本</p>
<h3 id="安装cmake"><a href="#安装cmake" class="headerlink" title="安装cmake"></a>安装cmake</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf cmake-3.23.4-linux-x86_64.tar.gz</span></span><br><span class="line"><span class="comment"># ln -s /data/cmake-3.23.4-linux-x86_64 /usr/local/cmake</span></span><br></pre></td></tr></table></figure>
<h3 id="将安装的相关环境变量写入-etc-profile"><a href="#将安装的相关环境变量写入-etc-profile" class="headerlink" title="将安装的相关环境变量写入/etc/profile"></a>将安装的相关环境变量写入/etc/profile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vi /etc/profile</span></span><br><span class="line"><span class="comment"># pathmunge /usr/local/protobuf/bin after</span></span><br><span class="line"><span class="comment"># pathmunge /usr/local/protobuf-c/bin after</span></span><br><span class="line"><span class="comment"># pathmunge /usr/local/pgsql/bin after</span></span><br><span class="line"><span class="comment"># PATH=/usr/local/cmake/bin:$PATH</span></span><br><span class="line"><span class="comment"># source /etc/profile</span></span><br></pre></td></tr></table></figure>
<h3 id="编译CGAL"><a href="#编译CGAL" class="headerlink" title="编译CGAL"></a>编译CGAL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># unzip CGAL-4.14.3.zip </span></span><br><span class="line"><span class="comment"># cd CGAL-4.14.3</span></span><br><span class="line"><span class="comment"># mkdir build</span></span><br><span class="line"><span class="comment"># cd build</span></span><br><span class="line"><span class="comment"># /usr/local/cmake/bin/cmake ../   ###(注意这里不要指定路径。以免安装编译SFCGAL时发生意外)</span></span><br><span class="line"><span class="comment"># make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure>
<h3 id="编译安装-SFCGAL"><a href="#编译安装-SFCGAL" class="headerlink" title="编译安装 SFCGAL"></a>编译安装 SFCGAL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf SFCGAL-v1.3.10.tar.gz</span></span><br><span class="line"><span class="comment"># cd /data/SFCGAL-v1.3.10/</span></span><br><span class="line"><span class="comment"># mkdir build</span></span><br><span class="line"><span class="comment"># cmake -D CMAKE_INSTALL_PREFIX=/usr/local/sfcgal  ../</span></span><br></pre></td></tr></table></figure>
<h3 id="将以上安装的所有lib-列入LD-LIBARY-PATH-直接写到-etc-ld-so-conf-也可以"><a href="#将以上安装的所有lib-列入LD-LIBARY-PATH-直接写到-etc-ld-so-conf-也可以" class="headerlink" title="将以上安装的所有lib 列入LD_LIBARY_PATH (直接写到 /etc/ld.so.conf 也可以)"></a>将以上安装的所有lib 列入LD_LIBARY_PATH (直接写到 /etc/ld.so.conf 也可以)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># export LD_LIBRARY_PATH=/usr/local/pgsql/lib:/usr/local/gdal/lib:/usr/local/geos/lib:/usr/local/jsonc/lib:/usr/local/proj/lib:/usr/local/protobuf/lib:/usr/local/protobuf-c/lib:/usr/local/sfcgal/lib64:/usr/local/sqlite3/lib:/usr/local/tiff/lib:/usr/lib:/usr/lib64</span></span><br><span class="line"><span class="comment"># source /etc/profile</span></span><br></pre></td></tr></table></figure>
<h3 id="编译安装-pg-routing"><a href="#编译安装-pg-routing" class="headerlink" title="编译安装 pg_routing"></a>编译安装 pg_routing</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf pgrouting-2.6.3.tar.gz </span></span><br><span class="line"><span class="comment"># cd pgrouting-2.6.3</span></span><br><span class="line"><span class="comment"># mkdir build</span></span><br><span class="line"><span class="comment"># cmake ../</span></span><br><span class="line"><span class="comment"># make</span></span><br><span class="line"><span class="comment"># make install</span></span><br></pre></td></tr></table></figure>
<h3 id="编译安装-postgis"><a href="#编译安装-postgis" class="headerlink" title="编译安装 postgis"></a>编译安装 postgis</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar -xzvf postgis-3.2.4dev.tar.gz </span></span><br><span class="line"><span class="comment"># cd postgis-3.2.4dev/</span></span><br><span class="line"><span class="comment"># ./configure --with-pgconfig=/usr/local/pgsql/bin/pg_config \</span></span><br><span class="line">  --with-gdalconfig=/usr/local/gdal/bin/gdal-config \</span><br><span class="line">  --with-geosconfig=/usr/local/geos/bin/geos-config  \</span><br><span class="line">  --with-protobufdir=/usr/local/protobuf-c \</span><br><span class="line">  --with-jsondir=/usr/local/jsonc \</span><br><span class="line">  --with-sfcgal=/usr/local/sfcgal/bin/sfcgal-config \</span><br><span class="line">  --with-projdir=/usr/local/proj \</span><br><span class="line">  --with-xml2config=/usr/bin/xml2-config</span><br><span class="line"></span><br><span class="line"><span class="comment"># make</span></span><br><span class="line"><span class="comment"># make install</span></span><br></pre></td></tr></table></figure>
<h3 id="初始化pg数据库。我们来看看create-extension-是否成功"><a href="#初始化pg数据库。我们来看看create-extension-是否成功" class="headerlink" title="初始化pg数据库。我们来看看create extension 是否成功"></a>初始化pg数据库。我们来看看create extension 是否成功</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># su - postgres</span></span><br><span class="line">$ initdb -A md5 -E utf8 --locale=C -D /usr/local/pgsql/data_sheen -W</span><br><span class="line">$ pg_ctl -D /usr/local/pgsql/data_sheen start</span><br><span class="line">$ <span class="built_in">mkdir</span> -p /data/PG_TABLESPACE/sheen_data  <span class="comment">###(创建自定义表空间目录)</span></span><br><span class="line">$ psql</span><br><span class="line">postgres=<span class="comment"># create user sheen loginin password &#x27;xxx&#x27;;</span></span><br><span class="line">postgres=<span class="comment"># create tablespace sheen_data owner sheen location &#x27;/data/PG_TABLESPACE/sheen_data&#x27;;</span></span><br><span class="line">postgres=<span class="comment"># create database sheen with owner=sheen tablespace=sheen_data;</span></span><br><span class="line">postgres=<span class="comment"># \c sheen postgres</span></span><br><span class="line">sheen=<span class="comment"># create extension postgis;</span></span><br><span class="line">sheen=<span class="comment"># create extension postgis_raster;</span></span><br><span class="line">sheen=<span class="comment"># create extension postgis_sfcgal;</span></span><br><span class="line">sheen=<span class="comment"># CREATE EXTENSION pgrouting;</span></span><br><span class="line">sheen=<span class="comment"># \dx</span></span><br><span class="line">                                   List of installed extensions</span><br><span class="line">      Name      | Version  |   Schema   |                        Description                         </span><br><span class="line">----------------+----------+------------+------------------------------------------------------------</span><br><span class="line"> pgrouting      | 2.6.3    | public     | pgRouting Extension</span><br><span class="line"> plpgsql        | 1.0      | pg_catalog | PL/pgSQL procedural language</span><br><span class="line"> postgis        | 3.2.4dev | public     | PostGIS geometry and geography spatial types and <span class="built_in">functions</span></span><br><span class="line"> postgis_raster | 3.2.4dev | public     | PostGIS raster types and <span class="built_in">functions</span></span><br><span class="line"> postgis_sfcgal | 3.2.4dev | public     | PostGIS SFCGAL <span class="built_in">functions</span></span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure>
<h3 id="扩展安装-fuzzystrmatch-和-postgis-tiger-geocoder"><a href="#扩展安装-fuzzystrmatch-和-postgis-tiger-geocoder" class="headerlink" title="扩展安装 fuzzystrmatch 和 postgis_tiger_geocoder"></a>扩展安装 fuzzystrmatch 和 postgis_tiger_geocoder</h3><p>postgis_tiger_geocoder 依赖于 fuzzystrmatch，要启用 postgis_tiger_geocoder需先编译启用fuzzystrmatch<br>fuzzystrmatch 存放在 postgresql 安装包的contrib 里面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[postgres@localhost ~]$ <span class="built_in">cd</span> /data/postgresql-14.5_pkg/contrib/fuzzystrmatch</span><br><span class="line">[postgres@localhost fuzzystrmatch]$ make</span><br><span class="line">make -C ../../src/backend generated-headers</span><br><span class="line">make[1]: Entering directory `/data/postgresql-14.5_pkg/src/backend<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make -C catalog distprep generated-header-symlinks</span></span><br><span class="line"><span class="string">make[2]: Entering directory `/data/postgresql-14.5_pkg/src/backend/catalog&#x27;</span></span><br><span class="line">make[2]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `distprep<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">make[2]: Nothing to be done for `generated-header-symlinks&#x27;</span>.</span><br><span class="line">make[2]: Leaving directory `/data/postgresql-14.5_pkg/src/backend/catalog<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make -C utils distprep generated-header-symlinks</span></span><br><span class="line"><span class="string">make[2]: Entering directory `/data/postgresql-14.5_pkg/src/backend/utils&#x27;</span></span><br><span class="line">make[2]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `distprep<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">make[2]: Nothing to be done for `generated-header-symlinks&#x27;</span>.</span><br><span class="line">make[2]: Leaving directory `/data/postgresql-14.5_pkg/src/backend/utils<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make[1]: Leaving directory `/data/postgresql-14.5_pkg/src/backend&#x27;</span></span><br><span class="line">gcc -std=gnu99 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -march=native -mtune=native -pipe -fomit-frame-pointer -fPIC -I. -I. -I../../src/include  -D_GNU_SOURCE -I/usr/include/libxml2   -c -o dmetaphone.o dmetaphone.c</span><br><span class="line">gcc -std=gnu99 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -march=native -mtune=native -pipe -fomit-frame-pointer -fPIC -I. -I. -I../../src/include  -D_GNU_SOURCE -I/usr/include/libxml2   -c -o fuzzystrmatch.o fuzzystrmatch.c</span><br><span class="line">gcc -std=gnu99 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -O2 -march=native -mtune=native -pipe -fomit-frame-pointer -fPIC -shared -o fuzzystrmatch.so  dmetaphone.o fuzzystrmatch.o -L../../src/port -L../../src/common    -Wl,--as-needed -Wl,-rpath,<span class="string">&#x27;/data/postgresql-14.5/lib&#x27;</span>,--enable-new-dtags  </span><br><span class="line">[postgres@localhost fuzzystrmatch]$ make install</span><br><span class="line">make -C ../../src/backend generated-headers</span><br><span class="line">make[1]: Entering directory `/data/postgresql-14.5_pkg/src/backend<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make -C catalog distprep generated-header-symlinks</span></span><br><span class="line"><span class="string">make[2]: Entering directory `/data/postgresql-14.5_pkg/src/backend/catalog&#x27;</span></span><br><span class="line">make[2]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `distprep<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">make[2]: Nothing to be done for `generated-header-symlinks&#x27;</span>.</span><br><span class="line">make[2]: Leaving directory `/data/postgresql-14.5_pkg/src/backend/catalog<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make -C utils distprep generated-header-symlinks</span></span><br><span class="line"><span class="string">make[2]: Entering directory `/data/postgresql-14.5_pkg/src/backend/utils&#x27;</span></span><br><span class="line">make[2]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> `distprep<span class="string">&#x27;.</span></span><br><span class="line"><span class="string">make[2]: Nothing to be done for `generated-header-symlinks&#x27;</span>.</span><br><span class="line">make[2]: Leaving directory `/data/postgresql-14.5_pkg/src/backend/utils<span class="string">&#x27;</span></span><br><span class="line"><span class="string">make[1]: Leaving directory `/data/postgresql-14.5_pkg/src/backend&#x27;</span></span><br><span class="line">/usr/bin/mkdir -p <span class="string">&#x27;/data/postgresql-14.5/lib&#x27;</span></span><br><span class="line">/usr/bin/mkdir -p <span class="string">&#x27;/data/postgresql-14.5/share/extension&#x27;</span></span><br><span class="line">/usr/bin/mkdir -p <span class="string">&#x27;/data/postgresql-14.5/share/extension&#x27;</span></span><br><span class="line">/usr/bin/install -c -m 755  fuzzystrmatch.so <span class="string">&#x27;/data/postgresql-14.5/lib/fuzzystrmatch.so&#x27;</span></span><br><span class="line">/usr/bin/install -c -m 644 ./fuzzystrmatch.control <span class="string">&#x27;/data/postgresql-14.5/share/extension/&#x27;</span></span><br><span class="line">/usr/bin/install -c -m 644 ./fuzzystrmatch--1.1.sql ./fuzzystrmatch--1.0--1.1.sql  <span class="string">&#x27;/data/postgresql-14.5/share/extension/&#x27;</span></span><br><span class="line"></span><br><span class="line">postgres=<span class="comment"># \c sheen postgres</span></span><br><span class="line">You are now connected to database <span class="string">&quot;sheen&quot;</span> as user <span class="string">&quot;postgres&quot;</span>.</span><br><span class="line">sheen=<span class="comment"># CREATE EXTENSION fuzzystrmatch;</span></span><br><span class="line">CREATE EXTENSION</span><br><span class="line">sheen=<span class="comment"># CREATE EXTENSION postgis_tiger_geocoder;</span></span><br><span class="line">CREATE EXTENSION</span><br><span class="line">sheen=<span class="comment"># SELECT na.address, na.streetname,na.streettypeabbrev, na.zip</span></span><br><span class="line">sheen-<span class="comment"># FROM normalize_address(&#x27;1 Devonshire Place, Boston, MA 02109&#x27;) AS na;</span></span><br><span class="line"> address | streetname | streettypeabbrev |  zip  </span><br><span class="line">---------+------------+------------------+-------</span><br><span class="line">       1 | Devonshire | Pl               | 02109</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure></p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>安装postgis 是比较麻烦的过程。安装期间曾试过想要安装某些高版本的包而升级了gcc ,后面各种编译错误。调换各种安装包后。<br>到最后postgis 执行configure 通过，结果在make 就出现错误 原因还是boost 的版本问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/14/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/14/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-14 10:29:30" itemprop="dateCreated datePublished" datetime="2022-10-14T10:29:30+08:00">2022-10-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sheen</p>
  <div class="site-description" itemprop="description">数据库相关技术研究,自动化运维</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sheen</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  


    </div>
</body>
</html>
