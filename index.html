<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sheenzxx.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="数据库相关技术研究,自动化运维">
<meta property="og:type" content="website">
<meta property="og:title" content="sheen&#39;s Blog">
<meta property="og:url" content="https://sheenzxx.github.io/index.html">
<meta property="og:site_name" content="sheen&#39;s Blog">
<meta property="og:description" content="数据库相关技术研究,自动化运维">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Sheen">
<meta property="article:tag" content="Python,shell,SQL,oracle,mysql,postgresql">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://sheenzxx.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>sheen's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="sheen's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">sheen's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">随笔，技术笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/home/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/11/18/CreatePdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/18/CreatePdb/" class="post-title-link" itemprop="url">创建可插拔数据库语法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-11-18 17:48:46" itemprop="dateCreated datePublished" datetime="2022-11-18T17:48:46+08:00">2022-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-11-24 10:45:12" itemprop="dateModified" datetime="2022-11-24T10:45:12+08:00">2022-11-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/oracle/" itemprop="url" rel="index"><span itemprop="name">oracle</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h3><pre><code>1.必须连接CDB 实例,并且CDB 必须是打开并且处于读写模式
2.要创建PDB 或 应用容器，当前位置必须是处于根容器(CDB$ROOT)，并且具有 CREATE PLUGGABLE DATABASE 的系统权限
3.要创建应用种子或应用PDB ,当前位置必须是处于根容器(CDB$ROOT)，并且具有 CREATE PLUGGABLE DATABASE 的系统权限
对于通过克隆方式创建PDB 需要注意：
   - 如果源库 和要创建的PDB 位于同个CDB中，那么你必须在被克隆的PDB 以及要创建的PDB对应根容器中中具有CREATE PLUGGABLE DATABASE 的系统权限
   - 如果源库是远端的PDB 或非CDB ,则必须在目标PDB对应的根容器中，以及远端源库都同时具有CREATE PLUGGABLE DATABASE的系统权限。
</code></pre><h3 id="1-通过-pdbseed-库来创建"><a href="#1-通过-pdbseed-库来创建" class="headerlink" title="1. 通过 pdbseed 库来创建"></a>1. 通过 pdbseed 库来创建</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span>  <span class="keyword">AS</span> SEED &#125;</span><br><span class="line">ADMIN <span class="keyword">USER</span> 用户名 IDENTIFIED <span class="keyword">BY</span> 密码 [ROLES<span class="operator">=</span>(角色<span class="number">1</span>,角色<span class="number">2.</span>..)] </span><br><span class="line">[PARALLEL [并发数]]</span><br><span class="line">[<span class="keyword">DEFAULT</span> TABLESPACE 默认表空间名 [ DATAFILE 指定数据文件 ] [ 扩展管理声明 ] ]</span><br><span class="line">[STORAGE ([MAXSIZE 存储最大值 <span class="operator">|</span> UNLIMITED ] [MAX_AUDIT_SIZE 审核空间最大值 <span class="operator">|</span> UNLIMITED ] [ MAX_DIAG_SIZE DIAG最大值 <span class="operator">|</span> UNLIMITED] )<span class="operator">|</span>UNLIMITED] </span><br><span class="line">[FILE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库的路径&#x27;</span>,<span class="string">&#x27;替换的路径&#x27;</span>)<span class="operator">|</span> <span class="keyword">None</span>]</span><br><span class="line">[SERVICE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库服务名&#x27;</span>,<span class="string">&#x27;替换服务名&#x27;</span>)]</span><br><span class="line">[PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;绝对路径&#x27;</span><span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="keyword">NONE</span>]</span><br><span class="line">[TEMPFILE REUSE]</span><br><span class="line">[USER_TABLESPACE [(<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ] [SNAPSHOT <span class="keyword">COPY</span><span class="operator">|</span>NODATA] <span class="operator">|</span> [<span class="keyword">COPY</span><span class="operator">|</span>MOVE<span class="operator">|</span>NOCOPY]]</span><br><span class="line">[STANDBYS <span class="operator">=</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ]]</span><br><span class="line">[LOGGIN <span class="operator">|</span> NOLOGGIN <span class="operator">|</span> FILESYSTEM_LIKE_LOGGIN]</span><br><span class="line">[CREATE_FILE_DEST <span class="operator">=</span> <span class="keyword">NONE</span> <span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="string">&#x27;磁盘组名&#x27;</span>]</span><br><span class="line">[HOST<span class="operator">=</span><span class="string">&#x27;主机名&#x27;</span>]</span><br><span class="line">[PORT<span class="operator">=</span>端口号]</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> pluggable database sheen</span><br><span class="line">admin <span class="keyword">user</span> sheen_sys identified <span class="keyword">by</span> sheen123 roles<span class="operator">=</span>(dba)</span><br><span class="line">PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;/disk1/oracle/oradata/ORCL19/sheen/&#x27;</span></span><br><span class="line">FILE_NAME_CONVERT<span class="operator">=</span>(<span class="string">&#x27;/data/oracle/oradata/ORCL19/pdbseed&#x27;</span>,<span class="string">&#x27;/data/oracle/oradata/ORCL19/sheen&#x27;</span>); #根据种子创建pdb 要指定FILE_NAME_CONVERT 参数</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="2-通过-clone-的方式来创建"><a href="#2-通过-clone-的方式来创建" class="headerlink" title="2. 通过 clone 的方式来创建"></a>2. 通过 clone 的方式来创建</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span> <span class="keyword">AS</span> SEED &#125;</span><br><span class="line">&#123; &#123; <span class="keyword">FROM</span> &#123; 源pdb [ @ dblink ] &#125; <span class="operator">|</span> &#123; 非CDB库 @ dblink &#125; &#125; <span class="operator">|</span>  &#123; <span class="keyword">AS</span> PROXY <span class="keyword">FROM</span> src_pdb_name @ dblink &#125; &#125;</span><br><span class="line">[PARALLEL [并发数]]</span><br><span class="line">[<span class="keyword">DEFAULT</span> TABLESPACE 默认表空间名 [ DATAFILE 指定数据文件 ] [ 扩展管理声明 ] ]</span><br><span class="line">[FILE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库的路径&#x27;</span>,<span class="string">&#x27;替换的路径&#x27;</span>)<span class="operator">|</span> <span class="keyword">None</span>]</span><br><span class="line">[SERVICE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库服务名&#x27;</span>,<span class="string">&#x27;替换服务名&#x27;</span>)]</span><br><span class="line">[PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;绝对路径&#x27;</span><span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="keyword">NONE</span>]</span><br><span class="line">[TEMPFILE REUSE]</span><br><span class="line">[SNAPSHOT <span class="keyword">COPY</span>]</span><br><span class="line">[<span class="keyword">USING</span> SNAPSHOT &#123;快照名 <span class="operator">|</span> <span class="keyword">AT</span> SCN 快照SCN值 <span class="operator">|</span><span class="keyword">AT</span> 快照时间戳&#125;]</span><br><span class="line">[USER_TABLESPACE [(<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ] [SNAPSHOT <span class="keyword">COPY</span><span class="operator">|</span>NODATA] <span class="operator">|</span> [<span class="keyword">COPY</span><span class="operator">|</span>MOVE<span class="operator">|</span>NOCOPY]]</span><br><span class="line">[STANDBYS <span class="operator">=</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ]]</span><br><span class="line">[LOGGIN <span class="operator">|</span> NOLOGGIN <span class="operator">|</span> FILESYSTEM_LIKE_LOGGIN]</span><br><span class="line">[CREATE_FILE_DEST <span class="operator">=</span> <span class="keyword">NONE</span> <span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="string">&#x27;磁盘组名&#x27;</span>]</span><br><span class="line">[KEYSTORE IDENTIFIED <span class="keyword">BY</span> &#123;<span class="keyword">EXTERNAL</span> STORE <span class="operator">|</span> keystore 密码&#125;] [<span class="keyword">NO</span> REKEY]</span><br><span class="line">[REFRESH MODE MANUAL <span class="operator">|</span> <span class="keyword">EVERY</span> 刷新间隔 &#123;<span class="keyword">HOUR</span> <span class="operator">|</span> MINUTES&#125; <span class="operator">|</span> <span class="keyword">NONE</span>]</span><br><span class="line">[RELOCATE AVAILABLITY MAX <span class="operator">|</span>NORMAL]</span><br><span class="line">[<span class="keyword">NO</span> DATA]</span><br><span class="line">[HOST<span class="operator">=</span><span class="string">&#x27;主机名&#x27;</span>]</span><br><span class="line">[PORT<span class="operator">=</span>端口号]</span><br><span class="line"></span><br><span class="line">热克隆：</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB2_CLONE <span class="keyword">FROM</span> CDB1_PDB2</span><br><span class="line">KEYSTORE IDENTIFIED <span class="keyword">BY</span> keystore_password</span><br><span class="line"></span><br><span class="line">对于联合PDB</span><br><span class="line">密码库的密码就是ROOT 密码库的密码</span><br><span class="line">同时wallet 必须在ROOT 中打开</span><br><span class="line"></span><br><span class="line">对于独立的PDB</span><br><span class="line">密码库的密码是对应 CDB1_PDB2_CLONE 的一个新的密码</span><br><span class="line"></span><br><span class="line">克隆一个PDB:</span><br><span class="line">对于联合PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB1_C <span class="keyword">AS</span> CLONE <span class="keyword">USING</span> <span class="string">&#x27;/tmp/cdb1_pdb3.pdb&#x27;</span></span><br><span class="line">KEYSTORE IDENTIFED <span class="keyword">BY</span> keystore_password DECRYPT <span class="keyword">USING</span> transport_secret</span><br><span class="line">如果使用TDE,则wallet 必须在ROOT中打开</span><br><span class="line">如果.pdb 文件中存在 TDE keys，必须指定 KEYSTORE IDENTIFED <span class="keyword">BY</span> keystore_password DECRYPT <span class="keyword">USING</span> transport_secret 子句</span><br><span class="line">keystore_password 是ROOT的 keystore 密码</span><br><span class="line"></span><br><span class="line">对于独立PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB2_C <span class="keyword">AS</span> CLONE <span class="keyword">USING</span> <span class="string">&#x27;/tmp/cdb1_pdb2.pdb&#x27;</span></span><br><span class="line">不需要指定KEYSTORE IDENTIFED <span class="keyword">BY</span> 或者 DECRYPT <span class="keyword">USING</span> transport_secret 子句。如果指定也会被忽略</span><br><span class="line">wallet 不用在ROOT 中打开</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">通过pdbseed 创建新的PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE salespdb</span><br><span class="line">  ADMIN <span class="keyword">USER</span> salesadm IDENTIFIED <span class="keyword">BY</span> password</span><br><span class="line">  ROLES <span class="operator">=</span> (dba)</span><br><span class="line">  <span class="keyword">DEFAULT</span> TABLESPACE sales</span><br><span class="line">    DATAFILE <span class="string">&#x27;/disk1/oracle/dbs/salespdb/sales01.dbf&#x27;</span> SIZE <span class="number">250</span>M AUTOEXTEND <span class="keyword">ON</span></span><br><span class="line">  FILE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;/disk1/oracle/dbs/pdbseed/&#x27;</span>,</span><br><span class="line">                       <span class="string">&#x27;/disk1/oracle/dbs/salespdb/&#x27;</span>)</span><br><span class="line">  STORAGE (MAXSIZE <span class="number">2</span>G)</span><br><span class="line">  PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;/disk1/oracle/dbs/salespdb/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">通过已经存在的PDB创建新的PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE newpdb <span class="keyword">FROM</span> salespdb</span><br><span class="line">  FILE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;/disk1/oracle/dbs/salespdb/&#x27;</span>, <span class="string">&#x27;/disk1/oracle/dbs/newpdb/&#x27;</span>)</span><br><span class="line">  PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;/disk1/oracle/dbs/newpdb&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3-通过-XML-的方式来创建"><a href="#3-通过-XML-的方式来创建" class="headerlink" title="3. 通过 XML 的方式来创建"></a>3. 通过 XML 的方式来创建</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span>  <span class="keyword">AS</span> SEED &#125;</span><br><span class="line">[<span class="keyword">AS</span> CLONE]</span><br><span class="line"><span class="keyword">USING</span> xml文件名 </span><br><span class="line">[SOURCE_FILE_NAME_CONVERT<span class="operator">=</span>(<span class="string">&#x27;源文件名部分1&#x27;</span>,<span class="string">&#x27;替换成目标名的部分1&#x27;</span>,<span class="string">&#x27;源文件名部分2&#x27;</span>,<span class="string">&#x27;替换成目标名的部分2&#x27;</span>,...) <span class="operator">|</span> &#123;SOURCE_FILE_DIRECTORY <span class="operator">=</span> [<span class="string">&#x27;源文件路径名&#x27;</span> <span class="operator">|</span><span class="keyword">NONE</span>]&#125;]</span><br><span class="line">[ &#123; [ <span class="keyword">COPY</span> <span class="operator">|</span> MOVE ] FILE_NAME_CONVERT <span class="operator">=</span> &#123;(<span class="string">&#x27;源库的路径&#x27;</span>,<span class="string">&#x27;替换的路径&#x27;</span>)<span class="operator">|</span> <span class="keyword">None</span>&#125; &#125; <span class="operator">|</span> NOCOPY ]</span><br><span class="line">[SERVICE_NAME_CONVERT <span class="operator">=</span> (<span class="string">&#x27;源库服务名&#x27;</span>,<span class="string">&#x27;替换服务名&#x27;</span>)]</span><br><span class="line">[<span class="keyword">DEFAULT</span> TABLESPACE 默认表空间名 [ DATAFILE 指定数据文件 ] [ 扩展管理声明 ] ]</span><br><span class="line">[STORAGE ([MAXSIZE 存储最大值 <span class="operator">|</span> UNLIMITED ] [MAX_AUDIT_SIZE 审核空间最大值 <span class="operator">|</span> UNLIMITED ] [ MAX_DIAG_SIZE DIAG最大值 <span class="operator">|</span> UNLIMITED] )<span class="operator">|</span>UNLIMITED] </span><br><span class="line">[PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;绝对路径&#x27;</span><span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="keyword">NONE</span>]</span><br><span class="line">[TEMPFILE REUSE]</span><br><span class="line">[USER_TABLESPACE [(<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;表空间1&#x27;</span>,<span class="string">&#x27;表空间2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ] [SNAPSHOT <span class="keyword">COPY</span><span class="operator">|</span>NODATA] <span class="operator">|</span> [<span class="keyword">COPY</span><span class="operator">|</span>MOVE<span class="operator">|</span>NOCOPY]]</span><br><span class="line">[STANDBYS <span class="operator">=</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)<span class="operator">|</span> <span class="keyword">ALL</span> [<span class="keyword">EXCEPT</span> (<span class="string">&#x27;CDB1&#x27;</span>,<span class="string">&#x27;CDB2&#x27;</span>,...)]<span class="operator">|</span><span class="keyword">NONE</span> ]]</span><br><span class="line">[LOGGIN <span class="operator">|</span> NOLOGGIN <span class="operator">|</span> FILESYSTEM_LIKE_LOGGIN]</span><br><span class="line">[CREATE_FILE_DEST <span class="operator">=</span> <span class="keyword">NONE</span> <span class="operator">|</span><span class="string">&#x27;directory 对象名&#x27;</span><span class="operator">|</span><span class="string">&#x27;磁盘组名&#x27;</span>]</span><br><span class="line">[HOST<span class="operator">=</span><span class="string">&#x27;主机名&#x27;</span>]</span><br><span class="line">[PORT<span class="operator">=</span>端口号]</span><br><span class="line">[DECRYPT <span class="keyword">USING</span> transport_secret]</span><br><span class="line"></span><br><span class="line">通过XML 的方式来加载PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE salespdb</span><br><span class="line">  <span class="keyword">USING</span> <span class="string">&#x27;/disk1/usr/salespdb.xml&#x27;</span></span><br><span class="line">  SOURCE_FILE_NAME_CONVERT <span class="operator">=</span></span><br><span class="line">    (<span class="string">&#x27;/disk1/oracle/dbs/salespdb/&#x27;</span>, <span class="string">&#x27;/disk2/oracle/dbs/salespdb/&#x27;</span>)</span><br><span class="line">  NOCOPY</span><br><span class="line">  STORAGE (MAXSIZE <span class="number">2</span>G)</span><br><span class="line">  TEMPFILE REUSE;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="4-通过-镜像拷贝-的方式来创建"><a href="#4-通过-镜像拷贝-的方式来创建" class="headerlink" title="4. 通过 镜像拷贝 的方式来创建"></a>4. 通过 镜像拷贝 的方式来创建</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span>  <span class="keyword">AS</span> SEED &#125;</span><br><span class="line"><span class="keyword">FROM</span> 源pdb名称 </span><br><span class="line"><span class="keyword">USING</span> MIRROR <span class="keyword">COPY</span> 镜像名</span><br></pre></td></tr></table></figure>
<h3 id="5-CONTAINER-MAP-子句"><a href="#5-CONTAINER-MAP-子句" class="headerlink" title="5. CONTAINER MAP 子句"></a>5. CONTAINER MAP 子句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER_MAP <span class="keyword">UPDATE</span> &#123;添加表分区 <span class="operator">|</span> 将表分为分区表&#125; </span><br><span class="line"></span><br><span class="line">为区间分区容器添加新的PDB并划分区区间</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE cdb1_pdb3</span><br><span class="line">  ADMIN <span class="keyword">USER</span> IDENTIFIED <span class="keyword">BY</span> manager</span><br><span class="line">  FILE_NAME_CONVERT<span class="operator">=</span>(<span class="string">&#x27;cdb1_pdb0, cdb1_pdb3&#x27;</span>)</span><br><span class="line">  CONTAINER_MAP <span class="keyword">UPDATE</span> (<span class="keyword">ADD</span> <span class="keyword">PARTITION</span> cdb1_pdb3 <span class="keyword">VALUES</span> LESS THAN (<span class="number">100</span>));</span><br><span class="line"><span class="keyword">ALTER</span> PLUGGABLE DATABASE cdb1_pdb3 <span class="keyword">OPEN</span>;</span><br><span class="line"></span><br><span class="line">将存在的区间分区容器分裂部分创建一个新的PDB</span><br><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE cdb1_pdb4</span><br><span class="line">  ADMIN <span class="keyword">USER</span> IDENTIFIED <span class="keyword">BY</span> manager</span><br><span class="line">  FILE_NAME_CONVERT<span class="operator">=</span>(<span class="string">&#x27;cdb1_pdb0, cdb1_pdb4&#x27;</span>)</span><br><span class="line">  CONTAINER_MAP <span class="keyword">UPDATE</span> (SPLIT <span class="keyword">PARTITION</span> cdb1_pdb3 </span><br><span class="line">                          <span class="keyword">AT</span> (<span class="number">50</span>) </span><br><span class="line">                          <span class="keyword">INTO</span></span><br><span class="line">                          (<span class="keyword">PARTITION</span> cdb1_pdb3, <span class="keyword">PARTITION</span> cdb1_pdb3);</span><br><span class="line"><span class="keyword">ALTER</span> PLUGGABLE DATABASE cdb1_pdb4 <span class="keyword">OPEN</span>;</span><br><span class="line"></span><br><span class="line">确认分区结果</span><br><span class="line"><span class="keyword">SELECT</span> partition_name, high_value</span><br><span class="line">  <span class="keyword">FROM</span> dba_tab_partitions</span><br><span class="line">  <span class="keyword">WHERE</span> table_name<span class="operator">=</span><span class="string">&#x27;MAP&#x27;</span> <span class="keyword">AND</span> table_owner<span class="operator">=</span><span class="string">&#x27;SYS&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="6-pdb-snapshot-clause-指定是否创建-PDB-SNAPSHOT"><a href="#6-pdb-snapshot-clause-指定是否创建-PDB-SNAPSHOT" class="headerlink" title="6. pdb_snapshot_clause 指定是否创建 PDB SNAPSHOT"></a>6. pdb_snapshot_clause 指定是否创建 PDB SNAPSHOT</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> PLUGGABLE DATABASE &#123;pdbname [ <span class="keyword">AS</span> APPLICATION  CONTAINER ] <span class="operator">|</span>  <span class="keyword">AS</span> SEED &#125;</span><br><span class="line">SNAPSHOT MANUAL <span class="operator">|</span> <span class="keyword">EVERY</span> 刷新间隔 &#123;HOURS <span class="operator">|</span> MINUTES&#125; <span class="operator">|</span> <span class="keyword">NONE</span></span><br><span class="line">       <span class="keyword">NONE</span>：默认值，标识不创建快照</span><br><span class="line">       MANUAL：表明 PDB 的快照只能手工创建</span><br><span class="line">       <span class="keyword">EVERY</span> <span class="type">INTERVAL</span>：则PDB的快照会在每一个时间间隔后创建</span><br><span class="line">                       如果指定的单位是 MINUTES 则间隔时间必须小于<span class="number">3000</span></span><br><span class="line">                       如果指定的单位是 HOURS 则间隔时间必须小于<span class="number">2000</span></span><br></pre></td></tr></table></figure>
<h3 id="7-名词释义"><a href="#7-名词释义" class="headerlink" title="7. 名词释义"></a>7. 名词释义</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">pdbname:要创建的pdb名称</span><br><span class="line"><span class="keyword">AS</span> APPLICATION CONTAINER：指定创建一个应用容器</span><br><span class="line"><span class="keyword">AS</span> SEED：创建应用种子 。数据库会为其分配一个 application_container_name$SEED 的名字，一个容器最多只能有一个应用种子</span><br><span class="line">ADMIN <span class="keyword">USER</span>: 为pdb 创建一个管理员用户</span><br><span class="line">ROLES：为管理员账号赋权         </span><br><span class="line">PARALLEL：复制数据文件到新的PDB的并发数。如果指定PARLLEL 而不指定数字，数据库会自动选择并发数</span><br><span class="line"><span class="keyword">DEFAULT</span> TABLESPACE：为PDB 创建一个默认表空间，为所有非<span class="operator">-</span><span class="keyword">SYSTEM</span> 并且没有指定默认表空间的用户的默认表空间</span><br><span class="line">FILE_NAME_CONVERT：指定种子库的路径，以及目标pdb存放数据文件的路径。</span><br><span class="line">                   如果FILE_NAME_CONVERT<span class="operator">=</span><span class="keyword">NONE</span>,数据库将首先在OMF中创建数据文件，</span><br><span class="line">                   如果没有使用OMF,则数据库会使用 PDB_FILE_NAME_CONVERT 初始化参数来设定</span><br><span class="line">SERVICE_NAME_CONVERT：替换种子库中出现的service_name 为新的名字</span><br><span class="line">                     <span class="number">1</span>) 不能替换PDB的默认服务，默认服务的名字将于PDB 同名</span><br><span class="line">                     <span class="number">2</span>) 通过create_pdb_from_seed 的方式，使用CDB seed 创建PDB 时不能使用该参数。因为CDB seed 没有用户自定义的service_name。</span><br><span class="line">                     <span class="number">3</span>) 通过应用seed来创建应用PDB 则可以使用该参数。</span><br><span class="line">PATH_PREFIX：<span class="number">1</span>) 使用该参数可确保于PDB关联的目录对象的文件路径仅限于指定目录或者其子目录。同时也确保于PDB关联的的以下文件</span><br><span class="line">             <span class="number">2</span>) 限制在指定目录(PDB的ORACLE XML存储库，使用<span class="keyword">CREATE</span> PFILE语句创建的文件，以及ORACLE wallets的导出目录)</span><br><span class="line">             <span class="number">3</span>) 创建PDB后无法修改此路径，该路径限制不影响在OMF中创建的文件</span><br><span class="line">             <span class="number">4</span>) 在UNIX类系统中。注意必须确保以 <span class="operator">/</span> 结束路径</span><br><span class="line">                PATH_PREFIX <span class="operator">=</span> <span class="string">&#x27;/disk1/oracle/dba/salespdb/&#x27;</span> #路径后面的 <span class="operator">/</span> 千万不能丢</span><br><span class="line">             <span class="number">5</span>) 如果使用目录对象，则目录对象必须存在于CDB$ROOT 中，目录对象指向的绝对路径将用于PATH_PREFIX</span><br><span class="line">             <span class="number">6</span>) 如果PATH_PREFIX<span class="operator">=</span><span class="keyword">NONE</span>,则以PDB相关联的目录路径将被视为绝对路径，并且不限于特定目录。</span><br><span class="line">             <span class="number">7</span>) 为 PDB 指定 PATH_PREFIX 后，现有目录对象可能无法按预期工作，因为 PATH_PREFIX 字符串始终作为前缀添加到 PDB 中的所有本地目录对象， </span><br><span class="line">                PATH_PREFIX 仅适用于用户创建的目录对象。 它不适用于 Oracle 提供的目录对象。</span><br><span class="line">TEMPFILE REUSE：指定假如存在TEMPFILE 则格式化并重新使用该文件</span><br><span class="line">USER_TABLESPACE：指定PDB 可以使用的已存在的表空间。<span class="keyword">SYSTEM</span>, SYSAUX, TEMP 这<span class="number">3</span>个表空间对所有的PDB都适用并且不能在该子句中指定</span><br><span class="line">                 指定表空间名。则这些表空间在新PDB 可用</span><br><span class="line">                 指定<span class="keyword">ALL</span> 。则所有的表空间在新PDB 可用</span><br><span class="line">                 指定<span class="keyword">ALL</span> <span class="keyword">EXCEPT</span> 。则除了指定的表空间。其他在新PDB 可用</span><br><span class="line">                 指定<span class="keyword">NONE</span> 。 则只有<span class="keyword">SYSTEM</span>, SYSAUX, TEMP 在新的PDB 不可用</span><br><span class="line"></span><br><span class="line">SNAPSHOT <span class="keyword">COPY</span> <span class="operator">|</span> <span class="keyword">NO</span> DATA：仅用于 clone 方式，</span><br><span class="line">           SNAPSHOT <span class="keyword">COPY</span>：使用存储快照来克隆表空间</span><br><span class="line">           <span class="keyword">NO</span> DATA：只拷贝表空间的数据定义信息。而不拷贝表空间的内容</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span> <span class="operator">|</span> MOVE <span class="operator">|</span> NOCOPY：仅用于 XML 方式</span><br><span class="line">          默认情况下数据库通过配置文件为新的PDB 创建每个设定的表空间。而这三种方法允许你重写那些设定</span><br><span class="line">          <span class="keyword">COPY</span>：拷贝表空间到新的位置</span><br><span class="line">          MOVE：移动表空间到新的位置</span><br><span class="line">          NOCOPY：不拷贝或移动表空间到新的位置</span><br><span class="line">        </span><br><span class="line">STANDBYS：cdbname 指定哪个CDB 从库包含这个新的PDB.可以指定多个CDB 从库</span><br><span class="line">          <span class="keyword">ALL</span>：指定连接主CDB 的所有从CDB 都包含这个新的PDB。这个是默认值</span><br><span class="line">          <span class="keyword">ALL</span> <span class="keyword">EXCEPT</span>:除了指定的CDB从库。其他从库都包含这个新的PDB</span><br><span class="line">          <span class="keyword">NONE</span>: 所有连接这个主CDB 的从CDB 都不包含这个新的PDB</span><br><span class="line">LOGGIN <span class="operator">|</span> NOLOGGIN <span class="operator">|</span> FILESYSTEM_LIKE_LOGGIN: 设定PDB创建表空间的日志属性。</span><br><span class="line">         默认情况是LOGGIN</span><br><span class="line">         该属性可在创建表空间时指定覆盖默认设置</span><br><span class="line"></span><br><span class="line">CREATE_FILE_DEST：改写PDB存放数据文件路径的属性。默认情况下，PDB 会引用CDB 的OMF设置。</span><br><span class="line">        <span class="keyword">NONE</span>：禁止PDB 使用OMF </span><br><span class="line">        directory_path_name(<span class="string">&#x27;directory 对象名&#x27;</span>)<span class="operator">|</span>diskgroup_name(<span class="string">&#x27;磁盘组名&#x27;</span>)：允许PDB使用OMF</span><br><span class="line">            <span class="number">1</span>) directory_path_name：指定 directory_path_name 以指定 PDB 文件的基本文件系统目录。 </span><br><span class="line">               指定操作系统目录的完整路径名。 该目录必须存在并且 Oracle 进程必须对该目录具有适当的权限。 </span><br><span class="line">               单引号是必需的，因此路径名区分大小写。</span><br><span class="line">            <span class="number">2</span>) diskgroup_name：指定 diskgroup_name 以指定 PDB 文件的默认 Oracle ASM 磁盘组。</span><br><span class="line">        如果指定 <span class="keyword">NONE</span> 以外的值，则数据库在 PDB 中隐式设置 DB_CREATE_FILE_DEST 初始化参数为 <span class="keyword">SCOPE</span><span class="operator">=</span>SPFILE。</span><br><span class="line">HOST <span class="operator">&amp;</span> PORT：仅在引用代理PDB来创建新的PDB时有用。这种类型的PDB称为引用PDB。 </span><br><span class="line">           <span class="keyword">AS</span> PROXY PDB<span class="variable">@dblink</span></span><br><span class="line"></span><br><span class="line">create_pdb_clone：通过克隆方式创建PDB</span><br><span class="line">        克隆的源PDB 可以是在同一个CDB中。也可以在不同的CDB中。甚至是非CDB 实例。</span><br><span class="line">        如果源PDB在同一个CDB中，则源PDB可以是插入状态也可以是非插入状态。如果是不同CDB 则需要插入状态。</span><br><span class="line">        如果源PDB不在同一个CDB中。或者是非CDB，有以下要求：</span><br><span class="line">        <span class="number">1</span>）它们必须具有相同的字节序格式</span><br><span class="line">        <span class="number">2</span>）它们必须具有兼容的字符集和国家字符集，这意味着：</span><br><span class="line">           A.源字符集中的每个字符在本地 CDB 字符集中都有</span><br><span class="line">           B.源字符集中的每个字符在本地 CDB 字符集中具有相同的代码点值</span><br><span class="line">        <span class="number">3</span>）他们必须安装相同的数据库选项集</span><br><span class="line">        源库用户使用了默认临时表空间的，在新PDB中使用新PDB的默认临时表空间。</span><br><span class="line">        源库用户没有使用默认临时表空间的，将继续使用在新PDB中本地对应的临时表空间。  </span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span>：通过克隆方式创建PDB 指定源库</span><br><span class="line"></span><br><span class="line"><span class="keyword">AS</span> PROXY <span class="keyword">FROM</span>：通过代理方式克隆</span><br><span class="line"></span><br><span class="line">DECRYPT <span class="keyword">USING</span> transport_secret：指定这个子句必须具有 SYSKM的权限</span><br><span class="line">    在联合PDB中：</span><br><span class="line">    如果使用TDE保护数据库，则一定要指定这个子句，否则则是可选项</span><br><span class="line">    在独立PDB中则不需要指定这个子句</span><br><span class="line">    wallet 必须在ROOT 中打开</span><br><span class="line">    在所有的方式下(NOCOPY, <span class="keyword">COPY</span>, <span class="keyword">and</span> MOVE) 都会拷贝wallet 文件。</span><br><span class="line">    例子：</span><br><span class="line">    在XML medata 文件中加载PDB</span><br><span class="line">    <span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB2 <span class="keyword">USING</span> <span class="string">&#x27;/tmp/cdb1_pdb2.xml&#x27;</span> NOCOPY</span><br><span class="line">    KEYSTORE IDENTIFIED <span class="keyword">BY</span> keystore_password DECRYPT <span class="keyword">USING</span> transport_secret</span><br><span class="line">    </span><br><span class="line">    在归档文件中加载PDB</span><br><span class="line">    <span class="keyword">CREATE</span> PLUGGABLE DATABASE CDB1_PDB1_1_C <span class="keyword">USING</span> <span class="string">&#x27;/tmp/cdb1_pdb3.pdb&#x27;</span> DECRYPT <span class="keyword">USING</span> transport_secret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/11/08/mysqlPlugIn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/08/mysqlPlugIn/" class="post-title-link" itemprop="url">MySql 插件安装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-08 09:38:29 / 修改时间：18:29:47" itemprop="dateCreated datePublished" datetime="2022-11-08T09:38:29+08:00">2022-11-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="首先来认识几个插件相关参数"><a href="#首先来认识几个插件相关参数" class="headerlink" title="首先来认识几个插件相关参数"></a>首先来认识几个插件相关参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">plugin_dir 指定插件so 文件存放的目录 mysql 5.7 自带的插件目录在 /usr/local/mysql/lib/plugin 里面</span><br><span class="line">           plugin_dir = /usr/local/mysql/lib/plugin</span><br><span class="line"></span><br><span class="line">plugin_name 要调用的插件的名称，默认情况下，服务器启动将会在mysql.plugin系统表中插件逐个加载，也可以通</span><br><span class="line">            过这个参数来改变这个行为</span><br><span class="line">            plugin_name = [OFF | ON | FORCE | FORCE_PLUS_PERMANENT]</span><br><span class="line">            OFF: 禁用插件 。可能某些内置插件不再此禁用之列，比如 mysql_native_password</span><br><span class="line">            ON ： 启用插件，如果启用失败。则禁用插件</span><br><span class="line">            FORCE：启用插件，如果启用失败，则数据库也停止启动。</span><br><span class="line">            FORCE_PLUS_PERMANENT：启用插件。比 FORCE 多了一个在运行过程中禁止卸载插件。如果用户执行卸载插件则报错</span><br><span class="line"></span><br><span class="line">plugin-load 告诉服务器在启动内置插件和存储引擎后启动指定的插件</span><br><span class="line">            plugin-load=<span class="string">&quot;connection_control.so&quot;</span></span><br><span class="line"></span><br><span class="line">plugin-load-add  告诉服务器在启动内置插件和存储引擎后启动指定的插件</span><br><span class="line">            plugin-load-add=<span class="string">&quot;connection_control.so&quot;</span></span><br><span class="line">early-plugin-load 告诉服务器在启动内置插件和存储引擎前启动指定插件</span><br><span class="line">            early-plugin-load=<span class="string">&quot;someplugin.so&quot;</span></span><br><span class="line"></span><br><span class="line">plugin-load 和 plugin-load-add 的区别是，plugin-load 在多实例环境下。配置多个plugin-load 最终取最后一个plugin-load的值,</span><br><span class="line">plugin-load-add 则是叠加作用。最终启动所有plugin-load-add 启动的多个插件</span><br><span class="line">--plugin-load=x --plugin-load-add=y</span><br><span class="line">等效于</span><br><span class="line">--plugin-load-add=x --plugin-load-add=y</span><br><span class="line">等效于</span><br><span class="line">--plugin-load=<span class="string">&quot;x;y&quot;</span></span><br><span class="line"></span><br><span class="line">当启用了skip-grant-tables ，则内置mysql.plugin 会被跳过，不启动内置插件。但是通过 plugin-load 、plugin-load-add 、early-plugin-load</span><br><span class="line">则会被加载。</span><br></pre></td></tr></table></figure>
<h3 id="通过命令来加载插件"><a href="#通过命令来加载插件" class="headerlink" title="通过命令来加载插件"></a>通过命令来加载插件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 首要条件 plugin_dir 要指向存放插件so 文件的目录。</span><br><span class="line">[mysqld]</span><br><span class="line">plugin<span class="operator">-</span>load<span class="operator">-</span><span class="keyword">add</span><span class="operator">=</span>myplugin<span class="operator">=</span>somepluglib.so</span><br><span class="line"></span><br><span class="line">等价于</span><br><span class="line">INSTALL PLUGIN myplugin SONAME <span class="string">&#x27;somepluglib.so&#x27;</span>;</span><br><span class="line"></span><br><span class="line">通过INSTALL PLUGIN 命令可以在线加载已经存放在 plugin_dir 中的插件。</span><br><span class="line">通过INSTALL PLUGIN 命令会使加载的插件写入mysql.plugin.导致插件永久注册。因为它要确保在下一次重启时会加载到该插件</span><br><span class="line">对于那些必须在数据库启动初始化阶段必须加载的插件，则不能通过INSTALL PLUGUN 来注册，会报错</span><br><span class="line">ERROR <span class="number">1721</span> (HY000): Plugin <span class="string">&#x27;myplugin&#x27;</span> <span class="keyword">is</span> marked <span class="keyword">as</span> <span class="keyword">not</span> dynamically</span><br><span class="line">installable. You have <span class="keyword">to</span> stop the server <span class="keyword">to</span> install it.</span><br><span class="line">这种情况的插件则需要通过 plugin<span class="operator">-</span>load plugin<span class="operator">-</span>load<span class="operator">-</span><span class="keyword">add</span>  early<span class="operator">-</span>plugin<span class="operator">-</span>load 来加载</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="卸载插件"><a href="#卸载插件" class="headerlink" title="卸载插件"></a>卸载插件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UNINSTALL PLUGIN 命令可以在运行时卸载 INSTALL PLUGIN 加载的插件或者通过plugin<span class="operator">-</span>load 的插件，除以下两种情况</span><br><span class="line"><span class="number">1.</span> 不能卸载内置插件。那些在information_schema.plugin 或者 <span class="keyword">show</span> plugins 结果中 Library 列展示为<span class="keyword">NULL</span> 的插件</span><br><span class="line"><span class="number">2.</span> 当 plugin_name 设置了 FORCE_PLUS_PERMANENT 值，这是不允许删除插件的</span><br><span class="line"></span><br><span class="line">对应那些配置了plugin<span class="operator">-</span>load 的插件则最终移除需要在配置文件中去除指定的插件，然后重启服务器。</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/11/02/sqltuning2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/02/sqltuning2/" class="post-title-link" itemprop="url">索引须知:最左原则</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-02 18:13:11 / 修改时间：18:37:19" itemprop="dateCreated datePublished" datetime="2022-11-02T18:13:11+08:00">2022-11-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>有如下表结构<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_mapping_v1` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `site` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;平台&#x27;</span>,</span><br><span class="line">  `project` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;项目&#x27;</span>,</span><br><span class="line">  `distinct_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span> COMMENT <span class="string">&#x27;设备号&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">&#x27;修改时间&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_user_mapping` (`site`,`project`,`distinct_id`) <span class="keyword">USING</span> BTREE COMMENT <span class="string">&#x27;用户映射表唯一组合索引&#x27;</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>使用如下的语句进行检索。可能很多人都会认为会命中unique key.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  id,site,project,distinct_id,user_id,create_time,update_time  <span class="keyword">FROM</span> user_mapping_v1 </span><br><span class="line"><span class="keyword">WHERE</span> distinct_id <span class="operator">=</span> <span class="string">&#x27;B4C2AA7B-95A0-44DF-BFC5-xxxx&#x27;</span> <span class="keyword">AND</span> project <span class="operator">=</span> <span class="string">&#x27;proj&#x27;</span></span><br></pre></td></tr></table></figure><br> 而实际执行时，你会收到意外的执行计划，那就是全表扫描。为什么呢？条件字段有包含在索引字段里面啊。这里就涉及到索引使用<br> 的一个原则问题：最左匹配原则。<br> 数据库通过条件匹配索引是从索引列最左列开始匹配的。那么上面的条件虽然有distinct_id，project 但是并没有site ，所以匹配<br> 不到索引。走了全表扫描。<br> 给它建一个索引<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_distinct_project <span class="keyword">ON</span> user_mapping_v1(distinct_id,project)</span><br></pre></td></tr></table></figure><br>这下我们可以看到走的就是新建的这个索引了<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id	select_type	  <span class="keyword">table</span>	        partitions	type	possible_keys	       key	             key_len	<span class="keyword">ref</span>	      <span class="keyword">rows</span>	filtered	Extra</span><br><span class="line"><span class="number">1</span>	SIMPLE	    user_mapping_v1	  \N	    <span class="keyword">ref</span>	 idx_distinct_project	idx_distinct_project	<span class="number">962</span>	   const,const	<span class="number">1</span>	 <span class="number">100.00</span>	     \N</span><br></pre></td></tr></table></figure><br>在创建索引时,通常要考虑把系统中对该表查下时最常使用的那个字段放在索引的最左边，建组合索引。以达到一个索引能在更多的情况下被使用</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/11/01/oldestxmin/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/01/oldestxmin/" class="post-title-link" itemprop="url">日志报错:oldest xmin is far in the past</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-11-01 11:44:29 / 修改时间：12:03:17" itemprop="dateCreated datePublished" datetime="2022-11-01T11:44:29+08:00">2022-11-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天巡检RDS postgresql 上的日志，发现错误日志里面一直报错<br><img src="/images/16672725934495.png" alt="errorlog">   </p>
<p>oldest xmin is far in the past<br>首先考虑到的是有长事务没有关闭导致autovacuum不能推进oldest xmin。<br>于是先查下有没idle in transaction 事务<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_stat_activity <span class="keyword">where</span> state<span class="operator">=</span><span class="string">&#x27;idle in transaction&#x27;</span></span><br></pre></td></tr></table></figure><br>发现并没有这样的transaction</p>
<p>那么是有事务在准备阶段没有关闭吗<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_prepared_xacts;</span><br></pre></td></tr></table></figure><br>发现也没有结果</p>
<p>出现这种情况的还有另一种可能。就是存在已经没有使用的复制槽</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_replication_slots;</span><br></pre></td></tr></table></figure>
<p>一看，果然有2条记录<br>经过一番询问，原来是好几个月前开发需要开DTS同步数据做数据集聚，但是项目已经停了好久。这边也没收到<br>通知。就这样落下了2个复制槽一直没有释放。由于长时间没用应用导致出现auto vacuum 的时候出错了</p>
<p>既然已经找到问题。那就把这2个没用的复制槽删掉吧<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_drop_replication_slot(<span class="string">&#x27;di_slot_2783&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> pg_drop_replication_slot(<span class="string">&#x27;di_slot_2785&#x27;</span>);</span><br></pre></td></tr></table></figure><br>过1分分钟重新查看日志。可以看到已经没报错vacumm 也执行过去了。oldest xmin: 662582680 达到6亿多<br><img src="/images/16672751408080.png" alt="resultpic"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/31/wal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/31/wal/" class="post-title-link" itemprop="url">PG的预写日志WAL(Write-Ahead Logging)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-31 16:19:09" itemprop="dateCreated datePublished" datetime="2022-10-31T16:19:09+08:00">2022-10-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-11-17 14:16:54" itemprop="dateModified" datetime="2022-11-17T14:16:54+08:00">2022-11-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/postgres/" itemprop="url" rel="index"><span itemprop="name">postgres</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>WAL(Write-Ahead Logging)是保证数据完整性的一种标准方法,WAL的中心概念是数据文件（存储着表和索引）的修改必须在这些动作被日志记录之后才被写入，即在描述这些改变的日志记录被刷到持久存储以后。<br>WAL日志存放在pg_wal目录中。wal 的大小默认16M，可以在初始化数据库(initdb)的时候通过—wal-segsize 来修改其大小。<br>WAL文件中的每一个记录都被一个CRC-32（32位）校验码所保护，这让我们可以判断记录内容是否正确。CRC值在我们写入每一个WAL记录时设置，并且在崩溃恢复、归档恢复和复制时检查<br>使用 WAL 会显着减少磁盘写入次数，因为只需要将日志文件刷新到磁盘以保证事务被提交，而不是事务更改的每个数据文件。 日志文件是按顺序写入的，因此同步日志的成本远低于刷新数据页的成本。 对于处理涉及数据存储不同部分的许多小事务的服务器来说尤其如此。 此外，当服务器正在处理许多小的并发事务时，日志文件的一个 fsync 可能足以提交许多事务。<br>WAL 也使在线备份数据库以及基于时间点的恢复得以实现。</p>
<p>配置WAL的相关参数<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">checkpoint_timeout  </span><br><span class="line">    <span class="number">1.</span> 每次发动一次checkpoint的间隔时间。检查点在每 checkpoint_timeout 秒开始 或者在wal 存储量快要超过 max_wal_size</span><br><span class="line">       时开始。(默认值分表为 <span class="number">5</span>min,<span class="number">1</span>G)</span><br><span class="line">    <span class="number">2.</span> 在每一个checkpoint 时刻，所有的脏数据页都将被刷到磁盘，并且一个特殊的检查点记录将被写入日志文件</span><br><span class="line">      （修改记录之前已经被刷写到wal日志里面）</span><br><span class="line">    <span class="number">3.</span> 在崩溃时，崩溃恢复过程检查最新的检查点记录用来决定从日志中的哪一点（称为重做记录）开始REDO操作，因为在这个检查点</span><br><span class="line">       之前的数据都已经刷盘。</span><br><span class="line">    <span class="number">4.</span> 如果在前一个检查点以来都没有WAL被写入。即使过了checkpoint_timeout，新的检查点也会被跳过</span><br><span class="line">    <span class="number">5.</span> 如果在进行WAL归档，并想通过更高的频率来归档WAL日志段来防止数据的丢失。则需要调整的是 archive_timeout 参数，而</span><br><span class="line">       不是checkpoint_timeout 参数</span><br><span class="line">    <span class="number">6.</span> 可以通过<span class="keyword">SQL</span> 命令 CHECKPOINT 强制设置检查点</span><br><span class="line">    <span class="number">7.</span> 减少 checkpoint_timeout 的时间间隔或降低 max_wal_size 的容量限制将会使检查点发出得更为频繁，这虽然能在崩溃后</span><br><span class="line">       更快的恢复，但会因为更多的刷新脏页数据带来更多的IO开销。如果还设置了full_page_writes，为了保证页面的一致性，在</span><br><span class="line">       每个检查点之后对一个数据页的第一次修改，将会对这个页整页的数据写入日志，因此会导致更多的WAL日志量的产生。无论如</span><br><span class="line">       何都会导致更多的磁盘IO产生。</span><br><span class="line">    <span class="number">8.</span> 将checkpoint_timeout 设置足够长的时间是比较合理的做法，可以设置 checkpoint_warning 作为检查点的简单性检查，如</span><br><span class="line">       果由于填充wal文件引起的检查点发生的时间比这个时间更近，则向服务器日志写入一条消息，这表明应该增加 max_wal_size 。 </span><br><span class="line">       checkpoint_warning 默认<span class="number">30</span>s ，没有写明单位时以秒为单位。</span><br><span class="line"></span><br><span class="line">checkpoint_completion_target</span><br><span class="line">    <span class="number">1.</span> 设置检查点将IO操作平均在 checkpoint_timeout <span class="operator">*</span> checkpoint_completion_target 时间内。避免大批页面写入对I<span class="operator">/</span>O系统</span><br><span class="line">       产生的冲击</span><br><span class="line">    <span class="number">2.</span> 在<span class="number">14</span>版开始该参数默认值为<span class="number">0.9</span>，以前版本为<span class="number">0.5</span></span><br><span class="line">    <span class="number">3.</span> 假设有<span class="number">100</span>G 的数据要刷出，checkpoint_timeout 为<span class="number">5</span>min </span><br><span class="line">       当 checkpoint_completion_target 设置为<span class="number">0.5</span>时</span><br><span class="line">       IO 需要承当 <span class="number">100</span> <span class="operator">/</span> (<span class="number">0.5</span> <span class="operator">*</span> <span class="number">60</span> <span class="operator">*</span> <span class="number">5</span>) <span class="operator">*</span> <span class="number">1024</span> <span class="operator">~</span> <span class="number">682</span> M<span class="operator">/</span>s 的写速率</span><br><span class="line">       当 checkpoint_completion_target 设置为<span class="number">0.9</span>时</span><br><span class="line">       IO 需要承当 <span class="number">100</span> <span class="operator">/</span> (<span class="number">0.9</span> <span class="operator">*</span> <span class="number">60</span> <span class="operator">*</span> <span class="number">5</span>) <span class="operator">*</span> <span class="number">1024</span> <span class="operator">~</span> <span class="number">379</span> M<span class="operator">/</span>s 的写速率</span><br><span class="line">    <span class="number">4.</span> checkpoint_completion_target 的值越高则IO 承担的压力相对较小。对系统更友好。不会因为IO繁忙导致系统顿卡</span><br><span class="line">    <span class="number">5.</span> 虽然该值能设置大于<span class="number">1.0</span> ，但也不要设置 <span class="operator">&gt;=</span> <span class="number">1.0</span> ,因为checkpoint 除了刷数据，还需要做一些别的动作。<span class="number">1.0</span>的设置极有可能</span><br><span class="line">       导致检查点不能按时被完成，这可能由于所需的WAL段数量意外变化导致性能损失</span><br><span class="line">    </span><br><span class="line">checkpoint_flush_after</span><br><span class="line">    <span class="number">1.</span> 当发生检查点时，写入超过 checkpoint_flush_after 数量的数据，将尝试强制操作系统将这些写入发出到底层存储。这样做将</span><br><span class="line">       限制内核页面缓存中的脏数据量，从而减少在检查点结束时发出 fsync 或操作系统在后台以较大批量写回数据时发生停顿的可能</span><br><span class="line">       性。</span><br><span class="line">    <span class="number">2.</span> 通常这会减少失误的延迟。但对于工作负载大于 shared_buffers 但又小余系统缓存页的情况有不利影响。</span><br><span class="line">    <span class="number">3.</span> 该参数在Linux 和 POSIX 系统有效，在linux 上默认值为<span class="number">256</span>kB,其他平台则设置为<span class="number">0</span> 禁用。最大值<span class="number">2</span>MB</span><br><span class="line"></span><br><span class="line">max_wal_size min_wal_size </span><br><span class="line">    <span class="number">1.</span> 这<span class="number">2</span>个参数决定存放在 pg_wal 里面WAL 的数量。</span><br><span class="line">    <span class="number">2.</span> 如果短期内WAL产生数的峰值超过 max_wal_size ，则移除不需要的 wal 文件，直到系统回到 max_wal_size 的限制之下</span><br><span class="line">    <span class="number">3.</span> 当低于 max_wal_size 的限制时，系统就会循环使用足够的 wal 文件直到下一个检查点所需要的量。这种需要是基于之前的检查点</span><br><span class="line">       周期中使用的WAL 文件数量的移动平均数估算出来的。如果实际用量超过估计值，移动平均数会立即增加，因此它能在一定程度上适</span><br><span class="line">       应峰值用量而不是平均用量</span><br><span class="line">    <span class="number">4.</span> min_wal_size 对回收给未来使用的 WAL 文件的量设置了一个最小值。这个参数指定数量的 WAL 将总是被回收给未来使用，即便系</span><br><span class="line">       统很闲并且 WAL用量估计建议只需要一点点 WAL 时也是如此</span><br><span class="line"></span><br><span class="line">wal_keep_size (<span class="number">12</span>及以前版本 wal_keep_segments )</span><br><span class="line">    <span class="number">1.</span> 控制在pg_wal 中保留 wal 日志的最小数量：wal_keep_size <span class="operator">+</span> <span class="number">1</span> wal 文件大小的总和。另外开启了归档，在未归档之前，wal的日</span><br><span class="line">       志不能被移除也不能被覆盖。 </span><br><span class="line">    <span class="number">2.</span> 这个参数设置是为了保证流复制期间。从库能够从主库获取足够所需的wal，保证复制的正常。如果有开启归档，从库没能在pg_wal中</span><br><span class="line">       获取足够的wal日志恢复，则可以通过在归档中获取对应的日志来恢复。直到追上主库。</span><br><span class="line">    <span class="number">3.</span> 如果归档跟不上 WAL 生成的速度，或者如果 archive_command 反复失败，旧的 WAL 文件将堆积在 pg_wal 中，直到情况得到解决。 </span><br><span class="line">       使用复制槽的慢速或故障备用服务器将产生相同的效果。</span><br><span class="line">    </span><br><span class="line">在恢复和归档模式下，服务器还会定期执行重启点。服务器将其所有状态强制刷盘，更新 pg_control 文件，以指示无需再扫描已处理的wal</span><br><span class="line">数据，然后回收 pg_wal中所有的旧 wal 文件。重启点在主库上只能在检查点记录处执行，即在至少经过 checkpoint_timeout 时间之后或</span><br><span class="line">者在wal总量即将到达 max_wal_size 之时到达检查点从而触发重启点。但是由于何时可以执行重启点的限制。在恢复期间通常会超过 max_wal_size,</span><br><span class="line">最多超过一个检查点周期的wal,wal_max_size 并不是一个硬限制，无论何时。服务器上都应该保留有足够的空间。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>个常用的 wal 内部函数：XLogInsertRecord 和 XLogFlush 。XLogInsertRecord 用于将一条新记录放置在共享内存中的WAL buffer中。</span><br><span class="line">如果没有足够的空间放置新纪录，XLogInsertRecord 不得不向内核缓存写出一些已经填满的 WAL 缓存，这是不可取的。</span><br><span class="line">因为 XLogInsertRecord用于每个数据库低级别的修改(比如 <span class="keyword">insert</span>),同时需要在受影响的数据页上持有排他锁，这就要求它尽可能快。但写</span><br><span class="line">入 WAL 缓冲区还可能带来更糟糕的后果就是强制开新的日志段，这要求更多的时间。通常 WAL 缓存应该由 XLogFlush 请求和写入刷新，</span><br><span class="line">该请求在大多数情况下在事务提交时进行，以确保事务记录被刷新到永久存储。 在具有高日志输出的系统上， XLogFlush 请求出现的频率可能</span><br><span class="line">不足以阻止 XLogInsertRecord 进行写入。在这样的系统上，应该通过修改 wal_buffers 参数来增加 WAL 缓冲区的数量。当设置了 </span><br><span class="line">full_page_writes 并且系统非常繁忙时，将 wal_buffers 设置得更高将有助于在每个检查点之后的时间段内平滑响应时间。</span><br><span class="line"></span><br><span class="line">commit_delay </span><br><span class="line">    <span class="number">1.</span> 该参数定义了组提交领导进程在 XLogFlush 里面获得锁后将休眠多少微秒,而组提交的跟随者跟在领导者后面排队。</span><br><span class="line">    <span class="number">2.</span> 这个休眠时间允许其他服务将其提交记录追加到 WAL 缓存区，以便它们跟随领导进程的最终同步操作一起刷出到存储。</span><br><span class="line">    <span class="number">3.</span> 如果fsync 没启动或者当前处于活动的事务少于 commit_siblings 则不发生休眠</span><br><span class="line">    <span class="number">4.</span> 有些平台要求休眠时间是<span class="number">10</span>毫秒，所以只要是非<span class="number">0</span>值，<span class="number">1</span><span class="number">-10000</span>微秒之间的取值都是相同的效果</span><br><span class="line">    <span class="number">5.</span> 同样有些平台实际上的休眠时间会比 commit_delay 设置的时间长一些</span><br><span class="line"></span><br><span class="line">    设置commit_delay 只在两种情况下有帮助</span><br><span class="line">    <span class="number">1</span>) 有一些并发提交的事务</span><br><span class="line">    <span class="number">2</span>) 吞吐量在某种程度上被提交率限制</span><br><span class="line">    但是在高旋转延迟的设备上，即使少到只有两个客户端，该设置也能有效提高事务吞吐量。</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/27/sqltuning1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/27/sqltuning1/" class="post-title-link" itemprop="url">not in 和 not exists</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-27 17:38:11 / 修改时间：18:23:22" itemprop="dateCreated datePublished" datetime="2022-10-27T17:38:11+08:00">2022-10-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天发现了一条跑了10分钟都没出结果的语句。好家伙。<br>先做一个执行计划分析<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">explain</span><br><span class="line"><span class="keyword">select</span> a.id, a.title, a.pub_url <span class="keyword">from</span> tbl1 a <span class="keyword">where</span> </span><br><span class="line">a.garbage_sign<span class="operator">=</span><span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.isold_article<span class="operator">=</span><span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.channel_id<span class="operator">=</span><span class="string">&#x27;000116582&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.id <span class="keyword">not</span> <span class="keyword">in</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> article_id <span class="keyword">from</span> tbl2 <span class="keyword">where</span> create_date<span class="operator">&gt;</span><span class="string">&#x27;2022-09-01 00:00:00&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">                                                                QUERY PLAN                                                          </span><br><span class="line">       </span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">-------</span></span><br><span class="line"> Bitmap Heap Scan <span class="keyword">on</span> tbl1 a  (cost<span class="operator">=</span><span class="number">685997.69</span>.<span class="number">.44605189219</span><span class="number">.14</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">121818</span> width<span class="operator">=</span><span class="number">108</span>)</span><br><span class="line">   Recheck Cond: (((channel_id)::text <span class="operator">=</span> <span class="string">&#x27;000116582&#x27;</span>::text) <span class="keyword">AND</span> ((garbage_sign)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::text) <span class="keyword">AND</span> ((isold_article)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::</span><br><span class="line">text))</span><br><span class="line">   <span class="keyword">Filter</span>: (<span class="keyword">NOT</span> (SubPlan <span class="number">1</span>))</span><br><span class="line">   <span class="operator">-</span><span class="operator">&gt;</span>  BitmapAnd  (cost<span class="operator">=</span><span class="number">685997.69</span>.<span class="number">.685997</span><span class="number">.69</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">243636</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> idx_tbl1_chennelid_pubdat  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.10402</span><span class="number">.42</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">262115</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">               Index Cond: ((channel_id)::text <span class="operator">=</span> <span class="string">&#x27;000116582&#x27;</span>::text)</span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> idx_tbl1_link  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.675534</span><span class="number">.11</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">8450463</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">               Index Cond: ((isold_article)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::text)</span><br><span class="line">   SubPlan <span class="number">1</span></span><br><span class="line">     <span class="operator">-</span><span class="operator">&gt;</span>  Materialize  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.363384</span><span class="number">.29</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1106828</span> width<span class="operator">=</span><span class="number">8</span>)</span><br><span class="line">           <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> tbl2  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.353526</span><span class="number">.15</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1106828</span> width<span class="operator">=</span><span class="number">8</span>)</span><br><span class="line">                 <span class="keyword">Filter</span>: (create_date <span class="operator">&gt;</span> <span class="string">&#x27;2022-09-01 00:00:00&#x27;</span>::<span class="type">timestamp</span> <span class="keyword">without</span> <span class="type">time</span> zone)</span><br><span class="line">(<span class="number">12</span> 行记录)</span><br></pre></td></tr></table></figure><br>从上面的执行计划可以看到子查询结果转化成一个100多W 的物化视图再跟tbl1做了一次bitmap。一般这么大的结果集并不是合适用 not in,not in 适合小结果集。<br>而大结果集则可以采用not exists, 改成not exists 来看看执行计划如何<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">explain</span><br><span class="line"><span class="keyword">select</span> a.id, a.title, a.pub_url <span class="keyword">from</span> tbl1 a <span class="keyword">where</span> </span><br><span class="line">a.garbage_sign<span class="operator">=</span><span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.isold_article<span class="operator">=</span><span class="string">&#x27;n&#x27;</span></span><br><span class="line"><span class="keyword">and</span> a.channel_id<span class="operator">=</span><span class="string">&#x27;000116582&#x27;</span></span><br><span class="line"><span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> tbl2 b <span class="keyword">where</span> a.id <span class="operator">=</span> b.article_id <span class="keyword">and</span> b.create_date<span class="operator">&gt;</span><span class="string">&#x27;2022-09-01 00:00:00&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">                                                QUERY PLAN                                                </span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> Hash Anti <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">382148.83</span>.<span class="number">.1149719</span><span class="number">.26</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">213975</span> width<span class="operator">=</span><span class="number">108</span>)</span><br><span class="line">   Hash Cond: ((a.id)::text <span class="operator">=</span> (b.article_id)::text)</span><br><span class="line">   <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Heap Scan <span class="keyword">on</span> tbl1 a  (cost<span class="operator">=</span><span class="number">10463.33</span>.<span class="number">.725582</span><span class="number">.54</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">243636</span> width<span class="operator">=</span><span class="number">108</span>)</span><br><span class="line">         Recheck Cond: (((channel_id)::text <span class="operator">=</span> <span class="string">&#x27;000116582&#x27;</span>::text) <span class="keyword">AND</span> ((garbage_sign)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::text))</span><br><span class="line">         <span class="keyword">Filter</span>: ((isold_article)::text <span class="operator">=</span> <span class="string">&#x27;n&#x27;</span>::text)</span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> idx_tbl1_chennelid_pubdat  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.10402</span><span class="number">.42</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">262115</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">               Index Cond: ((channel_id)::text <span class="operator">=</span> <span class="string">&#x27;000116582&#x27;</span>::text)</span><br><span class="line">   <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">353526.15</span>.<span class="number">.353526</span><span class="number">.15</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1106828</span> width<span class="operator">=</span><span class="number">8</span>)</span><br><span class="line">         <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> tbl2 b  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.353526</span><span class="number">.15</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1106828</span> width<span class="operator">=</span><span class="number">8</span>)</span><br><span class="line">               <span class="keyword">Filter</span>: (create_date <span class="operator">&gt;</span> <span class="string">&#x27;2022-09-01 00:00:00&#x27;</span>::<span class="type">timestamp</span> <span class="keyword">without</span> <span class="type">time</span> zone)</span><br><span class="line">(<span class="number">10</span> 行记录)</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>从上面的执行计划上看已经用的是 Hash Anti Join 而不是 Bitmap Heap Scan。<br>只要4秒多就出结果</p>
<p>在写SQL 时大家要遵循这样一个原则。in ，not in 都适用于子查询是小结果集的。 exists , not exists 则用于子查询是大结果集的<br>关联条件必须具有索引，否则也会慢到你怀疑人生。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/21/pgLogicalReplication/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/21/pgLogicalReplication/" class="post-title-link" itemprop="url">PG逻辑复制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-21 09:57:54" itemprop="dateCreated datePublished" datetime="2022-10-21T09:57:54+08:00">2022-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-27 17:29:09" itemprop="dateModified" datetime="2022-10-27T17:29:09+08:00">2022-10-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h3><p>PG 逻辑复制在9.4 版本开始支持。只是那时使用逻辑复制是以扩展的方式使用，需要额外编译插件，从pg 10开始，<br>我们可以很简单的在数据库中直接创建publication 以及 subcription 的方式来使用逻辑复制。</p>
<h4 id="1-1-逻辑复制与物理复制的区别："><a href="#1-1-逻辑复制与物理复制的区别：" class="headerlink" title="1.1. 逻辑复制与物理复制的区别："></a>1.1. 逻辑复制与物理复制的区别：</h4><pre><code>逻辑复制是基于复制标识（通常是主键）复制数据以及变更的方法
物理复制是基于精确的数据块地址喝逐字节复制的方法
</code></pre><h4 id="1-2-逻辑复制的使用场景"><a href="#1-2-逻辑复制的使用场景" class="headerlink" title="1.2. 逻辑复制的使用场景"></a>1.2. 逻辑复制的使用场景</h4><pre><code>1.可以发送一个库或者一个子集的增量变更数据给订阅者
2.当个别变更到达订阅端时引动触发器
3.基于分析目的的将多个数据库的数据汇总到一个数据库
4.在不同数据库版本之间做复制(一般可用作数据库版本升级)
5.在不同平台的数据中做复制(例如linux 与 windows 之间的PG 的复制)
6.发送不同的数据给不同分组的人员
7.在不同数据库中共享一个子集
</code></pre><p>订阅数据库可以作为发布者创建发布给其他数据库做订阅。订阅数据一般只作为只读。如果对订阅对象写入，有可能会<br>引发冲突。</p>
<h3 id="2-发布"><a href="#2-发布" class="headerlink" title="2. 发布"></a>2. 发布</h3><p>发布可以在任何物理复制主机上创建,有定义发布的节点我们称为发布者。发布是记录一个表或者一组表变更的集合<br>（也称为复制集或者改变集），每一个发布只能存在一个数据库。</p>
<p>发布不同于模式(schema)，不影响表的访问形势。如果需要每个表可以存在于多个发布中，发布目前只能包含表或者模式<br>中的所有表，必须显式添加到发布中。除非在创建发布时使用ALL tables 选项</p>
<p>Publication可以选择把它们产生的更改限制为INSERT、UPDATE、DELETE以及TRUNCATE的任意组合，类似于触发器如何<br>被特定事件类型触发的方式。默认情况下，所有操作类型都会被复制</p>
<p>每一个发布表都有一个复制标识，一般是主键，或者是唯一键，如果都没有那么将标识为full ，即整行作为复制标识</p>
<h4 id="2-1-创建发布"><a href="#2-1-创建发布" class="headerlink" title="2.1. 创建发布"></a>2.1. 创建发布</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span><span class="operator">+</span> 版本</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION name</span><br><span class="line">    [ <span class="keyword">FOR</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">      <span class="operator">|</span> <span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES ]</span><br><span class="line">    [ <span class="keyword">WITH</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"></span><br><span class="line"><span class="number">15</span><span class="operator">+</span> 版本   </span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION name</span><br><span class="line">    [ <span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES</span><br><span class="line">      <span class="operator">|</span> <span class="keyword">FOR</span> publication_object [, ... ] ]</span><br><span class="line">    [ <span class="keyword">WITH</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">where</span> publication_object <span class="keyword">is</span> <span class="keyword">one</span> <span class="keyword">of</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [ ( column_name [, ... ] ) ] [ <span class="keyword">WHERE</span> ( expression ) ] [, ... ]</span><br><span class="line">    TABLES <span class="keyword">IN</span> SCHEMA &#123; schema_name <span class="operator">|</span> <span class="built_in">CURRENT_SCHEMA</span> &#125; [, ... ]</span><br><span class="line"></span><br><span class="line">释义</span><br><span class="line">name </span><br><span class="line">    发布名</span><br><span class="line"></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">TABLE</span> </span><br><span class="line">    指定要被添加到发布的表列表，如果指定<span class="keyword">ONLY</span> 则只有<span class="keyword">ONLY</span> 后面那个表添加进去,没有指定则列表全部添加。</span><br><span class="line">    如果表名后加 <span class="operator">*</span> ，则这个表的所有派生表都将被添加（PG 存在表继承）,但分区表不适用，分区表的分区都会作为发布的一部分，不用在创建发布时指定。 </span><br><span class="line">    表名后面加 (列名,...) 只有指定的列会被发布，没有指定则发布表的所有字段，包含以后新建的所有字段。</span><br><span class="line">    <span class="keyword">where</span> 表达式则是过滤满足条件的数据才会被发布</span><br><span class="line">    <span class="keyword">TABLE</span> <span class="keyword">IN</span> SCHEMA(<span class="number">15</span><span class="operator">+</span> 版本)，可以直接指定摸个模式下所有表添加，包含以后建的新表。相比<span class="keyword">ALL</span> TABLES ，复制粒度更小。更灵活</span><br><span class="line">    只有普通表，分区表(<span class="number">13</span><span class="operator">+</span> 版本)才能放在发布中,临时表，非日志记录表，外部表，物化视图，以及普通视图都不能放在发布中</span><br><span class="line"></span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES </span><br><span class="line">    指定将数据库里是所有表都添加到发布中去。包含以后建的新表</span><br><span class="line"></span><br><span class="line"><span class="keyword">WITH</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">    publish (string) </span><br><span class="line">        指定限制发布DML，可以是  <span class="string">&#x27;insert, update, delete, truncate&#x27;</span> 的任意组合(<span class="keyword">truncate</span> <span class="number">11</span><span class="operator">+</span> 版本支持)，默认<span class="number">4</span>种全部发布</span><br><span class="line">    publish_via_partition_root (<span class="type">boolean</span>) (<span class="number">13</span><span class="operator">+</span> 版本) </span><br><span class="line">        这个参数决定当分区表或者在其分区上的变更是在模式中是使用一个标识还是那个变更的分区表做标识，默认是变更的分区表做标志,启用这个选项，将允许</span><br><span class="line">        分区表变更能被复制到同名的非分区表或分区表中。</span><br><span class="line">        当它被启用。作用于分区上的<span class="keyword">truncate</span> 操作将不会被复制</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">注意</span><br><span class="line">    如果 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> 或者 <span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES 没有设置，发布启动时带一个空表集，以后添加表时会添加到这个表集中</span><br><span class="line">    创建发布并没有马上启动复制。它只是为以后的订阅者定义了一个组和一些过滤逻辑</span><br><span class="line">    创建发布的用户必须在当前数据库中具备<span class="keyword">create</span> 权限 （super 用户会忽略这个检查）</span><br><span class="line">    将表添加到发布中，用户必须具备该表的所有权。<span class="keyword">FOR</span> <span class="keyword">ALL</span> TABLES 则要求用户具有SUPER权限</span><br><span class="line">    添加到发布<span class="keyword">UPDATE</span><span class="operator">/</span><span class="keyword">DELETE</span>操作的表必须已经定义了复制标识,否则将在这些标识禁用这些操作</span><br><span class="line">    对于<span class="keyword">insert</span> ... <span class="keyword">on</span> conflict命令，发布是以实际发生的数据变更发布的，因此根据结果。可能是<span class="keyword">insert</span> 也可能是<span class="keyword">update</span> 。也可能不发布</span><br><span class="line">    对于 <span class="keyword">copy</span> ... <span class="keyword">from</span> 命令是作为<span class="keyword">insert</span> 发布的</span><br><span class="line">    DDL 操作不发布</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">示例</span><br><span class="line">#创建一个发布,包含<span class="number">2</span>个表的变更</span><br><span class="line"><span class="keyword">create</span> publication my_pub <span class="keyword">for</span> <span class="keyword">table</span> table1,table2;</span><br><span class="line"></span><br><span class="line">#创建一个发布，包含所有报的变更</span><br><span class="line"><span class="keyword">create</span> publication my_pub <span class="keyword">for</span> <span class="keyword">all</span> tables;</span><br><span class="line"></span><br><span class="line">#创建一个发布，包含指定DML</span><br><span class="line"><span class="keyword">create</span> publication my_pub <span class="keyword">for</span> <span class="keyword">table</span> <span class="keyword">with</span> publish(<span class="string">&#x27;delete,update&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h4 id="2-2-修改发布"><a href="#2-2-修改发布" class="headerlink" title="2.2. 修改发布"></a>2.2. 修改发布</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#为发布添加表</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">ADD</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">#替换发布中的表的列表</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">SET</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">#删除发布中的表</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">DROP</span> <span class="keyword">TABLE</span> [ <span class="keyword">ONLY</span> ] table_name [ <span class="operator">*</span> ] [, ...]</span><br><span class="line">#修改发布中的发布属性</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name <span class="keyword">SET</span> ( publication_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">#修改发布的所有者</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name OWNER <span class="keyword">TO</span> &#123; new_owner <span class="operator">|</span> <span class="built_in">CURRENT_USER</span> <span class="operator">|</span> <span class="built_in">SESSION_USER</span> &#125;</span><br><span class="line">#为发布重命名</span><br><span class="line"><span class="keyword">ALTER</span> PUBLICATION name RENAME <span class="keyword">TO</span> new_name</span><br><span class="line"></span><br><span class="line">## 示例</span><br><span class="line"><span class="keyword">alter</span> publicaiton my_pub <span class="keyword">set</span> (publish <span class="operator">=</span> <span class="string">&#x27;insert,update&#x27;</span>)</span><br><span class="line"><span class="keyword">alter</span> publication my_pub <span class="keyword">add</span> tab2,tab3;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-删除发布"><a href="#2-3-删除发布" class="headerlink" title="2.3. 删除发布"></a>2.3. 删除发布</h4><p>发布只能被发布的所有者及超级用户删除<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> PUBLICATION [ IF <span class="keyword">EXISTS</span> ] name [, ...] [ CASCADE <span class="operator">|</span> RESTRICT ]</span><br><span class="line"></span><br><span class="line">## 示例</span><br><span class="line"><span class="keyword">drop</span> publication my_pub;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-订阅"><a href="#3-订阅" class="headerlink" title="3. 订阅"></a>3. 订阅</h3><p>订阅位于逻辑复制的下游，创建有订阅的节点称为订阅者。订阅定义了与另一个数据库的连接以及需要订阅的的发布集（一个或多个发布）<br>订阅节点上可以有多个订阅，每一个订阅接收一个复制槽（replication slot）的数据变更。当初始化好同步表以前存在的数据时，可能额外需要多的复制槽。并且在同步结束后删除。<br>逻辑复制的订阅可作为同步复制的备用服务器，备用名默认为订阅名，可以在订阅的连接信息中用application_name指定一个可供选择的名称<br>创建订阅的用户需要super 权限，因为non-superusers不能读取pg_subscription的信息<br>create subscription 用于创建订阅 alter subscription 用于停止和复用订阅，drop subscription 则用于删除订阅。<br>当订阅被删除并重新创建时，同步信息将丢失，这意味着数据必须重新同步<br>模式定义不会被复制,发布的表必须在订阅端存在。<br>发布与订阅端的表必须同名。不支持不同名表订阅<br>发布与订阅端的表的字段名必须相同，订阅端表列的顺序不要求与发布端相同，列的数据类型也不需要一样，只要可以将数据的文本表示形式转换为目标类型即可。订阅端表列可以比发布端<br>多，多出的列将以订阅端表的定义默认值填充</p>
<h4 id="3-1-复制槽管理"><a href="#3-1-复制槽管理" class="headerlink" title="3.1 复制槽管理"></a>3.1 复制槽管理</h4><p>如上面说的。在表初始化开始同步数据时，会要求额外的复制槽—数据同步槽，数据同步槽又系统内部自动创建，并在不需要时自动<br>删除。数据同步槽名称为“pg<em>%u_sync</em>%u_%llu”，参数为：订阅oid, 表的relid,系统标识sysid<br>一般情况下。远端的复制槽的创建在订阅创建（create subscription）的时候创建，并且在删除订阅(drop subscription)的时候删除,在某些情况下有必要单独操纵订阅以及其底层的复制槽。</p>
<h5 id="下面是一些场景："><a href="#下面是一些场景：" class="headerlink" title="下面是一些场景："></a>下面是一些场景：</h5><pre><code>1.在创建一个订阅时，复制槽已经存在。在这种情况下，可以使用create_slot = false选项创建订阅并关联到现有的槽
2.在创建一个订阅时，远程主机不可达或者处于一种不明状态。在这种情况下，可以使用connect = false选项创建订阅。那么远程主机将根本不会被联系。
  这是pg_dump所使用的方式。这样，在订阅可以被激活之前，必须手工创建远程复制槽
3.在删除一个订阅时，复制槽应该被保留。当订阅者数据库正在被移动到一台不同的主机并且将从那里再被激活时，这种行为很有用。在这种情况下，可以在尝试删除该订阅之前，
  使用ALTER SUBSCRIPTION将复制槽解除关联
4.在删除一个订阅是，远程主机不可达。在这种情况下，可以在尝试删除该订阅之前，使用ALTER SUBSCRIPTION将复制槽解除关联。如果远程数据库实例不再存在，那么不需要进一步的行动。
  不过，如果远程数据库实例只是不可达，那么复制槽应该被手动删除。否则它将会继续保留WAL并且最终可能会导致磁盘被填满。这种情况应该要仔细地研究
</code></pre><h4 id="3-2-创建订阅"><a href="#3-2-创建订阅" class="headerlink" title="3.2 创建订阅"></a>3.2 创建订阅</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION subscription_name</span><br><span class="line">    CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line">    PUBLICATION publication_name [, ...]</span><br><span class="line">    [ <span class="keyword">WITH</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"></span><br><span class="line">subscription_name</span><br><span class="line">    订阅名</span><br><span class="line">CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line">    连接远端发布节点的连接串</span><br><span class="line">PUBLICATION publication_name</span><br><span class="line">    发布名称,可以指定多个发布名称。也即是一个订阅可以订阅多个发布</span><br><span class="line"><span class="keyword">WITH</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">    指定订阅相关参数</span><br><span class="line">    <span class="keyword">connect</span> (<span class="type">boolean</span>)</span><br><span class="line">        指定创建订阅时是否连接远程发布节点，默认<span class="literal">true</span>,设置为<span class="literal">false</span> ,会强制设置 create_slot , enabled , copy_data 这<span class="number">3</span>个参数值为 <span class="literal">false</span></span><br><span class="line">        当该参数设置为<span class="literal">false</span> ，没有表会被订阅，当enable 订阅时，不会发生任何复制，必须执行<span class="keyword">ALTER</span> SUBSCRIPTION ... REFRESH PUBLICATION 才能使表订阅生效</span><br><span class="line">    create_slot (<span class="type">boolean</span>) </span><br><span class="line">        指定是否在发布节点上创建复制槽，默认值<span class="literal">true</span>, 如果设置为<span class="literal">false</span> ,你将需要通过别的方法在发布节点上创建复制槽</span><br><span class="line">    enabled (<span class="type">boolean</span>) </span><br><span class="line">        指定订阅是否马上生效，默认 <span class="literal">true</span> ,设置<span class="literal">false</span> 则只是创建并没有让复制生效</span><br><span class="line">    slot_name (string)</span><br><span class="line">        指定发布节点上复制槽的名称，默认值是将订阅的名称当做复制槽的名称</span><br><span class="line">        设置为<span class="keyword">NONE</span> 将表示订阅不创建复制槽，当你想稍后手工创建复制槽可使用该选项。同时必须设置create_slot，slot_name 的值为<span class="literal">false</span></span><br><span class="line">    #下面的参数则是控制订阅创建后的行为：</span><br><span class="line">    <span class="type">binary</span> (<span class="type">boolean</span>) (<span class="number">14</span><span class="operator">+</span> 版本)</span><br><span class="line">        指定订阅是否要求发布者发送数据采用<span class="type">binary</span> 格式（相对应的是text），默认值为<span class="literal">false</span>,如果设置为<span class="literal">true</span>,也只有具有二进制发送和接收功能的数据类型才会以二进制形式传输。</span><br><span class="line">        在进行跨版本复制时，可能会因为发布者具有某种数据类型的二进制发送功能，而订阅者缺少该类型的二进制接收功能导致数据传输将失败，并且无法使用二进制选项。</span><br><span class="line">    copy_data (<span class="type">boolean</span>)</span><br><span class="line">        指定是否在订阅开始时同步发布表中已存在的数据，默认值为<span class="literal">true</span></span><br><span class="line">        如果创建发布时有指定<span class="keyword">where</span> 条件，则满足条件的数据才会被发布过来</span><br><span class="line">    streaming (<span class="type">boolean</span>) （<span class="number">14</span><span class="operator">+</span> 版本)</span><br><span class="line">        指定是否为订阅开启正在进行中的事务中进行流传输。默认情况下所有事务都在发布端解码。然后才整个完整的发布给订阅</span><br><span class="line">    synchronous_commit (enum)</span><br><span class="line">        该参数会覆盖系统参数 synchronous_commit</span><br><span class="line">        设置为off 对 逻辑复制是安全的：如果订阅因为缺少同步而丢失的事务。发布者将会从新发布</span><br><span class="line">        在进行同步逻辑复制时，逻辑复制worker 将持续向发布者报告写入和刷新的位置，发布者则等待实际的刷新，这意味着订阅端设置synchronous_commit<span class="operator">=</span>off 将会增加发布端<span class="keyword">commit</span> 的延迟，</span><br><span class="line">        这种情况下设置为<span class="keyword">local</span> 或更高级别将会更合适</span><br><span class="line">    two_phase (<span class="type">boolean</span>) (<span class="number">15</span><span class="operator">+</span> 版本)</span><br><span class="line">        指定订阅是否启用两阶段提交，默认值<span class="literal">false</span></span><br><span class="line">        当启用两阶段提交，准备好的事务将会在 <span class="keyword">prepare</span> tansaction 阶段时就传给订阅者，在订阅者上也当做<span class="number">2</span>阶段处理。否则准备好的事务只有在提交时才会发送给订阅者。然后由订阅者立即处理</span><br><span class="line">        两阶段提交的实现要求复制已成功完成初始表同步阶段。 因此，即使为订阅启用了 two_phase，内部的两阶段状态也会暂时保持“待定”，直到初始化阶段完成。 查看 pg_subscription 的 subtwophasestate 列，了解实际的两阶段状态</span><br><span class="line">    disable_on_error (<span class="type">boolean</span>)</span><br><span class="line">        指定如果订阅工作者在从发布者复制数据期间检测到任何错误，是否应自动禁用订阅。 默认为<span class="literal">false</span>      </span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">    #创建一个订阅，并且不马上激活</span><br><span class="line">    <span class="keyword">CREATE</span> SUBSCRIPTION mysub</span><br><span class="line">         CONNECTION <span class="string">&#x27;host=192.168.1.50 port=5432 user=foo dbname=foodb&#x27;</span></span><br><span class="line">        PUBLICATION insert_only</span><br><span class="line">               <span class="keyword">WITH</span> (enabled <span class="operator">=</span> <span class="literal">false</span>);</span><br><span class="line">    #创建一个有<span class="number">2</span>个发布的订阅</span><br><span class="line">    <span class="keyword">CREATE</span> SUBSCRIPTION mysub</span><br><span class="line">         CONNECTION <span class="string">&#x27;host=192.168.1.50 port=5432 user=foo dbname=foodb&#x27;</span></span><br><span class="line">        PUBLICATION mypublication, insert_only;    </span><br></pre></td></tr></table></figure>
<h4 id="3-3-注意："><a href="#3-3-注意：" class="headerlink" title="3.3 注意："></a>3.3 注意：</h4><pre><code>不能在事务块中执行带创建复制槽行为的CREATE SUBSCRIPTION.
创建订阅时带创建复制槽的行为在相同的数据库集群（集群内不同的数据库之间，或者同个数据库之间）都会导致创建行为挂起.除非是创建时指定不创建复制槽，如果想实现集群中不同库复制行为， 首先应该通过插件pgoutput，使用其函数pg_create_logical_replication_slot先创建复制槽。然后再创建复制时指定 create_slot=false。这种限制性定义，可能会在未来的版本中取消
任何在发布中带where限制的表。其中不匹配的行或者空数据都会被发布,如果一个订阅有多个发布者，并且其中一个表有多个带where的发布，只要所有发布where条件任何一个成立，那一行会被发布。如果其中一个发布者没有带where条件或者采用了 ALL TABLE 或者 ALL TABLE IN SCHEMA,则表的每一行都始终发布，不管其他定义如何。而在15 版本以前，where定义在初始化同步表数据阶段将被忽略,这种情况下，用户需在初始化同步后自行删除不匹配的行。
订阅者有关联多个发布的，每个发布者同一个表的列必须相同。不支持不相同列的集合
允许使用不存在的发布，
</code></pre><h4 id="3-4-修改订阅"><a href="#3-4-修改订阅" class="headerlink" title="3.4 修改订阅"></a>3.4 修改订阅</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SET</span> PUBLICATION publication_name [, ...] [ <span class="keyword">WITH</span> ( publication_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">ADD</span> PUBLICATION publication_name [, ...] [ <span class="keyword">WITH</span> ( publication_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">DROP</span> PUBLICATION publication_name [, ...] [ <span class="keyword">WITH</span> ( publication_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name REFRESH PUBLICATION [ <span class="keyword">WITH</span> ( refresh_option [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] ) ]</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name ENABLE</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name DISABLE</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SET</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SKIP</span> ( skip_option <span class="operator">=</span> <span class="keyword">value</span> )</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name OWNER <span class="keyword">TO</span> &#123; new_owner <span class="operator">|</span> <span class="built_in">CURRENT_ROLE</span> <span class="operator">|</span> <span class="built_in">CURRENT_USER</span> <span class="operator">|</span> <span class="built_in">SESSION_USER</span> &#125;</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION name RENAME <span class="keyword">TO</span> new_name</span><br><span class="line">注意：</span><br><span class="line">修改订阅能修改创建订阅时设置的大部分属性</span><br><span class="line">关于权限问题。目前的订阅都是superuser 所以所有者检查将会被忽略。未来的版本可能改变这个问题</span><br><span class="line">当刷新发布的时候，将会移除那些不属于发布者的关系，如果有同步复制槽，同时删除同步复制槽，以便释放订阅在远端服务器分配的资源</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION ... REFRESH PUBLICATION 和  <span class="keyword">ALTER</span> SUBSCRIPTION ... &#123;<span class="keyword">SET</span><span class="operator">|</span><span class="keyword">ADD</span><span class="operator">|</span><span class="keyword">DROP</span>&#125; PUBLICATION ... <span class="keyword">with</span> refresh option <span class="keyword">as</span> <span class="literal">true</span> 句式不能在事务块中执行</span><br><span class="line">也不能用于设置了两阶段提交的订阅(two_phase <span class="operator">=</span><span class="literal">true</span>),除了copy_data<span class="operator">=</span><span class="literal">false</span>,可以了在视图pg_subscription的subtwophasestate字段查看两阶段提交实际状态</span><br><span class="line">参数说明：</span><br><span class="line">name</span><br><span class="line">    订阅的名称</span><br><span class="line">CONNECTION <span class="string">&#x27;conninfo&#x27;</span></span><br><span class="line">    连接发布节点的数据库连接串</span><br><span class="line"><span class="keyword">SET</span> PUBLICATION publication_name</span><br><span class="line"><span class="keyword">ADD</span> PUBLICATION publication_name</span><br><span class="line"><span class="keyword">DROP</span> PUBLICATION publication_name</span><br><span class="line">    这<span class="number">3</span>个句式是改变订阅的发布列表。<span class="keyword">SET</span> 是替换 ，<span class="keyword">ADD</span> 是添加 ，<span class="keyword">DROP</span> 则是删除，默认情况下这些操作也像 REFRESH PUBLICATION</span><br><span class="line">    publication_option 选项是 refresh ,默认值是<span class="literal">true</span> ,修改为<span class="literal">false</span> 则不刷新发布表信息，REFRESH PUBLICATION 需另外执行</span><br><span class="line">REFRESH PUBLICATION</span><br><span class="line">    在发布者获取缺失的表信息，这将添加从创建复制开始或从上一次REFRESH PUBLICATION之后的所有新增的表的复制</span><br><span class="line">    refresh_option： copy_data (<span class="type">boolean</span>) 是否将同步已存在的的表数据</span><br><span class="line">ENABLE</span><br><span class="line">    激活被禁用的订阅</span><br><span class="line">DISABLE</span><br><span class="line">    禁用活动的订阅</span><br><span class="line"><span class="keyword">SET</span> ( subscription_parameter [<span class="operator">=</span> <span class="keyword">value</span>] [, ... ] )</span><br><span class="line">    修改在创建订阅时指定的参数值(slot_name, synchronous_commit, <span class="type">binary</span>, streaming, <span class="keyword">and</span> disable_on_error)</span><br><span class="line"><span class="keyword">SKIP</span> ( skip_option <span class="operator">=</span> <span class="keyword">value</span> )</span><br><span class="line">    跳过远程事务的修改，当传入的数据违反了任何约束。逻辑复制将停止，直到解决。通过<span class="keyword">ALTER</span> SUBSCRIPTION name <span class="keyword">SKIP</span> 命令可以时复制worker跳过事务中所有数据的修改，</span><br><span class="line">    此选项对启动两阶段提交的订阅者上已经准备好的事务没有影响。逻辑复制worker成功跳过事务或完成事务后，LSN(存储在pg_subscription.subskiplsn)将被清除</span><br><span class="line">    skip_option： LSN, 指定逻辑复制worker将跳过其更改的远程事务的完成 LSN。 完成 LSN 是提交或准备事务的 LSN。 不支持跳过单个子事务。 设置 <span class="keyword">NONE</span> 会重置 LSN。</span><br><span class="line">new_owner</span><br><span class="line">    为订阅指定新的所有者</span><br><span class="line">new_name</span><br><span class="line">    修改订阅的名字</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">    #重新设置订阅的发布列表</span><br><span class="line">    <span class="keyword">ALTER</span> SUBSCRIPTION mysub <span class="keyword">SET</span> PUBLICATION insert_only;</span><br><span class="line">    #禁用订阅</span><br><span class="line">    <span class="keyword">ALTER</span> SUBSCRIPTION mysub DISABLE;</span><br></pre></td></tr></table></figure>
<h4 id="3-5-删除订阅"><a href="#3-5-删除订阅" class="headerlink" title="3.5 删除订阅"></a>3.5 删除订阅</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> SUBSCRIPTION [ IF <span class="keyword">EXISTS</span> ] name [ CASCADE <span class="operator">|</span> RESTRICT </span><br><span class="line">删除订阅，订阅只能被superuser 删除，不能在事务块中执行删除带有复制槽的订阅</span><br><span class="line">参数说明：</span><br><span class="line">name</span><br><span class="line">    订阅名称</span><br><span class="line">CASCADE</span><br><span class="line">RESTRICT</span><br><span class="line">    这些关键词没有任何作用，因为订阅没有依赖关系。</span><br><span class="line"></span><br><span class="line">注意:</span><br><span class="line">     当删除带复制槽的订阅时，删除命令会连接远端发布节点去删除复制槽。这是很有必要的，远端为订阅分配的资源将能得到释放.如果远端节点不可达或者远端节点上的复制槽没法被删除，</span><br><span class="line">     或者复制槽在远端不存在，或者未曾存在过，都将导致删除命令失败退出。这种情况下。可以通过 <span class="keyword">ALTER</span> SUBSCRIPTION ... <span class="keyword">SET</span> (slot_name <span class="operator">=</span> <span class="keyword">NONE</span>)，然后再删除订阅，这种操作</span><br><span class="line">     将不会去远端执行删除复制槽。但请注意远端的复制槽并没有被删除，需要手工去删除复制槽。如果不删除。会导致远端节点一直保留等待被复制的WAL ，存在磁盘空间被耗尽的风险。</span><br><span class="line"></span><br><span class="line">eg:</span><br><span class="line">    <span class="keyword">DROP</span> SUBSCRIPTION mysub;</span><br></pre></td></tr></table></figure>
<h3 id="4-行过滤（15-版本"><a href="#4-行过滤（15-版本" class="headerlink" title="4. 行过滤（15+ 版本)"></a>4. 行过滤（15+ 版本)</h3><h4 id="4-1-行过滤规则"><a href="#4-1-行过滤规则" class="headerlink" title="4.1 行过滤规则"></a>4.1 行过滤规则</h4><pre><code>行过滤发送在发布者发布数据之前，不符合条件或者对应列为空的数据将不会被复制，行过滤器对truncate 无效
</code></pre><h4 id="4-2-表达式限制"><a href="#4-2-表达式限制" class="headerlink" title="4.2 表达式限制"></a>4.2 表达式限制</h4><pre><code>WHERE 子句只允许简单的表达式。 它不能包含用户定义的函数、运算符、类型和排序规则、系统列引用或非不可变的内置函数，如果是发布UPDATE/DELETE 操作，则条件中必须
包含复制标识列(主键,唯一键)，如果是INSERT 则where 条件可以是任何列
</code></pre><h4 id="4-3-UPDATE操作在行过滤中的转换"><a href="#4-3-UPDATE操作在行过滤中的转换" class="headerlink" title="4.3 UPDATE操作在行过滤中的转换"></a>4.3 UPDATE操作在行过滤中的转换</h4><pre><code>每一个UPDATE 操作,都会对旧行以及新行进行where条件匹配。如果新旧行都不匹配则不复制。如果旧行匹配，新行匹配则INSERT,如果旧行匹配，新行不匹配
则DELETE,如果新旧行都匹配则UPDATE.如下图1示
</code></pre><p>图1<br><img src="/images/UpdateTransformation.png" alt="UpdateTrans">   </p>
<h4 id="4-4-行过滤在分区表的行为"><a href="#4-4-行过滤在分区表的行为" class="headerlink" title="4.4 行过滤在分区表的行为"></a>4.4 行过滤在分区表的行为</h4><pre><code>publish_via_partition_root 参数将决定行过滤的行为，如果设置为true 则使用根分区表的行过滤器。如果设置为false ，则使用每个分区的行过滤器 
</code></pre><h4 id="4-5-初始化数据同步行为"><a href="#4-5-初始化数据同步行为" class="headerlink" title="4.5 初始化数据同步行为"></a>4.5 初始化数据同步行为</h4><pre><code>如果订阅要求同步已存在的数据，并且发布包含where 过滤，只有匹配的行才会发送给订阅
如果订阅者同时订阅有多个发布，只要满足任何一个where 过滤的行都会被发送给订阅
(上面提到过如果订阅者是15版本以前的版本，在初始化数据时不会对已存在数据做行过滤)
</code></pre><h4 id="4-6-绑定多行过滤"><a href="#4-6-绑定多行过滤" class="headerlink" title="4.6 绑定多行过滤"></a>4.6 绑定多行过滤</h4><pre><code>订阅者同时订阅多个发布，并且这些发布在同一个表上都包含where 过滤器，对于每一行数据,通过OR运算对每个过滤器进行匹配。只要满足其中一个则成立，
那么遇到以下情况，则过滤器将变得多余
1.其中一个发布者没有包含过滤器
2.其中一个发布者在创建时使用了FOR ALL TABLE 子句。这种不允许包含过滤行为
3.其中一个发布者在创建时使用了FOR ALL TABLES IN SCHEMA,并且这个表在定义的schema 里面，这种也不允许包含过滤行为
</code></pre><h4 id="4-7-示例"><a href="#4-7-示例" class="headerlink" title="4.7 示例"></a>4.7 示例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><span class="line"># 在发布节点上创建测试表</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(a <span class="type">int</span>, b <span class="type">int</span>, c text, <span class="keyword">PRIMARY</span> KEY(a,c));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t2(d <span class="type">int</span>, e <span class="type">int</span>, f <span class="type">int</span>, <span class="keyword">PRIMARY</span> KEY(d));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t3(g <span class="type">int</span>, h <span class="type">int</span>, i <span class="type">int</span>, <span class="keyword">PRIMARY</span> KEY(g));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 在发布节点上创建带行过滤的发布</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p1 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t1 <span class="keyword">WHERE</span> (a <span class="operator">&gt;</span> <span class="number">5</span> <span class="keyword">AND</span> c <span class="operator">=</span> <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p2 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t1, t2 <span class="keyword">WHERE</span> (e <span class="operator">=</span> <span class="number">99</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p3 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t2 <span class="keyword">WHERE</span> (d <span class="operator">=</span> <span class="number">10</span>), t3 <span class="keyword">WHERE</span> (g <span class="operator">=</span> <span class="number">10</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line"># 在psql 中 通过 \dRp<span class="operator">+</span> 展示所有的行过滤器</span><br><span class="line">test_pub<span class="operator">=</span># \dRp<span class="operator">+</span></span><br><span class="line">                               Publication p1</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t1&quot; <span class="keyword">WHERE</span> ((a <span class="operator">&gt;</span> <span class="number">5</span>) <span class="keyword">AND</span> (c <span class="operator">=</span> <span class="string">&#x27;NSW&#x27;</span>::text))</span><br><span class="line"></span><br><span class="line">                               Publication p2</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t1&quot;</span><br><span class="line">    &quot;public.t2&quot; <span class="keyword">WHERE</span> (e <span class="operator">=</span> <span class="number">99</span>)</span><br><span class="line"></span><br><span class="line">                               Publication p3</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t2&quot; <span class="keyword">WHERE</span> (d <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line">    &quot;public.t3&quot; <span class="keyword">WHERE</span> (g <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"># 也可以通过\d 表名的方式查看某个表上的行过滤器</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># \d t1</span><br><span class="line">                 <span class="keyword">Table</span> &quot;public.t1&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> a      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"> b      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"> c      <span class="operator">|</span> text    <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line">Indexes:</span><br><span class="line">    &quot;t1_pkey&quot; <span class="keyword">PRIMARY</span> KEY, btree (a, c)</span><br><span class="line">Publications:</span><br><span class="line">    &quot;p1&quot; <span class="keyword">WHERE</span> ((a <span class="operator">&gt;</span> <span class="number">5</span>) <span class="keyword">AND</span> (c <span class="operator">=</span> <span class="string">&#x27;NSW&#x27;</span>::text))</span><br><span class="line">    &quot;p2&quot;</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># \d t2</span><br><span class="line">                 <span class="keyword">Table</span> &quot;public.t2&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> d      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"> e      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"> f      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line">Indexes:</span><br><span class="line">    &quot;t2_pkey&quot; <span class="keyword">PRIMARY</span> KEY, btree (d)</span><br><span class="line">Publications:</span><br><span class="line">    &quot;p2&quot; <span class="keyword">WHERE</span> (e <span class="operator">=</span> <span class="number">99</span>)</span><br><span class="line">    &quot;p3&quot; <span class="keyword">WHERE</span> (d <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># \d t3</span><br><span class="line">                 <span class="keyword">Table</span> &quot;public.t3&quot;</span><br><span class="line"> <span class="keyword">Column</span> <span class="operator">|</span>  Type   <span class="operator">|</span> <span class="keyword">Collation</span> <span class="operator">|</span> Nullable <span class="operator">|</span> <span class="keyword">Default</span></span><br><span class="line"><span class="comment">--------+---------+-----------+----------+---------</span></span><br><span class="line"> g      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="operator">|</span></span><br><span class="line"> h      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line"> i      <span class="operator">|</span> <span class="type">integer</span> <span class="operator">|</span>           <span class="operator">|</span>          <span class="operator">|</span></span><br><span class="line">Indexes:</span><br><span class="line">    &quot;t3_pkey&quot; <span class="keyword">PRIMARY</span> KEY, btree (g)</span><br><span class="line">Publications:</span><br><span class="line">    &quot;p3&quot; <span class="keyword">WHERE</span> (g <span class="operator">=</span> <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在订阅节点上 创建一个与发布节点上相同结构的表 t1，并且创建订阅 s1 ，订阅发布p1</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(a <span class="type">int</span>, b <span class="type">int</span>, c text, <span class="keyword">PRIMARY</span> KEY(a,c));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> SUBSCRIPTION s1</span><br><span class="line">test_sub<span class="operator">-</span># CONNECTION <span class="string">&#x27;host=localhost dbname=test_pub application_name=s1&#x27;</span></span><br><span class="line">test_sub<span class="operator">-</span># PUBLICATION p1;</span><br><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line"># 在发布节点上为表t1 插入一些数据，这时我们能看到满足p1 过滤条件的数据复制到订阅节点上了</span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">102</span>, <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">103</span>, <span class="string">&#x27;QLD&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">104</span>, <span class="string">&#x27;VIC&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">105</span>, <span class="string">&#x27;ACT&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="number">106</span>, <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="number">107</span>, <span class="string">&#x27;NT&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="number">108</span>, <span class="string">&#x27;QLD&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="number">109</span>, <span class="string">&#x27;NSW&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">2</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line"> <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">106</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line"> <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">106</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#更新一些数据，更新的旧行与新行都满足p1的过滤条件，这个时候<span class="keyword">UPDATE</span> 操作 正常的复制到订阅节点上</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> b <span class="operator">=</span> <span class="number">999</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">1</span></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">2</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line"> <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line"> <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line"> <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line"> a <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">---+-----+-----</span></span><br><span class="line"> <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">#再更新一些数据，使旧行不满足p1过滤条件，而新行满足过滤条件，这个时候<span class="keyword">UPDATE</span> 操作变为<span class="keyword">INSERT</span> 操作复制到订阅节点上</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> a <span class="operator">=</span> <span class="number">555</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line">   <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line">   <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line">   <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> NSW</span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 再更新一些数据使旧行满足p1过滤条件，而新行不满足，这个时候<span class="keyword">UPDATE</span> 操作变为<span class="keyword">DELETE</span> 操作复制到订阅节点上</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">UPDATE</span> t1 <span class="keyword">SET</span> c <span class="operator">=</span> <span class="string">&#x27;VIC&#x27;</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">9</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">##发布节点</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">3</span> <span class="operator">|</span> <span class="number">103</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">4</span> <span class="operator">|</span> <span class="number">104</span> <span class="operator">|</span> VIC</span><br><span class="line">   <span class="number">5</span> <span class="operator">|</span> <span class="number">105</span> <span class="operator">|</span> ACT</span><br><span class="line">   <span class="number">7</span> <span class="operator">|</span> <span class="number">107</span> <span class="operator">|</span> NT</span><br><span class="line">   <span class="number">8</span> <span class="operator">|</span> <span class="number">108</span> <span class="operator">|</span> QLD</span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">   <span class="number">9</span> <span class="operator">|</span> <span class="number">109</span> <span class="operator">|</span> VIC</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">##订阅节点</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1;</span><br><span class="line">  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c</span><br><span class="line"><span class="comment">-----+-----+-----</span></span><br><span class="line">   <span class="number">6</span> <span class="operator">|</span> <span class="number">999</span> <span class="operator">|</span> NSW</span><br><span class="line"> <span class="number">555</span> <span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span> NSW</span><br><span class="line">(<span class="number">2</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#####下面是分区表行过滤的示例</span><br><span class="line"></span><br><span class="line"># 发布节点上创建分区表主parent,以及分区表子表child</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> parent(a <span class="type">int</span> <span class="keyword">PRIMARY</span> KEY) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(a);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child <span class="keyword">PARTITION</span> <span class="keyword">OF</span> parent <span class="keyword">DEFAULT</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 相同的表结构在订阅节点上也创建</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> parent(a <span class="type">int</span> <span class="keyword">PRIMARY</span> KEY) <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(a);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child <span class="keyword">PARTITION</span> <span class="keyword">OF</span> parent <span class="keyword">DEFAULT</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 发布节点上创建条件发布p4,订阅节点创建订阅s4，订阅p4的发布，并且设置 publish_via_partition_root <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p4 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> parent <span class="keyword">WHERE</span> (a <span class="operator">&lt;</span> <span class="number">5</span>), child <span class="keyword">WHERE</span> (a <span class="operator">&gt;=</span> <span class="number">5</span>)</span><br><span class="line">test_pub<span class="operator">-</span># <span class="keyword">WITH</span> (publish_via_partition_root<span class="operator">=</span><span class="literal">true</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> SUBSCRIPTION s4</span><br><span class="line">test_sub<span class="operator">-</span># CONNECTION <span class="string">&#x27;host=localhost dbname=test_pub application_name=s4&#x27;</span></span><br><span class="line">test_sub<span class="operator">-</span># PUBLICATION p4;</span><br><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line"># 发布节点上写入些数据</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> parent <span class="keyword">VALUES</span> (<span class="number">2</span>), (<span class="number">4</span>), (<span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child <span class="keyword">VALUES</span> (<span class="number">3</span>), (<span class="number">5</span>), (<span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> parent <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> <span class="number">4</span></span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br><span class="line"># 订阅节点上可以看到</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> parent <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> <span class="number">4</span></span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 再来检验 publish_via_partition_root <span class="operator">=</span> <span class="literal">false</span> 的情况</span><br><span class="line"># 发布节点删除发布p4 并重建创建发布设置  publish_via_partition_root <span class="operator">=</span> <span class="literal">false</span> </span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">DROP</span> PUBLICATION p4;</span><br><span class="line"><span class="keyword">DROP</span> PUBLICATION</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p4 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> parent, child <span class="keyword">WHERE</span> (a <span class="operator">&gt;=</span> <span class="number">5</span>)</span><br><span class="line">test_pub<span class="operator">-</span># <span class="keyword">WITH</span> (publish_via_partition_root<span class="operator">=</span><span class="literal">false</span>);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line"># 订阅节点刷新</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">ALTER</span> SUBSCRIPTION s4 REFRESH PUBLICATION;</span><br><span class="line"><span class="keyword">ALTER</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">TRUNCATE</span> parent;</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> parent <span class="keyword">VALUES</span> (<span class="number">2</span>), (<span class="number">4</span>), (<span class="number">6</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child <span class="keyword">VALUES</span> (<span class="number">3</span>), (<span class="number">5</span>), (<span class="number">7</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> parent <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span></span><br><span class="line"> <span class="number">4</span></span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line">(<span class="number">6</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"> a</span><br><span class="line"><span class="comment">---</span></span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>
<h3 id="5-指定表字段集-15-版本"><a href="#5-指定表字段集-15-版本" class="headerlink" title="5 指定表字段集(15+ 版本)"></a>5 指定表字段集(15+ 版本)</h3><pre><code>可基于行行为或性能原因选择指定表字段，但不可作为安全限制，恶意的订阅能够读取发布未指定的列数据
如果没有指定表字段，则新增的字段数据同样会自动被复制，如果指定了表字段，那只有指定的字段数据会被复制
表字段列表只能包含简单的字段引用。 不保留表中字段的顺序
创建发布指定 FOR TABLE IN SCHEMA 时不支持指定表字段列表
对于分区表，由发布参数 publish_via_partition_root 决定用父表的字段列，还是子表的字段列表。设置true 使用父表的字段列，设置false（默认值）使用子表的字段列表
如果发布者会发布UPDATE/DELETE 操作，则字段列表必须包含表标识列（主键，唯一键），如果只是发布INSERT ,则可以省略包含表标识，字段列表对于TRUNCATE无任何影响 
在数据初始化期间只有发布指定的表字段列表会被拷贝，然而当订阅者的版本是15以前的版本时，所有的列都会同步过去。
订阅者订阅多个发布时，不支持每个发布者使用不同的表字段列表。当出现由于某个发布调整字段，这个时候就可能导致不同发布间字段不一致，这种情况alter publication 会成功
但稍后可能在发布者的walsender 报错，或者订阅者可能也抛错。这个时候需要通过alter subscription ... drop publicaiton ...删除有问题的发布，然后调整其列表再加回来。
</code></pre><h4 id="5-1-示例"><a href="#5-1-示例" class="headerlink" title="5.1 示例"></a>5.1 示例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 发布节点上创建表 t1</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(id <span class="type">int</span>, a text, b text, c text, d text, e text, <span class="keyword">PRIMARY</span> KEY(id));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line"></span><br><span class="line"># 创建发布p1 带表字段列表</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">CREATE</span> PUBLICATION p1 <span class="keyword">FOR</span> <span class="keyword">TABLE</span> t1 (id, b, a, d);</span><br><span class="line"><span class="keyword">CREATE</span> PUBLICATION</span><br><span class="line"></span><br><span class="line"># 在psql 中使用 \dRp<span class="operator">+</span> 查看发布定义</span><br><span class="line">test_pub<span class="operator">=</span># \dRp<span class="operator">+</span></span><br><span class="line">                               Publication p1</span><br><span class="line">  Owner   <span class="operator">|</span> <span class="keyword">All</span> tables <span class="operator">|</span> Inserts <span class="operator">|</span> Updates <span class="operator">|</span> Deletes <span class="operator">|</span> Truncates <span class="operator">|</span> Via root</span><br><span class="line"><span class="comment">----------+------------+---------+---------+---------+-----------+----------</span></span><br><span class="line"> postgres <span class="operator">|</span> f          <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t       <span class="operator">|</span> t         <span class="operator">|</span> f</span><br><span class="line">Tables:</span><br><span class="line">    &quot;public.t1&quot; (id, a, b, d)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在订阅节点上创建相同表结构的表并创建一个订阅者订阅p1</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1(id <span class="type">int</span>, b text, a text, d text, <span class="keyword">PRIMARY</span> KEY(id));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span></span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">CREATE</span> SUBSCRIPTION s1</span><br><span class="line">test_sub<span class="operator">-</span># CONNECTION <span class="string">&#x27;host=localhost dbname=test_pub application_name=s1&#x27;</span></span><br><span class="line">test_sub<span class="operator">-</span># PUBLICATION p1;</span><br><span class="line"><span class="keyword">CREATE</span> SUBSCRIPTION</span><br><span class="line"></span><br><span class="line"># 在发布节点上初始化数据</span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">&#x27;a-1&#x27;</span>, <span class="string">&#x27;b-1&#x27;</span>, <span class="string">&#x27;c-1&#x27;</span>, <span class="string">&#x27;d-1&#x27;</span>, <span class="string">&#x27;e-1&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">&#x27;a-2&#x27;</span>, <span class="string">&#x27;b-2&#x27;</span>, <span class="string">&#x27;c-2&#x27;</span>, <span class="string">&#x27;d-2&#x27;</span>, <span class="string">&#x27;e-2&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span>(<span class="number">3</span>, <span class="string">&#x27;a-3&#x27;</span>, <span class="string">&#x27;b-3&#x27;</span>, <span class="string">&#x27;c-3&#x27;</span>, <span class="string">&#x27;d-3&#x27;</span>, <span class="string">&#x27;e-3&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="number">0</span> <span class="number">1</span></span><br><span class="line">test_pub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"> id <span class="operator">|</span>  a  <span class="operator">|</span>  b  <span class="operator">|</span>  c  <span class="operator">|</span>  d  <span class="operator">|</span>  e</span><br><span class="line"><span class="comment">----+-----+-----+-----+-----+-----</span></span><br><span class="line">  <span class="number">1</span> <span class="operator">|</span> a<span class="number">-1</span> <span class="operator">|</span> b<span class="number">-1</span> <span class="operator">|</span> c<span class="number">-1</span> <span class="operator">|</span> d<span class="number">-1</span> <span class="operator">|</span> e<span class="number">-1</span></span><br><span class="line">  <span class="number">2</span> <span class="operator">|</span> a<span class="number">-2</span> <span class="operator">|</span> b<span class="number">-2</span> <span class="operator">|</span> c<span class="number">-2</span> <span class="operator">|</span> d<span class="number">-2</span> <span class="operator">|</span> e<span class="number">-2</span></span><br><span class="line">  <span class="number">3</span> <span class="operator">|</span> a<span class="number">-3</span> <span class="operator">|</span> b<span class="number">-3</span> <span class="operator">|</span> c<span class="number">-3</span> <span class="operator">|</span> d<span class="number">-3</span> <span class="operator">|</span> e<span class="number">-3</span></span><br><span class="line"></span><br><span class="line"># 在订阅节点上我们看到只有指定的字段复制过来了</span><br><span class="line">test_sub<span class="operator">=</span># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> id;</span><br><span class="line"> id <span class="operator">|</span>  b  <span class="operator">|</span>  a  <span class="operator">|</span>  d</span><br><span class="line"><span class="comment">----+-----+-----+-----</span></span><br><span class="line">  <span class="number">1</span> <span class="operator">|</span> b<span class="number">-1</span> <span class="operator">|</span> a<span class="number">-1</span> <span class="operator">|</span> d<span class="number">-1</span></span><br><span class="line">  <span class="number">2</span> <span class="operator">|</span> b<span class="number">-2</span> <span class="operator">|</span> a<span class="number">-2</span> <span class="operator">|</span> d<span class="number">-2</span></span><br><span class="line">  <span class="number">3</span> <span class="operator">|</span> b<span class="number">-3</span> <span class="operator">|</span> a<span class="number">-3</span> <span class="operator">|</span> d<span class="number">-3</span></span><br><span class="line">(<span class="number">3</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>
<h3 id="6-冲突"><a href="#6-冲突" class="headerlink" title="6 冲突"></a>6 冲突</h3><p>当订阅节点订阅表在本地被更改过时，或者由于表的权限问题，或者由于订阅端表开启了行级别的安全策略，都有可能引发冲突冲突一旦发生，复制将会终止。<br>可以通过查看日志了解冲突详情，并根据实际情况处理数据问题，或者解决权限问题。冲突必须经过人为解决后，复制才能够继续。<br>例如下面的错误信息<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ERROR:  duplicate key <span class="keyword">value</span> violates <span class="keyword">unique</span> <span class="keyword">constraint</span> &quot;test_pkey&quot;</span><br><span class="line">DETAIL:  Key (c)<span class="operator">=</span>(<span class="number">1</span>) already exists.</span><br><span class="line">CONTEXT:  processing remote data <span class="keyword">for</span> replication origin &quot;pg_16395&quot; during &quot;INSERT&quot; <span class="keyword">for</span> replication target relation &quot;public.test&quot; <span class="keyword">in</span> transaction <span class="number">725</span> finished <span class="keyword">at</span> <span class="number">0</span><span class="operator">/</span><span class="number">14</span>C0378</span><br></pre></td></tr></table></figure><br>在错误信息中我们可以看到事务的LSN 0/14C0378 还有复制源 pg_16395。我们可以通过  ALTER SUBSCRIPTION … SKIP 的命令来跳过完成的冲突事务，<br>也可以通过函数pg_replication_origin_advance(node_name text, lsn pg_lsn) 来跳过完成的冲突事务。<br>在使用pg_replication_origin_advance() 函数前必须先禁用订阅，或者创建订阅时指定了参数disable_on_error=true.<br>接着指定node_name “pg_16395” 以及完成的冲突事务 0/14C0378 的下一个位置 0/14C0379。当前复制源的位置可通过pg_replication_origin_status 系统视图来查看。</p>
<p>需要注意的是跳过整个事务。可能会将事务中本不冲突的数据也一并跳过。很容易引起订阅节点与发布节点上数据的不一致</p>
<h3 id="7-限制"><a href="#7-限制" class="headerlink" title="7 限制"></a>7 限制</h3><p>逻辑复制有以下的限制</p>
<pre><code>1. DDL 并不会被复制。初始化订阅节点时可以采用pg_dump -n -s 的方法导出指定schema下所有表结构。当发布节点上的表结构做变更时，需先在订阅节点上做变更。然后再在发布节点上做变更
2. 序列数据不会被复制。当要启用订阅节点作为业务节点时，一定要先重置序列的起始值，或重建序列，已满足当前序列值与表的最大值相匹配
3. 支持truncate 复制。在发布执行truncate需要注意的是，在truncate 关联外键的某些表。会同时清空关联的一组表。如果订阅节点也是相同的一组表关联，则复制正常运行。但如果订阅节点
   上还关联了某些不属于发布上关联的表。则复制会失败
4. 大对象不会被复制。 除了将数据存储在普通表中之外，没有解决方法
5. 复制只支持普通表，包括分区表。 尝试复制其他类型，例如视图、物化视图或外部表，将导致错误
6. 当复制分区表时，发布节点上有的分区子表，在订阅节点上都必须存在。
</code></pre><h3 id="8-复制架构"><a href="#8-复制架构" class="headerlink" title="8 复制架构"></a>8 复制架构</h3><p>逻辑复制从发布节点拷贝数据快照开始，当数据快照拷贝完成之后，发布节点上的变更将实时发送到订阅节点上。订阅者按照在发布<br>者上提交的顺序应用数据，以便保证任何单个订阅中的发布的事务一致性。</p>
<p>逻辑复制是用类似于物理流复制的架构构建的。 它由“walsender”和“apply”进程实现。walsender 进程启动 WAL 的逻辑解码<br>并加载标准逻辑解码插件（pgoutput）。 该插件将从 WAL 读取的更改转换为逻辑复制协议并根据发布规范过滤数据。 然后使用<br>流复制协议将数据连续传输到应用工作程序，应用工作程序将数据映射到本地表并在收到更改时以正确的事务顺序应用各个更改</p>
<p>订阅节点上的应用进程在运行时总是设置 session_replication_role= replica,这通常对触发器跟约束有影响。<br>    session_replication_role [origin|replica|local]:在会话中控制触发跟复制相关的触发器以及规则 .此设置的预期用途是逻辑复制系统在应用复制更改时将其值设置为replica</p>
<p>逻辑复制应用进程当前只触发行触发器，而不是语句触发器。 然而，初始表同步的实现类似于 COPY 命令，因此会触发 INSERT<br>的行触发器和语句触发器。</p>
<h3 id="9-监控"><a href="#9-监控" class="headerlink" title="9 监控"></a>9 监控</h3><p>逻辑复制采用类似于物理流复制的框架。监控发布者的健康状态可以通过 pg_stat_replication 视图查看<br>而对于订阅节点，则可以通过 pg_stat_subscription 查看</p>
<h3 id="10-配置参数设置"><a href="#10-配置参数设置" class="headerlink" title="10 配置参数设置"></a>10 配置参数设置</h3><p>在发布节点上<br>    wal_level = logical<br>    max_replication_slots &gt;= 订阅数量 + 初始化时同步表的连接数<br>    max_wal_senders &gt;= max_replication_slots + 物理复制从库的连接数<br>订阅节点上<br>    max_replication_slots &gt;= 订阅数量 + 初始化时同步表的连接数<br>    max_logical_replication_workers &gt;= 订阅数量 + 初始化时同步表的连接数<br>    max_worker_processes &gt;= max_logical_replication_workers + 1</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/20/pglogical/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/20/pglogical/" class="post-title-link" itemprop="url">利用PG 的逻辑复制给阿里云数据搭建IDC 逻辑复制库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-10-20 10:50:37" itemprop="dateCreated datePublished" datetime="2022-10-20T10:50:37+08:00">2022-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-10-28 15:21:15" itemprop="dateModified" datetime="2022-10-28T15:21:15+08:00">2022-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/postgres/" itemprop="url" rel="index"><span itemprop="name">postgres</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>将阿里云RDS 数据同步回IDC 做备库，最佳选择是DTS，当然想省钱的话，我们不妨来做个逻辑复制</p>
<h4 id="pg-逻辑复制的要求"><a href="#pg-逻辑复制的要求" class="headerlink" title="pg 逻辑复制的要求:"></a>pg 逻辑复制的要求:</h4><pre><code>1.postgresql 10+ 版本
2.wal_level 设置为 pglogical
3.max_replication_slots 至少设置为1 
4.逻辑复制采用发布,订阅模式。即在主库创建发布。在备库创建订阅
5.目前仅支持 INSERT ,UPDATE , DELETE 操作，11+ 支持 TRUNCATE ,不支持DDL。
6.被发布表（published table ）。必须都有一个复制标识。默认是表的主键，或者有唯一键 都可以被设置为复制标志。如果没有任何唯一标识可用。则会设置为full,已整列数据作为标志
7.订阅者连接发布的用户必须具有super 权限，如果具有super 权限。订阅将由pg_dump 转储，如果不具备super 权限则无法在 pg_subscription 中读取订阅信息，订阅将会被跳过。
8.发布数据库源表必须在订阅库中目标表以同名存在，订阅库目标表可以比发布库源表多字段,但源表字段必须在目标库都存在,对应的字段名也应该相同，不要求顺序相同，字段类型也只需要能够自动转换即可。
</code></pre><p>下面开始演示<br>由于云库RDS 我们一般都不具有super 权限。我们在创建发布者时，就没办法 create publication xxx for all tables; 只能按表来添加</p>
<h4 id="1-导出发布端数据表结构（注意这里只复制指定的schema-表）"><a href="#1-导出发布端数据表结构（注意这里只复制指定的schema-表）" class="headerlink" title="1. 导出发布端数据表结构（注意这里只复制指定的schema 表）"></a>1. 导出发布端数据表结构（注意这里只复制指定的schema 表）</h4><pre><code>pg_dump -f publication_db.meta.sql -U publication_db -s publication_db -h xxxx.aliyun.com -p port
</code></pre><h4 id="2-订阅端导入表"><a href="#2-订阅端导入表" class="headerlink" title="2. 订阅端导入表"></a>2. 订阅端导入表</h4><pre><code>create database publication_db owner xxxx  tablespace xxxx;
psql -U publication_db -d publication_db &lt; publication_db.meta.sql
</code></pre><h4 id="3-查看发布端是否具备逻辑复制条件"><a href="#3-查看发布端是否具备逻辑复制条件" class="headerlink" title="3. 查看发布端是否具备逻辑复制条件"></a>3. 查看发布端是否具备逻辑复制条件</h4><pre><code>show wal_level;
wal_level =logical 
show max_replication_slots;
max_replication_slots = 10
show max_wal_senders;
max_wal_senders = 10
</code></pre><p>   按照上述要求，如果不是则进行调整。然后重启数据库（生产环境重启数据库必须与业务协商）</p>
<h4 id="4-发布端创建发布"><a href="#4-发布端创建发布" class="headerlink" title="4. 发布端创建发布"></a>4. 发布端创建发布</h4><pre><code> create publication publication_db_logical for table xxxx;
 Select * from pg_publication; #查看发布者信息
</code></pre><h4 id="5-订阅端创建订阅"><a href="#5-订阅端创建订阅" class="headerlink" title="5. 订阅端创建订阅"></a>5. 订阅端创建订阅</h4><pre><code>\c publication_db superUser
create subscription publication_db_sub connction &#39;host=aliyun.db.domain port=xxx dbname=publication_db user=superUser password=xxxx&#39; publication publication_db_logical;
##对于pg中无法解析域名，我们可以先ping 下 RDS的域名。以得到真实IP，然后在/etc/hosts 中对应添加 ip  域名
select * from pg_subscription; #查看订阅信息
</code></pre><h4 id="6-在发布端查看是否已经启动复制进程"><a href="#6-在发布端查看是否已经启动复制进程" class="headerlink" title="6. 在发布端查看是否已经启动复制进程"></a>6. 在发布端查看是否已经启动复制进程</h4><pre><code>select * from pg_stat_replication;
</code></pre><h4 id="7-订阅创建成功后"><a href="#7-订阅创建成功后" class="headerlink" title="7. 订阅创建成功后"></a>7. 订阅创建成功后</h4><pre><code>订阅端首先进行的是表数据初始化。即在发布端全量拉取数据过来，完成后再进行增量同步
</code></pre><h4 id="8-添加余下的表到发布中"><a href="#8-添加余下的表到发布中" class="headerlink" title="8. 添加余下的表到发布中"></a>8. 添加余下的表到发布中</h4><pre><code>alter publication publication_db_logical add table tab1,tab2,tab3....
</code></pre><h4 id="9-在订阅端刷新订阅"><a href="#9-在订阅端刷新订阅" class="headerlink" title="9. 在订阅端刷新订阅"></a>9. 在订阅端刷新订阅</h4><pre><code>alter subscription mysub refresh publication;  #只有发动刷新。发布端的变动才会同步过来
</code></pre><h3 id="如果发布表需要增加字段。逻辑复制还能继续吗？"><a href="#如果发布表需要增加字段。逻辑复制还能继续吗？" class="headerlink" title="如果发布表需要增加字段。逻辑复制还能继续吗？"></a>如果发布表需要增加字段。逻辑复制还能继续吗？</h3><p>如果发布表增加了字段。而订阅表没有添加字段，逻辑复制就会中断。这个时候，只要在订阅节点库中对应表添加相应字段，再把订阅启动起来，就可以了。<br>正确的添加顺序。应该在订阅节点库先添加字段。然后再在发布节点库添加字段。然后看看是否复制正常。复制不正常就先停下复制。再启动复制即可</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/19/RecoveryDRSToIDc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/19/RecoveryDRSToIDc/" class="post-title-link" itemprop="url">将阿里云RDS备份拉回IDC做从库</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-19 14:05:57 / 修改时间：16:03:28" itemprop="dateCreated datePublished" datetime="2022-10-19T14:05:57+08:00">2022-10-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定"><a href="#1-登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定" class="headerlink" title="1. 登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定"></a>1. 登录阿里云控制台，然后在数据库实例里面选择我们需要操作的实例，在备份恢复选项中，找到最新的全备下载。可选方式为外网以及内网。根据自己环境决定</h3><p><img src="/images/20221019141152.png" alt="Lena"></p>
<h3 id="2-下载备份文件"><a href="#2-下载备份文件" class="headerlink" title="2. 下载备份文件"></a>2. 下载备份文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -c <span class="string">&quot;https://rdsbak-st-v2.oss-cn-shenzhen-internal.aliyuncs.com/custinxxxxxxx/hins21434496_data_20221019045743_qp.xb?xxxxxxxxxxxx.....&quot;</span> -O hins21434496_data_20221019045743_qp.xb </span><br></pre></td></tr></table></figure>
<h3 id="3-解压文件恢复xtrbackup-备份"><a href="#3-解压文件恢复xtrbackup-备份" class="headerlink" title="3.解压文件恢复xtrbackup 备份"></a>3.解压文件恢复xtrbackup 备份</h3><h5 id="A-如果环境中没有qpress-跟-xtrabackup-工具-则需要先下载安装"><a href="#A-如果环境中没有qpress-跟-xtrabackup-工具-则需要先下载安装" class="headerlink" title="A. 如果环境中没有qpress 跟 xtrabackup 工具 则需要先下载安装"></a>A. 如果环境中没有qpress 跟 xtrabackup 工具 则需要先下载安装</h5><p>对于MySQL 5.7、5.6或5.5实例：安装Percona XtraBackup 2.4。<br>对于MySQL 8.0实例，安装Percona XtraBackup 8.0。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">&quot;http://docs-aliyun.cn-hangzhou.oss.aliyun-inc.com/assets/attach/183466/cn_zh/1608011575185/qpress-11-linux-x64.tar&quot;</span></span><br><span class="line">tar xvf qpress-11-linux-x64.tar</span><br><span class="line"><span class="built_in">chmod</span> 775 qpress</span><br><span class="line"><span class="built_in">cp</span> qpress /usr/bin</span><br></pre></td></tr></table></figure><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libev</span><br><span class="line">wget <span class="string">&quot;https://downloads.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.26/binary/redhat/7/x86_64/percona-xtrabackup-24-2.4.26-1.el7.x86_64.rpm&quot;</span></span><br><span class="line">yum -y install percona-xtrabackup-24-2.4.26-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<h5 id="B-解压恢复"><a href="#B-解压恢复" class="headerlink" title="B. 解压恢复"></a>B. 解压恢复</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> data_common_xtrabackup</span><br><span class="line"><span class="built_in">cat</span> hins21434496_data_20221019045743_qp.xb | xbstream -x -v -C /usr/local/mysql/data_common_xtrabackup</span><br><span class="line">innobackupex --decompress --remove-original /usr/local/mysql/data_common_xtrabackup</span><br><span class="line">innobackupex --default-files=/usr/local/mysql/data_common_xtrabackup/backup-my.cnf --apply-log /usr/local/mysql/data_common_xtrabackup</span><br></pre></td></tr></table></figure>
<h3 id="4-搭建从库"><a href="#4-搭建从库" class="headerlink" title="4. 搭建从库"></a>4. 搭建从库</h3><h5 id="A-将backup-my-cnf-的innodb-部分参数添加到本地IDC-etc-my-cnf"><a href="#A-将backup-my-cnf-的innodb-部分参数添加到本地IDC-etc-my-cnf" class="headerlink" title="A. 将backup-my.cnf 的innodb 部分参数添加到本地IDC /etc/my.cnf"></a>A. 将backup-my.cnf 的innodb 部分参数添加到本地IDC /etc/my.cnf</h5><pre><code>innodb_log_files_in_group=2
innodb_log_file_size=1572864000
innodb_log_buffer_size=8388608
innodb_page_size=16384
innodb_undo_tablespaces=2
</code></pre><h5 id="B-完整的配置文件部分"><a href="#B-完整的配置文件部分" class="headerlink" title="B. 完整的配置文件部分"></a>B. 完整的配置文件部分</h5><pre><code>[mysqld4]
port    = 3309
socket  = /tmp/mysql.common_aliyun_slave.sock
datadir = /usr/local/mysql/data_common_aliyun_slave
innodb_data_home_dir = /usr/local/mysql/data_common_aliyun_slave
innodb_undo_directory = /usr/local/mysql/data_common_aliyun_slave
innodb_log_group_home_dir = /usr/local/mysql/data_common_aliyun_slave
innodb_buffer_pool_size = 10G
innodb_buffer_pool_instances = 10
innodb_fast_shutdown=0
innodb_log_files_in_group=2
innodb_log_file_size=1572864000
innodb_log_buffer_size=8388608
innodb_page_size=16384
innodb_undo_tablespaces=2
init_connect=&#39;set names utf8mb4&#39;
character-set-server=utf8mb4
server-id = 186
collation-server=utf8mb4_general_ci
log-slave-updates = true
skip-grant-tables #这个参数先添加以便去除权限登录数据库修改
</code></pre><h5 id="C-将恢复目录里面mysql-库的两个trigger-重命名-重置root-密码相关信息"><a href="#C-将恢复目录里面mysql-库的两个trigger-重命名-重置root-密码相关信息" class="headerlink" title="C. 将恢复目录里面mysql 库的两个trigger 重命名,重置root 密码相关信息"></a>C. 将恢复目录里面mysql 库的两个trigger 重命名,重置root 密码相关信息</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/mysql/data_common_aliyun_slave/mysql</span><br><span class="line"><span class="built_in">mv</span> user.TRG user.TRG.bak</span><br><span class="line"><span class="built_in">mv</span> proxies_priv.TRG proxies_priv.TRG.bak</span><br><span class="line">mysqld_multi start 4</span><br><span class="line">mysql -uroot -p -S /tmp/mysql.common_aliyun_slave.sock</span><br><span class="line">mysql&gt; use mysql</span><br><span class="line">mysql&gt; update user <span class="built_in">set</span> authentication_string=password(<span class="string">&#x27;xxx&#x27;</span>),host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span> <span class="built_in">where</span> user=<span class="string">&#x27;aliyun_root&#x27;</span>;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">mysql&gt; <span class="built_in">exit</span>;</span><br></pre></td></tr></table></figure>
<h5 id="D-查看恢复目录里面的-xtrabackup-info-文件-gtid-execute-信息"><a href="#D-查看恢复目录里面的-xtrabackup-info-文件-gtid-execute-信息" class="headerlink" title="D. 查看恢复目录里面的 xtrabackup_info 文件 gtid execute 信息"></a>D. 查看恢复目录里面的 xtrabackup_info 文件 gtid execute 信息</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> xtrabackup_info</span><br><span class="line">uuid = 99c6d1c2-4f2f-11ed-b7c8-0c42a1b70fa6</span><br><span class="line">name = </span><br><span class="line">.....</span><br><span class="line">lock_time = 1</span><br><span class="line">binlog_pos = filename <span class="string">&#x27;mysql-bin.000834&#x27;</span>, position 15350993, GTID of the last change <span class="string">&#x27;8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130585536&#x27;</span></span><br><span class="line">innodb_from_lsn = 0</span><br><span class="line">innodb_to_lsn = 437844748178</span><br><span class="line">partial = N</span><br><span class="line">incremental = N</span><br><span class="line">format = xbstream</span><br><span class="line">compact = N</span><br><span class="line">compressed = compressed</span><br><span class="line">encrypted = N</span><br></pre></td></tr></table></figure>
<h5 id="E-查看主库的gtid-purged-信息"><a href="#E-查看主库的gtid-purged-信息" class="headerlink" title="E. 查看主库的gtid purged 信息"></a>E. 查看主库的gtid purged 信息</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW GLOBAL VARIABLES LIKE <span class="string">&#x27;gtid_purged&#x27;</span>; </span><br><span class="line">8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130084627</span><br></pre></td></tr></table></figure>
<h5 id="F-将恢复的IDC实例作为云上的从库"><a href="#F-将恢复的IDC实例作为云上的从库" class="headerlink" title="F. 将恢复的IDC实例作为云上的从库"></a>F. 将恢复的IDC实例作为云上的从库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; reset slave;</span><br><span class="line">mysql&gt; reset master;</span><br><span class="line">mysql&gt; <span class="built_in">set</span> @@global.gtid_purged=<span class="string">&#x27;8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130084627,8e1da966-c6d7-11ec-ba02-0c42a1da3126:1-130585536&#x27;</span></span><br><span class="line">mysql&gt; change master to</span><br><span class="line">mysql&gt; master_host=<span class="string">&#x27;xxxx.aliyun.xxxxx&#x27;</span>,</span><br><span class="line">mysql&gt; master_port=<span class="string">&#x27;xxxx&#x27;</span>,</span><br><span class="line">mysql&gt; master_user=<span class="string">&#x27;repuser&#x27;</span>,</span><br><span class="line">mysql&gt; master_password=<span class="string">&#x27;reppass&#x27;</span>,</span><br><span class="line">mysql&gt; master_auto_position=1;</span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status\G;</span><br></pre></td></tr></table></figure>
<p>可以看到数据库已经正确连接到阿里云上RDS</p>
<h3 id="5-注意"><a href="#5-注意" class="headerlink" title="5. 注意"></a>5. 注意</h3><p>set @@global.gtid_purged=’主库的gtid_purged,从库的gtid_excuted’<br>master_user ， master_password 为RDS 实例上已经建好具有 select, replication_slave 的权限账号以及密码</p>
<p>上面有将2个trigger 重命名的操作。是因为阿里的数据库对user 表做了限制。只有把2个trigger 拿掉,才能修改用户表<br>否则将报如下错误<br>    ERROR 1064 (42000): Unknown trigger has an error in its body: ‘Unknown system variable ‘maintain_user_list’’</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sheenzxx.github.io/2022/10/18/useGtidPurged/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Sheen">
      <meta itemprop="description" content="数据库相关技术研究,自动化运维">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sheen's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/18/useGtidPurged/" class="post-title-link" itemprop="url">gtid purged 的巧用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-10-18 15:00:58 / 修改时间：15:08:47" itemprop="dateCreated datePublished" datetime="2022-10-18T15:00:58+08:00">2022-10-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="今天根据冷备搭建主从-出现问题总结"><a href="#今天根据冷备搭建主从-出现问题总结" class="headerlink" title="今天根据冷备搭建主从,出现问题总结"></a>今天根据冷备搭建主从,出现问题总结</h3><h4 id="1-UUID-相同"><a href="#1-UUID-相同" class="headerlink" title="1 UUID 相同   ."></a>1 UUID 相同   .</h4><p>   清除 auto.cnf 文件。重启 重新生成UUID</p>
<h4 id="2-change-master-后-报-从库需要的binglog-已经被主库purged"><a href="#2-change-master-后-报-从库需要的binglog-已经被主库purged" class="headerlink" title="2.change master 后  报 从库需要的binglog 已经被主库purged"></a>2.change master 后  报 从库需要的binglog 已经被主库purged</h4><p>   查询主库的 gtid_purged<br>   设置从库的gtid purged<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">master:</span><br><span class="line">show global variables like <span class="string">&#x27;%gtid%&#x27;</span> </span><br><span class="line">gtid_purged=<span class="string">&#x27;32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-181880&#x27;</span></span><br><span class="line"></span><br><span class="line">slave: </span><br><span class="line">reset master;</span><br><span class="line">reset slave all;</span><br><span class="line"><span class="built_in">set</span> global gtid_purged=<span class="string">&#x27;32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-181880&#x27;</span></span><br><span class="line">change master to ........ master_auto_position=1;</span><br></pre></td></tr></table></figure></p>
<h4 id="3-发现从库是从已存的主库binlog-开始读取。这使从库落后5万多秒。"><a href="#3-发现从库是从已存的主库binlog-开始读取。这使从库落后5万多秒。" class="headerlink" title="3 发现从库是从已存的主库binlog 开始读取。这使从库落后5万多秒。"></a>3 发现从库是从已存的主库binlog 开始读取。这使从库落后5万多秒。</h4><p>分析从库正在执行的binlog 这些binglog 正是在写一个大表。而这个大表刚好是要清除掉的。<br>怎样修改 主库的gtid_purged<br>主库gtid purged 记录的是被清除binlog 的最后一个 gtid 。要跳过这些已经执行过的binlog .那么就需要再重置一次binlog purged<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> purge master logs to <span class="string">&#x27;mysql-bin.000112&#x27;</span>;</span><br><span class="line">mysql.sock@(none)&gt; show global variables like <span class="string">&#x27;%gtid%&#x27;</span>;</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br><span class="line">| Variable_name                   | Value                                         |</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery     | OFF                                           |</span><br><span class="line">| enforce_gtid_consistency        | ON                                            |</span><br><span class="line">| gtid_executed                   | 32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-187811 |</span><br><span class="line">| gtid_mode                       | ON                                            |</span><br><span class="line">| gtid_owned                      |                                               |</span><br><span class="line">| gtid_purged                     | 32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-187809 |</span><br><span class="line">| simplified_binlog_gtid_recovery | OFF                                           |</span><br><span class="line">+---------------------------------+-----------------------------------------------+</span><br></pre></td></tr></table></figure><br>主库的gtid_purged 已经跳到已知最后一个binlog </p>
<p>重置从库。重新设置主从关系。将gtid_purged 设置到 32dcbbd2-b9a7-11ea-a2cd-6c92bf060958:1-187809</p>
<p>从库成功跳过不需要执行的binlog .正常运行</p>
<h4 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h4><p>这些操作基于冷备。主从库的数据是一致的。而且中间没有任何其他操作在主库产生。如有,则要知道那些必须执行过的操作落在哪。<br>取主库重启后第一个产生的Binlog 为界限。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Sheen</p>
  <div class="site-description" itemprop="description">数据库相关技术研究,自动化运维</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sheen</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  


    </div>
</body>
</html>
