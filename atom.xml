<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>sheen&#39;s Blog</title>
  
  <subtitle>随笔，技术笔记</subtitle>
  <link href="https://sheenzxx.github.io/atom.xml" rel="self"/>
  
  <link href="https://sheenzxx.github.io/"/>
  <updated>2024-01-08T08:20:51.450Z</updated>
  <id>https://sheenzxx.github.io/</id>
  
  <author>
    <name>Sheen</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>mysql的克隆插件</title>
    <link href="https://sheenzxx.github.io/2024/01/08/mysqlcloneplugin/"/>
    <id>https://sheenzxx.github.io/2024/01/08/mysqlcloneplugin/</id>
    <published>2024-01-08T07:43:10.000Z</published>
    <updated>2024-01-08T08:20:51.450Z</updated>
    
    <content type="html"><![CDATA[<p>mysql 8.1 开始有了克隆插件 clone.so 。clone 是奔着组复制集群而去的，同时对于搭建主从也提供了极大便利。还不锁库锁表。瞬间觉得xtrabackup 不香了</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装:"></a>安装:</h2><p>方法1：在my.cnf中添加参数，并重启<br>plugin_load_add=mysql_clone.so</p><p>方法2：在运行时安装插件使用<br>INSTALL PLUGIN clone SONAME ‘mysql_clone.so’;</p><p>如果要限定数据库启动时启动克隆插件并且不允许其在运行时删除<br>[mysqld]<br>plugin-load-add=mysql_clone.so<br>clone=FORCE_PLUS_PERMANENT</p><h2 id="克隆数据到本地目录"><a href="#克隆数据到本地目录" class="headerlink" title="克隆数据到本地目录"></a>克隆数据到本地目录</h2><p>用户需要 BACKUP_ADMIN  权限<br>GRANT BACKUP_ADMIN ON <em>.</em> TO ‘clone_user’;<br>克隆本实例到 data_sheen_clone。<br>root@localhost:(none)&gt;CLONE LOCAL DATA DIRECTORY ‘/usr/local/mysql/data_sheen_clone’;<br>Query OK, 0 rows affected (2.70 sec)<br>注意<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 路径以及目标目录必须是全路径</span><br><span class="line">2. 路径必须是已存在的路径</span><br><span class="line">3. 目标目录必须不存在</span><br><span class="line">4. 本地克隆不能克隆那些用户自建在 data 目录以外的表和表空间。</span><br></pre></td></tr></table></figure><br>拷贝完我们可以在指定目录下看到刚才克隆的数据库</p><h2 id="克隆远端数据库"><a href="#克隆远端数据库" class="headerlink" title="克隆远端数据库"></a>克隆远端数据库</h2><p>CLONE INSTANCE FROM ‘user’@’host’:port<br>IDENTIFIED BY ‘password’<br>[DATA DIRECTORY [=] ‘clone_dir’]<br>[REQUIRE [NO] SSL];</p><p>user 为源端实例的具有克隆权限的用户<br>password 为源端实例的具有克隆权限的用户的密码<br>host   为源端实例的地址，不支持IPV6地址<br>port   为源端实例的端口，不支持mysqlx_port<br>DATA DIRECTORY [=] ‘clone_dir’ 可选选项，指定接收方接收数据文件的目录。也需要绝对路径。目标目录不存在，并且用户具有该路径的权限。<br>       如果不指定，将会把当前实例的数据文件，binglog等全部删掉。然后克隆远端数据文件到该目录下。拷贝完成后重启数据库。<br>       默认情况下，接收端会将数据文件拷贝到 innodb_data_home_dir ， innodb_data_file_path, innodb_log_group_home_dir,  innodb_undo_directory目录中<br>       如果指定则将数据文件拷贝到指定目录<br>REQUIRE [NO] SSL 指定是否加密连接。默认启用加密行为</p><h4 id="要求"><a href="#要求" class="headerlink" title="要求:"></a>要求:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1. 源端用户需要有 BACKUP_ADMIN 的权限</span><br><span class="line">2. 接收端用户需要有 CLONE_ADMIN （CLONE_ADMIN 包含了 BACKUP_ADMIN ,SHUTDOWN 的权限）</span><br><span class="line">3. 源端与接收端必须运行在相同的操作系统跟平台上</span><br><span class="line">4. 接收端接收数据文件的目录必须有足够的磁盘存储空间可以容纳下源端数据库的大小</span><br><span class="line">5. 如果有存在于数据目录以外的自建表空间。clone 操作必须有权限可以访问那些目录，查看所有的innodb 文件 SELECT FILE_NAME FROM INFORMATION_SCHEMA.FILES;</span><br><span class="line">6. 源端与接收端必须设定相同的character set 和 collation</span><br><span class="line">7. 源端与接收端必须设定相同的innodb_page_size 和 innodb_data_file_path。 SHOW VARIABLES LIKE &#x27;innodb_page_size&#x27;;  SHOW VARIABLES LIKE &#x27;innodb_data_file_path&#x27;;</span><br><span class="line">8. 如果克隆加密或者压缩页的数据。则源端与接收端必须系统文件块大小一致</span><br><span class="line">9. 将源端地址设置到 clone_valid_donor_list 中。SHOW VARIABLES LIKE &#x27;clone_valid_donor_list&#x27;;</span><br><span class="line">10. 执行时不能有其他克隆操作同时进行</span><br><span class="line">11. 接收端 max_allowed_packet 设置的值必须大于等于源端的max_allowed_packet设置的值。SHOW VARIABLES LIKE &#x27;max_allowed_packet&#x27;;</span><br><span class="line">12. 源端undo表空间里的文件名必须唯一。否则在拷贝到接收端的innodb_undo_directory 或者 clone_dir 的时候会因为名字重复而报错。</span><br><span class="line">    SELECT TABLESPACE_NAME, FILE_NAME FROM INFORMATION_SCHEMA.FILES</span><br><span class="line">       WHERE FILE_TYPE LIKE &#x27;UNDO LOG&#x27;;</span><br></pre></td></tr></table></figure><h4 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h4><p>1) 在源端创建克隆账号，并授权<br>create user ‘repl’@’%’ identified by ‘repl’;<br>grant backup_admin ON <em>.</em> to ‘repl’@’%’;</p><p>2) 在源端安装mysql_clone.so 插件<br>INSTALL PLUGIN clone SONAME ‘mysql_clone.so’;<br>或者<br>启动前添加 plugin_load_add = “mysql_clone.so”</p><p>3) 在接收端创建复制账号<br>create user ‘repl’@’%’ identified by ‘repl’;<br>grant clone_admin ON <em>.</em> to ‘repl’@’%’;</p><p>4) 在接收端安装mysql_clone.so 插件<br>INSTALL PLUGIN clone SONAME ‘mysql_clone.so’;<br>或者<br>启动前添加 plugin_load_add = “mysql_clone.so”</p><p>这里可以直接用root 来操作</p><p>5) 接收端设置 clone_valid_donor_list<br> SET GLOBAL clone_valid_donor_list = ‘192.168.56.17:3306’;</p><p>6) 克隆目标端<br>root@localhost:(none)&gt;CLONE INSTANCE FROM ‘repl’@’192.168.56.17’:3306<br>  identified by ‘repl’<br>   REQUIRE no ssl;<br>从日志中可以看到拷贝完成后实例进行了重启<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2023-12-25T07:54:53.799895Z 10 [Warning] [MY-013460] [InnoDB] Clone removing all user data for provisioning: Started</span><br><span class="line">2023-12-25T07:54:54.103700Z 10 [Warning] [MY-013460] [InnoDB] Clone removing all user data for provisioning: Finished</span><br><span class="line">2023-12-25T07:54:58.822308Z 0 [Warning] [MY-010909] [Server] /usr/local/mysql/bin/mysqld: Forcing close of thread 10  user: &#x27;root&#x27;.</span><br><span class="line">2023-12-25T07:54:59.689871Z 0 [System] [MY-010910] [Server] /usr/local/mysql/bin/mysqld: Shutdown complete (mysqld 8.2.0)  MySQL Community Server - GPL.</span><br><span class="line">2023-12-25T07:54:59.690938Z 0 [System] [MY-015016] [Server] MySQL Server - end.</span><br><span class="line">2023-12-25T07:54:59.912281Z mysqld_safe Number of processes running now: 0</span><br><span class="line">2023-12-25T07:54:59.919126Z mysqld_safe mysqld restarted</span><br><span class="line">2023-12-25T07:54:59.934787Z 0 [System] [MY-015015] [Server] MySQL Server - start.</span><br><span class="line">2023-12-25T07:55:00.277772Z 0 [Warning] [MY-011070] [Server] &#x27;binlog_format&#x27; is deprec</span><br></pre></td></tr></table></figure></p><h4 id="克隆并行DDL"><a href="#克隆并行DDL" class="headerlink" title="克隆并行DDL"></a>克隆并行DDL</h4><p>在8.2 版本开始支持 克隆时并发执行DDL。由参数 clone_block_ddl 控制。默认开启<br>SET GLOBAL clone_block_ddl={OFF|ON}<br>克隆过程中不支持以下DDL行为并行运行<br>ALTER TABLE tbl_name DISCARD TABLESPACE;<br>ALTER TABLE tbl_name IMPORT TABLESPACE;<br>ALTER INSTANCE DISABLE INNODB REDO_LOG;</p><h4 id="克隆用于复制"><a href="#克隆用于复制" class="headerlink" title="克隆用于复制"></a>克隆用于复制</h4><p>查看接收端的binlog 位置。<br>SELECT BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;</p><p>查看接收端GTID 信息<br>SELECT @@GLOBAL.GTID_EXECUTED;</p><ol><li>如果是用于组复制添加成员。执行<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START GROUP_REPLICATION </span><br></pre></td></tr></table></figure></li><li>如果用于做主从复制的从库，则可以源端为主库或从库。<br>GTID 模式：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CHANGE SOURCE TO SOURCE_HOST = &#x27;source_host_name&#x27;, SOURCE_PORT = source_port_num,</span><br><span class="line">       ...</span><br><span class="line">       SOURCE_AUTO_POSITION = 1,</span><br><span class="line">       FOR CHANNEL &#x27;setup_channel&#x27;;</span><br><span class="line">START REPLICA USER = &#x27;user_name&#x27; PASSWORD = &#x27;password&#x27; FOR CHANNEL &#x27;setup_channel&#x27;;</span><br></pre></td></tr></table></figure></li><li>基于bin-log 位置的复制<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;</span><br><span class="line">CHANGE SOURCE TO SOURCE_HOST = &#x27;source_host_name&#x27;, SOURCE_PORT = source_port_num,</span><br><span class="line">       ...</span><br><span class="line">       SOURCE_LOG_FILE = &#x27;source_log_name&#x27;,</span><br><span class="line">       SOURCE_LOG_POS = source_log_pos,</span><br><span class="line">       FOR CHANNEL &#x27;setup_channel&#x27;;</span><br><span class="line">START REPLICA USER = &#x27;user_name&#x27; PASSWORD = &#x27;password&#x27; FOR CHANNEL &#x27;setup_channel&#x27;;</span><br></pre></td></tr></table></figure></li></ol><h4 id="克隆过程中产生的目录"><a href="#克隆过程中产生的目录" class="headerlink" title="克隆过程中产生的目录"></a>克隆过程中产生的目录</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#clone: 克隆操作过程中内部产生的文件存放在这个目录下</span><br><span class="line">#ib_archive：存储克隆过程中源端的归档日志的文件</span><br><span class="line">.#clone：接收端当本地文件被删除并拷贝远端文件过程中产生的临时文件</span><br></pre></td></tr></table></figure><h4 id="监控克隆过程"><a href="#监控克隆过程" class="headerlink" title="监控克隆过程"></a>监控克隆过程</h4><ol><li><p>查看克隆的状态<br>SELECT STATE FROM performance_schema.clone_status;<br>4种状态<br>Not Started, In Progress, Completed, Failed</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> root<span class="variable">@localhost</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.clone_status; </span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+-----------+-------------------------+-------------------------+--------------------+----------------+----------+---------------+------------------+-----------------+-----------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> ID   <span class="operator">|</span> PID  <span class="operator">|</span> STATE     <span class="operator">|</span> BEGIN_TIME              <span class="operator">|</span> END_TIME                <span class="operator">|</span> SOURCE             <span class="operator">|</span> DESTINATION    <span class="operator">|</span> ERROR_NO <span class="operator">|</span> ERROR_MESSAGE <span class="operator">|</span> BINLOG_FILE      <span class="operator">|</span> BINLOG_POSITION <span class="operator">|</span> GTID_EXECUTED                                                                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+-----------+-------------------------+-------------------------+--------------------+----------------+----------+---------------+------------------+-----------------+-----------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>    <span class="number">0</span> <span class="operator">|</span> Completed <span class="operator">|</span> <span class="number">2023</span><span class="number">-12</span><span class="number">-25</span> <span class="number">15</span>:<span class="number">54</span>:<span class="number">53.405</span> <span class="operator">|</span> <span class="number">2023</span><span class="number">-12</span><span class="number">-25</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">01.937</span> <span class="operator">|</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.17</span>:<span class="number">3306</span> <span class="operator">|</span> <span class="keyword">LOCAL</span> INSTANCE <span class="operator">|</span>        <span class="number">0</span> <span class="operator">|</span>               <span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000004</span> <span class="operator">|</span>            <span class="number">1406</span> <span class="operator">|</span> <span class="number">0</span>ecaadea<span class="number">-9</span>fc7<span class="number">-11</span>ee<span class="number">-8099</span><span class="number">-080027128</span>c74:<span class="number">1</span>,</span><br><span class="line"><span class="number">8332185e-9</span>f15<span class="number">-11</span>ee<span class="number">-8831</span><span class="number">-080027128</span>c74:<span class="number">1</span><span class="number">-14</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+------+-----------+-------------------------+-------------------------+--------------------+----------------+----------+---------------+------------------+-----------------+-----------------------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure><p>如果失败进一步获取失败的原因<br>SELECT STATE, ERROR_NO, ERROR_MESSAGE FROM performance_schema.clone_status; </p></li><li><p>查看克隆进程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT STAGE, STATE, END_TIME FROM performance_schema.clone_progress;</span><br><span class="line">root@localhost:(none)&gt;SELECT STAGE, STATE, END_TIME FROM performance_schema.clone_progress;</span><br><span class="line">+-----------+-----------+----------------------------+</span><br><span class="line">| STAGE     | STATE     | END_TIME                   |</span><br><span class="line">+-----------+-----------+----------------------------+</span><br><span class="line">| DROP DATA | Completed | 2023-12-25 15:54:54.111750 |</span><br><span class="line">| FILE COPY | Completed | 2023-12-25 15:54:56.630832 |</span><br><span class="line">| PAGE COPY | Completed | 2023-12-25 15:54:56.673880 |</span><br><span class="line">| REDO COPY | Completed | 2023-12-25 15:54:56.676687 |</span><br><span class="line">| FILE SYNC | Completed | 2023-12-25 15:54:56.817732 |</span><br><span class="line">| RESTART   | Completed | 2023-12-25 15:55:00.291296 |</span><br><span class="line">| RECOVERY  | Completed | 2023-12-25 15:55:01.937143 |</span><br><span class="line">+-----------+-----------+----------------------------+</span><br></pre></td></tr></table></figure><p>7种进程状态<br>DROP DATA, FILE COPY, PAGE_COPY, REDO_COPY, FILE_SYNC, RESTART, RECOVERY.</p></li></ol><ol><li>终止克隆进程<br>SELECT * FROM performance_schema.clone_status\G<br>KILL pid</li></ol><h2 id="克隆的原理"><a href="#克隆的原理" class="headerlink" title="克隆的原理"></a>克隆的原理</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                                                                   一致性的位点</span><br><span class="line">                                      |                                 |</span><br><span class="line">clone_start_lsn     clone_file_end_lsn|                        clone_lsn| </span><br><span class="line">       |                             ||                              |  |</span><br><span class="line">       [     拷贝数据文件             ]|                              |  | </span><br><span class="line">       &#123;    同时收集内存中的脏页       &#125;|     [   拷贝收集的脏页        ]  | </span><br><span class="line">                                      |     &#123;    归档redo            &#125;  |    [   拷贝redo   ]</span><br><span class="line">                                      |                                 |</span><br><span class="line">                基线                  |         增量1                    |       增量2</span><br><span class="line">---------------------------------------------------------------------------------------------&gt; </span><br><span class="line">                                                                          </span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;mysql 8.1 开始有了克隆插件 clone.so 。clone 是奔着组复制集群而去的，同时对于搭建主从也提供了极大便利。还不锁库锁表。瞬间觉得xtrabackup 不香了&lt;/p&gt;
&lt;h2 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink</summary>
      
    
    
    
    <category term="mysql" scheme="https://sheenzxx.github.io/categories/mysql/"/>
    
    
    <category term="plugin" scheme="https://sheenzxx.github.io/tags/plugin/"/>
    
    <category term="clone" scheme="https://sheenzxx.github.io/tags/clone/"/>
    
  </entry>
  
  <entry>
    <title>ORACLE 加密解密包 DBMS_CRYPTO 的使用</title>
    <link href="https://sheenzxx.github.io/2024/01/08/DBMS-CRYPTO/"/>
    <id>https://sheenzxx.github.io/2024/01/08/DBMS-CRYPTO/</id>
    <published>2024-01-08T06:59:13.000Z</published>
    <updated>2024-01-08T07:16:29.225Z</updated>
    
    <content type="html"><![CDATA[<p>DBMS_CRYPTO 位于 SYS schema 下，对其他用户可授权<br>grant execute on sys.DBMS_CRYPTO to user;</p><p>DBMS_CRYPTO的函数里的参数数据类型包括<br>BLOB  CLOB  PLS_INTEGER   RAW</p><h1 id="DBMS-CRYPTO的策略"><a href="#DBMS-CRYPTO的策略" class="headerlink" title="DBMS_CRYPTO的策略"></a>DBMS_CRYPTO的策略</h1><p>===注意DBMS_CRYPTO里面接收参数的数据类型 PLS_INTEGER,如下定义为PL/SQL 里面的预定义。只能在PL/SQL代码块中执行。</p><h2 id="HASH-函数相关算法"><a href="#HASH-函数相关算法" class="headerlink" title="HASH 函数相关算法"></a>HASH 函数相关算法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HASH_MD4               Produces a 128-bit hash, or message digest of the input message</span><br><span class="line">HASH_MD5               Also produces a 128-bit hash, but is more complex than MD4</span><br><span class="line">HASH_SH1               Secure Hash Algorithm (SHA-1). Produces a 160-bit hash.</span><br><span class="line">HASH_SH256             SHA-2, produces a 256-bit hash.</span><br><span class="line">HASH_SH384             SHA-2, produces a 384-bit hash.</span><br><span class="line">HASH_SH512             SHA-2, produces a 512-bit hash.</span><br></pre></td></tr></table></figure><h2 id="DBMS-CRYPTO-MAC-消息授权码-函数相关算法"><a href="#DBMS-CRYPTO-MAC-消息授权码-函数相关算法" class="headerlink" title="DBMS_CRYPTO MAC (消息授权码) 函数相关算法"></a>DBMS_CRYPTO MAC (消息授权码) 函数相关算法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HMAC_MD5               Same as MD5 hash function, except it requires a secret key to verify the hash value.</span><br><span class="line">HMAC_SH1               Same as SHA hash function, except it requires a secret key to verify the hash value.</span><br><span class="line">HMAC_SH256             Same as SHA-2 256-bit hash function, except it requires a secret key to verify the hash value.</span><br><span class="line">HMAC_SH384             Same as SHA-2 384-bit hash function, except it requires a secret key to verify the hash value.</span><br><span class="line">HMAC_SH512             Same as SHA-2 512-bit hash function, except it requires a secret key to verify the hash value.</span><br></pre></td></tr></table></figure><h2 id="DBMS-CRYPTO-加密算法"><a href="#DBMS-CRYPTO-加密算法" class="headerlink" title="DBMS_CRYPTO 加密算法"></a>DBMS_CRYPTO 加密算法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ENCRYPT_DES            Data Encryption Standard. Block cipher. Uses key length of 56 bits</span><br><span class="line">ENCRYPT_3DES_2KEY      Data Encryption Standard. Block cipher. Operates on a block 3 times with 2 keys. Effective key length of 112 bits</span><br><span class="line">ENCRYPT_3DES           Data Encryption Standard. Block cipher. Operates on a block 3 times</span><br><span class="line">ENCRYPT_AES128         Advanced Encryption Standard. Block cipher. Uses 128-bit key size</span><br><span class="line">ENCRYPT_AES192         Advanced Encryption Standard. Block cipher. Uses 192-bit key size</span><br><span class="line">ENCRYPT_AES256         Advanced Encryption Standard. Block cipher. Uses 256-bit key size</span><br><span class="line">ENCRYPT_RC4            Stream cipher. Uses a secret, randomly generated key unique to each session.</span><br></pre></td></tr></table></figure><h2 id="DBMS-CRYPTO-Block-Cipher-Suites"><a href="#DBMS-CRYPTO-Block-Cipher-Suites" class="headerlink" title="DBMS_CRYPTO Block Cipher Suites"></a>DBMS_CRYPTO Block Cipher Suites</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DES_CBC_PKCS5          ENCRYPT_DES + CHAIN_CBC + PAD_PKCS5</span><br><span class="line">DES3_CBC_PKCS5         ENCRYPT_3DES + CHAIN_CBC + PAD_PKCS5</span><br></pre></td></tr></table></figure><h2 id="DBMS-CRYPTO-Block-Cipher-Chaining-Modifiers"><a href="#DBMS-CRYPTO-Block-Cipher-Chaining-Modifiers" class="headerlink" title="DBMS_CRYPTO Block Cipher Chaining Modifiers"></a>DBMS_CRYPTO Block Cipher Chaining Modifiers</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CHAIN_ECB             Electronic Codebook. Encrypts each plaintext block independently.</span><br><span class="line">CHAIN_CBC             Cipher Block Chaining. Plaintext is XORed with the previous ciphertext block before it is encrypted.</span><br><span class="line">CHAIN_CFB             Cipher-Feedback. Enables encrypting units of data smaller than the block size.</span><br><span class="line">CHAIN_OFB             Output-Feedback. Enables running a block cipher as a synchronous stream cipher. Similar to CFB, except that n bits of the previous output block are moved into the right-most positions of the </span><br><span class="line">                      data queue waiting to be encrypted.</span><br></pre></td></tr></table></figure><h2 id="DBMS-CRYPTO-Block-Cipher-Padding-Modifiers"><a href="#DBMS-CRYPTO-Block-Cipher-Padding-Modifiers" class="headerlink" title="DBMS_CRYPTO Block Cipher Padding Modifiers"></a>DBMS_CRYPTO Block Cipher Padding Modifiers</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PAD_PKCS5             Provides padding which complies with the PKCS #5: Password-Based Cryptography Standard</span><br><span class="line">PAD_NONE              Provides option to specify no padding. Caller must ensure that blocksize is correct, else the package returns an error.</span><br><span class="line">PAD_ZERO              Provides padding consisting of zeroes</span><br></pre></td></tr></table></figure><h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><p>VARCHAR2数据类型并不能直接用于DBMS_CRYPTO中，首先需将varchar2类型的数据转换成 AL32UTF8 ，然后再转成ROW 类型。<br>示例：<br>UTL_I18N.STRING_TO_RAW (string, ‘AL32UTF8’);</p><p>将ROW 数据类型转换回varchar2类型<br>UTL_I18N.RAW_TO_CHAR (data, ‘AL32UTF8’);</p><h2 id="DBMS-CRYPTO-加密解密示例"><a href="#DBMS-CRYPTO-加密解密示例" class="headerlink" title="DBMS_CRYPTO 加密解密示例:"></a>DBMS_CRYPTO 加密解密示例:</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">   input_string       VARCHAR2 (<span class="number">200</span>) :<span class="operator">=</span>  <span class="string">&#x27;Secret Message&#x27;</span>;</span><br><span class="line">   output_string      VARCHAR2 (<span class="number">200</span>);</span><br><span class="line">   encrypted_raw      RAW (<span class="number">2000</span>);             <span class="comment">-- stores encrypted binary text</span></span><br><span class="line">   decrypted_raw      RAW (<span class="number">2000</span>);             <span class="comment">-- stores decrypted binary text</span></span><br><span class="line">   num_key_bytes      NUMBER :<span class="operator">=</span> <span class="number">256</span><span class="operator">/</span><span class="number">8</span>;        <span class="comment">-- key length 256 bits (32 bytes)</span></span><br><span class="line">   key_bytes_raw      RAW (<span class="number">32</span>);               <span class="comment">-- stores 256-bit encryption key</span></span><br><span class="line">   encryption_type    PLS_INTEGER :<span class="operator">=</span>          <span class="comment">-- total encryption type</span></span><br><span class="line"></span><br><span class="line">                            DBMS_CRYPTO.ENCRYPT_AES256</span><br><span class="line">                          <span class="operator">+</span> DBMS_CRYPTO.CHAIN_CBC</span><br><span class="line">                          <span class="operator">+</span> DBMS_CRYPTO.PAD_PKCS5;</span><br><span class="line"></span><br><span class="line">   iv_raw             RAW (<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">   DBMS_OUTPUT.PUT_LINE ( <span class="string">&#x27;Original string: &#x27;</span> <span class="operator">||</span> input_string);</span><br><span class="line">   key_bytes_raw :<span class="operator">=</span> DBMS_CRYPTO.RANDOMBYTES (num_key_bytes);</span><br><span class="line">   iv_raw        :<span class="operator">=</span> DBMS_CRYPTO.RANDOMBYTES (<span class="number">16</span>);</span><br><span class="line">   encrypted_raw :<span class="operator">=</span> DBMS_CRYPTO.ENCRYPT</span><br><span class="line">      (</span><br><span class="line">         src <span class="operator">=</span><span class="operator">&gt;</span> UTL_I18N.STRING_TO_RAW (input_string,  <span class="string">&#x27;AL32UTF8&#x27;</span>),</span><br><span class="line">         typ <span class="operator">=</span><span class="operator">&gt;</span> encryption_type,</span><br><span class="line">         key <span class="operator">=</span><span class="operator">&gt;</span> key_bytes_raw,</span><br><span class="line">         iv  <span class="operator">=</span><span class="operator">&gt;</span> iv_raw</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- The encrypted value &quot;encrypted_raw&quot; can be used here</span></span><br><span class="line"></span><br><span class="line">    decrypted_raw :<span class="operator">=</span> DBMS_CRYPTO.DECRYPT</span><br><span class="line">      (</span><br><span class="line">         src <span class="operator">=</span><span class="operator">&gt;</span> encrypted_raw,</span><br><span class="line">         typ <span class="operator">=</span><span class="operator">&gt;</span> encryption_type,</span><br><span class="line">         key <span class="operator">=</span><span class="operator">&gt;</span> key_bytes_raw,</span><br><span class="line">         iv  <span class="operator">=</span><span class="operator">&gt;</span> iv_raw</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">   output_string :<span class="operator">=</span> UTL_I18N.RAW_TO_CHAR (decrypted_raw, <span class="string">&#x27;AL32UTF8&#x27;</span>);</span><br><span class="line"></span><br><span class="line">   DBMS_OUTPUT.PUT_LINE (<span class="string">&#x27;Decrypted string: &#x27;</span> <span class="operator">||</span> output_string); </span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure><h1 id="DBMS-CRYPTO的相关函数"><a href="#DBMS-CRYPTO的相关函数" class="headerlink" title="DBMS_CRYPTO的相关函数"></a>DBMS_CRYPTO的相关函数</h1><p>解密函数<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DBMS_CRYPTO.DECRYPT(</span><br><span class="line">   src IN RAW,          -- RAW data to be decrypted. （要被解密的RAW类型数据）</span><br><span class="line">   typ IN PLS_INTEGER,  -- Stream or block cipher type and modifiers to be used. （加密类型： 加密算法+ Block Cipher Chaining Modifiers + Block Cipher Padding Modifiers 必须与加密时类型相同）</span><br><span class="line">   key IN RAW,          -- Key to be used for decryption. （秘钥，加密时指定的秘钥）</span><br><span class="line">   iv  IN RAW DEFAULT NULL  -- Optional initialization vector for block ciphers. Default is NULL. （可选的密码块初始化矢量 ,默认为NULL）</span><br><span class="line">) </span><br><span class="line"> RETURN RAW;</span><br></pre></td></tr></table></figure><br>解密存储过程<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DBMS_CRYPTO.DECRYPT(</span><br><span class="line">   dst IN OUT NOCOPY BLOB,</span><br><span class="line">   src IN            BLOB,</span><br><span class="line">   typ IN            PLS_INTEGER,</span><br><span class="line">   key IN            RAW,</span><br><span class="line">   iv  IN            RAW          DEFAULT NULL);</span><br><span class="line"></span><br><span class="line">DBMS_CRYPT.DECRYPT(</span><br><span class="line">   dst IN OUT NOCOPY CLOB         CHARACTER SET ANY_CS,</span><br><span class="line">   src IN            BLOB,</span><br><span class="line">   typ IN            PLS_INTEGER,</span><br><span class="line">   key IN            RAW,</span><br><span class="line">   iv  IN            RAW          DEFAULT NULL);</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>加密函数<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DBMS_CRYPTO.ENCRYPT(</span><br><span class="line">   src IN RAW,               --RAW data to be encrypted.  （要被加密的RAW类型数据）             </span><br><span class="line">   typ IN PLS_INTEGER,        -- Stream or block cipher type and modifiers to be used. （加密类型 加密算法+ Block Cipher Chaining Modifiers + Block Cipher Padding Modifiers ）</span><br><span class="line">   key IN RAW,                -- 加密秘钥</span><br><span class="line">   iv  IN RAW  DEFAULT NULL   --（可选的密码块初始化矢量 ,默认为NULL）</span><br><span class="line">)</span><br><span class="line"> RETURN RAW;</span><br></pre></td></tr></table></figure><br>加密存储过程<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DBMS_CRYPTO.ENCRYPT(</span><br><span class="line">   dst IN OUT NOCOPY BLOB,    -- LOB locator of output data. The value in the output LOB &lt;dst&gt; will be overwritten.</span><br><span class="line">   src IN            BLOB,</span><br><span class="line">   typ IN            PLS_INTEGER,</span><br><span class="line">   key IN            RAW,</span><br><span class="line">   iv  IN            RAW          DEFAULT NULL);</span><br><span class="line"></span><br><span class="line">DBMS_CRYPTO.ENCRYPT(</span><br><span class="line">   dst IN OUT NOCOPY BLOB,</span><br><span class="line">   src IN            CLOB         CHARACTER SET ANY_CS,</span><br><span class="line">   typ IN            PLS_INTEGER,</span><br><span class="line">   key IN            RAW,</span><br><span class="line">   iv  IN            RAW          DEFAULT NULL);</span><br></pre></td></tr></table></figure></p><p>哈希函数<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DBMS_CRYPTO.Hash (</span><br><span class="line">   src IN RAW,</span><br><span class="line">   typ IN PLS_INTEGER)</span><br><span class="line"> RETURN RAW;</span><br><span class="line"></span><br><span class="line">DBMS_CRYPTO.Hash (</span><br><span class="line">   src IN BLOB,</span><br><span class="line">   typ IN PLS_INTEGER)</span><br><span class="line"> RETURN RAW;</span><br><span class="line"></span><br><span class="line">DBMS_CRYPTO.Hash (</span><br><span class="line">   src IN CLOB CHARACTER SET ANY_CS,</span><br><span class="line">   typ IN PLS_INTEGER)</span><br><span class="line"> RETURN RAW;</span><br></pre></td></tr></table></figure></p><p>MAC 函数<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DBMS_CRYPTO.MAC (</span><br><span class="line">   src IN RAW,</span><br><span class="line">   typ IN PLS_INTEGER,</span><br><span class="line">   key IN RAW)</span><br><span class="line"> RETURN RAW;</span><br><span class="line"></span><br><span class="line">DBMS_CRYPTO.MAC (</span><br><span class="line">   src IN BLOB,</span><br><span class="line">   typ IN PLS_INTEGER</span><br><span class="line">   key IN RAW)</span><br><span class="line"> RETURN RAW;</span><br><span class="line"></span><br><span class="line">DBMS_CRYPTO.MAC (</span><br><span class="line">   src IN CLOB CHARACTER SET ANY_CS,</span><br><span class="line">   typ IN PLS_INTEGER</span><br><span class="line">   key IN RAW)</span><br><span class="line"> RETURN RAW;</span><br></pre></td></tr></table></figure><br>RANDOMBYTES  随机字节函数<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DBMS_CRYPTO.RANDOMBYTES (</span><br><span class="line">   number_bytes IN POSITIVE)</span><br><span class="line"> RETURN RAW;</span><br></pre></td></tr></table></figure><br>RANDOMINTEGER  随机整数函数<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DBMS_CRYPTO.RANDOMINTEGER</span><br><span class="line"> RETURN BINARY_INTEGER;</span><br></pre></td></tr></table></figure><br>RANDOMNUMBER   随机数字函数  数值范围[0..2**128-1]<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DBMS_CRYPTO.RANDOMNUMBER</span><br><span class="line">  RETURN NUMBER;</span><br></pre></td></tr></table></figure></p><h1 id="将加解密函数用于SQL查询中"><a href="#将加解密函数用于SQL查询中" class="headerlink" title="将加解密函数用于SQL查询中"></a>将加解密函数用于SQL查询中</h1><p>上面提到的哈希以及加密算法都是PLS_INTEGER类型。并预定义在PL/SQL 环境中。如果我们只想在SQL 环境下使用。应该怎么处理？<br>首先我们得找到 这些预定义名字对应的PLS_INTERGER 值。然后就可以使用了。</p><h2 id="利用代码块来打印相应算法对应的-PLS-INTEGER-值"><a href="#利用代码块来打印相应算法对应的-PLS-INTEGER-值" class="headerlink" title="利用代码块来打印相应算法对应的 PLS_INTEGER 值"></a>利用代码块来打印相应算法对应的 PLS_INTEGER 值</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> </span><br><span class="line">  v_typ PLS_INTEGER;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> t <span class="keyword">in</span> (<span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.ENCRYPT_DES&#x27;</span> <span class="keyword">AS</span> KEY,DBMS_CRYPTO.ENCRYPT_DES <span class="keyword">AS</span> <span class="keyword">VALUE</span> <span class="keyword">from</span> dual </span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.ENCRYPT_3DES_2KEY&#x27;</span>,DBMS_CRYPTO.ENCRYPT_3DES_2KEY <span class="keyword">from</span> dual </span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.ENCRYPT_3DES&#x27;</span>,DBMS_CRYPTO.ENCRYPT_3DES <span class="keyword">from</span> dual</span><br><span class="line">          <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.ENCRYPT_AES128&#x27;</span>,DBMS_CRYPTO.ENCRYPT_AES128 <span class="keyword">from</span> dual</span><br><span class="line">           <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.ENCRYPT_AES192&#x27;</span>,DBMS_CRYPTO.ENCRYPT_AES192 <span class="keyword">from</span> dual</span><br><span class="line">           <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.ENCRYPT_AES256&#x27;</span>,DBMS_CRYPTO.ENCRYPT_AES256 <span class="keyword">from</span> dual</span><br><span class="line">           <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.ENCRYPT_RC4&#x27;</span>,DBMS_CRYPTO.ENCRYPT_RC4 <span class="keyword">from</span> dual</span><br><span class="line">           <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.CHAIN_CBC&#x27;</span>,DBMS_CRYPTO.CHAIN_CBC <span class="keyword">from</span> dual</span><br><span class="line">           <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.PAD_PKCS5&#x27;</span>,DBMS_CRYPTO.PAD_PKCS5 <span class="keyword">from</span> dual</span><br><span class="line">           )</span><br><span class="line">   LOOP</span><br><span class="line">       dbms_output.put_line(t.key<span class="operator">||</span><span class="string">&#x27;:&#x27;</span><span class="operator">||</span>t.value);</span><br><span class="line">   <span class="keyword">end</span> loop;</span><br><span class="line">   v_typ :<span class="operator">=</span> DBMS_CRYPTO.ENCRYPT_AES256</span><br><span class="line">   <span class="operator">+</span>DBMS_CRYPTO.CHAIN_CBC</span><br><span class="line">   <span class="operator">+</span>DBMS_CRYPTO.PAD_PKCS5;</span><br><span class="line">   dbms_output.put_line(v_typ);</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">## 加密算法以及他们对应的PLS_INTEGER 数值    </span><br><span class="line">DBMS_CRYPTO.ENCRYPT_DES:<span class="number">1</span></span><br><span class="line">DBMS_CRYPTO.ENCRYPT_3DES_2KEY:<span class="number">2</span></span><br><span class="line">DBMS_CRYPTO.ENCRYPT_3DES:<span class="number">3</span></span><br><span class="line">DBMS_CRYPTO.ENCRYPT_AES128:<span class="number">6</span></span><br><span class="line">DBMS_CRYPTO.ENCRYPT_AES192:<span class="number">7</span></span><br><span class="line">DBMS_CRYPTO.ENCRYPT_AES256:<span class="number">8</span></span><br><span class="line">DBMS_CRYPTO.ENCRYPT_RC4:<span class="number">129</span></span><br><span class="line">DBMS_CRYPTO.CHAIN_CBC:<span class="number">256</span></span><br><span class="line">DBMS_CRYPTO.PAD_PKCS5:<span class="number">4096</span></span><br><span class="line"><span class="number">4360</span>   </span><br></pre></td></tr></table></figure><h2 id="同样的方法我们能获得hash-算法的PLS-INTEGER-数值"><a href="#同样的方法我们能获得hash-算法的PLS-INTEGER-数值" class="headerlink" title="同样的方法我们能获得hash 算法的PLS_INTEGER 数值"></a>同样的方法我们能获得hash 算法的PLS_INTEGER 数值</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> </span><br><span class="line">  v_typ PLS_INTEGER;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">for</span> t <span class="keyword">in</span> (<span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.HASH_MD4&#x27;</span> <span class="keyword">AS</span> KEY,DBMS_CRYPTO.HASH_MD4 <span class="keyword">AS</span> <span class="keyword">VALUE</span> <span class="keyword">from</span> dual </span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.HASH_MD5&#x27;</span>,DBMS_CRYPTO.HASH_MD5 <span class="keyword">from</span> dual </span><br><span class="line">              <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.HASH_SH1&#x27;</span>,DBMS_CRYPTO.HASH_SH1 <span class="keyword">from</span> dual</span><br><span class="line">          <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.HASH_SH256&#x27;</span>,DBMS_CRYPTO.HASH_SH256 <span class="keyword">from</span> dual</span><br><span class="line">           <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.HASH_SH384&#x27;</span>,DBMS_CRYPTO.HASH_SH384 <span class="keyword">from</span> dual</span><br><span class="line">           <span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line">           <span class="keyword">select</span> <span class="string">&#x27;DBMS_CRYPTO.HASH_SH512&#x27;</span>,DBMS_CRYPTO.HASH_SH512 <span class="keyword">from</span> dual</span><br><span class="line">           )</span><br><span class="line">   LOOP</span><br><span class="line">       dbms_output.put_line(t.key<span class="operator">||</span><span class="string">&#x27;:&#x27;</span><span class="operator">||</span>t.value);</span><br><span class="line">   <span class="keyword">end</span> loop;</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line">DBMS_CRYPTO.HASH_MD4:<span class="number">1</span></span><br><span class="line">DBMS_CRYPTO.HASH_MD5:<span class="number">2</span></span><br><span class="line">DBMS_CRYPTO.HASH_SH1:<span class="number">3</span></span><br><span class="line">DBMS_CRYPTO.HASH_SH256:<span class="number">4</span></span><br><span class="line">DBMS_CRYPTO.HASH_SH384:<span class="number">5</span></span><br><span class="line">DBMS_CRYPTO.HASH_SH512:<span class="number">6</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="加解密SQL-示例"><a href="#加解密SQL-示例" class="headerlink" title="加解密SQL 示例"></a>加解密SQL 示例</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dbms_crypto.encrypt(</span><br><span class="line">   src <span class="operator">=</span><span class="operator">&gt;</span> UTL_I18N.STRING_TO_RAW(<span class="string">&#x27;gh_3075c0db1aca&#x27;</span>,<span class="string">&#x27;AL32UTF8&#x27;</span>),</span><br><span class="line">   typ <span class="operator">=</span><span class="operator">&gt;</span> <span class="number">4360</span>,</span><br><span class="line">   key <span class="operator">=</span><span class="operator">&gt;</span> utl_raw.CAST_TO_RAW(<span class="string">&#x27;00123456789012345678901234567890&#x27;</span>)) <span class="keyword">as</span> encrow </span><br><span class="line"><span class="keyword">from</span> dual </span><br><span class="line"></span><br><span class="line">UTL_I18N.STRING_TO_RAW(<span class="string">&#x27;gh_3075c0db1aca&#x27;</span>,<span class="string">&#x27;AL32UTF8&#x27;</span>) 为需要加密的串，先转成AL32UTF8,再转成<span class="type">ROW</span></span><br><span class="line"><span class="number">4360</span> 对应的就是加密算法。这个数值怎么来 就是 加密算法 <span class="operator">+</span> CBC <span class="operator">+</span>PAD <span class="operator">=</span>  <span class="number">8</span> (DBMS_CRYPTO.ENCRYPT_AES256) <span class="operator">+</span>  <span class="number">256</span> (DBMS_CRYPTO.CHAIN_CBC) <span class="operator">+</span> <span class="number">4096</span> (DBMS_CRYPTO.PAD_PKCS5)</span><br><span class="line">utl_raw.CAST_TO_RAW(<span class="string">&#x27;00123456789012345678901234567890&#x27;</span>) 为秘钥,也需要转换为RAW类型</span><br><span class="line">iv 省略，使用了默认空值</span><br><span class="line"></span><br><span class="line">得到加密串为 </span><br><span class="line"><span class="number">2</span>CA6B7DD8BF347D238711A5B0D17A0DF</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> UTL_I18N.RAW_TO_CHAR(  <span class="comment">-- 将raw 转换为varchar2</span></span><br><span class="line">        DBMS_CRYPTO.DECRYPT(</span><br><span class="line">           src <span class="operator">=</span><span class="operator">&gt;</span> <span class="string">&#x27;2CA6B7DD8BF347D238711A5B0D17A0DF&#x27;</span>,</span><br><span class="line">           typ <span class="operator">=</span><span class="operator">&gt;</span> <span class="number">4360</span>,     <span class="comment">--加密算法与上相同</span></span><br><span class="line">           key <span class="operator">=</span><span class="operator">&gt;</span> utl_raw.CAST_TO_RAW(<span class="string">&#x27;00123456789012345678901234567890&#x27;</span>) <span class="comment">-- 秘钥与加密秘钥相同</span></span><br><span class="line">        ),</span><br><span class="line">       <span class="string">&#x27;AL32UTF8&#x27;</span>)  </span><br><span class="line"><span class="keyword">from</span> dual</span><br><span class="line">## 解密出来的字符串串与加密相同</span><br><span class="line">gh_3075c0db1aca</span><br></pre></td></tr></table></figure><h2 id="字符串hash-示例"><a href="#字符串hash-示例" class="headerlink" title="字符串hash 示例"></a>字符串hash 示例</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> DBMS_CRYPTO.HASH(</span><br><span class="line">       src <span class="operator">=</span><span class="operator">&gt;</span> UTL_I18N.STRING_TO_RAW( <span class="string">&#x27;The Little Brown Fox&#x27;</span>, <span class="string">&#x27;AL32UTF8&#x27;</span> ), </span><br><span class="line">       typ <span class="operator">=</span><span class="operator">&gt;</span> <span class="number">4</span> <span class="comment">/* DBMS_CRYPTO.HASH_SH256 对应的数值就是 4 */</span> )</span><br><span class="line"> <span class="keyword">from</span> dual ;</span><br><span class="line">得到的hash 串为:</span><br><span class="line">F3DAFB6DB9169798CED60C1DF1BA3D354D579594DF3963A2172C130A012DDA7A</span><br></pre></td></tr></table></figure><h2 id="详见"><a href="#详见" class="headerlink" title="详见"></a>详见</h2><p><a href="https://docs.oracle.com/en/database/oracle/oracle-database/12.2/arpls/DBMS_CRYPTO.html#GUID-CE3CF17D-E781-47CB-AEE7-19A9B2BCD3EC">https://docs.oracle.com/en/database/oracle/oracle-database/12.2/arpls/DBMS_CRYPTO.html#GUID-CE3CF17D-E781-47CB-AEE7-19A9B2BCD3EC</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;DBMS_CRYPTO 位于 SYS schema 下，对其他用户可授权&lt;br&gt;grant execute on sys.DBMS_CRYPTO to user;&lt;/p&gt;
&lt;p&gt;DBMS_CRYPTO的函数里的参数数据类型包括&lt;br&gt;BLOB  CLOB  PLS_INTE</summary>
      
    
    
    
    <category term="oracle" scheme="https://sheenzxx.github.io/categories/oracle/"/>
    
    
    <category term="hash" scheme="https://sheenzxx.github.io/tags/hash/"/>
    
    <category term="encrypto" scheme="https://sheenzxx.github.io/tags/encrypto/"/>
    
    <category term="decrypto" scheme="https://sheenzxx.github.io/tags/decrypto/"/>
    
  </entry>
  
  <entry>
    <title>利用 mysqlsh 搭建 innodb cluster</title>
    <link href="https://sheenzxx.github.io/2024/01/08/innodbCluster/"/>
    <id>https://sheenzxx.github.io/2024/01/08/innodbCluster/</id>
    <published>2024-01-08T04:08:26.000Z</published>
    <updated>2024-01-08T07:42:06.360Z</updated>
    
    <content type="html"><![CDATA[<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><h2 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h2><p>db-56-17<br>db-56-18<br>db-56-19<br>端口3308</p><h2 id="mysql-组复制相关配置"><a href="#mysql-组复制相关配置" class="headerlink" title="mysql 组复制相关配置"></a>mysql 组复制相关配置</h2><p>详细配置请参考 《mysql8.2搭建单主模式组复制及相关知识》<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">disabled_storage_engines=&quot;MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY&quot;</span><br><span class="line">server-id = &#123;各实例不同&#125;</span><br><span class="line">log_replica_updates = true </span><br><span class="line">gtid_mode=ON </span><br><span class="line">enforce_gtid_consistency=ON </span><br><span class="line">plugin_load_add = &quot;group_replication.so&quot;</span><br><span class="line">plugin_load_add=mysql_clone.so</span><br><span class="line">binlog_checksum = NONE </span><br><span class="line">group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot; ##UUID 可以通过select uuid() 获取 各个实例相同</span><br><span class="line">group_replication_start_on_boot=off </span><br><span class="line">group_replication_local_address= &quot;db-56-17:33081&quot; ## 各个实例不同对应各自的hostname</span><br><span class="line">group_replication_group_seeds= &quot;db-56-17:33081,db-56-18:33081,db-56-19:33081&quot;</span><br><span class="line">group_replication_bootstrap_group=off</span><br><span class="line">binlog_transaction_dependency_tracking=WRITESET</span><br><span class="line">group_replication_tls_source = mysql_admin</span><br></pre></td></tr></table></figure></p><h2 id="集群管理员需要的权限"><a href="#集群管理员需要的权限" class="headerlink" title="集群管理员需要的权限"></a>集群管理员需要的权限</h2><h4 id="手动授权需要的权限"><a href="#手动授权需要的权限" class="headerlink" title="手动授权需要的权限"></a>手动授权需要的权限</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">1) 集群管理账号必须具有对全局 *.* 有以下权限</span><br><span class="line">RELOAD, SHUTDOWN, PROCESS, FILE, SELECT, SUPER, REPLICATION SLAVE, REPLICATION CLIENT, REPLICATION_APPLIER, CREATE USER, </span><br><span class="line">SYSTEM_VARIABLES_ADMIN, PERSIST_RO_VARIABLES_ADMIN, BACKUP_ADMIN, CLONE_ADMIN, and EXECUTE.</span><br><span class="line">其中</span><br><span class="line">SUPER 权限包含以下权限: </span><br><span class="line">SYSTEM_VARIABLES_ADMIN, SESSION_VARIABLES_ADMIN, REPLICATION_SLAVE_ADMIN, GROUP_REPLICATION_ADMIN, REPLICATION_SLAVE_ADMIN, ROLE_ADMIN.</span><br><span class="line">2) 指定schema的权限</span><br><span class="line">对 mysql_innodb_cluster_metadata.*, mysql_innodb_cluster_metadata_bkp.*, and mysql_innodb_cluster_metadata_previous.* 具有以下权限</span><br><span class="line">ALTER, ALTER ROUTINE, CREATE, CREATE ROUTINE, CREATE TEMPORARY TABLES, CREATE VIEW, DELETE, DROP, EVENT, EXECUTE, INDEX, INSERT, LOCK TABLES, REFERENCES, SHOW VIEW, TRIGGER, UPDATE; </span><br><span class="line">3) 对mysql.*具有以下权限</span><br><span class="line">INSERT, UPDATE, DELETE.</span><br><span class="line"></span><br><span class="line">4) 如果只是具有只读权限的监控账号，则需要授权如下</span><br><span class="line">GRANT SELECT ON mysql_innodb_cluster_metadata.* TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON mysql.slave_master_info TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON mysql.user TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.global_status TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.global_variables TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.replication_applier_configuration TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.replication_applier_status TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.replication_applier_status_by_coordinator TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.replication_applier_status_by_worker TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.replication_connection_configuration TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.replication_connection_status TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.replication_group_member_stats TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.replication_group_members TO your_user@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON performance_schema.threads TO your_user@&#x27;%&#x27; WITH GRANT OPTION;</span><br></pre></td></tr></table></figure><h4 id="innodb-cluster-内部自动创建复制账号"><a href="#innodb-cluster-内部自动创建复制账号" class="headerlink" title="innodb cluster 内部自动创建复制账号"></a>innodb cluster 内部自动创建复制账号</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT REPLICATION SLAVE ON *.* to internal_user;</span><br></pre></td></tr></table></figure><h4 id="通过adminapi-管理集群管理员账号"><a href="#通过adminapi-管理集群管理员账号" class="headerlink" title="通过adminapi 管理集群管理员账号"></a>通过adminapi 管理集群管理员账号</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">创建管理员账号</span><br><span class="line">cluster.setupAdminAccount()</span><br><span class="line">创建mysqlrouter的账号</span><br><span class="line">cluster.setupRouterAccount()</span><br><span class="line">重置账号的密码</span><br><span class="line">Cluster.resetRecoveryAccountsPassword() </span><br></pre></td></tr></table></figure><h2 id="安装mysqlshell"><a href="#安装mysqlshell" class="headerlink" title="安装mysqlshell"></a>安装mysqlshell</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf mysql-shell-8.2.1-linux-glibc2.17-x86-64bit.tar.gz</span><br><span class="line">chown -R mysql.mysql mysql-shell-8.2.1-linux-glibc2.17-x86-64bit</span><br><span class="line">ln -s /usr/local/mysql-shell /data/mysql-shell-8.2.1-linux-glibc2.17-x86-64bit</span><br><span class="line">将路径写到环境变量中</span><br></pre></td></tr></table></figure><h2 id="安装mysqlrouter"><a href="#安装mysqlrouter" class="headerlink" title="安装mysqlrouter"></a>安装mysqlrouter</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf mysql-router-8.2.0-linux-glibc2.17-x86_64.tar.xz</span><br><span class="line">chown -R mysql-router-8.2.0-linux-glibc2.17-x86_64</span><br><span class="line">ln -s /usr/local/mysql-router mysql-router-8.2.0-linux-glibc2.17-x86_64</span><br><span class="line">将路径写到环境变量中</span><br></pre></td></tr></table></figure><h1 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h1><h2 id="三个实例初始化，启动"><a href="#三个实例初始化，启动" class="headerlink" title="三个实例初始化，启动"></a>三个实例初始化，启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data_innodb_cluster</span><br></pre></td></tr></table></figure><p>并修改root 密码</p><h2 id="创建管理员账号。每个实例上都创建-验证安装条件需要"><a href="#创建管理员账号。每个实例上都创建-验证安装条件需要" class="headerlink" title="创建管理员账号。每个实例上都创建(验证安装条件需要)"></a>创建管理员账号。每个实例上都创建(验证安装条件需要)</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> icadmin@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;icadmin&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> RELOAD, SHUTDOWN, PROCESS, FILE, <span class="keyword">SELECT</span>, SUPER, REPLICATION SLAVE, REPLICATION CLIENT, REPLICATION_APPLIER, <span class="keyword">CREATE</span> <span class="keyword">USER</span>, SYSTEM_VARIABLES_ADMIN, PERSIST_RO_VARIABLES_ADMIN, BACKUP_ADMIN, CLONE_ADMIN,<span class="keyword">EXECUTE</span> <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> icadmin@<span class="string">&#x27;%&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br><span class="line"><span class="keyword">GRANT</span> CONNECTION_ADMIN, GROUP_REPLICATION_ADMIN, REPLICATION_SLAVE_ADMIN, ROLE_ADMIN <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;icadmin&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">DELETE</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span> <span class="keyword">ON</span> mysql.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;icadmin&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALTER</span>, <span class="keyword">ALTER</span> ROUTINE, <span class="keyword">CREATE</span>, <span class="keyword">CREATE</span> ROUTINE, <span class="keyword">CREATE</span> TEMPORARY TABLES, <span class="keyword">CREATE</span> <span class="keyword">VIEW</span>, <span class="keyword">DELETE</span>, <span class="keyword">DROP</span>, EVENT, INDEX, <span class="keyword">INSERT</span>, LOCK TABLES, <span class="keyword">REFERENCES</span>, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, <span class="keyword">TRIGGER</span>, <span class="keyword">UPDATE</span> <span class="keyword">ON</span> mysql_innodb_cluster_metadata.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;icadmin&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALTER</span>, <span class="keyword">ALTER</span> ROUTINE, <span class="keyword">CREATE</span>, <span class="keyword">CREATE</span> ROUTINE, <span class="keyword">CREATE</span> TEMPORARY TABLES, <span class="keyword">CREATE</span> <span class="keyword">VIEW</span>, <span class="keyword">DELETE</span>, <span class="keyword">DROP</span>, EVENT, INDEX, <span class="keyword">INSERT</span>, LOCK TABLES, <span class="keyword">REFERENCES</span>, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, <span class="keyword">TRIGGER</span>, <span class="keyword">UPDATE</span> <span class="keyword">ON</span> mysql_innodb_cluster_metadata_bkp.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;icadmin&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALTER</span>, <span class="keyword">ALTER</span> ROUTINE, <span class="keyword">CREATE</span>, <span class="keyword">CREATE</span> ROUTINE, <span class="keyword">CREATE</span> TEMPORARY TABLES, <span class="keyword">CREATE</span> <span class="keyword">VIEW</span>, <span class="keyword">DELETE</span>, <span class="keyword">DROP</span>, EVENT, INDEX, <span class="keyword">INSERT</span>, LOCK TABLES, <span class="keyword">REFERENCES</span>, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, <span class="keyword">TRIGGER</span>, <span class="keyword">UPDATE</span> <span class="keyword">ON</span> mysql_innodb_cluster_metadata_previous.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;icadmin&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br></pre></td></tr></table></figure><h2 id="在db-56-17登录mysqlsh-连接56-17实例-验证每个节点是否符合要求-如果不符合要求。会将所有要求列出。按要求把实例该补的都补上"><a href="#在db-56-17登录mysqlsh-连接56-17实例-验证每个节点是否符合要求-如果不符合要求。会将所有要求列出。按要求把实例该补的都补上" class="headerlink" title="在db-56-17登录mysqlsh 连接56-17实例,验证每个节点是否符合要求,如果不符合要求。会将所有要求列出。按要求把实例该补的都补上"></a>在db-56-17登录mysqlsh 连接56-17实例,验证每个节点是否符合要求,如果不符合要求。会将所有要求列出。按要求把实例该补的都补上</h2><p>dba.checkInstanceConfiguration(‘icadmin@localhost:3308’)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">[mysql@db-56-17 mysql]$ mysqlsh -S /tmp/mysql.innodb_cluster.sock</span><br><span class="line">MySQL Shell 8.2.1</span><br><span class="line"></span><br><span class="line">Copyright (c) 2016, 2023, Oracle and/or its affiliates.</span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its affiliates.</span><br><span class="line">Other names may be trademarks of their respective owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;\help&#x27; or &#x27;\?&#x27; for help; &#x27;\quit&#x27; to exit.</span><br><span class="line">Creating a Classic session to &#x27;root@/tmp%2Fmysql.innodb_cluster.sock&#x27;</span><br><span class="line">Fetching schema names for auto-completion... Press ^C to stop.</span><br><span class="line">Your MySQL connection id is 18</span><br><span class="line">Server version: 8.2.0 MySQL Community Server - GPL</span><br><span class="line">No default schema selected; type \use &lt;schema&gt; to set one.</span><br><span class="line"> MySQL  localhost  JS &gt; dba.checkInstanceConfiguration(&#x27;icadmin@localhost:3308&#x27;)</span><br><span class="line">Please provide the password for &#x27;icadmin@localhost:3308&#x27;: *******</span><br><span class="line">Save password for &#x27;icadmin@localhost:3308&#x27;? [Y]es/[N]o/Ne[v]er (default No): y</span><br><span class="line">Dba.checkInstanceConfiguration: Unable to detect state for instance &#x27;db-56-17:3308&#x27;. Please check account privileges. (RuntimeError)</span><br><span class="line"> MySQL  localhost  JS &gt; dba.checkInstanceConfiguration(&#x27;icadmin@db-56-17:3308&#x27;)</span><br><span class="line">Dba.checkInstanceConfiguration: Unable to detect state for instance &#x27;db-56-17:3308&#x27;. Please check account privileges. (RuntimeError)</span><br><span class="line"> MySQL  localhost  JS &gt; dba.checkInstanceConfiguration(&#x27;icadmin@db-56-17:3308&#x27;)</span><br><span class="line">Validating local MySQL instance listening at port 3308 for use in an InnoDB cluster...</span><br><span class="line">ERROR: The account &#x27;icadmin&#x27;@&#x27;%&#x27; is missing privileges required to manage an InnoDB cluster: </span><br><span class="line">GRANT DELETE, INSERT, UPDATE ON mysql.* TO &#x27;icadmin&#x27;@&#x27;%&#x27; WITH GRANT OPTION;</span><br><span class="line">GRANT ALTER, ALTER ROUTINE, CREATE, CREATE ROUTINE, CREATE TEMPORARY TABLES, CREATE VIEW, DELETE, DROP, EVENT, INDEX, INSERT, LOCK TABLES, REFERENCES, SHOW VIEW, TRIGGER, UPDATE ON mysql_innodb_cluster_metadata.* TO &#x27;icadmin&#x27;@&#x27;%&#x27; WITH GRANT OPTION;</span><br><span class="line">GRANT ALTER, ALTER ROUTINE, CREATE, CREATE ROUTINE, CREATE TEMPORARY TABLES, CREATE VIEW, DELETE, DROP, EVENT, INDEX, INSERT, LOCK TABLES, REFERENCES, SHOW VIEW, TRIGGER, UPDATE ON mysql_innodb_cluster_metadata_bkp.* TO &#x27;icadmin&#x27;@&#x27;%&#x27; WITH GRANT OPTION;</span><br><span class="line">GRANT ALTER, ALTER ROUTINE, CREATE, CREATE ROUTINE, CREATE TEMPORARY TABLES, CREATE VIEW, DELETE, DROP, EVENT, INDEX, INSERT, LOCK TABLES, REFERENCES, SHOW VIEW, TRIGGER, UPDATE ON mysql_innodb_cluster_metadata_previous.* TO &#x27;icadmin&#x27;@&#x27;%&#x27; WITH GRANT OPTION;</span><br><span class="line">For more information, see the online documentation.</span><br><span class="line">Dba.checkInstanceConfiguration: The account &#x27;icadmin&#x27;@&#x27;%&#x27; is missing privileges required to manage an InnoDB cluster. (RuntimeError)</span><br><span class="line"> MySQL  localhost  JS &gt; dba.checkInstanceConfiguration(&#x27;icadmin@db-56-17:3308&#x27;)</span><br><span class="line">Validating local MySQL instance listening at port 3308 for use in an InnoDB cluster...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as db-56-17:3308</span><br><span class="line">Clients and other cluster members will communicate with it through this address by default. If this is not correct, the report_host MySQL system variable should be changed.</span><br><span class="line"></span><br><span class="line">Checking whether existing tables comply with Group Replication requirements...</span><br><span class="line">No incompatible tables detected</span><br><span class="line"></span><br><span class="line">Checking instance configuration...</span><br><span class="line"></span><br><span class="line">NOTE: Some configuration options need to be fixed:</span><br><span class="line">+----------------------------------------+---------------+----------------+----------------------------+</span><br><span class="line">| Variable                               | Current Value | Required Value | Note                       |</span><br><span class="line">+----------------------------------------+---------------+----------------+----------------------------+</span><br><span class="line">| binlog_transaction_dependency_tracking | COMMIT_ORDER  | WRITESET       | Update the server variable |</span><br><span class="line">+----------------------------------------+---------------+----------------+----------------------------+</span><br><span class="line"></span><br><span class="line">NOTE: Please use the dba.configureInstance() command to repair these issues.</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;config_errors&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;action&quot;: &quot;server_update&quot;, </span><br><span class="line">            &quot;current&quot;: &quot;COMMIT_ORDER&quot;, </span><br><span class="line">            &quot;option&quot;: &quot;binlog_transaction_dependency_tracking&quot;, </span><br><span class="line">            &quot;required&quot;: &quot;WRITESET&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ], </span><br><span class="line">    &quot;status&quot;: &quot;error&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>  修复后验证通过<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost  JS &gt; dba.checkInstanceConfiguration(&#x27;icadmin@db-56-17:3308&#x27;)</span><br><span class="line">Validating local MySQL instance listening at port 3308 for use in an InnoDB cluster...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as db-56-17:3308</span><br><span class="line">Clients and other cluster members will communicate with it through this address by default. If this is not correct, the report_host MySQL system variable should be changed.</span><br><span class="line"></span><br><span class="line">Checking whether existing tables comply with Group Replication requirements...</span><br><span class="line">No incompatible tables detected</span><br><span class="line"></span><br><span class="line">Checking instance configuration...</span><br><span class="line">Instance configuration is compatible with InnoDB cluster</span><br><span class="line"></span><br><span class="line">The instance &#x27;db-56-17:3308&#x27; is valid to be used in an InnoDB cluster.</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;status&quot;: &quot;ok&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>  接着验证其他2个节点</p><p>  MySQL  localhost  JS &gt; dba.checkInstanceConfiguration(‘icadmin@db-56-18:3308’)<br>  MySQL  localhost  JS &gt; dba.checkInstanceConfiguration(‘icadmin@db-56-19:3308’)</p><h2 id="配置集群节点-dba-configureInstance-‘icadmin-db-56-xx-3308’"><a href="#配置集群节点-dba-configureInstance-‘icadmin-db-56-xx-3308’" class="headerlink" title="配置集群节点 dba.configureInstance(‘icadmin@db-56-xx:3308’)"></a>配置集群节点 dba.configureInstance(‘icadmin@db-56-xx:3308’)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  localhost  JS &gt; dba.configureInstance(&#x27;icadmin@db-56-17:3308&#x27;)</span><br><span class="line">Configuring local MySQL instance listening at port 3308 for use in an InnoDB cluster...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as db-56-17:3308</span><br><span class="line">Clients and other cluster members will communicate with it through this address by default. If this is not correct, the report_host MySQL system variable should be changed.</span><br><span class="line"></span><br><span class="line">applierWorkerThreads will be set to the default value of 4.</span><br><span class="line"></span><br><span class="line">The instance &#x27;db-56-17:3308&#x27; is valid to be used in an InnoDB cluster.</span><br><span class="line">The instance &#x27;db-56-17:3308&#x27; is already ready to be used in an InnoDB cluster.</span><br><span class="line"></span><br><span class="line">Successfully enabled parallel appliers.</span><br><span class="line"> MySQL  localhost  JS &gt; dba.configureInstance(&#x27;icadmin@db-56-18:3308&#x27;)</span><br><span class="line"> MySQL  localhost  JS &gt; dba.configureInstance(&#x27;icadmin@db-56-19:3308&#x27;)</span><br></pre></td></tr></table></figure><h2 id="创建集群-var-cluster-dba-createCluster-‘InnodbCluster’"><a href="#创建集群-var-cluster-dba-createCluster-‘InnodbCluster’" class="headerlink" title="创建集群 var cluster = dba.createCluster(‘InnodbCluster’)"></a>创建集群 var cluster = dba.createCluster(‘InnodbCluster’)</h2> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  MySQL  localhost  JS&gt; var cluster = dba.createCluster(&#x27;InnodbCluster&#x27;)</span><br><span class="line">Validating instance at icadmin@db-56-17:3308...</span><br><span class="line">This instance reports its own address as db-56-17</span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">Creating InnoDB cluster &#x27;InnodbCluster&#x27; on &#x27;icadmin@db-56-17:3308&#x27;...</span><br><span class="line">Adding Seed Instance...</span><br><span class="line">Cluster successfully created. Use Cluster.addInstance() to add MySQL instances.</span><br><span class="line">At least 3 instances are needed for the cluster to be able to withstand up to</span><br><span class="line">one server failure.</span><br></pre></td></tr></table></figure><h2 id="添加其他节点-cluster-addInstance-‘icadmin-db-56-xxx-3308’"><a href="#添加其他节点-cluster-addInstance-‘icadmin-db-56-xxx-3308’" class="headerlink" title="添加其他节点 cluster.addInstance(‘icadmin@db-56-xxx:3308’)"></a>添加其他节点 cluster.addInstance(‘icadmin@db-56-xxx:3308’)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost  JS &gt; cluster.addInstance(&#x27;icadmin@db-56-18:3308&#x27;)</span><br><span class="line">WARNING: A GTID set check of the MySQL instance at &#x27;db-56-18:3308&#x27; determined that it contains transactions that do not originate from the cluster, which must be discarded before it can join the cluster.</span><br><span class="line"></span><br><span class="line">db-56-18:3308 has the following errant GTIDs that do not exist in the cluster:</span><br><span class="line">991c19f4-a955-11ee-9d83-080027e817da:1-9</span><br><span class="line"></span><br><span class="line">WARNING: Discarding these extra GTID events can either be done manually or by completely overwriting the state of db-56-18:3308 with a physical snapshot from an existing cluster member. To use this method by default, set the &#x27;recoveryMethod&#x27; option to &#x27;clone&#x27;.</span><br><span class="line"></span><br><span class="line">Having extra GTID events is not expected, and it is recommended to investigate this further and ensure that the data can be removed prior to choosing the clone recovery method.</span><br><span class="line"></span><br><span class="line">Please select a recovery method [C]lone/[A]bort (default Abort): c</span><br><span class="line">Validating instance configuration at db-56-18:3308...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as db-56-18:3308</span><br><span class="line"></span><br><span class="line">Instance configuration is suitable.</span><br><span class="line">NOTE: Group Replication will communicate with other members using &#x27;db-56-18:3308&#x27;. Use the localAddress option to override.</span><br><span class="line"></span><br><span class="line">* Checking connectivity and SSL configuration...</span><br><span class="line"></span><br><span class="line">A new instance will be added to the InnoDB Cluster. Depending on the amount of</span><br><span class="line">data on the cluster this might take from a few seconds to several hours.</span><br><span class="line"></span><br><span class="line">Adding instance to the cluster...</span><br><span class="line"></span><br><span class="line">Monitoring recovery process of the new cluster member. Press ^C to stop monitoring and let it continue in background.</span><br><span class="line">Clone based state recovery is now in progress.</span><br><span class="line"></span><br><span class="line">NOTE: A server restart is expected to happen as part of the clone process. If the</span><br><span class="line">server does not support the RESTART command or does not come back after a</span><br><span class="line">while, you may need to manually start it back.</span><br><span class="line"></span><br><span class="line">* Waiting for clone to finish...</span><br><span class="line">NOTE: db-56-18:3308 is being cloned from db-56-17:3308</span><br><span class="line">** Stage DROP DATA: Completed </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">** Clone Transfer      </span><br><span class="line">FILE COPY  ============================================================    0%  Not Started    </span><br><span class="line">PAGE COPY  ============================================================    0%  Not Started    </span><br><span class="line">REDO COPY  ============================================================    0%  Not Started</span><br><span class="line">** Clone Transfer      </span><br><span class="line">FILE COPY  ============================================================    0%  In Progress    </span><br><span class="line">PAGE COPY  ============================================================    0%  Not Started    </span><br><span class="line">REDO COPY  ============================================================    0%  Not Started</span><br><span class="line">** Clone Transfer      </span><br><span class="line">FILE COPY  ============================================================    0%  In Progress    </span><br><span class="line">PAGE COPY  ============================================================    0%  Not Started    </span><br><span class="line">REDO COPY  ============================================================    0%  Not Started</span><br><span class="line">** Clone Transfer      </span><br><span class="line">FILE COPY  ###############=============================================   25%  In Progress    </span><br><span class="line">PAGE COPY  ============================================================    0%  Not Started    </span><br><span class="line">REDO COPY  ============================================================    0%  Not Started</span><br><span class="line">** Clone Transfer      </span><br><span class="line">FILE COPY  ###############=============================================   25%  In Progress    </span><br><span class="line">PAGE COPY  ============================================================    0%  Not Started    </span><br><span class="line">REDO COPY  ============================================================    0%  Not Started</span><br><span class="line">** Clone Transfer      </span><br><span class="line">FILE COPY  ##################################==========================   57%  In Progress    </span><br><span class="line">PAGE COPY  ============================================================    0%  Not Started    </span><br><span class="line">REDO COPY  ============================================================    0%  Not Started</span><br><span class="line">** Clone Transfer      </span><br><span class="line">FILE COPY  ############################################################  100%  Completed    </span><br><span class="line">PAGE COPY  ============================================================    0%  In Progress    </span><br><span class="line">REDO COPY  ============================================================    0%  Not Started</span><br><span class="line">** Clone Transfer      </span><br><span class="line">FILE COPY  ############################################################  100%  Completed    </span><br><span class="line">PAGE COPY  ############################################################  100%  Completed    </span><br><span class="line">REDO COPY  ############################################################  100%  Completed</span><br><span class="line">NOTE: db-56-18:3308 is shutting down...</span><br><span class="line"></span><br><span class="line">* Waiting for server restart... ready </span><br><span class="line">* db-56-18:3308 has restarted, waiting for clone to finish...</span><br><span class="line">** Stage RESTART: Completed</span><br><span class="line">* Clone process has finished: 74.70 MB transferred in 2 sec (37.35 MB/s)</span><br><span class="line"></span><br><span class="line">State recovery already finished for &#x27;db-56-18:3308&#x27;</span><br><span class="line"></span><br><span class="line">The instance &#x27;db-56-18:3308&#x27; was successfully added to the cluster</span><br></pre></td></tr></table></figure><p>继续添加56-19<br>MySQL  localhost  JS &gt; cluster.addInstance(‘icadmin@db-56-19:3308’)<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">State recovery already finished for &#x27;db-56-19:3308&#x27;</span><br><span class="line"></span><br><span class="line">The instance &#x27;db-56-19:3308&#x27; was successfully added to the cluster.</span><br></pre></td></tr></table></figure></p><h2 id="检查状态-cluster-status"><a href="#检查状态-cluster-status" class="headerlink" title="检查状态 cluster.status();"></a>检查状态 cluster.status();</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> MySQL  localhost  JS &gt; cluster.status();</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;InnodbCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;db-56-17:3308&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;REQUIRED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;db-56-17:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-17:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;PRIMARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-18:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-18:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-19:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-19:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;topologyMode&quot;: &quot;Single-Primary&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;db-56-17:3308&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="mysql-router-进行引导"><a href="#mysql-router-进行引导" class="headerlink" title="mysql router 进行引导"></a>mysql router 进行引导</h2><p>   mysqlrouter —bootstrap root@localhost:3308 -d mysqlrouter</p><p>   会在当前目录下创建mysqlrouter 目录，并创建配置文件，启动脚本等<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line">After this MySQL Router has been started with the generated configuration</span><br><span class="line"></span><br><span class="line">    $ bin/mysqlrouter -c /data/mysql-router-8.2.0-linux-glibc2.17-x86_64/mysqlrouter/mysqlrouter.conf</span><br><span class="line"></span><br><span class="line">InnoDB Cluster &#x27;InnodbCluster&#x27; can be reached by connecting to:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MySQL Classic protocol</span></span></span><br><span class="line"></span><br><span class="line">- Read/Write Connections: localhost:6446</span><br><span class="line">- Read/Only Connections:  localhost:6447</span><br><span class="line">- Read/Write Split Connections: localhost:6450</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MySQL X protocol</span></span></span><br><span class="line"></span><br><span class="line">- Read/Write Connections: localhost:6448</span><br><span class="line">- Read/Only Connections:  localhost:6449</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[mysql@db-56-17 mysql-router]$ cd mysqlrouter/</span><br><span class="line">[mysql@db-56-17 mysqlrouter]$ ls</span><br><span class="line">data  log  mysqlrouter.conf  mysqlrouter.key  run  start.sh  stop.sh</span><br></pre></td></tr></table></figure></p><h2 id="启动mysqlrouter"><a href="#启动mysqlrouter" class="headerlink" title="启动mysqlrouter"></a>启动mysqlrouter</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysql@db-56-17 mysqlrouter]$ ./start.sh </span><br><span class="line"></span><br><span class="line">[mysql@db-56-17 mysqlrouter]$ mysqlsh icadmin@localhost:6446</span><br><span class="line">Please provide the password for &#x27;icadmin@localhost:6446&#x27;: *******</span><br><span class="line">Save password for &#x27;icadmin@localhost:6446&#x27;? [Y]es/[N]o/Ne[v]er (default No): y</span><br><span class="line">MySQL Shell 8.2.1</span><br></pre></td></tr></table></figure><h2 id="使用mysqlshell-连接sqlrouter-测试主从failover-过程"><a href="#使用mysqlshell-连接sqlrouter-测试主从failover-过程" class="headerlink" title="使用mysqlshell 连接sqlrouter 测试主从failover 过程"></a>使用mysqlshell 连接sqlrouter 测试主从failover 过程</h2><p>  cluster =dba.getCluster(‘InnodbCluster’)<br>  cluster.status()</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:6446 ssl  JS &gt; cluster =dba.getCluster(&#x27;InnodbCluster&#x27;)</span><br><span class="line">&lt;Cluster:InnodbCluster&gt;</span><br><span class="line"> MySQL  localhost:6446 ssl  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;InnodbCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;db-56-17:3308&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;REQUIRED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;db-56-17:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-17:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;PRIMARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-18:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-18:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-19:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-19:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;topologyMode&quot;: &quot;Single-Primary&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;db-56-17:3308&quot;</span><br><span class="line">&#125;</span><br><span class="line"> MySQL  localhost:6446 ssl  JS &gt;\sql</span><br><span class="line">MySQL  localhost:6446 ssl  SQL &gt;select @@hostname</span><br><span class="line">db-56-17</span><br></pre></td></tr></table></figure><p>  停用主库<br>  mysqld_multi stop 3</p><p>  再次查看状态<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  localhost:6446 ssl  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;InnodbCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;db-56-19:3308&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;REQUIRED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK_NO_TOLERANCE_PARTIAL&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is NOT tolerant to any failures. 1 member is not active.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;db-56-17:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-17:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;n/a&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;shellConnectError&quot;: &quot;MySQL Error 2003: Could not open connection to &#x27;db-56-17:3308&#x27;: Can&#x27;t connect to MySQL server on &#x27;db-56-17:3308&#x27; (111)&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;(MISSING)&quot;    ##已经检测到异常</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-18:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-18:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-19:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-19:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;PRIMARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;topologyMode&quot;: &quot;Single-Primary&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;db-56-19:3308&quot;</span><br><span class="line">&#125;</span><br><span class="line"> MySQL  localhost:6446 ssl  JS &gt;\sql</span><br><span class="line"> MySQL  localhost:6446 ssl  SQL &gt;\sqlselect @@hostname   ## 主库已切换至db-56-19上</span><br><span class="line">db-56-19  </span><br></pre></td></tr></table></figure></p><p>  重新启动主库<br>  mysqld_multi start 3<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:6446 ssl  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;InnodbCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;db-56-19:3308&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;REQUIRED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure. 1 member is not active.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;db-56-17:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-17:3308&quot;, </span><br><span class="line">                &quot;instanceErrors&quot;: [</span><br><span class="line">                    &quot;NOTE: The required parallel-appliers settings are not enabled on the instance. Use dba.configureInstance() to fix it.&quot;  ##因为参数配置问题。导致重启出现错误</span><br><span class="line">                ], </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;n/a&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;recovery&quot;: &#123;</span><br><span class="line">                    &quot;state&quot;: &quot;ON&quot;</span><br><span class="line">                &#125;, </span><br><span class="line">                &quot;recoveryStatusText&quot;: &quot;Distributed recovery in progress&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;RECOVERING&quot;,   ## 处于recoverying 状态</span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-18:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-18:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-19:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-19:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;PRIMARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;topologyMode&quot;: &quot;Single-Primary&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;db-56-19:3308&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>  修正错误 binlog_transaction_dependency_tracking 正确值应该为 WRITESET<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3308 ssl  JS &gt; dba.configureInstance(&#x27;icadmin@db-56-17:3308&#x27;,&#123;applierWorkerThreads: 4, restart: true&#125;)</span><br><span class="line">The instance &#x27;db-56-17:3308&#x27; belongs to an InnoDB Cluster.</span><br><span class="line">Configuring local MySQL instance listening at port 3308 for use in an InnoDB cluster...</span><br><span class="line"></span><br><span class="line">This instance reports its own address as db-56-17:3308</span><br><span class="line">Clients and other cluster members will communicate with it through this address by default. If this is not correct, the report_host MySQL system variable should be changed.</span><br><span class="line"></span><br><span class="line">NOTE: Some configuration options need to be fixed:</span><br><span class="line">+----------------------------------------+---------------+----------------+----------------------------+</span><br><span class="line">| Variable                               | Current Value | Required Value | Note                       |</span><br><span class="line">+----------------------------------------+---------------+----------------+----------------------------+</span><br><span class="line">| binlog_transaction_dependency_tracking | COMMIT_ORDER  | WRITESET       | Update the server variable |</span><br><span class="line">+----------------------------------------+---------------+----------------+----------------------------+</span><br><span class="line"></span><br><span class="line">Do you want to perform the required configuration changes? [y/n]: y    #输入y 字段修改为 writeset</span><br><span class="line">Configuring instance...</span><br><span class="line"></span><br><span class="line">WARNING: &#x27;@@binlog_transaction_dependency_tracking&#x27; is deprecated and will be removed in a future release. (Code 1287).</span><br><span class="line">The instance &#x27;db-56-17:3308&#x27; was configured to be used in an InnoDB cluster.</span><br><span class="line"> MySQL  localhost:3308 ssl  JS &gt; \sql</span><br></pre></td></tr></table></figure></p><p>  最终正常恢复。节点加入集群<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost:3308 ssl  JS &gt; cluster = dba.getCluster(&#x27;InnodbCluster&#x27;)</span><br><span class="line">&lt;Cluster:InnodbCluster&gt;</span><br><span class="line"> MySQL  localhost:3308 ssl  JS &gt; cluster.status()</span><br><span class="line">&#123;</span><br><span class="line">    &quot;clusterName&quot;: &quot;InnodbCluster&quot;, </span><br><span class="line">    &quot;defaultReplicaSet&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;default&quot;, </span><br><span class="line">        &quot;primary&quot;: &quot;db-56-19:3308&quot;, </span><br><span class="line">        &quot;ssl&quot;: &quot;REQUIRED&quot;, </span><br><span class="line">        &quot;status&quot;: &quot;OK&quot;, </span><br><span class="line">        &quot;statusText&quot;: &quot;Cluster is ONLINE and can tolerate up to ONE failure.&quot;, </span><br><span class="line">        &quot;topology&quot;: &#123;</span><br><span class="line">            &quot;db-56-17:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-17:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-18:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-18:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;SECONDARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/O&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &quot;db-56-19:3308&quot;: &#123;</span><br><span class="line">                &quot;address&quot;: &quot;db-56-19:3308&quot;, </span><br><span class="line">                &quot;memberRole&quot;: &quot;PRIMARY&quot;, </span><br><span class="line">                &quot;mode&quot;: &quot;R/W&quot;, </span><br><span class="line">                &quot;readReplicas&quot;: &#123;&#125;, </span><br><span class="line">                &quot;replicationLag&quot;: &quot;applier_queue_applied&quot;, </span><br><span class="line">                &quot;role&quot;: &quot;HA&quot;, </span><br><span class="line">                &quot;status&quot;: &quot;ONLINE&quot;, </span><br><span class="line">                &quot;version&quot;: &quot;8.2.0&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, </span><br><span class="line">        &quot;topologyMode&quot;: &quot;Single-Primary&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;groupInformationSourceMember&quot;: &quot;db-56-19:3308&quot;</span><br><span class="line">&#125;</span><br><span class="line"> MySQL  localhost:3308 ssl  JS &gt; </span><br></pre></td></tr></table></figure></p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="查询dba管理接口下所有的接口"><a href="#查询dba管理接口下所有的接口" class="headerlink" title="查询dba管理接口下所有的接口"></a>查询dba管理接口下所有的接口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost  JS &gt; dba.help()</span><br><span class="line">NAME</span><br><span class="line">      dba - InnoDB Cluster, ReplicaSet, and ClusterSet management functions.</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">      Entry point for AdminAPI functions, including InnoDB Clusters,</span><br><span class="line">      ReplicaSets, and ClusterSets.</span><br><span class="line"></span><br><span class="line">      InnoDB Clusters</span><br><span class="line"></span><br><span class="line">      The dba.configureInstance() function can be used to configure a MySQL</span><br><span class="line">      instance with the settings required to use it in an InnoDB Cluster.</span><br><span class="line"></span><br><span class="line">      InnoDB Clusters can be created with the dba.createCluster() function.</span><br><span class="line"></span><br><span class="line">      Once created, InnoDB Cluster management objects can be obtained with the</span><br><span class="line">      dba.getCluster() function.</span><br><span class="line"></span><br><span class="line">      InnoDB ReplicaSets</span><br><span class="line"></span><br><span class="line">      The dba.configureReplicaSetInstance() function can be used to configure a</span><br><span class="line">      MySQL instance with the settings required to use it in a ReplicaSet.</span><br><span class="line"></span><br><span class="line">      ReplicaSets can be created with the dba.createReplicaSet() function.</span><br><span class="line"></span><br><span class="line">      Once created, ReplicaSet management objects can be obtained with the</span><br><span class="line">      dba.getReplicaSet() function.</span><br><span class="line"></span><br><span class="line">      InnoDB ClusterSets</span><br><span class="line"></span><br><span class="line">      ClusterSets can be created with the &lt;Cluster&gt;.createClusterSet()</span><br><span class="line">      function.</span><br><span class="line"></span><br><span class="line">      Once created, ClusterSet management objected can be obtained with the</span><br><span class="line">      dba.getClusterSet() or &lt;Cluster&gt;.getClusterSet() functions.</span><br><span class="line"></span><br><span class="line">      Sandboxes</span><br><span class="line"></span><br><span class="line">      Utility functions are provided to create sandbox MySQL instances, which</span><br><span class="line">      can be used to create test Clusters and ReplicaSets.</span><br><span class="line"></span><br><span class="line">PROPERTIES</span><br><span class="line">      session</span><br><span class="line">            The session the dba object will use by default.</span><br><span class="line"></span><br><span class="line">      verbose</span><br><span class="line">            Controls debug message verbosity for sandbox related dba</span><br><span class="line">            operations.</span><br><span class="line"></span><br><span class="line">FUNCTIONS</span><br><span class="line">      checkInstanceConfiguration(instance[, options])</span><br><span class="line">            Validates an instance for MySQL InnoDB Cluster usage.</span><br><span class="line"></span><br><span class="line">      configureInstance([instance][, options])</span><br><span class="line">            Validates and configures an instance for MySQL InnoDB Cluster</span><br><span class="line">            usage.</span><br><span class="line"></span><br><span class="line">      configureLocalInstance([instance][, options])</span><br><span class="line">            Validates and configures a local instance for MySQL InnoDB Cluster</span><br><span class="line">            usage.</span><br><span class="line"></span><br><span class="line">            ATTENTION: This function is deprecated and will be removed in a</span><br><span class="line">                       future release of MySQL Shell, use</span><br><span class="line">                       dba.configureInstance() instead.</span><br><span class="line"></span><br><span class="line">      configureReplicaSetInstance([instance][, options])</span><br><span class="line">            Validates and configures an instance for use in an InnoDB</span><br><span class="line">            ReplicaSet.</span><br><span class="line"></span><br><span class="line">      createCluster(name[, options])</span><br><span class="line">            Creates a MySQL InnoDB cluster.</span><br><span class="line"></span><br><span class="line">      createReplicaSet(name[, options])</span><br><span class="line">            Creates a MySQL InnoDB ReplicaSet.</span><br><span class="line"></span><br><span class="line">      deleteSandboxInstance(port[, options])</span><br><span class="line">            Deletes an existing MySQL Server instance on localhost.</span><br><span class="line"></span><br><span class="line">      deploySandboxInstance(port[, options])</span><br><span class="line">            Creates a new MySQL Server instance on localhost.</span><br><span class="line"></span><br><span class="line">      dropMetadataSchema(options)</span><br><span class="line">            Drops the Metadata Schema.</span><br><span class="line"></span><br><span class="line">      getCluster([name][, options])</span><br><span class="line">            Returns an object representing a Cluster.</span><br><span class="line"></span><br><span class="line">      getClusterSet()</span><br><span class="line">            Returns an object representing a ClusterSet.</span><br><span class="line"></span><br><span class="line">      getReplicaSet()</span><br><span class="line">            Returns an object representing a ReplicaSet.</span><br><span class="line"></span><br><span class="line">      help([member])</span><br><span class="line">            Provides help about this object and it&#x27;s members</span><br><span class="line"></span><br><span class="line">      killSandboxInstance(port[, options])</span><br><span class="line">            Kills a running MySQL Server instance on localhost.</span><br><span class="line"></span><br><span class="line">      rebootClusterFromCompleteOutage([clusterName][, options])</span><br><span class="line">            Brings a cluster back ONLINE when all members are OFFLINE.</span><br><span class="line"></span><br><span class="line">      startSandboxInstance(port[, options])</span><br><span class="line">            Starts an existing MySQL Server instance on localhost.</span><br><span class="line"></span><br><span class="line">      stopSandboxInstance(port[, options])</span><br><span class="line">            Stops a running MySQL Server instance on localhost.</span><br><span class="line"></span><br><span class="line">      upgradeMetadata([options])</span><br><span class="line">            Upgrades (or restores) the metadata to the version supported by the</span><br><span class="line">            Shell.</span><br><span class="line"></span><br><span class="line">      SEE ALSO</span><br><span class="line"></span><br><span class="line">      - For general information about the AdminAPI use: \? AdminAPI</span><br><span class="line">      - For help on a specific function use: \? dba.&lt;functionName&gt;</span><br><span class="line"></span><br><span class="line">      e.g. \? dba.deploySandboxInstance</span><br><span class="line">  </span><br></pre></td></tr></table></figure><h2 id="查询某个接口的使用方法"><a href="#查询某个接口的使用方法" class="headerlink" title="查询某个接口的使用方法"></a>查询某个接口的使用方法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MySQL  localhost  JS &gt; dba.help(<span class="string">&#x27;getCluster&#x27;</span>)</span><br><span class="line">NAME</span><br><span class="line">      getCluster - Returns an object representing a Cluster.</span><br><span class="line"></span><br><span class="line">SYNTAX</span><br><span class="line">      dba.getCluster([name][, options])</span><br><span class="line"></span><br><span class="line">WHERE</span><br><span class="line">      name: Parameter to specify the name of the Cluster to be returned.</span><br><span class="line">      options: Dictionary with additional options.</span><br><span class="line"></span><br><span class="line">RETURNS</span><br><span class="line">      The Cluster object identified by the given name or the default Cluster.</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">      If name is not specified or is null, the default Cluster will be</span><br><span class="line">      returned.</span><br><span class="line"></span><br><span class="line">      If name is specified, and no Cluster with the indicated name is found, an</span><br><span class="line">      error will be raised.</span><br><span class="line"></span><br><span class="line">      The options dictionary may contain the following attributes:</span><br><span class="line"></span><br><span class="line">      - connectToPrimary: boolean value used to indicate <span class="keyword">if</span> Shell should</span><br><span class="line">        automatically connect to the primary member of the Cluster or not.</span><br><span class="line">        Deprecated and ignored, Shell will attempt to connect to the primary by</span><br><span class="line">        default and fallback to a secondary when not possible.</span><br></pre></td></tr></table></figure><h2 id="cluster-的相关接口"><a href="#cluster-的相关接口" class="headerlink" title="cluster 的相关接口"></a>cluster 的相关接口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"> MySQL  localhost  JS &gt; var Cluster = dba.getCluster(&#x27;InnodbCluster&#x27;)</span><br><span class="line"> MySQL  localhost  JS &gt; Cluster.help()</span><br><span class="line">NAME</span><br><span class="line">      Cluster - Represents an InnoDB Cluster.</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">      The cluster object is the entry point to manage and monitor a MySQL</span><br><span class="line">      InnoDB Cluster.</span><br><span class="line"></span><br><span class="line">      A cluster is a set of MySQLd Instances which holds the user&#x27;s data.</span><br><span class="line"></span><br><span class="line">      It provides high-availability and scalability for the user&#x27;s data.</span><br><span class="line"></span><br><span class="line">PROPERTIES</span><br><span class="line">      name</span><br><span class="line">            Retrieves the name of the cluster.</span><br><span class="line"></span><br><span class="line">FUNCTIONS</span><br><span class="line">      addInstance(instance[, options])</span><br><span class="line">            Adds an Instance to the cluster.</span><br><span class="line"></span><br><span class="line">      addReplicaInstance(instance[, options])</span><br><span class="line">            Adds a Read Replica Instance to the Cluster.</span><br><span class="line"></span><br><span class="line">      checkInstanceState(instance)</span><br><span class="line">            Verifies the instance gtid state in relation to the cluster.</span><br><span class="line"></span><br><span class="line">            ATTENTION: This function is deprecated and will be removed in a</span><br><span class="line">                       future release of MySQL Shell.</span><br><span class="line"></span><br><span class="line">      createClusterSet(domainName[, options])</span><br><span class="line">            Creates a MySQL InnoDB ClusterSet from an existing standalone</span><br><span class="line">            InnoDB Cluster.</span><br><span class="line"></span><br><span class="line">      describe()</span><br><span class="line">            Describe the structure of the cluster.</span><br><span class="line"></span><br><span class="line">      disconnect()</span><br><span class="line">            Disconnects all internal sessions used by the cluster object.</span><br><span class="line"></span><br><span class="line">      dissolve([options])</span><br><span class="line">            Dissolves the cluster.</span><br><span class="line"></span><br><span class="line">      fenceAllTraffic()</span><br><span class="line">            Fences a Cluster from All Traffic.</span><br><span class="line"></span><br><span class="line">      fenceWrites()</span><br><span class="line">            Fences a Cluster from Write Traffic.</span><br><span class="line"></span><br><span class="line">      forceQuorumUsingPartitionOf(instance[, password])</span><br><span class="line">            Restores the cluster from quorum loss.</span><br><span class="line"></span><br><span class="line">      getClusterSet()</span><br><span class="line">            Returns an object representing a ClusterSet.</span><br><span class="line"></span><br><span class="line">      getName()</span><br><span class="line">            Retrieves the name of the cluster.</span><br><span class="line"></span><br><span class="line">      help([member])</span><br><span class="line">            Provides help about this class and it&#x27;s members</span><br><span class="line"></span><br><span class="line">      listRouters([options])</span><br><span class="line">            Lists the Router instances.</span><br><span class="line"></span><br><span class="line">      options([options])</span><br><span class="line">            Lists the cluster configuration options.</span><br><span class="line"></span><br><span class="line">      rejoinInstance(instance[, options])</span><br><span class="line">            Rejoins an Instance to the cluster.</span><br><span class="line"></span><br><span class="line">      removeInstance(instance[, options])</span><br><span class="line">            Removes an Instance from the cluster.</span><br><span class="line"></span><br><span class="line">      removeRouterMetadata(routerDef)</span><br><span class="line">            Removes metadata for a router instance.</span><br><span class="line"></span><br><span class="line">      rescan([options])</span><br><span class="line">            Rescans the cluster.</span><br><span class="line"></span><br><span class="line">      resetRecoveryAccountsPassword(options)</span><br><span class="line">            Reset the password of the recovery accounts of the cluster.</span><br><span class="line"></span><br><span class="line">      routingOptions([router])</span><br><span class="line">            Lists the Cluster Routers configuration options.</span><br><span class="line"></span><br><span class="line">      setInstanceOption(instance, option, value)</span><br><span class="line">            Changes the value of an option in a Cluster member.</span><br><span class="line"></span><br><span class="line">      setOption(option, value)</span><br><span class="line">            Changes the value of an option for the whole Cluster.</span><br><span class="line"></span><br><span class="line">      setPrimaryInstance(instance[, options])</span><br><span class="line">            Elects a specific cluster member as the new primary.</span><br><span class="line"></span><br><span class="line">      setRoutingOption([router], option, value)</span><br><span class="line">            Changes the value of either a global Cluster Routing option or of a</span><br><span class="line">            single Router instance.</span><br><span class="line"></span><br><span class="line">      setupAdminAccount(user, options)</span><br><span class="line">            Create or upgrade an InnoDB Cluster admin account.</span><br><span class="line"></span><br><span class="line">      setupRouterAccount(user, options)</span><br><span class="line">            Create or upgrade a MySQL account to use with MySQL Router.</span><br><span class="line"></span><br><span class="line">      status([options])</span><br><span class="line">            Describe the status of the cluster.</span><br><span class="line"></span><br><span class="line">      switchToMultiPrimaryMode()</span><br><span class="line">            Switches the cluster to multi-primary mode.</span><br><span class="line"></span><br><span class="line">      switchToSinglePrimaryMode([instance])</span><br><span class="line">            Switches the cluster to single-primary mode.</span><br><span class="line"></span><br><span class="line">      unfenceWrites()</span><br><span class="line">            Unfences a Cluster.</span><br><span class="line"></span><br><span class="line">      For more help on a specific function use: cluster.help(&#x27;&lt;functionName&gt;&#x27;)</span><br><span class="line"></span><br><span class="line">      e.g. cluster.help(&#x27;addInstance&#x27;)</span><br></pre></td></tr></table></figure><h2 id="配置集群权重"><a href="#配置集群权重" class="headerlink" title="配置集群权重"></a>配置集群权重</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dba.createCluster(&#x27;cluster1&#x27;, &#123;memberWeight:35&#125;)</span><br><span class="line">var mycluster = dba.getCluster()</span><br><span class="line">mycluster.addInstance(&#x27;icadmin@ic2&#x27;, &#123;memberWeight:25&#125;)</span><br><span class="line">mycluster.addInstance(&#x27;icadmin@ic3&#x27;, &#123;memberWeight:50&#125;)</span><br></pre></td></tr></table></figure><h2 id="配置复制线程数"><a href="#配置复制线程数" class="headerlink" title="配置复制线程数"></a>配置复制线程数</h2><p>dba.configureInstance(instance, {applierWorkerThreads: 8, restart: true})</p><h2 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h2><p>cluster.removeInstance(“root@instanceWithOldUUID:3306”, {force: true})<br>cluster.rescan()</p><h2 id="仲裁成员不足情况下的重新恢复（假如3个节点down-了2个）"><a href="#仲裁成员不足情况下的重新恢复（假如3个节点down-了2个）" class="headerlink" title="仲裁成员不足情况下的重新恢复（假如3个节点down 了2个）"></a>仲裁成员不足情况下的重新恢复（假如3个节点down 了2个）</h2><p>cluster.forceQuorumUsingPartitionOf(“icadmin@ic-1:3306”)</p><h2 id="大停电后的恢复"><a href="#大停电后的恢复" class="headerlink" title="大停电后的恢复"></a>大停电后的恢复</h2><p>var cluster = dba.rebootClusterFromCompleteOutage()</p><h2 id="清除innodb-集群信息（解散集群）"><a href="#清除innodb-集群信息（解散集群）" class="headerlink" title="清除innodb 集群信息（解散集群）"></a>清除innodb 集群信息（解散集群）</h2><p>Cluster.dissolve()</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;准备&quot;&gt;&lt;a href=&quot;#准备&quot; class=&quot;headerlink&quot; title=&quot;准备&quot;&gt;&lt;/a&gt;准备&lt;/h1&gt;&lt;h2 id=&quot;服务器&quot;&gt;&lt;a href=&quot;#服务器&quot; class=&quot;headerlink&quot; title=&quot;服务器&quot;&gt;&lt;/a&gt;服务器&lt;/h2&gt;&lt;p</summary>
      
    
    
    
    <category term="mysql" scheme="https://sheenzxx.github.io/categories/mysql/"/>
    
    
    <category term="mysqlsh" scheme="https://sheenzxx.github.io/tags/mysqlsh/"/>
    
    <category term="mysqlroute" scheme="https://sheenzxx.github.io/tags/mysqlroute/"/>
    
    <category term="groupreplication" scheme="https://sheenzxx.github.io/tags/groupreplication/"/>
    
  </entry>
  
  <entry>
    <title>mysql8.2搭建单主模式组复制及相关知识</title>
    <link href="https://sheenzxx.github.io/2023/12/22/mysql8grm/"/>
    <id>https://sheenzxx.github.io/2023/12/22/mysql8grm/</id>
    <published>2023-12-22T03:31:56.000Z</published>
    <updated>2023-12-22T06:57:00.987Z</updated>
    
    <content type="html"><![CDATA[<h2 id="组复制配置的相关要求"><a href="#组复制配置的相关要求" class="headerlink" title="组复制配置的相关要求"></a>组复制配置的相关要求</h2><ol><li><p>存储引擎必须是 innodb,所以禁用非innodb 存储引擎<br>disabled_storage_engines=”MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY”</p></li><li><p>主键<br>组复制集群中所有的表必须具有主键，或者具有与主键等效的唯一键来确保能标识事务冲突时的行。组复制有自己的内部机制来检查。而不是使用 sql_require_primary_key 参数强制使用主键，<br>你可以在组复制运行时设置 sql_require_primary_key =on 或者在 CHANGE REPLICATION SOURCE TO 时指定 REQUIRE_TABLE_PRIMARY_KEY_CHECK=ON.<br>来限制建表时必须使用主键。但是你可能会发现，某些组复制内部机制允许的行为在 sql_require_primary_key =on 或者在 CHANGE REPLICATION SOURCE TO 时指定 REQUIRE_TABLE_PRIMARY_KEY_CHECK=ON<br>时是不允许的</p></li><li><p>网络性能<br>部署在稳定的同个局域网内。关闭防火墙等可能会影响节点间检测的服务</p></li><li><p>唯一的服务标准。 每个实例有自己独立的 server_id</p></li><li><p>必须开启bin-log</p></li><li><p>必须log_replica_updates=ON </p></li><li><p>必须binlog_format=ROW </p></li><li><p>必须 gtid_mode=ON 和 enforce_gtid_consistency=ON.</p></li><li><p>所有组成员的 default_table_encryption 必须设置相同</p></li><li><p>所有组成员的 lower_case_table_names 必须设置相同</p></li><li><p>设置 binlog_transaction_dependency_tracking = WRITESET 和 replica_preserve_commit_order = ON</p></li><li><p>设置并发复制，所有组成员默认都设置并发复制默认为4. 通过 replica_parallel_workers  调整数量。最大可以1024 个</p></li><li><p>mysql 8.2 及以后的版本都支持 xa 事务。可以通过 xa_detach_on_prepare = ON |OFF 来开启支持或关闭</p></li></ol><h2 id="组复制的限制"><a href="#组复制的限制" class="headerlink" title="组复制的限制"></a>组复制的限制</h2><ol><li><p>组复制在使用 —upgrade=MINIMAL 的选项升级后不能启动。这个选项不升级复制依赖的一些系统表</p></li><li><p>组复制针对并发事务的认证过程没有考虑间隙锁，因为在InnoDB之外无法获得有关间隙锁的信息</p></li><li><p>表锁和命名锁。认证过程不考虑表锁</p></li><li><p>binlog_checksum 在8.2 以前不支持校验。设置binlog_checksum = NONE 在8.2 开始 默认为binlog_checksum=CRC32</p></li><li><p>不支持SERIALIZABLE 的事务隔离级别。设置为transaction_isolation = READ-COMMITTED</p></li><li><p>使用多主模式时，不支持针对同一对象但在不同服务器上执行的并发数据定义语句和数据操作语句。在对象上执行数据定义语言（DDL）语句期间，<br>在同一对象上但在不同的服务器实例上执行并发数据操作语言（DML）有可能检测不到在不同实例上执行的冲突DDL</p></li><li><p>多主模式组（所有成员都配置为group_replication_single_primary_mode=OFF）不支持具有多级外键依赖关系的表，特别是定义了CASCADING外键约束的表。<br>这是因为导致多主模式组执行级联操作的外键约束可能会导致未检测到的冲突，并导致组成员之间的数据不一致。因此，我们建议在多主模式组中使用的服务<br>器实例上设置group_replication_enforce_update_everywhere_checks=ON，以避免未检测到的冲突。单主模式下则无此风险</p></li><li><p>多主模式组（所有成员都配置为group_replication_single_primary_mode=OFF）不支持具有多级外键依赖关系的表，特别是定义了CASCADING外键约束的表。<br>这是因为导致多主模式组执行级联操作的外键约束可能会导致未检测到的冲突，并导致组成员之间的数据不一致。因此，我们建议在多主模式组中使用的服务<br>器实例上设置group_replication_enforce_update_everywhere_checks=ON，以避免未检测到的冲突。</p></li><li><p>多主模式下，在某节点上执行 SELECT。。FOR UPDATE语句可能会导致死锁。这是因为锁不是在组的成员之间共享的，因此可能无法达到对此类语句的期望</p></li><li><p>全局复制筛选器不能用于为组复制配置的MySQL服务器实例，因为在某些服务器上筛选事务会使组无法就一致状态达成一致。通道特定的复制筛选器可以用<br>于不直接参与组复制的复制通道，例如组成员还充当组外源的副本的情况。它们不能用于group_replication_applier或group_replification_recovery通道。</p></li><li><p>MySQL中提供了对TLSv1.3协议的支持，前提是它是使用OpenSSL 1.1.1或更高版本编译的。组复制支持TLSv1.3，可用于组通信连接和分布式恢复连接。</p></li><li><p>组复制启动并管理分布式恢复的克隆操作。但已设置为支持克隆的组成员也可以参与用户手动启动的克隆操作。如果操作涉及正在运行组复制的组成员，<br>则可以手动启动克隆操作，前提是克隆操作不会删除和替换接收方的数据。因此，如果组复制正在运行，则启动克隆操作的语句必须包括DATA DIRECTORY子句</p></li><li><p>组复制最多支持9个成员</p></li><li><p>事务大小限制<br>如果单事务太大。以至于无法在5秒内无法在组成员中复制完毕，会导致认为成员失败，而遭踢出集群。可以通过以下方法避免</p><ol><li>设置group_replication_member_expel_timeout 参数以获取更长的延迟时间，默认再加5秒</li><li>限制事务数据的大小。比如使用 LOAD DATA 时将文件分割成更小的块</li><li>设置group_replication_transaction_size_limit 限制事务数据允许的最大规格。默认是150000000 bytes，超过此规格的事务将会别回滚。并且不会分发到其他组成员</li><li>设置group_replication_compression_threshold 来压缩大消息。默认1M。当大消息的最大规格限制 group_replication_transaction_size_limit 大于    group_replication_compression_threshold 时。都将会被压缩发送</li><li>设置复制消息的最大规格 group_replication_communication_max_message_size 。默认是10M。超过该大小将会被分段发送。当消息被压缩后仍然超过group_replication_communication_max_message_size 后就会被分段。所有组成员数据库版本必须大于8.0.16 才允许使用分段消息</li></ol></li></ol><h2 id="安装准备"><a href="#安装准备" class="headerlink" title="安装准备"></a>安装准备</h2><p>echo “192.168.56.17    db-56-17     db-56-17” &gt;&gt;/etc/hosts<br>echo “192.168.56.18    db-56-18     db-56-18” &gt;&gt;/etc/hosts<br>echo “192.168.56.19    db-56-19     db-56-19” &gt;&gt;/etc/hosts</p><h2 id="配置ssh"><a href="#配置ssh" class="headerlink" title="配置ssh"></a>配置ssh</h2><h1 id="先操作-db-56-17"><a href="#先操作-db-56-17" class="headerlink" title="先操作 db-56-17"></a>先操作 db-56-17</h1><h2 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h2><h3 id="必要参数配置"><a href="#必要参数配置" class="headerlink" title="必要参数配置"></a>必要参数配置</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">disabled_storage_engines<span class="operator">=</span>&quot;MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY&quot; #禁用非innodb引擎</span><br><span class="line">authentication_policy<span class="operator">=</span>mysql_native_password                          #设置密码策略</span><br></pre></td></tr></table></figure><h3 id="复制框架相关"><a href="#复制框架相关" class="headerlink" title="复制框架相关"></a>复制框架相关</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server<span class="operator">-</span>id <span class="operator">=</span> <span class="number">17</span>                                                       #每个实例不同</span><br><span class="line">log_replica_updates <span class="operator">=</span> <span class="literal">true</span>                                           #打开复制更新binlog</span><br><span class="line">gtid_mode<span class="operator">=</span><span class="keyword">ON</span>                                                         #打开GTID</span><br><span class="line">enforce_gtid_consistency<span class="operator">=</span><span class="keyword">ON</span>                                          #强制gtid 一致性</span><br></pre></td></tr></table></figure><h3 id="组复制相关参数"><a href="#组复制相关参数" class="headerlink" title="组复制相关参数"></a>组复制相关参数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">plugin_load_add <span class="operator">=</span> &quot;group_replication.so&quot;                             #加载组复制插件</span><br><span class="line">binlog_checksum <span class="operator">=</span> <span class="keyword">NONE</span>                                               #设置为<span class="keyword">NONE</span> ，<span class="number">8.2</span> 以后可以设置为</span><br><span class="line">group_replication_group_name<span class="operator">=</span>&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;  #复制组名。集群中所有的节点复制组名都一致。必须是个uuid 。可以通过<span class="keyword">select</span> uuid() 获取，也可以写&quot;aaaa-aa....&quot;</span><br><span class="line">group_replication_start_on_boot<span class="operator">=</span>off                                  #设置插件不要在服务器启动时自动启动。在配置组复制集群时非常重要。因为可以在启动插件前配置服务。</span><br><span class="line">                                                                     #当配置成员后。可以设置为<span class="keyword">on</span></span><br><span class="line">group_replication_local_address<span class="operator">=</span> &quot;db-56-17:33061&quot;                    #设置本机用于组复制内部成员沟通地址 。为主机名或ip加端口号。建议使用<span class="number">33061</span> ，该地址不能和客户端访问数据库一样，</span><br><span class="line">                                                                     #组成员之间的local_address 均不一样</span><br><span class="line">group_replication_group_seeds<span class="operator">=</span> &quot;db-56-17:33061,db-56-18:33061,db-56-19:33061&quot; #设置复制组成员的地址。用于新节点加入时，可以通过这些地址建立连接。里面的成员也称为种子成员。</span><br><span class="line">                                                                     #里面的地址为local_address 设置的地址。并不一定所有的成员都需要列在种子成员中。它是组成员的子集</span><br><span class="line"> #同时加入多个成员时。必须确保种子成员都已经加入组。不要将同时加入的成员作为种子成员。因为当连接到他们时，他们可能</span><br><span class="line"> #还没在组中。</span><br><span class="line">group_replication_bootstrap_group<span class="operator">=</span>off                                #指示插件是否引导组，即使是第一个成员也设置为关闭。我们在配置时手动启动它。引导结束后再关闭它。</span><br><span class="line">                                                                     #如果在多个成员上打开引导组。会造成脑裂。所以在第一个成员引导结束之后。所有其他成员都不要再打开它</span><br></pre></td></tr></table></figure><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>当使用mysqld_multi 多实例启动时，组复制的相关参数要写在[mysqldn]下。否则相关参数都不生效</p><h2 id="配置组复制"><a href="#配置组复制" class="headerlink" title="配置组复制"></a>配置组复制</h2><h3 id="初始化数据库实例"><a href="#初始化数据库实例" class="headerlink" title="初始化数据库实例"></a>初始化数据库实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data_sheen</span><br><span class="line">修改root 密码</span><br></pre></td></tr></table></figure><h3 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h3><p>mysqld_multi start 1</p><h3 id="查看组复制插件是否已启动。"><a href="#查看组复制插件是否已启动。" class="headerlink" title="查看组复制插件是否已启动。"></a>查看组复制插件是否已启动。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:(none)&gt;show plugins;</span><br><span class="line">....</span><br><span class="line">| mysql_native_password            | ACTIVE   | AUTHENTICATION     | NULL                 | GPL     |</span><br><span class="line">| group_replication                | ACTIVE   | GROUP REPLICATION  | group_replication.so | GPL     |</span><br><span class="line">+----------------------------------+----------+--------------------+----------------------+---------+</span><br></pre></td></tr></table></figure><h3 id="如果没有启动则安装组复制插件"><a href="#如果没有启动则安装组复制插件" class="headerlink" title="如果没有启动则安装组复制插件"></a>如果没有启动则安装组复制插件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSTALL PLUGIN group_replication SONAME <span class="string">&#x27;group_replication.so&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="创建复制账号"><a href="#创建复制账号" class="headerlink" title="创建复制账号"></a>创建复制账号</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">0</span>;    # 关闭操作写入binlog 这里设置不要将权限账号写入binlog,避免在不同实例加入时冲突</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;repl&#x27;</span>;  </span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;   #replica 的复制权限</span><br><span class="line"><span class="keyword">GRANT</span> CONNECTION_ADMIN <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;    #它确保在涉及的服务器之一处于脱机模式时不会终止组复制连接</span><br><span class="line"><span class="keyword">GRANT</span> BACKUP_ADMIN <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;        #如果组复制中支持克隆。这是克隆所需的权限</span><br><span class="line"><span class="keyword">GRANT</span> GROUP_REPLICATION_STREAM <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>; #此权限是用户帐户使用MySQL通信堆栈建立和维护组复制连接所必需的</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"><span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">1</span>;    #开启<span class="keyword">SQL</span> 写入binlog </span><br></pre></td></tr></table></figure><h3 id="设置组复制用于分布式恢复用户数据的凭证为-group-replication-recovery"><a href="#设置组复制用于分布式恢复用户数据的凭证为-group-replication-recovery" class="headerlink" title="设置组复制用于分布式恢复用户数据的凭证为 group_replication_recovery"></a>设置组复制用于分布式恢复用户数据的凭证为 group_replication_recovery</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE REPLICATION SOURCE <span class="keyword">TO</span> SOURCE_USER<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, SOURCE_PASSWORD<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span> <span class="keyword">FOR</span> CHANNEL <span class="string">&#x27;group_replication_recovery&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="第一个节点启用引导，启动组复制"><a href="#第一个节点启用引导，启动组复制" class="headerlink" title="第一个节点启用引导，启动组复制"></a>第一个节点启用引导，启动组复制</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> group_replication_bootstrap_group<span class="operator">=</span><span class="keyword">ON</span>;   #启动引导</span><br><span class="line"><span class="keyword">START</span> GROUP_REPLICATION <span class="keyword">USER</span><span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, PASSWORD<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>;  #启动组复制</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> group_replication_bootstrap_group<span class="operator">=</span>OFF;  #关闭引导</span><br></pre></td></tr></table></figure><h3 id="查看组成员"><a href="#查看组成员" class="headerlink" title="查看组成员"></a>查看组成员</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@localhost</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.replication_group_members;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+</span></span><br><span class="line"><span class="operator">|</span> CHANNEL_NAME              <span class="operator">|</span> MEMBER_ID                            <span class="operator">|</span> MEMBER_HOST <span class="operator">|</span> MEMBER_PORT <span class="operator">|</span> MEMBER_STATE <span class="operator">|</span> MEMBER_ROLE <span class="operator">|</span> MEMBER_VERSION <span class="operator">|</span> MEMBER_COMMUNICATION_STACK <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">0</span>ecaadea<span class="number">-9</span>fc7<span class="number">-11</span>ee<span class="number">-8099</span><span class="number">-080027128</span>c74 <span class="operator">|</span> db<span class="number">-56</span><span class="number">-17</span>    <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="number">8.2</span><span class="number">.0</span>          <span class="operator">|</span> XCom                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+</span></span><br></pre></td></tr></table></figure><h1 id="操作-db-56-18-使其加入组"><a href="#操作-db-56-18-使其加入组" class="headerlink" title="操作 db-56-18 ,使其加入组"></a>操作 db-56-18 ,使其加入组</h1><h2 id="参数配置。"><a href="#参数配置。" class="headerlink" title="参数配置。"></a>参数配置。</h2><h3 id="将-db-56-17-的配置文件复制到-db-56-18"><a href="#将-db-56-17-的配置文件复制到-db-56-18" class="headerlink" title="将 db-56-17 的配置文件复制到 db-56-18"></a>将 db-56-17 的配置文件复制到 db-56-18</h3><h3 id="在-db-56-18-上修改下面2个参数的值"><a href="#在-db-56-18-上修改下面2个参数的值" class="headerlink" title="在 db-56-18 上修改下面2个参数的值"></a>在 db-56-18 上修改下面2个参数的值</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server<span class="operator">-</span>id <span class="operator">=</span> <span class="number">18</span></span><br><span class="line">group_replication_local_address<span class="operator">=</span> &quot;db-56-18:33061&quot;</span><br></pre></td></tr></table></figure><h3 id="初始化数据库实例-1"><a href="#初始化数据库实例-1" class="headerlink" title="初始化数据库实例"></a>初始化数据库实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data_sheen</span><br><span class="line">修改root 密码</span><br></pre></td></tr></table></figure><h3 id="启动数据库-1"><a href="#启动数据库-1" class="headerlink" title="启动数据库"></a>启动数据库</h3><p>mysqld_multi start 1</p><h3 id="检查插件并设置复制账号"><a href="#检查插件并设置复制账号" class="headerlink" title="检查插件并设置复制账号"></a>检查插件并设置复制账号</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> plugins;</span><br><span class="line"><span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;repl&#x27;</span>;  </span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> CONNECTION_ADMIN <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> BACKUP_ADMIN <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> GROUP_REPLICATION_STREAM <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"><span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><h3 id="因为我们是新开的实例。在加入复制组时需要重置掉本地的gtid信息"><a href="#因为我们是新开的实例。在加入复制组时需要重置掉本地的gtid信息" class="headerlink" title="因为我们是新开的实例。在加入复制组时需要重置掉本地的gtid信息"></a>因为我们是新开的实例。在加入复制组时需要重置掉本地的gtid信息</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reset master</span><br></pre></td></tr></table></figure><h3 id="设置组复制用于分布式恢复用户数据的凭证为-group-replication-recovery-1"><a href="#设置组复制用于分布式恢复用户数据的凭证为-group-replication-recovery-1" class="headerlink" title="设置组复制用于分布式恢复用户数据的凭证为 group_replication_recovery"></a>设置组复制用于分布式恢复用户数据的凭证为 group_replication_recovery</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE REPLICATION SOURCE <span class="keyword">TO</span> SOURCE_USER<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, SOURCE_PASSWORD<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span> <span class="keyword">FOR</span> CHANNEL <span class="string">&#x27;group_replication_recovery&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="启动组复制-这里与节点1有所不同，仅启动组复制，不要开启组引导"><a href="#启动组复制-这里与节点1有所不同，仅启动组复制，不要开启组引导" class="headerlink" title="启动组复制(这里与节点1有所不同，仅启动组复制，不要开启组引导)"></a>启动组复制(这里与节点1有所不同，仅启动组复制，不要开启组引导)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> GROUP_REPLICATION <span class="keyword">USER</span><span class="operator">=</span><span class="string">&#x27;rpl_user&#x27;</span>, PASSWORD<span class="operator">=</span><span class="string">&#x27;password&#x27;</span>; ## 当成功启动组复制并加入复制组。将会将该节点设置为super_read_only<span class="operator">=</span><span class="keyword">ON</span> 不允许修改</span><br></pre></td></tr></table></figure><h3 id="查看组成员-1"><a href="#查看组成员-1" class="headerlink" title="查看组成员"></a>查看组成员</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root<span class="variable">@localhost</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.replication_group_members;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+</span></span><br><span class="line"><span class="operator">|</span> CHANNEL_NAME              <span class="operator">|</span> MEMBER_ID                            <span class="operator">|</span> MEMBER_HOST <span class="operator">|</span> MEMBER_PORT <span class="operator">|</span> MEMBER_STATE <span class="operator">|</span> MEMBER_ROLE <span class="operator">|</span> MEMBER_VERSION <span class="operator">|</span> MEMBER_COMMUNICATION_STACK <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">0</span>ecaadea<span class="number">-9</span>fc7<span class="number">-11</span>ee<span class="number">-8099</span><span class="number">-080027128</span>c74 <span class="operator">|</span> db<span class="number">-56</span><span class="number">-17</span>    <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="number">8.2</span><span class="number">.0</span>          <span class="operator">|</span> XCom                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">1</span>bb739ac<span class="number">-9</span>fc7<span class="number">-11</span>ee<span class="operator">-</span>bc56<span class="number">-080027e817</span>da <span class="operator">|</span> db<span class="number">-56</span><span class="number">-18</span>    <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> SECONDARY   <span class="operator">|</span> <span class="number">8.2</span><span class="number">.0</span>          <span class="operator">|</span> XCom                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+</span></span><br></pre></td></tr></table></figure><h1 id="操作-db-56-19-使其加入组"><a href="#操作-db-56-19-使其加入组" class="headerlink" title="操作 db-56-19 ,使其加入组"></a>操作 db-56-19 ,使其加入组</h1><h2 id="参数配置。-1"><a href="#参数配置。-1" class="headerlink" title="参数配置。"></a>参数配置。</h2><h3 id="将-db-56-17-的配置文件复制到-db-56-19"><a href="#将-db-56-17-的配置文件复制到-db-56-19" class="headerlink" title="将 db-56-17 的配置文件复制到 db-56-19"></a>将 db-56-17 的配置文件复制到 db-56-19</h3><h3 id="在-db-56-19-上修改下面2个参数的值"><a href="#在-db-56-19-上修改下面2个参数的值" class="headerlink" title="在 db-56-19 上修改下面2个参数的值"></a>在 db-56-19 上修改下面2个参数的值</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server<span class="operator">-</span>id <span class="operator">=</span> <span class="number">19</span></span><br><span class="line">group_replication_local_address<span class="operator">=</span> &quot;db-56-19:33061&quot;  </span><br></pre></td></tr></table></figure><h3 id="初始化数据库实例-2"><a href="#初始化数据库实例-2" class="headerlink" title="初始化数据库实例"></a>初始化数据库实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data_sheen</span><br><span class="line">修改root 密码</span><br></pre></td></tr></table></figure><h3 id="启动数据库-2"><a href="#启动数据库-2" class="headerlink" title="启动数据库"></a>启动数据库</h3><p>mysqld_multi start 1</p><h3 id="检查插件并设置复制账号-1"><a href="#检查插件并设置复制账号-1" class="headerlink" title="检查插件并设置复制账号"></a>检查插件并设置复制账号</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> plugins;</span><br><span class="line"><span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;repl&#x27;</span>;  </span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> CONNECTION_ADMIN <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> BACKUP_ADMIN <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> GROUP_REPLICATION_STREAM <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"><span class="keyword">SET</span> SQL_LOG_BIN<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure><h3 id="因为我们是新开的实例。在加入复制组时需要重置掉本地的gtid信息-1"><a href="#因为我们是新开的实例。在加入复制组时需要重置掉本地的gtid信息-1" class="headerlink" title="因为我们是新开的实例。在加入复制组时需要重置掉本地的gtid信息"></a>因为我们是新开的实例。在加入复制组时需要重置掉本地的gtid信息</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reset master     </span><br></pre></td></tr></table></figure><h3 id="设置组复制用于分布式恢复用户数据的凭证为-group-replication-recovery-2"><a href="#设置组复制用于分布式恢复用户数据的凭证为-group-replication-recovery-2" class="headerlink" title="设置组复制用于分布式恢复用户数据的凭证为 group_replication_recovery"></a>设置组复制用于分布式恢复用户数据的凭证为 group_replication_recovery</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE REPLICATION SOURCE <span class="keyword">TO</span> SOURCE_USER<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span>, SOURCE_PASSWORD<span class="operator">=</span><span class="string">&#x27;repl&#x27;</span> <span class="keyword">FOR</span> CHANNEL <span class="string">&#x27;group_replication_recovery&#x27;</span>;</span><br></pre></td></tr></table></figure><h3 id="启动组复制-这里与节点1有所不同，仅启动组复制，不要开启组引导-1"><a href="#启动组复制-这里与节点1有所不同，仅启动组复制，不要开启组引导-1" class="headerlink" title="启动组复制(这里与节点1有所不同，仅启动组复制，不要开启组引导)"></a>启动组复制(这里与节点1有所不同，仅启动组复制，不要开启组引导)</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> GROUP_REPLICATION <span class="keyword">USER</span><span class="operator">=</span><span class="string">&#x27;rpl_user&#x27;</span>, PASSWORD<span class="operator">=</span><span class="string">&#x27;password&#x27;</span>; </span><br><span class="line"></span><br><span class="line">root<span class="variable">@localhost</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.replication_group_members;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+</span></span><br><span class="line"><span class="operator">|</span> CHANNEL_NAME              <span class="operator">|</span> MEMBER_ID                            <span class="operator">|</span> MEMBER_HOST <span class="operator">|</span> MEMBER_PORT <span class="operator">|</span> MEMBER_STATE <span class="operator">|</span> MEMBER_ROLE <span class="operator">|</span> MEMBER_VERSION <span class="operator">|</span> MEMBER_COMMUNICATION_STACK <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">0</span>ecaadea<span class="number">-9</span>fc7<span class="number">-11</span>ee<span class="number">-8099</span><span class="number">-080027128</span>c74 <span class="operator">|</span> db<span class="number">-56</span><span class="number">-17</span>    <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> <span class="keyword">PRIMARY</span>     <span class="operator">|</span> <span class="number">8.2</span><span class="number">.0</span>          <span class="operator">|</span> XCom                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">159504</span>c3<span class="number">-9</span>fc7<span class="number">-11</span>ee<span class="number">-803</span>b<span class="number">-080027</span>fd716e <span class="operator">|</span> db<span class="number">-56</span><span class="number">-19</span>    <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> SECONDARY   <span class="operator">|</span> <span class="number">8.2</span><span class="number">.0</span>          <span class="operator">|</span> XCom                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> group_replication_applier <span class="operator">|</span> <span class="number">1</span>bb739ac<span class="number">-9</span>fc7<span class="number">-11</span>ee<span class="operator">-</span>bc56<span class="number">-080027e817</span>da <span class="operator">|</span> db<span class="number">-56</span><span class="number">-18</span>    <span class="operator">|</span>        <span class="number">3306</span> <span class="operator">|</span> ONLINE       <span class="operator">|</span> SECONDARY   <span class="operator">|</span> <span class="number">8.2</span><span class="number">.0</span>          <span class="operator">|</span> XCom                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+----------------------------+</span></span><br></pre></td></tr></table></figure><h2 id="数据测试"><a href="#数据测试" class="headerlink" title="数据测试"></a>数据测试</h2><p>在节点db-56-17 上建库。写入数据<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> database test</span><br><span class="line">use test</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t1 (c1 <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY, c2 TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;Luis&#x27;</span>);</span><br></pre></td></tr></table></figure><br>在节点db-56-18 ,db-56-19 查看数据是否同步<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> databases;</span><br><span class="line">root<span class="variable">@localhost</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span>use test;</span><br><span class="line">Database changed</span><br><span class="line">root<span class="variable">@localhost</span>:test<span class="operator">&gt;</span><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+</span></span><br><span class="line"><span class="operator">|</span> c1 <span class="operator">|</span> c2   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Luis <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+</span></span><br><span class="line"></span><br><span class="line">root<span class="variable">@localhost</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span><span class="keyword">show</span> binlog events;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------+----------------+-----------+-------------+-----------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> Pos  <span class="operator">|</span> Event_type     <span class="operator">|</span> Server_id <span class="operator">|</span> End_log_pos <span class="operator">|</span> Info                                                                                                                              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------+----------------+-----------+-------------+-----------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>    <span class="number">4</span> <span class="operator">|</span> Format_desc    <span class="operator">|</span>        <span class="number">19</span> <span class="operator">|</span>         <span class="number">126</span> <span class="operator">|</span> Server ver: <span class="number">8.2</span><span class="number">.0</span>, Binlog ver: <span class="number">4</span>                                                                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">126</span> <span class="operator">|</span> Previous_gtids <span class="operator">|</span>        <span class="number">19</span> <span class="operator">|</span>         <span class="number">153</span> <span class="operator">|</span>                                                                                                                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">153</span> <span class="operator">|</span> Gtid           <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>         <span class="number">235</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;0ecaadea-9fc7-11ee-8099-080027128c74:1&#x27;</span>                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">235</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>         <span class="number">442</span> <span class="operator">|</span> <span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> <span class="string">&#x27;mysql_native_password&#x27;</span> <span class="keyword">AS</span> <span class="string">&#x27;*2632CF75CFB8987B429348FA90905C86DF24D0A7&#x27;</span> <span class="comment">/* xid=23 */</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">442</span> <span class="operator">|</span> Gtid           <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>         <span class="number">524</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;8332185e-9f15-11ee-8831-080027128c74:1&#x27;</span>                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">524</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>         <span class="number">586</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                                                                                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">586</span> <span class="operator">|</span> View_change    <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>         <span class="number">725</span> <span class="operator">|</span> view_id<span class="operator">=</span><span class="number">17031392240567592</span>:<span class="number">1</span>                                                                                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">725</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>         <span class="number">793</span> <span class="operator">|</span> <span class="keyword">COMMIT</span>                                                                                                                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">793</span> <span class="operator">|</span> Gtid           <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>         <span class="number">875</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;8332185e-9f15-11ee-8831-080027128c74:2&#x27;</span>                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">875</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>         <span class="number">937</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                                                                                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>  <span class="number">937</span> <span class="operator">|</span> View_change    <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1116</span> <span class="operator">|</span> view_id<span class="operator">=</span><span class="number">17031392240567592</span>:<span class="number">2</span>                                                                                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1116</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1184</span> <span class="operator">|</span> <span class="keyword">COMMIT</span>                                                                                                                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1184</span> <span class="operator">|</span> Gtid           <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1266</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;8332185e-9f15-11ee-8831-080027128c74:3&#x27;</span>                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1266</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1328</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                                                                                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1328</span> <span class="operator">|</span> View_change    <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1507</span> <span class="operator">|</span> view_id<span class="operator">=</span><span class="number">17031392240567592</span>:<span class="number">4</span>                                                                                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1507</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1575</span> <span class="operator">|</span> <span class="keyword">COMMIT</span>                                                                                                                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1575</span> <span class="operator">|</span> Gtid           <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1657</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;8332185e-9f15-11ee-8831-080027128c74:4&#x27;</span>                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1657</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1719</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                                                                                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1719</span> <span class="operator">|</span> View_change    <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1898</span> <span class="operator">|</span> view_id<span class="operator">=</span><span class="number">17031392240567592</span>:<span class="number">5</span>                                                                                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1898</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">1966</span> <span class="operator">|</span> <span class="keyword">COMMIT</span>                                                                                                                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">1966</span> <span class="operator">|</span> Gtid           <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2046</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;8332185e-9f15-11ee-8831-080027128c74:5&#x27;</span>                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">2046</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2150</span> <span class="operator">|</span> <span class="keyword">create</span> database test <span class="comment">/* xid=34 */</span>                                                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">2150</span> <span class="operator">|</span> Gtid           <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2230</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;8332185e-9f15-11ee-8831-080027128c74:6&#x27;</span>                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">2230</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2369</span> <span class="operator">|</span> use `test`; <span class="keyword">create</span> <span class="keyword">table</span>  t1 (c1 <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY, c2 TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>) <span class="comment">/* xid=35 */</span>                                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">2369</span> <span class="operator">|</span> Gtid           <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2451</span> <span class="operator">|</span> <span class="keyword">SET</span> @<span class="variable">@SESSION</span>.GTID_NEXT<span class="operator">=</span> <span class="string">&#x27;8332185e-9f15-11ee-8831-080027128c74:7&#x27;</span>                                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">2451</span> <span class="operator">|</span> Query          <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2517</span> <span class="operator">|</span> <span class="keyword">BEGIN</span>                                                                                                                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">2517</span> <span class="operator">|</span> Rows_query     <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2570</span> <span class="operator">|</span> # <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t1 <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;Luis&#x27;</span>)                                                                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">2570</span> <span class="operator">|</span> Table_map      <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2619</span> <span class="operator">|</span> table_id: <span class="number">144</span> (test.t1)                                                                                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">2619</span> <span class="operator">|</span> Write_rows     <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2661</span> <span class="operator">|</span> table_id: <span class="number">144</span> flags: STMT_END_F                                                                                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span> <span class="number">2661</span> <span class="operator">|</span> Xid            <span class="operator">|</span>        <span class="number">17</span> <span class="operator">|</span>        <span class="number">2688</span> <span class="operator">|</span> <span class="keyword">COMMIT</span> <span class="comment">/* xid=37 */</span>                                                                                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+------+----------------+-----------+-------------+-----------------------------------------------------------------------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure></p><h2 id="出现错误及解决方案"><a href="#出现错误及解决方案" class="headerlink" title="出现错误及解决方案"></a>出现错误及解决方案</h2><h4 id="错误1-Plugin-group-replication-reported-‘The-group-replication-group-name-option-is-mandatory’"><a href="#错误1-Plugin-group-replication-reported-‘The-group-replication-group-name-option-is-mandatory’" class="headerlink" title="错误1 Plugin group_replication reported: ‘The group_replication_group_name option is mandatory’"></a>错误1 Plugin group_replication reported: ‘The group_replication_group_name option is mandatory’</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;group_replication_group_name&#x27;</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> group_replication_group_name <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-------+</span></span><br><span class="line"><span class="keyword">select</span> uuid(); <span class="comment">-- 获取uuid 并作为group_replication_group_name 的值</span></span><br><span class="line"><span class="keyword">set</span> persist group_replication_group_name<span class="operator">=</span><span class="string">&#x27;8332185e-9f15-11ee-8831-080027128c74&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="错误2-GCS-Invalid-hostname-or-IP-address-assigned-to-the-parameter-local-node-’"><a href="#错误2-GCS-Invalid-hostname-or-IP-address-assigned-to-the-parameter-local-node-’" class="headerlink" title="错误2 [GCS] Invalid hostname or IP address () assigned to the parameter local_node!’"></a>错误2 [GCS] Invalid hostname or IP address () assigned to the parameter local_node!’</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;group_replication_local_address&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                   <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> group_replication_local_address <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------------+-------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> persist group_replication_local_address<span class="operator">=</span>&quot;192.168.56.17:33061&quot;;</span><br><span class="line"></span><br><span class="line">root<span class="variable">@localhost</span>:(<span class="keyword">none</span>)<span class="operator">&gt;</span><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;group_replication_group_seeds&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                 <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> group_replication_group_seeds <span class="operator">|</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="keyword">set</span> persist group_replication_group_seeds<span class="operator">=</span><span class="string">&#x27;db-56-17:33061,db-56-18:33061,db-56-19:33061&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="以上3个值为空，主要是设置组复制参数但没有写在-mysqldn-下。使用了mysqld-multi-启动不生效"><a href="#以上3个值为空，主要是设置组复制参数但没有写在-mysqldn-下。使用了mysqld-multi-启动不生效" class="headerlink" title="以上3个值为空，主要是设置组复制参数但没有写在[mysqldn] 下。使用了mysqld_multi 启动不生效"></a>以上3个值为空，主要是设置组复制参数但没有写在[mysqldn] 下。使用了mysqld_multi 启动不生效</h4><h4 id="错误-3-ERROR-MY-011526-Repl-Plugin-group-replication-reported-‘This-member-has-more-executed-transactions-than-those-present-in-the-group-Local-transactions-1bb739ac-9fc7-11ee-bc56-080027e817da-1-gt-Group-transactions-0ecaadea-9fc7-11ee-8099-080027128c74-1-8332185e-9f15-11ee-8831-080027128c74-1’"><a href="#错误-3-ERROR-MY-011526-Repl-Plugin-group-replication-reported-‘This-member-has-more-executed-transactions-than-those-present-in-the-group-Local-transactions-1bb739ac-9fc7-11ee-bc56-080027e817da-1-gt-Group-transactions-0ecaadea-9fc7-11ee-8099-080027128c74-1-8332185e-9f15-11ee-8831-080027128c74-1’" class="headerlink" title="错误 3[ERROR] [MY-011526] [Repl] Plugin group_replication reported: ‘This member has more executed transactions than those present in the group. Local transactions: 1bb739ac-9fc7-11ee-bc56-080027e817da:1 &gt; Group transactions: 0ecaadea-9fc7-11ee-8099-080027128c74:1, 8332185e-9f15-11ee-8831-080027128c74:1’"></a>错误 3[ERROR] [MY-011526] [Repl] Plugin group_replication reported: ‘This member has more executed transactions than those present in the group. Local transactions: 1bb739ac-9fc7-11ee-bc56-080027e817da:1 &gt; Group transactions: 0ecaadea-9fc7-11ee-8099-080027128c74:1, 8332185e-9f15-11ee-8831-080027128c74:1’</h4><h4 id="2023-12-21T06-18-37-133900Z-0-ERROR-MY-011522-Repl-Plugin-group-replication-reported-‘The-member-contains-transactions-not-present-in-the-group-The-member-will-now-exit-the-group-’"><a href="#2023-12-21T06-18-37-133900Z-0-ERROR-MY-011522-Repl-Plugin-group-replication-reported-‘The-member-contains-transactions-not-present-in-the-group-The-member-will-now-exit-the-group-’" class="headerlink" title="2023-12-21T06:18:37.133900Z 0 [ERROR] [MY-011522] [Repl] Plugin group_replication reported: ‘The member contains transactions not present in the group. The member will now exit the group.’"></a>2023-12-21T06:18:37.133900Z 0 [ERROR] [MY-011522] [Repl] Plugin group_replication reported: ‘The member contains transactions not present in the group. The member will now exit the group.’</h4><h4 id="这是因为我们启动的是新实例。并不是通过复制。拥有自己的gtid-。将主库信息置空。再启动复制"><a href="#这是因为我们启动的是新实例。并不是通过复制。拥有自己的gtid-。将主库信息置空。再启动复制" class="headerlink" title="这是因为我们启动的是新实例。并不是通过复制。拥有自己的gtid 。将主库信息置空。再启动复制"></a>这是因为我们启动的是新实例。并不是通过复制。拥有自己的gtid 。将主库信息置空。再启动复制</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reset master</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;组复制配置的相关要求&quot;&gt;&lt;a href=&quot;#组复制配置的相关要求&quot; class=&quot;headerlink&quot; title=&quot;组复制配置的相关要求&quot;&gt;&lt;/a&gt;组复制配置的相关要求&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;存储引擎必须是 innodb,所以禁用非innodb 存储</summary>
      
    
    
    
    <category term="mysql" scheme="https://sheenzxx.github.io/categories/mysql/"/>
    
    
    <category term="group replication" scheme="https://sheenzxx.github.io/tags/group-replication/"/>
    
  </entry>
  
  <entry>
    <title>flink 配置</title>
    <link href="https://sheenzxx.github.io/2023/11/29/flink/"/>
    <id>https://sheenzxx.github.io/2023/11/29/flink/</id>
    <published>2023-11-29T01:32:28.000Z</published>
    <updated>2023-11-30T10:17:45.404Z</updated>
    
    <content type="html"><![CDATA[<h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件位于 conf/flink-conf.xml ,采用key: value 的形式进行配置</p><h3 id="主机名与端口"><a href="#主机名与端口" class="headerlink" title="主机名与端口"></a>主机名与端口</h3><p>只有在 standalone 应用或会话部署的情况下才需要使用<br>在flink with yarn 或 active Kubernetes integration 模式下。主机名和端口将自动检测<br>rest.address, rest.port 用于客户端连接flink 的地址和端口 。在 JobManager 运行的节点上，将地址设置为主机名<br>jobmanager.rpc.address (默认localhost), jobmanager.rpc.port(默认6123) 用于 TaskManager 连接 JobManager/ResourceManager。</p><h3 id="内存设置"><a href="#内存设置" class="headerlink" title="内存设置"></a>内存设置</h3><p>jobmanager.memory.process.size   JobManager (JobMaster / ResourceManager / Dispatcher) 进程所用总内存的大小<br>taskmanager.memory.process.size  TaskManager 进程所用总内存大小</p><p>例如可以设置为 2048m 或者 2g</p><h3 id="并行设置"><a href="#并行设置" class="headerlink" title="并行设置"></a>并行设置</h3><p>taskmanager.numberOfTaskSlots    每个 TaskManager 提供的slot 数量(默认为1),每一个 slot 可以，服务一个任务或者管道<br>                                 在 TaskManager 中提供多个 slot </p><p>parallelism.default              默认并行数量。当没再任何地方制定并行数量。取这个值。默认 1</p><h3 id="设置检查点-checkpointing"><a href="#设置检查点-checkpointing" class="headerlink" title="设置检查点(checkpointing)"></a>设置检查点(checkpointing)</h3><p>state.backend.type               状态后端存储的类型 （filesystem 或 rocksdb）<br>state.checkpoints.dir            写 checkpoint 的路径，一般都是写在分布式存储中，例如 hdfs://namenode:port/flink/checkpoints.<br>state.savepoints.dir             写 savepoints 的路径，与 state.checkpoints.dir 设置相似<br>execution.checkpointing.interval 设置触发 checkpoint 的时间间隔，开启checkpointing 时，该值必须大于0</p><h3 id="Web-UI-设置"><a href="#Web-UI-设置" class="headerlink" title="Web UI 设置"></a>Web UI 设置</h3><p>web.submit.enable                允许通过Web UI 界面上传和开始任务 默认 true<br>web.cancel.enable                允许通过Web UI 界面取消允许的任务 默认 true<br>web.upload.dir                   存储上传任务的路径 </p><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>io.tmp.dirs                      flink 存放本地数据的路径，默认为 java.io.tmpdir 指定的路径，如果配置的是一个路径列表。flink 将<br>                                 在路径之间轮换存放文件<br>                                 持久化/恢复不依赖此数据,但是如果删除这些数据，通常会导致严重的恢复操作。因此建议该目录不能存在定期清理行为</p><h2 id="常用设置选项"><a href="#常用设置选项" class="headerlink" title="常用设置选项"></a>常用设置选项</h2><h3 id="为flink-不同的组件设置主机名和端口"><a href="#为flink-不同的组件设置主机名和端口" class="headerlink" title="为flink 不同的组件设置主机名和端口"></a>为flink 不同的组件设置主机名和端口</h3><p>jobmanager.rpc.address          用于设置 与 jobmanager 通讯的地址<br>jobmanager.rpc.port             用于设置 与 jobmanager 通讯的端口<br>rest.address                    用于客户端连接服务的地址,仅当 high-availability 为空时有效<br>rest.bind-address               服务绑定在服务器的地址,一般设置 0.0.0.0<br>rest.bind-port                  指定服务绑定的端口,支持端口列表<br>rest.port                       客户端连接服务的端口<br>taskmanager.host                taskmanger 的地址,不同taskmanger 地址不能相同</p><h3 id="容错设置"><a href="#容错设置" class="headerlink" title="容错设置"></a>容错设置</h3><p>restart-strategy.type           指定任务失败时重启策略 none, off, disable 表示没有重启策略，如果开启checkpoint 默认为 fixed-delay 策略</p><h4 id="fixed-delay-策略"><a href="#fixed-delay-策略" class="headerlink" title="fixed-delay 策略"></a>fixed-delay 策略</h4><p>restart-strategy.fixed-delay.attempts  任务声明失败前重启任务尝试的次数<br>restart-strategy.fixed-delay.delay     每次尝试重启的间隔</p><h2 id="配置-TaskManager-内存"><a href="#配置-TaskManager-内存" class="headerlink" title="配置 TaskManager 内存"></a>配置 TaskManager 内存</h2><h3 id="配置总内存"><a href="#配置总内存" class="headerlink" title="配置总内存"></a>配置总内存</h3><p>Flink JVM 进程的<em>进程总内存（Total Process Memory）</em>包含了由 Flink 应用使用的内存（Flink 总内存）以及由运行 Flink 的 JVM 使用的内存。 其中，<em>Flink 总内存（Total Flink Memory）</em>包括 JVM 堆内存（Heap Memory）、<em>托管内存（Managed Memory）</em>以及其他直接内存（Direct Memory）或本地内存（Native Memory</p><p>taskmanager.memory.process.size  用于配置Flink JVM 总内存的参数</p><h3 id="Flink-TaskManager-内存模型的所有组成部分，以及影响其大小的相关配置参数"><a href="#Flink-TaskManager-内存模型的所有组成部分，以及影响其大小的相关配置参数" class="headerlink" title="Flink TaskManager 内存模型的所有组成部分，以及影响其大小的相关配置参数"></a>Flink TaskManager 内存模型的所有组成部分，以及影响其大小的相关配置参数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">|            组成部分                        |      配置参数                               |              描述                            |</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------      </span><br><span class="line">| 框架堆内存(Framework Heap Memory)          | taskmanager.memory.framework.heap.size      |   用于 Flink 框架的 JVM 堆内存(进阶配置)      |</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">|任务堆内存(Task Heap Memory)                | taskmanager.memory.task.heap.size           |   用于 Flink 应用的算子及用户代码的 JVM 堆内存.|</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">|托管内存(Managed memory)                    | taskmanager.memory.managed.size             |   由 Flink 管理的用于排序、哈希表、缓存中间结果及|</span><br><span class="line">|                                           | taskmanager.memory.managed.fraction         |   RocksDB State Backend 的本地内存.            |</span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------------      </span><br><span class="line">|框架堆外内存(Framework Off-heap Memory)     | taskmanager.memory.framework.off-heap.size  |   用于 Flink 框架的堆外内存（直接内存或本地内存）|</span><br><span class="line">|                                           |                                             |   (进阶配置)                                  | </span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">|任务堆外内存(Task Off-heap Memory)          | taskmanager.memory.task.off-heap.size       |   用于 Flink 应用的算子及用户代码的堆外内存      |</span><br><span class="line">|                                           |                                             |   （直接内存或本地内存）。                      |</span><br><span class="line">------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">|网络内存(Network Memory)                    | taskmanager.memory.network.min              |用于任务之间数据传输的直接内存（例如网络传输缓冲） |</span><br><span class="line">|                                           | taskmanager.memory.network.max              |该内存部分为基于 Flink 总内存的受限的等比内存部分 |</span><br><span class="line">|                                           | taskmanager.memory.network.fraction         |这块内存被用于分配网络缓冲                       |</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">|JVM Metaspace                              | taskmanager.memory.jvm-metaspace.size       |  Flink JVM 进程的 Metaspace。                 |</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">|JVM 开销                                   | taskmanager.memory.jvm-overhead.min          | 用于其他 JVM 开销的本地内存，                  |</span><br><span class="line">|                                           | taskmanager.memory.jvm-overhead.max          | 例如栈空间、垃圾回收空间等。                   |</span><br><span class="line">|                                           | taskmanager.memory.jvm-overhead.fraction     | 该内存部分为基于进程总内存的受限的等比内存部分。 |</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>通常情况下,不建议对框架堆内存，和框架外堆内存进行调整</p><p>如果 Flink 作为一个单独的 Java 程序运行在你的电脑本地而非创建一个集群，只有以下参数会生效<br>taskmanager.memory.task.heap.size      默认无穷大<br>taskmanager.memory.task.off-heap.size  默认无穷大<br>taskmanager.memory.managed.size        默认128M<br>taskmanager.memory.network.min         默认64M<br>taskmanager.memory.network.max</p><h3 id=""><a href="#" class="headerlink" title=" "></a> </h3>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;基本配置&quot;&gt;&lt;a href=&quot;#基本配置&quot; class=&quot;headerlink&quot; title=&quot;基本配置&quot;&gt;&lt;/a&gt;基本配置&lt;/h2&gt;&lt;h3 id=&quot;配置文件&quot;&gt;&lt;a href=&quot;#配置文件&quot; class=&quot;headerlink&quot; title=&quot;配置文件&quot;&gt;&lt;/a</summary>
      
    
    
    
    <category term="hadoop" scheme="https://sheenzxx.github.io/categories/hadoop/"/>
    
    
    <category term="flink" scheme="https://sheenzxx.github.io/tags/flink/"/>
    
  </entry>
  
  <entry>
    <title>python 使用代理访问</title>
    <link href="https://sheenzxx.github.io/2023/11/24/requestproxy/"/>
    <id>https://sheenzxx.github.io/2023/11/24/requestproxy/</id>
    <published>2023-11-24T04:16:47.000Z</published>
    <updated>2023-11-24T04:29:56.679Z</updated>
    
    <content type="html"><![CDATA[<p>公司的服务器上是不能通外网的。有个任务需要调用外部钉钉接口。于是只能通过代理来解决。<br>可通外网的代理 ip 为 10.xx.xx.40:8080  ,接口请求我们用python requests 库<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">ddurl=<span class="string">&quot;https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line">headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>&#125;</span><br><span class="line">proxies = &#123;</span><br><span class="line"><span class="string">&quot;http&quot;</span>:<span class="string">&quot;http://10.82.44.10:8080&quot;</span>,</span><br><span class="line"><span class="string">&quot;https&quot;</span>:<span class="string">&quot;https://10.82.44.10:8080&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dingdingdata = &#123;<span class="string">&quot;msgtype&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="string">&quot;text&quot;</span>: &#123;<span class="string">&quot;title&quot;</span>:<span class="string">&quot;monitor dd&quot;</span>,</span><br><span class="line">                         <span class="string">&quot;content&quot;</span>:<span class="string">&quot;&quot;&quot;monitor_content&quot;&quot;&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br><span class="line">resp = requests.post(url = ddurl, headers = headers, proxies=proxies,data=json.dumps(dingdingdata))</span><br><span class="line"><span class="built_in">print</span>(resp.json())</span><br></pre></td></tr></table></figure><br>执行结果却是请求超时失败<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Caused by NewConnectionError(&#x27;&lt;urllib3.connection.HTTPSConnection object at 0x7fe3406d6f50&gt;: Failed to establish a new connection: [Errno 101] Network is unreachable&#x27;</span><br></pre></td></tr></table></figure><br>莫非是代理有问题?<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -x 10.xx.xx.40:8080 <span class="string">&#x27;www.baidu.com&#x27;</span></span><br></pre></td></tr></table></figure><br>curl 放回结果正常。能访问外网</p><p>经过一番度娘。终于了解到是urllib3 的问题。最新的urllib3有更严格ssl的校验<br>只能对requests ,urllib3 库进行降级处理<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo pip uninstall requests urllib3 </span><br><span class="line"></span><br><span class="line">sudo pip --proxy=10.xxx.xxx.40:8080 install requests==2.27  urllib3==1.25.8</span><br></pre></td></tr></table></figure><br>重新安装包好。代码正常！！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;公司的服务器上是不能通外网的。有个任务需要调用外部钉钉接口。于是只能通过代理来解决。&lt;br&gt;可通外网的代理 ip 为 10.xx.xx.40:8080  ,接口请求我们用python requests 库&lt;br&gt;&lt;figure class=&quot;highlight python</summary>
      
    
    
    
    <category term="python" scheme="https://sheenzxx.github.io/categories/python/"/>
    
    
    <category term="requests" scheme="https://sheenzxx.github.io/tags/requests/"/>
    
    <category term="proxy" scheme="https://sheenzxx.github.io/tags/proxy/"/>
    
  </entry>
  
  <entry>
    <title>Spark 性能调优配置</title>
    <link href="https://sheenzxx.github.io/2023/11/22/sparktunning/"/>
    <id>https://sheenzxx.github.io/2023/11/22/sparktunning/</id>
    <published>2023-11-22T05:57:17.000Z</published>
    <updated>2023-11-24T07:44:04.243Z</updated>
    
    <content type="html"><![CDATA[<h2 id="硬件资源类"><a href="#硬件资源类" class="headerlink" title="硬件资源类"></a>硬件资源类</h2><h4 id="1-与-CPU-相关配置"><a href="#1-与-CPU-相关配置" class="headerlink" title="1. 与 CPU 相关配置"></a>1. 与 CPU 相关配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spark.cores.max               在standalone模式下一个应用程序能使用最多的cpu数,如果没有设置，将用 spark.deploy.defaultCores 的值替代。</span><br><span class="line">spark.executor.cores          单个executor内CPU核数。在standalone模式下 默认使用节点上所有CPU.YARN模式下默认为1</span><br><span class="line">spark.task.cpus               单个任务消耗的CPU核数</span><br><span class="line">spark.default.parallelism     未指定分区数时的默认并行度</span><br><span class="line">spark.sql.shuffle.partitions  数据关联、聚合操作中 reducer 端的分区数（并行度）   </span><br></pre></td></tr></table></figure><p>RDD (Resiliennt Distributed Datasets) 抽象弹性分布式数据集<br>并行度（Parallelism）与并行计算任务（Paralleled Tasks）的区别？</p><p>并行度指的是分布式数据集被划分为多少份，从而用于分布式计算。并行度的出发点是数据，它明确了数据划分的粒度。并行度越高，数据的粒度越细，数据分片越多，数据越分散。由此可见，像分区数量、分片数量、Partitions 这些概念都是并行度的同义词。</p><p>并行计算任务指的是在任一时刻整个集群能够同时计算的任务数量。换句话说，它的出发点是计算任务、是 CPU，由与 CPU 有关的三个参数共同决定。</p><p>Executor中并行计算任务数的上限是 #Executor-tasks=spark.executor.cores ÷spark.task.cpus ，<br>整个集群并行计算任务数是 #Executors= #Executor-tasks <em> 集群内 Executors 的数量<br>最终的数值是：#Executor-tasks </em> #Executors。<br>并行度决定了数据粒度，数据粒度决定了分区大小，分区大小则决定着每个计算任务的内存消耗</p><h4 id="2-与内存相关配置项"><a href="#2-与内存相关配置项" class="headerlink" title="2. 与内存相关配置项"></a>2. 与内存相关配置项</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spark.executor.memory          单个Executor堆内内存总大小</span><br><span class="line">spark.memory.offHeap.size      单个Executor堆外内存总大小</span><br><span class="line">spark.memory.fraction          用于缓存RDD和执行计算的内存比例</span><br><span class="line">spark.memory.storageFraction   </span><br><span class="line">spark.rdd.compress             RDD缓存是否压缩，默认不压缩</span><br></pre></td></tr></table></figure><h4 id="3-磁盘相关配置项"><a href="#3-磁盘相关配置项" class="headerlink" title="3. 磁盘相关配置项"></a>3. 磁盘相关配置项</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark.local.dir    用于缓存RDD和shuffle中间文件磁盘目录</span><br></pre></td></tr></table></figure><h2 id="Shuffle类配置项"><a href="#Shuffle类配置项" class="headerlink" title="Shuffle类配置项"></a>Shuffle类配置项</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spark.shuffle.file.buffer=32k           Map输出端写入缓冲区大小</span><br><span class="line">spark.reducer.maxSizeInFlight=48m       Reduce输入端的读取缓冲区大小</span><br><span class="line">spark.shuffle.io.maxRetries=3</span><br><span class="line">spark.shuffle.io.retryWait=5s</span><br><span class="line">spark.shuffle.memoryFraction=0.2</span><br><span class="line">spark.shuffle.manager=sort</span><br><span class="line">spark.shuffle.sort.bypassMergeThreshold    Map阶段不进行排序的分区阈值</span><br><span class="line">spark.shuffle.consolidateFiles=false</span><br></pre></td></tr></table></figure><h2 id="Spark-SQL类配置项"><a href="#Spark-SQL类配置项" class="headerlink" title="Spark SQL类配置项"></a>Spark SQL类配置项</h2><p>AQE（Adaptive query execution，自适应查询引擎）三大特性：</p><p>自动分区合并<br>自动数据倾斜处理<br>Join策略调整</p><h4 id="与自动分区合并有关配置项"><a href="#与自动分区合并有关配置项" class="headerlink" title="与自动分区合并有关配置项"></a>与自动分区合并有关配置项</h4><p>（1）分区合并的场景：在 Shuffle 过程中，因为数据分布不均衡，导致 Reduce 阶段存在大量的小分区，这些小分区的数据量非常小，调度成本很高。<br>（2）AQE如何判断分区是否需要合并？AQE 事先并不判断哪些分区足够小，而是按照分区编号进行扫描，当扫描量超过“目标尺寸”时，就合并一次。<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spark.sql.adaptive.enabled                                是否启动AQE，默认禁用</span><br><span class="line">spark.sql.adaptive.advisoryPartitionSizeInBytes            开发者指定分区合并后的推荐尺寸</span><br><span class="line">spark.sql.adaptive.coalescePartitions.minPartitionNum=200分区合并后数据集的分区数不能低于该值</span><br></pre></td></tr></table></figure><br>假设Shuffle 过后数据大小为 20GB，minPartitionNum 设置为 200，每个分区的尺寸就是 20GB / 200 = 100MB。再假设，advisoryPartitionSizeInBytes 设置为 200MB，最终的目标分区尺寸就是取（100MB，200MB）之间的最小值，也就是 100MB</p><h4 id="与自动数据倾斜有关配置项"><a href="#与自动数据倾斜有关配置项" class="headerlink" title="与自动数据倾斜有关配置项"></a>与自动数据倾斜有关配置项</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spark.sql.adaptive.skewJoin.enabled                         是否开启AQE中自动处理数据倾斜的功能</span><br><span class="line">spark.sql.adaptive.skewJoin.skewedPartitionFactor         判定数据分区是否倾斜的比例数</span><br><span class="line">spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes 判定数据分区是否倾斜的最低阈值</span><br><span class="line">spark.sql.adaptive.advisoryPartitionSizeInBytes             以字节为单位，拆分倾斜分区的数据粒度</span><br></pre></td></tr></table></figure><p>假设数据表A有3个分区，分区大小分别是80MB、100MB和 512MB。这些分区按大小个排序后的中位数是100MB<br>skewedPartitionFactor 的默认值是5倍，所以大于100MB * 5 = 500MB 的分区才有可能被判定为倾斜分区<br>skewedPartitionThresholdInBytes的默认值是256MB，满足中位数条件的分区，必须要大于 256MB，Saprk才会把这个分区最终判定为倾斜分区<br>advisoryPartitionSizeInBytes的默认值是256MB，512MB的倾斜分区会以 256MB 为粒度拆分成多份，因此，这个大分区会被拆成 2 个小分区（ 512MB / 256MB =2）<br>拆分之后，原来的数据表就由 3 个分区变成了 4 个分区，每个分区的尺寸都不大于 256MB。</p><h4 id="与Join策略调整有关配置项"><a href="#与Join策略调整有关配置项" class="headerlink" title="与Join策略调整有关配置项"></a>与Join策略调整有关配置项</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spark.sql.autoBroadcastJoinThreshold=10M                    两表join,一张表的尺寸小于 10MB，二者的关联操作就可以降级为 Broadcast Join(2G推荐)</span><br><span class="line">spark.sql.adaptive.nonEmptyPartitionRatioForBroadcastJoin=0.2非空的数据分区占比要小于 0.2，才能成功触发 Broadcast Join 降级</span><br></pre></td></tr></table></figure><p>假设，大表过滤之前有 100 个分区，Filter 操作之后，有 85 个分区内的数据因为不满足过滤条件，在过滤之后都变成了没有任何数据的空分区，另外的 15 个分区还保留着满足过滤条件的数据。</p><p>这张大表过滤之后的非空分区占比是 15 / 100 = 15%，因为 15% 小于 0.2，所以这个例子中的大表会成功触发 Broadcast Join 降级。相反，如果大表过滤之后，非空分区占比大于 0.2，那么剩余数据量再小，AQE 也不会把 Shuffle Joins 降级为 Broadcast Join。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;硬件资源类&quot;&gt;&lt;a href=&quot;#硬件资源类&quot; class=&quot;headerlink&quot; title=&quot;硬件资源类&quot;&gt;&lt;/a&gt;硬件资源类&lt;/h2&gt;&lt;h4 id=&quot;1-与-CPU-相关配置&quot;&gt;&lt;a href=&quot;#1-与-CPU-相关配置&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="hadoop" scheme="https://sheenzxx.github.io/categories/hadoop/"/>
    
    
    <category term="spark" scheme="https://sheenzxx.github.io/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>clickhouse重建副本操作</title>
    <link href="https://sheenzxx.github.io/2023/11/06/clickhouseRepairReplica/"/>
    <id>https://sheenzxx.github.io/2023/11/06/clickhouseRepairReplica/</id>
    <published>2023-11-06T06:18:58.000Z</published>
    <updated>2023-11-06T06:29:30.625Z</updated>
    
    <content type="html"><![CDATA[<p>clickhouse 因各种原因导致的副本节点数据丢失。无法启动的修复步骤<br>1.清空异常副本节点的 metadata 和 data 目录。<br>2.从另一个正常副本将 metadata 目录拷贝过来（这一步之后可以启动数据库，但是只有表结构没有数据）。<br>3.执行 sudo -u clickhouse touch /data/clickhouse/flags/force_restore_data<br>4.启动数据库。</p><p>zookeeper 数据丢失，从而使 clickhouse 数据库无法启动的解决办法<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cannot create table from metadata file /var/lib/clickhouse/metadata/xx/xxx.sql, error: Coordination::Exception: Can’t get data for node /clickhouse/tables/xx/cluster_xxx-01/xxxx/metadata: node doesn’t exist (No node), stack trace:</span><br></pre></td></tr></table></figure><br>1.将/var/lib/clickhouse/metadata/ 下的SQL与/var/lib/clickhouse/data/ 下的数据备份之后删除<br>2.启动数据库<br>3.创建与原来表数据结构的MergeTree表<br>4.将之前分布式表的数据文件夹复制到新表的数据目录中。<br>5.重启数据库<br>6.重新创建原结构本地表<br>7.重新创建原结构分布式表<br>8.insert into [分布式表] select * from [MergeTree表]</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;clickhouse 因各种原因导致的副本节点数据丢失。无法启动的修复步骤&lt;br&gt;1.清空异常副本节点的 metadata 和 data 目录。&lt;br&gt;2.从另一个正常副本将 metadata 目录拷贝过来（这一步之后可以启动数据库，但是只有表结构没有数据）。&lt;br&gt;3.执</summary>
      
    
    
    
    <category term="clickhouse" scheme="https://sheenzxx.github.io/categories/clickhouse/"/>
    
    
    <category term="replica" scheme="https://sheenzxx.github.io/tags/replica/"/>
    
  </entry>
  
  <entry>
    <title>mysql 复制相关 gtid 模式</title>
    <link href="https://sheenzxx.github.io/2023/09/28/mysqlgtid/"/>
    <id>https://sheenzxx.github.io/2023/09/28/mysqlgtid/</id>
    <published>2023-09-28T02:55:51.000Z</published>
    <updated>2023-09-28T04:12:43.584Z</updated>
    
    <content type="html"><![CDATA[<p>我们开启 mysql gtid 复制时。需要设置2个变量<br>gtid_mode = on<br>enforce_gtid_consistency  = on<br>在mysql 5.7 中。这2个参数可以被动态修改</p><p>单开启gtid_mode = on 时。 复制不接受匿名事务。因为匿名事务没有gtid标识。</p><p>gtid_mode 有4种值:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OFF: 关闭gtid模式。只有匿名事务会被复制</span><br><span class="line">OFF_PERMISSIVE：新产生的事务为匿名事务，允许复制中的事务为匿名事务或gtid事务。</span><br><span class="line">ON_PERMISSIVE: 新产生的事务为GTID事务，允许复制中的事务为匿名事务或gtid事务。</span><br><span class="line">ON: 开启GTID模式。只产生GTID 事务。只允许GTID事务被复制</span><br></pre></td></tr></table></figure><br>4种模式只能顺序更改。比如 当前的 gtid_mode 设置为 OFF_PERMISSIVE，那么它只能设置为 OFF 或者 ON_PERMISSIVE 但不能设置为 ON 这是为了确保服务器正确处理从匿名事务到 GTID 事务切换的过程<br>当gtid_mode 在 on 或 off 之间切换时，gtid的状态(即gtid_execute 的值)是持久的，这确保了服务器已应用的gtid 集始终保留，无论gtid_mode 的值如何变</p><p>enforce_gtid_consistency 有3种值：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OFF: 不检查事务是否违反 gtid 一致性</span><br><span class="line">ON: 不允许任何事务违反 gtid 一致性（检查到非GTID 事务报错退出）</span><br><span class="line">WARN：允许事务违反 gtid 一致性，但是会发出警告</span><br></pre></td></tr></table></figure><br>当遇到 Cannot replicate anonymous transaction when AUTO_POSITION = 1, 的解决办法</p><ol><li>跳过该事务<br>主:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global gtid_mode=ON_PERMISSIVE;</span><br></pre></td></tr></table></figure>从:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set global gtid_mode = ON_PERMISSIVE;</span><br><span class="line">set global enforce_gtid_consistency=warn;</span><br><span class="line">stop slave;</span><br><span class="line">change master to master_auto_position=0;</span><br><span class="line">SET GLOBAL SQL_SLAVE_SKIP_COUNTER = 1 ;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>恢复:<br>从<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global enforce_gtid_consistency=on;</span><br><span class="line">set global gtid_mode=on;</span><br></pre></td></tr></table></figure>主<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global gtid_mode=on;</span><br></pre></td></tr></table></figure>从<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">change master to master_auto_position=1;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure></li><li>执行该事务<br>主：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global gtid_mode=ON_PERMISSIVE;</span><br></pre></td></tr></table></figure>从：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set global gtid_mode = ON_PERMISSIVE;</span><br><span class="line">set global enforce_gtid_consistency=warn;</span><br><span class="line">stop slave;</span><br><span class="line">change master to master_auto_position=0;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure>恢复：<br>从：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global enforce_gtid_consistency=on;</span><br><span class="line">set global gtid_mode=on;</span><br></pre></td></tr></table></figure>主：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global gtid_mode=on;</span><br></pre></td></tr></table></figure>从：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">change master to master_auto_position=1;</span><br><span class="line">start slave;</span><br></pre></td></tr></table></figure></li></ol><p>当 gtid_mode = on 时,必须enforce_gtid_consistency =on 从库也要求同样配置</p><p>当 enforce_gtid_consistency 需要降级。 首先 gtid_mode 先降级</p><p>当 master_auto_position=1 要求 gtid_mode = on，enforce_gtid_consistency =on</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;我们开启 mysql gtid 复制时。需要设置2个变量&lt;br&gt;gtid_mode = on&lt;br&gt;enforce_gtid_consistency  = on&lt;br&gt;在mysql 5.7 中。这2个参数可以被动态修改&lt;/p&gt;
&lt;p&gt;单开启gtid_mode = on 时。</summary>
      
    
    
    
    <category term="mysql" scheme="https://sheenzxx.github.io/categories/mysql/"/>
    
    
    <category term="replication" scheme="https://sheenzxx.github.io/tags/replication/"/>
    
    <category term="gtid" scheme="https://sheenzxx.github.io/tags/gtid/"/>
    
  </entry>
  
  <entry>
    <title>python 连接 Oceanbase 数据库</title>
    <link href="https://sheenzxx.github.io/2023/09/25/python2oceanbase/"/>
    <id>https://sheenzxx.github.io/2023/09/25/python2oceanbase/</id>
    <published>2023-09-25T07:11:44.000Z</published>
    <updated>2023-09-25T07:28:48.274Z</updated>
    
    <content type="html"><![CDATA[<p>通过python 连接 Oceanbase 数据库。我们通过jdbc 的方式来实现</p><ol><li>java jdk8 or jdk 11<br>oracle 官网下载 jdk8 或者 open jdk 11 设置JAVA_HOME</li><li>jaydebeapi 包<br>pip install jaydebeapi</li><li>ob-client jar包: oceanbase-client-2.x.x.jar<br>下载 oceanbase-client-2.4.1.jar 放在指定目录 在jarFile 中需要用到</li></ol><p>准备好以上的东西后，定义数据库连接类,使用 com.alipay.oceanbase.jdbc.Driver 驱动类<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Obconnect</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,ip,port,dbname,user,password</span>):</span><br><span class="line">        self.ip = ip</span><br><span class="line">        self.port = port</span><br><span class="line">        self.dbname = dbname</span><br><span class="line">        self.user = user</span><br><span class="line">        self.password = password</span><br><span class="line">        self.driver = <span class="string">&#x27;com.alipay.oceanbase.jdbc.Driver&#x27;</span></span><br><span class="line">        self.jarFile = <span class="string">&#x27;./oceanbase-client-2.4.1.jar&#x27;</span> </span><br><span class="line">        self.url = <span class="string">&#x27;jdbc:oceanbase://&#123;&#125;:&#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.ip,self.port,self.dbname)</span><br><span class="line">        self.conn = jaydebeapi.connect(self.driver, self.url, [user, password], self.jarFile)</span><br><span class="line">        self.cursor = self.conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self,sql</span>):</span><br><span class="line">        self.cursor.execute(sql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">executemany</span>(<span class="params">self,sql,data</span>):</span><br><span class="line">        self.cursor.executemany(sql,data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self,sql</span>):</span><br><span class="line">        self.cursor.execute(sql)</span><br><span class="line">        res = self.cursor.fetchall()</span><br><span class="line">        <span class="keyword">return</span> res  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">       self.cursor.close()</span><br><span class="line">       self.conn.close() </span><br></pre></td></tr></table></figure></p><p>实现一个在oracle 读取数据批量写入 oceanbase 的例子<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jaydebeapi</span><br><span class="line"><span class="keyword">from</span> baseTools <span class="keyword">import</span> DbConn <span class="comment">#连接oracle 的定义，大家自行实现用cx_Oracle</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">encoding = <span class="string">&quot;gbk&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Obconnect</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,ip,port,dbname,user,password</span>):</span><br><span class="line">        self.ip = ip</span><br><span class="line">        self.port = port</span><br><span class="line">        self.dbname = dbname</span><br><span class="line">        self.user = user</span><br><span class="line">        self.password = password</span><br><span class="line">        self.driver = <span class="string">&#x27;com.alipay.oceanbase.jdbc.Driver&#x27;</span></span><br><span class="line">        self.jarFile = <span class="string">&#x27;./oceanbase-client-2.4.1.jar&#x27;</span> </span><br><span class="line">        self.url = <span class="string">&#x27;jdbc:oceanbase://&#123;&#125;:&#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.ip,self.port,self.dbname)</span><br><span class="line">        self.conn = jaydebeapi.connect(self.driver, self.url, [user, password], self.jarFile)</span><br><span class="line">        self.cursor = self.conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute</span>(<span class="params">self,sql</span>):</span><br><span class="line">        self.cursor.execute(sql)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">executemany</span>(<span class="params">self,sql,data</span>):</span><br><span class="line">        self.cursor.executemany(sql,data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self,sql</span>):</span><br><span class="line">        self.cursor.execute(sql)</span><br><span class="line">        res = self.cursor.fetchall()</span><br><span class="line">        <span class="keyword">return</span> res  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close</span>(<span class="params">self</span>):</span><br><span class="line">       self.cursor.close()</span><br><span class="line">       self.conn.close() </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##结果集类型转换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">result_change</span>(<span class="params">data</span>):</span><br><span class="line">    result =[]</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> data:</span><br><span class="line">        tmp_list=<span class="built_in">list</span>(row)</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tmp_list)):</span><br><span class="line">            <span class="comment">## 日期型转化。ob 不认datetime 。转成 timestamp</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(tmp_list[idx],datetime.datetime):</span><br><span class="line">                tmp_list[idx] = tmp_list[idx].timestamp()</span><br><span class="line">        result.append(tmp_list)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment">## 构造 insert sql 模板</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">insert_string_creater</span>(<span class="params">title,table_name,dbtype</span>):</span><br><span class="line">    <span class="keyword">if</span> dbtype == <span class="string">&quot;oracle&quot;</span>:</span><br><span class="line">        parstr = <span class="string">&quot;,&quot;</span>.join([<span class="string">&quot;:%s&quot;</span>%col <span class="keyword">for</span> col <span class="keyword">in</span> title])</span><br><span class="line">        instr = <span class="string">&quot;insert into %s values (%s)&quot;</span>%(table_name,parstr)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> dbtype == <span class="string">&quot;mysql&quot;</span>:</span><br><span class="line">            tp = [<span class="string">&#x27;`%s`&#x27;</span>%t <span class="keyword">for</span> t <span class="keyword">in</span> title ]</span><br><span class="line">            title_str = <span class="string">&quot;,&quot;</span>.join(tp)</span><br><span class="line">        <span class="keyword">else</span>:   </span><br><span class="line">            title_str = <span class="string">&quot;,&quot;</span>.join(title)</span><br><span class="line">        val_str = <span class="string">&quot;,&quot;</span>.join([<span class="string">&#x27;%s&#x27;</span>]*<span class="built_in">len</span>(title))</span><br><span class="line">        instr = <span class="string">&quot;insert into %s (%s) values (%s)&quot;</span>%(table_name,title_str,val_str) </span><br><span class="line">    <span class="keyword">return</span> instr</span><br><span class="line"></span><br><span class="line"><span class="comment">## 连接实例</span></span><br><span class="line">obconn = Obconnect(<span class="string">&#x27;xxxx&#x27;</span>,<span class="number">1521</span>,<span class="string">&#x27;xxxx&#x27;</span>,<span class="string">&#x27;xxxx&#x27;</span>,<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">oraconn = DbConn(&#123;<span class="string">&quot;ip&quot;</span>:<span class="string">&#x27;192.168.xxx.xxx&#x27;</span>,<span class="string">&quot;port&quot;</span>:<span class="number">1521</span>,<span class="string">&quot;db&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;user&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;xxx&quot;</span>,<span class="string">&quot;dbtype&quot;</span>:<span class="string">&quot;oracle&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">## </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bulk_insert</span>(<span class="params">table_name</span>):</span><br><span class="line">    res,title = oraconn.query_title(<span class="string">&quot;select * from product_app.%s where rownum &lt;10000 &quot;</span>%table_name)</span><br><span class="line">    instr = insert_string_creater(title,table_name,<span class="string">&#x27;oracle&#x27;</span>)</span><br><span class="line">    data = result_change(res)</span><br><span class="line">    obconn.executemany(instr,data)</span><br><span class="line">    obconn.execute(<span class="string">&quot;commit&quot;</span>)</span><br><span class="line"></span><br><span class="line">bulk_insert(<span class="string">&#x27;cc_acl&#x27;</span>)</span><br></pre></td></tr></table></figure></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;通过python 连接 Oceanbase 数据库。我们通过jdbc 的方式来实现&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;java jdk8 or jdk 11&lt;br&gt;oracle 官网下载 jdk8 或者 open jdk 11 设置JAVA_HOME&lt;/li&gt;
&lt;li&gt;jaydeb</summary>
      
    
    
    
    <category term="oceanbase" scheme="https://sheenzxx.github.io/categories/oceanbase/"/>
    
    
    <category term="python" scheme="https://sheenzxx.github.io/tags/python/"/>
    
    <category term="driver" scheme="https://sheenzxx.github.io/tags/driver/"/>
    
  </entry>
  
  <entry>
    <title>使用 gin 优化一例</title>
    <link href="https://sheenzxx.github.io/2023/09/25/gincase/"/>
    <id>https://sheenzxx.github.io/2023/09/25/gincase/</id>
    <published>2023-09-25T03:44:10.000Z</published>
    <updated>2023-09-25T04:02:32.499Z</updated>
    
    <content type="html"><![CDATA[<p>大数据组那边有个系统用了PG 。在慢语句告警中发现有个update 用了 78 秒<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> tag_users_mapping </span><br><span class="line">  <span class="keyword">set</span> user_ids<span class="operator">=</span>(<span class="keyword">select</span> <span class="built_in">coalesce</span>(rb_build_agg(user_id), rb_build(<span class="string">&#x27;&#123;&#125;&#x27;</span>))</span><br><span class="line"><span class="keyword">from</span>  user_tags_mapping </span><br><span class="line"><span class="keyword">where</span> leave <span class="operator">~</span> <span class="string">&#x27;(^20411947,)|(,20411947,)|(,20411947$)&#x27;</span> <span class="keyword">or</span> leave<span class="operator">=</span><span class="string">&#x27;20411947&#x27;</span>) <span class="keyword">where</span> id<span class="operator">=</span><span class="number">156518</span></span><br></pre></td></tr></table></figure><br>通过分析可以看到慢的是在update set 的子句里面。leave 用了正则表达式，user_tags_mapping 有2300W数据。走全表扫描。<br>查看表数据库可以看到leave 是使用text 类型存的数据为：<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;20121054,202365,20490503,500902&quot;</span><br><span class="line">&quot;2014550,204104135,20210,2013225,2022,20495281,500605,500902&quot;</span><br><span class="line">&quot;2011726,2023,20489521,50402,500902&quot;</span><br><span class="line">&quot;2013286,2022,204102891,50402,500902&quot;</span><br><span class="line">&quot;2013836,20210,204106485,50402,500902&quot;</span><br><span class="line">&quot;2019306,20217,204105486,500605,500902&quot;</span><br><span class="line">&quot;2013286,2022,204102891,50402,500902&quot;</span><br><span class="line">&quot;20124394,202107,20488918,500605,500902&quot;</span><br><span class="line">&quot;204108669,2013996,20215,204108668,500902&quot;</span><br><span class="line">&quot;2013286,2022,50402,500902&quot;</span><br></pre></td></tr></table></figure><br>开发用了正则匹配只是为了匹配 某个ID 存在于leave 中。<br>如何加速查询呢？唯有索引。看到这种按逗号分隔的组成，可以想到如果是array 数组，我们可以加上gin 索引来提高检索速度。<br>PG 有提供 string_to_array 将字符串分割成array 。也支持函数索引。于是建索引如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index idx_user_tags_mapping_leave <span class="keyword">on</span>  user_tags_mapping <span class="keyword">using</span> gin(string_to_array(leave,<span class="string">&#x27;,&#x27;</span>))</span><br></pre></td></tr></table></figure><br>将SQL改写,利用 &amp;&amp; 匹配 某个数组中的元素是否存在另一个数组<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> tag_users_mapping </span><br><span class="line">  <span class="keyword">set</span> user_ids<span class="operator">=</span>(<span class="keyword">select</span> <span class="built_in">coalesce</span>(rb_build_agg(user_id), rb_build(<span class="string">&#x27;&#123;&#125;&#x27;</span>)) <span class="keyword">from</span> tmp_user_tags_mapping <span class="keyword">where</span> <span class="keyword">array</span>[<span class="string">&#x27;20411947&#x27;</span>]<span class="operator">&amp;&amp;</span>string_to_array(leave,<span class="string">&#x27;,&#x27;</span>)) <span class="keyword">where</span> id<span class="operator">=</span><span class="number">156518</span></span><br></pre></td></tr></table></figure><br>这个查询需要花费 56ms 。性能提升 1300+ 倍。优化效果很明显。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;大数据组那边有个系统用了PG 。在慢语句告警中发现有个update 用了 78 秒&lt;br&gt;&lt;figure class=&quot;highlight sql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;</summary>
      
    
    
    
    <category term="postgresql" scheme="https://sheenzxx.github.io/categories/postgresql/"/>
    
    
    <category term="gin index" scheme="https://sheenzxx.github.io/tags/gin-index/"/>
    
  </entry>
  
  <entry>
    <title>记一次 waiting for table flush 故障</title>
    <link href="https://sheenzxx.github.io/2023/09/06/waitTableFlush/"/>
    <id>https://sheenzxx.github.io/2023/09/06/waitTableFlush/</id>
    <published>2023-09-06T08:22:50.000Z</published>
    <updated>2023-09-06T09:05:58.343Z</updated>
    
    <content type="html"><![CDATA[<p>早上运维同事说某一个应用的数据库突然报 too many session<br>于是登上数据库查看。发现数据库里堆积了有1000个会话。并且全部处于state: waiting for table flush<br>优先处理故障，将所有阻塞语句全部杀掉</p><p>通过监控，agent 日志等发现有一个慢语句在昨天下午两点多一直运行到早上5点。在慢语句系统中找出来发现<br>这个语句2表关联查询。并没有关联条件。导致SQL 出现笛卡尔积。因为表比较大。导致SQL 一直运行。可这个<br>语句为啥会导致 在5点钟左右开始所有的会话都陷入等待呢。</p><p>最终排查到我们的定时任务刚好在4点57 分开始。<br>xtrabackup 备份 会在备份非innodb 文件之前执行 flush tables with read lock. 以确保备份一致性。<br>这个时候一个长查询一直没有结束。导致 xtrabckup 进入等待，又因为是获取全局读锁。导致其他会话进来<br>后也一起陷入 waiting for table flush 。最终连接被耗尽，故障发生。</p><p>对于xtrabackup 官网针对这个问题提供了一些解决方案<br><a href="https://docs.percona.com/percona-xtrabackup/2.4/innobackupex/improved_ftwrl.html">https://docs.percona.com/percona-xtrabackup/2.4/innobackupex/improved_ftwrl.html</a></p><p>通过对下列参数的设置。可以避免trabackup 长时间等待，从而引发系统故障。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ftwrl-wait-query-type             ALL  <span class="comment"># which long queries should be finished before ftwrl</span></span><br><span class="line">ftwrl-wait-threshold              60   <span class="comment"># how long query should be running before we consider it long running and potential blocker of global lock</span></span><br><span class="line">kill-long-query-type              SELECT <span class="comment"># which queries should be killed once kill-long-queries-timeout has expired.</span></span><br><span class="line">kill-long-queries-timeout         0    <span class="comment"># how many time we give for queries to complete after FLUSH TABLES WITH READ LOCK is issued before start to kill. Default if 0, not to kill</span></span><br><span class="line">ftwrl-wait-timeout                0    <span class="comment"># how long to wait for a good moment. Default is 0, not to wait.</span></span><br><span class="line"></span><br><span class="line">example:</span><br><span class="line">$ innobackupex --ftwrl-wait-threshold=40 --ftwrl-wait-query-type=all --ftwrl-wait-timeout=180 --kill-long-queries-timeout=20 --kill-long-query-type=all /data/backups/</span><br></pre></td></tr></table></figure><br>当然对数据库长查询的监控也很有必要。之前是通过邮件告警。告警太多。被淹没了。这次也将告警接入企微。更加重视它。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;早上运维同事说某一个应用的数据库突然报 too many session&lt;br&gt;于是登上数据库查看。发现数据库里堆积了有1000个会话。并且全部处于state: waiting for table flush&lt;br&gt;优先处理故障，将所有阻塞语句全部杀掉&lt;/p&gt;
&lt;p&gt;通过监</summary>
      
    
    
    
    <category term="mysql" scheme="https://sheenzxx.github.io/categories/mysql/"/>
    
    
    <category term="long query" scheme="https://sheenzxx.github.io/tags/long-query/"/>
    
    <category term="xtrabackup" scheme="https://sheenzxx.github.io/tags/xtrabackup/"/>
    
  </entry>
  
  <entry>
    <title>单机版将mongodb单节点升级为副本集群</title>
    <link href="https://sheenzxx.github.io/2023/09/01/mongoSingle-Replicaset/"/>
    <id>https://sheenzxx.github.io/2023/09/01/mongoSingle-Replicaset/</id>
    <published>2023-09-01T02:42:44.000Z</published>
    <updated>2023-09-01T02:51:11.275Z</updated>
    
    <content type="html"><![CDATA[<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>1.修改配置文件 /etc/mongod.conf,添加<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">replication:</span><br><span class="line">  oplogSizeMB: 2048</span><br><span class="line">  replSetName: mmp_wuid</span><br><span class="line">  </span><br><span class="line">security:</span><br><span class="line">  keyFile: /data/mongodb/etc/mongo.keyfile </span><br><span class="line">  authorization: &quot;enabled&quot;</span><br><span class="line">  </span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">2.生成keyFile ,replica 开启security 需要设置keyFile</span><br><span class="line">```bash</span><br><span class="line">mkdir -p /data/mongodb/etc</span><br><span class="line">openssl rand -base64 753 &gt; /data/mongodb/etc/mongo.keyfile</span><br><span class="line">chmod 600 /app/mongodb/etc/mongo.keyfile</span><br></pre></td></tr></table></figure></p><h2 id="停止monogdb-服务"><a href="#停止monogdb-服务" class="headerlink" title="停止monogdb 服务"></a>停止monogdb 服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ mongo   </span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.auth(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;xxxx&#x27;</span>) </span><br><span class="line">&gt;db.shutdownServer()</span><br><span class="line"><span class="comment">## 重启mongodb 服务</span></span><br><span class="line">systemctl start mongodb.service</span><br></pre></td></tr></table></figure><h2 id="配置复制集"><a href="#配置复制集" class="headerlink" title="配置复制集"></a>配置复制集</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mongo</span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.auth(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">&gt;config = &#123;<span class="string">&quot;_id&quot;</span>:<span class="string">&quot;mmp_wuid&quot;</span>,members : [&#123;_id:0, host:<span class="string">&quot;192.168.30.207:27017&quot;</span>&#125;]&#125;</span><br><span class="line">&gt;rs.initiate(config)</span><br></pre></td></tr></table></figure><h2 id="搭建从节点"><a href="#搭建从节点" class="headerlink" title="搭建从节点"></a>搭建从节点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkidr -p /app/mongodb_rep/&#123;<span class="built_in">log</span>,mongodb,etc&#125;</span><br><span class="line"><span class="built_in">cp</span> /etc/mongod.conf /etc/mongo_rep.conf</span><br><span class="line"><span class="comment">##修改 logfile 以及dbpath 指向从库实际路径,以及端口</span></span><br><span class="line"><span class="built_in">cp</span> /data/mongodb/etc/mongo.keyfile /app/mongodb_rep/etc/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> /lib/systemd/system/mongodb.service /lib/systemd/system/mongodb_rep.service</span><br><span class="line">vi mongodb_rep.service </span><br><span class="line"><span class="comment">##修改指向rep 配置文件的路径</span></span><br><span class="line"></span><br><span class="line">systemclt daemon-reaload</span><br><span class="line">systemctl start mongodb_rep.service</span><br></pre></td></tr></table></figure><h2 id="主节点上添加-replica-节点"><a href="#主节点上添加-replica-节点" class="headerlink" title="主节点上添加 replica 节点"></a>主节点上添加 replica 节点</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; rs.add(&quot;192.168.30.207:27018&quot;)</span><br><span class="line">&gt; rs.status()</span><br></pre></td></tr></table></figure><p>可以看到节点2 处于 startup2 状态。为同步数据</p><h1 id="到此。单节点升级为replica-集群完成"><a href="#到此。单节点升级为replica-集群完成" class="headerlink" title="到此。单节点升级为replica 集群完成"></a>到此。单节点升级为replica 集群完成</h1><h2 id="错误与解决"><a href="#错误与解决" class="headerlink" title="错误与解决"></a>错误与解决</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">在副本集中启用认证后需要配置security.keyFile，否则会报如下错误</span><br><span class="line">1. BadValue: security.keyFile is required when authorization is enabled with replica sets</span><br><span class="line">try &#x27;/usr/local/mongodb/bin/mongod --help&#x27; for more information]</span><br><span class="line"></span><br><span class="line">在节点1上</span><br><span class="line">openssl rand -base64 753 &gt; /data/mongodb/etc/mongo.keyfile</span><br><span class="line">chmod 600 /app/mongodb/etc/mongo.keyfile</span><br><span class="line">拷贝到节点2</span><br><span class="line">scp mongo.keyfile mongodb2:`pwd`</span><br><span class="line"></span><br><span class="line">2. permissions on /app/mongodb_rep/etc/mongo.keyfile are too open</span><br><span class="line"></span><br><span class="line">mongo.keyfile 权限过大</span><br><span class="line">chmod 600 /app/mongodb_rep/etc/mongo.keyfile</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;准备&quot;&gt;&lt;a href=&quot;#准备&quot; class=&quot;headerlink&quot; title=&quot;准备&quot;&gt;&lt;/a&gt;准备&lt;/h2&gt;&lt;p&gt;1.修改配置文件 /etc/mongod.conf,添加&lt;br&gt;&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;t</summary>
      
    
    
    
    <category term="mongodb" scheme="https://sheenzxx.github.io/categories/mongodb/"/>
    
    
    <category term="replica" scheme="https://sheenzxx.github.io/tags/replica/"/>
    
  </entry>
  
  <entry>
    <title>利用hive将habse数据导入clickhouse</title>
    <link href="https://sheenzxx.github.io/2023/08/25/hvie2clickhouse/"/>
    <id>https://sheenzxx.github.io/2023/08/25/hvie2clickhouse/</id>
    <published>2023-08-25T07:42:12.000Z</published>
    <updated>2023-08-25T10:24:19.967Z</updated>
    
    <content type="html"><![CDATA[<p>如何将hbase 的数据导入clickhouse 呢。一种通过第三方工具,例如 datax 来传输，但是配置比较麻烦。<br>想到clickhouse 支持 hive 外部表查询。我们可以利用建立外部表的方式。将数据抽取到clickhouse 本地。</p><h3 id="clickhouse数据库的准备，起开远程本地缓存"><a href="#clickhouse数据库的准备，起开远程本地缓存" class="headerlink" title="clickhouse数据库的准备，起开远程本地缓存"></a>clickhouse数据库的准备，起开远程本地缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启本地cache 可以使 查询速度提高2x</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /data1/clickhouse/local_cache</span><br><span class="line"><span class="built_in">chown</span> -R clickhouse:clickhouse /data1/clickhouse</span><br><span class="line">vi /etc/clickhouse-server/config.xml</span><br><span class="line"><span class="comment">##开启添加本地缓存</span></span><br><span class="line">    &lt;local_cache_for_remote_fs&gt;</span><br><span class="line">        &lt;<span class="built_in">enable</span>&gt;<span class="literal">true</span>&lt;/enable&gt;</span><br><span class="line">        &lt;root_dir&gt;/data1/clickhouse/local_cache&lt;/root_dir&gt;</span><br><span class="line">        &lt;limit_size&gt;559096952&lt;/limit_size&gt;</span><br><span class="line">        &lt;bytes_read_before_flush&gt;1048576&lt;/bytes_read_before_flush&gt;</span><br><span class="line">    &lt;/local_cache_for_remote_fs&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable: ClickHouse will maintain local cache for remote filesystem(HDFS) after startup if true.</span></span><br><span class="line"><span class="comment"># root_dir: Required. The root directory to store local cache files for remote filesystem.</span></span><br><span class="line"><span class="comment"># limit_size: Required. The maximum size(in bytes) of local cache files.</span></span><br><span class="line"><span class="comment"># bytes_read_before_flush: Control bytes before flush to local filesystem when downloading file from remote filesystem. The default value is 1MB.</span></span><br><span class="line"><span class="comment"># 重启数据库</span></span><br><span class="line"><span class="comment"># 用户可以通过设置 set use_local_cache_for_remote_fs = 0 关闭使用本地缓存</span></span><br></pre></td></tr></table></figure><h3 id="hbase-中的表"><a href="#hbase-中的表" class="headerlink" title="hbase 中的表"></a>hbase 中的表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="string">&#x27;hive_hbase_table&#x27;</span>,<span class="string">&#x27;cf1&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="在-hive-中建立访问-hbase-的表"><a href="#在-hive-中建立访问-hbase-的表" class="headerlink" title="在 hive 中建立访问 hbase 的表"></a>在 hive 中建立访问 hbase 的表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use test;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> hive_hbase_table(key <span class="type">int</span>, <span class="keyword">value</span> string) <span class="operator">/</span><span class="operator">/</span> key 字段必须，对应 hbase 中的rowkey</span><br><span class="line">STORED <span class="keyword">BY</span> <span class="string">&#x27;org.apache.hadoop.hive.hbase.HBaseStorageHandler&#x27;</span> </span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (&quot;hbase.columns.mapping&quot; <span class="operator">=</span> &quot;:key,cf1:val&quot;) <span class="operator">/</span><span class="operator">/</span> hbase 字段映射</span><br><span class="line">TBLPROPERTIES (&quot;hbase.table.name&quot; <span class="operator">=</span> &quot;hive_hbase_table&quot;); <span class="operator">/</span><span class="operator">/</span> 映射hbase 中的表名</span><br></pre></td></tr></table></figure><h3 id="在-clickhouse-中间-hive-外部表"><a href="#在-clickhouse-中间-hive-外部表" class="headerlink" title="在 clickhouse 中间 hive 外部表"></a>在 clickhouse 中间 hive 外部表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test.test_orc</span><br><span class="line">(</span><br><span class="line">    `key` Int32,</span><br><span class="line">    `val` Int16</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> Hive(<span class="string">&#x27;thrift://xxx.xxx.xxx.xxx:9083&#x27;</span>, <span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;hive_hbase_table&#x27;</span>);</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;如何将hbase 的数据导入clickhouse 呢。一种通过第三方工具,例如 datax 来传输，但是配置比较麻烦。&lt;br&gt;想到clickhouse 支持 hive 外部表查询。我们可以利用建立外部表的方式。将数据抽取到clickhouse 本地。&lt;/p&gt;
&lt;h3 id=</summary>
      
    
    
    
    <category term="clickhouse" scheme="https://sheenzxx.github.io/categories/clickhouse/"/>
    
    
    <category term="hive" scheme="https://sheenzxx.github.io/tags/hive/"/>
    
    <category term="clickhouse" scheme="https://sheenzxx.github.io/tags/clickhouse/"/>
    
    <category term="hbase" scheme="https://sheenzxx.github.io/tags/hbase/"/>
    
  </entry>
  
  <entry>
    <title>maxscale 安装与配置</title>
    <link href="https://sheenzxx.github.io/2023/08/17/maxscale/"/>
    <id>https://sheenzxx.github.io/2023/08/17/maxscale/</id>
    <published>2023-08-17T03:14:31.000Z</published>
    <updated>2023-09-27T09:23:30.915Z</updated>
    
    <content type="html"><![CDATA[<p>maridb 的中间件 maxscale 一个C语言实现的智能代理(intelligent proxy), 提供读写分离,负载均衡和高可用性。它同时维护client端请求的连接以及到后端server的连接。</p><p>下载<br><a href="https://mariadb.com/downloads/community/maxscale/">https://mariadb.com/downloads/community/maxscale/</a></p><p>使用二进制压缩包安装的方式<br>下载: <a href="https://dlm.mariadb.com/3440302/MaxScale/23.08.1/centos/7/x86_64/maxscale-23.08.1.rhel.7.tar.gz">https://dlm.mariadb.com/3440302/MaxScale/23.08.1/centos/7/x86_64/maxscale-23.08.1.rhel.7.tar.gz</a></p><p>安装需要的库<br>libcurl<br>libaio<br>OpenSSL<br>gnutls<br>libatomic<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libaio  libcurl OpenSSL gnutls libatomic</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /data</span><br><span class="line"></span><br><span class="line">tar -xzvf maxscale-23.08.1.rhel.7.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">ln</span> -s /data/maxscale-23.08.1.rhel.7 maxscale</span><br><span class="line"></span><br><span class="line">groupadd maxscale</span><br><span class="line">useradd -g maxscale maxscale</span><br><span class="line"></span><br><span class="line"><span class="built_in">chown</span> -R maxscale:maxscale /data/maxscale</span><br></pre></td></tr></table></figure><br>编辑配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/maxscale/etc</span><br><span class="line"><span class="built_in">cp</span> maxscale.cnf.template maxscale.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment">## 定义写实例</span></span><br><span class="line">[server1]</span><br><span class="line"><span class="built_in">type</span>=server</span><br><span class="line">address=192.168.12.5</span><br><span class="line">port=3306</span><br><span class="line">protocol=MySQLBackend</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line"><span class="built_in">type</span>=server</span><br><span class="line">address=192.168.12.6</span><br><span class="line">port=3306</span><br><span class="line">protocol=MySQLBackend</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义监控</span></span><br><span class="line">[MariaDB-Monitor]</span><br><span class="line"><span class="built_in">type</span>=monitor</span><br><span class="line">module=mariadbmon</span><br><span class="line">servers=server1,server2</span><br><span class="line">user=monitor_user</span><br><span class="line">password=monitor_pw</span><br><span class="line">monitor_interval=2s</span><br><span class="line"></span><br><span class="line"><span class="comment">#定义只读服务</span></span><br><span class="line">[Read-Only-Service]</span><br><span class="line"><span class="built_in">type</span>=service</span><br><span class="line">router=readconnroute</span><br><span class="line">servers=server2</span><br><span class="line">user=service_user</span><br><span class="line">password=service_pw</span><br><span class="line">router_options=slave</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义读写分离服务</span></span><br><span class="line">[Read-Write-Service]</span><br><span class="line"><span class="built_in">type</span>=service</span><br><span class="line">router=readwritesplit</span><br><span class="line">servers=server1,server2</span><br><span class="line">max_slave_replication_lag=3  </span><br><span class="line">user=service_user</span><br><span class="line">password=service_pw</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义只读监听端口</span></span><br><span class="line">[Read-Only-Listener]</span><br><span class="line"><span class="built_in">type</span>=listener</span><br><span class="line">service=Read-Only-Service</span><br><span class="line">protocol=MariaDBClient</span><br><span class="line">port=4008</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义读写监听端口</span></span><br><span class="line">[Read-Write-Listener]</span><br><span class="line"><span class="built_in">type</span>=listener</span><br><span class="line">service=Read-Write-Service</span><br><span class="line">protocol=MariaDBClient</span><br><span class="line">port=4006</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#在实例 server 1,sever 2 上</span></span><br><span class="line"><span class="comment">#创建监控用户</span></span><br><span class="line">CREATE USER <span class="string">&#x27;monitor_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;monitor_pw&#x27;</span>;</span><br><span class="line">GRANT REPLICATION CLIENT, FILE, SUPER, RELOAD, PROCESS, SHOW DATABASES, EVENT ON *.* TO <span class="string">&#x27;monitor_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建maxscale监视连接用户</span></span><br><span class="line">CREATE USER <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;service_pw&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.user TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.db TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.tables_priv TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.columns_priv TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.procs_priv TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.proxies_priv TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SELECT ON mysql.roles_mapping TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">GRANT SHOW DATABASES ON *.* TO <span class="string">&#x27;service_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建连接数据库的客户端用户</span></span><br><span class="line">grant all on db.* TO <span class="string">&#x27;app&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动maxscale</span></span><br><span class="line">bin/maxscale -d --basedir=.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#maxscale 部署最佳实践就跟应用部署在同一个服务器上，应用通过连localhost 或 127.0.0.1 来连接数据库</span></span><br><span class="line"><span class="comment">#也可以多台部署。前端通过nginx 等做负载均衡，统一入口</span></span><br></pre></td></tr></table></figure><p>maxctrl 的 相关用法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">Commands:</span><br><span class="line">  maxctrl list &lt;<span class="built_in">command</span>&gt;        List objects</span><br><span class="line">  maxctrl show &lt;<span class="built_in">command</span>&gt;        Show objects</span><br><span class="line">  maxctrl <span class="built_in">set</span> &lt;<span class="built_in">command</span>&gt;         Set object state</span><br><span class="line">  maxctrl clear &lt;<span class="built_in">command</span>&gt;       Clear object state</span><br><span class="line">  maxctrl <span class="built_in">enable</span> &lt;<span class="built_in">command</span>&gt;      Enable functionality</span><br><span class="line">  maxctrl <span class="built_in">disable</span> &lt;<span class="built_in">command</span>&gt;     Disable functionality</span><br><span class="line">  maxctrl create &lt;<span class="built_in">command</span>&gt;      Create objects</span><br><span class="line">  maxctrl destroy &lt;<span class="built_in">command</span>&gt;     Destroy objects</span><br><span class="line">  maxctrl <span class="built_in">link</span> &lt;<span class="built_in">command</span>&gt;        Link objects</span><br><span class="line">  maxctrl <span class="built_in">unlink</span> &lt;<span class="built_in">command</span>&gt;      Unlink objects</span><br><span class="line">  maxctrl start &lt;<span class="built_in">command</span>&gt;       Start objects</span><br><span class="line">  maxctrl stop &lt;<span class="built_in">command</span>&gt;        Stop objects</span><br><span class="line">  maxctrl alter &lt;<span class="built_in">command</span>&gt;       Alter objects</span><br><span class="line">  maxctrl rotate &lt;<span class="built_in">command</span>&gt;      Rotate <span class="built_in">log</span> files</span><br><span class="line">  maxctrl reload &lt;<span class="built_in">command</span>&gt;      Reload objects</span><br><span class="line">  maxctrl call &lt;<span class="built_in">command</span>&gt;        Call module commands</span><br><span class="line">  maxctrl api &lt;<span class="built_in">command</span>&gt;         Raw REST API access</span><br><span class="line">  maxctrl classify &lt;statement&gt;  Classify statement</span><br><span class="line"></span><br><span class="line">Global Options:</span><br><span class="line">  -c, --config     MaxCtrl configuration file</span><br><span class="line">                                            [string] [default: <span class="string">&quot;~/.maxctrl.cnf&quot;</span>]</span><br><span class="line">  -u, --user       Username to use                   [string] [default: <span class="string">&quot;admin&quot;</span>]</span><br><span class="line">  -p, --password   Password <span class="keyword">for</span> the user. To input the password manually, use -p</span><br><span class="line">                   <span class="string">&#x27;&#x27;</span> or --password=<span class="string">&#x27;&#x27;</span>             [string] [default: <span class="string">&quot;mariadb&quot;</span>]</span><br><span class="line">  -h, --hosts      List of MaxScale hosts. The hosts must be <span class="keyword">in</span> HOST:PORT format</span><br><span class="line">                   and each value must be separated by a comma.</span><br><span class="line">                                            [string] [default: <span class="string">&quot;127.0.0.1:8989&quot;</span>]</span><br><span class="line">  -t, --<span class="built_in">timeout</span>    Request <span class="built_in">timeout</span> <span class="keyword">in</span> plain milliseconds, e.g <span class="string">&#x27;-t 1000&#x27;</span>, or as</span><br><span class="line">                   duration with suffix [h|m|s|ms], e.g. <span class="string">&#x27;-t 10s&#x27;</span></span><br><span class="line">                                                     [string] [default: <span class="string">&quot;10000&quot;</span>]</span><br><span class="line">  -q, --quiet      Silence all output. Ignored <span class="keyword">while</span> <span class="keyword">in</span> interactive mode.</span><br><span class="line">                                                      [boolean] [default: <span class="literal">false</span>]</span><br><span class="line">      --tsv        Print tab separated output         [boolean] [default: <span class="literal">false</span>]</span><br><span class="line">      --skip-sync  Disable configuration synchronization <span class="keyword">for</span> this <span class="built_in">command</span></span><br><span class="line">                                                      [boolean] [default: <span class="literal">false</span>]</span><br><span class="line"></span><br><span class="line">HTTPS/TLS Options:</span><br><span class="line">  -s, --secure                  Enable HTTPS requests [boolean] [default: <span class="literal">false</span>]</span><br><span class="line">      --tls-key                 Path to TLS private key                 [string]</span><br><span class="line">      --tls-passphrase          Password <span class="keyword">for</span> the TLS private key        [string]</span><br><span class="line">      --tls-cert                Path to TLS public certificate          [string]</span><br><span class="line">      --tls-ca-cert             Path to TLS CA certificate              [string]</span><br><span class="line">  -n, --tls-verify-server-cert  Whether to verify server TLS certificates</span><br><span class="line">                                                       [boolean] [default: <span class="literal">true</span>]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --version  Show version number                                   [boolean]</span><br><span class="line">      --<span class="built_in">help</span>     Show <span class="built_in">help</span>                                             [boolean]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line">maxctrl list --<span class="built_in">help</span></span><br><span class="line">Commands:</span><br><span class="line">  maxctrl list servers              List servers</span><br><span class="line">  maxctrl list services             List services</span><br><span class="line">  maxctrl list listeners [service]  List listeners</span><br><span class="line">  maxctrl list monitors             List monitors</span><br><span class="line">  maxctrl list sessions             List sessions</span><br><span class="line">  maxctrl list filters              List filters</span><br><span class="line">  maxctrl list modules              List loaded modules</span><br><span class="line">  maxctrl list threads              List threads</span><br><span class="line">  maxctrl list <span class="built_in">users</span>                List created <span class="built_in">users</span></span><br><span class="line">  maxctrl list commands             List module commands</span><br><span class="line">  maxctrl list queries              List active queries from all sessions</span><br></pre></td></tr></table></figure></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;maridb 的中间件 maxscale 一个C语言实现的智能代理(intelligent proxy), 提供读写分离,负载均衡和高可用性。它同时维护client端请求的连接以及到后端server的连接。&lt;/p&gt;
&lt;p&gt;下载&lt;br&gt;&lt;a href=&quot;https://mar</summary>
      
    
    
    
    <category term="mysql" scheme="https://sheenzxx.github.io/categories/mysql/"/>
    
    
    <category term="中间件" scheme="https://sheenzxx.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="读写分离" scheme="https://sheenzxx.github.io/tags/%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/"/>
    
  </entry>
  
  <entry>
    <title>搭建 shardingsphere-proxy-4.1.1</title>
    <link href="https://sheenzxx.github.io/2023/07/27/sharding-proxy/"/>
    <id>https://sheenzxx.github.io/2023/07/27/sharding-proxy/</id>
    <published>2023-07-27T07:29:41.000Z</published>
    <updated>2023-07-27T07:59:54.254Z</updated>
    
    <content type="html"><![CDATA[<p>shardingsphere-proxy 4.x 跟 5.x 差别比较大。这里介绍4.x proxy 的搭建<br>在 <a href="https://archive.apache.org/dist/shardingsphere/">https://archive.apache.org/dist/shardingsphere/</a> 下载所需版本<br>本文选择的是 apache-shardingsphere-4.1.1-sharding-proxy-bin.tar.gz </p><p>1.安装jdk<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /app</span><br><span class="line">tar -xzvf jdk-8u341-linux-x64.tar.gz </span><br><span class="line">vi ~/.bash_profile</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/app/jdk1.8.0_341</span><br><span class="line">PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/.local/bin:<span class="variable">$HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> PATH</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></p><p>2.解压配置proxy<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 解压bin 包</span></span><br><span class="line"><span class="built_in">cd</span> /app</span><br><span class="line">tar -xzvf apache-shardingsphere-4.1.1-sharding-proxy-bin.tar.gz </span><br><span class="line"><span class="built_in">mv</span> apache-shardingsphere-4.1.1-sharding-proxy-bin shardingsphere-proxy-4.11</span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置授权文件，定义了shardingsphere-proxy 登录的用户以及密码。</span></span><br><span class="line"><span class="built_in">cd</span> shardingsphere-proxy-4.11</span><br><span class="line">vi conf/server.yaml</span><br><span class="line"></span><br><span class="line">authentication:</span><br><span class="line">  <span class="built_in">users</span>:</span><br><span class="line">    root:         <span class="comment"># 用户</span></span><br><span class="line">      password: root  <span class="comment"># 密码</span></span><br><span class="line">    sharding:     <span class="comment"># 用户</span></span><br><span class="line">      password: sharding  <span class="comment"># 密码</span></span><br><span class="line">      authorizedSchemas: beauty_db <span class="comment"># 授权数据库,要设置 在config-x 里面定义的 schemaName</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置分片文件</span></span><br><span class="line">vi conf/config-sharding.yaml</span><br><span class="line">schemaName: beauty_db  <span class="comment">## proxy 库名定义</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">dataSources: <span class="comment">## 设置数据源</span></span><br><span class="line">  o2o:  <span class="comment">##数据源名称</span></span><br><span class="line">    url: jdbc:mysql://10.xx.xx.xx:3306/beautydb?serverTimezone=UTC&amp;useSSL=<span class="literal">false</span></span><br><span class="line">    username: beauty</span><br><span class="line">    password: beauty123</span><br><span class="line">    connectionTimeoutMilliseconds: 30000</span><br><span class="line">    idleTimeoutMilliseconds: 60000</span><br><span class="line">    maxLifetimeMilliseconds: 1800000</span><br><span class="line"><span class="comment">## 分片规则定义</span></span><br><span class="line">shardingRule:</span><br><span class="line">  tables:</span><br><span class="line">    wb_service_order:  <span class="comment">## 逻辑表名</span></span><br><span class="line">      actualDataNodes: o2o.wb_service_order_$-&gt;&#123;2022..2023&#125;_$-&gt;&#123;0..9&#125; <span class="comment">## 实际映射的分表&#123;wb_server_order_2022_0 --&gt; wb_server_order_2023_9 &#125;</span></span><br><span class="line">      tableStrategy:</span><br><span class="line">        complex:  <span class="comment">## 分片策略 &#123;standard:标准型 complex: 复合型 inline: 行表达式  hint: 基于hint 的分片策略&#125;</span></span><br><span class="line">          shardingColumns: union_id,create_time  <span class="comment">## 分片字段 ，单字段用shardingColumn 多字段用 shardingColumns</span></span><br><span class="line">          algorithmClassName: cn.smartbreeze.biz.beauty.sharding.algorithm.UnionIdHash10AndTimeYearShardingAlgorithm <span class="comment">##自定义逻辑分片类名</span></span><br><span class="line">    wb_service_order_ext:</span><br><span class="line">      actualDataNodes: o2o.wb_service_order_ext_$-&gt;&#123;2022..2023&#125;_$-&gt;&#123;0..9&#125;</span><br><span class="line">      tableStrategy:</span><br><span class="line">        complex:</span><br><span class="line">          shardingColumns: order_id,create_time</span><br><span class="line">          algorithmClassName: cn.smartbreeze.biz.beauty.sharding.algorithm.OrderId10AndTimeYearShardingAlgorithm</span><br><span class="line">    wb_service_order_log:</span><br><span class="line">      actualDataNodes: o2o.wb_service_order_log_$-&gt;&#123;2023..2023&#125;_$-&gt;&#123;0..9&#125;</span><br><span class="line">      tableStrategy:</span><br><span class="line">        complex:</span><br><span class="line">          shardingColumns: order_id,create_time</span><br><span class="line">          algorithmClassName: cn.smartbreeze.biz.beauty.sharding.algorithm.OrderId10AndTimeYearShardingAlgorithm</span><br><span class="line">    wb_store_schedule:</span><br><span class="line">      actualDataNodes: o2o.wb_store_schedule_$-&gt;&#123;2023..2023&#125;_$-&gt;&#123;0..9&#125;</span><br><span class="line">      tableStrategy:</span><br><span class="line">        complex:</span><br><span class="line">          shardingColumns: store_id,start_time</span><br><span class="line">          algorithmClassName: cn.smartbreeze.biz.beauty.sharding.algorithm.StoreId10AndTimeYearShardingAlgorithm</span><br><span class="line">  bindingTables: <span class="comment">## 需要绑定的表。只展示逻辑名。不展示详细分片表</span></span><br><span class="line">    - wb_service_order ,wb_service_order_ext ,wb_service_order_log ,wb_store_schedule</span><br></pre></td></tr></table></figure><br>3.追加相应jar包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># postgresql 类型的数据库不需要加载驱动包</span></span><br><span class="line"><span class="comment"># mysql 类型数据库需要加载驱动包</span></span><br><span class="line">tar -xzvf mysql-connector-java-5.1.49.tar.gz</span><br><span class="line"><span class="built_in">cp</span> mysql-connector-java-5.1.49/mysql-connector-java-5.1.49.jar  /app/shardingsphere-proxy-4.11/lib <span class="comment"># 驱动包放这个目录底下。</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /app/shardingsphere-proxy-4.11</span><br><span class="line"><span class="built_in">mkdir</span> ext-lib</span><br><span class="line"><span class="built_in">cp</span> store-beauty-biz-0.0.1-SNAPSHOT.jar  store-beauty-core-0.0.1-SNAPSHOT.jar ext-lib <span class="comment">## 这2个为开发写的自定义规则jar 包</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>4.启动验证<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /app/shardingsphere-proxy-4.11</span><br><span class="line">sh bin/start.sh  <span class="comment"># 启动 默认3307 端口。可以通过 sh bin/start.sh $&#123;proxy-port&#125; 的方式自定义端口号</span></span><br><span class="line">sh bin/stop.sh   <span class="comment"># 停止</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#登录验证</span></span><br><span class="line">mysql -usharding -psharding beauty_db --host=x.x.x.x --port=3307 </span><br></pre></td></tr></table></figure></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;shardingsphere-proxy 4.x 跟 5.x 差别比较大。这里介绍4.x proxy 的搭建&lt;br&gt;在 &lt;a href=&quot;https://archive.apache.org/dist/shardingsphere/&quot;&gt;https://archive.apa</summary>
      
    
    
    
    <category term="mysql" scheme="https://sheenzxx.github.io/categories/mysql/"/>
    
    
    <category term="中间件" scheme="https://sheenzxx.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    <category term="分库分表" scheme="https://sheenzxx.github.io/tags/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/"/>
    
  </entry>
  
  <entry>
    <title>处理clickhouse MaterializeMySQL 数据库故障一则</title>
    <link href="https://sheenzxx.github.io/2023/07/21/clickhouseMaterializeMySQL/"/>
    <id>https://sheenzxx.github.io/2023/07/21/clickhouseMaterializeMySQL/</id>
    <published>2023-07-21T06:04:34.000Z</published>
    <updated>2023-07-27T02:32:32.028Z</updated>
    
    <content type="html"><![CDATA[<p>开发同事报clickhouse 的 MaterializeMySQL 数据库查询都报错<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SQL 错误 [48] [07000]: Code: 48, e.displayText() = DB::Exception: Cannot rename and modify the same column `invitation_task_detail` <span class="keyword">in</span> a single ALTER query (version 20.12.4.5 (official build))</span><br><span class="line">, server ClickHouseNode [uri=http://10.82.xxx.xxx:8123/xxxx, options=&#123;use_server_time_zone=<span class="literal">false</span>,use_time_zone=Asia/Shanghai&#125;]@2105728836</span><br></pre></td></tr></table></figure></p><p>后查明原因竟是开发同事在对应的mysql 库修改了表结构。这个时候需要删除重建 MaterializeMySQL 数据库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">sudo docker <span class="built_in">exec</span> -it clickhouse bash</span><br><span class="line">root@WCN-GDUVA-SBKAP1:/<span class="comment"># clickhouse-client --user=default</span></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) drop database store_beauty;</span><br><span class="line"></span><br><span class="line">DROP DATABASE store_beauty</span><br><span class="line"></span><br><span class="line">Query <span class="built_in">id</span>: c4e3933d-8eb4-4ca0-a867-457d4d7e2007</span><br><span class="line"></span><br><span class="line">Ok.</span><br><span class="line"></span><br><span class="line"><span class="comment">## 这里需要开启 allow_experimental_database_materialize_mysql 参数。</span></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) SET allow_experimental_database_materialize_mysql = 1;</span><br><span class="line"></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) CREATE DATABASE store_beauty ENGINE = MaterializeMySQL(<span class="string">&#x27;10.82.xx.xxx:3306&#x27;</span>, <span class="string">&#x27;store_beauty&#x27;</span>, <span class="string">&#x27;repl&#x27;</span>, <span class="string">&#x27;xxxxxx&#x27;</span>);</span><br><span class="line"></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) use store_beauty</span><br><span class="line"></span><br><span class="line">WCN-GDUVA-SBKAP1.aswgcn.asiapacific.aswgroup.net :) show tables;</span><br><span class="line">....</span><br><span class="line">....</span><br><span class="line"><span class="comment">## 发现 生产库正常同步，而uat 只同步了40个表就挂住了。翻看日志</span></span><br><span class="line"><span class="built_in">cd</span> /var/log/clickhouse-server</span><br><span class="line"><span class="built_in">tail</span> -100f clickhouse-server.err.log</span><br><span class="line">...</span><br><span class="line">2023.07.21 03:13:24.147160 [ 128 ] &#123;1ac67e78-ef20-4f55-a3a4-d9d0f96fce9a&#125; &lt;Error&gt; DynamicQueryHandler: Code: 50, e.displayText() = DB::Exception: Unknown data <span class="built_in">type</span> family: json, Stack trace (when copying this message, always include the lines below):</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">## 发现这里报了一个类型错误。相同的操作 在线上没问题。在uat 反而卡住了。开发说uat mysql 库也没动过。</span></span><br><span class="line"><span class="comment">## 一时间以为是uat percona 升级了数据库版本引发的。想尝试升级clickhouse 版本看看</span></span><br><span class="line"><span class="comment">## 拉取最新的 docker 镜像</span></span><br><span class="line">docker pull clickhouse/clickhouse-server:23.4</span><br><span class="line"><span class="comment">## 保存镜像并同步到uat 环境</span></span><br><span class="line">docker save -o clickhouse-server.tar clickhouse/clickhouse-server </span><br><span class="line"><span class="comment">## 在uat 环境中导入</span></span><br><span class="line">sudo docker load -i clickhouse-server.tar</span><br><span class="line"></span><br><span class="line"><span class="comment">## 拉起一个新版本镜像的container</span></span><br><span class="line">sudo docker run -d --name=clickhouse23.4 -p 18123:8123 -p19000:9000  -v /app/clickhouse/data234:/var/lib/clickhouse  --<span class="built_in">ulimit</span> nofile=262144:262144 clickhouse/clickhouse-server</span><br><span class="line"></span><br><span class="line"><span class="comment">## 登入镜像</span></span><br><span class="line">sudo docker <span class="built_in">exec</span> -it clickhouse23.4 bash</span><br><span class="line"><span class="comment">## 开启物化库参数。这里比20.12 的版本上 参数有区别 。materialize(d) 多了一个 字符</span></span><br><span class="line">SET allow_experimental_database_materialized_mysql = 1;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建库后。发现依然卡在 40个表</span></span><br><span class="line">CREATE DATABASE store_beauty ENGINE = MaterializeMySQL(<span class="string">&#x27;10.82.xx.xxx:3306&#x27;</span>, <span class="string">&#x27;store_beauty&#x27;</span>, <span class="string">&#x27;repl&#x27;</span>, <span class="string">&#x27;xxxxxx&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">## 这次翻看日志可以发现比较清晰。它指出了在dump wb_user_calendar 表的时候，列 spa_content 的 json 类型转换错误。该列在uat 上是json 类型。开发说有很多表都有json 类型</span></span><br><span class="line"><span class="comment">## 查看线上表数据。该列都有数据。而uat 该列没有数据，于是更新该列非null 后问题依旧。</span></span><br><span class="line"><span class="comment">## 于是查看线上mysql 同名表发现 该表实际上是text 类型。而不是json 类型。存储的是json 格式的字符串。</span></span><br><span class="line"><span class="comment">## 修改 uat 字段与线上一致 </span></span><br><span class="line">alter table wb_user_calendar change spa_content spa_content text default null comment <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除数据库重建</span></span><br><span class="line"><span class="comment">## 这次所有表都同步过来了。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p><h2 id="从这次故障可以看出-clickhouse-的-MaterializeMySQL-引擎并不支持-mysql-的json-格式。"><a href="#从这次故障可以看出-clickhouse-的-MaterializeMySQL-引擎并不支持-mysql-的json-格式。" class="headerlink" title="从这次故障可以看出 clickhouse 的 MaterializeMySQL 引擎并不支持 mysql 的json 格式。"></a>从这次故障可以看出 clickhouse 的 MaterializeMySQL 引擎并不支持 mysql 的json 格式。</h2><h2 id="升级clickhouse-到最新版本可解决-mysql-变更表结构不同步clickhouse-问题-并且需要注意MYSQL-修改表的语法"><a href="#升级clickhouse-到最新版本可解决-mysql-变更表结构不同步clickhouse-问题-并且需要注意MYSQL-修改表的语法" class="headerlink" title="升级clickhouse 到最新版本可解决 mysql 变更表结构不同步clickhouse 问题,并且需要注意MYSQL 修改表的语法"></a>升级clickhouse 到最新版本可解决 mysql 变更表结构不同步clickhouse 问题,并且需要注意MYSQL 修改表的语法</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 改字段名不要用change的语法， 用rename的语法</span><br><span class="line"></span><br><span class="line">ALTER TABLE 表名 RENAME COLUMN 原字段名 TO 新字段名;</span><br><span class="line"></span><br><span class="line">2. 改字段属性用modify</span><br><span class="line"></span><br><span class="line">ALTER TABLE 表名 MODIFY 字段名 属性;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;开发同事报clickhouse 的 MaterializeMySQL 数据库查询都报错&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/sp</summary>
      
    
    
    
    <category term="clickhouse" scheme="https://sheenzxx.github.io/categories/clickhouse/"/>
    
    
    <category term="MaterializeMySQL" scheme="https://sheenzxx.github.io/tags/MaterializeMySQL/"/>
    
  </entry>
  
  <entry>
    <title>mongodb shard 集群开启分片</title>
    <link href="https://sheenzxx.github.io/2023/07/19/mongoDBUseShared/"/>
    <id>https://sheenzxx.github.io/2023/07/19/mongoDBUseShared/</id>
    <published>2023-07-19T03:22:11.000Z</published>
    <updated>2023-07-19T03:57:07.165Z</updated>
    
    <content type="html"><![CDATA[<p>使用了mongodb 集群。如果没有对数据库。以及表开启分片。所有的库表默认只存在主节点上。分片集群也失去了意义。<br>这里介绍下如何开始数据库分片</p><p>1.安装mongosh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1. 下载mongoshell 1.0 版本</span><br><span class="line"></span><br><span class="line">2. tar -xzvf mongosh-1.10.0-linux-x64.tgz</span><br><span class="line"></span><br><span class="line">3. <span class="built_in">cd</span> mongosh-1.10.0-linux-x64/bin</span><br><span class="line"></span><br><span class="line">4. mongodb 管理控制台上添加白名单</span><br><span class="line"></span><br><span class="line">5. 登录mongoshard 集群</span><br><span class="line">./mongosh <span class="string">&quot;mongodb://s-xxxxxx.mongodb.rds.aliyuncs.com:3717,s-xxxxx.mongodb.rds.aliyuncs.com:3717/admin&quot;</span></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>2.登录集群后。先授权登录，然后切换到 config 库查看 当前shard集群的同步状态。以及查看分片集群的状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[mongos] admin&gt; db.auth(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"> &#123; ok: 1 &#125;</span><br><span class="line"> [mongos] admin&gt; use config</span><br><span class="line"> 查看当前Balancer的状态</span><br><span class="line"> sh.getBalancerState()</span><br><span class="line"> </span><br><span class="line"> 查看分片集群的状态</span><br><span class="line"> sh.status()</span><br></pre></td></tr></table></figure><p>3.设置同步平衡时间窗口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">设置 Balancer 窗口 窗口时间格式 时间格式为HH:MM  HH取值范围为00 - 23，MM取值范围为00 - 59</span><br><span class="line"> db.settings.updateOne(</span><br><span class="line">   &#123; _id: <span class="string">&quot;balancer&quot;</span> &#125;,</span><br><span class="line">   &#123; <span class="variable">$set</span>: &#123; activeWindow : &#123; start : <span class="string">&quot;00:00&quot;</span>, stop : <span class="string">&quot;09:00&quot;</span> &#125; &#125; &#125;,</span><br><span class="line">   &#123; upsert: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">如果需要balancer 始终运行，则设置如下</span><br><span class="line">db.settings.updateOne(&#123; _id : <span class="string">&quot;balancer&quot;</span> &#125;, &#123; <span class="variable">$unset</span> : &#123; activeWindow : <span class="literal">true</span> &#125; &#125;)  </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>4.开启 Balancer 功能<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.setBalancerState(<span class="literal">true</span>) </span><br></pre></td></tr></table></figure></p><p>5.如何关闭 Balancer 功能<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 执行如下脚本。确定 balaner 进程没在运行</span></span><br><span class="line"><span class="keyword">while</span>( sh.isBalancerRunning()[<span class="string">&quot;inBalancerRound&quot;</span>]) &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;waiting...&quot;</span>);</span><br><span class="line">          <span class="built_in">sleep</span>(1000);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">## 返回值为空，表示Balancer没有处于执行任务的状态，此时可执行下一步的操作，关闭Balancer </span></span><br><span class="line"><span class="comment">## 返回值为waiting，表示Balancer正在执行块迁移，此时不能执行关闭Balancer的命令，否则可能引起数据不一致</span></span><br><span class="line"><span class="comment">## 需注意的是 在同步过程中sh.isBalancerRunning 也可能出现短暂的终止。 配合  sh.getBalancerState() 一起看比较稳妥</span></span><br><span class="line"><span class="comment">## 另一个可以观察 shard 分片上的 CPU 波动。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 确认没有同步任务时可以执行停止</span></span><br><span class="line">sh.stopBalancer()</span><br></pre></td></tr></table></figure></p><p>6.为数据库开启分片功能(config 库上执行)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 数据库开启分片[config库上执行]</span></span><br><span class="line">sh.enableSharding(<span class="string">&quot;&lt;database&gt;&quot;</span>)</span><br><span class="line"><span class="comment">## 例如</span></span><br><span class="line">sh.enableSharding(<span class="string">&quot;mongodbtest&quot;</span>)</span><br></pre></td></tr></table></figure></p><p>7.为collection 建立分片索引(在目标库上执行)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 命令</span></span><br><span class="line">db.&lt;collection&gt;.createIndex(&lt;keyPatterns&gt;,&lt;options&gt;)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 参数说明：</span></span><br><span class="line">    &lt;collection&gt;：集合名。</span><br><span class="line">    &lt;keyPatterns&gt;：包含用于建立索引的字段和索引类型。</span><br><span class="line">    常见的索引类型如下：</span><br><span class="line">       1：创建升序索引</span><br><span class="line">       -1：创建降序索引</span><br><span class="line">       <span class="string">&quot;hashed&quot;</span>：创建哈希索引</span><br><span class="line">    &lt;options&gt;：表示接收可选参数，详情请参见db.collection.createIndex()，本操作示例中暂未使用到该字段</span><br><span class="line"><span class="comment">## 例子</span></span><br><span class="line"><span class="comment">##创建升序索引示例，基于范围的分片</span></span><br><span class="line">db.customer.createIndex(&#123;name:1&#125;)</span><br><span class="line"><span class="comment">## 创建哈希索引示例，基于指定列的hash 分片</span></span><br><span class="line">db.customer.createIndex(&#123;name:<span class="string">&quot;hashed&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></p><p>8.开启 collection 的分片<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 命令</span></span><br><span class="line">sh.shardCollection(<span class="string">&quot;&lt;database&gt;.&lt;collection&gt;&quot;</span>,&#123; <span class="string">&quot;&lt;key&gt;&quot;</span>:&lt;value&gt; &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">##参数说明：</span></span><br><span class="line">    &lt;database&gt;：数据库名。</span><br><span class="line">    &lt;collection&gt;：集合名。</span><br><span class="line">    &lt;key&gt;：分片的键，MongoDB将根据片键的值进行数据分片。</span><br><span class="line">    &lt;value&gt;  1：表示基于范围分片，通常能很好地支持基于片键的范围查询。</span><br><span class="line">             “hashed”：表示基于哈希分片，通常能将写入均衡分布到各Shard节点中。</span><br><span class="line"></span><br><span class="line"><span class="comment">## 例子</span></span><br><span class="line"><span class="comment">## 基于范围分片的配置示例</span></span><br><span class="line">sh.shardCollection(<span class="string">&quot;mongodbtest.customer&quot;</span>,&#123;<span class="string">&quot;name&quot;</span>:1&#125;)</span><br><span class="line"><span class="comment">## 基于哈希分片的配置示例</span></span><br><span class="line">sh.shardCollection(<span class="string">&quot;mongodbtest.customer&quot;</span>,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;hashed&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;使用了mongodb 集群。如果没有对数据库。以及表开启分片。所有的库表默认只存在主节点上。分片集群也失去了意义。&lt;br&gt;这里介绍下如何开始数据库分片&lt;/p&gt;
&lt;p&gt;1.安装mongosh&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;</summary>
      
    
    
    
    <category term="mongodb" scheme="https://sheenzxx.github.io/categories/mongodb/"/>
    
    
    <category term="replica" scheme="https://sheenzxx.github.io/tags/replica/"/>
    
    <category term="sharding" scheme="https://sheenzxx.github.io/tags/sharding/"/>
    
  </entry>
  
  <entry>
    <title>用xtrabackup 备份恢复Docker 的实例</title>
    <link href="https://sheenzxx.github.io/2023/07/17/xtrabackupwithDocker/"/>
    <id>https://sheenzxx.github.io/2023/07/17/xtrabackupwithDocker/</id>
    <published>2023-07-17T06:28:36.000Z</published>
    <updated>2023-07-19T01:59:39.371Z</updated>
    
    <content type="html"><![CDATA[<p>1.拉取 xtrbackup Docker 镜像<br>镜像版本可以在 <a href="https://hub.docker.com/r/percona/percona-xtrabackup/tags">https://hub.docker.com/r/percona/percona-xtrabackup/tags</a> 查找<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull percona/percona-xtrabackup:8.0.33-27 </span><br></pre></td></tr></table></figure></p><p>2.写一个可以支持全备和增量备份的脚本。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> xtrabackupDocker.sh </span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="comment"># 注意所有要docker挂载的路径都要有777 权限。否则都会报权限错误</span></span><br><span class="line"><span class="comment"># 全备和增备都以日期目录存储</span></span><br><span class="line"><span class="comment"># 增量备份 为取全备目录里面最新的一个全备为基础备份。没有基础备份退出增量备份</span></span><br><span class="line"></span><br><span class="line">fullTag=<span class="variable">$1</span></span><br><span class="line">BACKUP_PATH=/data/percona_data/backup</span><br><span class="line"></span><br><span class="line">today=`<span class="built_in">date</span> +<span class="string">&#x27;%Y%m%d_%H%M&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment">##创建备份路径</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">build_path</span></span>()&#123;</span><br><span class="line">   <span class="keyword">if</span> [ ! -d <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">mkdir</span> -p <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full</span><br><span class="line">      <span class="built_in">chmod</span> 777 <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   <span class="keyword">if</span> [ ! -d <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">mkdir</span> -p <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc</span><br><span class="line">      <span class="built_in">chmod</span> 777 <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 全备函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">full_backup</span></span>()&#123;</span><br><span class="line">   <span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full</span><br><span class="line">   <span class="keyword">if</span> [ -d <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full/<span class="variable">$today</span> ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">rm</span> -rf <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full/<span class="variable">$today</span></span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">   <span class="built_in">mkdir</span> <span class="variable">$today</span></span><br><span class="line">   <span class="built_in">chmod</span> 777 <span class="variable">$today</span></span><br><span class="line">   </span><br><span class="line">   docker run --name percona-xtrabackup \</span><br><span class="line">     --volumes-from percona-server8033 \    </span><br><span class="line">     -v <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full/<span class="variable">$today</span>:/backup \</span><br><span class="line">     percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">     xtrabackup --backup --datadir=/var/lib/mysql/ --target-dir=/backup \</span><br><span class="line">     --user=root --password=123456</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 增量备份</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">inc_backup</span></span>()&#123;</span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc</span><br><span class="line">  <span class="keyword">if</span> [ -d <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc/<span class="variable">$today</span> ];<span class="keyword">then</span></span><br><span class="line">      <span class="built_in">rm</span> -rf <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc/<span class="variable">$today</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">mkdir</span> <span class="variable">$today</span></span><br><span class="line">  <span class="built_in">chmod</span> 777 <span class="variable">$today</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_PATH&#125;</span>/full</span><br><span class="line">  last_full=<span class="variable">$BACKUP_PATH</span>/full/$(<span class="built_in">ls</span> -t | <span class="built_in">head</span> -1)</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$last_full</span>&quot;</span> = <span class="string">&quot;<span class="variable">$BACKUP_PATH</span>/full/&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">     <span class="built_in">exit</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">cd</span> <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc</span><br><span class="line">  docker run --name percona-xtrabackup \</span><br><span class="line">     --volumes-from percona-server8033 \</span><br><span class="line">     -v <span class="variable">$last_full</span>:/backup \</span><br><span class="line">     -v <span class="variable">$&#123;BACKUP_PATH&#125;</span>/inc/<span class="variable">$today</span>:/inc \</span><br><span class="line">     percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">     xtrabackup --backup --datadir=/var/lib/mysql/ --target-dir=/inc \</span><br><span class="line">     --incremental-basedir=/backup \</span><br><span class="line">     --user=root --password=123456</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">##创建路径</span></span><br><span class="line">build_path || <span class="built_in">return</span> 1</span><br><span class="line"></span><br><span class="line"><span class="comment">##清除docker 容器</span></span><br><span class="line">containerId=`docker ps -a |grep percona-xtrabackup|awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">docker <span class="built_in">rm</span> <span class="variable">$containerId</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$fullTag</span>&quot;</span> = <span class="string">&quot;full&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">   full_backup</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   inc_backup</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></p><p>3.发起备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x xtrabackupDocker.sh</span><br><span class="line">./xtrabackupDocker.sh full <span class="comment">## 为发起全备</span></span><br><span class="line">./xtrabackupDocker.sh <span class="comment">## 不加参数为增备</span></span><br></pre></td></tr></table></figure></p><p>4.恢复备份<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span>  /data/percona_data/backup/full</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">20230714_1528</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建恢复容器</span></span><br><span class="line">docker create --name percona-xtrabackup_recovery --volumes-from percona-server8033 \</span><br><span class="line">-v /data/percona_data/backup/full/20230714_1528:/backup \</span><br><span class="line">-v /data/percona_data/conf/my.cnf:/etc/mysql/conf.d/my.cnf \</span><br><span class="line">percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">xtrabackup --defaults-file=/etc/mysql/conf.d/my.cnf  --prepare --target-dir=/backup \</span><br><span class="line">--user=root --password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment">## 执行恢复命令</span></span><br><span class="line">docker start -ai percona-xtrabackup  <span class="comment"># 第一遍执行</span></span><br><span class="line">docker start -ai percona-xtrabackup  <span class="comment"># 第二遍执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将目录拷回原来的数据目录</span></span><br><span class="line">docker stop percona-server8033</span><br><span class="line"><span class="built_in">cd</span> /data/percona_data/</span><br><span class="line"><span class="built_in">mv</span> data8033 data8033_bak</span><br><span class="line"><span class="built_in">mv</span> /data/percona_data/backup/full/20230714_1528 data8033</span><br><span class="line">docker start percona-server8033</span><br></pre></td></tr></table></figure></p><p>5.增量备份的恢复<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 先全量恢复。需要带  --apply-log-only 只应用日志</span></span><br><span class="line">docker run --name percona-xtrabackup_recovery --volumes-from percona-server8033 \</span><br><span class="line">-v /data/percona_data/backup/full/20230714_1528:/backup \</span><br><span class="line">-v /data/percona_data/conf/my.cnf:/etc/mysql/conf.d/my.cnf \</span><br><span class="line">percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">xtrabackup --defaults-file=/etc/mysql/conf.d/my.cnf  --prepare --apply-log-only --target-dir=/backup \</span><br><span class="line">--user=root --password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment">## 跑完就删 container .或者指定不同名字的container </span></span><br><span class="line"></span><br><span class="line">docker ps -a |grep percona-xtrabackup_recovery </span><br><span class="line">docker <span class="built_in">rm</span> <span class="variable">$container_id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 恢复增量 本文实例为基于全量的增量。所以恢复时只需要指定最后一个增量 </span></span><br><span class="line"><span class="comment">## 如果是多级增量备份 只要不是最后一个增量，就需要加上 --apply-log-only 选项。最后一个增量恢复去除该选项即可</span></span><br><span class="line">docker run --name percona-xtrabackup_recovery --volumes-from percona-server8033 \</span><br><span class="line">-v /data/percona_data/backup/inc/20230715_1528:/inc \</span><br><span class="line">-v /data/percona_data/conf/my.cnf:/etc/mysql/conf.d/my.cnf \</span><br><span class="line">percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">xtrabackup --defaults-file=/etc/mysql/conf.d/my.cnf  --prepare --target-dir=/backup \</span><br><span class="line">--user=root --password=123456</span><br><span class="line"></span><br></pre></td></tr></table></figure></p><p>6.利用备份恢复为从库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 先建一个从库的container </span></span><br><span class="line"><span class="comment">## 从库配置文件myslave.cnf 配置好从库相关选项。server-id 不能跟主库一样</span></span><br><span class="line">docker run -d \</span><br><span class="line">--name=percona-server8033_slave \</span><br><span class="line">-v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">-v /etc/timezone:/etc/timezone  \</span><br><span class="line">-v /data/percona_data/data8033_slave:/var/lib/mysql \</span><br><span class="line">-v /data/percona_data/conf/myslave.cnf:/etc/my.cnf \</span><br><span class="line">-p 3307:3306 \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">percona/percona-server:8.0.33-25  \</span><br><span class="line">--character-set-server=utf8mb4 \</span><br><span class="line">--collation-server=utf8mb4_unicode_ci</span><br><span class="line"></span><br><span class="line">[root@localhost backup]<span class="comment"># docker ps -a</span></span><br><span class="line">CONTAINER ID   IMAGE                                  COMMAND                  CREATED      STATUS                  PORTS                                                  NAMES</span><br><span class="line">9a2016f84858   percona/percona-server:8.0.33-25       <span class="string">&quot;/docker-entrypoint.…&quot;</span>   2 days ago   Up 2 days               33060/tcp, 0.0.0.0:3307-&gt;3306/tcp, :::3307-&gt;3306/tcp   percona-server8033_slave</span><br><span class="line">docker logs 9a2016f84858 --follow</span><br><span class="line"></span><br><span class="line"><span class="comment">## 等初始化完成之后，停掉container</span></span><br><span class="line">docker stop percona-server8033_slave</span><br><span class="line"><span class="comment">## 恢复备份</span></span><br><span class="line">docker create --name percona-xtrabackup_recovery --volumes-from percona-server8033 \</span><br><span class="line">-v /data/percona_data/backup/full/20230714_1528:/backup \</span><br><span class="line">-v /data/percona_data/conf/my.cnf:/etc/mysql/conf.d/my.cnf \</span><br><span class="line">percona/percona-xtrabackup:8.0.33-27  \</span><br><span class="line">xtrabackup --defaults-file=/etc/mysql/conf.d/my.cnf  --prepare --target-dir=/backup \</span><br><span class="line">--user=root --password=123456</span><br><span class="line"></span><br><span class="line"><span class="comment">## 执行恢复命令</span></span><br><span class="line">docker start -ai percona-xtrabackup  <span class="comment"># 第一遍执行</span></span><br><span class="line">docker start -ai percona-xtrabackup  <span class="comment"># 第二遍执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 替换目录，将恢复的目录替为 /data/percona_data/data8033_slave 的目录</span></span><br><span class="line"><span class="built_in">mv</span> /data/percona_data/data8033_slave /data/percona_data/data8033_slave_bak</span><br><span class="line"><span class="built_in">mv</span> /data/percona_data/backup/full/20230714_1528 /data/percona_data/data8033_slave</span><br><span class="line"><span class="built_in">chmod</span> 777 /data/percona_data/data8033_slave</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动 从库容器</span></span><br><span class="line">docker start percona-server8033_slave</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在主库创建复制账号</span></span><br><span class="line">docker <span class="built_in">exec</span> -it percona-server8033 mysql -uroot -p123456 -e <span class="string">&quot;create user repl@&#x27;%&#x27; identified by &#x27;repl&#x27;;grant select,replication slave on *.* to repl@&#x27;%&#x27;;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 获取备份时的gtid 信息</span></span><br><span class="line"><span class="built_in">cd</span>  data8033_slave</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> xtrabackup_info</span><br><span class="line">...</span><br><span class="line">binlog_pos = filename <span class="string">&#x27;binlog.000007&#x27;</span>, position <span class="string">&#x27;197&#x27;</span>, GTID of the last change <span class="string">&#x27;c1ef4787-206b-11ee-8d03-0242ac110002:1-77&#x27;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置从库gtid 信息</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it percona-server8033_slave mysql -uroot -p123456 -e <span class="string">&quot;reset slave;reset master; set gtid_purged=&#x27;c1ef4787-206b-11ee-8d03-0242ac110002:1-77&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置从库连接主库信息</span></span><br><span class="line">docker <span class="built_in">exec</span> -it percona-server8033_slave mysql -uroot -p123456 -e <span class="string">&quot;CHANGE REPLICATION SOURCE TO \</span></span><br><span class="line"><span class="string">&gt; SOURCE_HOST=&#x27;192.168.56.15&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_PORT=3306,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_USER=&#x27;repl&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_PASSWORD=&#x27;repl&#x27;,\</span></span><br><span class="line"><span class="string">&gt; SOURCE_AUTO_POSITION=1;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">docker <span class="built_in">exec</span> -it percona-server8033_slave mysql -uroot -p123456 -e <span class="string">&quot;start slave;show slave status\G&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;1.拉取 xtrbackup Docker 镜像&lt;br&gt;镜像版本可以在 &lt;a href=&quot;https://hub.docker.com/r/percona/percona-xtrabackup/tags&quot;&gt;https://hub.docker.com/r/percona/p</summary>
      
    
    
    
    <category term="mysql" scheme="https://sheenzxx.github.io/categories/mysql/"/>
    
    
    <category term="docker" scheme="https://sheenzxx.github.io/tags/docker/"/>
    
    <category term="percona" scheme="https://sheenzxx.github.io/tags/percona/"/>
    
    <category term="xtrabackup" scheme="https://sheenzxx.github.io/tags/xtrabackup/"/>
    
  </entry>
  
  <entry>
    <title>对 docker Percona mysql 进行版本替换升级</title>
    <link href="https://sheenzxx.github.io/2023/07/12/dokerPerconaUpgrade/"/>
    <id>https://sheenzxx.github.io/2023/07/12/dokerPerconaUpgrade/</id>
    <published>2023-07-12T05:50:34.000Z</published>
    <updated>2023-07-19T03:15:48.265Z</updated>
    
    <content type="html"><![CDATA[<p>客户有一套 percona mysql 运行在Docker 中。版本为 8.0.25-15,经等保扫描有一些漏洞需要修复。需要对这套数据库进行版本升级。<br>版本替换需要停机处理。</p><ol><li><p>在能连外网的机器上下载最新的 Percona-server Docker 版本。<br>版本列表见：<a href="https://registry.hub.docker.com/r/percona/percona-server/tags?page=1&amp;name=8.0">https://registry.hub.docker.com/r/percona/percona-server/tags?page=1&amp;name=8.0</a><br>找到当前最新版本 8.0.33-25<br><code>docker pull percona/percona-server:8.0.33-25</code></p></li><li><p>将镜像导出。<br><code>docker save -o percona-server:8.0.33-25.tar percona/percona-server:8.0.33-25</code></p></li><li><p>将镜像同步到线上环境导入<br><code>docker load &lt; percona-server:8.0.33-25.tar</code><br>如果没有采用 [新镜像名称]:[新镜像标签] 的命名方式。导入后在 docker images 中只能看到 REPOSITORY  TAG 2 列都是 None<br>这时需要修改镜像名称<br><code>docker tag [镜像id] [新镜像名称]:[新镜像标签]</code></p></li><li><p>停止 当前运行的 percona-server 实例,并删除container</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost percona_data]<span class="comment"># docker ps </span></span><br><span class="line">CONTAINER ID   IMAGE                              COMMAND                  CREATED         STATUS         PORTS                                                  NAMES</span><br><span class="line">ef10071274a8   percona/percona-server:8.0.25-15   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   3 seconds ago   Up 2 seconds   33060/tcp, 0.0.0.0:3308-&gt;3306/tcp, :::3308-&gt;3306/tcp   percona-server8025</span><br><span class="line"></span><br><span class="line">[root@localhost percona_data]<span class="comment"># docker stop percona-server8025</span></span><br><span class="line">percona-server8025</span><br><span class="line">[root@localhost percona_data]<span class="comment"># docker rm percona-server8025 </span></span><br><span class="line">percona-server8025</span><br></pre></td></tr></table></figure></li><li><p>用新的版本重新拉起container</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker run  -d \</span><br><span class="line">&gt; --name=percona-server8025 \</span><br><span class="line">&gt; -v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">&gt; -v /etc/timezone:/etc/timezone  \</span><br><span class="line">&gt; -v /data/percona_data/data8025:/var/lib/mysql \</span><br><span class="line">&gt; -v /data/percona_data/conf:/etc/my.cnf.d \</span><br><span class="line">&gt; -p 3308:3306 \</span><br><span class="line">&gt; -e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">&gt; percona/percona-server:8.0.33-25  \  <span class="comment">## 此处替换新版本  </span></span><br><span class="line">&gt; --character-set-server=utf8mb4 \</span><br><span class="line">&gt; --collation-server=utf8mb4_unicode_ci</span><br><span class="line">ac487a648370b3fc92e9ac67d6b0addaa89082dc29f0f9148f9c12a9597d6c91</span><br><span class="line"></span><br><span class="line">[root@localhost percona_data]<span class="comment"># docker ps</span></span><br><span class="line">CONTAINER ID   IMAGE                              COMMAND                  CREATED         STATUS         PORTS                                                  NAMES</span><br><span class="line">ac487a648370   percona/percona-server:8.0.33-25   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   4 seconds ago   Up 3 seconds   33060/tcp, 0.0.0.0:3308-&gt;3306/tcp, :::3308-&gt;3306/tcp   percona-server8025</span><br></pre></td></tr></table></figure></li><li><p>查看日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2023-07-19T02:19:21.459842Z 0 [Warning] [MY-011068] [Server] The syntax <span class="string">&#x27;log_slave_updates&#x27;</span> is deprecated and will be removed <span class="keyword">in</span> a future release. Please use log_replica_updates instead.</span><br><span class="line">2023-07-19T02:19:21.459865Z 0 [Warning] [MY-011068] [Server] The syntax <span class="string">&#x27;log_slave_updates&#x27;</span> is deprecated and will be removed <span class="keyword">in</span> a future release. Please use log_replica_updates instead.</span><br><span class="line">2023-07-19T02:19:21.459877Z 0 [Warning] [MY-011068] [Server] The syntax <span class="string">&#x27;skip_slave_start&#x27;</span> is deprecated and will be removed <span class="keyword">in</span> a future release. Please use skip_replica_start instead.</span><br><span class="line">2023-07-19T02:19:21.460998Z 0 [Warning] [MY-010097] [Server] Insecure configuration <span class="keyword">for</span> --secure-log-path: Current value does not restrict location of generated files. Consider setting it to a valid, non-empty path.</span><br><span class="line">2023-07-19T02:19:21.461043Z 0 [Warning] [MY-010918] [Server] <span class="string">&#x27;default_authentication_plugin&#x27;</span> is deprecated and will be removed <span class="keyword">in</span> a future release. Please use authentication_policy instead.</span><br><span class="line">2023-07-19T02:19:21.461062Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.33-25) starting as process 1</span><br><span class="line">2023-07-19T02:19:21.467176Z 1 [System] [MY-013576] [InnoDB] InnoDB initialization has started.</span><br><span class="line">2023-07-19T02:19:22.089039Z 1 [System] [MY-013577] [InnoDB] InnoDB initialization has ended.</span><br><span class="line">2023-07-19T02:19:25.524903Z 4 [System] [MY-013381] [Server] Server upgrade from <span class="string">&#x27;80025&#x27;</span> to <span class="string">&#x27;80033&#x27;</span> started.  <span class="comment">## 8.0 的升级不需要执行mysql_upgrade mysqld 在启动后自动升级</span></span><br><span class="line">mbind: Operation not permitted</span><br><span class="line">2023-07-19T02:19:38.722702Z 4 [System] [MY-013381] [Server] Server upgrade from <span class="string">&#x27;80025&#x27;</span> to <span class="string">&#x27;80033&#x27;</span> completed.  <span class="comment">## 版本升级完成</span></span><br><span class="line">2023-07-19T02:19:38.970169Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.</span><br><span class="line">2023-07-19T02:19:38.970198Z 0 [System] [MY-013602] [Server] Channel mysql_main configured to support TLS. Encrypted connections are now supported <span class="keyword">for</span> this channel.</span><br><span class="line">2023-07-19T02:19:39.014404Z 0 [System] [MY-010931] [Server] /usr/sbin/mysqld: ready <span class="keyword">for</span> connections. Version: <span class="string">&#x27;8.0.33-25&#x27;</span>  socket: <span class="string">&#x27;/var/lib/mysql/mysql.sock&#x27;</span>  port: 3306  Percona Server (GPL), Release 25, Revision 60c9e2c5.</span><br><span class="line">2023-07-19T02:19:39.014473Z 0 [System] [MY-011323] [Server] X Plugin ready <span class="keyword">for</span> connections. Bind-address: <span class="string">&#x27;::&#x27;</span> port: 33060, socket: /var/lib/mysql/mysqlx.sock</span><br></pre></td></tr></table></figure></li><li><p>数据检测</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost data8025]# docker exec -it percona-server8025  mysql -uroot -p123456 -e &quot;select * from sheen.test1;&quot;</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------+-------+</span><br><span class="line">| id   | title |</span><br><span class="line">+------+-------+</span><br><span class="line">|    1 | aa    |</span><br><span class="line">|    2 | bb    |</span><br><span class="line">+------+-------+</span><br></pre></td></tr></table></figure></li><li><p>对于在没有root 权限 需要使用sudo 的情况下 需要加上 —privileged=true 这个参数。否则在初始化的时候会报路径权限不足</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run  -d \    <span class="comment"># run create + start 一个container -d 后台运行</span></span><br><span class="line">--privileged=<span class="literal">true</span> \ <span class="comment"># 将扩展权限给这个container</span></span><br><span class="line">--name=percona-server8033 \  <span class="comment"># container 名称</span></span><br><span class="line">-v /etc/localtime:/etc/localtime:ro \ <span class="comment"># -v 将本地目录 映射到 容器中对应的目录</span></span><br><span class="line">-v /etc/timezone:/etc/timezone  \</span><br><span class="line">-v /data/percona_data/data8033:/var/lib/mysql \   <span class="comment"># 数据库的数据目录</span></span><br><span class="line">-v /data/percona_data/conf:/etc/my.cnf.d \        <span class="comment"># 数据库的配置文件目录</span></span><br><span class="line">-p 3306:3306 \                                    <span class="comment"># -p 端口映射。在宿主机上起一个端口映射容器里面服务的端口。</span></span><br><span class="line">-e MYSQL_ROOT_PASSWORD=future123456 \             <span class="comment"># -e 容器环境变量，这里指定 mysql root 的密码</span></span><br><span class="line">percona/percona-server:8.0.33-25  \               <span class="comment"># 使用的镜像</span></span><br><span class="line">--character-set-server=utf8mb4 \                  <span class="comment"># 指定数据库的字符集</span></span><br><span class="line">--collation-server=utf8mb4_unicode_ci             <span class="comment"># 指定数据库的 colllaction</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;客户有一套 percona mysql 运行在Docker 中。版本为 8.0.25-15,经等保扫描有一些漏洞需要修复。需要对这套数据库进行版本升级。&lt;br&gt;版本替换需要停机处理。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;在能连外网的机器上下载最新的 Percona-server</summary>
      
    
    
    
    <category term="mysql" scheme="https://sheenzxx.github.io/categories/mysql/"/>
    
    
    <category term="docker" scheme="https://sheenzxx.github.io/tags/docker/"/>
    
    <category term="percona" scheme="https://sheenzxx.github.io/tags/percona/"/>
    
  </entry>
  
</feed>
